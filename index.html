<!DOCTYPE html>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" manifest="passlok.appcache" lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>PassLok Privacy Eric 2.5</title>
<meta name="Keywords" content="passlok, URSA, browser, encryption, decryption, symmetric, public key, signature, AES, ECDH, Diffie, Hellman, elliptic curve, advanced, javascript, PGP, PRISM">
<meta name="Description" content="PassLok privacy Eric">
<meta name="author" content="F. Ruiz">
<meta name="robots" content="index">
<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="https://passlok.com/app/passlok-touch-icon.png">
<link rel="shortcut icon" type="image/x-icon" href="https://passlok.com/app/favicon.ico">

<!--Note to those wishing to read the JavaScript code: the code is divided into blocks, each one within its own script tag. You will read it more easily if you use an editor capable of folding code blocks-->

<!--Default CSS stylesheet containing the Light color scheme-->
<style>
html {
	-webkit-text-size-adjust: 100%;
}
body {
	font-family: Sans-Serif;
	font-size: 100%;
	margin-left: 1%;
	margin-right: 1%;
	overflow: auto;
	background-color: #FFFFFF;
	color: #000000;
}
input:focus {
    outline: none !important;
    border:1px solid #00CA68;
    box-shadow: 0 0 10px #77b5a4;
}
div:focus {
    outline: none !important;
    border:1px solid #00CA68;
    box-shadow: 0 0 10px #719ECE;
}
button:focus {
    outline: none !important;
    box-shadow: 0 0 10px #75b3a2;
}
select:focus {
    outline: none !important;
    border:1px solid #00CA68;
    box-shadow: 0 0 10px #719ECE;
}
.black_overlay {
	display: block;
	position: absolute;
	top: 0%;
	left: 0%;
	width: 100%;
	height: 100%;
	z-index: 1001;
	-moz-opacity: 0.5;
	opacity: .50;
	filter: alpha(opacity=50);
	background-color: black;
}
.white_content {
	display: none;
	position: absolute;
	top: 10%;
	left: 10%;
	width: 80%;
	height: 80%;
	padding: 0px;
	border: 0px solid gray;
	z-index: 1002;
	overflow: auto;
	background-color: white;
}
.block_page {
	display: none;
	position: absolute;
	top: 0%;
	left: 0%;
	width: 100%;
	height: 100%;
	padding: 0px;
	border: 0px solid gray;
	z-index: 1002;
	overflow: auto;
	background-color: white;
}
.cssbutton {
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;
	font-family: Arial;
	font-size: 18px;
	padding: 12px;
	text-decoration: none;
	border: 0px;
	color: #666666;
	background: #e6e6e6;
}
.cssbutton:hover {
	text-decoration: none;
	cursor: pointer;
	background: #c4c4c4;
}
.narrow {
	padding-left: 9px;
	padding-right: 9px;
}
.cssbox {
	-webkit-border-radius: 15px;
	-moz-border-radius: 15px;
	border-radius: 15px;
	font-size: medium;
	padding: 15px;
	text-decoration: none;
	width: 100%;
	-webkit-appearance: none;
	box-sizing: border-box;
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-shadow: none;
	-moz-box-shadow: none;
	box-shadow: none;
	color: #000000;
	background: #fffff5;
	border: 1px solid #dedede;
	overflow: auto;
	white-space: pre-line;
}
.message {
	white-space: pre-line;
	height: 40px;
}
.field-icon {
  margin-left: -30px;
  height: 18px;
  z-index: 1003;
  position: relative;
}
.helpHeading {
	cursor: pointer;
	padding: 1px;
}
.helpHeading:hover {
	background-color: #eeeeee;
}
.helpHeading2 {
	cursor: pointer;
	padding: 1px;
}
.helpText {
	max-height: 0;
	overflow: hidden;
	transition: max-height 0.3s ease-out;
}
.intLink {
	cursor: pointer;
}
.blink {
	-webkit-animation: blink .75s linear infinite;
	-moz-animation: blink .75s linear infinite;
	-ms-animation: blink .75s linear infinite;
	-o-animation: blink .75s linear infinite;
	animation: blink .75s linear infinite;
}
 @-webkit-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @-moz-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @-ms-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @-o-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
input[type=checkbox] {
	/* Larger checkboxes */
	-ms-transform: scale(1.7); /* IE */
	-moz-transform: scale(1.7); /* FF */
	-webkit-transform: scale(1.7); /* Safari and Chrome */
	-o-transform: scale(1.7); /* Opera */
	padding: 0px;
	cursor: pointer;
	border: 1px solid #dedede;
}
input[type=radio] {
	/* Larger radio buttons */
	-ms-transform: scale(1.7); /* IE */
	-moz-transform: scale(1.7); /* FF */
	-webkit-transform: scale(1.7); /* Safari and Chrome */
	-o-transform: scale(1.7); /* Opera */
	padding: 0px;
	cursor: pointer;
	border: 1px solid #dedede;
}
ul#tabs {
	margin: 0;
	text-align: center;
	padding: 11px;
	width: 100%;
	position: fixed;
	top: 0px;
	left: 0px;
	z-index: 1;
	background-color: #c6d5c6;
}
ul#tabs li {
	display: inline;
	width: auto;
}
ul#tabs li a {
	font-size: 18px;
	border: none;
	text-decoration: none;
	padding: 10px;
	margin-left: -4px;
	padding-bottom: 11px;
	color: #42454a;
	background-color: #c6d5c6;
}
ul#tabs li a:hover {
	background-color: #a4b3a4;
}
ul#tabs li a.selected {
	font-weight: bold;
	padding: 12px;
	border: none;
	color: #000;
	background-color: #ffffff;
	border-top-left-radius: 15px;
	border-top-right-radius: 15px;
}
div.tabContent {
	border: none;
	max-width: 1000px;
	margin-left: auto;
	margin-right: auto;
	background-color: #ffffff;
}
div.tabContent.hide {
	display: none;
}
select {
	-webkit-appearance: button;
	-moz-appearance: button;
	-webkit-user-select: none;
	-moz-user-select: none;
	font-size: medium;
	width: 30%;
	margin: 0;
	text-overflow: ellipsis;
	white-space: nowrap;
	border: 1px solid #dedede;
	color: #666666;
	background: #fffff5;
}
img.intLink {
	border: 0;
}
#toolBar1 {
	display: none;
	padding-top: 1px;
	padding-left: 2px;
	border-top-left-radius: 15px;
	border-top-right-radius: 15px;
	background: #e6e6e6;
}
#toolBar1 select {
	font-size: 10px;
	width: 80px;
	padding: 4px;
	border-radius: 8px;
}
#mainBox {
	width: 100%;
	padding: 12px;
}
#editMode label {
	cursor: pointer;
}
[contenteditable=true]:empty:before{
  content: attr(placeholder);
  display: block; /* For Firefox */
  color: #999999;
}

<!--previously inline formatting moved to style.css-->
#mainMsg {
	min-height: 20px;
}
#lockList {
	padding: 4px;
	width: 30%;
}
#resetListBtn {
	font-size: 14px;
	padding: 4px;
}
#main2lockBtn {
	font-size: 14px;
	padding: 4px;
	padding-left: 10px;
	padding-right: 12px;
}
#basicBtnsTop {
	display: block;
}
#decryptBtnBasic {
	font-size: 22px;
	padding: 14px;
}
#showLockBtnBasic {
	font-size: 22px;
	padding: 14px;
}
#emailBtnsTop {
	display: none;
}
#decryptBtnEmail {
	padding-right: 7px;
	padding-left: 7px;
}
#stegoBtnEmail {
	padding-right: 6px;
	padding-left: 6px;
}
#imageFileEmailBtn {
	padding-right: 6px;
	padding-left: 6px;
	padding-bottom: 13px;
}
#imageFileEmail {
	display: none;
}
#mainBtnsTop {
	display: none;
}
#decryptBtn {
	padding-right: 7px;
	padding-left: 7px;
}
#verifyBtn {
	padding-right: 7px;
	padding-left: 7px;
}
#showLockBtn {
	padding-right: 7px;
	padding-left: 7px;
}
#main2extraBtn {
	color: orange;
	padding-right: 9px;
	padding-left: 9px;
}
#extraButtonsTop {
	display: none;
}
#stegoBtn {
	padding-right: 9px;
	padding-left: 9px;
}
#imageFileBtn {
	padding-bottom: 13px;
}
#imageFile {
	display: none;
}
#secretShareBtn {
	padding-right: 9px;
	padding-left: 9px;
}
#extra2mainBtn {
	color: orange;
	padding-right: 9px;
	padding-left: 9px;
}
#imgFile {
	display: none;
}
#mainFile {
	display: none;
}

#optionsTab {
	max-width: 500px;
}
#customColors {
	display: block;
}
#colorPicker {
	width: 50px;
	padding: 12px;
}
#rndColors {
	font-size: medium;
	padding: 9px;
}
#specialEncryptModes {
	display: none;
}
#syncCheck {
	display: none;
}
#basicHideModes {
	display: none;
}
#advancedModes {
	display: none;
}
#advancedBtns {
	display: none;
}

#helpTop {
	position: fixed;
	background-color: inherit;
	width: 100%;
	top: 41px;
	display: none;
}
#helpSpace {
	background-color: inherit;
	display: none;
}
#helpTopMobile {
	display: block;
}
#advancedHelp {
	display: none;
}
#canary {
	float: left;
}

#lockScr {
	display: none;
}
#lock2mainBtn {
	float: left;
}
#lockMsg {
	height: 25px;
}
#lockNameBox {
	width: 95%;
}
#lockBox {
	width: 95%;
}
#lockBtnsBottom {
	display: none;
}
#lockFile{
	display: none;
}

#keyScr {
	display: block;
}
#pwdMsg {
	height: 40px;
}
#javascriptOff {
	color: red;
	font-weight: bold;
}
#nameList {
	padding: 4px;
	width: 30%;
}
#newUserBtn {
	font-size: 14px;
	padding: 4px;
}
#pwdBox {
	width: 95%;
}

#introscr {
	display: none;
}
#introWelcome {
	color: green;
}
#intro1 {
	width: 98%;
	max-width: 500px;
}
#skipIntroBtn {
	float: right;
}
#introscr2 {
	display: none;
}
#intro2 {
	width: 98%;
	max-width: 500px;
}
#nameIntro {
	width: 90%;
}
#pwdIntroMsg {
	color: green;
}
#introscr3 {
	display: none;
}
#intro3 {
	width: 98%;
	max-width: 500px;
}
#pwdIntroBox {
	width: 90%;
}
#introscr4 {
	display: none;
}
#intro4 {
	width: 98%;
	max-width: 500px;
}
#emailIntro {
	width: 90%;
}
#introscr5 {
	display: none;
}
#intro5 {
	width: 98%;
	max-width: 500px;
}
#showlockIntroBtn {
	color: blue;
}
#intromsg2 {
	color: red;
}

#nameScr {
	display: none;
}
#namechangemsg {
	height: 30px;
}
#userNameBox {
	width: 95%;
}
#newKeyMsg {
	height: 30px;
}
#newKeyBox {
	width: 95%;
}
#newKey2Box {
	width: 95%;
}
#emailScr {
	display: none;
}
#emailBox {
	width: 95%;
}

#decoyText {
	width: 95%;
}
#decoyInBox {
	width: 95%;
}
#decoyOutBox {
	width: 95%;
}

#partsNumber {
	width: 30%;
}
#partsQuorum {
	width: 30%;
}

#chatDate {
	width: 95%;
}

#imageScr {
	display: none;
}
#image2mainBtn {
	float: left;
}
#imageBox {
	width: 25%;
	padding: 5px;
}
#imageMsg {
	height: 40px;
}

#lockdirContent {
	max-width: 1200px;
	margin-left: auto;
	margin-right: auto;
}

#qrcodeImg {
	top: 100px;
}
</style>

<!--License notice and SSL force-->
<script>
        /*
		@source: https://passlok.com/app/index.html

        @licstart  The following is the entire license notice for the
        JavaScript code in this page.

        Copyright (C) 2022  Francisco Ruiz

        The JavaScript code in this page is free software: you can
        redistribute it and/or modify it under the terms of the GNU
        General Public License (GNU GPL) as published by the Free Software
        Foundation, either version 3 of the License, or (at your option)
        any later version.  The code is distributed WITHOUT ANY WARRANTY;
        without even the implied warranty of MERCHANTABILITY or FITNESS
        FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

        As additional permission under GNU GPL version 3 section 7, you
        may distribute non-source (e.g., minimized or compacted) forms of
        that code without the copy of the GNU GPL normally required by
        section 4, provided you include this license notice and a URL
        through which recipients can access the Corresponding Source.


        @licend  The above is the entire license notice
        for the JavaScript code in this page.
        */

    if (window.location.protocol == "http:") {				//force SSL/TLS

        var restOfUrl = window.location.href.substr(5);
        window.location = "https:" + restOfUrl;
    }
</script>

<!--Shamir Secret Sharing Scheme. Edited so NaCl RNG is used instead of built-in RNG. https://github.com/amper5and/secrets.js-->
<script>
//edit in lines 390-393 by F. Ruiz in order to use SJCL RNG function rather than the built-in RNG. Chunks of code commented out as a consequence.
// secrets.js - by Alexander Stetsyuk - released under MIT License
(function(exports, global){
var defaults = {
	bits: 8, // default number of bits
	radix: 16, // work with HEX by default
	minBits: 3,
	maxBits: 20, // this permits 1,048,575 shares, though going this high is NOT recommended in JS!

	bytesPerChar: 2,
	maxBytesPerChar: 6, // Math.pow(256,7) > Math.pow(2,53)

	// Primitive polynomials (in decimal form) for Galois Fields GF(2^n), for 2 <= n <= 30
	// The index of each term in the array corresponds to the n for that polynomial
	// i.e. to get the polynomial for n=16, use primitivePolynomials[16]
	primitivePolynomials: [null,null,1,3,3,5,3,3,29,17,9,5,83,27,43,3,45,9,39,39,9,5,3,33,27,9,71,39,9,5,83],

	// warning for insecure PRNG
	warning: 'WARNING:\nA secure random number generator was not found.\nUsing Math.random(), which is NOT cryptographically strong!'
};

// Protected settings object
var config = {};

/** @expose **/
/*edit by F. Ruiz. This function is turned off since it does not get called
exports.getConfig = function(){
	return {
		'bits': config.bits,
		'unsafePRNG': config.unsafePRNG
	};
};
*/

function init(bits){
	if(bits && (typeof bits !== 'number' || bits%1 !== 0 || bits<defaults.minBits || bits>defaults.maxBits)){
		throw new Error('Number of bits must be an integer between ' + defaults.minBits + ' and ' + defaults.maxBits + ', inclusive.')
	}

	config.radix = defaults.radix;
	config.bits = bits || defaults.bits;
	config.size = Math.pow(2, config.bits);
	config.max = config.size - 1;

	// Construct the exp and log tables for multiplication.
	var logs = [], exps = [], x = 1, primitive = defaults.primitivePolynomials[config.bits];
	for(var i=0; i<config.size; i++){
		exps[i] = x;
		logs[x] = i;
		x <<= 1;
		if(x >= config.size){
			x ^= primitive;
			x &= config.max;
		}
	}

	config.logs = logs;
	config.exps = exps;
};

/** @expose **/
exports.init = init;

function isInited(){
	if(!config.bits || !config.size || !config.max  || !config.logs || !config.exps || config.logs.length !== config.size || config.exps.length !== config.size){
		return false;
	}
	return true;
};

//Edit by F. Ruiz. The RNG code in this library is removed and the one in SJCL is used instead

//about 100 lines removed here

//End of F. Ruiz edits for this block. There are three more edits: 1. a RNG check that is removed. 2. built-in RNG call replaced by SJCL RNG call. 3. new version of padLeft function


// Divides a `secret` number String str expressed in radix `inputRadix` (optional, default 16)
// into `numShares` shares, each expressed in radix `outputRadix` (optional, default to `inputRadix`),
// requiring `threshold` number of shares to reconstruct the secret.
// Optionally, zero-pads the secret to a length that is a multiple of padLength before sharing.
/** @expose **/
exports.share = function(secret, numShares, threshold, padLength, withoutPrefix){
	if(!isInited()){
		this.init();
	}
/*	if(!isSetRNG()){				RNG check removed by F. Ruiz
		this.setRNG();
	}
*/
	padLength =  padLength || 0;

	if(typeof secret !== 'string'){
		throw new Error('Secret must be a string.');
	}
	if(typeof numShares !== 'number' || numShares%1 !== 0 || numShares < 2){
		throw new Error('Number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive.')
	}
	if(numShares > config.max){
		var neededBits = Math.ceil(Math.log(numShares +1)/Math.LN2);
		throw new Error('Number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive. To create ' + numShares + ' shares, use at least ' + neededBits + ' bits.')
	}
	if(typeof threshold !== 'number' || threshold%1 !== 0 || threshold < 2){
		throw new Error('Threshold number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive.');
	}
	if(threshold > config.max){
		var neededBits = Math.ceil(Math.log(threshold +1)/Math.LN2);
		throw new Error('Threshold number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive.  To use a threshold of ' + threshold + ', use at least ' + neededBits + ' bits.');
	}
	if(typeof padLength !== 'number' || padLength%1 !== 0 ){
		throw new Error('Zero-pad length must be an integer greater than 1.');
	}

	if(config.unsafePRNG){
		warn();
	}

	secret = '1' + hex2bin(secret); // append a 1 so that we can preserve the correct number of leading zeros in our secret
	secret = split(secret, padLength);
	var x = new Array(numShares), y = new Array(numShares);
	for(var i=0, len = secret.length; i<len; i++){
		var subShares = this._getShares(secret[i], numShares, threshold);
		for(var j=0; j<numShares; j++){
			x[j] = x[j] || subShares[j].x.toString(config.radix);
			y[j] = padLeft(subShares[j].y.toString(2)) + (y[j] ? y[j] : '');
		}
	}
	var padding = config.max.toString(config.radix).length;
	if(withoutPrefix){
		for(var i=0; i<numShares; i++){
			x[i] = bin2hex(y[i]);
		}
	}else{
		for(var i=0; i<numShares; i++){
			x[i] = config.bits.toString(36).toUpperCase() + padLeft(x[i],padding) + bin2hex(y[i]);
		}
	}

	return x;
};

// This is the basic polynomial generation and evaluation function
// for a `config.bits`-length secret (NOT an arbitrary length)
// Note: no error-checking at this stage! If `secrets` is NOT
// a NUMBER less than 2^bits-1, the output will be incorrect!
/** @expose **/
exports._getShares = function(secret, numShares, threshold){
	var shares = [];
	var coeffs = [secret];

	for(var i=1; i<threshold; i++){
//Edit by F. Ruiz
//		coeffs[i] = parseInt(config.rng(config.bits),2);							//original random decimal number of maximum size 2^config.bits
		coeffs[i] = nacl.randomBytes(1)[0];											//using NaCl, for config.bits = 8
//End of F. Ruiz edit
	}
	for(var i=1, len = numShares+1; i<len; i++){
		shares[i-1] = {
			x: i,
			y: horner(i, coeffs)
		}
	}
	return shares;
};

// Polynomial evaluation at `x` using Horner's Method
// TODO: this can possibly be sped up using other methods
// NOTE: fx=fx * x + coeff[i] ->  exp(log(fx) + log(x)) + coeff[i],
//       so if fx===0, just set fx to coeff[i] because
//       using the exp/log form will result in incorrect value
function horner(x, coeffs){
	var logx = config.logs[x];
	var fx = 0;
	for(var i=coeffs.length-1; i>=0; i--){
		if(fx === 0){
			fx = coeffs[i];
			continue;
		}
		fx = config.exps[ (logx + config.logs[fx]) % config.max ] ^ coeffs[i];
	}
	return fx;
};

function inArray(arr,val){
	for(var i = 0,len=arr.length; i < len; i++) {
		if(arr[i] === val){
   		 return true;
	 	}
 	}
	return false;
};

function processShare(share){

	var bits = parseInt(share[0], 36);
	if(bits && (typeof bits !== 'number' || bits%1 !== 0 || bits<defaults.minBits || bits>defaults.maxBits)){
		throw new Error('Number of bits must be an integer between ' + defaults.minBits + ' and ' + defaults.maxBits + ', inclusive.')
	}

	var max = Math.pow(2, bits) - 1;
	var idLength = max.toString(config.radix).length;

	var id = parseInt(share.substr(1, idLength), config.radix);
	if(typeof id !== 'number' || id%1 !== 0 || id<1 || id>max){
		throw new Error('Share id must be an integer between 1 and ' + config.max + ', inclusive.');
	}
	share = share.substr(idLength + 1);
	if(!share.length){
		throw new Error('Invalid share: zero-length share.')
	}
	return {
		'bits': bits,
		'id': id,
		'value': share
	};
};

/** @expose **/
exports._processShare = processShare;

// Protected method that evaluates the Lagrange interpolation
// polynomial at x=`at` for individual config.bits-length
// segments of each share in the `shares` Array.
// Each share is expressed in base `inputRadix`. The output
// is expressed in base `outputRadix'
function combine(at, shares){
	var setBits, share, x = [], y = [], result = '', idx;

	for(var i=0, len = shares.length; i<len; i++){
		share = processShare(shares[i]);
		if(typeof setBits === 'undefined'){
			setBits = share['bits'];
		}else if(share['bits'] !== setBits){
			throw new Error('Mismatched shares: Different bit settings.')
		}

		if(config.bits !== setBits){
			init(setBits);
		}

		if(inArray(x, share['id'])){ // repeated x value?
			continue;
		}

		idx = x.push(share['id']) - 1;
		share = split(hex2bin(share['value']));
		for(var j=0, len2 = share.length; j<len2; j++){
			y[j] = y[j] || [];
			y[j][idx] = share[j];
		}
	}

	for(var i=0, len=y.length; i<len; i++){
		result = padLeft(lagrange(at, x, y[i]).toString(2)) + result;
	}

	if(at===0){// reconstructing the secret
		var idx = result.indexOf('1'); //find the first 1
		return bin2hex(result.slice(idx+1));
	}else{// generating a new share
		return bin2hex(result);
	}
};

// Combine `shares` Array into the original secret
/** @expose **/
exports.combine = function(shares){
	return combine(0, shares);
};

// Generate a new share with id `id` (a number between 1 and 2^bits-1)
// `id` can be a Number or a String in the default radix (16)
/** @expose **/
exports.newShare = function(id, shares){
	if(typeof id === 'string'){
		id = parseInt(id, config.radix);
	}

	var share = processShare(shares[0]);
	var max = Math.pow(2, share['bits']) - 1;

	if(typeof id !== 'number' || id%1 !== 0 || id<1 || id>max){
		throw new Error('Share id must be an integer between 1 and ' + config.max + ', inclusive.');
	}

	var padding = max.toString(config.radix).length;
	return config.bits.toString(36).toUpperCase() + padLeft(id.toString(config.radix), padding) + combine(id, shares);
};

// Evaluate the Lagrange interpolation polynomial at x = `at`
// using x and y Arrays that are of the same length, with
// corresponding elements constituting points on the polynomial.
function lagrange(at, x, y){
	var sum = 0,
		product,
		i, j;

	for(var i=0, len = x.length; i<len; i++){
		if(!y[i]){
			continue;
		}

		product = config.logs[y[i]];
		for(var j=0; j<len; j++){
			if(i === j){ continue; }
			if(at === x[j]){ // happens when computing a share that is in the list of shares used to compute it
				product = -1; // fix for a zero product term, after which the sum should be sum^0 = sum, not sum^1
				break;
			}
			product = ( product + config.logs[at ^ x[j]] - config.logs[x[i] ^ x[j]] + config.max/* to make sure it's not negative */ ) % config.max;
		}

		sum = product === -1 ? sum : sum ^ config.exps[product]; // though exps[-1]= undefined and undefined ^ anything = anything in chrome, this behavior may not hold everywhere, so do the check
	}
	return sum;
};

/** @expose **/
exports._lagrange = lagrange;

// Splits a number string `bits`-length segments, after first
// optionally zero-padding it to a length that is a multiple of `padLength.
// Returns array of integers (each less than 2^bits-1), with each element
// representing a `bits`-length segment of the input string from right to left,
// i.e. parts[0] represents the right-most `bits`-length segment of the input string.
function split(str, padLength){
	if(padLength){
		str = padLeft(str, padLength)
	}
	var parts = [];
	for(var i=str.length; i>config.bits; i-=config.bits){
		parts.push(parseInt(str.slice(i-config.bits, i), 2));
	}
	parts.push(parseInt(str.slice(0, i), 2));
	return parts;
};

// Pads a string `str` with zeros on the left so that its length is a multiple of `bits`
function padLeft(str, bits){
	bits = bits || config.bits
//edit by F. Ruiz. This function didn't work well on iPad, so changed it with a different algorithm
//	var missing = str.length % bits;
//	return (missing ? new Array(bits - missing + 1).join('0') : '') + str;
	while(str.length % bits) str = '0' + str;
	return str;
//end of F. Ruiz edit
};

function hex2bin(str){
	var bin = '', num;
	for(var i=str.length - 1; i>=0; i--){
		num = parseInt(str[i], 16)
		if(isNaN(num)){
			throw new Error('Invalid hex character.')
		}
		bin = padLeft(num.toString(2), 4) + bin;
	}
	return bin;
}

function bin2hex(str){
	var hex = '', num;
	str = padLeft(str, 4);
	for(var i=str.length; i>=4; i-=4){
		num = parseInt(str.slice(i-4, i), 2);
		if(isNaN(num)){
			throw new Error('Invalid binary character.')
		}
		hex = num.toString(16) + hex;
	}
	return hex;
}

// Converts a given UTF16 character string to the HEX representation.
// Each character of the input string is represented by
// `bytesPerChar` bytes in the output string.
/** @expose **/
exports.str2hex = function(str, bytesPerChar){
	if(typeof str !== 'string'){
		throw new Error('Input must be a character string.');
	}
	bytesPerChar = bytesPerChar || defaults.bytesPerChar;

	if(typeof bytesPerChar !== 'number' || bytesPerChar%1 !== 0 || bytesPerChar<1 || bytesPerChar > defaults.maxBytesPerChar){
		throw new Error('Bytes per character must be an integer between 1 and ' + defaults.maxBytesPerChar + ', inclusive.')
	}

	var hexChars = 2*bytesPerChar;
	var max = Math.pow(16, hexChars) - 1;
	var out = '', num;
	for(var i=0, len=str.length; i<len; i++){
		num = str[i].charCodeAt();
		if(isNaN(num)){
			throw new Error('Invalid character: ' + str[i]);
		}else if(num > max){
			var neededBytes = Math.ceil(Math.log(num+1)/Math.log(256));
			throw new Error('Invalid character code (' + num +'). Maximum allowable is 256^bytes-1 (' + max + '). To convert this character, use at least ' + neededBytes + ' bytes.')
		}else{
			out = padLeft(num.toString(16), hexChars) + out;
		}
	}
	return out;
};

// Converts a given HEX number string to a UTF16 character string.
/** @expose **/
exports.hex2str = function(str, bytesPerChar){
	if(typeof str !== 'string'){
		throw new Error('Input must be a hexadecimal string.');
	}
	bytesPerChar = bytesPerChar || defaults.bytesPerChar;

	if(typeof bytesPerChar !== 'number' || bytesPerChar%1 !== 0 || bytesPerChar<1 || bytesPerChar > defaults.maxBytesPerChar){
		throw new Error('Bytes per character must be an integer between 1 and ' + defaults.maxBytesPerChar + ', inclusive.')
	}

	var hexChars = 2*bytesPerChar;
	var out = '';
	str = padLeft(str, hexChars);
	for(var i=0, len = str.length; i<len; i+=hexChars){
		out = String.fromCharCode(parseInt(str.slice(i, i+hexChars),16)) + out;
	}
	return out;
};

// by default, initialize without an RNG
exports.init();
})(typeof module !== 'undefined' && module['exports'] ? module['exports'] : (window['secrets'] = {}), typeof GLOBAL !== 'undefined' ? GLOBAL : window );
</script>

<!--Tweet NaCl crypto library 1.0.3 by Dmitry Chestnykh. https://github.com/dchest/tweetnacl-js-->
<script>
(function(nacl) {
'use strict';

// Ported in 2014 by Dmitry Chestnykh and Devi Mandiri.
// Public domain.
//
// Implementation derived from TweetNaCl version 20140427.
// See for details: http://tweetnacl.cr.yp.to/

var u64 = function(h, l) { this.hi = h|0 >>> 0; this.lo = l|0 >>> 0; };
var gf = function(init) {
  var i, r = new Float64Array(16);
  if (init) for (i = 0; i < init.length; i++) r[i] = init[i];
  return r;
};

//  Pluggable, initialized in high-level API below.
var randombytes = function(/* x, n */) { throw new Error('no PRNG'); };

var _0 = new Uint8Array(16);
var _9 = new Uint8Array(32); _9[0] = 9;

var gf0 = gf(),
    gf1 = gf([1]),
    _121665 = gf([0xdb41, 1]),
    D = gf([0x78a3, 0x1359, 0x4dca, 0x75eb, 0xd8ab, 0x4141, 0x0a4d, 0x0070, 0xe898, 0x7779, 0x4079, 0x8cc7, 0xfe73, 0x2b6f, 0x6cee, 0x5203]),
    D2 = gf([0xf159, 0x26b2, 0x9b94, 0xebd6, 0xb156, 0x8283, 0x149a, 0x00e0, 0xd130, 0xeef3, 0x80f2, 0x198e, 0xfce7, 0x56df, 0xd9dc, 0x2406]),
    X = gf([0xd51a, 0x8f25, 0x2d60, 0xc956, 0xa7b2, 0x9525, 0xc760, 0x692c, 0xdc5c, 0xfdd6, 0xe231, 0xc0a4, 0x53fe, 0xcd6e, 0x36d3, 0x2169]),
    Y = gf([0x6658, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666]),
    I = gf([0xa0b0, 0x4a0e, 0x1b27, 0xc4ee, 0xe478, 0xad2f, 0x1806, 0x2f43, 0xd7a7, 0x3dfb, 0x0099, 0x2b4d, 0xdf0b, 0x4fc1, 0x2480, 0x2b83]);

function L32(x, c) { return (x << c) | (x >>> (32 - c)); }

function ld32(x, i) {
  var u = x[i+3] & 0xff;
  u = (u<<8)|(x[i+2] & 0xff);
  u = (u<<8)|(x[i+1] & 0xff);
  return (u<<8)|(x[i+0] & 0xff);
}

function dl64(x, i) {
  var h = (x[i] << 24) | (x[i+1] << 16) | (x[i+2] << 8) | x[i+3];
  var l = (x[i+4] << 24) | (x[i+5] << 16) | (x[i+6] << 8) | x[i+7];
  return new u64(h, l);
}

function st32(x, j, u) {
  var i;
  for (i = 0; i < 4; i++) { x[j+i] = u & 255; u >>>= 8; }
}

function ts64(x, i, u) {
  x[i]   = (u.hi >> 24) & 0xff;
  x[i+1] = (u.hi >> 16) & 0xff;
  x[i+2] = (u.hi >>  8) & 0xff;
  x[i+3] = u.hi & 0xff;
  x[i+4] = (u.lo >> 24)  & 0xff;
  x[i+5] = (u.lo >> 16)  & 0xff;
  x[i+6] = (u.lo >>  8)  & 0xff;
  x[i+7] = u.lo & 0xff;
}

function vn(x, xi, y, yi, n) {
  var i,d = 0;
  for (i = 0; i < n; i++) d |= x[xi+i]^y[yi+i];
  return (1 & ((d - 1) >>> 8)) - 1;
}

function crypto_verify_16(x, xi, y, yi) {
  return vn(x,xi,y,yi,16);
}

function crypto_verify_32(x, xi, y, yi) {
  return vn(x,xi,y,yi,32);
}

function core(out,inp,k,c,h) {
  var w = new Uint32Array(16), x = new Uint32Array(16),
      y = new Uint32Array(16), t = new Uint32Array(4);
  var i, j, m;

  for (i = 0; i < 4; i++) {
    x[5*i] = ld32(c, 4*i);
    x[1+i] = ld32(k, 4*i);
    x[6+i] = ld32(inp, 4*i);
    x[11+i] = ld32(k, 16+4*i);
  }

  for (i = 0; i < 16; i++) y[i] = x[i];

  for (i = 0; i < 20; i++) {
    for (j = 0; j < 4; j++) {
      for (m = 0; m < 4; m++) t[m] = x[(5*j+4*m)%16];
      t[1] ^= L32((t[0]+t[3])|0, 7);
      t[2] ^= L32((t[1]+t[0])|0, 9);
      t[3] ^= L32((t[2]+t[1])|0,13);
      t[0] ^= L32((t[3]+t[2])|0,18);
      for (m = 0; m < 4; m++) w[4*j+(j+m)%4] = t[m];
    }
    for (m = 0; m < 16; m++) x[m] = w[m];
  }

  if (h) {
    for (i = 0; i < 16; i++) x[i] = (x[i] + y[i]) | 0;
    for (i = 0; i < 4; i++) {
      x[5*i] = (x[5*i] - ld32(c, 4*i)) | 0;
      x[6+i] = (x[6+i] - ld32(inp, 4*i)) | 0;
    }
    for (i = 0; i < 4; i++) {
      st32(out,4*i,x[5*i]);
      st32(out,16+4*i,x[6+i]);
    }
  } else {
    for (i = 0; i < 16; i++) st32(out, 4 * i, (x[i] + y[i]) | 0);
  }
}

function crypto_core_salsa20(out,inp,k,c) {
  core(out,inp,k,c,false);
  return 0;
}

function crypto_core_hsalsa20(out,inp,k,c) {
  core(out,inp,k,c,true);
  return 0;
}

var sigma = new Uint8Array([101, 120, 112, 97, 110, 100, 32, 51, 50, 45, 98, 121, 116, 101, 32, 107]);
            // "expand 32-byte k"

function crypto_stream_salsa20_xor(c,cpos,m,mpos,b,n,k) {
  var z = new Uint8Array(16), x = new Uint8Array(64);
  var u, i;
  if (!b) return 0;
  for (i = 0; i < 16; i++) z[i] = 0;
  for (i = 0; i < 8; i++) z[i] = n[i];
  while (b >= 64) {
    crypto_core_salsa20(x,z,k,sigma);
    for (i = 0; i < 64; i++) c[cpos+i] = (m?m[mpos+i]:0) ^ x[i];
    u = 1;
    for (i = 8; i < 16; i++) {
      u = u + (z[i] & 0xff) | 0;
      z[i] = u & 0xff;
      u >>>= 8;
    }
    b -= 64;
    cpos += 64;
    if (m) mpos += 64;
  }
  if (b > 0) {
    crypto_core_salsa20(x,z,k,sigma);
    for (i = 0; i < b; i++) c[cpos+i] = (m?m[mpos+i]:0) ^ x[i];
  }
  return 0;
}

function crypto_stream_salsa20(c,cpos,d,n,k) {
  return crypto_stream_salsa20_xor(c,cpos,null,0,d,n,k);
}

function crypto_stream(c,cpos,d,n,k) {
  var s = new Uint8Array(32);
  crypto_core_hsalsa20(s,n,k,sigma);
  return crypto_stream_salsa20(c,cpos,d,n.subarray(16),s);
}

function crypto_stream_xor(c,cpos,m,mpos,d,n,k) {
  var s = new Uint8Array(32);
  crypto_core_hsalsa20(s,n,k,sigma);
  return crypto_stream_salsa20_xor(c,cpos,m,mpos,d,n.subarray(16),s);
}

function add1305(h, c) {
  var j, u = 0;
  for (j = 0; j < 17; j++) {
    u = (u + ((h[j] + c[j]) | 0)) | 0;
    h[j] = u & 255;
    u >>>= 8;
  }
}

var minusp = new Uint32Array([
  5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 252
]);

function crypto_onetimeauth(out, outpos, m, mpos, n, k) {
  var s, i, j, u;
  var x = new Uint32Array(17), r = new Uint32Array(17),
      h = new Uint32Array(17), c = new Uint32Array(17),
      g = new Uint32Array(17);
  for (j = 0; j < 17; j++) r[j]=h[j]=0;
  for (j = 0; j < 16; j++) r[j]=k[j];
  r[3]&=15;
  r[4]&=252;
  r[7]&=15;
  r[8]&=252;
  r[11]&=15;
  r[12]&=252;
  r[15]&=15;

  while (n > 0) {
    for (j = 0; j < 17; j++) c[j] = 0;
    for (j = 0; (j < 16) && (j < n); ++j) c[j] = m[mpos+j];
    c[j] = 1;
    mpos += j; n -= j;
    add1305(h,c);
    for (i = 0; i < 17; i++) {
      x[i] = 0;
      for (j = 0; j < 17; j++) x[i] = (x[i] + (h[j] * ((j <= i) ? r[i - j] : ((320 * r[i + 17 - j])|0))) | 0) | 0;
    }
    for (i = 0; i < 17; i++) h[i] = x[i];
    u = 0;
    for (j = 0; j < 16; j++) {
      u = (u + h[j]) | 0;
      h[j] = u & 255;
      u >>>= 8;
    }
    u = (u + h[16]) | 0; h[16] = u & 3;
    u = (5 * (u >>> 2)) | 0;
    for (j = 0; j < 16; j++) {
      u = (u + h[j]) | 0;
      h[j] = u & 255;
      u >>>= 8;
    }
    u = (u + h[16]) | 0; h[16] = u;
  }

  for (j = 0; j < 17; j++) g[j] = h[j];
  add1305(h,minusp);
  s = (-(h[16] >>> 7) | 0);
  for (j = 0; j < 17; j++) h[j] ^= s & (g[j] ^ h[j]);

  for (j = 0; j < 16; j++) c[j] = k[j + 16];
  c[16] = 0;
  add1305(h,c);
  for (j = 0; j < 16; j++) out[outpos+j] = h[j];
  return 0;
}

function crypto_onetimeauth_verify(h, hpos, m, mpos, n, k) {
  var x = new Uint8Array(16);
  crypto_onetimeauth(x,0,m,mpos,n,k);
  return crypto_verify_16(h,hpos,x,0);
}

function crypto_secretbox(c,m,d,n,k) {
  var i;
  if (d < 32) return -1;
  crypto_stream_xor(c,0,m,0,d,n,k);
  crypto_onetimeauth(c, 16, c, 32, d - 32, c);
  for (i = 0; i < 16; i++) c[i] = 0;
  return 0;
}

function crypto_secretbox_open(m,c,d,n,k) {
  var i;
  var x = new Uint8Array(32);
  if (d < 32) return -1;
  crypto_stream(x,0,32,n,k);
  if (crypto_onetimeauth_verify(c, 16,c, 32,d - 32,x) !== 0) return -1;
  crypto_stream_xor(m,0,c,0,d,n,k);
  for (i = 0; i < 32; i++) m[i] = 0;
  return 0;
}

function set25519(r, a) {
  var i;
  for (i = 0; i < 16; i++) r[i] = a[i]|0;
}

function car25519(o) {
  var c;
  var i;
  for (i = 0; i < 16; i++) {
      o[i] += 65536;
      c = Math.floor(o[i] / 65536);
      o[(i+1)*(i<15?1:0)] += c - 1 + 37 * (c-1) * (i===15?1:0);
      o[i] -= (c * 65536);
  }
}

function sel25519(p, q, b) {
  var t, c = ~(b-1);
  for (var i = 0; i < 16; i++) {
    t = c & (p[i] ^ q[i]);
    p[i] ^= t;
    q[i] ^= t;
  }
}

function pack25519(o, n) {
  var i, j, b;
  var m = gf(), t = gf();
  for (i = 0; i < 16; i++) t[i] = n[i];
  car25519(t);
  car25519(t);
  car25519(t);
  for (j = 0; j < 2; j++) {
    m[0] = t[0] - 0xffed;
    for (i = 1; i < 15; i++) {
      m[i] = t[i] - 0xffff - ((m[i-1]>>16) & 1);
      m[i-1] &= 0xffff;
    }
    m[15] = t[15] - 0x7fff - ((m[14]>>16) & 1);
    b = (m[15]>>16) & 1;
    m[14] &= 0xffff;
    sel25519(t, m, 1-b);
  }
  for (i = 0; i < 16; i++) {
    o[2*i] = t[i] & 0xff;
    o[2*i+1] = t[i]>>8;
  }
}

function neq25519(a, b) {
  var c = new Uint8Array(32), d = new Uint8Array(32);
  pack25519(c, a);
  pack25519(d, b);
  return crypto_verify_32(c, 0, d, 0);
}

function par25519(a) {
  var d = new Uint8Array(32);
  pack25519(d, a);
  return d[0] & 1;
}

function unpack25519(o, n) {
  var i;
  for (i = 0; i < 16; i++) o[i] = n[2*i] + (n[2*i+1] << 8);
  o[15] &= 0x7fff;
}

function A(o, a, b) {
  var i;
  for (i = 0; i < 16; i++) o[i] = (a[i] + b[i])|0;
}

function Z(o, a, b) {
  var i;
  for (i = 0; i < 16; i++) o[i] = (a[i] - b[i])|0;
}

function M(o, a, b) {
  var i, j, t = new Float64Array(31);
  for (i = 0; i < 31; i++) t[i] = 0;
  for (i = 0; i < 16; i++) {
    for (j = 0; j < 16; j++) {
      t[i+j] += a[i] * b[j];
    }
  }
  for (i = 0; i < 15; i++) {
    t[i] += 38 * t[i+16];
  }
  for (i = 0; i < 16; i++) o[i] = t[i];
  car25519(o);
  car25519(o);
}

function S(o, a) {
  M(o, a, a);
}

function inv25519(o, i) {
  var c = gf();
  var a;
  for (a = 0; a < 16; a++) c[a] = i[a];
  for (a = 253; a >= 0; a--) {
    S(c, c);
    if(a !== 2 && a !== 4) M(c, c, i);
  }
  for (a = 0; a < 16; a++) o[a] = c[a];
}

function pow2523(o, i) {
  var c = gf();
  var a;
  for (a = 0; a < 16; a++) c[a] = i[a];
  for (a = 250; a >= 0; a--) {
      S(c, c);
      if(a !== 1) M(c, c, i);
  }
  for (a = 0; a < 16; a++) o[a] = c[a];
}

function crypto_scalarmult(q, n, p) {
  var z = new Uint8Array(32);
  var x = new Float64Array(80), r, i;
  var a = gf(), b = gf(), c = gf(),
      d = gf(), e = gf(), f = gf();
  for (i = 0; i < 31; i++) z[i] = n[i];
  z[31]=(n[31]&127)|64;
  z[0]&=248;
  unpack25519(x,p);
  for (i = 0; i < 16; i++) {
    b[i]=x[i];
    d[i]=a[i]=c[i]=0;
  }
  a[0]=d[0]=1;
  for (i=254; i>=0; --i) {
    r=(z[i>>>3]>>>(i&7))&1;
    sel25519(a,b,r);
    sel25519(c,d,r);
    A(e,a,c);
    Z(a,a,c);
    A(c,b,d);
    Z(b,b,d);
    S(d,e);
    S(f,a);
    M(a,c,a);
    M(c,b,e);
    A(e,a,c);
    Z(a,a,c);
    S(b,a);
    Z(c,d,f);
    M(a,c,_121665);
    A(a,a,d);
    M(c,c,a);
    M(a,d,f);
    M(d,b,x);
    S(b,e);
    sel25519(a,b,r);
    sel25519(c,d,r);
  }
  for (i = 0; i < 16; i++) {
    x[i+16]=a[i];
    x[i+32]=c[i];
    x[i+48]=b[i];
    x[i+64]=d[i];
  }
  var x32 = x.subarray(32);
  var x16 = x.subarray(16);
  inv25519(x32,x32);
  M(x16,x16,x32);
  pack25519(q,x16);
  return 0;
}

function crypto_scalarmult_base(q, n) {
  return crypto_scalarmult(q, n, _9);
}

function crypto_box_keypair(y, x) {
  randombytes(x, 32);
  return crypto_scalarmult_base(y, x);
}

function crypto_box_beforenm(k, y, x) {
  var s = new Uint8Array(32);
  crypto_scalarmult(s, x, y);
  return crypto_core_hsalsa20(k, _0, s, sigma);
}

var crypto_box_afternm = crypto_secretbox;
var crypto_box_open_afternm = crypto_secretbox_open;

function crypto_box(c, m, d, n, y, x) {
  var k = new Uint8Array(32);
  crypto_box_beforenm(k, y, x);
  return crypto_box_afternm(c, m, d, n, k);
}

function crypto_box_open(m, c, d, n, y, x) {
  var k = new Uint8Array(32);
  crypto_box_beforenm(k, y, x);
  return crypto_box_open_afternm(m, c, d, n, k);
}

function add64() {
  var a = 0, b = 0, c = 0, d = 0, m16 = 65535, l, h, i;
  for (i = 0; i < arguments.length; i++) {
    l = arguments[i].lo;
    h = arguments[i].hi;
    a += (l & m16); b += (l >>> 16);
    c += (h & m16); d += (h >>> 16);
  }

  b += (a >>> 16);
  c += (b >>> 16);
  d += (c >>> 16);

  return new u64((c & m16) | (d << 16), (a & m16) | (b << 16));
}

function shr64(x, c) {
  return new u64((x.hi >>> c), (x.lo >>> c) | (x.hi << (32 - c)));
}

function xor64() {
  var l = 0, h = 0, i;
  for (i = 0; i < arguments.length; i++) {
    l ^= arguments[i].lo;
    h ^= arguments[i].hi;
  }
  return new u64(h, l);
}

function R(x, c) {
  var h, l, c1 = 32 - c;
  if (c < 32) {
    h = (x.hi >>> c) | (x.lo << c1);
    l = (x.lo >>> c) | (x.hi << c1);
  } else if (c < 64) {
    h = (x.lo >>> c) | (x.hi << c1);
    l = (x.hi >>> c) | (x.lo << c1);
  }
  return new u64(h, l);
}

function Ch(x, y, z) {
  var h = (x.hi & y.hi) ^ (~x.hi & z.hi),
      l = (x.lo & y.lo) ^ (~x.lo & z.lo);
  return new u64(h, l);
}

function Maj(x, y, z) {
  var h = (x.hi & y.hi) ^ (x.hi & z.hi) ^ (y.hi & z.hi),
      l = (x.lo & y.lo) ^ (x.lo & z.lo) ^ (y.lo & z.lo);
  return new u64(h, l);
}

function Sigma0(x) { return xor64(R(x,28), R(x,34), R(x,39)); }
function Sigma1(x) { return xor64(R(x,14), R(x,18), R(x,41)); }
function sigma0(x) { return xor64(R(x, 1), R(x, 8), shr64(x,7)); }
function sigma1(x) { return xor64(R(x,19), R(x,61), shr64(x,6)); }

var K = [
  new u64(0x428a2f98, 0xd728ae22), new u64(0x71374491, 0x23ef65cd),
  new u64(0xb5c0fbcf, 0xec4d3b2f), new u64(0xe9b5dba5, 0x8189dbbc),
  new u64(0x3956c25b, 0xf348b538), new u64(0x59f111f1, 0xb605d019),
  new u64(0x923f82a4, 0xaf194f9b), new u64(0xab1c5ed5, 0xda6d8118),
  new u64(0xd807aa98, 0xa3030242), new u64(0x12835b01, 0x45706fbe),
  new u64(0x243185be, 0x4ee4b28c), new u64(0x550c7dc3, 0xd5ffb4e2),
  new u64(0x72be5d74, 0xf27b896f), new u64(0x80deb1fe, 0x3b1696b1),
  new u64(0x9bdc06a7, 0x25c71235), new u64(0xc19bf174, 0xcf692694),
  new u64(0xe49b69c1, 0x9ef14ad2), new u64(0xefbe4786, 0x384f25e3),
  new u64(0x0fc19dc6, 0x8b8cd5b5), new u64(0x240ca1cc, 0x77ac9c65),
  new u64(0x2de92c6f, 0x592b0275), new u64(0x4a7484aa, 0x6ea6e483),
  new u64(0x5cb0a9dc, 0xbd41fbd4), new u64(0x76f988da, 0x831153b5),
  new u64(0x983e5152, 0xee66dfab), new u64(0xa831c66d, 0x2db43210),
  new u64(0xb00327c8, 0x98fb213f), new u64(0xbf597fc7, 0xbeef0ee4),
  new u64(0xc6e00bf3, 0x3da88fc2), new u64(0xd5a79147, 0x930aa725),
  new u64(0x06ca6351, 0xe003826f), new u64(0x14292967, 0x0a0e6e70),
  new u64(0x27b70a85, 0x46d22ffc), new u64(0x2e1b2138, 0x5c26c926),
  new u64(0x4d2c6dfc, 0x5ac42aed), new u64(0x53380d13, 0x9d95b3df),
  new u64(0x650a7354, 0x8baf63de), new u64(0x766a0abb, 0x3c77b2a8),
  new u64(0x81c2c92e, 0x47edaee6), new u64(0x92722c85, 0x1482353b),
  new u64(0xa2bfe8a1, 0x4cf10364), new u64(0xa81a664b, 0xbc423001),
  new u64(0xc24b8b70, 0xd0f89791), new u64(0xc76c51a3, 0x0654be30),
  new u64(0xd192e819, 0xd6ef5218), new u64(0xd6990624, 0x5565a910),
  new u64(0xf40e3585, 0x5771202a), new u64(0x106aa070, 0x32bbd1b8),
  new u64(0x19a4c116, 0xb8d2d0c8), new u64(0x1e376c08, 0x5141ab53),
  new u64(0x2748774c, 0xdf8eeb99), new u64(0x34b0bcb5, 0xe19b48a8),
  new u64(0x391c0cb3, 0xc5c95a63), new u64(0x4ed8aa4a, 0xe3418acb),
  new u64(0x5b9cca4f, 0x7763e373), new u64(0x682e6ff3, 0xd6b2b8a3),
  new u64(0x748f82ee, 0x5defb2fc), new u64(0x78a5636f, 0x43172f60),
  new u64(0x84c87814, 0xa1f0ab72), new u64(0x8cc70208, 0x1a6439ec),
  new u64(0x90befffa, 0x23631e28), new u64(0xa4506ceb, 0xde82bde9),
  new u64(0xbef9a3f7, 0xb2c67915), new u64(0xc67178f2, 0xe372532b),
  new u64(0xca273ece, 0xea26619c), new u64(0xd186b8c7, 0x21c0c207),
  new u64(0xeada7dd6, 0xcde0eb1e), new u64(0xf57d4f7f, 0xee6ed178),
  new u64(0x06f067aa, 0x72176fba), new u64(0x0a637dc5, 0xa2c898a6),
  new u64(0x113f9804, 0xbef90dae), new u64(0x1b710b35, 0x131c471b),
  new u64(0x28db77f5, 0x23047d84), new u64(0x32caab7b, 0x40c72493),
  new u64(0x3c9ebe0a, 0x15c9bebc), new u64(0x431d67c4, 0x9c100d4c),
  new u64(0x4cc5d4be, 0xcb3e42b6), new u64(0x597f299c, 0xfc657e2a),
  new u64(0x5fcb6fab, 0x3ad6faec), new u64(0x6c44198c, 0x4a475817)
];

function crypto_hashblocks(x, m, n) {
  var z = [], b = [], a = [], w = [], t, i, j;

  for (i = 0; i < 8; i++) z[i] = a[i] = dl64(x, 8*i);

  var pos = 0;
  while (n >= 128) {
    for (i = 0; i < 16; i++) w[i] = dl64(m, 8*i+pos);
    for (i = 0; i < 80; i++) {
      for (j = 0; j < 8; j++) b[j] = a[j];
      t = add64(a[7], Sigma1(a[4]), Ch(a[4], a[5], a[6]), K[i], w[i%16]);
      b[7] = add64(t, Sigma0(a[0]), Maj(a[0], a[1], a[2]));
      b[3] = add64(b[3], t);
      for (j = 0; j < 8; j++) a[(j+1)%8] = b[j];
      if (i%16 === 15) {
        for (j = 0; j < 16; j++) {
          w[j] = add64(w[j], w[(j+9)%16], sigma0(w[(j+1)%16]), sigma1(w[(j+14)%16]));
        }
      }
    }

    for (i = 0; i < 8; i++) {
      a[i] = add64(a[i], z[i]);
      z[i] = a[i];
    }

    pos += 128;
    n -= 128;
  }

  for (i = 0; i < 8; i++) ts64(x, 8*i, z[i]);
  return n;
}

var iv = new Uint8Array([
  0x6a,0x09,0xe6,0x67,0xf3,0xbc,0xc9,0x08,
  0xbb,0x67,0xae,0x85,0x84,0xca,0xa7,0x3b,
  0x3c,0x6e,0xf3,0x72,0xfe,0x94,0xf8,0x2b,
  0xa5,0x4f,0xf5,0x3a,0x5f,0x1d,0x36,0xf1,
  0x51,0x0e,0x52,0x7f,0xad,0xe6,0x82,0xd1,
  0x9b,0x05,0x68,0x8c,0x2b,0x3e,0x6c,0x1f,
  0x1f,0x83,0xd9,0xab,0xfb,0x41,0xbd,0x6b,
  0x5b,0xe0,0xcd,0x19,0x13,0x7e,0x21,0x79
]);

function crypto_hash(out, m, n) {
  var h = new Uint8Array(64), x = new Uint8Array(256);
  var i, b = n;

  for (i = 0; i < 64; i++) h[i] = iv[i];

  crypto_hashblocks(h, m, n);
  n %= 128;

  for (i = 0; i < 256; i++) x[i] = 0;
  for (i = 0; i < n; i++) x[i] = m[b-n+i];
  x[n] = 128;

  n = 256-128*(n<112?1:0);
  x[n-9] = 0;
  ts64(x, n-8, new u64((b / 0x20000000) | 0, b << 3));
  crypto_hashblocks(h, x, n);

  for (i = 0; i < 64; i++) out[i] = h[i];

  return 0;
}

function add(p, q) {
  var a = gf(), b = gf(), c = gf(),
      d = gf(), e = gf(), f = gf(),
      g = gf(), h = gf(), t = gf();

  Z(a, p[1], p[0]);
  Z(t, q[1], q[0]);
  M(a, a, t);
  A(b, p[0], p[1]);
  A(t, q[0], q[1]);
  M(b, b, t);
  M(c, p[3], q[3]);
  M(c, c, D2);
  M(d, p[2], q[2]);
  A(d, d, d);
  Z(e, b, a);
  Z(f, d, c);
  A(g, d, c);
  A(h, b, a);

  M(p[0], e, f);
  M(p[1], h, g);
  M(p[2], g, f);
  M(p[3], e, h);
}

function cswap(p, q, b) {
  var i;
  for (i = 0; i < 4; i++) {
    sel25519(p[i], q[i], b);
  }
}

function pack(r, p) {
  var tx = gf(), ty = gf(), zi = gf();
  inv25519(zi, p[2]);
  M(tx, p[0], zi);
  M(ty, p[1], zi);
  pack25519(r, ty);
  r[31] ^= par25519(tx) << 7;
}

function scalarmult(p, q, s) {
  var b, i;
  set25519(p[0], gf0);
  set25519(p[1], gf1);
  set25519(p[2], gf1);
  set25519(p[3], gf0);
  for (i = 255; i >= 0; --i) {
    b = (s[(i/8)|0] >> (i&7)) & 1;
    cswap(p, q, b);
    add(q, p);
    add(p, p);
    cswap(p, q, b);
  }
}

function scalarbase(p, s) {
  var q = [gf(), gf(), gf(), gf()];
  set25519(q[0], X);
  set25519(q[1], Y);
  set25519(q[2], gf1);
  M(q[3], X, Y);
  scalarmult(p, q, s);
}

function crypto_sign_keypair(pk, sk, seeded) {
  var d = new Uint8Array(64);
  var p = [gf(), gf(), gf(), gf()];
  var i;

  if (!seeded) randombytes(sk, 32);
  crypto_hash(d, sk, 32);
  d[0] &= 248;
  d[31] &= 127;
  d[31] |= 64;

  scalarbase(p, d);
  pack(pk, p);

  for (i = 0; i < 32; i++) sk[i+32] = pk[i];
  return 0;
}

var L = new Float64Array([0xed, 0xd3, 0xf5, 0x5c, 0x1a, 0x63, 0x12, 0x58, 0xd6, 0x9c, 0xf7, 0xa2, 0xde, 0xf9, 0xde, 0x14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0x10]);

function modL(r, x) {
  var carry, i, j, k;
  for (i = 63; i >= 32; --i) {
    carry = 0;
    for (j = i - 32, k = i - 12; j < k; ++j) {
      x[j] += carry - 16 * x[i] * L[j - (i - 32)];
      carry = Math.floor((x[j] + 128) / 256);
      x[j] -= carry * 256;
    }
    x[j] += carry;
    x[i] = 0;
  }
  carry = 0;
  for (j = 0; j < 32; j++) {
    x[j] += carry - (x[31] >> 4) * L[j];
    carry = x[j] >> 8;
    x[j] &= 255;
  }
  for (j = 0; j < 32; j++) x[j] -= carry * L[j];
  for (i = 0; i < 32; i++) {
    x[i+1] += x[i] >> 8;
    r[i] = x[i] & 255;
  }
}

function reduce(r) {
  var x = new Float64Array(64), i;
  for (i = 0; i < 64; i++) x[i] = r[i];
  for (i = 0; i < 64; i++) r[i] = 0;
  modL(r, x);
}

// Note: difference from C - smlen returned, not passed as argument.
function crypto_sign(sm, m, n, sk) {
  var d = new Uint8Array(64), h = new Uint8Array(64), r = new Uint8Array(64);
  var i, j, x = new Float64Array(64);
  var p = [gf(), gf(), gf(), gf()];

  crypto_hash(d, sk, 32);
  d[0] &= 248;
  d[31] &= 127;
  d[31] |= 64;

  var smlen = n + 64;
  for (i = 0; i < n; i++) sm[64 + i] = m[i];
  for (i = 0; i < 32; i++) sm[32 + i] = d[32 + i];

  crypto_hash(r, sm.subarray(32), n+32);
  reduce(r);
  scalarbase(p, r);
  pack(sm, p);

  for (i = 32; i < 64; i++) sm[i] = sk[i];
  crypto_hash(h, sm, n + 64);
  reduce(h);

  for (i = 0; i < 64; i++) x[i] = 0;
  for (i = 0; i < 32; i++) x[i] = r[i];
  for (i = 0; i < 32; i++) {
    for (j = 0; j < 32; j++) {
      x[i+j] += h[i] * d[j];
    }
  }

  modL(sm.subarray(32), x);
  return smlen;
}

function unpackneg(r, p) {
  var t = gf(), chk = gf(), num = gf(),
      den = gf(), den2 = gf(), den4 = gf(),
      den6 = gf();

  set25519(r[2], gf1);
  unpack25519(r[1], p);
  S(num, r[1]);
  M(den, num, D);
  Z(num, num, r[2]);
  A(den, r[2], den);

  S(den2, den);
  S(den4, den2);
  M(den6, den4, den2);
  M(t, den6, num);
  M(t, t, den);

  pow2523(t, t);
  M(t, t, num);
  M(t, t, den);
  M(t, t, den);
  M(r[0], t, den);

  S(chk, r[0]);
  M(chk, chk, den);
  if (neq25519(chk, num)) M(r[0], r[0], I);

  S(chk, r[0]);
  M(chk, chk, den);
  if (neq25519(chk, num)) return -1;

  if (par25519(r[0]) === (p[31]>>7)) Z(r[0], gf0, r[0]);

  M(r[3], r[0], r[1]);
  return 0;
}

function crypto_sign_open(m, sm, n, pk) {
  var i;
  var t = new Uint8Array(32), h = new Uint8Array(64);
  var p = [gf(), gf(), gf(), gf()],
      q = [gf(), gf(), gf(), gf()];

  if (n < 64) return -1;

  if (unpackneg(q, pk)) return -1;

  for (i = 0; i < n; i++) m[i] = sm[i];
  for (i = 0; i < 32; i++) m[i+32] = pk[i];
  crypto_hash(h, m, n);
  reduce(h);
  scalarmult(p, q, h);

  scalarbase(q, sm.subarray(32));
  add(p, q);
  pack(t, p);

  n -= 64;
  if (crypto_verify_32(sm, 0, t, 0)) {
    for (i = 0; i < n; i++) m[i] = 0;
    return -1;
  }

  for (i = 0; i < n; i++) m[i] = sm[i + 64];
  return n;
}

var crypto_secretbox_KEYBYTES = 32,
    crypto_secretbox_NONCEBYTES = 24,
    crypto_secretbox_ZEROBYTES = 32,
    crypto_secretbox_BOXZEROBYTES = 16,
    crypto_scalarmult_BYTES = 32,
    crypto_scalarmult_SCALARBYTES = 32,
    crypto_box_PUBLICKEYBYTES = 32,
    crypto_box_SECRETKEYBYTES = 32,
    crypto_box_BEFORENMBYTES = 32,
    crypto_box_NONCEBYTES = crypto_secretbox_NONCEBYTES,
    crypto_box_ZEROBYTES = crypto_secretbox_ZEROBYTES,
    crypto_box_BOXZEROBYTES = crypto_secretbox_BOXZEROBYTES,
    crypto_sign_BYTES = 64,
    crypto_sign_PUBLICKEYBYTES = 32,
    crypto_sign_SECRETKEYBYTES = 64,
    crypto_sign_SEEDBYTES = 32,
    crypto_hash_BYTES = 64;

nacl.lowlevel = {
  crypto_core_hsalsa20: crypto_core_hsalsa20,
  crypto_stream_xor: crypto_stream_xor,
  crypto_stream: crypto_stream,
  crypto_stream_salsa20_xor: crypto_stream_salsa20_xor,
  crypto_stream_salsa20: crypto_stream_salsa20,
  crypto_onetimeauth: crypto_onetimeauth,
  crypto_onetimeauth_verify: crypto_onetimeauth_verify,
  crypto_verify_16: crypto_verify_16,
  crypto_verify_32: crypto_verify_32,
  crypto_secretbox: crypto_secretbox,
  crypto_secretbox_open: crypto_secretbox_open,
  crypto_scalarmult: crypto_scalarmult,
  crypto_scalarmult_base: crypto_scalarmult_base,
  crypto_box_beforenm: crypto_box_beforenm,
  crypto_box_afternm: crypto_box_afternm,
  crypto_box: crypto_box,
  crypto_box_open: crypto_box_open,
  crypto_box_keypair: crypto_box_keypair,
  crypto_hash: crypto_hash,
  crypto_sign: crypto_sign,
  crypto_sign_keypair: crypto_sign_keypair,
  crypto_sign_open: crypto_sign_open,

  crypto_secretbox_KEYBYTES: crypto_secretbox_KEYBYTES,
  crypto_secretbox_NONCEBYTES: crypto_secretbox_NONCEBYTES,
  crypto_secretbox_ZEROBYTES: crypto_secretbox_ZEROBYTES,
  crypto_secretbox_BOXZEROBYTES: crypto_secretbox_BOXZEROBYTES,
  crypto_scalarmult_BYTES: crypto_scalarmult_BYTES,
  crypto_scalarmult_SCALARBYTES: crypto_scalarmult_SCALARBYTES,
  crypto_box_PUBLICKEYBYTES: crypto_box_PUBLICKEYBYTES,
  crypto_box_SECRETKEYBYTES: crypto_box_SECRETKEYBYTES,
  crypto_box_BEFORENMBYTES: crypto_box_BEFORENMBYTES,
  crypto_box_NONCEBYTES: crypto_box_NONCEBYTES,
  crypto_box_ZEROBYTES: crypto_box_ZEROBYTES,
  crypto_box_BOXZEROBYTES: crypto_box_BOXZEROBYTES,
  crypto_sign_BYTES: crypto_sign_BYTES,
  crypto_sign_PUBLICKEYBYTES: crypto_sign_PUBLICKEYBYTES,
  crypto_sign_SECRETKEYBYTES: crypto_sign_SECRETKEYBYTES,
  crypto_sign_SEEDBYTES: crypto_sign_SEEDBYTES,
  crypto_hash_BYTES: crypto_hash_BYTES,

  gf: gf,
  D: D,
  L: L,
  pack25519: pack25519,
  unpack25519: unpack25519,
  M: M,
  A: A,
  S: S,
  Z: Z,
  pow2523: pow2523,
  add: add,
  set25519: set25519,
  modL: modL,
  scalarmult: scalarmult,
  scalarbase: scalarbase,
};

/* High-level API */

function checkLengths(k, n) {
  if (k.length !== crypto_secretbox_KEYBYTES) throw new Error('bad key size');
  if (n.length !== crypto_secretbox_NONCEBYTES) throw new Error('bad nonce size');
}

function checkBoxLengths(pk, sk) {
  if (pk.length !== crypto_box_PUBLICKEYBYTES) throw new Error('bad public key size');
  if (sk.length !== crypto_box_SECRETKEYBYTES) throw new Error('bad secret key size');
}

function checkArrayTypes() {
  for (var i = 0; i < arguments.length; i++) {
    if (!(arguments[i] instanceof Uint8Array))
      throw new TypeError('unexpected type, use Uint8Array');
  }
}

function cleanup(arr) {
  for (var i = 0; i < arr.length; i++) arr[i] = 0;
}

nacl.randomBytes = function(n) {
  var b = new Uint8Array(n);
  randombytes(b, n);
  return b;
};

nacl.secretbox = function(msg, nonce, key) {
  checkArrayTypes(msg, nonce, key);
  checkLengths(key, nonce);
  var m = new Uint8Array(crypto_secretbox_ZEROBYTES + msg.length);
  var c = new Uint8Array(m.length);
  for (var i = 0; i < msg.length; i++) m[i+crypto_secretbox_ZEROBYTES] = msg[i];
  crypto_secretbox(c, m, m.length, nonce, key);
  return c.subarray(crypto_secretbox_BOXZEROBYTES);
};

nacl.secretbox.open = function(box, nonce, key) {
  checkArrayTypes(box, nonce, key);
  checkLengths(key, nonce);
  var c = new Uint8Array(crypto_secretbox_BOXZEROBYTES + box.length);
  var m = new Uint8Array(c.length);
  for (var i = 0; i < box.length; i++) c[i+crypto_secretbox_BOXZEROBYTES] = box[i];
  if (c.length < 32) return null;
  if (crypto_secretbox_open(m, c, c.length, nonce, key) !== 0) return null;
  return m.subarray(crypto_secretbox_ZEROBYTES);
};

nacl.secretbox.keyLength = crypto_secretbox_KEYBYTES;
nacl.secretbox.nonceLength = crypto_secretbox_NONCEBYTES;
nacl.secretbox.overheadLength = crypto_secretbox_BOXZEROBYTES;

nacl.scalarMult = function(n, p) {
  checkArrayTypes(n, p);
  if (n.length !== crypto_scalarmult_SCALARBYTES) throw new Error('bad n size');
  if (p.length !== crypto_scalarmult_BYTES) throw new Error('bad p size');
  var q = new Uint8Array(crypto_scalarmult_BYTES);
  crypto_scalarmult(q, n, p);
  return q;
};

nacl.scalarMult.base = function(n) {
  checkArrayTypes(n);
  if (n.length !== crypto_scalarmult_SCALARBYTES) throw new Error('bad n size');
  var q = new Uint8Array(crypto_scalarmult_BYTES);
  crypto_scalarmult_base(q, n);
  return q;
};

nacl.scalarMult.scalarLength = crypto_scalarmult_SCALARBYTES;
nacl.scalarMult.groupElementLength = crypto_scalarmult_BYTES;

nacl.box = function(msg, nonce, publicKey, secretKey) {
  var k = nacl.box.before(publicKey, secretKey);
  return nacl.secretbox(msg, nonce, k);
};

nacl.box.before = function(publicKey, secretKey) {
  checkArrayTypes(publicKey, secretKey);
  checkBoxLengths(publicKey, secretKey);
  var k = new Uint8Array(crypto_box_BEFORENMBYTES);
  crypto_box_beforenm(k, publicKey, secretKey);
  return k;
};

nacl.box.after = nacl.secretbox;

nacl.box.open = function(msg, nonce, publicKey, secretKey) {
  var k = nacl.box.before(publicKey, secretKey);
  return nacl.secretbox.open(msg, nonce, k);
};

nacl.box.open.after = nacl.secretbox.open;

nacl.box.keyPair = function() {
  var pk = new Uint8Array(crypto_box_PUBLICKEYBYTES);
  var sk = new Uint8Array(crypto_box_SECRETKEYBYTES);
  crypto_box_keypair(pk, sk);
  return {publicKey: pk, secretKey: sk};
};

nacl.box.keyPair.fromSecretKey = function(secretKey) {
  checkArrayTypes(secretKey);
  if (secretKey.length !== crypto_box_SECRETKEYBYTES)
    throw new Error('bad secret key size');
  var pk = new Uint8Array(crypto_box_PUBLICKEYBYTES);
  crypto_scalarmult_base(pk, secretKey);
  return {publicKey: pk, secretKey: new Uint8Array(secretKey)};
};

nacl.box.publicKeyLength = crypto_box_PUBLICKEYBYTES;
nacl.box.secretKeyLength = crypto_box_SECRETKEYBYTES;
nacl.box.sharedKeyLength = crypto_box_BEFORENMBYTES;
nacl.box.nonceLength = crypto_box_NONCEBYTES;
nacl.box.overheadLength = nacl.secretbox.overheadLength;

nacl.sign = function(msg, secretKey) {
  checkArrayTypes(msg, secretKey);
  if (secretKey.length !== crypto_sign_SECRETKEYBYTES)
    throw new Error('bad secret key size');
  var signedMsg = new Uint8Array(crypto_sign_BYTES+msg.length);
  crypto_sign(signedMsg, msg, msg.length, secretKey);
  return signedMsg;
};

nacl.sign.open = function(signedMsg, publicKey) {
  checkArrayTypes(signedMsg, publicKey);
  if (publicKey.length !== crypto_sign_PUBLICKEYBYTES)
    throw new Error('bad public key size');
  var tmp = new Uint8Array(signedMsg.length);
  var mlen = crypto_sign_open(tmp, signedMsg, signedMsg.length, publicKey);
  if (mlen < 0) return null;
  var m = new Uint8Array(mlen);
  for (var i = 0; i < m.length; i++) m[i] = tmp[i];
  return m;
};

nacl.sign.detached = function(msg, secretKey) {
  var signedMsg = nacl.sign(msg, secretKey);
  var sig = new Uint8Array(crypto_sign_BYTES);
  for (var i = 0; i < sig.length; i++) sig[i] = signedMsg[i];
  return sig;
};

nacl.sign.detached.verify = function(msg, sig, publicKey) {
  checkArrayTypes(msg, sig, publicKey);
  if (sig.length !== crypto_sign_BYTES)
    throw new Error('bad signature size');
  if (publicKey.length !== crypto_sign_PUBLICKEYBYTES)
    throw new Error('bad public key size');
  var sm = new Uint8Array(crypto_sign_BYTES + msg.length);
  var m = new Uint8Array(crypto_sign_BYTES + msg.length);
  var i;
  for (i = 0; i < crypto_sign_BYTES; i++) sm[i] = sig[i];
  for (i = 0; i < msg.length; i++) sm[i+crypto_sign_BYTES] = msg[i];
  return (crypto_sign_open(m, sm, sm.length, publicKey) >= 0);
};

nacl.sign.keyPair = function() {
  var pk = new Uint8Array(crypto_sign_PUBLICKEYBYTES);
  var sk = new Uint8Array(crypto_sign_SECRETKEYBYTES);
  crypto_sign_keypair(pk, sk);
  return {publicKey: pk, secretKey: sk};
};

nacl.sign.keyPair.fromSecretKey = function(secretKey) {
  checkArrayTypes(secretKey);
  if (secretKey.length !== crypto_sign_SECRETKEYBYTES)
    throw new Error('bad secret key size');
  var pk = new Uint8Array(crypto_sign_PUBLICKEYBYTES);
  for (var i = 0; i < pk.length; i++) pk[i] = secretKey[32+i];
  return {publicKey: pk, secretKey: new Uint8Array(secretKey)};
};

nacl.sign.keyPair.fromSeed = function(seed) {
  checkArrayTypes(seed);
  if (seed.length !== crypto_sign_SEEDBYTES)
    throw new Error('bad seed size');
  var pk = new Uint8Array(crypto_sign_PUBLICKEYBYTES);
  var sk = new Uint8Array(crypto_sign_SECRETKEYBYTES);
  for (var i = 0; i < 32; i++) sk[i] = seed[i];
  crypto_sign_keypair(pk, sk, true);
  return {publicKey: pk, secretKey: sk};
};

nacl.sign.publicKeyLength = crypto_sign_PUBLICKEYBYTES;
nacl.sign.secretKeyLength = crypto_sign_SECRETKEYBYTES;
nacl.sign.seedLength = crypto_sign_SEEDBYTES;
nacl.sign.signatureLength = crypto_sign_BYTES;

nacl.hash = function(msg) {
  checkArrayTypes(msg);
  var h = new Uint8Array(crypto_hash_BYTES);
  crypto_hash(h, msg, msg.length);
  return h;
};

nacl.hash.hashLength = crypto_hash_BYTES;

nacl.verify = function(x, y) {
  checkArrayTypes(x, y);
  // Zero length arguments are considered not equal.
  if (x.length === 0 || y.length === 0) return false;
  if (x.length !== y.length) return false;
  return (vn(x, 0, y, 0, x.length) === 0) ? true : false;
};

nacl.setPRNG = function(fn) {
  randombytes = fn;
};

(function() {
  // Initialize PRNG if environment provides CSPRNG.
  // If not, methods calling randombytes will throw.
  var crypto = typeof self !== 'undefined' ? (self.crypto || self.msCrypto) : null;
  if (crypto && crypto.getRandomValues) {
    // Browsers.
    var QUOTA = 65536;
    nacl.setPRNG(function(x, n) {
      var i, v = new Uint8Array(n);
      for (i = 0; i < n; i += QUOTA) {
        crypto.getRandomValues(v.subarray(i, i + Math.min(n - i, QUOTA)));
      }
      for (i = 0; i < n; i++) x[i] = v[i];
      cleanup(v);
    });
  } else if (typeof require !== 'undefined') {
    // Node.js.
    crypto = require('crypto');
    if (crypto && crypto.randomBytes) {
      nacl.setPRNG(function(x, n) {
        var i, v = crypto.randomBytes(n);
        for (i = 0; i < n; i++) x[i] = v[i];
        cleanup(v);
      });
    }
  }
})();

})(typeof module !== 'undefined' && module.exports ? module.exports : (self.nacl = self.nacl || {}));
</script>

<!--ed2curve-js conversion of curve coordinates 0.2.1 by Dmitry Chestnykh. https://github.com/dchest/ed2curve-js-->
<script>
/*
 * ed2curve: convert Ed25519 signing key pair into Curve25519
 * key pair suitable for Diffie-Hellman key exchange.
 *
 * Written by Dmitry Chestnykh in 2014. Public domain.
 */
/* jshint newcap: false */
(function(root, f) {
  'use strict';
  if (typeof module !== 'undefined' && module.exports) module.exports = f(require('tweetnacl/nacl-fast'));
  else root.ed2curve = f(root.nacl);
}(this, function(nacl) {
  'use strict';
  if (!nacl) throw new Error('tweetnacl not loaded');

  // -- Operations copied from TweetNaCl.js. --

  var gf = function(init) {
    var i, r = new Float64Array(16);
    if (init) for (i = 0; i < init.length; i++) r[i] = init[i];
    return r;
  };

  var gf0 = gf(),
      gf1 = gf([1]),
      D = gf([0x78a3, 0x1359, 0x4dca, 0x75eb, 0xd8ab, 0x4141, 0x0a4d, 0x0070, 0xe898, 0x7779, 0x4079, 0x8cc7, 0xfe73, 0x2b6f, 0x6cee, 0x5203]),
      I = gf([0xa0b0, 0x4a0e, 0x1b27, 0xc4ee, 0xe478, 0xad2f, 0x1806, 0x2f43, 0xd7a7, 0x3dfb, 0x0099, 0x2b4d, 0xdf0b, 0x4fc1, 0x2480, 0x2b83]);



  function car25519(o) {
    var c;
    var i;
    for (i = 0; i < 16; i++) {
      o[i] += 65536;
      c = Math.floor(o[i] / 65536);
      o[(i+1)*(i<15?1:0)] += c - 1 + 37 * (c-1) * (i===15?1:0);
      o[i] -= (c * 65536);
    }
  }

  function sel25519(p, q, b) {
    var t, c = ~(b-1);
    for (var i = 0; i < 16; i++) {
      t = c & (p[i] ^ q[i]);
      p[i] ^= t;
      q[i] ^= t;
    }
  }

  function unpack25519(o, n) {
    var i;
    for (i = 0; i < 16; i++) o[i] = n[2*i] + (n[2*i+1] << 8);
    o[15] &= 0x7fff;
  }

  // addition
  function A(o, a, b) {
    var i;
    for (i = 0; i < 16; i++) o[i] = (a[i] + b[i])|0;
  }

  // subtraction
  function Z(o, a, b) {
    var i;
    for (i = 0; i < 16; i++) o[i] = (a[i] - b[i])|0;
  }

  // multiplication
  function M(o, a, b) {
    var i, j, t = new Float64Array(31);
    for (i = 0; i < 31; i++) t[i] = 0;
    for (i = 0; i < 16; i++) {
      for (j = 0; j < 16; j++) {
        t[i+j] += a[i] * b[j];
      }
    }
    for (i = 0; i < 15; i++) {
      t[i] += 38 * t[i+16];
    }
    for (i = 0; i < 16; i++) o[i] = t[i];
    car25519(o);
    car25519(o);
  }

  // squaring
  function S(o, a) {
    M(o, a, a);
  }

  // inversion
  function inv25519(o, i) {
    var c = gf();
    var a;
    for (a = 0; a < 16; a++) c[a] = i[a];
    for (a = 253; a >= 0; a--) {
      S(c, c);
      if(a !== 2 && a !== 4) M(c, c, i);
    }
    for (a = 0; a < 16; a++) o[a] = c[a];
  }

  function pack25519(o, n) {
    var i, j, b;
    var m = gf(), t = gf();
    for (i = 0; i < 16; i++) t[i] = n[i];
    car25519(t);
    car25519(t);
    car25519(t);
    for (j = 0; j < 2; j++) {
      m[0] = t[0] - 0xffed;
      for (i = 1; i < 15; i++) {
        m[i] = t[i] - 0xffff - ((m[i-1]>>16) & 1);
        m[i-1] &= 0xffff;
      }
      m[15] = t[15] - 0x7fff - ((m[14]>>16) & 1);
      b = (m[15]>>16) & 1;
      m[14] &= 0xffff;
      sel25519(t, m, 1-b);
    }
    for (i = 0; i < 16; i++) {
      o[2*i] = t[i] & 0xff;
      o[2*i+1] = t[i] >> 8;
    }
  }


  function par25519(a) {
    var d = new Uint8Array(32);
    pack25519(d, a);
    return d[0] & 1;
  }



  function vn(x, xi, y, yi, n) {
    var i, d = 0;
    for (i = 0; i < n; i++) d |= x[xi + i] ^ y[yi + i];
    return (1 & ((d - 1) >>> 8)) - 1;
  }


  function crypto_verify_32(x, xi, y, yi) {
    return vn(x, xi, y, yi, 32);
  }

  function neq25519(a, b) {
    var c = new Uint8Array(32), d = new Uint8Array(32);
    pack25519(c, a);
    pack25519(d, b);
    return crypto_verify_32(c, 0, d, 0);
  }


  function pow2523(o, i) {
    var c = gf();
    var a;
    for (a = 0; a < 16; a++) c[a] = i[a];
    for (a = 250; a >= 0; a--) {
      S(c, c);
      if (a !== 1) M(c, c, i);
    }
    for (a = 0; a < 16; a++) o[a] = c[a];
  }

  function set25519(r, a) {
    var i;
    for (i = 0; i < 16; i++) r[i] = a[i] | 0;
  }

  function unpackneg(r, p) {
    var t = gf(), chk = gf(), num = gf(),
      den = gf(), den2 = gf(), den4 = gf(),
      den6 = gf();

    set25519(r[2], gf1);
    unpack25519(r[1], p);
    S(num, r[1]);
    M(den, num, D);
    Z(num, num, r[2]);
    A(den, r[2], den);

    S(den2, den);
    S(den4, den2);
    M(den6, den4, den2);
    M(t, den6, num);
    M(t, t, den);

    pow2523(t, t);
    M(t, t, num);
    M(t, t, den);
    M(t, t, den);
    M(r[0], t, den);

    S(chk, r[0]);
    M(chk, chk, den);
    if (neq25519(chk, num)) M(r[0], r[0], I);

    S(chk, r[0]);
    M(chk, chk, den);
    if (neq25519(chk, num)) return -1;

    if (par25519(r[0]) === (p[31] >> 7)) Z(r[0], gf0, r[0]);

    M(r[3], r[0], r[1]);
    return 0;
  }

  // ----

  // Converts Ed25519 public key to Curve25519 public key.
  // montgomeryX = (edwardsY + 1)*inverse(1 - edwardsY) mod p
  function convertPublicKey(pk) {
    var z = new Uint8Array(32),
      q = [gf(), gf(), gf(), gf()],
      a = gf(), b = gf();

    if (unpackneg(q, pk)) return null; // reject invalid key

    var y = q[1];

    A(a, gf1, y);
    Z(b, gf1, y);
    inv25519(b, b);
    M(a, a, b);

    pack25519(z, a);
    return z;
  }

  // Converts Ed25519 secret key to Curve25519 secret key.
  function convertSecretKey(sk) {
    var d = new Uint8Array(64), o = new Uint8Array(32), i;
    nacl.lowlevel.crypto_hash(d, sk, 32);
    d[0] &= 248;
    d[31] &= 127;
    d[31] |= 64;
    for (i = 0; i < 32; i++) o[i] = d[i];
    for (i = 0; i < 64; i++) d[i] = 0;
    return o;
  }

  function convertKeyPair(edKeyPair) {
    var publicKey = convertPublicKey(edKeyPair.publicKey);
    if (!publicKey) return null;
    return {
      publicKey: publicKey,
      secretKey: convertSecretKey(edKeyPair.secretKey)
    };
  }

  return {
    convertPublicKey: convertPublicKey,
    convertSecretKey: convertSecretKey,
    convertKeyPair: convertKeyPair,
  };

}));
</script>

<!--scrypt-async-js KDF 2.0.1 by Dmitry Chestnykh. https://github.com/dchest/scrypt-async-js-->
<script>
/*!
 * Fast "async" scrypt implementation in JavaScript.
 * Copyright (c) 2013-2016 Dmitry Chestnykh | BSD License
 * https://github.com/dchest/scrypt-async-js
 */

/**
 * scrypt(password, salt, options, callback)
 *
 * where
 *
 * password and salt are strings or arrays of bytes (Array of Uint8Array)
 * options is
 *
 * {
 *    N:      // CPU/memory cost parameter, must be power of two
 *            // (alternatively, you can specify logN)
 *    r:      // block size
 *    p:      // parallelization parameter
 *    dkLen:  // length of derived key, default = 32
 *    encoding: // optional encoding:
 *                    "base64" - standard Base64 encoding
 *                    "hex" — hex encoding,
 *                    "binary" — Uint8Array,
 *                    undefined/null - Array of bytes
 *    interruptStep: // optional, steps to split calculations (default is 0)
 * }
 *
 * Derives a key from password and salt and calls callback
 * with derived key as the only argument.
 *
 * Calculations are interrupted with setImmediate (or zero setTimeout) at the
 * given interruptSteps to avoid freezing the browser. If it's undefined or zero,
 * the callback is called immediately after the calculation, avoiding setImmediate.
 *
 * Legacy way (only supports p = 1) to call this function is:
 *
 * scrypt(password, salt, logN, r, dkLen, [interruptStep], callback, [encoding])
 *
 * In legacy API, if interruptStep is not given, it defaults to 1000.
 * Pass 0 to have callback called immediately.
 *
 */
function scrypt(password, salt, logN, r, dkLen, interruptStep, callback, encoding) {
  'use strict';

  function SHA256(m) {
    /** @const */ var K = [
      0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b,
      0x59f111f1, 0x923f82a4, 0xab1c5ed5, 0xd807aa98, 0x12835b01,
      0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7,
      0xc19bf174, 0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc,
      0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da, 0x983e5152,
      0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147,
      0x06ca6351, 0x14292967, 0x27b70a85, 0x2e1b2138, 0x4d2c6dfc,
      0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
      0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819,
      0xd6990624, 0xf40e3585, 0x106aa070, 0x19a4c116, 0x1e376c08,
      0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f,
      0x682e6ff3, 0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208,
      0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
    ];

    var h0 = 0x6a09e667, h1 = 0xbb67ae85, h2 = 0x3c6ef372, h3 = 0xa54ff53a,
        h4 = 0x510e527f, h5 = 0x9b05688c, h6 = 0x1f83d9ab, h7 = 0x5be0cd19,
        w = new Array(64);

    function blocks(p) {
      var off = 0, len = p.length;
      while (len >= 64) {
        var a = h0, b = h1, c = h2, d = h3, e = h4, f = h5, g = h6, h = h7,
            u, i, j, t1, t2;

        for (i = 0; i < 16; i++) {
          j = off + i*4;
          w[i] = ((p[j] & 0xff)<<24) | ((p[j+1] & 0xff)<<16) |
                 ((p[j+2] & 0xff)<<8) | (p[j+3] & 0xff);
        }

        for (i = 16; i < 64; i++) {
          u = w[i-2];
          t1 = ((u>>>17) | (u<<(32-17))) ^ ((u>>>19) | (u<<(32-19))) ^ (u>>>10);

          u = w[i-15];
          t2 = ((u>>>7) | (u<<(32-7))) ^ ((u>>>18) | (u<<(32-18))) ^ (u>>>3);

          w[i] = (((t1 + w[i-7]) | 0) + ((t2 + w[i-16]) | 0)) | 0;
        }

        for (i = 0; i < 64; i++) {
          t1 = ((((((e>>>6) | (e<<(32-6))) ^ ((e>>>11) | (e<<(32-11))) ^
               ((e>>>25) | (e<<(32-25)))) + ((e & f) ^ (~e & g))) | 0) +
               ((h + ((K[i] + w[i]) | 0)) | 0)) | 0;

          t2 = ((((a>>>2) | (a<<(32-2))) ^ ((a>>>13) | (a<<(32-13))) ^
               ((a>>>22) | (a<<(32-22)))) + ((a & b) ^ (a & c) ^ (b & c))) | 0;

          h = g;
          g = f;
          f = e;
          e = (d + t1) | 0;
          d = c;
          c = b;
          b = a;
          a = (t1 + t2) | 0;
        }

        h0 = (h0 + a) | 0;
        h1 = (h1 + b) | 0;
        h2 = (h2 + c) | 0;
        h3 = (h3 + d) | 0;
        h4 = (h4 + e) | 0;
        h5 = (h5 + f) | 0;
        h6 = (h6 + g) | 0;
        h7 = (h7 + h) | 0;

        off += 64;
        len -= 64;
      }
    }

    blocks(m);

    var i, bytesLeft = m.length % 64,
        bitLenHi = (m.length / 0x20000000) | 0,
        bitLenLo = m.length << 3,
        numZeros = (bytesLeft < 56) ? 56 : 120,
        p = m.slice(m.length - bytesLeft, m.length);

    p.push(0x80);
    for (i = bytesLeft + 1; i < numZeros; i++) p.push(0);
    p.push((bitLenHi>>>24) & 0xff);
    p.push((bitLenHi>>>16) & 0xff);
    p.push((bitLenHi>>>8)  & 0xff);
    p.push((bitLenHi>>>0)  & 0xff);
    p.push((bitLenLo>>>24) & 0xff);
    p.push((bitLenLo>>>16) & 0xff);
    p.push((bitLenLo>>>8)  & 0xff);
    p.push((bitLenLo>>>0)  & 0xff);

    blocks(p);

    return [
      (h0>>>24) & 0xff, (h0>>>16) & 0xff, (h0>>>8) & 0xff, (h0>>>0) & 0xff,
      (h1>>>24) & 0xff, (h1>>>16) & 0xff, (h1>>>8) & 0xff, (h1>>>0) & 0xff,
      (h2>>>24) & 0xff, (h2>>>16) & 0xff, (h2>>>8) & 0xff, (h2>>>0) & 0xff,
      (h3>>>24) & 0xff, (h3>>>16) & 0xff, (h3>>>8) & 0xff, (h3>>>0) & 0xff,
      (h4>>>24) & 0xff, (h4>>>16) & 0xff, (h4>>>8) & 0xff, (h4>>>0) & 0xff,
      (h5>>>24) & 0xff, (h5>>>16) & 0xff, (h5>>>8) & 0xff, (h5>>>0) & 0xff,
      (h6>>>24) & 0xff, (h6>>>16) & 0xff, (h6>>>8) & 0xff, (h6>>>0) & 0xff,
      (h7>>>24) & 0xff, (h7>>>16) & 0xff, (h7>>>8) & 0xff, (h7>>>0) & 0xff
    ];
  }

  function PBKDF2_HMAC_SHA256_OneIter(password, salt, dkLen) {
    // compress password if it's longer than hash block length
    if(password.length > 64) {
      // SHA256 expects password to be an Array. If it's not
      // (i.e. it doesn't have .push method), convert it to one.
      password = SHA256(password.push ? password : Array.prototype.slice.call(password, 0));
    }

    var i, innerLen = 64 + salt.length + 4,
        inner = new Array(innerLen),
        outerKey = new Array(64),
        dk = [];

    // inner = (password ^ ipad) || salt || counter
    for (i = 0; i < 64; i++) inner[i] = 0x36;
    for (i = 0; i < password.length; i++) inner[i] ^= password[i];
    for (i = 0; i < salt.length; i++) inner[64+i] = salt[i];
    for (i = innerLen - 4; i < innerLen; i++) inner[i] = 0;

    // outerKey = password ^ opad
    for (i = 0; i < 64; i++) outerKey[i] = 0x5c;
    for (i = 0; i < password.length; i++) outerKey[i] ^= password[i];

    // increments counter inside inner
    function incrementCounter() {
      for (var i = innerLen-1; i >= innerLen-4; i--) {
        inner[i]++;
        if (inner[i] <= 0xff) return;
        inner[i] = 0;
      }
    }

    // output blocks = SHA256(outerKey || SHA256(inner)) ...
    while (dkLen >= 32) {
      incrementCounter();
      dk = dk.concat(SHA256(outerKey.concat(SHA256(inner))));
      dkLen -= 32;
    }
    if (dkLen > 0) {
      incrementCounter();
      dk = dk.concat(SHA256(outerKey.concat(SHA256(inner))).slice(0, dkLen));
    }
    return dk;
  }

  function salsaXOR(tmp, B, bin, bout) {
    var j0  = tmp[0]  ^ B[bin++],
        j1  = tmp[1]  ^ B[bin++],
        j2  = tmp[2]  ^ B[bin++],
        j3  = tmp[3]  ^ B[bin++],
        j4  = tmp[4]  ^ B[bin++],
        j5  = tmp[5]  ^ B[bin++],
        j6  = tmp[6]  ^ B[bin++],
        j7  = tmp[7]  ^ B[bin++],
        j8  = tmp[8]  ^ B[bin++],
        j9  = tmp[9]  ^ B[bin++],
        j10 = tmp[10] ^ B[bin++],
        j11 = tmp[11] ^ B[bin++],
        j12 = tmp[12] ^ B[bin++],
        j13 = tmp[13] ^ B[bin++],
        j14 = tmp[14] ^ B[bin++],
        j15 = tmp[15] ^ B[bin++],
        u, i;

    var x0 = j0, x1 = j1, x2 = j2, x3 = j3, x4 = j4, x5 = j5, x6 = j6, x7 = j7,
        x8 = j8, x9 = j9, x10 = j10, x11 = j11, x12 = j12, x13 = j13, x14 = j14,
        x15 = j15;

    for (i = 0; i < 8; i += 2) {
      u =  x0 + x12;   x4 ^= u<<7  | u>>>(32-7);
      u =  x4 +  x0;   x8 ^= u<<9  | u>>>(32-9);
      u =  x8 +  x4;  x12 ^= u<<13 | u>>>(32-13);
      u = x12 +  x8;   x0 ^= u<<18 | u>>>(32-18);

      u =  x5 +  x1;   x9 ^= u<<7  | u>>>(32-7);
      u =  x9 +  x5;  x13 ^= u<<9  | u>>>(32-9);
      u = x13 +  x9;   x1 ^= u<<13 | u>>>(32-13);
      u =  x1 + x13;   x5 ^= u<<18 | u>>>(32-18);

      u = x10 +  x6;  x14 ^= u<<7  | u>>>(32-7);
      u = x14 + x10;   x2 ^= u<<9  | u>>>(32-9);
      u =  x2 + x14;   x6 ^= u<<13 | u>>>(32-13);
      u =  x6 +  x2;  x10 ^= u<<18 | u>>>(32-18);

      u = x15 + x11;   x3 ^= u<<7  | u>>>(32-7);
      u =  x3 + x15;   x7 ^= u<<9  | u>>>(32-9);
      u =  x7 +  x3;  x11 ^= u<<13 | u>>>(32-13);
      u = x11 +  x7;  x15 ^= u<<18 | u>>>(32-18);

      u =  x0 +  x3;   x1 ^= u<<7  | u>>>(32-7);
      u =  x1 +  x0;   x2 ^= u<<9  | u>>>(32-9);
      u =  x2 +  x1;   x3 ^= u<<13 | u>>>(32-13);
      u =  x3 +  x2;   x0 ^= u<<18 | u>>>(32-18);

      u =  x5 +  x4;   x6 ^= u<<7  | u>>>(32-7);
      u =  x6 +  x5;   x7 ^= u<<9  | u>>>(32-9);
      u =  x7 +  x6;   x4 ^= u<<13 | u>>>(32-13);
      u =  x4 +  x7;   x5 ^= u<<18 | u>>>(32-18);

      u = x10 +  x9;  x11 ^= u<<7  | u>>>(32-7);
      u = x11 + x10;   x8 ^= u<<9  | u>>>(32-9);
      u =  x8 + x11;   x9 ^= u<<13 | u>>>(32-13);
      u =  x9 +  x8;  x10 ^= u<<18 | u>>>(32-18);

      u = x15 + x14;  x12 ^= u<<7  | u>>>(32-7);
      u = x12 + x15;  x13 ^= u<<9  | u>>>(32-9);
      u = x13 + x12;  x14 ^= u<<13 | u>>>(32-13);
      u = x14 + x13;  x15 ^= u<<18 | u>>>(32-18);
    }

    B[bout++] = tmp[0]  = (x0  + j0)  | 0;
    B[bout++] = tmp[1]  = (x1  + j1)  | 0;
    B[bout++] = tmp[2]  = (x2  + j2)  | 0;
    B[bout++] = tmp[3]  = (x3  + j3)  | 0;
    B[bout++] = tmp[4]  = (x4  + j4)  | 0;
    B[bout++] = tmp[5]  = (x5  + j5)  | 0;
    B[bout++] = tmp[6]  = (x6  + j6)  | 0;
    B[bout++] = tmp[7]  = (x7  + j7)  | 0;
    B[bout++] = tmp[8]  = (x8  + j8)  | 0;
    B[bout++] = tmp[9]  = (x9  + j9)  | 0;
    B[bout++] = tmp[10] = (x10 + j10) | 0;
    B[bout++] = tmp[11] = (x11 + j11) | 0;
    B[bout++] = tmp[12] = (x12 + j12) | 0;
    B[bout++] = tmp[13] = (x13 + j13) | 0;
    B[bout++] = tmp[14] = (x14 + j14) | 0;
    B[bout++] = tmp[15] = (x15 + j15) | 0;
  }

  function blockCopy(dst, di, src, si, len) {
    while (len--) dst[di++] = src[si++];
  }

  function blockXOR(dst, di, src, si, len) {
    while (len--) dst[di++] ^= src[si++];
  }

  function blockMix(tmp, B, bin, bout, r) {
    blockCopy(tmp, 0, B, bin + (2*r-1)*16, 16);
    for (var i = 0; i < 2*r; i += 2) {
      salsaXOR(tmp, B, bin + i*16,      bout + i*8);
      salsaXOR(tmp, B, bin + i*16 + 16, bout + i*8 + r*16);
    }
  }

  function integerify(B, bi, r) {
    return B[bi+(2*r-1)*16];
  }

  function stringToUTF8Bytes(s) {
    var arr = [];
    for (var i = 0; i < s.length; i++) {
      var c = s.charCodeAt(i);
      if (c < 0x80) {
        arr.push(c);
      } else if (c < 0x800) {
        arr.push(0xc0 | c >> 6);
        arr.push(0x80 | c & 0x3f);
      } else if (c < 0xd800) {
        arr.push(0xe0 | c >> 12);
        arr.push(0x80 | (c >> 6) & 0x3f);
        arr.push(0x80 | c & 0x3f);
      } else {
        if (i >= s.length - 1) {
          throw new Error('invalid string');
        }
        i++; // get one more character
        c = (c & 0x3ff) << 10;
        c |= s.charCodeAt(i) & 0x3ff;
        c += 0x10000;

        arr.push(0xf0 | c >> 18);
        arr.push(0x80 | (c >> 12) & 0x3f);
        arr.push(0x80 | (c >> 6) & 0x3f);
        arr.push(0x80 | c & 0x3f);
      }
    }
    return arr;
  }

  function bytesToHex(p) {
    /** @const */
    var enc = '0123456789abcdef'.split('');

    var len = p.length,
        arr = [],
        i = 0;

    for (; i < len; i++) {
        arr.push(enc[(p[i]>>>4) & 15]);
        arr.push(enc[(p[i]>>>0) & 15]);
    }
    return arr.join('');
  }

  function bytesToBase64(p) {
    /** @const */
    var enc = ('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz' +
              '0123456789+/').split('');

    var len = p.length,
        arr = [],
        i = 0,
        a, b, c, t;

    while (i < len) {
      a = i < len ? p[i++] : 0;
      b = i < len ? p[i++] : 0;
      c = i < len ? p[i++] : 0;
      t = (a << 16) + (b << 8) + c;
      arr.push(enc[(t >>> 3 * 6) & 63]);
      arr.push(enc[(t >>> 2 * 6) & 63]);
      arr.push(enc[(t >>> 1 * 6) & 63]);
      arr.push(enc[(t >>> 0 * 6) & 63]);
    }
    if (len % 3 > 0) {
      arr[arr.length-1] = '=';
      if (len % 3 === 1) arr[arr.length-2] = '=';
    }
    return arr.join('');
  }


  // Generate key.

  var MAX_UINT = (-1)>>>0,
      p = 1;

  if (typeof logN === "object") {
    // Called as: scrypt(password, salt, opts, callback)
    if (arguments.length > 4) {
      throw new Error('scrypt: incorrect number of arguments');
    }

    var opts = logN;

    callback = r;
    logN = opts.logN;
    if (typeof logN === 'undefined') {
      if (typeof opts.N !== 'undefined') {
        if (opts.N < 2 || opts.N > MAX_UINT)
          throw new Error('scrypt: N is out of range');

        if ((opts.N & (opts.N - 1)) !== 0)
          throw new Error('scrypt: N is not a power of 2');

        logN = Math.log(opts.N) / Math.LN2;
      } else {
        throw new Error('scrypt: missing N parameter');
      }
    }

    // XXX: If opts.p or opts.dkLen is 0, it will be set to the default value
    // instead of throwing due to incorrect value. To avoid breaking
    // compatibility, this will only be changed in the next major version.
    p = opts.p || 1;
    r = opts.r;
    dkLen = opts.dkLen || 32;
    interruptStep = opts.interruptStep || 0;
    encoding = opts.encoding;
  }

  if (p < 1)
    throw new Error('scrypt: invalid p');

  if (r <= 0)
    throw new Error('scrypt: invalid r');

  if (logN < 1 || logN > 31)
    throw new Error('scrypt: logN must be between 1 and 31');


  var N = (1<<logN)>>>0,
      XY, V, B, tmp;

  if (r*p >= 1<<30 || r > MAX_UINT/128/p || r > MAX_UINT/256 || N > MAX_UINT/128/r)
    throw new Error('scrypt: parameters are too large');

  // Decode strings.
  if (typeof password === 'string')
    password = stringToUTF8Bytes(password);
  if (typeof salt === 'string')
    salt = stringToUTF8Bytes(salt);

  if (typeof Int32Array !== 'undefined') {
    //XXX We can use Uint32Array, but Int32Array is faster in Safari.
    XY = new Int32Array(64*r);
    V = new Int32Array(32*N*r);
    tmp = new Int32Array(16);
  } else {
    XY = [];
    V = [];
    tmp = new Array(16);
  }
  B = PBKDF2_HMAC_SHA256_OneIter(password, salt, p*128*r);

  var xi = 0, yi = 32 * r;

  function smixStart(pos) {
    for (var i = 0; i < 32*r; i++) {
      var j = pos + i*4;
      XY[xi+i] = ((B[j+3] & 0xff)<<24) | ((B[j+2] & 0xff)<<16) |
                 ((B[j+1] & 0xff)<<8)  | ((B[j+0] & 0xff)<<0);
    }
  }

  function smixStep1(start, end) {
    for (var i = start; i < end; i += 2) {
      blockCopy(V, i*(32*r), XY, xi, 32*r);
      blockMix(tmp, XY, xi, yi, r);

      blockCopy(V, (i+1)*(32*r), XY, yi, 32*r);
      blockMix(tmp, XY, yi, xi, r);
    }
  }

  function smixStep2(start, end) {
    for (var i = start; i < end; i += 2) {
      var j = integerify(XY, xi, r) & (N-1);
      blockXOR(XY, xi, V, j*(32*r), 32*r);
      blockMix(tmp, XY, xi, yi, r);

      j = integerify(XY, yi, r) & (N-1);
      blockXOR(XY, yi, V, j*(32*r), 32*r);
      blockMix(tmp, XY, yi, xi, r);
    }
  }

  function smixFinish(pos) {
    for (var i = 0; i < 32*r; i++) {
      var j = XY[xi+i];
      B[pos + i*4 + 0] = (j>>>0)  & 0xff;
      B[pos + i*4 + 1] = (j>>>8)  & 0xff;
      B[pos + i*4 + 2] = (j>>>16) & 0xff;
      B[pos + i*4 + 3] = (j>>>24) & 0xff;
    }
  }

  var nextTick = (typeof setImmediate !== 'undefined') ? setImmediate : setTimeout;

  function interruptedFor(start, end, step, fn, donefn) {
    (function performStep() {
      nextTick(function() {
        fn(start, start + step < end ? start + step : end);
        start += step;
        if (start < end)
          performStep();
        else
          donefn();
        });
    })();
  }

  function getResult(enc) {
      var result = PBKDF2_HMAC_SHA256_OneIter(password, B, dkLen);
      if (enc === 'base64')
        return bytesToBase64(result);
      else if (enc === 'hex')
        return bytesToHex(result);
      else if (enc === 'binary')
        return new Uint8Array(result);
      else
        return result;
  }

  // Blocking variant.
  function calculateSync() {
    for (var i = 0; i < p; i++) {
      smixStart(i*128*r);
      smixStep1(0, N);
      smixStep2(0, N);
      smixFinish(i*128*r);
    }
    callback(getResult(encoding));
  }

  // Async variant.
  function calculateAsync(i) {
      smixStart(i*128*r);
      interruptedFor(0, N, interruptStep*2, smixStep1, function() {
        interruptedFor(0, N, interruptStep*2, smixStep2, function () {
          smixFinish(i*128*r);
          if (i + 1 < p) {
            nextTick(function() { calculateAsync(i + 1); });
          } else {
            callback(getResult(encoding));
          }
        });
      });
  }

  if (typeof interruptStep === 'function') {
    // Called as: scrypt(...,      callback, [encoding])
    //  shifting: scrypt(..., interruptStep,  callback, [encoding])
    encoding = callback;
    callback = interruptStep;
    interruptStep = 1000;
  }

  if (interruptStep <= 0) {
    calculateSync();
  } else {
    calculateAsync(0);
  }
}

if (typeof module !== 'undefined') module.exports = scrypt;
</script>

<!--lz-string compression algorithm 1.4.4. https://github.com/pieroxy/lz-string-->
<script>
// Copyright (c) 2013 Pieroxy <pieroxy@pieroxy.net>
// This work is free. You can redistribute it and/or modify it
// under the terms of the WTFPL, Version 2
// For more information see LICENSE.txt or http://www.wtfpl.net/
//
// For more information, the home page:
// http://pieroxy.net/blog/pages/lz-string/testing.html
//
// LZ-based compression algorithm, version 1.4.4
var LZString = (function() {

// private property
var f = String.fromCharCode;
var keyStrBase64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
var keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
var baseReverseDic = {};

function getBaseValue(alphabet, character) {
  if (!baseReverseDic[alphabet]) {
    baseReverseDic[alphabet] = {};
    for (var i=0 ; i<alphabet.length ; i++) {
      baseReverseDic[alphabet][alphabet.charAt(i)] = i;
    }
  }
  return baseReverseDic[alphabet][character];
}

var LZString = {
  compressToBase64 : function (input) {
    if (input == null) return "";
    var res = LZString._compress(input, 6, function(a){return keyStrBase64.charAt(a);});
    switch (res.length % 4) { // To produce valid Base64
    default: // When could this happen ?
    case 0 : return res;
    case 1 : return res+"===";
    case 2 : return res+"==";
    case 3 : return res+"=";
    }
  },

  decompressFromBase64 : function (input) {
    if (input == null) return "";
    if (input == "") return null;
    return LZString._decompress(input.length, 32, function(index) { return getBaseValue(keyStrBase64, input.charAt(index)); });
  },

  compressToUTF16 : function (input) {
    if (input == null) return "";
    return LZString._compress(input, 15, function(a){return f(a+32);}) + " ";
  },

  decompressFromUTF16: function (compressed) {
    if (compressed == null) return "";
    if (compressed == "") return null;
    return LZString._decompress(compressed.length, 16384, function(index) { return compressed.charCodeAt(index) - 32; });
  },

  //compress into uint8array (UCS-2 big endian format)
  compressToUint8Array: function (uncompressed) {
    var compressed = LZString.compress(uncompressed);
    var buf=new Uint8Array(compressed.length*2); // 2 bytes per character

    for (var i=0, TotalLen=compressed.length; i<TotalLen; i++) {
      var current_value = compressed.charCodeAt(i);
      buf[i*2] = current_value >>> 8;
      buf[i*2+1] = current_value % 256;
    }
    return buf;
  },

  //decompress from uint8array (UCS-2 big endian format)
  decompressFromUint8Array:function (compressed) {
    if (compressed===null || compressed===undefined){
        return LZString.decompress(compressed);
    } else {
        var buf=new Array(compressed.length/2); // 2 bytes per character
        for (var i=0, TotalLen=buf.length; i<TotalLen; i++) {
          buf[i]=compressed[i*2]*256+compressed[i*2+1];
        }

        var result = [];
        buf.forEach(function (c) {
          result.push(f(c));
        });
        return LZString.decompress(result.join(''));

    }

  },


  //compress into a string that is already URI encoded
  compressToEncodedURIComponent: function (input) {
    if (input == null) return "";
    return LZString._compress(input, 6, function(a){return keyStrUriSafe.charAt(a);});
  },

  //decompress from an output of compressToEncodedURIComponent
  decompressFromEncodedURIComponent:function (input) {
    if (input == null) return "";
    if (input == "") return null;
    input = input.replace(/ /g, "+");
    return LZString._decompress(input.length, 32, function(index) { return getBaseValue(keyStrUriSafe, input.charAt(index)); });
  },

  compress: function (uncompressed) {
    return LZString._compress(uncompressed, 16, function(a){return f(a);});
  },
  _compress: function (uncompressed, bitsPerChar, getCharFromInt) {
    if (uncompressed == null) return "";
    var i, value,
        context_dictionary= {},
        context_dictionaryToCreate= {},
        context_c="",
        context_wc="",
        context_w="",
        context_enlargeIn= 2, // Compensate for the first entry which should not count
        context_dictSize= 3,
        context_numBits= 2,
        context_data=[],
        context_data_val=0,
        context_data_position=0,
        ii;

    for (ii = 0; ii < uncompressed.length; ii += 1) {
      context_c = uncompressed.charAt(ii);
      if (!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)) {
        context_dictionary[context_c] = context_dictSize++;
        context_dictionaryToCreate[context_c] = true;
      }

      context_wc = context_w + context_c;
      if (Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)) {
        context_w = context_wc;
      } else {
        if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)) {
          if (context_w.charCodeAt(0)<256) {
            for (i=0 ; i<context_numBits ; i++) {
              context_data_val = (context_data_val << 1);
              if (context_data_position == bitsPerChar-1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
            }
            value = context_w.charCodeAt(0);
            for (i=0 ; i<8 ; i++) {
              context_data_val = (context_data_val << 1) | (value&1);
              if (context_data_position == bitsPerChar-1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
              value = value >> 1;
            }
          } else {
            value = 1;
            for (i=0 ; i<context_numBits ; i++) {
              context_data_val = (context_data_val << 1) | value;
              if (context_data_position ==bitsPerChar-1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
              value = 0;
            }
            value = context_w.charCodeAt(0);
            for (i=0 ; i<16 ; i++) {
              context_data_val = (context_data_val << 1) | (value&1);
              if (context_data_position == bitsPerChar-1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
              value = value >> 1;
            }
          }
          context_enlargeIn--;
          if (context_enlargeIn == 0) {
            context_enlargeIn = Math.pow(2, context_numBits);
            context_numBits++;
          }
          delete context_dictionaryToCreate[context_w];
        } else {
          value = context_dictionary[context_w];
          for (i=0 ; i<context_numBits ; i++) {
            context_data_val = (context_data_val << 1) | (value&1);
            if (context_data_position == bitsPerChar-1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }


        }
        context_enlargeIn--;
        if (context_enlargeIn == 0) {
          context_enlargeIn = Math.pow(2, context_numBits);
          context_numBits++;
        }
        // Add wc to the dictionary.
        context_dictionary[context_wc] = context_dictSize++;
        context_w = String(context_c);
      }
    }

    // Output the code for w.
    if (context_w !== "") {
      if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)) {
        if (context_w.charCodeAt(0)<256) {
          for (i=0 ; i<context_numBits ; i++) {
            context_data_val = (context_data_val << 1);
            if (context_data_position == bitsPerChar-1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
          }
          value = context_w.charCodeAt(0);
          for (i=0 ; i<8 ; i++) {
            context_data_val = (context_data_val << 1) | (value&1);
            if (context_data_position == bitsPerChar-1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }
        } else {
          value = 1;
          for (i=0 ; i<context_numBits ; i++) {
            context_data_val = (context_data_val << 1) | value;
            if (context_data_position == bitsPerChar-1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = 0;
          }
          value = context_w.charCodeAt(0);
          for (i=0 ; i<16 ; i++) {
            context_data_val = (context_data_val << 1) | (value&1);
            if (context_data_position == bitsPerChar-1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }
        }
        context_enlargeIn--;
        if (context_enlargeIn == 0) {
          context_enlargeIn = Math.pow(2, context_numBits);
          context_numBits++;
        }
        delete context_dictionaryToCreate[context_w];
      } else {
        value = context_dictionary[context_w];
        for (i=0 ; i<context_numBits ; i++) {
          context_data_val = (context_data_val << 1) | (value&1);
          if (context_data_position == bitsPerChar-1) {
            context_data_position = 0;
            context_data.push(getCharFromInt(context_data_val));
            context_data_val = 0;
          } else {
            context_data_position++;
          }
          value = value >> 1;
        }


      }
      context_enlargeIn--;
      if (context_enlargeIn == 0) {
        context_enlargeIn = Math.pow(2, context_numBits);
        context_numBits++;
      }
    }

    // Mark the end of the stream
    value = 2;
    for (i=0 ; i<context_numBits ; i++) {
      context_data_val = (context_data_val << 1) | (value&1);
      if (context_data_position == bitsPerChar-1) {
        context_data_position = 0;
        context_data.push(getCharFromInt(context_data_val));
        context_data_val = 0;
      } else {
        context_data_position++;
      }
      value = value >> 1;
    }

    // Flush the last char
    while (true) {
      context_data_val = (context_data_val << 1);
      if (context_data_position == bitsPerChar-1) {
        context_data.push(getCharFromInt(context_data_val));
        break;
      }
      else context_data_position++;
    }
    return context_data.join('');
  },

  decompress: function (compressed) {
    if (compressed == null) return "";
    if (compressed == "") return null;
    return LZString._decompress(compressed.length, 32768, function(index) { return compressed.charCodeAt(index); });
  },

  _decompress: function (length, resetValue, getNextValue) {
    var dictionary = [],
        next,
        enlargeIn = 4,
        dictSize = 4,
        numBits = 3,
        entry = "",
        result = [],
        i,
        w,
        bits, resb, maxpower, power,
        c,
        data = {val:getNextValue(0), position:resetValue, index:1};

    for (i = 0; i < 3; i += 1) {
      dictionary[i] = i;
    }

    bits = 0;
    maxpower = Math.pow(2,2);
    power=1;
    while (power!=maxpower) {
      resb = data.val & data.position;
      data.position >>= 1;
      if (data.position == 0) {
        data.position = resetValue;
        data.val = getNextValue(data.index++);
      }
      bits |= (resb>0 ? 1 : 0) * power;
      power <<= 1;
    }

    switch (next = bits) {
      case 0:
          bits = 0;
          maxpower = Math.pow(2,8);
          power=1;
          while (power!=maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) {
              data.position = resetValue;
              data.val = getNextValue(data.index++);
            }
            bits |= (resb>0 ? 1 : 0) * power;
            power <<= 1;
          }
        c = f(bits);
        break;
      case 1:
          bits = 0;
          maxpower = Math.pow(2,16);
          power=1;
          while (power!=maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) {
              data.position = resetValue;
              data.val = getNextValue(data.index++);
            }
            bits |= (resb>0 ? 1 : 0) * power;
            power <<= 1;
          }
        c = f(bits);
        break;
      case 2:
        return "";
    }
    dictionary[3] = c;
    w = c;
    result.push(c);
    while (true) {
      if (data.index > length) {
        return "";
      }

      bits = 0;
      maxpower = Math.pow(2,numBits);
      power=1;
      while (power!=maxpower) {
        resb = data.val & data.position;
        data.position >>= 1;
        if (data.position == 0) {
          data.position = resetValue;
          data.val = getNextValue(data.index++);
        }
        bits |= (resb>0 ? 1 : 0) * power;
        power <<= 1;
      }

      switch (c = bits) {
        case 0:
          bits = 0;
          maxpower = Math.pow(2,8);
          power=1;
          while (power!=maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) {
              data.position = resetValue;
              data.val = getNextValue(data.index++);
            }
            bits |= (resb>0 ? 1 : 0) * power;
            power <<= 1;
          }

          dictionary[dictSize++] = f(bits);
          c = dictSize-1;
          enlargeIn--;
          break;
        case 1:
          bits = 0;
          maxpower = Math.pow(2,16);
          power=1;
          while (power!=maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) {
              data.position = resetValue;
              data.val = getNextValue(data.index++);
            }
            bits |= (resb>0 ? 1 : 0) * power;
            power <<= 1;
          }
          dictionary[dictSize++] = f(bits);
          c = dictSize-1;
          enlargeIn--;
          break;
        case 2:
          return result.join('');
      }

      if (enlargeIn == 0) {
        enlargeIn = Math.pow(2, numBits);
        numBits++;
      }

      if (dictionary[c]) {
        entry = dictionary[c];
      } else {
        if (c === dictSize) {
          entry = w + w.charAt(0);
        } else {
          return null;
        }
      }
      result.push(entry);

      // Add w+entry[0] to the dictionary.
      dictionary[dictSize++] = w + entry.charAt(0);
      enlargeIn--;

      w = entry;

      if (enlargeIn == 0) {
        enlargeIn = Math.pow(2, numBits);
        numBits++;
      }

    }
  }
};
  return LZString;
})();

if (typeof define === 'function' && define.amd) {
  define(function () { return LZString; });
} else if( typeof module !== 'undefined' && module != null ) {
  module.exports = LZString
}
</script>

<!--DOMPurify, used to sanitize decrypted material before putting in DOM v2.3.6. https://github.com/cure53/DOMPurify-->
<script>
/*! @license DOMPurify 2.3.6 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.3.6/LICENSE */

(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global = global || self, global.DOMPurify = factory());
}(this, function () { 'use strict';

  function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

  var hasOwnProperty = Object.hasOwnProperty,
      setPrototypeOf = Object.setPrototypeOf,
      isFrozen = Object.isFrozen,
      getPrototypeOf = Object.getPrototypeOf,
      getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;
  var freeze = Object.freeze,
      seal = Object.seal,
      create = Object.create; // eslint-disable-line import/no-mutable-exports

  var _ref = typeof Reflect !== 'undefined' && Reflect,
      apply = _ref.apply,
      construct = _ref.construct;

  if (!apply) {
    apply = function apply(fun, thisValue, args) {
      return fun.apply(thisValue, args);
    };
  }

  if (!freeze) {
    freeze = function freeze(x) {
      return x;
    };
  }

  if (!seal) {
    seal = function seal(x) {
      return x;
    };
  }

  if (!construct) {
    construct = function construct(Func, args) {
      return new (Function.prototype.bind.apply(Func, [null].concat(_toConsumableArray(args))))();
    };
  }

  var arrayForEach = unapply(Array.prototype.forEach);
  var arrayPop = unapply(Array.prototype.pop);
  var arrayPush = unapply(Array.prototype.push);

  var stringToLowerCase = unapply(String.prototype.toLowerCase);
  var stringMatch = unapply(String.prototype.match);
  var stringReplace = unapply(String.prototype.replace);
  var stringIndexOf = unapply(String.prototype.indexOf);
  var stringTrim = unapply(String.prototype.trim);

  var regExpTest = unapply(RegExp.prototype.test);

  var typeErrorCreate = unconstruct(TypeError);

  function unapply(func) {
    return function (thisArg) {
      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      return apply(func, thisArg, args);
    };
  }

  function unconstruct(func) {
    return function () {
      for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }

      return construct(func, args);
    };
  }

  /* Add properties to a lookup table */
  function addToSet(set, array) {
    if (setPrototypeOf) {
      // Make 'in' and truthy checks like Boolean(set.constructor)
      // independent of any properties defined on Object.prototype.
      // Prevent prototype setters from intercepting set as a this value.
      setPrototypeOf(set, null);
    }

    var l = array.length;
    while (l--) {
      var element = array[l];
      if (typeof element === 'string') {
        var lcElement = stringToLowerCase(element);
        if (lcElement !== element) {
          // Config presets (e.g. tags.js, attrs.js) are immutable.
          if (!isFrozen(array)) {
            array[l] = lcElement;
          }

          element = lcElement;
        }
      }

      set[element] = true;
    }

    return set;
  }

  /* Shallow clone an object */
  function clone(object) {
    var newObject = create(null);

    var property = void 0;
    for (property in object) {
      if (apply(hasOwnProperty, object, [property])) {
        newObject[property] = object[property];
      }
    }

    return newObject;
  }

  /* IE10 doesn't support __lookupGetter__ so lets'
   * simulate it. It also automatically checks
   * if the prop is function or getter and behaves
   * accordingly. */
  function lookupGetter(object, prop) {
    while (object !== null) {
      var desc = getOwnPropertyDescriptor(object, prop);
      if (desc) {
        if (desc.get) {
          return unapply(desc.get);
        }

        if (typeof desc.value === 'function') {
          return unapply(desc.value);
        }
      }

      object = getPrototypeOf(object);
    }

    function fallbackValue(element) {
      console.warn('fallback value for', element);
      return null;
    }

    return fallbackValue;
  }

  var html = freeze(['a', 'abbr', 'acronym', 'address', 'area', 'article', 'aside', 'audio', 'b', 'bdi', 'bdo', 'big', 'blink', 'blockquote', 'body', 'br', 'button', 'canvas', 'caption', 'center', 'cite', 'code', 'col', 'colgroup', 'content', 'data', 'datalist', 'dd', 'decorator', 'del', 'details', 'dfn', 'dialog', 'dir', 'div', 'dl', 'dt', 'element', 'em', 'fieldset', 'figcaption', 'figure', 'font', 'footer', 'form', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'head', 'header', 'hgroup', 'hr', 'html', 'i', 'img', 'input', 'ins', 'kbd', 'label', 'legend', 'li', 'main', 'map', 'mark', 'marquee', 'menu', 'menuitem', 'meter', 'nav', 'nobr', 'ol', 'optgroup', 'option', 'output', 'p', 'picture', 'pre', 'progress', 'q', 'rp', 'rt', 'ruby', 's', 'samp', 'section', 'select', 'shadow', 'small', 'source', 'spacer', 'span', 'strike', 'strong', 'style', 'sub', 'summary', 'sup', 'table', 'tbody', 'td', 'template', 'textarea', 'tfoot', 'th', 'thead', 'time', 'tr', 'track', 'tt', 'u', 'ul', 'var', 'video', 'wbr']);

  // SVG
  var svg = freeze(['svg', 'a', 'altglyph', 'altglyphdef', 'altglyphitem', 'animatecolor', 'animatemotion', 'animatetransform', 'circle', 'clippath', 'defs', 'desc', 'ellipse', 'filter', 'font', 'g', 'glyph', 'glyphref', 'hkern', 'image', 'line', 'lineargradient', 'marker', 'mask', 'metadata', 'mpath', 'path', 'pattern', 'polygon', 'polyline', 'radialgradient', 'rect', 'stop', 'style', 'switch', 'symbol', 'text', 'textpath', 'title', 'tref', 'tspan', 'view', 'vkern']);

  var svgFilters = freeze(['feBlend', 'feColorMatrix', 'feComponentTransfer', 'feComposite', 'feConvolveMatrix', 'feDiffuseLighting', 'feDisplacementMap', 'feDistantLight', 'feFlood', 'feFuncA', 'feFuncB', 'feFuncG', 'feFuncR', 'feGaussianBlur', 'feImage', 'feMerge', 'feMergeNode', 'feMorphology', 'feOffset', 'fePointLight', 'feSpecularLighting', 'feSpotLight', 'feTile', 'feTurbulence']);

  // List of SVG elements that are disallowed by default.
  // We still need to know them so that we can do namespace
  // checks properly in case one wants to add them to
  // allow-list.
  var svgDisallowed = freeze(['animate', 'color-profile', 'cursor', 'discard', 'fedropshadow', 'font-face', 'font-face-format', 'font-face-name', 'font-face-src', 'font-face-uri', 'foreignobject', 'hatch', 'hatchpath', 'mesh', 'meshgradient', 'meshpatch', 'meshrow', 'missing-glyph', 'script', 'set', 'solidcolor', 'unknown', 'use']);

  var mathMl = freeze(['math', 'menclose', 'merror', 'mfenced', 'mfrac', 'mglyph', 'mi', 'mlabeledtr', 'mmultiscripts', 'mn', 'mo', 'mover', 'mpadded', 'mphantom', 'mroot', 'mrow', 'ms', 'mspace', 'msqrt', 'mstyle', 'msub', 'msup', 'msubsup', 'mtable', 'mtd', 'mtext', 'mtr', 'munder', 'munderover']);

  // Similarly to SVG, we want to know all MathML elements,
  // even those that we disallow by default.
  var mathMlDisallowed = freeze(['maction', 'maligngroup', 'malignmark', 'mlongdiv', 'mscarries', 'mscarry', 'msgroup', 'mstack', 'msline', 'msrow', 'semantics', 'annotation', 'annotation-xml', 'mprescripts', 'none']);

  var text = freeze(['#text']);

  var html$1 = freeze(['accept', 'action', 'align', 'alt', 'autocapitalize', 'autocomplete', 'autopictureinpicture', 'autoplay', 'background', 'bgcolor', 'border', 'capture', 'cellpadding', 'cellspacing', 'checked', 'cite', 'class', 'clear', 'color', 'cols', 'colspan', 'controls', 'controlslist', 'coords', 'crossorigin', 'datetime', 'decoding', 'default', 'dir', 'disabled', 'disablepictureinpicture', 'disableremoteplayback', 'download', 'draggable', 'enctype', 'enterkeyhint', 'face', 'for', 'headers', 'height', 'hidden', 'high', 'href', 'hreflang', 'id', 'inputmode', 'integrity', 'ismap', 'kind', 'label', 'lang', 'list', 'loading', 'loop', 'low', 'max', 'maxlength', 'media', 'method', 'min', 'minlength', 'multiple', 'muted', 'name', 'nonce', 'noshade', 'novalidate', 'nowrap', 'open', 'optimum', 'pattern', 'placeholder', 'playsinline', 'poster', 'preload', 'pubdate', 'radiogroup', 'readonly', 'rel', 'required', 'rev', 'reversed', 'role', 'rows', 'rowspan', 'spellcheck', 'scope', 'selected', 'shape', 'size', 'sizes', 'span', 'srclang', 'start', 'src', 'srcset', 'step', 'style', 'summary', 'tabindex', 'title', 'translate', 'type', 'usemap', 'valign', 'value', 'width', 'xmlns', 'slot']);

  var svg$1 = freeze(['accent-height', 'accumulate', 'additive', 'alignment-baseline', 'ascent', 'attributename', 'attributetype', 'azimuth', 'basefrequency', 'baseline-shift', 'begin', 'bias', 'by', 'class', 'clip', 'clippathunits', 'clip-path', 'clip-rule', 'color', 'color-interpolation', 'color-interpolation-filters', 'color-profile', 'color-rendering', 'cx', 'cy', 'd', 'dx', 'dy', 'diffuseconstant', 'direction', 'display', 'divisor', 'dur', 'edgemode', 'elevation', 'end', 'fill', 'fill-opacity', 'fill-rule', 'filter', 'filterunits', 'flood-color', 'flood-opacity', 'font-family', 'font-size', 'font-size-adjust', 'font-stretch', 'font-style', 'font-variant', 'font-weight', 'fx', 'fy', 'g1', 'g2', 'glyph-name', 'glyphref', 'gradientunits', 'gradienttransform', 'height', 'href', 'id', 'image-rendering', 'in', 'in2', 'k', 'k1', 'k2', 'k3', 'k4', 'kerning', 'keypoints', 'keysplines', 'keytimes', 'lang', 'lengthadjust', 'letter-spacing', 'kernelmatrix', 'kernelunitlength', 'lighting-color', 'local', 'marker-end', 'marker-mid', 'marker-start', 'markerheight', 'markerunits', 'markerwidth', 'maskcontentunits', 'maskunits', 'max', 'mask', 'media', 'method', 'mode', 'min', 'name', 'numoctaves', 'offset', 'operator', 'opacity', 'order', 'orient', 'orientation', 'origin', 'overflow', 'paint-order', 'path', 'pathlength', 'patterncontentunits', 'patterntransform', 'patternunits', 'points', 'preservealpha', 'preserveaspectratio', 'primitiveunits', 'r', 'rx', 'ry', 'radius', 'refx', 'refy', 'repeatcount', 'repeatdur', 'restart', 'result', 'rotate', 'scale', 'seed', 'shape-rendering', 'specularconstant', 'specularexponent', 'spreadmethod', 'startoffset', 'stddeviation', 'stitchtiles', 'stop-color', 'stop-opacity', 'stroke-dasharray', 'stroke-dashoffset', 'stroke-linecap', 'stroke-linejoin', 'stroke-miterlimit', 'stroke-opacity', 'stroke', 'stroke-width', 'style', 'surfacescale', 'systemlanguage', 'tabindex', 'targetx', 'targety', 'transform', 'transform-origin', 'text-anchor', 'text-decoration', 'text-rendering', 'textlength', 'type', 'u1', 'u2', 'unicode', 'values', 'viewbox', 'visibility', 'version', 'vert-adv-y', 'vert-origin-x', 'vert-origin-y', 'width', 'word-spacing', 'wrap', 'writing-mode', 'xchannelselector', 'ychannelselector', 'x', 'x1', 'x2', 'xmlns', 'y', 'y1', 'y2', 'z', 'zoomandpan']);

  var mathMl$1 = freeze(['accent', 'accentunder', 'align', 'bevelled', 'close', 'columnsalign', 'columnlines', 'columnspan', 'denomalign', 'depth', 'dir', 'display', 'displaystyle', 'encoding', 'fence', 'frame', 'height', 'href', 'id', 'largeop', 'length', 'linethickness', 'lspace', 'lquote', 'mathbackground', 'mathcolor', 'mathsize', 'mathvariant', 'maxsize', 'minsize', 'movablelimits', 'notation', 'numalign', 'open', 'rowalign', 'rowlines', 'rowspacing', 'rowspan', 'rspace', 'rquote', 'scriptlevel', 'scriptminsize', 'scriptsizemultiplier', 'selection', 'separator', 'separators', 'stretchy', 'subscriptshift', 'supscriptshift', 'symmetric', 'voffset', 'width', 'xmlns']);

  var xml = freeze(['xlink:href', 'xml:id', 'xlink:title', 'xml:space', 'xmlns:xlink']);

  // eslint-disable-next-line unicorn/better-regex
  var MUSTACHE_EXPR = seal(/\{\{[\s\S]*|[\s\S]*\}\}/gm); // Specify template detection regex for SAFE_FOR_TEMPLATES mode
  var ERB_EXPR = seal(/<%[\s\S]*|[\s\S]*%>/gm);
  var DATA_ATTR = seal(/^data-[\-\w.\u00B7-\uFFFF]/); // eslint-disable-line no-useless-escape
  var ARIA_ATTR = seal(/^aria-[\-\w]+$/); // eslint-disable-line no-useless-escape
  var IS_ALLOWED_URI = seal(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i // eslint-disable-line no-useless-escape
  );
  var IS_SCRIPT_OR_DATA = seal(/^(?:\w+script|data):/i);
  var ATTR_WHITESPACE = seal(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g // eslint-disable-line no-control-regex
  );
  var DOCTYPE_NAME = seal(/^html$/i);

  var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

  function _toConsumableArray$1(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

  var getGlobal = function getGlobal() {
    return typeof window === 'undefined' ? null : window;
  };

  /**
   * Creates a no-op policy for internal use only.
   * Don't export this function outside this module!
   * @param {?TrustedTypePolicyFactory} trustedTypes The policy factory.
   * @param {Document} document The document object (to determine policy name suffix)
   * @return {?TrustedTypePolicy} The policy created (or null, if Trusted Types
   * are not supported).
   */
  var _createTrustedTypesPolicy = function _createTrustedTypesPolicy(trustedTypes, document) {
    if ((typeof trustedTypes === 'undefined' ? 'undefined' : _typeof(trustedTypes)) !== 'object' || typeof trustedTypes.createPolicy !== 'function') {
      return null;
    }

    // Allow the callers to control the unique policy name
    // by adding a data-tt-policy-suffix to the script element with the DOMPurify.
    // Policy creation with duplicate names throws in Trusted Types.
    var suffix = null;
    var ATTR_NAME = 'data-tt-policy-suffix';
    if (document.currentScript && document.currentScript.hasAttribute(ATTR_NAME)) {
      suffix = document.currentScript.getAttribute(ATTR_NAME);
    }

    var policyName = 'dompurify' + (suffix ? '#' + suffix : '');

    try {
      return trustedTypes.createPolicy(policyName, {
        createHTML: function createHTML(html$$1) {
          return html$$1;
        }
      });
    } catch (_) {
      // Policy creation failed (most likely another DOMPurify script has
      // already run). Skip creating the policy, as this will only cause errors
      // if TT are enforced.
      console.warn('TrustedTypes policy ' + policyName + ' could not be created.');
      return null;
    }
  };

  function createDOMPurify() {
    var window = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : getGlobal();

    var DOMPurify = function DOMPurify(root) {
      return createDOMPurify(root);
    };

    /**
     * Version label, exposed for easier checks
     * if DOMPurify is up to date or not
     */
    DOMPurify.version = '2.3.6';

    /**
     * Array of elements that DOMPurify removed during sanitation.
     * Empty if nothing was removed.
     */
    DOMPurify.removed = [];

    if (!window || !window.document || window.document.nodeType !== 9) {
      // Not running in a browser, provide a factory function
      // so that you can pass your own Window
      DOMPurify.isSupported = false;

      return DOMPurify;
    }

    var originalDocument = window.document;

    var document = window.document;
    var DocumentFragment = window.DocumentFragment,
        HTMLTemplateElement = window.HTMLTemplateElement,
        Node = window.Node,
        Element = window.Element,
        NodeFilter = window.NodeFilter,
        _window$NamedNodeMap = window.NamedNodeMap,
        NamedNodeMap = _window$NamedNodeMap === undefined ? window.NamedNodeMap || window.MozNamedAttrMap : _window$NamedNodeMap,
        HTMLFormElement = window.HTMLFormElement,
        DOMParser = window.DOMParser,
        trustedTypes = window.trustedTypes;


    var ElementPrototype = Element.prototype;

    var cloneNode = lookupGetter(ElementPrototype, 'cloneNode');
    var getNextSibling = lookupGetter(ElementPrototype, 'nextSibling');
    var getChildNodes = lookupGetter(ElementPrototype, 'childNodes');
    var getParentNode = lookupGetter(ElementPrototype, 'parentNode');

    // As per issue #47, the web-components registry is inherited by a
    // new document created via createHTMLDocument. As per the spec
    // (http://w3c.github.io/webcomponents/spec/custom/#creating-and-passing-registries)
    // a new empty registry is used when creating a template contents owner
    // document, so we use that as our parent document to ensure nothing
    // is inherited.
    if (typeof HTMLTemplateElement === 'function') {
      var template = document.createElement('template');
      if (template.content && template.content.ownerDocument) {
        document = template.content.ownerDocument;
      }
    }

    var trustedTypesPolicy = _createTrustedTypesPolicy(trustedTypes, originalDocument);
    var emptyHTML = trustedTypesPolicy ? trustedTypesPolicy.createHTML('') : '';

    var _document = document,
        implementation = _document.implementation,
        createNodeIterator = _document.createNodeIterator,
        createDocumentFragment = _document.createDocumentFragment,
        getElementsByTagName = _document.getElementsByTagName;
    var importNode = originalDocument.importNode;


    var documentMode = {};
    try {
      documentMode = clone(document).documentMode ? document.documentMode : {};
    } catch (_) {}

    var hooks = {};

    /**
     * Expose whether this browser supports running the full DOMPurify.
     */
    DOMPurify.isSupported = typeof getParentNode === 'function' && implementation && typeof implementation.createHTMLDocument !== 'undefined' && documentMode !== 9;

    var MUSTACHE_EXPR$$1 = MUSTACHE_EXPR,
        ERB_EXPR$$1 = ERB_EXPR,
        DATA_ATTR$$1 = DATA_ATTR,
        ARIA_ATTR$$1 = ARIA_ATTR,
        IS_SCRIPT_OR_DATA$$1 = IS_SCRIPT_OR_DATA,
        ATTR_WHITESPACE$$1 = ATTR_WHITESPACE;
    var IS_ALLOWED_URI$$1 = IS_ALLOWED_URI;

    /**
     * We consider the elements and attributes below to be safe. Ideally
     * don't add any new ones but feel free to remove unwanted ones.
     */

    /* allowed element names */

    var ALLOWED_TAGS = null;
    var DEFAULT_ALLOWED_TAGS = addToSet({}, [].concat(_toConsumableArray$1(html), _toConsumableArray$1(svg), _toConsumableArray$1(svgFilters), _toConsumableArray$1(mathMl), _toConsumableArray$1(text)));

    /* Allowed attribute names */
    var ALLOWED_ATTR = null;
    var DEFAULT_ALLOWED_ATTR = addToSet({}, [].concat(_toConsumableArray$1(html$1), _toConsumableArray$1(svg$1), _toConsumableArray$1(mathMl$1), _toConsumableArray$1(xml)));

    /*
     * Configure how DOMPUrify should handle custom elements and their attributes as well as customized built-in elements.
     * @property {RegExp|Function|null} tagNameCheck one of [null, regexPattern, predicate]. Default: `null` (disallow any custom elements)
     * @property {RegExp|Function|null} attributeNameCheck one of [null, regexPattern, predicate]. Default: `null` (disallow any attributes not on the allow list)
     * @property {boolean} allowCustomizedBuiltInElements allow custom elements derived from built-ins if they pass CUSTOM_ELEMENT_HANDLING.tagNameCheck. Default: `false`.
     */
    var CUSTOM_ELEMENT_HANDLING = Object.seal(Object.create(null, {
      tagNameCheck: {
        writable: true,
        configurable: false,
        enumerable: true,
        value: null
      },
      attributeNameCheck: {
        writable: true,
        configurable: false,
        enumerable: true,
        value: null
      },
      allowCustomizedBuiltInElements: {
        writable: true,
        configurable: false,
        enumerable: true,
        value: false
      }
    }));

    /* Explicitly forbidden tags (overrides ALLOWED_TAGS/ADD_TAGS) */
    var FORBID_TAGS = null;

    /* Explicitly forbidden attributes (overrides ALLOWED_ATTR/ADD_ATTR) */
    var FORBID_ATTR = null;

    /* Decide if ARIA attributes are okay */
    var ALLOW_ARIA_ATTR = true;

    /* Decide if custom data attributes are okay */
    var ALLOW_DATA_ATTR = true;

    /* Decide if unknown protocols are okay */
    var ALLOW_UNKNOWN_PROTOCOLS = false;

    /* Output should be safe for common template engines.
     * This means, DOMPurify removes data attributes, mustaches and ERB
     */
    var SAFE_FOR_TEMPLATES = false;

    /* Decide if document with <html>... should be returned */
    var WHOLE_DOCUMENT = false;

    /* Track whether config is already set on this instance of DOMPurify. */
    var SET_CONFIG = false;

    /* Decide if all elements (e.g. style, script) must be children of
     * document.body. By default, browsers might move them to document.head */
    var FORCE_BODY = false;

    /* Decide if a DOM `HTMLBodyElement` should be returned, instead of a html
     * string (or a TrustedHTML object if Trusted Types are supported).
     * If `WHOLE_DOCUMENT` is enabled a `HTMLHtmlElement` will be returned instead
     */
    var RETURN_DOM = false;

    /* Decide if a DOM `DocumentFragment` should be returned, instead of a html
     * string  (or a TrustedHTML object if Trusted Types are supported) */
    var RETURN_DOM_FRAGMENT = false;

    /* Try to return a Trusted Type object instead of a string, return a string in
     * case Trusted Types are not supported  */
    var RETURN_TRUSTED_TYPE = false;

    /* Output should be free from DOM clobbering attacks? */
    var SANITIZE_DOM = true;

    /* Keep element content when removing element? */
    var KEEP_CONTENT = true;

    /* If a `Node` is passed to sanitize(), then performs sanitization in-place instead
     * of importing it into a new Document and returning a sanitized copy */
    var IN_PLACE = false;

    /* Allow usage of profiles like html, svg and mathMl */
    var USE_PROFILES = {};

    /* Tags to ignore content of when KEEP_CONTENT is true */
    var FORBID_CONTENTS = null;
    var DEFAULT_FORBID_CONTENTS = addToSet({}, ['annotation-xml', 'audio', 'colgroup', 'desc', 'foreignobject', 'head', 'iframe', 'math', 'mi', 'mn', 'mo', 'ms', 'mtext', 'noembed', 'noframes', 'noscript', 'plaintext', 'script', 'style', 'svg', 'template', 'thead', 'title', 'video', 'xmp']);

    /* Tags that are safe for data: URIs */
    var DATA_URI_TAGS = null;
    var DEFAULT_DATA_URI_TAGS = addToSet({}, ['audio', 'video', 'img', 'source', 'image', 'track']);

    /* Attributes safe for values like "javascript:" */
    var URI_SAFE_ATTRIBUTES = null;
    var DEFAULT_URI_SAFE_ATTRIBUTES = addToSet({}, ['alt', 'class', 'for', 'id', 'label', 'name', 'pattern', 'placeholder', 'role', 'summary', 'title', 'value', 'style', 'xmlns']);

    var MATHML_NAMESPACE = 'http://www.w3.org/1998/Math/MathML';
    var SVG_NAMESPACE = 'http://www.w3.org/2000/svg';
    var HTML_NAMESPACE = 'http://www.w3.org/1999/xhtml';
    /* Document namespace */
    var NAMESPACE = HTML_NAMESPACE;
    var IS_EMPTY_INPUT = false;

    /* Parsing of strict XHTML documents */
    var PARSER_MEDIA_TYPE = void 0;
    var SUPPORTED_PARSER_MEDIA_TYPES = ['application/xhtml+xml', 'text/html'];
    var DEFAULT_PARSER_MEDIA_TYPE = 'text/html';
    var transformCaseFunc = void 0;

    /* Keep a reference to config to pass to hooks */
    var CONFIG = null;

    /* Ideally, do not touch anything below this line */
    /* ______________________________________________ */

    var formElement = document.createElement('form');

    var isRegexOrFunction = function isRegexOrFunction(testValue) {
      return testValue instanceof RegExp || testValue instanceof Function;
    };

    /**
     * _parseConfig
     *
     * @param  {Object} cfg optional config literal
     */
    // eslint-disable-next-line complexity
    var _parseConfig = function _parseConfig(cfg) {
      if (CONFIG && CONFIG === cfg) {
        return;
      }

      /* Shield configuration object from tampering */
      if (!cfg || (typeof cfg === 'undefined' ? 'undefined' : _typeof(cfg)) !== 'object') {
        cfg = {};
      }

      /* Shield configuration object from prototype pollution */
      cfg = clone(cfg);

      /* Set configuration parameters */
      ALLOWED_TAGS = 'ALLOWED_TAGS' in cfg ? addToSet({}, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;
      ALLOWED_ATTR = 'ALLOWED_ATTR' in cfg ? addToSet({}, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;
      URI_SAFE_ATTRIBUTES = 'ADD_URI_SAFE_ATTR' in cfg ? addToSet(clone(DEFAULT_URI_SAFE_ATTRIBUTES), cfg.ADD_URI_SAFE_ATTR) : DEFAULT_URI_SAFE_ATTRIBUTES;
      DATA_URI_TAGS = 'ADD_DATA_URI_TAGS' in cfg ? addToSet(clone(DEFAULT_DATA_URI_TAGS), cfg.ADD_DATA_URI_TAGS) : DEFAULT_DATA_URI_TAGS;
      FORBID_CONTENTS = 'FORBID_CONTENTS' in cfg ? addToSet({}, cfg.FORBID_CONTENTS) : DEFAULT_FORBID_CONTENTS;
      FORBID_TAGS = 'FORBID_TAGS' in cfg ? addToSet({}, cfg.FORBID_TAGS) : {};
      FORBID_ATTR = 'FORBID_ATTR' in cfg ? addToSet({}, cfg.FORBID_ATTR) : {};
      USE_PROFILES = 'USE_PROFILES' in cfg ? cfg.USE_PROFILES : false;
      ALLOW_ARIA_ATTR = cfg.ALLOW_ARIA_ATTR !== false; // Default true
      ALLOW_DATA_ATTR = cfg.ALLOW_DATA_ATTR !== false; // Default true
      ALLOW_UNKNOWN_PROTOCOLS = cfg.ALLOW_UNKNOWN_PROTOCOLS || false; // Default false
      SAFE_FOR_TEMPLATES = cfg.SAFE_FOR_TEMPLATES || false; // Default false
      WHOLE_DOCUMENT = cfg.WHOLE_DOCUMENT || false; // Default false
      RETURN_DOM = cfg.RETURN_DOM || false; // Default false
      RETURN_DOM_FRAGMENT = cfg.RETURN_DOM_FRAGMENT || false; // Default false
      RETURN_TRUSTED_TYPE = cfg.RETURN_TRUSTED_TYPE || false; // Default false
      FORCE_BODY = cfg.FORCE_BODY || false; // Default false
      SANITIZE_DOM = cfg.SANITIZE_DOM !== false; // Default true
      KEEP_CONTENT = cfg.KEEP_CONTENT !== false; // Default true
      IN_PLACE = cfg.IN_PLACE || false; // Default false
      IS_ALLOWED_URI$$1 = cfg.ALLOWED_URI_REGEXP || IS_ALLOWED_URI$$1;
      NAMESPACE = cfg.NAMESPACE || HTML_NAMESPACE;
      if (cfg.CUSTOM_ELEMENT_HANDLING && isRegexOrFunction(cfg.CUSTOM_ELEMENT_HANDLING.tagNameCheck)) {
        CUSTOM_ELEMENT_HANDLING.tagNameCheck = cfg.CUSTOM_ELEMENT_HANDLING.tagNameCheck;
      }

      if (cfg.CUSTOM_ELEMENT_HANDLING && isRegexOrFunction(cfg.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)) {
        CUSTOM_ELEMENT_HANDLING.attributeNameCheck = cfg.CUSTOM_ELEMENT_HANDLING.attributeNameCheck;
      }

      if (cfg.CUSTOM_ELEMENT_HANDLING && typeof cfg.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements === 'boolean') {
        CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements = cfg.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements;
      }

      PARSER_MEDIA_TYPE =
      // eslint-disable-next-line unicorn/prefer-includes
      SUPPORTED_PARSER_MEDIA_TYPES.indexOf(cfg.PARSER_MEDIA_TYPE) === -1 ? PARSER_MEDIA_TYPE = DEFAULT_PARSER_MEDIA_TYPE : PARSER_MEDIA_TYPE = cfg.PARSER_MEDIA_TYPE;

      // HTML tags and attributes are not case-sensitive, converting to lowercase. Keeping XHTML as is.
      transformCaseFunc = PARSER_MEDIA_TYPE === 'application/xhtml+xml' ? function (x) {
        return x;
      } : stringToLowerCase;

      if (SAFE_FOR_TEMPLATES) {
        ALLOW_DATA_ATTR = false;
      }

      if (RETURN_DOM_FRAGMENT) {
        RETURN_DOM = true;
      }

      /* Parse profile info */
      if (USE_PROFILES) {
        ALLOWED_TAGS = addToSet({}, [].concat(_toConsumableArray$1(text)));
        ALLOWED_ATTR = [];
        if (USE_PROFILES.html === true) {
          addToSet(ALLOWED_TAGS, html);
          addToSet(ALLOWED_ATTR, html$1);
        }

        if (USE_PROFILES.svg === true) {
          addToSet(ALLOWED_TAGS, svg);
          addToSet(ALLOWED_ATTR, svg$1);
          addToSet(ALLOWED_ATTR, xml);
        }

        if (USE_PROFILES.svgFilters === true) {
          addToSet(ALLOWED_TAGS, svgFilters);
          addToSet(ALLOWED_ATTR, svg$1);
          addToSet(ALLOWED_ATTR, xml);
        }

        if (USE_PROFILES.mathMl === true) {
          addToSet(ALLOWED_TAGS, mathMl);
          addToSet(ALLOWED_ATTR, mathMl$1);
          addToSet(ALLOWED_ATTR, xml);
        }
      }

      /* Merge configuration parameters */
      if (cfg.ADD_TAGS) {
        if (ALLOWED_TAGS === DEFAULT_ALLOWED_TAGS) {
          ALLOWED_TAGS = clone(ALLOWED_TAGS);
        }

        addToSet(ALLOWED_TAGS, cfg.ADD_TAGS);
      }

      if (cfg.ADD_ATTR) {
        if (ALLOWED_ATTR === DEFAULT_ALLOWED_ATTR) {
          ALLOWED_ATTR = clone(ALLOWED_ATTR);
        }

        addToSet(ALLOWED_ATTR, cfg.ADD_ATTR);
      }

      if (cfg.ADD_URI_SAFE_ATTR) {
        addToSet(URI_SAFE_ATTRIBUTES, cfg.ADD_URI_SAFE_ATTR);
      }

      if (cfg.FORBID_CONTENTS) {
        if (FORBID_CONTENTS === DEFAULT_FORBID_CONTENTS) {
          FORBID_CONTENTS = clone(FORBID_CONTENTS);
        }

        addToSet(FORBID_CONTENTS, cfg.FORBID_CONTENTS);
      }

      /* Add #text in case KEEP_CONTENT is set to true */
      if (KEEP_CONTENT) {
        ALLOWED_TAGS['#text'] = true;
      }

      /* Add html, head and body to ALLOWED_TAGS in case WHOLE_DOCUMENT is true */
      if (WHOLE_DOCUMENT) {
        addToSet(ALLOWED_TAGS, ['html', 'head', 'body']);
      }

      /* Add tbody to ALLOWED_TAGS in case tables are permitted, see #286, #365 */
      if (ALLOWED_TAGS.table) {
        addToSet(ALLOWED_TAGS, ['tbody']);
        delete FORBID_TAGS.tbody;
      }

      // Prevent further manipulation of configuration.
      // Not available in IE8, Safari 5, etc.
      if (freeze) {
        freeze(cfg);
      }

      CONFIG = cfg;
    };

    var MATHML_TEXT_INTEGRATION_POINTS = addToSet({}, ['mi', 'mo', 'mn', 'ms', 'mtext']);

    var HTML_INTEGRATION_POINTS = addToSet({}, ['foreignobject', 'desc', 'title', 'annotation-xml']);

    /* Keep track of all possible SVG and MathML tags
     * so that we can perform the namespace checks
     * correctly. */
    var ALL_SVG_TAGS = addToSet({}, svg);
    addToSet(ALL_SVG_TAGS, svgFilters);
    addToSet(ALL_SVG_TAGS, svgDisallowed);

    var ALL_MATHML_TAGS = addToSet({}, mathMl);
    addToSet(ALL_MATHML_TAGS, mathMlDisallowed);

    /**
     *
     *
     * @param  {Element} element a DOM element whose namespace is being checked
     * @returns {boolean} Return false if the element has a
     *  namespace that a spec-compliant parser would never
     *  return. Return true otherwise.
     */
    var _checkValidNamespace = function _checkValidNamespace(element) {
      var parent = getParentNode(element);

      // In JSDOM, if we're inside shadow DOM, then parentNode
      // can be null. We just simulate parent in this case.
      if (!parent || !parent.tagName) {
        parent = {
          namespaceURI: HTML_NAMESPACE,
          tagName: 'template'
        };
      }

      var tagName = stringToLowerCase(element.tagName);
      var parentTagName = stringToLowerCase(parent.tagName);

      if (element.namespaceURI === SVG_NAMESPACE) {
        // The only way to switch from HTML namespace to SVG
        // is via <svg>. If it happens via any other tag, then
        // it should be killed.
        if (parent.namespaceURI === HTML_NAMESPACE) {
          return tagName === 'svg';
        }

        // The only way to switch from MathML to SVG is via
        // svg if parent is either <annotation-xml> or MathML
        // text integration points.
        if (parent.namespaceURI === MATHML_NAMESPACE) {
          return tagName === 'svg' && (parentTagName === 'annotation-xml' || MATHML_TEXT_INTEGRATION_POINTS[parentTagName]);
        }

        // We only allow elements that are defined in SVG
        // spec. All others are disallowed in SVG namespace.
        return Boolean(ALL_SVG_TAGS[tagName]);
      }

      if (element.namespaceURI === MATHML_NAMESPACE) {
        // The only way to switch from HTML namespace to MathML
        // is via <math>. If it happens via any other tag, then
        // it should be killed.
        if (parent.namespaceURI === HTML_NAMESPACE) {
          return tagName === 'math';
        }

        // The only way to switch from SVG to MathML is via
        // <math> and HTML integration points
        if (parent.namespaceURI === SVG_NAMESPACE) {
          return tagName === 'math' && HTML_INTEGRATION_POINTS[parentTagName];
        }

        // We only allow elements that are defined in MathML
        // spec. All others are disallowed in MathML namespace.
        return Boolean(ALL_MATHML_TAGS[tagName]);
      }

      if (element.namespaceURI === HTML_NAMESPACE) {
        // The only way to switch from SVG to HTML is via
        // HTML integration points, and from MathML to HTML
        // is via MathML text integration points
        if (parent.namespaceURI === SVG_NAMESPACE && !HTML_INTEGRATION_POINTS[parentTagName]) {
          return false;
        }

        if (parent.namespaceURI === MATHML_NAMESPACE && !MATHML_TEXT_INTEGRATION_POINTS[parentTagName]) {
          return false;
        }

        // Certain elements are allowed in both SVG and HTML
        // namespace. We need to specify them explicitly
        // so that they don't get erronously deleted from
        // HTML namespace.
        var commonSvgAndHTMLElements = addToSet({}, ['title', 'style', 'font', 'a', 'script']);

        // We disallow tags that are specific for MathML
        // or SVG and should never appear in HTML namespace
        return !ALL_MATHML_TAGS[tagName] && (commonSvgAndHTMLElements[tagName] || !ALL_SVG_TAGS[tagName]);
      }

      // The code should never reach this place (this means
      // that the element somehow got namespace that is not
      // HTML, SVG or MathML). Return false just in case.
      return false;
    };

    /**
     * _forceRemove
     *
     * @param  {Node} node a DOM node
     */
    var _forceRemove = function _forceRemove(node) {
      arrayPush(DOMPurify.removed, { element: node });
      try {
        // eslint-disable-next-line unicorn/prefer-dom-node-remove
        node.parentNode.removeChild(node);
      } catch (_) {
        try {
          node.outerHTML = emptyHTML;
        } catch (_) {
          node.remove();
        }
      }
    };

    /**
     * _removeAttribute
     *
     * @param  {String} name an Attribute name
     * @param  {Node} node a DOM node
     */
    var _removeAttribute = function _removeAttribute(name, node) {
      try {
        arrayPush(DOMPurify.removed, {
          attribute: node.getAttributeNode(name),
          from: node
        });
      } catch (_) {
        arrayPush(DOMPurify.removed, {
          attribute: null,
          from: node
        });
      }

      node.removeAttribute(name);

      // We void attribute values for unremovable "is"" attributes
      if (name === 'is' && !ALLOWED_ATTR[name]) {
        if (RETURN_DOM || RETURN_DOM_FRAGMENT) {
          try {
            _forceRemove(node);
          } catch (_) {}
        } else {
          try {
            node.setAttribute(name, '');
          } catch (_) {}
        }
      }
    };

    /**
     * _initDocument
     *
     * @param  {String} dirty a string of dirty markup
     * @return {Document} a DOM, filled with the dirty markup
     */
    var _initDocument = function _initDocument(dirty) {
      /* Create a HTML document */
      var doc = void 0;
      var leadingWhitespace = void 0;

      if (FORCE_BODY) {
        dirty = '<remove></remove>' + dirty;
      } else {
        /* If FORCE_BODY isn't used, leading whitespace needs to be preserved manually */
        var matches = stringMatch(dirty, /^[\r\n\t ]+/);
        leadingWhitespace = matches && matches[0];
      }

      if (PARSER_MEDIA_TYPE === 'application/xhtml+xml') {
        // Root of XHTML doc must contain xmlns declaration (see https://www.w3.org/TR/xhtml1/normative.html#strict)
        dirty = '<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>' + dirty + '</body></html>';
      }

      var dirtyPayload = trustedTypesPolicy ? trustedTypesPolicy.createHTML(dirty) : dirty;
      /*
       * Use the DOMParser API by default, fallback later if needs be
       * DOMParser not work for svg when has multiple root element.
       */
      if (NAMESPACE === HTML_NAMESPACE) {
        try {
          doc = new DOMParser().parseFromString(dirtyPayload, PARSER_MEDIA_TYPE);
        } catch (_) {}
      }

      /* Use createHTMLDocument in case DOMParser is not available */
      if (!doc || !doc.documentElement) {
        doc = implementation.createDocument(NAMESPACE, 'template', null);
        try {
          doc.documentElement.innerHTML = IS_EMPTY_INPUT ? '' : dirtyPayload;
        } catch (_) {
          // Syntax error if dirtyPayload is invalid xml
        }
      }

      var body = doc.body || doc.documentElement;

      if (dirty && leadingWhitespace) {
        body.insertBefore(document.createTextNode(leadingWhitespace), body.childNodes[0] || null);
      }

      /* Work on whole document or just its body */
      if (NAMESPACE === HTML_NAMESPACE) {
        return getElementsByTagName.call(doc, WHOLE_DOCUMENT ? 'html' : 'body')[0];
      }

      return WHOLE_DOCUMENT ? doc.documentElement : body;
    };

    /**
     * _createIterator
     *
     * @param  {Document} root document/fragment to create iterator for
     * @return {Iterator} iterator instance
     */
    var _createIterator = function _createIterator(root) {
      return createNodeIterator.call(root.ownerDocument || root, root,
      // eslint-disable-next-line no-bitwise
      NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_COMMENT | NodeFilter.SHOW_TEXT, null, false);
    };

    /**
     * _isClobbered
     *
     * @param  {Node} elm element to check for clobbering attacks
     * @return {Boolean} true if clobbered, false if safe
     */
    var _isClobbered = function _isClobbered(elm) {
      return elm instanceof HTMLFormElement && (typeof elm.nodeName !== 'string' || typeof elm.textContent !== 'string' || typeof elm.removeChild !== 'function' || !(elm.attributes instanceof NamedNodeMap) || typeof elm.removeAttribute !== 'function' || typeof elm.setAttribute !== 'function' || typeof elm.namespaceURI !== 'string' || typeof elm.insertBefore !== 'function');
    };

    /**
     * _isNode
     *
     * @param  {Node} obj object to check whether it's a DOM node
     * @return {Boolean} true is object is a DOM node
     */
    var _isNode = function _isNode(object) {
      return (typeof Node === 'undefined' ? 'undefined' : _typeof(Node)) === 'object' ? object instanceof Node : object && (typeof object === 'undefined' ? 'undefined' : _typeof(object)) === 'object' && typeof object.nodeType === 'number' && typeof object.nodeName === 'string';
    };

    /**
     * _executeHook
     * Execute user configurable hooks
     *
     * @param  {String} entryPoint  Name of the hook's entry point
     * @param  {Node} currentNode node to work on with the hook
     * @param  {Object} data additional hook parameters
     */
    var _executeHook = function _executeHook(entryPoint, currentNode, data) {
      if (!hooks[entryPoint]) {
        return;
      }

      arrayForEach(hooks[entryPoint], function (hook) {
        hook.call(DOMPurify, currentNode, data, CONFIG);
      });
    };

    /**
     * _sanitizeElements
     *
     * @protect nodeName
     * @protect textContent
     * @protect removeChild
     *
     * @param   {Node} currentNode to check for permission to exist
     * @return  {Boolean} true if node was killed, false if left alive
     */
    var _sanitizeElements = function _sanitizeElements(currentNode) {
      var content = void 0;

      /* Execute a hook if present */
      _executeHook('beforeSanitizeElements', currentNode, null);

      /* Check if element is clobbered or can clobber */
      if (_isClobbered(currentNode)) {
        _forceRemove(currentNode);
        return true;
      }

      /* Check if tagname contains Unicode */
      if (stringMatch(currentNode.nodeName, /[\u0080-\uFFFF]/)) {
        _forceRemove(currentNode);
        return true;
      }

      /* Now let's check the element's type and name */
      var tagName = transformCaseFunc(currentNode.nodeName);

      /* Execute a hook if present */
      _executeHook('uponSanitizeElement', currentNode, {
        tagName: tagName,
        allowedTags: ALLOWED_TAGS
      });

      /* Detect mXSS attempts abusing namespace confusion */
      if (!_isNode(currentNode.firstElementChild) && (!_isNode(currentNode.content) || !_isNode(currentNode.content.firstElementChild)) && regExpTest(/<[/\w]/g, currentNode.innerHTML) && regExpTest(/<[/\w]/g, currentNode.textContent)) {
        _forceRemove(currentNode);
        return true;
      }

      /* Mitigate a problem with templates inside select */
      if (tagName === 'select' && regExpTest(/<template/i, currentNode.innerHTML)) {
        _forceRemove(currentNode);
        return true;
      }

      /* Remove element if anything forbids its presence */
      if (!ALLOWED_TAGS[tagName] || FORBID_TAGS[tagName]) {
        /* Check if we have a custom element to handle */
        if (!FORBID_TAGS[tagName] && _basicCustomElementTest(tagName)) {
          if (CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp && regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck, tagName)) return false;
          if (CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function && CUSTOM_ELEMENT_HANDLING.tagNameCheck(tagName)) return false;
        }

        /* Keep content except for bad-listed elements */
        if (KEEP_CONTENT && !FORBID_CONTENTS[tagName]) {
          var parentNode = getParentNode(currentNode) || currentNode.parentNode;
          var childNodes = getChildNodes(currentNode) || currentNode.childNodes;

          if (childNodes && parentNode) {
            var childCount = childNodes.length;

            for (var i = childCount - 1; i >= 0; --i) {
              parentNode.insertBefore(cloneNode(childNodes[i], true), getNextSibling(currentNode));
            }
          }
        }

        _forceRemove(currentNode);
        return true;
      }

      /* Check whether element has a valid namespace */
      if (currentNode instanceof Element && !_checkValidNamespace(currentNode)) {
        _forceRemove(currentNode);
        return true;
      }

      if ((tagName === 'noscript' || tagName === 'noembed') && regExpTest(/<\/no(script|embed)/i, currentNode.innerHTML)) {
        _forceRemove(currentNode);
        return true;
      }

      /* Sanitize element content to be template-safe */
      if (SAFE_FOR_TEMPLATES && currentNode.nodeType === 3) {
        /* Get the element's text content */
        content = currentNode.textContent;
        content = stringReplace(content, MUSTACHE_EXPR$$1, ' ');
        content = stringReplace(content, ERB_EXPR$$1, ' ');
        if (currentNode.textContent !== content) {
          arrayPush(DOMPurify.removed, { element: currentNode.cloneNode() });
          currentNode.textContent = content;
        }
      }

      /* Execute a hook if present */
      _executeHook('afterSanitizeElements', currentNode, null);

      return false;
    };

    /**
     * _isValidAttribute
     *
     * @param  {string} lcTag Lowercase tag name of containing element.
     * @param  {string} lcName Lowercase attribute name.
     * @param  {string} value Attribute value.
     * @return {Boolean} Returns true if `value` is valid, otherwise false.
     */
    // eslint-disable-next-line complexity
    var _isValidAttribute = function _isValidAttribute(lcTag, lcName, value) {
      /* Make sure attribute cannot clobber */
      if (SANITIZE_DOM && (lcName === 'id' || lcName === 'name') && (value in document || value in formElement)) {
        return false;
      }

      /* Allow valid data-* attributes: At least one character after "-"
          (https://html.spec.whatwg.org/multipage/dom.html#embedding-custom-non-visible-data-with-the-data-*-attributes)
          XML-compatible (https://html.spec.whatwg.org/multipage/infrastructure.html#xml-compatible and http://www.w3.org/TR/xml/#d0e804)
          We don't need to check the value; it's always URI safe. */
      if (ALLOW_DATA_ATTR && !FORBID_ATTR[lcName] && regExpTest(DATA_ATTR$$1, lcName)) ; else if (ALLOW_ARIA_ATTR && regExpTest(ARIA_ATTR$$1, lcName)) ; else if (!ALLOWED_ATTR[lcName] || FORBID_ATTR[lcName]) {
        if (
        // First condition does a very basic check if a) it's basically a valid custom element tagname AND
        // b) if the tagName passes whatever the user has configured for CUSTOM_ELEMENT_HANDLING.tagNameCheck
        // and c) if the attribute name passes whatever the user has configured for CUSTOM_ELEMENT_HANDLING.attributeNameCheck
        _basicCustomElementTest(lcTag) && (CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp && regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck, lcTag) || CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function && CUSTOM_ELEMENT_HANDLING.tagNameCheck(lcTag)) && (CUSTOM_ELEMENT_HANDLING.attributeNameCheck instanceof RegExp && regExpTest(CUSTOM_ELEMENT_HANDLING.attributeNameCheck, lcName) || CUSTOM_ELEMENT_HANDLING.attributeNameCheck instanceof Function && CUSTOM_ELEMENT_HANDLING.attributeNameCheck(lcName)) ||
        // Alternative, second condition checks if it's an `is`-attribute, AND
        // the value passes whatever the user has configured for CUSTOM_ELEMENT_HANDLING.tagNameCheck
        lcName === 'is' && CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements && (CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp && regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck, value) || CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function && CUSTOM_ELEMENT_HANDLING.tagNameCheck(value))) ; else {
          return false;
        }
        /* Check value is safe. First, is attr inert? If so, is safe */
      } else if (URI_SAFE_ATTRIBUTES[lcName]) ; else if (regExpTest(IS_ALLOWED_URI$$1, stringReplace(value, ATTR_WHITESPACE$$1, ''))) ; else if ((lcName === 'src' || lcName === 'xlink:href' || lcName === 'href') && lcTag !== 'script' && stringIndexOf(value, 'data:') === 0 && DATA_URI_TAGS[lcTag]) ; else if (ALLOW_UNKNOWN_PROTOCOLS && !regExpTest(IS_SCRIPT_OR_DATA$$1, stringReplace(value, ATTR_WHITESPACE$$1, ''))) ; else if (!value) ; else {
        return false;
      }

      return true;
    };

    /**
     * _basicCustomElementCheck
     * checks if at least one dash is included in tagName, and it's not the first char
     * for more sophisticated checking see https://github.com/sindresorhus/validate-element-name
     * @param {string} tagName name of the tag of the node to sanitize
     */
    var _basicCustomElementTest = function _basicCustomElementTest(tagName) {
      return tagName.indexOf('-') > 0;
    };

    /**
     * _sanitizeAttributes
     *
     * @protect attributes
     * @protect nodeName
     * @protect removeAttribute
     * @protect setAttribute
     *
     * @param  {Node} currentNode to sanitize
     */
    var _sanitizeAttributes = function _sanitizeAttributes(currentNode) {
      var attr = void 0;
      var value = void 0;
      var lcName = void 0;
      var l = void 0;
      /* Execute a hook if present */
      _executeHook('beforeSanitizeAttributes', currentNode, null);

      var attributes = currentNode.attributes;

      /* Check if we have attributes; if not we might have a text node */

      if (!attributes) {
        return;
      }

      var hookEvent = {
        attrName: '',
        attrValue: '',
        keepAttr: true,
        allowedAttributes: ALLOWED_ATTR
      };
      l = attributes.length;

      /* Go backwards over all attributes; safely remove bad ones */
      while (l--) {
        attr = attributes[l];
        var _attr = attr,
            name = _attr.name,
            namespaceURI = _attr.namespaceURI;

        value = stringTrim(attr.value);
        lcName = transformCaseFunc(name);

        /* Execute a hook if present */
        hookEvent.attrName = lcName;
        hookEvent.attrValue = value;
        hookEvent.keepAttr = true;
        hookEvent.forceKeepAttr = undefined; // Allows developers to see this is a property they can set
        _executeHook('uponSanitizeAttribute', currentNode, hookEvent);
        value = hookEvent.attrValue;
        /* Did the hooks approve of the attribute? */
        if (hookEvent.forceKeepAttr) {
          continue;
        }

        /* Remove attribute */
        _removeAttribute(name, currentNode);

        /* Did the hooks approve of the attribute? */
        if (!hookEvent.keepAttr) {
          continue;
        }

        /* Work around a security issue in jQuery 3.0 */
        if (regExpTest(/\/>/i, value)) {
          _removeAttribute(name, currentNode);
          continue;
        }

        /* Sanitize attribute content to be template-safe */
        if (SAFE_FOR_TEMPLATES) {
          value = stringReplace(value, MUSTACHE_EXPR$$1, ' ');
          value = stringReplace(value, ERB_EXPR$$1, ' ');
        }

        /* Is `value` valid for this attribute? */
        var lcTag = transformCaseFunc(currentNode.nodeName);
        if (!_isValidAttribute(lcTag, lcName, value)) {
          continue;
        }

        /* Handle invalid data-* attribute set by try-catching it */
        try {
          if (namespaceURI) {
            currentNode.setAttributeNS(namespaceURI, name, value);
          } else {
            /* Fallback to setAttribute() for browser-unrecognized namespaces e.g. "x-schema". */
            currentNode.setAttribute(name, value);
          }

          arrayPop(DOMPurify.removed);
        } catch (_) {}
      }

      /* Execute a hook if present */
      _executeHook('afterSanitizeAttributes', currentNode, null);
    };

    /**
     * _sanitizeShadowDOM
     *
     * @param  {DocumentFragment} fragment to iterate over recursively
     */
    var _sanitizeShadowDOM = function _sanitizeShadowDOM(fragment) {
      var shadowNode = void 0;
      var shadowIterator = _createIterator(fragment);

      /* Execute a hook if present */
      _executeHook('beforeSanitizeShadowDOM', fragment, null);

      while (shadowNode = shadowIterator.nextNode()) {
        /* Execute a hook if present */
        _executeHook('uponSanitizeShadowNode', shadowNode, null);

        /* Sanitize tags and elements */
        if (_sanitizeElements(shadowNode)) {
          continue;
        }

        /* Deep shadow DOM detected */
        if (shadowNode.content instanceof DocumentFragment) {
          _sanitizeShadowDOM(shadowNode.content);
        }

        /* Check attributes, sanitize if necessary */
        _sanitizeAttributes(shadowNode);
      }

      /* Execute a hook if present */
      _executeHook('afterSanitizeShadowDOM', fragment, null);
    };

    /**
     * Sanitize
     * Public method providing core sanitation functionality
     *
     * @param {String|Node} dirty string or DOM node
     * @param {Object} configuration object
     */
    // eslint-disable-next-line complexity
    DOMPurify.sanitize = function (dirty, cfg) {
      var body = void 0;
      var importedNode = void 0;
      var currentNode = void 0;
      var oldNode = void 0;
      var returnNode = void 0;
      /* Make sure we have a string to sanitize.
        DO NOT return early, as this will return the wrong type if
        the user has requested a DOM object rather than a string */
      IS_EMPTY_INPUT = !dirty;
      if (IS_EMPTY_INPUT) {
        dirty = '<!-->';
      }

      /* Stringify, in case dirty is an object */
      if (typeof dirty !== 'string' && !_isNode(dirty)) {
        // eslint-disable-next-line no-negated-condition
        if (typeof dirty.toString !== 'function') {
          throw typeErrorCreate('toString is not a function');
        } else {
          dirty = dirty.toString();
          if (typeof dirty !== 'string') {
            throw typeErrorCreate('dirty is not a string, aborting');
          }
        }
      }

      /* Check we can run. Otherwise fall back or ignore */
      if (!DOMPurify.isSupported) {
        if (_typeof(window.toStaticHTML) === 'object' || typeof window.toStaticHTML === 'function') {
          if (typeof dirty === 'string') {
            return window.toStaticHTML(dirty);
          }

          if (_isNode(dirty)) {
            return window.toStaticHTML(dirty.outerHTML);
          }
        }

        return dirty;
      }

      /* Assign config vars */
      if (!SET_CONFIG) {
        _parseConfig(cfg);
      }

      /* Clean up removed elements */
      DOMPurify.removed = [];

      /* Check if dirty is correctly typed for IN_PLACE */
      if (typeof dirty === 'string') {
        IN_PLACE = false;
      }

      if (IN_PLACE) {
        /* Do some early pre-sanitization to avoid unsafe root nodes */
        if (dirty.nodeName) {
          var tagName = transformCaseFunc(dirty.nodeName);
          if (!ALLOWED_TAGS[tagName] || FORBID_TAGS[tagName]) {
            throw typeErrorCreate('root node is forbidden and cannot be sanitized in-place');
          }
        }
      } else if (dirty instanceof Node) {
        /* If dirty is a DOM element, append to an empty document to avoid
           elements being stripped by the parser */
        body = _initDocument('<!---->');
        importedNode = body.ownerDocument.importNode(dirty, true);
        if (importedNode.nodeType === 1 && importedNode.nodeName === 'BODY') {
          /* Node is already a body, use as is */
          body = importedNode;
        } else if (importedNode.nodeName === 'HTML') {
          body = importedNode;
        } else {
          // eslint-disable-next-line unicorn/prefer-dom-node-append
          body.appendChild(importedNode);
        }
      } else {
        /* Exit directly if we have nothing to do */
        if (!RETURN_DOM && !SAFE_FOR_TEMPLATES && !WHOLE_DOCUMENT &&
        // eslint-disable-next-line unicorn/prefer-includes
        dirty.indexOf('<') === -1) {
          return trustedTypesPolicy && RETURN_TRUSTED_TYPE ? trustedTypesPolicy.createHTML(dirty) : dirty;
        }

        /* Initialize the document to work on */
        body = _initDocument(dirty);

        /* Check we have a DOM node from the data */
        if (!body) {
          return RETURN_DOM ? null : RETURN_TRUSTED_TYPE ? emptyHTML : '';
        }
      }

      /* Remove first element node (ours) if FORCE_BODY is set */
      if (body && FORCE_BODY) {
        _forceRemove(body.firstChild);
      }

      /* Get node iterator */
      var nodeIterator = _createIterator(IN_PLACE ? dirty : body);

      /* Now start iterating over the created document */
      while (currentNode = nodeIterator.nextNode()) {
        /* Fix IE's strange behavior with manipulated textNodes #89 */
        if (currentNode.nodeType === 3 && currentNode === oldNode) {
          continue;
        }

        /* Sanitize tags and elements */
        if (_sanitizeElements(currentNode)) {
          continue;
        }

        /* Shadow DOM detected, sanitize it */
        if (currentNode.content instanceof DocumentFragment) {
          _sanitizeShadowDOM(currentNode.content);
        }

        /* Check attributes, sanitize if necessary */
        _sanitizeAttributes(currentNode);

        oldNode = currentNode;
      }

      oldNode = null;

      /* If we sanitized `dirty` in-place, return it. */
      if (IN_PLACE) {
        return dirty;
      }

      /* Return sanitized string or DOM */
      if (RETURN_DOM) {
        if (RETURN_DOM_FRAGMENT) {
          returnNode = createDocumentFragment.call(body.ownerDocument);

          while (body.firstChild) {
            // eslint-disable-next-line unicorn/prefer-dom-node-append
            returnNode.appendChild(body.firstChild);
          }
        } else {
          returnNode = body;
        }

        if (ALLOWED_ATTR.shadowroot) {
          /*
            AdoptNode() is not used because internal state is not reset
            (e.g. the past names map of a HTMLFormElement), this is safe
            in theory but we would rather not risk another attack vector.
            The state that is cloned by importNode() is explicitly defined
            by the specs.
          */
          returnNode = importNode.call(originalDocument, returnNode, true);
        }

        return returnNode;
      }

      var serializedHTML = WHOLE_DOCUMENT ? body.outerHTML : body.innerHTML;

      /* Serialize doctype if allowed */
      if (WHOLE_DOCUMENT && ALLOWED_TAGS['!doctype'] && body.ownerDocument && body.ownerDocument.doctype && body.ownerDocument.doctype.name && regExpTest(DOCTYPE_NAME, body.ownerDocument.doctype.name)) {
        serializedHTML = '<!DOCTYPE ' + body.ownerDocument.doctype.name + '>\n' + serializedHTML;
      }

      /* Sanitize final string template-safe */
      if (SAFE_FOR_TEMPLATES) {
        serializedHTML = stringReplace(serializedHTML, MUSTACHE_EXPR$$1, ' ');
        serializedHTML = stringReplace(serializedHTML, ERB_EXPR$$1, ' ');
      }

      return trustedTypesPolicy && RETURN_TRUSTED_TYPE ? trustedTypesPolicy.createHTML(serializedHTML) : serializedHTML;
    };

    /**
     * Public method to set the configuration once
     * setConfig
     *
     * @param {Object} cfg configuration object
     */
    DOMPurify.setConfig = function (cfg) {
      _parseConfig(cfg);
      SET_CONFIG = true;
    };

    /**
     * Public method to remove the configuration
     * clearConfig
     *
     */
    DOMPurify.clearConfig = function () {
      CONFIG = null;
      SET_CONFIG = false;
    };

    /**
     * Public method to check if an attribute value is valid.
     * Uses last set config, if any. Otherwise, uses config defaults.
     * isValidAttribute
     *
     * @param  {string} tag Tag name of containing element.
     * @param  {string} attr Attribute name.
     * @param  {string} value Attribute value.
     * @return {Boolean} Returns true if `value` is valid. Otherwise, returns false.
     */
    DOMPurify.isValidAttribute = function (tag, attr, value) {
      /* Initialize shared config vars if necessary. */
      if (!CONFIG) {
        _parseConfig({});
      }

      var lcTag = transformCaseFunc(tag);
      var lcName = transformCaseFunc(attr);
      return _isValidAttribute(lcTag, lcName, value);
    };

    /**
     * AddHook
     * Public method to add DOMPurify hooks
     *
     * @param {String} entryPoint entry point for the hook to add
     * @param {Function} hookFunction function to execute
     */
    DOMPurify.addHook = function (entryPoint, hookFunction) {
      if (typeof hookFunction !== 'function') {
        return;
      }

      hooks[entryPoint] = hooks[entryPoint] || [];
      arrayPush(hooks[entryPoint], hookFunction);
    };

    /**
     * RemoveHook
     * Public method to remove a DOMPurify hook at a given entryPoint
     * (pops it from the stack of hooks if more are present)
     *
     * @param {String} entryPoint entry point for the hook to remove
     */
    DOMPurify.removeHook = function (entryPoint) {
      if (hooks[entryPoint]) {
        arrayPop(hooks[entryPoint]);
      }
    };

    /**
     * RemoveHooks
     * Public method to remove all DOMPurify hooks at a given entryPoint
     *
     * @param  {String} entryPoint entry point for the hooks to remove
     */
    DOMPurify.removeHooks = function (entryPoint) {
      if (hooks[entryPoint]) {
        hooks[entryPoint] = [];
      }
    };

    /**
     * RemoveAllHooks
     * Public method to remove all DOMPurify hooks
     *
     */
    DOMPurify.removeAllHooks = function () {
      hooks = {};
    };

    return DOMPurify;
  }

  var purify = createDOMPurify();

  return purify;

}));
//# sourceMappingURL=purify.js.map
</script>

<!--jpeg image steganography by Owen Campbell-Moore and others. https://github.com/owencm/js-steg. First jsstegencoder-1.0.js-->
<script>
/*

  Based on Basic Blocking JPEG Encoder v 0.9a, ported and optimised by
  Andreas Ritter (www.bytestrom.eu, 11/2009).

  Modified by Owen Campbell-Moore (www.owencampbellmoore.com, 03/13) for
  easy DCT modification.

  Released by Andreas Ritter carrying both of the following licences:

  Copyright (c) 2008, Adobe Systems Incorporated
  All rights reserved.

  Redistribution and use in source and binary forms, with or without
  modification, are permitted provided that the following conditions are
  met:

  * Redistributions of source code must retain the above copyright notice,
    this list of conditions and the following disclaimer.

  * Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the
    documentation and/or other materials provided with the distribution.

  * Neither the name of Adobe Systems Incorporated nor the names of its
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
  IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
  THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
  CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

  -------------

  Licensed under the MIT License

  Copyright (c) 2009 Andreas Ritter

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  THE SOFTWARE.

*/
function JPEGEncoder() {
	var self = this;
	var fround = Math.round;
	var ffloor = Math.floor;
	var YTable = new Array(64);
	var UVTable = new Array(64);
	var fdtbl_Y = new Array(64);
	var fdtbl_UV = new Array(64);
	var YDC_HT;
	var UVDC_HT;
	var YAC_HT;
	var UVAC_HT;

	var bitcode = new Array(65535);
	var category = new Array(65535);
	var outputfDCTQuant = new Array(64);
	var DU = new Array(64);
	var byteout = [];
	var bytenew = 0;
	var bytepos = 7;

	var YDU = new Array(64);
	var UDU = new Array(64);
	var VDU = new Array(64);
	var clt = new Array(256);
	var RGB_YUV_TABLE = new Array(2048);
	var currentQuality;

	var ZigZag = [
			 0, 1, 5, 6,14,15,27,28,
			 2, 4, 7,13,16,26,29,42,
			 3, 8,12,17,25,30,41,43,
			 9,11,18,24,31,40,44,53,
			10,19,23,32,39,45,52,54,
			20,22,33,38,46,51,55,60,
			21,34,37,47,50,56,59,61,
			35,36,48,49,57,58,62,63
		];

	var std_dc_luminance_nrcodes = [0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0];
	var std_dc_luminance_values = [0,1,2,3,4,5,6,7,8,9,10,11];
	var std_ac_luminance_nrcodes = [0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,0x7d];
	var std_ac_luminance_values = [
			0x01,0x02,0x03,0x00,0x04,0x11,0x05,0x12,
			0x21,0x31,0x41,0x06,0x13,0x51,0x61,0x07,
			0x22,0x71,0x14,0x32,0x81,0x91,0xa1,0x08,
			0x23,0x42,0xb1,0xc1,0x15,0x52,0xd1,0xf0,
			0x24,0x33,0x62,0x72,0x82,0x09,0x0a,0x16,
			0x17,0x18,0x19,0x1a,0x25,0x26,0x27,0x28,
			0x29,0x2a,0x34,0x35,0x36,0x37,0x38,0x39,
			0x3a,0x43,0x44,0x45,0x46,0x47,0x48,0x49,
			0x4a,0x53,0x54,0x55,0x56,0x57,0x58,0x59,
			0x5a,0x63,0x64,0x65,0x66,0x67,0x68,0x69,
			0x6a,0x73,0x74,0x75,0x76,0x77,0x78,0x79,
			0x7a,0x83,0x84,0x85,0x86,0x87,0x88,0x89,
			0x8a,0x92,0x93,0x94,0x95,0x96,0x97,0x98,
			0x99,0x9a,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,
			0xa8,0xa9,0xaa,0xb2,0xb3,0xb4,0xb5,0xb6,
			0xb7,0xb8,0xb9,0xba,0xc2,0xc3,0xc4,0xc5,
			0xc6,0xc7,0xc8,0xc9,0xca,0xd2,0xd3,0xd4,
			0xd5,0xd6,0xd7,0xd8,0xd9,0xda,0xe1,0xe2,
			0xe3,0xe4,0xe5,0xe6,0xe7,0xe8,0xe9,0xea,
			0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,
			0xf9,0xfa
		];

	var std_dc_chrominance_nrcodes = [0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0];
	var std_dc_chrominance_values = [0,1,2,3,4,5,6,7,8,9,10,11];
	var std_ac_chrominance_nrcodes = [0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,0x77];
	var std_ac_chrominance_values = [
			0x00,0x01,0x02,0x03,0x11,0x04,0x05,0x21,
			0x31,0x06,0x12,0x41,0x51,0x07,0x61,0x71,
			0x13,0x22,0x32,0x81,0x08,0x14,0x42,0x91,
			0xa1,0xb1,0xc1,0x09,0x23,0x33,0x52,0xf0,
			0x15,0x62,0x72,0xd1,0x0a,0x16,0x24,0x34,
			0xe1,0x25,0xf1,0x17,0x18,0x19,0x1a,0x26,
			0x27,0x28,0x29,0x2a,0x35,0x36,0x37,0x38,
			0x39,0x3a,0x43,0x44,0x45,0x46,0x47,0x48,
			0x49,0x4a,0x53,0x54,0x55,0x56,0x57,0x58,
			0x59,0x5a,0x63,0x64,0x65,0x66,0x67,0x68,
			0x69,0x6a,0x73,0x74,0x75,0x76,0x77,0x78,
			0x79,0x7a,0x82,0x83,0x84,0x85,0x86,0x87,
			0x88,0x89,0x8a,0x92,0x93,0x94,0x95,0x96,
			0x97,0x98,0x99,0x9a,0xa2,0xa3,0xa4,0xa5,
			0xa6,0xa7,0xa8,0xa9,0xaa,0xb2,0xb3,0xb4,
			0xb5,0xb6,0xb7,0xb8,0xb9,0xba,0xc2,0xc3,
			0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xd2,
			0xd3,0xd4,0xd5,0xd6,0xd7,0xd8,0xd9,0xda,
			0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,0xe8,0xe9,
			0xea,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,
			0xf9,0xfa
		];

	function initQuantTables(sf){
			var YQT = [
				16, 11, 10, 16, 24, 40, 51, 61,
				12, 12, 14, 19, 26, 58, 60, 55,
				14, 13, 16, 24, 40, 57, 69, 56,
				14, 17, 22, 29, 51, 87, 80, 62,
				18, 22, 37, 56, 68,109,103, 77,
				24, 35, 55, 64, 81,104,113, 92,
				49, 64, 78, 87,103,121,120,101,
				72, 92, 95, 98,112,100,103, 99
			];

			for (var i = 0; i < 64; i++) {
				var t = ffloor((YQT[i]*sf+50)/100);
				if (t < 1) {
					t = 1;
				} else if (t > 255) {
					t = 255;
				}
				YTable[ZigZag[i]] = t;
			}

			var UVQT = [
				17, 18, 24, 47, 99, 99, 99, 99,
				18, 21, 26, 66, 99, 99, 99, 99,
				24, 26, 56, 99, 99, 99, 99, 99,
				47, 66, 99, 99, 99, 99, 99, 99,
				99, 99, 99, 99, 99, 99, 99, 99,
				99, 99, 99, 99, 99, 99, 99, 99,
				99, 99, 99, 99, 99, 99, 99, 99,
				99, 99, 99, 99, 99, 99, 99, 99
			];
			for (var j = 0; j < 64; j++) {
				var u = ffloor((UVQT[j]*sf+50)/100);
				if (u < 1) {
					u = 1;
				} else if (u > 255) {
					u = 255;
				}
				UVTable[ZigZag[j]] = u;
			}
			var aasf = [
				1.0, 1.387039845, 1.306562965, 1.175875602,
				1.0, 0.785694958, 0.541196100, 0.275899379
			];
			var k = 0;
			for (var row = 0; row < 8; row++)
			{
				for (var col = 0; col < 8; col++)
				{
					fdtbl_Y[k]  = (1.0 / (YTable [ZigZag[k]] * aasf[row] * aasf[col] * 8.0));
					fdtbl_UV[k] = (1.0 / (UVTable[ZigZag[k]] * aasf[row] * aasf[col] * 8.0));
					k++;
				}
			}
		}

		function computeHuffmanTbl(nrcodes, std_table){
			var codevalue = 0;
			var pos_in_table = 0;
			var HT = new Array();
			for (var k = 1; k <= 16; k++) {
				for (var j = 1; j <= nrcodes[k]; j++) {
					HT[std_table[pos_in_table]] = [];
					HT[std_table[pos_in_table]][0] = codevalue;
					HT[std_table[pos_in_table]][1] = k;
					pos_in_table++;
					codevalue++;
				}
				codevalue*=2;
			}
			return HT;
		}

		function initHuffmanTbl()
		{
			YDC_HT = computeHuffmanTbl(std_dc_luminance_nrcodes,std_dc_luminance_values);
			UVDC_HT = computeHuffmanTbl(std_dc_chrominance_nrcodes,std_dc_chrominance_values);
			YAC_HT = computeHuffmanTbl(std_ac_luminance_nrcodes,std_ac_luminance_values);
			UVAC_HT = computeHuffmanTbl(std_ac_chrominance_nrcodes,std_ac_chrominance_values);
		}

		function initCategoryNumber()
		{
			var nrlower = 1;
			var nrupper = 2;
			for (var cat = 1; cat <= 15; cat++) {
				//Positive numbers
				for (var nr = nrlower; nr<nrupper; nr++) {
					category[32767+nr] = cat;
					bitcode[32767+nr] = [];
					bitcode[32767+nr][1] = cat;
					bitcode[32767+nr][0] = nr;
				}
				//Negative numbers
				for (var nrneg =-(nrupper-1); nrneg<=-nrlower; nrneg++) {
					category[32767+nrneg] = cat;
					bitcode[32767+nrneg] = [];
					bitcode[32767+nrneg][1] = cat;
					bitcode[32767+nrneg][0] = nrupper-1+nrneg;
				}
				nrlower <<= 1;
				nrupper <<= 1;
			}
		}

		function initRGBYUVTable() {
			for(var i = 0; i < 256;i++) {
				RGB_YUV_TABLE[i]      		=  19595 * i;
				RGB_YUV_TABLE[(i+ 256)>>0] 	=  38470 * i;
				RGB_YUV_TABLE[(i+ 512)>>0] 	=   7471 * i + 0x8000;
				RGB_YUV_TABLE[(i+ 768)>>0] 	= -11059 * i;
				RGB_YUV_TABLE[(i+1024)>>0] 	= -21709 * i;
				RGB_YUV_TABLE[(i+1280)>>0] 	=  32768 * i + 0x807FFF;
				RGB_YUV_TABLE[(i+1536)>>0] 	= -27439 * i;
				RGB_YUV_TABLE[(i+1792)>>0] 	= - 5329 * i;
			}
		}

		// IO functions
		function writeBits(bs)
		{
			var value = bs[0];
			var posval = bs[1]-1;
			while ( posval >= 0 ) {
				if (value & (1 << posval) ) {
					bytenew |= (1 << bytepos);
				}
				posval--;
				bytepos--;
				if (bytepos < 0) {
					if (bytenew == 0xFF) {
						writeByte(0xFF);
						writeByte(0);
					}
					else {
						writeByte(bytenew);
					}
					bytepos=7;
					bytenew=0;
				}
			}
		}

		function writeByte(value)
		{
			byteout.push(clt[value]); // write char directly instead of converting later
		}

		function writeWord(value)
		{
			writeByte((value>>8)&0xFF);
			writeByte((value   )&0xFF);
		}

		// DCT & quantization core
		function fDCTQuant(data, fdtbl)
		{
			var d0, d1, d2, d3, d4, d5, d6, d7;
			/* Pass 1: process rows. */
			var dataOff=0;
			var i;
			const I8 = 8;
			const I64 = 64;
			for (i=0; i<I8; ++i)
			{
				d0 = data[dataOff];
				d1 = data[dataOff+1];
				d2 = data[dataOff+2];
				d3 = data[dataOff+3];
				d4 = data[dataOff+4];
				d5 = data[dataOff+5];
				d6 = data[dataOff+6];
				d7 = data[dataOff+7];

				var tmp0 = d0 + d7;
				var tmp7 = d0 - d7;
				var tmp1 = d1 + d6;
				var tmp6 = d1 - d6;
				var tmp2 = d2 + d5;
				var tmp5 = d2 - d5;
				var tmp3 = d3 + d4;
				var tmp4 = d3 - d4;

				/* Even part */
				var tmp10 = tmp0 + tmp3;	/* phase 2 */
				var tmp13 = tmp0 - tmp3;
				var tmp11 = tmp1 + tmp2;
				var tmp12 = tmp1 - tmp2;

				data[dataOff] = tmp10 + tmp11; /* phase 3 */
				data[dataOff+4] = tmp10 - tmp11;

				var z1 = (tmp12 + tmp13) * 0.707106781; /* c4 */
				data[dataOff+2] = tmp13 + z1; /* phase 5 */
				data[dataOff+6] = tmp13 - z1;

				/* Odd part */
				tmp10 = tmp4 + tmp5; /* phase 2 */
				tmp11 = tmp5 + tmp6;
				tmp12 = tmp6 + tmp7;

				/* The rotator is modified from fig 4-8 to avoid extra negations. */
				var z5 = (tmp10 - tmp12) * 0.382683433; /* c6 */
				var z2 = 0.541196100 * tmp10 + z5; /* c2-c6 */
				var z4 = 1.306562965 * tmp12 + z5; /* c2+c6 */
				var z3 = tmp11 * 0.707106781; /* c4 */

				var z11 = tmp7 + z3;	/* phase 5 */
				var z13 = tmp7 - z3;

				data[dataOff+5] = z13 + z2;	/* phase 6 */
				data[dataOff+3] = z13 - z2;
				data[dataOff+1] = z11 + z4;
				data[dataOff+7] = z11 - z4;

				dataOff += 8; /* advance pointer to next row */
			}

			/* Pass 2: process columns. */
			dataOff = 0;
			for (i=0; i<I8; ++i)
			{
				d0 = data[dataOff];
				d1 = data[dataOff + 8];
				d2 = data[dataOff + 16];
				d3 = data[dataOff + 24];
				d4 = data[dataOff + 32];
				d5 = data[dataOff + 40];
				d6 = data[dataOff + 48];
				d7 = data[dataOff + 56];

				var tmp0p2 = d0 + d7;
				var tmp7p2 = d0 - d7;
				var tmp1p2 = d1 + d6;
				var tmp6p2 = d1 - d6;
				var tmp2p2 = d2 + d5;
				var tmp5p2 = d2 - d5;
				var tmp3p2 = d3 + d4;
				var tmp4p2 = d3 - d4;

				/* Even part */
				var tmp10p2 = tmp0p2 + tmp3p2;	/* phase 2 */
				var tmp13p2 = tmp0p2 - tmp3p2;
				var tmp11p2 = tmp1p2 + tmp2p2;
				var tmp12p2 = tmp1p2 - tmp2p2;

				data[dataOff] = tmp10p2 + tmp11p2; /* phase 3 */
				data[dataOff+32] = tmp10p2 - tmp11p2;

				var z1p2 = (tmp12p2 + tmp13p2) * 0.707106781; /* c4 */
				data[dataOff+16] = tmp13p2 + z1p2; /* phase 5 */
				data[dataOff+48] = tmp13p2 - z1p2;

				/* Odd part */
				tmp10p2 = tmp4p2 + tmp5p2; /* phase 2 */
				tmp11p2 = tmp5p2 + tmp6p2;
				tmp12p2 = tmp6p2 + tmp7p2;

				/* The rotator is modified from fig 4-8 to avoid extra negations. */
				var z5p2 = (tmp10p2 - tmp12p2) * 0.382683433; /* c6 */
				var z2p2 = 0.541196100 * tmp10p2 + z5p2; /* c2-c6 */
				var z4p2 = 1.306562965 * tmp12p2 + z5p2; /* c2+c6 */
				var z3p2 = tmp11p2 * 0.707106781; /* c4 */

				var z11p2 = tmp7p2 + z3p2;	/* phase 5 */
				var z13p2 = tmp7p2 - z3p2;

				data[dataOff+40] = z13p2 + z2p2; /* phase 6 */
				data[dataOff+24] = z13p2 - z2p2;
				data[dataOff+ 8] = z11p2 + z4p2;
				data[dataOff+56] = z11p2 - z4p2;

				dataOff++; /* advance pointer to next column */
			}

			// Quantize/descale the coefficients
			var fDCTQuantVar;
			var outputfDCTQuant = new Array(64);
			for (i=0; i<I64; ++i)
			{
				// Apply the quantization and scaling factor & Round to nearest integer
				fDCTQuantVar = data[i]*fdtbl[i];
				outputfDCTQuant[i] = (fDCTQuantVar > 0.0) ? ((fDCTQuantVar + 0.5)|0) : ((fDCTQuantVar - 0.5)|0);
				//outputfDCTQuant[i] = fround(fDCTQuant);

			}

			return outputfDCTQuant;
		}

		function writeAPP0()
		{
			writeWord(0xFFE0); // marker
			writeWord(16); // length
			writeByte(0x4A); // J
			writeByte(0x46); // F
			writeByte(0x49); // I
			writeByte(0x46); // F
			writeByte(0); // = "JFIF",'\0'
			writeByte(1); // versionhi
			writeByte(1); // versionlo
			writeByte(0); // xyunits
			writeWord(1); // xdensity
			writeWord(1); // ydensity
			writeByte(0); // thumbnwidth
			writeByte(0); // thumbnheight
		}

		function writeSOF0(width, height)
		{
			writeWord(0xFFC0); // marker
			writeWord(17);   // length, truecolor YUV JPG
			writeByte(8);    // precision
			writeWord(height);
			writeWord(width);
			writeByte(3);    // nrofcomponents
			writeByte(1);    // IdY
			writeByte(0x11); // HVY
			writeByte(0);    // QTY
			writeByte(2);    // IdU
			writeByte(0x11); // HVU
			writeByte(1);    // QTU
			writeByte(3);    // IdV
			writeByte(0x11); // HVV
			writeByte(1);    // QTV
		}

		function writeDQT()
		{
			writeWord(0xFFDB); // marker
			writeWord(132);	   // length
			writeByte(0);
			for (var i=0; i<64; i++) {
				writeByte(YTable[i]);
			}
			writeByte(1);
			for (var j=0; j<64; j++) {
				writeByte(UVTable[j]);
			}
		}

		function writeDHT()
		{
			writeWord(0xFFC4); // marker
			writeWord(0x01A2); // length

			writeByte(0); // HTYDCinfo
			for (var i=0; i<16; i++) {
				writeByte(std_dc_luminance_nrcodes[i+1]);
			}
			for (var j=0; j<=11; j++) {
				writeByte(std_dc_luminance_values[j]);
			}

			writeByte(0x10); // HTYACinfo
			for (var k=0; k<16; k++) {
				writeByte(std_ac_luminance_nrcodes[k+1]);
			}
			for (var l=0; l<=161; l++) {
				writeByte(std_ac_luminance_values[l]);
			}

			writeByte(1); // HTUDCinfo
			for (var m=0; m<16; m++) {
				writeByte(std_dc_chrominance_nrcodes[m+1]);
			}
			for (var n=0; n<=11; n++) {
				writeByte(std_dc_chrominance_values[n]);
			}

			writeByte(0x11); // HTUACinfo
			for (var o=0; o<16; o++) {
				writeByte(std_ac_chrominance_nrcodes[o+1]);
			}
			for (var p=0; p<=161; p++) {
				writeByte(std_ac_chrominance_values[p]);
			}
		}

		function writeSOS()
		{
			writeWord(0xFFDA); // marker
			writeWord(12); // length
			writeByte(3); // nrofcomponents
			writeByte(1); // IdY
			writeByte(0); // HTY
			writeByte(2); // IdU
			writeByte(0x11); // HTU
			writeByte(3); // IdV
			writeByte(0x11); // HTV
			writeByte(0); // Ss
			writeByte(0x3f); // Se
			writeByte(0); // Bf
		}

		function processDU(DU_DCT, DC, HTDC, HTAC){
			var EOB = HTAC[0x00];
			var M16zeroes = HTAC[0xF0];
			var pos;
			const I16 = 16;
			const I63 = 63;
			const I64 = 64;

			//ZigZag reorder
			for (var j=0;j<I64;++j) {
				DU[ZigZag[j]]=DU_DCT[j];
			}
			var Diff = DU[0] - DC; DC = DU[0];
			//Encode DC
			if (Diff==0) {
				writeBits(HTDC[0]); // Diff might be 0
			} else {
				pos = 32767+Diff;
				writeBits(HTDC[category[pos]]);
				writeBits(bitcode[pos]);
			}
			//Encode ACs
			var end0pos = 63; // was const... which is crazy
			for (; (end0pos>0)&&(DU[end0pos]==0); end0pos--) {};
			//end0pos = first element in reverse order !=0
			if ( end0pos == 0) {
				writeBits(EOB);
				return DC;
			}
			var i = 1;
			var lng;
			while ( i <= end0pos ) {
				var startpos = i;
				for (; (DU[i]==0) && (i<=end0pos); ++i) {}
				var nrzeroes = i-startpos;
				if ( nrzeroes >= I16 ) {
					lng = nrzeroes>>4;
					for (var nrmarker=1; nrmarker <= lng; ++nrmarker)
						writeBits(M16zeroes);
					nrzeroes = nrzeroes&0xF;
				}
				pos = 32767+DU[i];
				writeBits(HTAC[(nrzeroes<<4)+category[pos]]);
				writeBits(bitcode[pos]);
				i++;
			}
			if ( end0pos != I63 ) {
				writeBits(EOB);
			}
			return DC;
		}

		function initCharLookupTable(){
			var sfcc = String.fromCharCode;
			for(var i=0; i < 256; i++){ ///// ACHTUNG // 255
				clt[i] = sfcc(i);
			}
		}

		this.encodeAndModifyCoefficients = function(image, quality, coefficientModifier) // image data object
		{
			var time_start = new Date().getTime();

			setQuality(quality);

			// Initialize bit writer
			byteout = new Array();
			bytenew=0;
			bytepos=7;

			// Add JPEG headers
			writeWord(0xFFD8); // SOI
			writeAPP0();
			writeDQT();
			writeSOF0(image.width,image.height);
			writeDHT();
			writeSOS();


			// Encode 8x8 macroblocks
			var DCY=0;
			var DCU=0;
			var DCV=0;

			bytenew=0;
			bytepos=7;

			var imageData = image.data;
			var width = image.width;
			var height = image.height;

			var quadWidth = width*4;
			var tripleWidth = width*3;

			var x, y = 0;
			var j = 0;
			var r, g, b;
			var start,p, col,row,pos;
			var DU_DCT_ARRAY = new Array();
			DU_DCT_ARRAY[0] = new Array();
			DU_DCT_ARRAY[1] = new Array();
			DU_DCT_ARRAY[2] = new Array();
			while(y < height){
				x = 0;
				while(x < quadWidth){
					start = quadWidth * y + x;
					p = start;
					col = -1;
					row = 0;

					for(pos=0; pos < 64; pos++){
						row = pos >> 3;// /8
						col = ( pos & 7 ) * 4; // %8
						p = start + ( row * quadWidth ) + col;

						if(y+row >= height){ // padding bottom
							p-= (quadWidth*(y+1+row-height));
						}

						if(x+col >= quadWidth){ // padding right
							p-= ((x+col) - quadWidth +4)
						}

						r = imageData[ p++ ];
						g = imageData[ p++ ];
						b = imageData[ p++ ];


						/* // calculate YUV values dynamically
						YDU[pos]=((( 0.29900)*r+( 0.58700)*g+( 0.11400)*b))-128; //-0x80
						UDU[pos]=(((-0.16874)*r+(-0.33126)*g+( 0.50000)*b));
						VDU[pos]=((( 0.50000)*r+(-0.41869)*g+(-0.08131)*b));
						*/

						// use lookup table (slightly faster)
						YDU[pos] = ((RGB_YUV_TABLE[r]             + RGB_YUV_TABLE[(g +  256)>>0] + RGB_YUV_TABLE[(b +  512)>>0]) >> 16)-128;
						UDU[pos] = ((RGB_YUV_TABLE[(r +  768)>>0] + RGB_YUV_TABLE[(g + 1024)>>0] + RGB_YUV_TABLE[(b + 1280)>>0]) >> 16)-128;
						VDU[pos] = ((RGB_YUV_TABLE[(r + 1280)>>0] + RGB_YUV_TABLE[(g + 1536)>>0] + RGB_YUV_TABLE[(b + 1792)>>0]) >> 16)-128;
					}

					DU_DCT_ARRAY[0][j] = fDCTQuant(YDU, fdtbl_Y);
					DU_DCT_ARRAY[1][j] = fDCTQuant(UDU, fdtbl_UV);
					DU_DCT_ARRAY[2][j] = fDCTQuant(VDU, fdtbl_UV);

					x+=32;
					j++;
				}
				y+=8;
			}

			//This is where the passed in function gets to fiddle with the coefficients.
			coefficientModifier(DU_DCT_ARRAY);

			for (var i = 0; i < j; i++){
				DCY = processDU(DU_DCT_ARRAY[0][i], DCY, YDC_HT, YAC_HT);
				DCU = processDU(DU_DCT_ARRAY[1][i], DCU, UVDC_HT, UVAC_HT);
				DCV = processDU(DU_DCT_ARRAY[2][i], DCV, UVDC_HT, UVAC_HT);
			}

			// Do the bit alignment of the EOI marker
			if ( bytepos >= 0 ) {
				var fillbits = [];
				fillbits[1] = bytepos+1;
				fillbits[0] = (1<<(bytepos+1))-1;
				writeBits(fillbits);
			}

			writeWord(0xFFD9); //EOI

			var jpegDataUri = 'data:image/jpeg;base64,' + btoa(byteout.join(''));

			byteout = [];

			// benchmarking
			var duration = new Date().getTime() - time_start;
    		console.log('Encoding time: '+ duration + 'ms');
    		//

			return jpegDataUri
	}

	function setQuality(quality){
		if (quality <= 0) {
			quality = 1;
		}
		if (quality > 100) {
			quality = 100;
		}

		if(currentQuality == quality) return // don't recalc if unchanged

		var sf = 0;
		if (quality < 50) {
			sf = Math.floor(5000 / quality);
		} else {
			sf = Math.floor(200 - quality*2);
		}

		initQuantTables(sf);
		currentQuality = quality;
		console.log('Quality set to: '+quality +'%');
	}

	function init(){
		var time_start = new Date().getTime();
		// Create tables
		initCharLookupTable()
		initHuffmanTbl();
		initCategoryNumber();
		initRGBYUVTable();

		var duration = new Date().getTime() - time_start;
    	console.log('Initialization '+ duration + 'ms');
	}

	init();

};
</script>

<!--jsstegdecoder-1.0.js. Edits to display warning on error or skip over certain errors-->
<script>
/*
   Modified JPEG decoder for Steganography by Owen Campbell-Moore, based on one released by notmasteryet, in turn based on one release by Adobe.

   Copyright 2011 notmasteryet

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/

var JpegImage = (function jpegImage() {
  "use strict";
  var DU_DCT_ARRAY = new Array(3); //This will be filled with the DCT coefficients
  var dctZigZag = new Int32Array([
     0,
     1,  8,
    16,  9,  2,
     3, 10, 17, 24,
    32, 25, 18, 11, 4,
     5, 12, 19, 26, 33, 40,
    48, 41, 34, 27, 20, 13,  6,
     7, 14, 21, 28, 35, 42, 49, 56,
    57, 50, 43, 36, 29, 22, 15,
    23, 30, 37, 44, 51, 58,
    59, 52, 45, 38, 31,
    39, 46, 53, 60,
    61, 54, 47,
    55, 62,
    63
  ]);

  var dctCos1  =  4017   // cos(pi/16)
  var dctSin1  =   799   // sin(pi/16)
  var dctCos3  =  3406   // cos(3*pi/16)
  var dctSin3  =  2276   // sin(3*pi/16)
  var dctCos6  =  1567   // cos(6*pi/16)
  var dctSin6  =  3784   // sin(6*pi/16)
  var dctSqrt2 =  5793   // sqrt(2)
  var dctSqrt1d2 = 2896  // sqrt(2) / 2

  function constructor() {
  }

  function buildHuffmanTable(codeLengths, values) {
    var k = 0, code = [], i, j, length = 16;
    while (length > 0 && !codeLengths[length - 1])
      length--;
    code.push({children: [], index: 0});
    var p = code[0], q;
    for (i = 0; i < length; i++) {
      for (j = 0; j < codeLengths[i]; j++) {
        p = code.pop();
        p.children[p.index] = values[k];
        while (p.index > 0) {
          p = code.pop();
        }
        p.index++;
        code.push(p);
        while (code.length <= i) {
          code.push(q = {children: [], index: 0});
          p.children[p.index] = q.children;
          p = q;
        }
        k++;
      }
      if (i + 1 < length) {
        // p here points to last code
        code.push(q = {children: [], index: 0});
        p.children[p.index] = q.children;
        p = q;
      }
    }
    return code[0].children;
  }

  function decodeScan(data, offset,
                      frame, components, resetInterval,
                      spectralStart, spectralEnd,
                      successivePrev, successive) {
    var precision = frame.precision;
    var samplesPerLine = frame.samplesPerLine;
    var scanLines = frame.scanLines;
    var mcusPerLine = frame.mcusPerLine;
    var progressive = frame.progressive;
    var maxH = frame.maxH, maxV = frame.maxV;

    var startOffset = offset, bitsData = 0, bitsCount = 0;
    function readBit() {
      if (bitsCount > 0) {
        bitsCount--;
        return (bitsData >> bitsCount) & 1;
      }
      bitsData = data[offset++];
      if (bitsData == 0xFF) {
        var nextByte = data[offset++];
        if (nextByte) {
          throw "unexpected marker: " + ((bitsData << 8) | nextByte).toString(16);
        }
        // unstuff 0
      }
      bitsCount = 7;
      return bitsData >>> 7;
    }
    function decodeHuffman(tree) {
      var node = tree, bit;
      while ((bit = readBit()) !== null) {
        node = node[bit];
        if (typeof node === 'number')
          return node;
        if (typeof node !== 'object')
          throw "invalid huffman sequence";
      }
      return null;
    }
    function receive(length) {
      var n = 0;
      while (length > 0) {
        var bit = readBit();
        if (bit === null) return;
        n = (n << 1) | bit;
        length--;
      }
      return n;
    }
    function receiveAndExtend(length) {
      var n = receive(length);
      if (n >= 1 << (length - 1))
        return n;
      return n + (-1 << length) + 1;
    }
    function decodeBaseline(component, zz) {
      var t = decodeHuffman(component.huffmanTableDC);
      var diff = t === 0 ? 0 : receiveAndExtend(t);
      zz[0]= (component.pred += diff);
      var k = 1;
      while (k < 64) {
        var rs = decodeHuffman(component.huffmanTableAC);
        var s = rs & 15, r = rs >> 4;
        if (s === 0) {
          if (r < 15)
            break;
          k += 16;
          continue;
        }
        k += r;
        var z = dctZigZag[k];
        zz[z] = receiveAndExtend(s);
        k++;
      }
    }
    function decodeDCFirst(component, zz) {
      var t = decodeHuffman(component.huffmanTableDC);
      var diff = t === 0 ? 0 : (receiveAndExtend(t) << successive);
      zz[0] = (component.pred += diff);
    }
    function decodeDCSuccessive(component, zz) {
      zz[0] |= readBit() << successive;
    }
    var eobrun = 0;
    function decodeACFirst(component, zz) {
      if (eobrun > 0) {
        eobrun--;
        return;
      }
      var k = spectralStart, e = spectralEnd;
      while (k <= e) {
        var rs = decodeHuffman(component.huffmanTableAC);
        var s = rs & 15, r = rs >> 4;
        if (s === 0) {
          if (r < 15) {
            eobrun = receive(r) + (1 << r) - 1;
            break;
          }
          k += 16;
          continue;
        }
        k += r;
        var z = dctZigZag[k];
        zz[z] = receiveAndExtend(s) * (1 << successive);
        k++;
      }
    }
    var successiveACState = 0, successiveACNextValue;
    function decodeACSuccessive(component, zz) {
      var k = spectralStart, e = spectralEnd, r = 0;
      while (k <= e) {
        var z = dctZigZag[k];
        switch (successiveACState) {
        case 0: // initial state
          var rs = decodeHuffman(component.huffmanTableAC);
          var s = rs & 15, r = rs >> 4;
          if (s === 0) {
            if (r < 15) {
              eobrun = receive(r) + (1 << r);
              successiveACState = 4;
            } else {
              r = 16;
              successiveACState = 1;
            }
          } else {
            if (s !== 1)
              throw "invalid ACn encoding";
            successiveACNextValue = receiveAndExtend(s);
            successiveACState = r ? 2 : 3;
          }
          continue;
        case 1: // skipping r zero items
        case 2:
          if (zz[z])
            zz[z] += (readBit() << successive);
          else {
            r--;
            if (r === 0)
              successiveACState = successiveACState == 2 ? 3 : 0;
          }
          break;
        case 3: // set value for a zero item
          if (zz[z])
            zz[z] += (readBit() << successive);
          else {
            zz[z] = successiveACNextValue << successive;
            successiveACState = 0;
          }
          break;
        case 4: // eob
          if (zz[z])
            zz[z] += (readBit() << successive);
          break;
        }
        k++;
      }
      if (successiveACState === 4) {
        eobrun--;
        if (eobrun === 0)
          successiveACState = 0;
      }
    }
    function decodeMcu(component, decode, mcu, row, col) {
      var mcuRow = (mcu / mcusPerLine) | 0;
      var mcuCol = mcu % mcusPerLine;
      var blockRow = mcuRow * component.v + row;
      var blockCol = mcuCol * component.h + col;
      decode(component, component.blocks[blockRow][blockCol]);
    }
    function decodeBlock(component, decode, mcu) {
      var blockRow = (mcu / component.blocksPerLine) | 0;
      var blockCol = mcu % component.blocksPerLine;
      decode(component, component.blocks[blockRow][blockCol]);
    }

    var componentsLength = components.length;
    var component, i, j, k, n;
    var decodeFn;
    if (progressive) {
      if (spectralStart === 0)
        decodeFn = successivePrev === 0 ? decodeDCFirst : decodeDCSuccessive;
      else
        decodeFn = successivePrev === 0 ? decodeACFirst : decodeACSuccessive;
    } else {
      decodeFn = decodeBaseline;
    }

    var mcu = 0, marker;
    var mcuExpected;
    if (componentsLength == 1) {
      mcuExpected = components[0].blocksPerLine * components[0].blocksPerColumn;
    } else {
      mcuExpected = mcusPerLine * frame.mcusPerColumn;
    }
    if (!resetInterval) resetInterval = mcuExpected;

    var h, v;
    while (mcu < mcuExpected) {
      // reset interval stuff
      for (i = 0; i < componentsLength; i++)
        components[i].pred = 0;
      eobrun = 0;

      if (componentsLength == 1) {
        component = components[0];
        for (n = 0; n < resetInterval; n++) {
          decodeBlock(component, decodeFn, mcu);
          mcu++;
        }
      } else {
        for (n = 0; n < resetInterval; n++) {
          for (i = 0; i < componentsLength; i++) {
            component = components[i];
            h = component.h;
            v = component.v;
            for (j = 0; j < v; j++) {
              for (k = 0; k < h; k++) {
                decodeMcu(component, decodeFn, mcu, j, k);
              }
            }
          }
          mcu++;
        }
      }

      // find marker
      bitsCount = 0;
      marker = (data[offset] << 8) | data[offset + 1];
      if (marker <= 0xFF00) {
		  imageMsg.textContent = 'This JPG image has errors';		//warning added by F. Ruiz for use in PassLok
//        throw "marker was not found";
      }

      if (marker >= 0xFFD0 && marker <= 0xFFD7) { // RSTx
        offset += 2;
      }
      else
        break;
    }

    return offset - startOffset;
  }

  function buildComponentData(frame, component) {
    var lines = [];
    var blocksPerLine = component.blocksPerLine;
    var blocksPerColumn = component.blocksPerColumn;
    var samplesPerLine = blocksPerLine << 3;
    var R = new Int32Array(64), r = new Uint8Array(64);

    // A port of poppler's IDCT method which in turn is taken from:
    //   Christoph Loeffler, Adriaan Ligtenberg, George S. Moschytz,
    //   "Practical Fast 1-D DCT Algorithms with 11 Multiplications",
    //   IEEE Intl. Conf. on Acoustics, Speech & Signal Processing, 1989,
    //   988-991.
    function quantizeAndInverse(zz, dataOut, dataIn) {
      var qt = component.quantizationTable;
      var v0, v1, v2, v3, v4, v5, v6, v7, t;
      var p = dataIn;
      var i;

      // dequant
      for (i = 0; i < 64; i++)
        p[i] = zz[i] * qt[i];

      // inverse DCT on rows
      for (i = 0; i < 8; ++i) {
        var row = 8 * i;

        // check for all-zero AC coefficients
        if (p[1 + row] == 0 && p[2 + row] == 0 && p[3 + row] == 0 &&
            p[4 + row] == 0 && p[5 + row] == 0 && p[6 + row] == 0 &&
            p[7 + row] == 0) {
          t = (dctSqrt2 * p[0 + row] + 512) >> 10;
          p[0 + row] = t;
          p[1 + row] = t;
          p[2 + row] = t;
          p[3 + row] = t;
          p[4 + row] = t;
          p[5 + row] = t;
          p[6 + row] = t;
          p[7 + row] = t;
          continue;
        }

        // stage 4
        v0 = (dctSqrt2 * p[0 + row] + 128) >> 8;
        v1 = (dctSqrt2 * p[4 + row] + 128) >> 8;
        v2 = p[2 + row];
        v3 = p[6 + row];
        v4 = (dctSqrt1d2 * (p[1 + row] - p[7 + row]) + 128) >> 8;
        v7 = (dctSqrt1d2 * (p[1 + row] + p[7 + row]) + 128) >> 8;
        v5 = p[3 + row] << 4;
        v6 = p[5 + row] << 4;

        // stage 3
        t = (v0 - v1+ 1) >> 1;
        v0 = (v0 + v1 + 1) >> 1;
        v1 = t;
        t = (v2 * dctSin6 + v3 * dctCos6 + 128) >> 8;
        v2 = (v2 * dctCos6 - v3 * dctSin6 + 128) >> 8;
        v3 = t;
        t = (v4 - v6 + 1) >> 1;
        v4 = (v4 + v6 + 1) >> 1;
        v6 = t;
        t = (v7 + v5 + 1) >> 1;
        v5 = (v7 - v5 + 1) >> 1;
        v7 = t;

        // stage 2
        t = (v0 - v3 + 1) >> 1;
        v0 = (v0 + v3 + 1) >> 1;
        v3 = t;
        t = (v1 - v2 + 1) >> 1;
        v1 = (v1 + v2 + 1) >> 1;
        v2 = t;
        t = (v4 * dctSin3 + v7 * dctCos3 + 2048) >> 12;
        v4 = (v4 * dctCos3 - v7 * dctSin3 + 2048) >> 12;
        v7 = t;
        t = (v5 * dctSin1 + v6 * dctCos1 + 2048) >> 12;
        v5 = (v5 * dctCos1 - v6 * dctSin1 + 2048) >> 12;
        v6 = t;

        // stage 1
        p[0 + row] = v0 + v7;
        p[7 + row] = v0 - v7;
        p[1 + row] = v1 + v6;
        p[6 + row] = v1 - v6;
        p[2 + row] = v2 + v5;
        p[5 + row] = v2 - v5;
        p[3 + row] = v3 + v4;
        p[4 + row] = v3 - v4;
      }

      // inverse DCT on columns
      for (i = 0; i < 8; ++i) {
        var col = i;

        // check for all-zero AC coefficients
        if (p[1*8 + col] == 0 && p[2*8 + col] == 0 && p[3*8 + col] == 0 &&
            p[4*8 + col] == 0 && p[5*8 + col] == 0 && p[6*8 + col] == 0 &&
            p[7*8 + col] == 0) {
          t = (dctSqrt2 * dataIn[i+0] + 8192) >> 14;
          p[0*8 + col] = t;
          p[1*8 + col] = t;
          p[2*8 + col] = t;
          p[3*8 + col] = t;
          p[4*8 + col] = t;
          p[5*8 + col] = t;
          p[6*8 + col] = t;
          p[7*8 + col] = t;
          continue;
        }

        // stage 4
        v0 = (dctSqrt2 * p[0*8 + col] + 2048) >> 12;
        v1 = (dctSqrt2 * p[4*8 + col] + 2048) >> 12;
        v2 = p[2*8 + col];
        v3 = p[6*8 + col];
        v4 = (dctSqrt1d2 * (p[1*8 + col] - p[7*8 + col]) + 2048) >> 12;
        v7 = (dctSqrt1d2 * (p[1*8 + col] + p[7*8 + col]) + 2048) >> 12;
        v5 = p[3*8 + col];
        v6 = p[5*8 + col];

        // stage 3
        t = (v0 - v1 + 1) >> 1;
        v0 = (v0 + v1 + 1) >> 1;
        v1 = t;
        t = (v2 * dctSin6 + v3 * dctCos6 + 2048) >> 12;
        v2 = (v2 * dctCos6 - v3 * dctSin6 + 2048) >> 12;
        v3 = t;
        t = (v4 - v6 + 1) >> 1;
        v4 = (v4 + v6 + 1) >> 1;
        v6 = t;
        t = (v7 + v5 + 1) >> 1;
        v5 = (v7 - v5 + 1) >> 1;
        v7 = t;

        // stage 2
        t = (v0 - v3 + 1) >> 1;
        v0 = (v0 + v3 + 1) >> 1;
        v3 = t;
        t = (v1 - v2 + 1) >> 1;
        v1 = (v1 + v2 + 1) >> 1;
        v2 = t;
        t = (v4 * dctSin3 + v7 * dctCos3 + 2048) >> 12;
        v4 = (v4 * dctCos3 - v7 * dctSin3 + 2048) >> 12;
        v7 = t;
        t = (v5 * dctSin1 + v6 * dctCos1 + 2048) >> 12;
        v5 = (v5 * dctCos1 - v6 * dctSin1 + 2048) >> 12;
        v6 = t;

        // stage 1
        p[0*8 + col] = v0 + v7;
        p[7*8 + col] = v0 - v7;
        p[1*8 + col] = v1 + v6;
        p[6*8 + col] = v1 - v6;
        p[2*8 + col] = v2 + v5;
        p[5*8 + col] = v2 - v5;
        p[3*8 + col] = v3 + v4;
        p[4*8 + col] = v3 - v4;
      }

      // convert to 8-bit integers
      for (i = 0; i < 64; ++i) {
        var sample = 128 + ((p[i] + 8) >> 4);
        dataOut[i] = sample < 0 ? 0 : sample > 0xFF ? 0xFF : sample;
      }
    }

    DU_DCT_ARRAY[component.componentId] = new Array();
    var k = 0;
    for (var blockRow = 0; blockRow < blocksPerColumn; blockRow++) {
      for (var blockCol = 0; blockCol < blocksPerLine; blockCol++) {
        DU_DCT_ARRAY[component.componentId][k] = new Array(64);
        for (var i = 0; i<64; i++) {
          DU_DCT_ARRAY[component.componentId][k][i] = component.blocks[blockRow][blockCol][i];
        }
        k++;
      }
    }

    var i, j;
    for (var blockRow = 0; blockRow < blocksPerColumn; blockRow++) {
      var scanLine = blockRow << 3;
      for (i = 0; i < 8; i++)
        lines.push(new Uint8Array(samplesPerLine));
      for (var blockCol = 0; blockCol < blocksPerLine; blockCol++) {
        quantizeAndInverse(component.blocks[blockRow][blockCol], r, R);

        var offset = 0, sample = blockCol << 3;
        for (j = 0; j < 8; j++) {
          var line = lines[scanLine + j];
          for (i = 0; i < 8; i++)
            line[sample + i] = r[offset++];
        }
      }
    }
    return lines;
  }

  constructor.prototype = {
    load: function load(path, returnDCT) {
      var xhr = new XMLHttpRequest();
      console.log("Loading "+path);
      xhr.open("GET", path, true);
      xhr.responseType = "arraybuffer";
      xhr.onload = (function() {
        // TODO catch parse error
        var data = new Uint8Array(xhr.response || xhr.mozResponseArrayBuffer);
        this.parse(data);
        if (this.onload)
          if (returnDCT) {
            this.onload(DU_DCT_ARRAY);
          } else {
            this.onload();
          }
      }).bind(this);
      xhr.send(null);
    },
    parse: function parse(data) {
      var offset = 0, length = data.length;
      function readUint16() {
        var value = (data[offset] << 8) | data[offset + 1];
        offset += 2;
        return value;
      }
      function readDataBlock() {
        var length = readUint16();
        var array = data.subarray(offset, offset + length - 2);
        offset += array.length;
        return array;
      }
      function prepareComponents(frame) {
        var maxH = 0, maxV = 0;
        var component, componentId;
        for (componentId in frame.components) {
          if (frame.components.hasOwnProperty(componentId)) {
            component = frame.components[componentId];
            if (maxH < component.h) maxH = component.h;
            if (maxV < component.v) maxV = component.v;
          }
        }
        var mcusPerLine = Math.ceil(frame.samplesPerLine / 8 / maxH);
        var mcusPerColumn = Math.ceil(frame.scanLines / 8 / maxV);
        for (componentId in frame.components) {
          if (frame.components.hasOwnProperty(componentId)) {
            component = frame.components[componentId];
            var blocksPerLine = Math.ceil(Math.ceil(frame.samplesPerLine / 8) * component.h / maxH);
            var blocksPerColumn = Math.ceil(Math.ceil(frame.scanLines  / 8) * component.v / maxV);
            var blocksPerLineForMcu = mcusPerLine * component.h;
            var blocksPerColumnForMcu = mcusPerColumn * component.v;
            var blocks = [];
            for (var i = 0; i < blocksPerColumnForMcu; i++) {
              var row = [];
              for (var j = 0; j < blocksPerLineForMcu; j++)
                row.push(new Int32Array(64));
              blocks.push(row);
            }
            component.blocksPerLine = blocksPerLine;
            component.blocksPerColumn = blocksPerColumn;
            component.blocks = blocks;
          }
        }
        frame.maxH = maxH;
        frame.maxV = maxV;
        frame.mcusPerLine = mcusPerLine;
        frame.mcusPerColumn = mcusPerColumn;
      }
      var jfif = null;
      var adobe = null;
      var pixels = null;
      var frame, resetInterval;
      var quantizationTables = [], frames = [];
      var huffmanTablesAC = [], huffmanTablesDC = [];
      var fileMarker = readUint16();
      if (fileMarker != 0xFFD8) { // SOI (Start of Image)
        throw "SOI not found";
      }

      fileMarker = readUint16();
      while (fileMarker != 0xFFD9) { // EOI (End of image)
        var i, j, l;
        switch(fileMarker) {
          case 0xFFE0: // APP0 (Application Specific)
          case 0xFFE1: // APP1
          case 0xFFE2: // APP2
          case 0xFFE3: // APP3
          case 0xFFE4: // APP4
          case 0xFFE5: // APP5
          case 0xFFE6: // APP6
          case 0xFFE7: // APP7
          case 0xFFE8: // APP8
          case 0xFFE9: // APP9
          case 0xFFEA: // APP10
          case 0xFFEB: // APP11
          case 0xFFEC: // APP12
          case 0xFFED: // APP13
          case 0xFFEE: // APP14
          case 0xFFEF: // APP15
          case 0xFFFE: // COM (Comment)
            var appData = readDataBlock();

            if (fileMarker === 0xFFE0) {
              if (appData[0] === 0x4A && appData[1] === 0x46 && appData[2] === 0x49 &&
                appData[3] === 0x46 && appData[4] === 0) { // 'JFIF\x00'
                jfif = {
                  version: { major: appData[5], minor: appData[6] },
                  densityUnits: appData[7],
                  xDensity: (appData[8] << 8) | appData[9],
                  yDensity: (appData[10] << 8) | appData[11],
                  thumbWidth: appData[12],
                  thumbHeight: appData[13],
                  thumbData: appData.subarray(14, 14 + 3 * appData[12] * appData[13])
                };
              }
            }
            // TODO APP1 - Exif
            if (fileMarker === 0xFFEE) {
              if (appData[0] === 0x41 && appData[1] === 0x64 && appData[2] === 0x6F &&
                appData[3] === 0x62 && appData[4] === 0x65 && appData[5] === 0) { // 'Adobe\x00'
                adobe = {
                  version: appData[6],
                  flags0: (appData[7] << 8) | appData[8],
                  flags1: (appData[9] << 8) | appData[10],
                  transformCode: appData[11]
                };
              }
            }
            break;

          case 0xFFDB: // DQT (Define Quantization Tables)
            var quantizationTableCount = Math.floor((readUint16() - 2) / 65);
            for (i = 0; i < quantizationTableCount; i++) {
              var quantizationTableSpec = data[offset++];
              var tableData = new Int32Array(64);
              if ((quantizationTableSpec >> 4) === 0) { // 8 bit values
                for (j = 0; j < 64; j++) {
                  var z = dctZigZag[j];
                  tableData[z] = data[offset++];
                }
              } else if ((quantizationTableSpec >> 4) === 1) { //16 bit
                for (j = 0; j < 64; j++) {
                  var z = dctZigZag[j];
                  tableData[z] = readUint16();
                }
              } else
                throw "DQT: invalid table spec";
              quantizationTables[quantizationTableSpec & 15] = tableData;
            }
            break;

          case 0xFFC0: // SOF0 (Start of Frame, Baseline DCT)
          case 0xFFC2: // SOF2 (Start of Frame, Progressive DCT)
            readUint16(); // skip data length
            frame = {};
            frame.progressive = (fileMarker === 0xFFC2);
            frame.precision = data[offset++];
            frame.scanLines = readUint16();
            frame.samplesPerLine = readUint16();
            frame.components = {};
            frame.componentsOrder = [];
            var componentsCount = data[offset++], componentId;
            var maxH = 0, maxV = 0;
            for (i = 0; i < componentsCount; i++) {
              componentId = data[offset];
              var h = data[offset + 1] >> 4;
              var v = data[offset + 1] & 15;
              var qId = data[offset + 2];
              frame.componentsOrder.push(componentId);
              frame.components[componentId] = {
                componentId: componentId,
                h: h,
                v: v,
                quantizationTable: quantizationTables[qId]
              };
              offset += 3;
            }
            prepareComponents(frame);
            frames.push(frame);
            break;

          case 0xFFC4: // DHT (Define Huffman Tables)
            var huffmanLength = readUint16();
            for (i = 2; i < huffmanLength;) {
              var huffmanTableSpec = data[offset++];
              var codeLengths = new Uint8Array(16);
              var codeLengthSum = 0;
              for (j = 0; j < 16; j++, offset++)
                codeLengthSum += (codeLengths[j] = data[offset]);
              var huffmanValues = new Uint8Array(codeLengthSum);
              for (j = 0; j < codeLengthSum; j++, offset++)
                huffmanValues[j] = data[offset];
              i += 17 + codeLengthSum;

              ((huffmanTableSpec >> 4) === 0 ?
                huffmanTablesDC : huffmanTablesAC)[huffmanTableSpec & 15] =
                buildHuffmanTable(codeLengths, huffmanValues);
            }
            break;

          case 0xFFDD: // DRI (Define Restart Interval)
            readUint16(); // skip data length
            resetInterval = readUint16();
            break;

          case 0xFFDA: // SOS (Start of Scan)
            var scanLength = readUint16();
            var selectorsCount = data[offset++];
            var components = [], component;
            for (i = 0; i < selectorsCount; i++) {
              component = frame.components[data[offset++]];
              var tableSpec = data[offset++];
              component.huffmanTableDC = huffmanTablesDC[tableSpec >> 4];
              component.huffmanTableAC = huffmanTablesAC[tableSpec & 15];
              components.push(component);
            }
            var spectralStart = data[offset++];
            var spectralEnd = data[offset++];
            var successiveApproximation = data[offset++];
            var processed = decodeScan(data, offset,
              frame, components, resetInterval,
              spectralStart, spectralEnd,
              successiveApproximation >> 4, successiveApproximation & 15);
            offset += processed;
            break;
          default:
//            throw "unknown JPEG marker " + fileMarker.toString(16);
        }
        fileMarker = readUint16();
      }
      if (frames.length != 1)
        throw "only single frame JPEGs supported";

      this.width = frame.samplesPerLine;
      this.height = frame.scanLines;
      this.jfif = jfif;
      this.adobe = adobe;
      this.components = [];
      for (var i = 0; i < frame.componentsOrder.length; i++) {
        var component = frame.components[frame.componentsOrder[i]];
        this.components.push({
          lines: buildComponentData(frame, component),
          scaleX: component.h / frame.maxH,
          scaleY: component.v / frame.maxV
        });
      }
    },
    getData: function getData(width, height) {
      function clampTo8bit(a) {
        return a < 0 ? 0 : a > 255 ? 255 : a;
      }
      var scaleX = this.width / width, scaleY = this.height / height;

      var component1, component2, component3, component4;
      var component1Line, component2Line, component3Line, component4Line;
      var x, y;
      var offset = 0;
      var Y, Cb, Cr, K, C, M, Ye, R, G, B;
      var colorTransform;
      var dataLength = width * height * this.components.length;
      var data = new Uint8Array(dataLength);
      switch (this.components.length) {
        case 1:
          component1 = this.components[0];
          for (y = 0; y < height; y++) {
            component1Line = component1.lines[0 | (y * component1.scaleY * scaleY)];
            for (x = 0; x < width; x++) {
              Y = component1Line[0 | (x * component1.scaleX * scaleX)];

              data[offset++] = Y;
            }
          }
          break;
        case 3:
          // The default transform for three components is true
          colorTransform = true;
          // The adobe transform marker overrides any previous setting
          if (this.adobe && this.adobe.transformCode)
            colorTransform = true;
          else if (typeof this.colorTransform !== 'undefined')
            colorTransform = !!this.colorTransform;

          component1 = this.components[0];
          component2 = this.components[1];
          component3 = this.components[2];
          for (y = 0; y < height; y++) {
            component1Line = component1.lines[0 | (y * component1.scaleY * scaleY)];
            component2Line = component2.lines[0 | (y * component2.scaleY * scaleY)];
            component3Line = component3.lines[0 | (y * component3.scaleY * scaleY)];
            for (x = 0; x < width; x++) {
              if (!colorTransform) {
                R = component1Line[0 | (x * component1.scaleX * scaleX)];
                G = component2Line[0 | (x * component2.scaleX * scaleX)];
                B = component3Line[0 | (x * component3.scaleX * scaleX)];
              } else {
                Y = component1Line[0 | (x * component1.scaleX * scaleX)];
                Cb = component2Line[0 | (x * component2.scaleX * scaleX)];
                Cr = component3Line[0 | (x * component3.scaleX * scaleX)];

                R = clampTo8bit(Y + 1.402 * (Cr - 128));
                G = clampTo8bit(Y - 0.3441363 * (Cb - 128) - 0.71413636 * (Cr - 128));
                B = clampTo8bit(Y + 1.772 * (Cb - 128));
              }

              data[offset++] = R;
              data[offset++] = G;
              data[offset++] = B;
            }
          }
          break;
        case 4:
          if (!this.adobe)
            throw 'Unsupported color mode (4 components)';
          // The default transform for four components is false
          colorTransform = false;
          // The adobe transform marker overrides any previous setting
          if (this.adobe && this.adobe.transformCode)
            colorTransform = true;
          else if (typeof this.colorTransform !== 'undefined')
            colorTransform = !!this.colorTransform;

          component1 = this.components[0];
          component2 = this.components[1];
          component3 = this.components[2];
          component4 = this.components[3];
          for (y = 0; y < height; y++) {
            component1Line = component1.lines[0 | (y * component1.scaleY * scaleY)];
            component2Line = component2.lines[0 | (y * component2.scaleY * scaleY)];
            component3Line = component3.lines[0 | (y * component3.scaleY * scaleY)];
            component4Line = component4.lines[0 | (y * component4.scaleY * scaleY)];
            for (x = 0; x < width; x++) {
              if (!colorTransform) {
                C = component1Line[0 | (x * component1.scaleX * scaleX)];
                M = component2Line[0 | (x * component2.scaleX * scaleX)];
                Ye = component3Line[0 | (x * component3.scaleX * scaleX)];
                K = component4Line[0 | (x * component4.scaleX * scaleX)];
              } else {
                Y = component1Line[0 | (x * component1.scaleX * scaleX)];
                Cb = component2Line[0 | (x * component2.scaleX * scaleX)];
                Cr = component3Line[0 | (x * component3.scaleX * scaleX)];
                K = component4Line[0 | (x * component4.scaleX * scaleX)];

                C = 255 - clampTo8bit(Y + 1.402 * (Cr - 128));
                M = 255 - clampTo8bit(Y - 0.3441363 * (Cb - 128) - 0.71413636 * (Cr - 128));
                Ye = 255 - clampTo8bit(Y + 1.772 * (Cb - 128));
              }
              data[offset++] = C;
              data[offset++] = M;
              data[offset++] = Ye;
              data[offset++] = K;
            }
          }
          break;
        default:
          throw 'Unsupported color mode';
      }
      return data;
    },
    copyToImageData: function copyToImageData(imageData) {
      var width = imageData.width, height = imageData.height;
      var imageDataArray = imageData.data;
      var data = this.getData(width, height);
      var i = 0, j = 0, x, y;
      var Y, K, C, M, R, G, B;
      switch (this.components.length) {
        case 1:
          for (y = 0; y < height; y++) {
            for (x = 0; x < width; x++) {
              Y = data[i++];

              imageDataArray[j++] = Y;
              imageDataArray[j++] = Y;
              imageDataArray[j++] = Y;
              imageDataArray[j++] = 255;
            }
          }
          break;
        case 3:
          for (y = 0; y < height; y++) {
            for (x = 0; x < width; x++) {
              R = data[i++];
              G = data[i++];
              B = data[i++];

              imageDataArray[j++] = R;
              imageDataArray[j++] = G;
              imageDataArray[j++] = B;
              imageDataArray[j++] = 255;
            }
          }
          break;
        case 4:
          for (y = 0; y < height; y++) {
            for (x = 0; x < width; x++) {
              C = data[i++];
              M = data[i++];
              Y = data[i++];
              K = data[i++];

              R = 255 - clampTo8bit(C * (1 - K / 255) + K);
              G = 255 - clampTo8bit(M * (1 - K / 255) + K);
              B = 255 - clampTo8bit(Y * (1 - K / 255) + K);

              imageDataArray[j++] = R;
              imageDataArray[j++] = G;
              imageDataArray[j++] = B;
              imageDataArray[j++] = 255;
            }
          }
          break;
        default:
          throw 'Unsupported color mode';
      }
    }
  };

  return constructor;
})();
</script>

<!--jssteg-1.0.js-->
<script>
/**
 * jsSteg Javascript Library v1.0
 * https://github.com/owencm/js-steg
 * Copyright 2014, Owen Campbell-Moore and other contributors
 * Released under the MIT license
 *
 * Usage:
 * jsSteg provides two public functions, getCoefficients and reEncodeWithModifications.
 * Refer to their documentation below to understand their usage.
 *
 * Note:
 * This library depends on jsstegdecoder-1.0.js and jsstegencoder-1.0.js which have different
 * licences and must be included before this library.
 */
var jsSteg = (function() {
  /**
   * Use the JPEG decoding library and pass on the coefficients to coeffReader
   * - url: the blob URL from which to read the image
   * - coeffReader: a function which will be called with the coefficients as an argument
   */
  var getCoefficients = function(url, coeffReader) {
    var image;
    image = new JpegImage();
    image.onload = function(coefficients) {
      return coeffReader(coefficients);
    };
    return image.load(url, true);
  };

  /**
   * Convert an image in any format to bmp data for encoding
   * - url: the blob URL to convert to bmp
   * - callback: called with the resulting data
   */
  var getImageDataFromURL = function(url, callback) {
    var img;
    img = document.createElement("img");
    img.onload = function() {
      var ctx, cvs;
      cvs = document.createElement("canvas");
      cvs.width = img.width;
      cvs.height = img.height;
      ctx = cvs.getContext("2d");
      ctx.drawImage(img, 0, 0);
      return callback(ctx.getImageData(0, 0, cvs.width, cvs.height));
    };
    return img.src = url;
  };

  /**
   * Decode the provided JPEG to raw data and then re-encode it with the JPEG encoding library,
   * running coefficientModifier on the coefficients while encoding
   * - url: the blob URL from which to 're-encode'
   * - coefficientModifier: this will be called with the coefficients as an argument which it can
   * modify before the encoding is completed
   */
  var reEncodeWithModifications = function(url, coefficientModifier, callback) {
    getImageDataFromURL(url, function(data) {
      var encoder = new JPEGEncoder();
      var jpegURI = encoder.encodeAndModifyCoefficients(data, 75, modifyCoefficients);
      callback(jpegURI);
    });
  }

  return {
    getCoefficients: getCoefficients,
    reEncodeWithModifications: reEncodeWithModifications
  };
})();
</script>

<!--isaac seedable PRNG by Yves-Marie Rinquin. https://github.com/rubycon/isaac.js/blob/master/isaac.js-->
<script>
/* ----------------------------------------------------------------------
 * Copyright (c) 2012 Yves-Marie K. Rinquin
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * ----------------------------------------------------------------------
 *
 * ISAAC is a cryptographically secure pseudo-random number generator
 * (or CSPRNG for short) designed by Robert J. Jenkins Jr. in 1996 and
 * based on RC4. It is designed for speed and security.
 *
 * ISAAC's informations & analysis:
 *   http://burtleburtle.net/bob/rand/isaac.html
 * ISAAC's implementation details:
 *   http://burtleburtle.net/bob/rand/isaacafa.html
 *
 * ISAAC succesfully passed TestU01
 *
 * ----------------------------------------------------------------------
 *
 * Usage:
 *   var random_number = isaac.random();
 *
 * Output: [ 0x00000000; 0xffffffff]
 *         [-2147483648; 2147483647]
 *
 */

/* js string (ucs-2/utf16) to a 32-bit integer (utf-8 chars, little-endian) array */
String.prototype.toIntArray = function() {
  var w1, w2, u, r4 = [], r = [], i = 0;
  var s = this + '\0\0\0'; // pad string to avoid discarding last chars
  var l = s.length - 1;

  while(i < l) {
    w1 = s.charCodeAt(i++);
    w2 = s.charCodeAt(i+1);
    if       (w1 < 0x0080) {
      // 0x0000 - 0x007f code point: basic ascii
      r4.push(w1);
    } else if(w1 < 0x0800) {
      // 0x0080 - 0x07ff code point
      r4.push(((w1 >>>  6) & 0x1f) | 0xc0);
      r4.push(((w1 >>>  0) & 0x3f) | 0x80);
    } else if((w1 & 0xf800) != 0xd800) {
      // 0x0800 - 0xd7ff / 0xe000 - 0xffff code point
      r4.push(((w1 >>> 12) & 0x0f) | 0xe0);
      r4.push(((w1 >>>  6) & 0x3f) | 0x80);
      r4.push(((w1 >>>  0) & 0x3f) | 0x80);
    } else if(((w1 & 0xfc00) == 0xd800)
           && ((w2 & 0xfc00) == 0xdc00)) {
      // 0xd800 - 0xdfff surrogate / 0x10ffff - 0x10000 code point
      u = ((w2 & 0x3f) | ((w1 & 0x3f) << 10)) + 0x10000;
      r4.push(((u >>> 18) & 0x07) | 0xf0);
      r4.push(((u >>> 12) & 0x3f) | 0x80);
      r4.push(((u >>>  6) & 0x3f) | 0x80);
      r4.push(((u >>>  0) & 0x3f) | 0x80);
      i++;
    } else {
      // invalid char
    }
    /* add integer (four utf-8 value) to array */
    if(r4.length > 3) {
      // little endian
      r.push((r4.shift() <<  0) | (r4.shift() <<  8) |
             (r4.shift() << 16) | (r4.shift() << 24));
    }
  }

  return r;
}

/* isaac module pattern */
var isaac = (function(){

  /* private: internal states */
  var m = Array(256), // internal memory
      acc = 0,        // accumulator
      brs = 0,        // last result
      cnt = 0,        // counter
      r = Array(256), // result array
      gnt = 0;        // generation counter

  seed(Math.random() * 0xffffffff);

  /* private: 32-bit integer safe adder */
  function add(x, y) {
    var lsb = (x & 0xffff) + (y & 0xffff);
    var msb = (x >>>   16) + (y >>>   16) + (lsb >>> 16);
    return (msb << 16) | (lsb & 0xffff);
  }

  /* public: initialisation */
  function reset() {
    acc = brs = cnt = 0;
    for(var i = 0; i < 256; ++i)
      m[i] = r[i] = 0;
    gnt = 0;
  }

  /* public: seeding function */
  function seed(s) {
    var a, b, c, d, e, f, g, h, i;

    /* seeding the seeds of love */
    a = b = c = d =
    e = f = g = h = 0x9e3779b9; /* the golden ratio */

    if(s && typeof(s) === 'string')
      s = s.toIntArray();

    if(s && typeof(s) === 'number') {
      s = [s];
    }

    if(s instanceof Array) {
      reset();
      for(i = 0; i < s.length; i++)
        r[i & 0xff] += (typeof(s[i]) === 'number') ? s[i] : 0;
    }

    /* private: seed mixer */
    function seed_mix() {
      a ^= b <<  11; d = add(d, a); b = add(b, c);
      b ^= c >>>  2; e = add(e, b); c = add(c, d);
      c ^= d <<   8; f = add(f, c); d = add(d, e);
      d ^= e >>> 16; g = add(g, d); e = add(e, f);
      e ^= f <<  10; h = add(h, e); f = add(f, g);
      f ^= g >>>  4; a = add(a, f); g = add(g, h);
      g ^= h <<   8; b = add(b, g); h = add(h, a);
      h ^= a >>>  9; c = add(c, h); a = add(a, b);
    }

    for(i = 0; i < 4; i++) /* scramble it */
      seed_mix();

    for(i = 0; i < 256; i += 8) {
      if(s) { /* use all the information in the seed */
        a = add(a, r[i + 0]); b = add(b, r[i + 1]);
        c = add(c, r[i + 2]); d = add(d, r[i + 3]);
        e = add(e, r[i + 4]); f = add(f, r[i + 5]);
        g = add(g, r[i + 6]); h = add(h, r[i + 7]);
      }
      seed_mix();
      /* fill in m[] with messy stuff */
      m[i + 0] = a; m[i + 1] = b; m[i + 2] = c; m[i + 3] = d;
      m[i + 4] = e; m[i + 5] = f; m[i + 6] = g; m[i + 7] = h;
    }
    if(s) {
      /* do a second pass to make all of the seed affect all of m[] */
      for(i = 0; i < 256; i += 8) {
        a = add(a, m[i + 0]); b = add(b, m[i + 1]);
        c = add(c, m[i + 2]); d = add(d, m[i + 3]);
        e = add(e, m[i + 4]); f = add(f, m[i + 5]);
        g = add(g, m[i + 6]); h = add(h, m[i + 7]);
        seed_mix();
        /* fill in m[] with messy stuff (again) */
        m[i + 0] = a; m[i + 1] = b; m[i + 2] = c; m[i + 3] = d;
        m[i + 4] = e; m[i + 5] = f; m[i + 6] = g; m[i + 7] = h;
      }
    }

    prng(); /* fill in the first set of results */
    gnt = 256;  /* prepare to use the first set of results */;
  }

  /* public: isaac generator, n = number of run */
  function prng(n){
    var i, x, y;

    n = (n && typeof(n) === 'number')
      ? Math.abs(Math.floor(n)) : 1;

    while(n--) {
      cnt = add(cnt,   1);
      brs = add(brs, cnt);

      for(i = 0; i < 256; i++) {
        switch(i & 3) {
          case 0: acc ^= acc <<  13; break;
          case 1: acc ^= acc >>>  6; break;
          case 2: acc ^= acc <<   2; break;
          case 3: acc ^= acc >>> 16; break;
        }
        acc        = add(m[(i +  128) & 0xff], acc); x = m[i];
        m[i] =   y = add(m[(x >>>  2) & 0xff], add(acc, brs));
        r[i] = brs = add(m[(y >>> 10) & 0xff], x);
      }
    }
  }

  /* public: return a random number between */
  function rand() {
    if(!gnt--) {
      prng(); gnt = 255;
    }
    return r[gnt];
  }

  /* public: return internals in an object*/
  function internals(){
    return {a: acc, b: brs, c: cnt, m: m, r: r};
  }

  /* return class object */
  return {
    'reset': reset,
    'seed':  seed,
    'prng':  prng,
    'rand':  rand,
    'internals': internals
  };
})(); /* declare and execute */

/* public: output*/
isaac.random = function() {
  return 0.5 + this.rand() * 2.3283064365386963e-10; // 2^-32
}
</script>

<!--color picker by Jan Odvarko. Edited so images are included, and to make it smaller. https://github.com/odvarko/JSColor-->
<script>
/**
 * jscolor, JavaScript Color Picker
 *
 * @version 1.4.4
 * @license GNU Lesser General Public License, http://www.gnu.org/copyleft/lesser.html
 * @author  Jan Odvarko, http://odvarko.cz
 * @created 2008-06-15
 * @updated 2014-12-09
 * @link    http://jscolor.com
 */


var jscolor = {


	dir : '', // location of jscolor directory (leave empty to autodetect)
	bindClass : 'color', // class name
	binding : true, // automatic binding via <input class="...">
	preloading : true, // use image preloading?


	install : function() {
		jscolor.addEvent(window, 'load', jscolor.init);
	},


	init : function() {
		if(jscolor.binding) {
			jscolor.bind();
		}
		if(jscolor.preloading) {
			jscolor.preload();
		}
	},


	bind : function() {
		var matchClass = new RegExp('(^|\\s)('+jscolor.bindClass+')(\\s*(\\{[^}]*\\})|\\s|$)', 'i');
		var e = document.getElementsByTagName('input');
		for(var i=0; i<e.length; i+=1) {
			if(jscolor.isColorAttrSupported && e[i].type.toLowerCase() == 'color') {
				// skip inputs of type 'color' if the browser supports this feature
				continue;
			}
			var m;
			if(!e[i].color && e[i].className && (m = e[i].className.match(matchClass))) {
				var prop = {};
				if(m[4]) {
					try {
						prop = (new Function ('return (' + m[4] + ')'))();
					} catch(eInvalidProp) {}
				}
				e[i].color = new jscolor.color(e[i], prop);
			}
		}
	},


	preload : function() {
		for(var fn in jscolor.imgRequire) {
			if(jscolor.imgRequire.hasOwnProperty(fn)) {
				jscolor.loadImage(fn);
			}
		}
	},


	images : {
		pad : [ 181, 101 ],
		sld : [ 16, 101 ],
		cross : [ 15, 15 ],
		arrow : [ 7, 11 ]
	},


	fetchElement : function(mixed) {
		return typeof mixed === 'string' ? document.getElementById(mixed) : mixed;
	},


	addEvent : function(el, evnt, func) {
		if(el.addEventListener) {
			el.addEventListener(evnt, func, false);
		} else if(el.attachEvent) {
			el.attachEvent('on'+evnt, func);
		}
	},


	fireEvent : function(el, evnt) {
		if(!el) {
			return;
		}
		if(document.createEvent) {
			var ev = document.createEvent('HTMLEvents');
			ev.initEvent(evnt, true, true);
			el.dispatchEvent(ev);
		} else if(document.createEventObject) {
			var ev = document.createEventObject();
			el.fireEvent('on'+evnt, ev);
		} else if(el['on'+evnt]) { // alternatively use the traditional event model (IE5)
			el['on'+evnt]();
		}
	},


	getElementPos : function(e) {
		var e1=e, e2=e;
		var x=0, y=0;
		if(e1.offsetParent) {
			do {
				x += e1.offsetLeft;
				y += e1.offsetTop;
			} while(e1 = e1.offsetParent);
		}
		while((e2 = e2.parentNode) && e2.nodeName.toUpperCase() !== 'BODY') {
			x -= e2.scrollLeft;
			y -= e2.scrollTop;
		}
		return [x, y];
	},


	getElementSize : function(e) {
		return [e.offsetWidth, e.offsetHeight];
	},


	getRelMousePos : function(e) {
		var x = 0, y = 0;
		if (!e) { e = window.event; }
		if (typeof e.offsetX === 'number') {
			x = e.offsetX;
			y = e.offsetY;
		} else if (typeof e.layerX === 'number') {
			x = e.layerX;
			y = e.layerY;
		}
		return { x: x, y: y };
	},


	getViewPos : function() {
		if(typeof window.pageYOffset === 'number') {
			return [window.pageXOffset, window.pageYOffset];
		} else if(document.body && (document.body.scrollLeft || document.body.scrollTop)) {
			return [document.body.scrollLeft, document.body.scrollTop];
		} else if(document.documentElement && (document.documentElement.scrollLeft || document.documentElement.scrollTop)) {
			return [document.documentElement.scrollLeft, document.documentElement.scrollTop];
		} else {
			return [0, 0];
		}
	},


	getViewSize : function() {
		if(typeof window.innerWidth === 'number') {
			return [window.innerWidth, window.innerHeight];
		} else if(document.body && (document.body.clientWidth || document.body.clientHeight)) {
			return [document.body.clientWidth, document.body.clientHeight];
		} else if(document.documentElement && (document.documentElement.clientWidth || document.documentElement.clientHeight)) {
			return [document.documentElement.clientWidth, document.documentElement.clientHeight];
		} else {
			return [0, 0];
		}
	},

	//
	// Usage example:
	// var myColor = new jscolor.color(myInputElement)
	//

	color : function(target, prop) {


		this.required = true; // refuse empty values?
		this.adjust = true; // adjust value to uniform notation?
		this.hash = false; // prefix color with # symbol?
		this.caps = true; // uppercase?
		this.slider = true; // show the value/saturation slider?
		this.valueElement = target; // value holder
		this.styleElement = target; // where to reflect current color
		this.onImmediateChange = null; // onchange callback (can be either string or function)
		this.hsv = [0, 0, 1]; // read-only  0-6, 0-1, 0-1
		this.rgb = [1, 1, 1]; // read-only  0-1, 0-1, 0-1
		this.minH = 0; // read-only  0-6
		this.maxH = 6; // read-only  0-6
		this.minS = 0; // read-only  0-1
		this.maxS = 1; // read-only  0-1
		this.minV = 0; // read-only  0-1
		this.maxV = 1; // read-only  0-1

		this.pickerOnfocus = true; // display picker on focus?
		this.pickerMode = 'HSV'; // HSV | HVS
		this.pickerPosition = 'bottom'; // left | right | top | bottom
		this.pickerSmartPosition = true; // automatically adjust picker position when necessary
		this.pickerButtonHeight = 20; // px
		this.pickerClosable = false;
		this.pickerCloseText = 'Close';
		this.pickerButtonColor = 'ButtonText'; // px
		this.pickerFace = 10; // px
		this.pickerFaceColor = 'ThreeDFace'; // CSS color
		this.pickerBorder = 1; // px
		this.pickerBorderColor = 'ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight'; // CSS color
		this.pickerInset = 1; // px
		this.pickerInsetColor = 'ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow'; // CSS color
		this.pickerZIndex = 10000;


		for(var p in prop) {
			if(prop.hasOwnProperty(p)) {
				this[p] = prop[p];
			}
		}


		this.hidePicker = function() {
			if(isPickerOwner()) {
				removePicker();
			}
		};


		this.showPicker = function() {
			if(!isPickerOwner()) {
				var tp = jscolor.getElementPos(target); // target pos
				var ts = jscolor.getElementSize(target); // target size
				var vp = jscolor.getViewPos(); // view pos
				var vs = jscolor.getViewSize(); // view size
				var ps = getPickerDims(this); // picker size
				var a, b, c;
				switch(this.pickerPosition.toLowerCase()) {
					case 'left': a=1; b=0; c=-1; break;
					case 'right':a=1; b=0; c=1; break;
					case 'top':  a=0; b=1; c=-1; break;
					default:     a=0; b=1; c=1; break;
				}
				var l = (ts[b]+ps[b])/2;

				// picker pos
				if (!this.pickerSmartPosition) {
					var pp = [
						tp[a],
						tp[b]+ts[b]-l+l*c
					];
				} else {
					var pp = [
						-vp[a]+tp[a]+ps[a] > vs[a] ?
							(-vp[a]+tp[a]+ts[a]/2 > vs[a]/2 && tp[a]+ts[a]-ps[a] >= 0 ? tp[a]+ts[a]-ps[a] : tp[a]) :
							tp[a],
						-vp[b]+tp[b]+ts[b]+ps[b]-l+l*c > vs[b] ?
							(-vp[b]+tp[b]+ts[b]/2 > vs[b]/2 && tp[b]+ts[b]-l-l*c >= 0 ? tp[b]+ts[b]-l-l*c : tp[b]+ts[b]-l+l*c) :
							(tp[b]+ts[b]-l+l*c >= 0 ? tp[b]+ts[b]-l+l*c : tp[b]+ts[b]-l-l*c)
					];
				}
				drawPicker(pp[a], pp[b]);
			}
		};


		this.importColor = function() {
			if(!valueElement) {
				this.exportColor();
			} else {
				if(!this.adjust) {
					if(!this.fromString(valueElement.value, leaveValue)) {
						styleElement.style.backgroundImage = styleElement.jscStyle.backgroundImage;
						styleElement.style.backgroundColor = styleElement.jscStyle.backgroundColor;
						styleElement.style.color = styleElement.jscStyle.color;
						this.exportColor(leaveValue | leaveStyle);
					}
				} else if(!this.required && /^\s*$/.test(valueElement.value)) {
					valueElement.value = '';
					styleElement.style.backgroundImage = styleElement.jscStyle.backgroundImage;
					styleElement.style.backgroundColor = styleElement.jscStyle.backgroundColor;
					styleElement.style.color = styleElement.jscStyle.color;
					this.exportColor(leaveValue | leaveStyle);

				} else if(this.fromString(valueElement.value)) {
					// OK
				} else {
					this.exportColor();
				}
			}
		};


		this.exportColor = function(flags) {
			if(!(flags & leaveValue) && valueElement) {
				var value = this.toString();
				if(this.caps) { value = value.toUpperCase(); }
				if(this.hash) { value = '#'+value; }
				valueElement.value = value;
			}
			if(!(flags & leaveStyle) && styleElement) {
				styleElement.style.backgroundImage = "none";
				styleElement.style.backgroundColor =
					'#'+this.toString();
				styleElement.style.color =
					0.213 * this.rgb[0] +
					0.715 * this.rgb[1] +
					0.072 * this.rgb[2]
					< 0.5 ? '#FFF' : '#000';
			}
			if(!(flags & leavePad) && isPickerOwner()) {
				redrawPad();
			}
			if(!(flags & leaveSld) && isPickerOwner()) {
				redrawSld();
			}
		};


		this.fromHSV = function(h, s, v, flags) { // null = don't change
			if(h !== null) { h = Math.max(0.0, this.minH, Math.min(6.0, this.maxH, h)); }
			if(s !== null) { s = Math.max(0.0, this.minS, Math.min(1.0, this.maxS, s)); }
			if(v !== null) { v = Math.max(0.0, this.minV, Math.min(1.0, this.maxV, v)); }

			this.rgb = HSV_RGB(
				h===null ? this.hsv[0] : (this.hsv[0]=h),
				s===null ? this.hsv[1] : (this.hsv[1]=s),
				v===null ? this.hsv[2] : (this.hsv[2]=v)
			);

			this.exportColor(flags);
		};


		this.fromRGB = function(r, g, b, flags) { // null = don't change
			if(r !== null) { r = Math.max(0.0, Math.min(1.0, r)); }
			if(g !== null) { g = Math.max(0.0, Math.min(1.0, g)); }
			if(b !== null) { b = Math.max(0.0, Math.min(1.0, b)); }

			var hsv = RGB_HSV(
				r===null ? this.rgb[0] : r,
				g===null ? this.rgb[1] : g,
				b===null ? this.rgb[2] : b
			);
			if(hsv[0] !== null) {
				this.hsv[0] = Math.max(0.0, this.minH, Math.min(6.0, this.maxH, hsv[0]));
			}
			if(hsv[2] !== 0) {
				this.hsv[1] = hsv[1]===null ? null : Math.max(0.0, this.minS, Math.min(1.0, this.maxS, hsv[1]));
			}
			this.hsv[2] = hsv[2]===null ? null : Math.max(0.0, this.minV, Math.min(1.0, this.maxV, hsv[2]));

			// update RGB according to final HSV, as some values might be trimmed
			var rgb = HSV_RGB(this.hsv[0], this.hsv[1], this.hsv[2]);
			this.rgb[0] = rgb[0];
			this.rgb[1] = rgb[1];
			this.rgb[2] = rgb[2];

			this.exportColor(flags);
		};


		this.fromString = function(hex, flags) {
			var m = hex.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);
			if(!m) {
				return false;
			} else {
				if(m[1].length === 6) { // 6-char notation
					this.fromRGB(
						parseInt(m[1].substr(0,2),16) / 255,
						parseInt(m[1].substr(2,2),16) / 255,
						parseInt(m[1].substr(4,2),16) / 255,
						flags
					);
				} else { // 3-char notation
					this.fromRGB(
						parseInt(m[1].charAt(0)+m[1].charAt(0),16) / 255,
						parseInt(m[1].charAt(1)+m[1].charAt(1),16) / 255,
						parseInt(m[1].charAt(2)+m[1].charAt(2),16) / 255,
						flags
					);
				}
				return true;
			}
		};


		this.toString = function() {
			return (
				(0x100 | Math.round(255*this.rgb[0])).toString(16).substr(1) +
				(0x100 | Math.round(255*this.rgb[1])).toString(16).substr(1) +
				(0x100 | Math.round(255*this.rgb[2])).toString(16).substr(1)
			);
		};


		function RGB_HSV(r, g, b) {
			var n = Math.min(Math.min(r,g),b);
			var v = Math.max(Math.max(r,g),b);
			var m = v - n;
			if(m === 0) { return [ null, 0, v ]; }
			var h = r===n ? 3+(b-g)/m : (g===n ? 5+(r-b)/m : 1+(g-r)/m);
			return [ h===6?0:h, m/v, v ];
		}


		function HSV_RGB(h, s, v) {
			if(h === null) { return [ v, v, v ]; }
			var i = Math.floor(h);
			var f = i%2 ? h-i : 1-(h-i);
			var m = v * (1 - s);
			var n = v * (1 - s*f);
			switch(i) {
				case 6:
				case 0: return [v,n,m];
				case 1: return [n,v,m];
				case 2: return [m,v,n];
				case 3: return [m,n,v];
				case 4: return [n,m,v];
				case 5: return [v,m,n];
			}
		}


		function removePicker() {
			delete jscolor.picker.owner;
			document.getElementsByTagName('body')[0].removeChild(jscolor.picker.boxB);
		}


		function drawPicker(x, y) {
			if(!jscolor.picker) {
				jscolor.picker = {
					box : document.createElement('div'),
					boxB : document.createElement('div'),
					pad : document.createElement('div'),
					padB : document.createElement('div'),
					padM : document.createElement('div'),
					sld : document.createElement('div'),
					sldB : document.createElement('div'),
					sldM : document.createElement('div'),
					btn : document.createElement('div'),
					btnS : document.createElement('span'),
					btnT : document.createTextNode(THIS.pickerCloseText)
				};
				for(var i=0,segSize=4; i<jscolor.images.sld[1]; i+=segSize) {
					var seg = document.createElement('div');
					seg.style.height = segSize+'px';
					seg.style.fontSize = '1px';
					seg.style.lineHeight = '0';
					jscolor.picker.sld.appendChild(seg);
				}
				jscolor.picker.sldB.appendChild(jscolor.picker.sld);
				jscolor.picker.box.appendChild(jscolor.picker.sldB);
				jscolor.picker.box.appendChild(jscolor.picker.sldM);
				jscolor.picker.padB.appendChild(jscolor.picker.pad);
				jscolor.picker.box.appendChild(jscolor.picker.padB);
				jscolor.picker.box.appendChild(jscolor.picker.padM);
				jscolor.picker.btnS.appendChild(jscolor.picker.btnT);
				jscolor.picker.btn.appendChild(jscolor.picker.btnS);
				jscolor.picker.box.appendChild(jscolor.picker.btn);
				jscolor.picker.boxB.appendChild(jscolor.picker.box);
			}

			var p = jscolor.picker;

			// controls interaction
			p.box.onmouseup =
			p.box.onmouseout = function() { target.focus(); };
			p.box.onmousedown = function() { abortBlur=true; };
			p.box.onmousemove = function(e) {
				if (holdPad || holdSld) {
					holdPad && setPad(e);
					holdSld && setSld(e);
					if (document.selection) {
						document.selection.empty();
					} else if (window.getSelection) {
						window.getSelection().removeAllRanges();
					}
					dispatchImmediateChange();
				}
			};
			if('ontouchstart' in window) { // if touch device
				var handle_touchmove = function(e) {
					var event={
						'offsetX': e.touches[0].pageX-touchOffset.X,
						'offsetY': e.touches[0].pageY-touchOffset.Y
					};
					if (holdPad || holdSld) {
						holdPad && setPad(event);
						holdSld && setSld(event);
						dispatchImmediateChange();
					}
					e.stopPropagation(); // prevent move "view" on browser
					e.preventDefault(); // prevent Default - Android Fix (else android generated only 1-2 touchmove events)
				};
				p.box.removeEventListener('touchmove', handle_touchmove, false)
				p.box.addEventListener('touchmove', handle_touchmove, false)
			}
			p.padM.onmouseup =
			p.padM.onmouseout = function() { if(holdPad) { holdPad=false; jscolor.fireEvent(valueElement,'change'); } };
			p.padM.onmousedown = function(e) {
				// if the slider is at the bottom, move it up
				switch(modeID) {
					case 0: if (THIS.hsv[2] === 0) { THIS.fromHSV(null, null, 1.0); }; break;
					case 1: if (THIS.hsv[1] === 0) { THIS.fromHSV(null, 1.0, null); }; break;
				}
				holdSld=false;
				holdPad=true;
				setPad(e);
				dispatchImmediateChange();
			};
			if('ontouchstart' in window) {
				p.padM.addEventListener('touchstart', function(e) {
					touchOffset={
						'X': e.target.offsetParent.offsetLeft,
						'Y': e.target.offsetParent.offsetTop
					};
					this.onmousedown({
						'offsetX':e.touches[0].pageX-touchOffset.X,
						'offsetY':e.touches[0].pageY-touchOffset.Y
					});
				});
			}
			p.sldM.onmouseup =
			p.sldM.onmouseout = function() { if(holdSld) { holdSld=false; jscolor.fireEvent(valueElement,'change'); } };
			p.sldM.onmousedown = function(e) {
				holdPad=false;
				holdSld=true;
				setSld(e);
				dispatchImmediateChange();
			};
			if('ontouchstart' in window) {
				p.sldM.addEventListener('touchstart', function(e) {
					touchOffset={
						'X': e.target.offsetParent.offsetLeft,
						'Y': e.target.offsetParent.offsetTop
					};
					this.onmousedown({
						'offsetX':e.touches[0].pageX-touchOffset.X,
						'offsetY':e.touches[0].pageY-touchOffset.Y
					});
				});
			}

			// picker
			var dims = getPickerDims(THIS);
			p.box.style.width = dims[0] + 'px';
			p.box.style.height = dims[1] + 'px';

			// picker border
			p.boxB.style.position = 'absolute';
			p.boxB.style.clear = 'both';
			p.boxB.style.left = x+'px';
			p.boxB.style.top = y+'px';
			p.boxB.style.zIndex = THIS.pickerZIndex;
			p.boxB.style.border = THIS.pickerBorder+'px solid';
			p.boxB.style.borderColor = THIS.pickerBorderColor;
			p.boxB.style.background = THIS.pickerFaceColor;

			// pad image
			p.pad.style.width = jscolor.images.pad[0]+'px';
			p.pad.style.height = jscolor.images.pad[1]+'px';

			// pad border
			p.padB.style.position = 'absolute';
			p.padB.style.left = THIS.pickerFace+'px';
			p.padB.style.top = THIS.pickerFace+'px';
			p.padB.style.border = THIS.pickerInset+'px solid';
			p.padB.style.borderColor = THIS.pickerInsetColor;

			// pad mouse area
			p.padM.style.position = 'absolute';
			p.padM.style.left = '0';
			p.padM.style.top = '0';
			p.padM.style.width = THIS.pickerFace + 2*THIS.pickerInset + jscolor.images.pad[0] + jscolor.images.arrow[0] + 'px';
			p.padM.style.height = p.box.style.height;
			p.padM.style.cursor = 'crosshair';

			// slider image
			p.sld.style.overflow = 'hidden';
			p.sld.style.width = jscolor.images.sld[0]+'px';
			p.sld.style.height = jscolor.images.sld[1]+'px';

			// slider border
			p.sldB.style.display = THIS.slider ? 'block' : 'none';
			p.sldB.style.position = 'absolute';
			p.sldB.style.right = THIS.pickerFace+'px';
			p.sldB.style.top = THIS.pickerFace+'px';
			p.sldB.style.border = THIS.pickerInset+'px solid';
			p.sldB.style.borderColor = THIS.pickerInsetColor;

			// slider mouse area
			p.sldM.style.display = THIS.slider ? 'block' : 'none';
			p.sldM.style.position = 'absolute';
			p.sldM.style.right = '0';
			p.sldM.style.top = '0';
			p.sldM.style.width = jscolor.images.sld[0] + jscolor.images.arrow[0] + THIS.pickerFace + 2*THIS.pickerInset + 'px';
			p.sldM.style.height = p.box.style.height;
			try {
				p.sldM.style.cursor = 'pointer';
			} catch(eOldIE) {
				p.sldM.style.cursor = 'hand';
			}

			// "close" button
			function setBtnBorder() {
				var insetColors = THIS.pickerInsetColor.split(/\s+/);
				var pickerOutsetColor = insetColors.length < 2 ? insetColors[0] : insetColors[1] + ' ' + insetColors[0] + ' ' + insetColors[0] + ' ' + insetColors[1];
				p.btn.style.borderColor = pickerOutsetColor;
			}

			//images
			p.padM.style.backgroundImage = "url(data:image/gif;base64,R0lGODlhDwAPAKEBAAAAAP///////////yH5BAEKAAIALAAAAAAPAA8AAAIklB8Qx53b4otSUWcvyiz4/4AeQJbmKY4p1HHapBlwPL/uVRsFADs=)"; //edited by F. Ruiz, as well as the next two images
			p.padM.style.backgroundRepeat = "no-repeat";
			p.sldM.style.backgroundImage = "url(data:image/gif;base64,R0lGODlhBwALAKECAAAAAP///6g8eKg8eCH5BAEKAAIALAAAAAAHAAsAAAITTIQYcLnsgGxvijrxqdQq6DRJAQA7)";							//image 2 added
			p.sldM.style.backgroundRepeat = "no-repeat";
			p.pad.style.backgroundImage = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALUAAABlCAIAAACEDzXRAAAKQ0lEQVR42u2d23IjKwxFBeRh5v8/9uQlzXlI2gGELoCEm6pxubp6PI69WoV3C20uIQPAH4A/AH/p41/pDcTxP4BPGDtq3vYJGPpv8craeRdo/fyTI8ZhHnodOGgcV/3rnx8QI0SABO2xfAbiCfVR8Wj+CD8jenbRJNyGOxLoAaH1iLu4EUEHAv1+MsQ4zLE4AiIOcpibv4u9OET6+cP4ASnJ1JH4/G60A9km+GbBxLlpKAkADoR2JnaBrvWD/x1GCZn9EYLEHqVfI6Efx0D7E9tDF/rBSJ54l8FqTUse0J+EvxPrdK0fD4aOLXQi7zyGxMaRvvWjjH2U8o9I44OKnf+wyCpHoR/Phk6d/COq8481YrNI3/qR2B+kMl1Fl6J8o/JrU/GEA6HdiB2ha/0YBVx7rFwNHAj9JuIl6EI/qKyJug4Yvg7xA0QEpB8nQe8itoQu9EOT8M3mTsqUSUzykH6cBO1PbA9d91+ShDzV9xrtcgW21IT6L0yfcS90FKCdw+wS6Q9ISWjVfLTVVT2mdiPGGRduFKWm7dBStWlLmI0j/QExdgp7gT5qCu2BLKiLqtc94hI7PB8auQP4KuyIvSJ960fUqXWcd2F48Khr1bHSj2dDp/afmg7tMrFxpG/9mHMFuqrH3spFw0s0Bgr9OAzamdgFutaPpMuqo6WVEXWJdSL14xhof2J76MKfS2yXWGOVB1WXXGOVdxFSx587CXoLsTE0689RH7VW4RMLeKI9wPpzz4XeS2wDzdbXR52AWStjwiSAA6HdiB2h1f6cqT0whzzuzz0LejuxATTy90Xt40v7CzdGRvKS4O/zQ0AiXaRW5x/dv4vS4A/a308LYR5pFquRRvlHIrKWoCj5woCVId4eR/KPNDjURg2tdEC7rSQN5B9DYR70X5YivVxft7AyrOvrD4V2JnaBJurr+qpemLEywlRhT6qvPx16C7ExdK0fSjcj0maAzsqgBt7rfIxGP46B9iT2gi70I842bNj0U4wd/WAG/L5VP3p0W4iNoYv6Oh6eoJmSMW5laIzF8iT1TtgeV9RZoZ7QvdEUzsQu0CP+HOMKDFoZvDFg6s89CNqf2B5a4e8Hts84W0pgeohBtspBXYp8H3Tk/H23MBtHuvbn5mp7dlU9TUkP+XNJMabzHdCIbnuYDSItzZ+bdgUWrAwNPhwInRxw1/wXuYGj+4vo7flboRpjEQ6EjgojYK9/K04NFfNTauEBypXQWQLAfqQoHl9CfvpQ6C3ExtC9/q2YW2u6X1JWzfsYFPKX3L99LrQ/sT10XR+jKh+UN2AxlDOyXfLQaxxf/fkvT4d2JnaBZv258M6h4IFu2Em7/sezoLcQG0Mjfy6xrqLnVBLGWHw1i69WP5LCCn0TNEL3DLNXpCV/n5oo5jAVLY5Em6i8Pwm6uSNuCrNxpNX+nDira20qqyZriv384xhoZ2IX6Lr/wg8eiwpXYGQqPEgjsBrX+er3X46B9ie2h6bX/4i6IfcLS2mIY++7TfoCuLj6hwgN89CwBJ3Gx8rOVsn0kQ48tDS/4X1L8SzMb3BbkGdtwsD05AbP9YOU8xui+uljZei/P/3qx2HQbsSO0Ar/lveHLZYCVK4GeN1P5N+eAb2R2Aya9ueUY+8dlhLtdhWvgfEfz4AeGf9hR2wcaeTPpacvRdzLTx8J/Qq1Ij995PrJ3/mp0p8LO5YyF0s215g/9yxoZ2IXaLo+FiwtgTlvIAznp4+G3khsBk3Pf5mYvqOwMqZnNnw3i9cRDoT2JPaCZuvreskDuXkHxfQMvfbBgdBbiI2hC/3QLCg6lESZZkrfJ7nSj3gWNEMcRkYJsf5L0BXENBl1WV8/aquMLM9/eSJ0UtxZmFGGg4MigZ75ovHnvsOcUX09zRbzjCrU/K/Rev0gT2i2vu4cZrNI1+sH2e49Yb3lRC6e9fSS9ETohjj7hdkx0rQ/57/rxIrhBQdCv494Hlrtz1lo30Qjz1z+cRh02ndTNIMm1j8NxtmePs+76i+/esJHrH/6dGh/YntoRf9l2RtQWgJXzY4bdtbqx0OhnYldoHv7I79jf4+rOGGaRWr14yToLcTG0Ky/v32rjAsdX9S5vgI4ENqT2Asa7Z/9vq0yStiGNNVHkOe/RGmqwBQ0jEDHFpoJ85BLN+jPaRoHGWl2/2yx3msxVRHjZ0Td4GfV/Bf9bCM1dBiBfrHeJ1HR6dKEedDf5yPdBLilp/efC3Ribb1VxlUHGQe8iTb0598+Hdqf2B6a3b9SOerezsoIBWaJ3IBn1fp0j4PeQmwMzc5/idLK3UZWRkmKX2zA4Vc/DoPeSGwGrdvfY24RpKmVjrLuCQdCuxE7Qkv64TZ3Z44dVPrxUOh3EK9C1/lHGpz7ZzpVsYTF7K8Hyj+Ogd5FbAk9uL9H9LIyYg821sjo13gYtD+xPbRU/9Ds/b1sZTTIr5OStMGHA6GdiV2gUf2UmQcfJdUbXOoe6HoN1A0b2uQD4EBosXJqQTwKnXvXAEX+oZlfGaS9ewetDGCLeV1exH4e9Mr+2TDpv2iggYFW+LdBsTbngv/yUroGH0jleEX7MOgtxMbQ7PzKoMuajKyM8pYIiB194HnQzsQu0Gp/LvpulVHylsgK/TgG2p/YHrqXf6T3bJUBhfxFWUDPg95CbAytm/+ycasM9WOxWu0PnTniLWE2iLRi/4Z3bJXRvY76s0+Arl93I3aMNOHPBce2PdSkL7Kpnwe9l9gGutCPoFgkUtytXAGbex0vKCznSOs00o+ToLcQG0N/QErCrG6jrTIynVUDwo896vCzssPrNnAYtD+xPfR9fwmKeu/CVhm5OAn1STPkvhxBW1KXjeP60Y/DoJ2JXaAL/RCPy+PXc80L9d7OV294dVPbC/fb4EDoLcTG0IV+TCDrrIxMHIFg512BWj9OgvYk9oK+9SMoZG55q/JMiGS40/sLjacu28T3MVfd0Aha+u3QJXr+0Q//MBtHutaPQOzh3H0RBoZS5OJ/MjqJ9x2vQb7qgSuvX0StH0+FLptzrvTDh9gl0oV+iAbi2lAsqNmbK3yBAyLNdbRzW8Y6Btqf2B76A2IURE2zZY16KGfZlwqofJSL4feABka+xCNX+ekx0LuILaFr/Zit7s4ZA7y5Qg2sDr/t4zDodxCvQt/6occctDKGriMPzH85D9qN2BG61g/QwcLSVDSGl78C6LePY6A3EptBf0BKcjWWH/GqyJqoxKnMufEVBLJxAJwJ7U9sDH3fX0CxnIB4orMyuilTyRh6g+0bfDgQ2p/YHrrQD+jV6qb/SdRrMit8TRWwyEabxgFwJrQnsQt0rR+LR3VqFNiGHRBv73ge9EZiM+haPyicuRcVmIxzAMTMl9wfi3sGtBuxF3ShH92C29yJTteU+ohbRrZk3Qe9hdgY+tYPnOqanA+mTN33ZGKE06HQbsQu0LV+MF8+94rU5dK8B8/KyJaI+6D9ie2hC/3Q12QnSnYLn5p9P/6d0D7EltAh5wz/Hv8exON/LUjHOuz5CksAAAAASUVORK5CYII=)";	//image 3
			p.pad.style.backgroundRepeat = "no-repeat";
			p.pad.style.backgroundPosition = "0 0";

			// place pointers
			redrawPad();
			redrawSld();

			jscolor.picker.owner = THIS;
			document.getElementsByTagName('body')[0].appendChild(p.boxB);
		}


		function getPickerDims(o) {
			var dims = [
				2*o.pickerInset + 2*o.pickerFace + jscolor.images.pad[0] +
					(o.slider ? 2*o.pickerInset + 2*jscolor.images.arrow[0] + jscolor.images.sld[0] : 0),
				o.pickerClosable ?
					4*o.pickerInset + 3*o.pickerFace + jscolor.images.pad[1] + o.pickerButtonHeight :
					2*o.pickerInset + 2*o.pickerFace + jscolor.images.pad[1]
			];
			return dims;
		}


		function redrawPad() {
			// redraw the pad pointer
			switch(modeID) {
				case 0: var yComponent = 1; break;
				case 1: var yComponent = 2; break;
			}
			var x = Math.round((THIS.hsv[0]/6) * (jscolor.images.pad[0]-1));
			var y = Math.round((1-THIS.hsv[yComponent]) * (jscolor.images.pad[1]-1));
			jscolor.picker.padM.style.backgroundPosition =
				(THIS.pickerFace+THIS.pickerInset+x - Math.floor(jscolor.images.cross[0]/2)) + 'px ' +
				(THIS.pickerFace+THIS.pickerInset+y - Math.floor(jscolor.images.cross[1]/2)) + 'px';

			// redraw the slider image
			var seg = jscolor.picker.sld.childNodes;

			switch(modeID) {
				case 0:
					var rgb = HSV_RGB(THIS.hsv[0], THIS.hsv[1], 1);
					for(var i=0; i<seg.length; i+=1) {
						seg[i].style.backgroundColor = 'rgb('+
							(rgb[0]*(1-i/seg.length)*100)+'%,'+
							(rgb[1]*(1-i/seg.length)*100)+'%,'+
							(rgb[2]*(1-i/seg.length)*100)+'%)';
					}
					break;
				case 1:
					var rgb, s, c = [ THIS.hsv[2], 0, 0 ];
					var i = Math.floor(THIS.hsv[0]);
					var f = i%2 ? THIS.hsv[0]-i : 1-(THIS.hsv[0]-i);
					switch(i) {
						case 6:
						case 0: rgb=[0,1,2]; break;
						case 1: rgb=[1,0,2]; break;
						case 2: rgb=[2,0,1]; break;
						case 3: rgb=[2,1,0]; break;
						case 4: rgb=[1,2,0]; break;
						case 5: rgb=[0,2,1]; break;
					}
					for(var i=0; i<seg.length; i+=1) {
						s = 1 - 1/(seg.length-1)*i;
						c[1] = c[0] * (1 - s*f);
						c[2] = c[0] * (1 - s);
						seg[i].style.backgroundColor = 'rgb('+
							(c[rgb[0]]*100)+'%,'+
							(c[rgb[1]]*100)+'%,'+
							(c[rgb[2]]*100)+'%)';
					}
					break;
			}
		}


		function redrawSld() {
			// redraw the slider pointer
			switch(modeID) {
				case 0: var yComponent = 2; break;
				case 1: var yComponent = 1; break;
			}
			var y = Math.round((1-THIS.hsv[yComponent]) * (jscolor.images.sld[1]-1));
			jscolor.picker.sldM.style.backgroundPosition =
				'0 ' + (THIS.pickerFace+THIS.pickerInset+y - Math.floor(jscolor.images.arrow[1]/2)) + 'px';
		}


		function isPickerOwner() {
			return jscolor.picker && jscolor.picker.owner === THIS;
		}


		function blurTarget() {
			if(valueElement === target) {
				THIS.importColor();
			}
			if(THIS.pickerOnfocus) {
				THIS.hidePicker();
			}
		}


		function blurValue() {
			if(valueElement !== target) {
				THIS.importColor();
			}
		}


		function setPad(e) {
			var mpos = jscolor.getRelMousePos(e);
			var x = mpos.x - THIS.pickerFace - THIS.pickerInset;
			var y = mpos.y - THIS.pickerFace - THIS.pickerInset;
			switch(modeID) {
				case 0: THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)), 1 - y/(jscolor.images.pad[1]-1), null, leaveSld); break;
				case 1: THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)), null, 1 - y/(jscolor.images.pad[1]-1), leaveSld); break;
			}
		}


		function setSld(e) {
			var mpos = jscolor.getRelMousePos(e);
			var y = mpos.y - THIS.pickerFace - THIS.pickerInset;
			switch(modeID) {
				case 0: THIS.fromHSV(null, null, 1 - y/(jscolor.images.sld[1]-1), leavePad); break;
				case 1: THIS.fromHSV(null, 1 - y/(jscolor.images.sld[1]-1), null, leavePad); break;
			}
		}


		function dispatchImmediateChange() {
			if (THIS.onImmediateChange) {
				var callback;
				if (typeof THIS.onImmediateChange === 'string') {
					callback = new Function (THIS.onImmediateChange);
				} else {
					callback = THIS.onImmediateChange;
				}
				callback.call(THIS);
			}
		}


		var THIS = this;
		var modeID = this.pickerMode.toLowerCase()==='hvs' ? 1 : 0;
		var abortBlur = false;
		var
			valueElement = jscolor.fetchElement(this.valueElement),
			styleElement = jscolor.fetchElement(this.styleElement);
		var
			holdPad = false,
			holdSld = false,
			touchOffset = {};
		var
			leaveValue = 1<<0,
			leaveStyle = 1<<1,
			leavePad = 1<<2,
			leaveSld = 1<<3;

		jscolor.isColorAttrSupported = false;
		var el = document.createElement('input');
		if(el.setAttribute) {
			el.setAttribute('type', 'color');
			if(el.type.toLowerCase() == 'color') {
				jscolor.isColorAttrSupported = true;
			}
		}

		// target
		jscolor.addEvent(target, 'focus', function() {
			if(THIS.pickerOnfocus) { THIS.showPicker(); }
		});
		jscolor.addEvent(target, 'blur', function() {
			if(!abortBlur) {
				window.setTimeout(function(){ abortBlur || blurTarget(); abortBlur=false; }, 0);
			} else {
				abortBlur = false;
			}
		});

		// valueElement
		if(valueElement) {
			var updateField = function() {
				THIS.fromString(valueElement.value, leaveValue);
				dispatchImmediateChange();
			};
			jscolor.addEvent(valueElement, 'keyup', updateField);
			jscolor.addEvent(valueElement, 'input', updateField);
			jscolor.addEvent(valueElement, 'blur', blurValue);
			valueElement.setAttribute('autocomplete', 'off');
		}

		// styleElement
		if(styleElement) {
			styleElement.jscStyle = {
				backgroundImage : styleElement.style.backgroundImage,
				backgroundColor : styleElement.style.backgroundColor,
				color : styleElement.style.color
			};
		}

		this.importColor();
	}

};

jscolor.install();
</script>

<!--this used to be in TweetNaCl, but they dropped it-->
<script>
// taken from an old version of TweetNaCl, which dropped this code eventually

nacl.util = {};

nacl.util.decodeUTF8 = function(s) {
  var i, d = unescape(encodeURIComponent(s)), b = new Uint8Array(d.length);
  for (i = 0; i < d.length; i++) b[i] = d.charCodeAt(i);
  return b;
};

nacl.util.encodeUTF8 = function(arr) {
  var i, s = [];
  for (i = 0; i < arr.length; i++) s.push(String.fromCharCode(arr[i]));
  return decodeURIComponent(escape(s.join('')));
};

nacl.util.encodeBase64 = function(arr) {
  if (typeof btoa === 'undefined') {
    return (new Buffer(arr)).toString('base64');
  } else {
    var i, s = [], len = arr.length;
    for (i = 0; i < len; i++) s.push(String.fromCharCode(arr[i]));
    return btoa(s.join(''));
  }
};

nacl.util.decodeBase64 = function(s) {
  if (typeof atob === 'undefined') {
    return new Uint8Array(Array.prototype.slice.call(new Buffer(s, 'base64'), 0));
  } else {
	  try{															//added for PassLok because atob may fail
    var i, d = atob(s), b = new Uint8Array(d.length);
	  }catch(error){
		  return false
	  }
    for (i = 0; i < d.length; i++) b[i] = d.charCodeAt(i);
    return b;
  }
};
</script>

<!--QRcode.js by David Shim. https://github.com/davidshimjs/qrcodejs-->
<script>
/**   QRCODE.js  by David Shim begins */
var QRCode;

(function () {
		//---------------------------------------------------------------------
		// QRCode for JavaScript
		//
		// Copyright (c) 2009 Kazuhiko Arase
		//
		// URL: http://www.d-project.com/
		//
		// Licensed under the MIT license:
		//   http://www.opensource.org/licenses/mit-license.php
		//
		// The word "QR Code" is registered trademark of 
		// DENSO WAVE INCORPORATED
		//   http://www.denso-wave.com/qrcode/faqpatent-e.html
		//
		//---------------------------------------------------------------------
		function QR8bitByte(data) {
			this.mode = QRMode.MODE_8BIT_BYTE;
			this.data = data;
		}
		QR8bitByte.prototype = {
			getLength: function (buffer) {
				return this.data.length;
			},
			write: function (buffer) {
				for (var i = 0; i < this.data.length; i++) {
					buffer.put(this.data.charCodeAt(i), 8);
				}
			}
		};

		function QRCodeModel(typeNumber, errorCorrectLevel) {
			this.typeNumber = typeNumber;
			this.errorCorrectLevel = errorCorrectLevel;
			this.modules = null;
			this.moduleCount = 0;
			this.dataCache = null;
			this.dataList = [];
		}
		QRCodeModel.prototype = {
			addData: function (data) {
				var newData = new QR8bitByte(data);
				this.dataList.push(newData);
				this.dataCache = null;
			},
			isDark: function (row, col) {
				if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) {
					throw new Error(row + "," + col);
				}
				return this.modules[row][col];
			},
			getModuleCount: function () {
				return this.moduleCount;
			},
			make: function () {
				this.makeImpl(false, this.getBestMaskPattern());
			},
			makeImpl: function (test, maskPattern) {
				this.moduleCount = this.typeNumber * 4 + 17;
				this.modules = new Array(this.moduleCount);
				for (var row = 0; row < this.moduleCount; row++) {
					this.modules[row] = new Array(this.moduleCount);
					for (var col = 0; col < this.moduleCount; col++) {
						this.modules[row][col] = null;
					}
				}
				this.setupPositionProbePattern(0, 0);
				this.setupPositionProbePattern(this.moduleCount - 7, 0);
				this.setupPositionProbePattern(0, this.moduleCount - 7);
				this.setupPositionAdjustPattern();
				this.setupTimingPattern();
				this.setupTypeInfo(test, maskPattern);
				if (this.typeNumber >= 7) {
					this.setupTypeNumber(test);
				}
				if (this.dataCache == null) {
					this.dataCache = QRCodeModel.createData(this.typeNumber, this.errorCorrectLevel, this.dataList);
				}
				this.mapData(this.dataCache, maskPattern);
			},
			setupPositionProbePattern: function (row, col) {
				for (var r = -1; r <= 7; r++) {
					if (row + r <= -1 || this.moduleCount <= row + r) continue;
					for (var c = -1; c <= 7; c++) {
						if (col + c <= -1 || this.moduleCount <= col + c) continue;
						if ((0 <= r && r <= 6 && (c == 0 || c == 6)) || (0 <= c && c <= 6 && (r == 0 || r == 6)) || (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
							this.modules[row + r][col + c] = true;
						} else {
							this.modules[row + r][col + c] = false;
						}
					}
				}
			},
			getBestMaskPattern: function () {
				var minLostPoint = 0;
				var pattern = 0;
				for (var i = 0; i < 8; i++) {
					this.makeImpl(true, i);
					var lostPoint = QRUtil.getLostPoint(this);
					if (i == 0 || minLostPoint > lostPoint) {
						minLostPoint = lostPoint;
						pattern = i;
					}
				}
				return pattern;
			},
			createMovieClip: function (target_mc, instance_name, depth) {
				var qr_mc = target_mc.createEmptyMovieClip(instance_name, depth);
				var cs = 1;
				this.make();
				for (var row = 0; row < this.modules.length; row++) {
					var y = row * cs;
					for (var col = 0; col < this.modules[row].length; col++) {
						var x = col * cs;
						var dark = this.modules[row][col];
						if (dark) {
							qr_mc.beginFill(0, 100);
							qr_mc.moveTo(x, y);
							qr_mc.lineTo(x + cs, y);
							qr_mc.lineTo(x + cs, y + cs);
							qr_mc.lineTo(x, y + cs);
							qr_mc.endFill();
						}
					}
				}
				return qr_mc;
			},
			setupTimingPattern: function () {
				for (var r = 8; r < this.moduleCount - 8; r++) {
					if (this.modules[r][6] != null) {
						continue;
					}
					this.modules[r][6] = (r % 2 == 0);
				}
				for (var c = 8; c < this.moduleCount - 8; c++) {
					if (this.modules[6][c] != null) {
						continue;
					}
					this.modules[6][c] = (c % 2 == 0);
				}
			},
			setupPositionAdjustPattern: function () {
				var pos = QRUtil.getPatternPosition(this.typeNumber);
				for (var i = 0; i < pos.length; i++) {
					for (var j = 0; j < pos.length; j++) {
						var row = pos[i];
						var col = pos[j];
						if (this.modules[row][col] != null) {
							continue;
						}
						for (var r = -2; r <= 2; r++) {
							for (var c = -2; c <= 2; c++) {
								if (r == -2 || r == 2 || c == -2 || c == 2 || (r == 0 && c == 0)) {
									this.modules[row + r][col + c] = true;
								} else {
									this.modules[row + r][col + c] = false;
								}
							}
						}
					}
				}
			},
			setupTypeNumber: function (test) {
				var bits = QRUtil.getBCHTypeNumber(this.typeNumber);
				for (var i = 0; i < 18; i++) {
					var mod = (!test && ((bits >> i) & 1) == 1);
					this.modules[Math.floor(i / 3)][i % 3 + this.moduleCount - 8 - 3] = mod;
				}
				for (var i = 0; i < 18; i++) {
					var mod = (!test && ((bits >> i) & 1) == 1);
					this.modules[i % 3 + this.moduleCount - 8 - 3][Math.floor(i / 3)] = mod;
				}
			},
			setupTypeInfo: function (test, maskPattern) {
				var data = (this.errorCorrectLevel << 3) | maskPattern;
				var bits = QRUtil.getBCHTypeInfo(data);
				for (var i = 0; i < 15; i++) {
					var mod = (!test && ((bits >> i) & 1) == 1);
					if (i < 6) {
						this.modules[i][8] = mod;
					} else if (i < 8) {
						this.modules[i + 1][8] = mod;
					} else {
						this.modules[this.moduleCount - 15 + i][8] = mod;
					}
				}
				for (var i = 0; i < 15; i++) {
					var mod = (!test && ((bits >> i) & 1) == 1);
					if (i < 8) {
						this.modules[8][this.moduleCount - i - 1] = mod;
					} else if (i < 9) {
						this.modules[8][15 - i - 1 + 1] = mod;
					} else {
						this.modules[8][15 - i - 1] = mod;
					}
				}
				this.modules[this.moduleCount - 8][8] = (!test);
			},
			mapData: function (data, maskPattern) {
				var inc = -1;
				var row = this.moduleCount - 1;
				var bitIndex = 7;
				var byteIndex = 0;
				for (var col = this.moduleCount - 1; col > 0; col -= 2) {
					if (col == 6) col--;
					while (true) {
						for (var c = 0; c < 2; c++) {
							if (this.modules[row][col - c] == null) {
								var dark = false;
								if (byteIndex < data.length) {
									dark = (((data[byteIndex] >>> bitIndex) & 1) == 1);
								}
								var mask = QRUtil.getMask(maskPattern, row, col - c);
								if (mask) {
									dark = !dark;
								}
								this.modules[row][col - c] = dark;
								bitIndex--;
								if (bitIndex == -1) {
									byteIndex++;
									bitIndex = 7;
								}
							}
						}
						row += inc;
						if (row < 0 || this.moduleCount <= row) {
							row -= inc;
							inc = -inc;
							break;
						}
					}
				}
			}
		};
		QRCodeModel.PAD0 = 0xEC;
		QRCodeModel.PAD1 = 0x11;
		QRCodeModel.createData = function (typeNumber, errorCorrectLevel, dataList) {
			var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, errorCorrectLevel);
			var buffer = new QRBitBuffer();
			for (var i = 0; i < dataList.length; i++) {
				var data = dataList[i];
				buffer.put(data.mode, 4);
				buffer.put(data.getLength(), QRUtil.getLengthInBits(data.mode, typeNumber));
				data.write(buffer);
			}
			var totalDataCount = 0;
			for (var i = 0; i < rsBlocks.length; i++) {
				totalDataCount += rsBlocks[i].dataCount;
			}
			if (buffer.getLengthInBits() > totalDataCount * 8) {
				throw new Error("code length overflow. (" + buffer.getLengthInBits() + ">" + totalDataCount * 8 + ")");
			}
			if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) {
				buffer.put(0, 4);
			}
			while (buffer.getLengthInBits() % 8 != 0) {
				buffer.putBit(false);
			}
			while (true) {
				if (buffer.getLengthInBits() >= totalDataCount * 8) {
					break;
				}
				buffer.put(QRCodeModel.PAD0, 8);
				if (buffer.getLengthInBits() >= totalDataCount * 8) {
					break;
				}
				buffer.put(QRCodeModel.PAD1, 8);
			}
			return QRCodeModel.createBytes(buffer, rsBlocks);
		};
		QRCodeModel.createBytes = function (buffer, rsBlocks) {
			var offset = 0;
			var maxDcCount = 0;
			var maxEcCount = 0;
			var dcdata = new Array(rsBlocks.length);
			var ecdata = new Array(rsBlocks.length);
			for (var r = 0; r < rsBlocks.length; r++) {
				var dcCount = rsBlocks[r].dataCount;
				var ecCount = rsBlocks[r].totalCount - dcCount;
				maxDcCount = Math.max(maxDcCount, dcCount);
				maxEcCount = Math.max(maxEcCount, ecCount);
				dcdata[r] = new Array(dcCount);
				for (var i = 0; i < dcdata[r].length; i++) {
					dcdata[r][i] = 0xff & buffer.buffer[i + offset];
				}
				offset += dcCount;
				var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount);
				var rawPoly = new QRPolynomial(dcdata[r], rsPoly.getLength() - 1);
				var modPoly = rawPoly.mod(rsPoly);
				ecdata[r] = new Array(rsPoly.getLength() - 1);
				for (var i = 0; i < ecdata[r].length; i++) {
					var modIndex = i + modPoly.getLength() - ecdata[r].length;
					ecdata[r][i] = (modIndex >= 0) ? modPoly.get(modIndex) : 0;
				}
			}
			var totalCodeCount = 0;
			for (var i = 0; i < rsBlocks.length; i++) {
				totalCodeCount += rsBlocks[i].totalCount;
			}
			var data = new Array(totalCodeCount);
			var index = 0;
			for (var i = 0; i < maxDcCount; i++) {
				for (var r = 0; r < rsBlocks.length; r++) {
					if (i < dcdata[r].length) {
						data[index++] = dcdata[r][i];
					}
				}
			}
			for (var i = 0; i < maxEcCount; i++) {
				for (var r = 0; r < rsBlocks.length; r++) {
					if (i < ecdata[r].length) {
						data[index++] = ecdata[r][i];
					}
				}
			}
			return data;
		};
		var QRMode = {
			MODE_NUMBER: 1 << 0,
			MODE_ALPHA_NUM: 1 << 1,
			MODE_8BIT_BYTE: 1 << 2,
			MODE_KANJI: 1 << 3
		};
		var QRErrorCorrectLevel = {
			L: 1,
			M: 0,
			Q: 3,
			H: 2
		};
		var QRMaskPattern = {
			PATTERN000: 0,
			PATTERN001: 1,
			PATTERN010: 2,
			PATTERN011: 3,
			PATTERN100: 4,
			PATTERN101: 5,
			PATTERN110: 6,
			PATTERN111: 7
		};
		var QRUtil = {
			PATTERN_POSITION_TABLE: [
				[],
				[6, 18],
				[6, 22],
				[6, 26],
				[6, 30],
				[6, 34],
				[6, 22, 38],
				[6, 24, 42],
				[6, 26, 46],
				[6, 28, 50],
				[6, 30, 54],
				[6, 32, 58],
				[6, 34, 62],
				[6, 26, 46, 66],
				[6, 26, 48, 70],
				[6, 26, 50, 74],
				[6, 30, 54, 78],
				[6, 30, 56, 82],
				[6, 30, 58, 86],
				[6, 34, 62, 90],
				[6, 28, 50, 72, 94],
				[6, 26, 50, 74, 98],
				[6, 30, 54, 78, 102],
				[6, 28, 54, 80, 106],
				[6, 32, 58, 84, 110],
				[6, 30, 58, 86, 114],
				[6, 34, 62, 90, 118],
				[6, 26, 50, 74, 98, 122],
				[6, 30, 54, 78, 102, 126],
				[6, 26, 52, 78, 104, 130],
				[6, 30, 56, 82, 108, 134],
				[6, 34, 60, 86, 112, 138],
				[6, 30, 58, 86, 114, 142],
				[6, 34, 62, 90, 118, 146],
				[6, 30, 54, 78, 102, 126, 150],
				[6, 24, 50, 76, 102, 128, 154],
				[6, 28, 54, 80, 106, 132, 158],
				[6, 32, 58, 84, 110, 136, 162],
				[6, 26, 54, 82, 110, 138, 166],
				[6, 30, 58, 86, 114, 142, 170]
			],
			G15: (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0),
			G18: (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0),
			G15_MASK: (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1),
			getBCHTypeInfo: function (data) {
				var d = data << 10;
				while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15) >= 0) {
					d ^= (QRUtil.G15 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15)));
				}
				return ((data << 10) | d) ^ QRUtil.G15_MASK;
			},
			getBCHTypeNumber: function (data) {
				var d = data << 12;
				while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18) >= 0) {
					d ^= (QRUtil.G18 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18)));
				}
				return (data << 12) | d;
			},
			getBCHDigit: function (data) {
				var digit = 0;
				while (data != 0) {
					digit++;
					data >>>= 1;
				}
				return digit;
			},
			getPatternPosition: function (typeNumber) {
				return QRUtil.PATTERN_POSITION_TABLE[typeNumber - 1];
			},
			getMask: function (maskPattern, i, j) {
				switch (maskPattern) {
				case QRMaskPattern.PATTERN000:
					return (i + j) % 2 == 0;
				case QRMaskPattern.PATTERN001:
					return i % 2 == 0;
				case QRMaskPattern.PATTERN010:
					return j % 3 == 0;
				case QRMaskPattern.PATTERN011:
					return (i + j) % 3 == 0;
				case QRMaskPattern.PATTERN100:
					return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;
				case QRMaskPattern.PATTERN101:
					return (i * j) % 2 + (i * j) % 3 == 0;
				case QRMaskPattern.PATTERN110:
					return ((i * j) % 2 + (i * j) % 3) % 2 == 0;
				case QRMaskPattern.PATTERN111:
					return ((i * j) % 3 + (i + j) % 2) % 2 == 0;
				default:
					throw new Error("bad maskPattern:" + maskPattern);
				}
			},
			getErrorCorrectPolynomial: function (errorCorrectLength) {
				var a = new QRPolynomial([1], 0);
				for (var i = 0; i < errorCorrectLength; i++) {
					a = a.multiply(new QRPolynomial([1, QRMath.gexp(i)], 0));
				}
				return a;
			},
			getLengthInBits: function (mode, type) {
				if (1 <= type && type < 10) {
					switch (mode) {
					case QRMode.MODE_NUMBER:
						return 10;
					case QRMode.MODE_ALPHA_NUM:
						return 9;
					case QRMode.MODE_8BIT_BYTE:
						return 8;
					case QRMode.MODE_KANJI:
						return 8;
					default:
						throw new Error("mode:" + mode);
					}
				} else if (type < 27) {
					switch (mode) {
					case QRMode.MODE_NUMBER:
						return 12;
					case QRMode.MODE_ALPHA_NUM:
						return 11;
					case QRMode.MODE_8BIT_BYTE:
						return 16;
					case QRMode.MODE_KANJI:
						return 10;
					default:
						throw new Error("mode:" + mode);
					}
				} else if (type < 41) {
					switch (mode) {
					case QRMode.MODE_NUMBER:
						return 14;
					case QRMode.MODE_ALPHA_NUM:
						return 13;
					case QRMode.MODE_8BIT_BYTE:
						return 16;
					case QRMode.MODE_KANJI:
						return 12;
					default:
						throw new Error("mode:" + mode);
					}
				} else {
					throw new Error("type:" + type);
				}
			},
			getLostPoint: function (qrCode) {
				var moduleCount = qrCode.getModuleCount();
				var lostPoint = 0;
				for (var row = 0; row < moduleCount; row++) {
					for (var col = 0; col < moduleCount; col++) {
						var sameCount = 0;
						var dark = qrCode.isDark(row, col);
						for (var r = -1; r <= 1; r++) {
							if (row + r < 0 || moduleCount <= row + r) {
								continue;
							}
							for (var c = -1; c <= 1; c++) {
								if (col + c < 0 || moduleCount <= col + c) {
									continue;
								}
								if (r == 0 && c == 0) {
									continue;
								}
								if (dark == qrCode.isDark(row + r, col + c)) {
									sameCount++;
								}
							}
						}
						if (sameCount > 5) {
							lostPoint += (3 + sameCount - 5);
						}
					}
				}
				for (var row = 0; row < moduleCount - 1; row++) {
					for (var col = 0; col < moduleCount - 1; col++) {
						var count = 0;
						if (qrCode.isDark(row, col)) count++;
						if (qrCode.isDark(row + 1, col)) count++;
						if (qrCode.isDark(row, col + 1)) count++;
						if (qrCode.isDark(row + 1, col + 1)) count++;
						if (count == 0 || count == 4) {
							lostPoint += 3;
						}
					}
				}
				for (var row = 0; row < moduleCount; row++) {
					for (var col = 0; col < moduleCount - 6; col++) {
						if (qrCode.isDark(row, col) && !qrCode.isDark(row, col + 1) && qrCode.isDark(row, col + 2) && qrCode.isDark(row, col + 3) && qrCode.isDark(row, col + 4) && !qrCode.isDark(row, col + 5) && qrCode.isDark(row, col + 6)) {
							lostPoint += 40;
						}
					}
				}
				for (var col = 0; col < moduleCount; col++) {
					for (var row = 0; row < moduleCount - 6; row++) {
						if (qrCode.isDark(row, col) && !qrCode.isDark(row + 1, col) && qrCode.isDark(row + 2, col) && qrCode.isDark(row + 3, col) && qrCode.isDark(row + 4, col) && !qrCode.isDark(row + 5, col) && qrCode.isDark(row + 6, col)) {
							lostPoint += 40;
						}
					}
				}
				var darkCount = 0;
				for (var col = 0; col < moduleCount; col++) {
					for (var row = 0; row < moduleCount; row++) {
						if (qrCode.isDark(row, col)) {
							darkCount++;
						}
					}
				}
				var ratio = Math.abs(100 * darkCount / moduleCount / moduleCount - 50) / 5;
				lostPoint += ratio * 10;
				return lostPoint;
			}
		};
		var QRMath = {
			glog: function (n) {
				if (n < 1) {
					throw new Error("glog(" + n + ")");
				}
				return QRMath.LOG_TABLE[n];
			},
			gexp: function (n) {
				while (n < 0) {
					n += 255;
				}
				while (n >= 256) {
					n -= 255;
				}
				return QRMath.EXP_TABLE[n];
			},
			EXP_TABLE: new Array(256),
			LOG_TABLE: new Array(256)
		};
		for (var i = 0; i < 8; i++) {
			QRMath.EXP_TABLE[i] = 1 << i;
		}
		for (var i = 8; i < 256; i++) {
			QRMath.EXP_TABLE[i] = QRMath.EXP_TABLE[i - 4] ^ QRMath.EXP_TABLE[i - 5] ^ QRMath.EXP_TABLE[i - 6] ^ QRMath.EXP_TABLE[i - 8];
		}
		for (var i = 0; i < 255; i++) {
			QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]] = i;
		}

		function QRPolynomial(num, shift) {
			if (num.length == undefined) {
				throw new Error(num.length + "/" + shift);
			}
			var offset = 0;
			while (offset < num.length && num[offset] == 0) {
				offset++;
			}
			this.num = new Array(num.length - offset + shift);
			for (var i = 0; i < num.length - offset; i++) {
				this.num[i] = num[i + offset];
			}
		}
		QRPolynomial.prototype = {
			get: function (index) {
				return this.num[index];
			},
			getLength: function () {
				return this.num.length;
			},
			multiply: function (e) {
				var num = new Array(this.getLength() + e.getLength() - 1);
				for (var i = 0; i < this.getLength(); i++) {
					for (var j = 0; j < e.getLength(); j++) {
						num[i + j] ^= QRMath.gexp(QRMath.glog(this.get(i)) + QRMath.glog(e.get(j)));
					}
				}
				return new QRPolynomial(num, 0);
			},
			mod: function (e) {
				if (this.getLength() - e.getLength() < 0) {
					return this;
				}
				var ratio = QRMath.glog(this.get(0)) - QRMath.glog(e.get(0));
				var num = new Array(this.getLength());
				for (var i = 0; i < this.getLength(); i++) {
					num[i] = this.get(i);
				}
				for (var i = 0; i < e.getLength(); i++) {
					num[i] ^= QRMath.gexp(QRMath.glog(e.get(i)) + ratio);
				}
				return new QRPolynomial(num, 0).mod(e);
			}
		};

		function QRRSBlock(totalCount, dataCount) {
			this.totalCount = totalCount;
			this.dataCount = dataCount;
		}
		QRRSBlock.RS_BLOCK_TABLE = [
			[1, 26, 19],
			[1, 26, 16],
			[1, 26, 13],
			[1, 26, 9],
			[1, 44, 34],
			[1, 44, 28],
			[1, 44, 22],
			[1, 44, 16],
			[1, 70, 55],
			[1, 70, 44],
			[2, 35, 17],
			[2, 35, 13],
			[1, 100, 80],
			[2, 50, 32],
			[2, 50, 24],
			[4, 25, 9],
			[1, 134, 108],
			[2, 67, 43],
			[2, 33, 15, 2, 34, 16],
			[2, 33, 11, 2, 34, 12],
			[2, 86, 68],
			[4, 43, 27],
			[4, 43, 19],
			[4, 43, 15],
			[2, 98, 78],
			[4, 49, 31],
			[2, 32, 14, 4, 33, 15],
			[4, 39, 13, 1, 40, 14],
			[2, 121, 97],
			[2, 60, 38, 2, 61, 39],
			[4, 40, 18, 2, 41, 19],
			[4, 40, 14, 2, 41, 15],
			[2, 146, 116],
			[3, 58, 36, 2, 59, 37],
			[4, 36, 16, 4, 37, 17],
			[4, 36, 12, 4, 37, 13],
			[2, 86, 68, 2, 87, 69],
			[4, 69, 43, 1, 70, 44],
			[6, 43, 19, 2, 44, 20],
			[6, 43, 15, 2, 44, 16],
			[4, 101, 81],
			[1, 80, 50, 4, 81, 51],
			[4, 50, 22, 4, 51, 23],
			[3, 36, 12, 8, 37, 13],
			[2, 116, 92, 2, 117, 93],
			[6, 58, 36, 2, 59, 37],
			[4, 46, 20, 6, 47, 21],
			[7, 42, 14, 4, 43, 15],
			[4, 133, 107],
			[8, 59, 37, 1, 60, 38],
			[8, 44, 20, 4, 45, 21],
			[12, 33, 11, 4, 34, 12],
			[3, 145, 115, 1, 146, 116],
			[4, 64, 40, 5, 65, 41],
			[11, 36, 16, 5, 37, 17],
			[11, 36, 12, 5, 37, 13],
			[5, 109, 87, 1, 110, 88],
			[5, 65, 41, 5, 66, 42],
			[5, 54, 24, 7, 55, 25],
			[11, 36, 12],
			[5, 122, 98, 1, 123, 99],
			[7, 73, 45, 3, 74, 46],
			[15, 43, 19, 2, 44, 20],
			[3, 45, 15, 13, 46, 16],
			[1, 135, 107, 5, 136, 108],
			[10, 74, 46, 1, 75, 47],
			[1, 50, 22, 15, 51, 23],
			[2, 42, 14, 17, 43, 15],
			[5, 150, 120, 1, 151, 121],
			[9, 69, 43, 4, 70, 44],
			[17, 50, 22, 1, 51, 23],
			[2, 42, 14, 19, 43, 15],
			[3, 141, 113, 4, 142, 114],
			[3, 70, 44, 11, 71, 45],
			[17, 47, 21, 4, 48, 22],
			[9, 39, 13, 16, 40, 14],
			[3, 135, 107, 5, 136, 108],
			[3, 67, 41, 13, 68, 42],
			[15, 54, 24, 5, 55, 25],
			[15, 43, 15, 10, 44, 16],
			[4, 144, 116, 4, 145, 117],
			[17, 68, 42],
			[17, 50, 22, 6, 51, 23],
			[19, 46, 16, 6, 47, 17],
			[2, 139, 111, 7, 140, 112],
			[17, 74, 46],
			[7, 54, 24, 16, 55, 25],
			[34, 37, 13],
			[4, 151, 121, 5, 152, 122],
			[4, 75, 47, 14, 76, 48],
			[11, 54, 24, 14, 55, 25],
			[16, 45, 15, 14, 46, 16],
			[6, 147, 117, 4, 148, 118],
			[6, 73, 45, 14, 74, 46],
			[11, 54, 24, 16, 55, 25],
			[30, 46, 16, 2, 47, 17],
			[8, 132, 106, 4, 133, 107],
			[8, 75, 47, 13, 76, 48],
			[7, 54, 24, 22, 55, 25],
			[22, 45, 15, 13, 46, 16],
			[10, 142, 114, 2, 143, 115],
			[19, 74, 46, 4, 75, 47],
			[28, 50, 22, 6, 51, 23],
			[33, 46, 16, 4, 47, 17],
			[8, 152, 122, 4, 153, 123],
			[22, 73, 45, 3, 74, 46],
			[8, 53, 23, 26, 54, 24],
			[12, 45, 15, 28, 46, 16],
			[3, 147, 117, 10, 148, 118],
			[3, 73, 45, 23, 74, 46],
			[4, 54, 24, 31, 55, 25],
			[11, 45, 15, 31, 46, 16],
			[7, 146, 116, 7, 147, 117],
			[21, 73, 45, 7, 74, 46],
			[1, 53, 23, 37, 54, 24],
			[19, 45, 15, 26, 46, 16],
			[5, 145, 115, 10, 146, 116],
			[19, 75, 47, 10, 76, 48],
			[15, 54, 24, 25, 55, 25],
			[23, 45, 15, 25, 46, 16],
			[13, 145, 115, 3, 146, 116],
			[2, 74, 46, 29, 75, 47],
			[42, 54, 24, 1, 55, 25],
			[23, 45, 15, 28, 46, 16],
			[17, 145, 115],
			[10, 74, 46, 23, 75, 47],
			[10, 54, 24, 35, 55, 25],
			[19, 45, 15, 35, 46, 16],
			[17, 145, 115, 1, 146, 116],
			[14, 74, 46, 21, 75, 47],
			[29, 54, 24, 19, 55, 25],
			[11, 45, 15, 46, 46, 16],
			[13, 145, 115, 6, 146, 116],
			[14, 74, 46, 23, 75, 47],
			[44, 54, 24, 7, 55, 25],
			[59, 46, 16, 1, 47, 17],
			[12, 151, 121, 7, 152, 122],
			[12, 75, 47, 26, 76, 48],
			[39, 54, 24, 14, 55, 25],
			[22, 45, 15, 41, 46, 16],
			[6, 151, 121, 14, 152, 122],
			[6, 75, 47, 34, 76, 48],
			[46, 54, 24, 10, 55, 25],
			[2, 45, 15, 64, 46, 16],
			[17, 152, 122, 4, 153, 123],
			[29, 74, 46, 14, 75, 47],
			[49, 54, 24, 10, 55, 25],
			[24, 45, 15, 46, 46, 16],
			[4, 152, 122, 18, 153, 123],
			[13, 74, 46, 32, 75, 47],
			[48, 54, 24, 14, 55, 25],
			[42, 45, 15, 32, 46, 16],
			[20, 147, 117, 4, 148, 118],
			[40, 75, 47, 7, 76, 48],
			[43, 54, 24, 22, 55, 25],
			[10, 45, 15, 67, 46, 16],
			[19, 148, 118, 6, 149, 119],
			[18, 75, 47, 31, 76, 48],
			[34, 54, 24, 34, 55, 25],
			[20, 45, 15, 61, 46, 16]
		];
		QRRSBlock.getRSBlocks = function (typeNumber, errorCorrectLevel) {
			var rsBlock = QRRSBlock.getRsBlockTable(typeNumber, errorCorrectLevel);
			if (rsBlock == undefined) {
				throw new Error("bad rs block @ typeNumber:" + typeNumber + "/errorCorrectLevel:" + errorCorrectLevel);
			}
			var length = rsBlock.length / 3;
			var list = [];
			for (var i = 0; i < length; i++) {
				var count = rsBlock[i * 3 + 0];
				var totalCount = rsBlock[i * 3 + 1];
				var dataCount = rsBlock[i * 3 + 2];
				for (var j = 0; j < count; j++) {
					list.push(new QRRSBlock(totalCount, dataCount));
				}
			}
			return list;
		};
		QRRSBlock.getRsBlockTable = function (typeNumber, errorCorrectLevel) {
			switch (errorCorrectLevel) {
			case QRErrorCorrectLevel.L:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 0];
			case QRErrorCorrectLevel.M:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 1];
			case QRErrorCorrectLevel.Q:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 2];
			case QRErrorCorrectLevel.H:
				return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 3];
			default:
				return undefined;
			}
		};

		function QRBitBuffer() {
			this.buffer = [];
			this.length = 0;
		}
		QRBitBuffer.prototype = {
			get: function (index) {
				var bufIndex = Math.floor(index / 8);
				return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) == 1;
			},
			put: function (num, length) {
				for (var i = 0; i < length; i++) {
					this.putBit(((num >>> (length - i - 1)) & 1) == 1);
				}
			},
			getLengthInBits: function () {
				return this.length;
			},
			putBit: function (bit) {
				var bufIndex = Math.floor(this.length / 8);
				if (this.buffer.length <= bufIndex) {
					this.buffer.push(0);
				}
				if (bit) {
					this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
				}
				this.length++;
			}
		};
		var QRCodeLimitLength = [
			[17, 14, 11, 7],
			[32, 26, 20, 14],
			[53, 42, 32, 24],
			[78, 62, 46, 34],
			[106, 84, 60, 44],
			[134, 106, 74, 58],
			[154, 122, 86, 64],
			[192, 152, 108, 84],
			[230, 180, 130, 98],
			[271, 213, 151, 119],
			[321, 251, 177, 137],
			[367, 287, 203, 155],
			[425, 331, 241, 177],
			[458, 362, 258, 194],
			[520, 412, 292, 220],
			[586, 450, 322, 250],
			[644, 504, 364, 280],
			[718, 560, 394, 310],
			[792, 624, 442, 338],
			[858, 666, 482, 382],
			[929, 711, 509, 403],
			[1003, 779, 565, 439],
			[1091, 857, 611, 461],
			[1171, 911, 661, 511],
			[1273, 997, 715, 535],
			[1367, 1059, 751, 593],
			[1465, 1125, 805, 625],
			[1528, 1190, 868, 658],
			[1628, 1264, 908, 698],
			[1732, 1370, 982, 742],
			[1840, 1452, 1030, 790],
			[1952, 1538, 1112, 842],
			[2068, 1628, 1168, 898],
			[2188, 1722, 1228, 958],
			[2303, 1809, 1283, 983],
			[2431, 1911, 1351, 1051],
			[2563, 1989, 1423, 1093],
			[2699, 2099, 1499, 1139],
			[2809, 2213, 1579, 1219],
			[2953, 2331, 1663, 1273]
		];
	
	function _isSupportCanvas() {
		return typeof CanvasRenderingContext2D != "undefined";
	}
	
	// android 2.x doesn't support Data-URI spec
	function _getAndroid() {
		var android = false;
		var sAgent = navigator.userAgent;
		
		if (/android/i.test(sAgent)) { // android
			android = true;
			aMat = sAgent.toString().match(/android ([0-9]\.[0-9])/i);
			
			if (aMat && aMat[1]) {
				android = parseFloat(aMat[1]);
			}
		}
		
		return android;
	}
	
	// Drawing in DOM by using Table tag
	var Drawing = !_isSupportCanvas() ? (function () {
		var _el = null;
		var _htOption = null;
		
		var Drawing = function (el, htOption) {
			_el = el;
			_htOption = htOption;
		};
			
		/**
		 * Draw the QRCode
		 * 
		 * @param {QRCode} oQRCode
		 */
		Drawing.prototype.draw = function (oQRCode) {
			var nCount = oQRCode.getModuleCount();
			var nWidth = Math.floor(_htOption.width / nCount);
			var nHeight = Math.floor(_htOption.height / nCount);
			var aHTML = ['<table style="border:0;border-collapse:collapse;">'];
			
			for (var row = 0; row < nCount; row++) {
				aHTML.push('<tr>');
				
				for (var col = 0; col < nCount; col++) {
					aHTML.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:' + nWidth + 'px;height:' + nHeight + 'px;background-color:' + (oQRCode.isDark(row, col) ? _htOption.colorDark : _htOption.colorLight) + ';"></td>');
				}
				
				aHTML.push('</tr>');
			}
			
			aHTML.push('</table>');
			_el.innerHTML = aHTML.join('');
			
			// Fix the margin values as real size.
			var elTable = _el.childNodes[0];
			var nLeftMarginTable = (_htOption.width - elTable.offsetWidth) / 2;
			var nTopMarginTable = (_htOption.height - elTable.offsetHeight) / 2;
			
			if (nLeftMarginTable > 0 && nTopMarginTable > 0) {
				elTable.style.margin = nTopMarginTable + "px " + nLeftMarginTable + "px";	
			}
		};
		
		/**
		 * Clear the QRCode
		 */
		Drawing.prototype.clear = function () {
			_el.innerHTML = '';
		};
		
		return Drawing;
	})() : (function () { // Drawing in Canvas
		var _el = null;
		var _elCanvas = null;
		var _elImage = null;
		var _fFail = null;
		var _fSuccess = null;
		var _htOption = null;
		var _bSupportDataURI = null;
		var _oContext = null;
		var _bIsPainted = false;
		var _android = _getAndroid();
		
		function _onMakeImage() {
			_elImage.src = _elCanvas.toDataURL("image/png");
			_elImage.style.display = "block";
			_elCanvas.style.display = "none";			
		}
		
		// Android 2.1 bug workaround
		// http://code.google.com/p/android/issues/detail?id=5141
		if (_android && _android <= 2.1) {
	    	var factor = 1 / window.devicePixelRatio;
	        var drawImage = CanvasRenderingContext2D.prototype.drawImage; 
	    	CanvasRenderingContext2D.prototype.drawImage = function (image, sx, sy, sw, sh, dx, dy, dw, dh) {
	    		if (("nodeName" in image) && /img/i.test(image.nodeName)) {
		        	for (var i = arguments.length - 1; i >= 1; i--) {
		            	arguments[i] = arguments[i] * factor;
		        	}
	    		} else if (typeof dw == "undefined") {
	    			arguments[1] *= factor;
	    			arguments[2] *= factor;
	    			arguments[3] *= factor;
	    			arguments[4] *= factor;
	    		}
	    		
	        	drawImage.apply(this, arguments); 
	    	};
		}
		
		/**
		 * Check whether the user's browser supports Data URI or not
		 * 
		 * @private
		 * @param {Function} fSuccess Occurs if it supports Data URI
		 * @param {Function} fFail Occurs if it doesn't support Data URI
		 */
		function _safeSetDataURI(fSuccess, fFail) {
			_fFail = fFail;
			_fSuccess = fSuccess;
	
			// Check it just once
			if (_bSupportDataURI === null) {
				var el = document.createElement("img");
				var fOnError = function () {
					_bSupportDataURI = false;
					
					if (_fFail) {
						_fFail();	
					}					
				};
				var fOnSuccess = function () {
					_bSupportDataURI = true;
					
					if (_fSuccess) {
						_fSuccess();
					}
				};
				
				el.onabort = fOnError;
				el.onerror = fOnError;
				el.onload = fOnSuccess;
				el.src = "data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="; // the Image contains 1px data.
				return;
			} else if (_bSupportDataURI === true && _fSuccess) {
				_fSuccess();
			} else if (_bSupportDataURI === false && _fFail) {
				_fFail();
			}
		};
		
		/**
		 * Drawing QRCode by using canvas
		 * 
		 * @constructor
		 * @param {HTMLElement} el
		 * @param {Object} htOption QRCode Options 
		 */
		var Drawing = function (el, htOption) {
			_htOption = htOption;
			_elCanvas = document.createElement("canvas");
			_elCanvas.width = htOption.width;
			_elCanvas.height = htOption.height;
			el.appendChild(_elCanvas);
			_el = el;
			_oContext = _elCanvas.getContext("2d");
			_bIsPainted = false;
			_elImage = document.createElement("img");
			_elImage.style.display = "none";
			_el.appendChild(_elImage);
			_bSupportDataURI = null;
		};
			
		/**
		 * Draw the QRCode
		 * 
		 * @param {QRCode} oQRCode 
		 */
		Drawing.prototype.draw = function (oQRCode) {
			_elImage.style.display = "none";
			var nCount = oQRCode.getModuleCount();
			var nWidth = _htOption.width / nCount;
			var nHeight = _htOption.height / nCount;
			var nRoundedWidth = Math.round(nWidth);
			var nRoundedHeight = Math.round(nHeight);
			this.clear();
			
			for (var row = 0; row < nCount; row++) {
				for (var col = 0; col < nCount; col++) {
					var bIsDark = oQRCode.isDark(row, col);
					var nLeft = col * nWidth;
					var nTop = row * nHeight;
					_oContext.strokeStyle = bIsDark ? _htOption.colorDark : _htOption.colorLight;
					_oContext.lineWidth = 1;
					_oContext.fillStyle = bIsDark ? _htOption.colorDark : _htOption.colorLight;					
					_oContext.fillRect(nLeft, nTop, nWidth, nHeight);
					
					//resistant anti-aliasing
					_oContext.strokeRect(
						Math.floor(nLeft) + 0.5,
						Math.floor(nTop) + 0.5,
						nRoundedWidth,
						nRoundedHeight
					);
					
					_oContext.strokeRect(
						Math.ceil(nLeft) - 0.5,
						Math.ceil(nTop) - 0.5,
						nRoundedWidth,
						nRoundedHeight
					);
				}
			}
			
			_bIsPainted = true;
		};
			
		/**
		 * Make the image from Canvas if the browser supports Data URI.
		 */
		Drawing.prototype.makeImage = function () {
			if (_bIsPainted) {
				_safeSetDataURI(_onMakeImage);
			}
		};
			
		/**
		 * Return whether the QRCode is painted or not
		 * 
		 * @return {Boolean}
		 */
		Drawing.prototype.isPainted = function () {
			return _bIsPainted;
		};
		
		/**
		 * Clear the QRCode
		 */
		Drawing.prototype.clear = function () {
			_oContext.clearRect(0, 0, _elCanvas.width, _elCanvas.height);
			_bIsPainted = false;
		};
		
		/**
		 * @private
		 * @param {Number} nNumber
		 */
		Drawing.prototype.round = function (nNumber) {
			if (!nNumber) {
				return nNumber;
			}
			
			return Math.floor(nNumber * 1000) / 1000;
		};
		
		return Drawing;
	})();
	
	/**
	 * Get the type by string length
	 * 
	 * @private
	 * @param {String} sText
	 * @param {Number} nCorrectLevel
	 * @return {Number} type
	 */
	function _getTypeNumber(sText, nCorrectLevel) {			
		var nType = 1;
		
		for (var i = 0, len = QRCodeLimitLength.length; i <= len; i++) {
			var nLimit = 0;
			
			switch (nCorrectLevel) {
				case QRErrorCorrectLevel.L :
					nLimit = QRCodeLimitLength[i][0];
					break;
				case QRErrorCorrectLevel.M :
					nLimit = QRCodeLimitLength[i][1];
					break;
				case QRErrorCorrectLevel.Q :
					nLimit = QRCodeLimitLength[i][2];
					break;
				case QRErrorCorrectLevel.H :
					nLimit = QRCodeLimitLength[i][3];
					break;
			}
			
			if (sText.length <= nLimit) {
				break;
			} else {
				nType++;
			}
		}
		
		if (nType > QRCodeLimitLength.length) {
			throw new Error("Too long data");
		}
		
		return nType;
	}
	
	/**
	 * @class QRCode
	 * @constructor
	 * @example 
	 * new QRCode(document.getElementById("test"), "http://jindo.dev.naver.com/collie");
	 *
	 * @example
	 * var oQRCode = new QRCode("test", {
	 *    text : "http://naver.com",
	 *    width : 128,
	 *    height : 128
	 * });
	 * 
	 * oQRCode.clear(); // Clear the QRCode.
	 * oQRCode.makeCode("http://map.naver.com"); // Re-create the QRCode.
	 *
	 * @param {HTMLElement|String} el target element or 'id' attribute of element.
	 * @param {Object|String} vOption
	 * @param {String} vOption.text QRCode link data
	 * @param {Number} [vOption.width=256]
	 * @param {Number} [vOption.height=256]
	 * @param {String} [vOption.colorDark="#000000"]
	 * @param {String} [vOption.colorLight="#ffffff"]
	 * @param {QRCode.CorrectLevel} [vOption.correctLevel=QRCode.CorrectLevel.H] [L|M|Q|H] 
	 */
	QRCode = function (el, vOption) {
		this._htOption = {
			width : 256, 
			height : 256,
			typeNumber : 4,
			colorDark : "#000000",
			colorLight : "#ffffff",
			correctLevel : QRErrorCorrectLevel.H
		};
		
		if (typeof vOption === 'string') {
			vOption	= {
				text : vOption
			};
		}
		
		// Overwrites options
		if (vOption) {
			for (var i in vOption) {
				this._htOption[i] = vOption[i];
			}
		}
		
		if (typeof el == "string") {
			el = document.getElementById(el);
		}
		
		this._android = _getAndroid();
		this._el = el;
		this._oQRCode = null;
		this._oDrawing = new Drawing(this._el, this._htOption);
		
		if (this._htOption.text) {
			this.makeCode(this._htOption.text);	
		}
	};
	
	/**
	 * Make the QRCode
	 * 
	 * @param {String} sText link data
	 */
	QRCode.prototype.makeCode = function (sText) {
		this._oQRCode = new QRCodeModel(_getTypeNumber(sText, this._htOption.correctLevel), this._htOption.correctLevel);
		this._oQRCode.addData(sText);
		this._oQRCode.make();
		this._el.title = sText;
		this._oDrawing.draw(this._oQRCode);			
		this.makeImage();
	};
	
	/**
	 * Make the Image from Canvas element
	 * - It occurs automatically
	 * - Android below 3 doesn't support Data-URI spec.
	 * 
	 * @private
	 */
	QRCode.prototype.makeImage = function () {
		if (typeof this._oDrawing.makeImage == "function" && (!this._android || this._android >= 3)) {
			this._oDrawing.makeImage();
		}
	};
	
	/**
	 * Clear the QRCode
	 */
	QRCode.prototype.clear = function () {
		this._oDrawing.clear();
	};
	
	/**
	 * @name QRCode.CorrectLevel
	 */
	QRCode.CorrectLevel = QRErrorCorrectLevel;
})();

//end of qrcode.js
</script>

<!--ORIGINAL PASSLOK CODE-->

<!--this only loads two regular expressions: blackListExp and wordListExp, plus their lengths-->
<script>
//Dictionary for entropy calculation in WiseHash. American English version
//This file contains only two global arrays made of words: blacklist and wordlist. Common substitutions have been applied:
//   0 for o, 1 for i, 2 for z, 3 for e, 4 for a, 5 for s, 7 for t, 8 for b, 9 for g

//this makes an regular expression with the 1000 most frequent passwords as of 2011, from https://xato.net/passwords/more-top-worst-passwords, plus a few more. 3-letter words from the other list. To sort it from longer to shorter strings in javascript, do it with the following, after it has been turned into an array:
//blacklist.sort(function (a, b) { return b.length - a.length; })
var blackListExp = new RegExp("c0rr3c7h0r5384773ry574pl3|p455l0k|p455l0ck|123456789|l1v3rp00l|p455w0rd1|53mp3rf1|p4k1574n|845384ll|f00784ll|m1ch43l1|j3nn1f3r|73577357|w0lf94n9|74rh33l5|5up3rm4n|l0v3r80y|pu55yc47|7ru57n01|p4n7h3r5|5r1n1v45|51mp50n5|571n9r4y|m1ch3ll3|5un5h1n3|4m3r1c4n|l4wr3nc3|p455w0rd|w0lfp4ck|3l124837|574rw4r5|5c4rf4c3|41rpl4n3|ncc1701d|c0mpu73r|k4w454k1|c4rd1n4l|p47r1075|5p1d3rm4|c0rv3773|m17ch3ll|ch3v3ll3|pr1nc355|l37m31n1|8ulld095|r0ll71d3|1l0v3y0u|44444444|p455p0r7|v1r91n14|m4v3r1ck|8l1nk182|5w0rdf15|5c07l4nd|5w1mm1n9|54m4n7h4|5733l3r5|8r1774ny|574r9473|wh473v3r|3l3c7r1c|8udl19h7|p33k4800|m157r355|p34rlj4m|fr33p455|r3m3m83r|h4rdc0r3|w0lv3r1n|48cd1234|v3r0n1c4|w1ldc475|53cur17y|1n73rn37|50f784ll|ch4mp10n|m3rc3d35|848y91rl|fr33u53r|12345678|p47r1c14|w35751d3|c0ur7n3y|5n1ck3r5|819d4ddy|fr4nkl1n|m1dn19h7|c4r0l1n3|1q422w5x|m4r5h4ll|11111111|dr0w554p|ch3r0k33|m4rl80r0|4nd3r50n|5p17f1r3|v1c70r14|m4ryj4n3|p4r4d153|l4cr0553|8u77h34d|1nf1n17y|n0v3m83r|n1n73nd0|574r7r3k|p00h834r|45df9hjk|l1v3rp00|d4rkn355|80ll0ck5|d4n13ll3|r3d5k1n5|cr3471v3|c0l0r4d0|c4r0l1n4|1q2w334r|k1m83rly|5l1pkn07|m0un741n|l45v3945|p455w0rd|4l3x4nd3|5n0w84ll|5h17h34d|31n5731n|9u1nn355|xxxxxxxx|87654321|m1ch194n|88888888|n1ch0l45|m374ll1c|r3dw1n95|8r00klyn|d1ckh34d|qw3r7yu1|83nj4m1n|d0lph1n5|d3c3m83r|chr1571n|3xpl0r3r|3l3ph4n7|41r80rn3|8ull5h17|c0c4c0l4|j0rd4n23|69696969|94rf13ld|pl471num|l1f3h4ck|w1ll14m5|90d21ll4|45df45df|5c0rp10n|ru5h2112|j0n47h4n|1n53cur3|ch0pp3r|w3lc0m3|fr33d0m|m4r1n35|ncc1701|71m07hy|cl4ud14|ch4rl35|cl1n70n|8r07h3r|819d1ck|c47ch22|f1r3m4n|7hund3r|8l0wj08|p0k3m0n|m0n573r|8r4dl3y|m4x1mu5|p3n9u1n|h0u570n|p47ch35|53rv1c3|8r4nd0n|p4n73r4|w1nd0w5|p3rf3c7|n474l13|h347h3r|jup173r|h3ndr1x|l1nc0ln|51mp50n|ch1c490|r4n93r5|94nd4lf|fr4nk13|8197175|24ch4ry|p45510n|r41d3r5|p4ck4rd|1r3l4nd|n1ppl35|chr0n1c|cumm1n9|j0hn50n|ch3573r|p0n714c|n3m3515|m477h3w|f15h1n9|j3ffr3y|948r13l|l00k1n9|fr13nd5|pyr4m1d|4ll150n|84r84r4|7hx1138|3v3r70n|ch3l534|p4n7h3r|2xcv8nm|4r53n4l|p47r1ck|r1ch4rd|ru553ll|d14m0nd|7777777|dr34m3r|kr1573n|4m473ur|h07m41l|cry574l|7174n1c|p0pc0rn|v1nc3n7|5h0073r|3x7r3m3|5h4nn0n|84574rd|l347h3r|0c7083r|c4m3r0n|cl4551c|m4d150n|ch4rl13|548r1n4|h0073r5|m3l4n13|4n7h0ny|c4p741n|v1k1n95|j45m1n3|d3571ny|5k1pp3r|d0u9l45|n4u9h7y|54ndm4n|v4n3554|71ff4ny|8008135|n3wp0r7|m4ch1n3|4r120n4|f0r3v3r|pu55135|7hump3r|573ph3n|8u88l35|l183r7y|j4ck50n|l37m31n|5c0073r|ph03n1x|5n0wm4n|w1n570n|5p3nc3r|m0n74n4|p4ck3r5|n3wy0rk|drumm3r|574nl3y|93n3r4l|3cl1p53|d0d93r5|p0r5ch3|54m5un9|j3551c4|819c0ck|455h0l3|c0ll393|hun71n9|fuck1n9|93n3515|n4745h4|m4xw3ll|8675309|f4n745y|8347l35|7357123|h4wk3y3|pumpk1n|r00573r|fuck0ff|pl4y80y|v4mp1r3|n1rv4n4|r3dh34d|8uff4l0|qw3r7y1|c4r7m4n|d19174l|r4ym0nd|7r1n17y|n07h1n9|7r00p3r|p4n7135|fl0r1d4|1234567|p3rv3r7|r0538ud|80nd493|mu574n9|7r0u8l3|5ucc355|9r390ry|cr1ck37|w4rr10r|p34ch35|fl0w3r5|fucky0u|m1ch43l|7h3r0ck|9473w4y|w1ll14m|r41n80w|c0w80y5|w1ldc47|ch1ck3n|m3rcury|y4nk335|8r0nc05|fr4nc15|4m3r1c4|ju571c3|573w4r7|d0lph1n|73571n9|80nd007|f3rr4r1|5u8l1m3|cum5h07|h3k46w2|8r17n3y|ph4n70m|m3l1554|c0n7r0l|1r0nm4n|pr1v473|48cd3f9|v0y493r|817ch35|930r914|r383cc4|l35814n|j4ck455|8ulld09|5c0rp10|53cur3|c4nn0n|w1n73r|r3d123|90rd0n|7r4v15|834v3r|1n51d3|fly3r5|232323|222222|80nn13|d09913|l393nd|y4nk33|8l423r|qw3r7y|runn3r|81rd13|555555|p4rk3r|70p9un|834v15|h34v3n|4n1m4l|c0y073|81980y|71nk3r|4r7hur|w4l73r|73573r|d0n4ld|k474n4|4p0ll0|v39374|dr490n|4u9u57|54m50n|m0nk3y|8r0nc0|fr34ky|696969|48c123|c0pp3r|v00d00|c4lv1n|w1ll0w|4lph41|l177l3|c4r73r|4l83r7|m3m83r|k1773n|x4v13r|349l31|5h3l8y|159753|j35513|n1993r|123321|5h4d0w|h0rn3y|5urf3r|n1554n|999999|547urn|8r4v35|4l3x15|m4rv1n|m4573r|4c710n|4d1d45|m47ur3|fr3ddy|w4lk3r|p0l1c3|987654|9unn3r|111111|c0nn13|0nl1n3|ru5514|4ppl35|73r354|70mc47|5h4r0n|d3x73r|r4c1n9|57up1d|f15h3r|d0c70r|dr34m5|v1c70r|h3n741|m49num|n47h4n|c4n4d4|d0nk3y|777777|333333|573ll4|93m1n1|j0rd4n|12348c|5p33dy|h07d09|123456|p1mp1n|n3l50n|m4r1n4|m0n1c4|571cky|j49u4r|l0u153|222222|83rl1n|9470r5|h4rl3y|5uck3r|m3x1c0|5uck17|chr151|fuckm3|91850n|c3l71c|m4rcu5|ch3rry|c45513|888888|5n1p3r|ch4nc3|p00k13|h07r0d|r3dd09|h3lpm3|7uck3r|j3573r|dr1v3r|c00p3r|un173d|c4rm3n|l0v3r5|hun73r|54ndr4|1q2w33|112233|c45p3r|54mu3l|j3r3my|914n75|57r1k3|d38813|513rr4|70y074|h3ll01|90083r|fr1d4y|50ph13|5c077y|48cd3f|7ur7l3|h4w411|fluffy|muff1n|h0r535|j4ck13|r4n93r|fl0w3r|d3nn15|p4m3l4|7h3m4n|8uddh4|r0ck37|l4ur3n|w0lv35|4n93l4|541l0r|423r7y|74uru5|5h0r7y|m0n3y1|l0v3m3|8ull37|51mpl3|80093r|444444|84d455|8u773r|d3n153|m4dd09|l124rd|w1ll13|455m4n|c4rl05|w1l50n|h0w4rd|123qw3|pr1nc3|4n93l5|murphy|101010|1w4n7u|747700|p0p3y3|v1k1n9|pu55y1|90ld3n|w1nn3r|5p00ky|4l45k4|84d93r|j45p3r|8u573r|m024r7|m07h3r|v491n4|q42w5x|0l1v3r|n0rm4n|5ydn3y|51n9l3|c0u94r|r3d50x|819m4c|420420|f4m1ly|3n19m4|53x53x|r41d3r|8r421l|8l0nd3|7h0m45|r4ch3l|5ch00l|5l4y3r|l0v3ly|h4nn4h|000000|252525|l0nd0n|5p4nky|l35l13|8l0wm3|84d80y|d1353l|3m1n3m|5u2uk1|3dw4rd|humm3r|l4d135|84rn3y|5k1ppy|r39913|5uckm3|m4r1n3|147147|p1r473|80570n|r3drum|d148l0|w4nk3r|571nky|duc471|y4m4h4|815h0p|f3nd3r|5p1r17|573v3n|m0nd4y|8ru7u5|r48817|5m007h|m1ll3r|m4rl3y|f0r357|212121|l4k3r5|n1ppl3|5p1d3r|v1510n|84n4n4|73nn15|8r4ndy|1nd14n|71993r|p1c4rd|5y573m|jun10r|lucky1|cl41r3|5c008y|800913|w124rd|pl4y3r|xxxxxx|5pr1n9|d4nc3r|h4rd0n|j0hnny|fuck3d|800800|c0ff33|c0mp4q|kn19h7|4ndr34|819r3d|5qu1r7|pl3453|2xcv8n|h08835|k3rm17|r083r7|d0m1n0|50cc3r|d3nv3r|8r00k3|r45c4l|h17m4n|349l35|847m4n|888888|fr13nd|d4k074|5m0k3y|1c3m4n|800m3r|541n75|5n00py|j053ph|819m4n|20m813|h4h4h4|131313|d15n3y|ju571n|8r3nd4|m00k13|p34nu7|dunc4n|0l1v14|n45c4r|c00k13|4l1c14|4l150n|m1ck3y|8u8841|7193r5|m0r94n|444444|purpl3|3r071c|9u174r|841l3y|l19h75|f4lc0n|m47r1x|c4m4r0|h4ppy1|94l0r3|chr157|w3453l|242424|w0m847|d1993r|c0w80y|5p4rky|p00p00|4cc0rd|45df9h|7urk3y|007007|53cr37|819d09|y3ll0w|m4r71n|ch3353|90lf3r|c4rr13|121212|p5ych0|m3rl1n|8ur70n|k1ll3r|c0nn0r|l1ckm3|r0l4nd|4u571n|fuck3r|74yl0r|5umm3r|4rn0ld|h4mm3r|91n93r|908lu3|d3v1l5|3u93n3|3mp1r3|n1c0l3|5h499y|fr099y|94rc14|789456|k0d14k|p30pl3|kr4m3r|8173m3|h00k3r|whyn07|0r4n93|84x73r|5p0r75|h0ck3y|4m4nd4|qqqqqq|666666|4v4l0n|45hl3y|123123|d4ll45|51lv3r|m49913|123654|7ruck5|j05hu4|654321|4cc355|d4n13l|p3pp3r|m4dm4x|4ly554|84m84m|5h4v3d|7193r1|ch1ck5|r4p70r|fr4nc3|4ndr3w|930r93|d3c0y|3n73r|9r33n|wh0r3|cr42y|m0053|v1d30|80085|0u812|cr34m|11111|j35u5|fl45h|fr4nk|8uddy|8088y|84ll5|h0u53|5w337|5m17h|h0nd4|m491c|349l3|h4ppy|h0r53|k3lly|d347h|c08r4|3nj0y|834ch|j3nny|4m83r|8unny|m0u53|p0w3r|p3p51|j0n35|55555|ch3vy|j4m35|d1r7y|4dm1n|8u884|05c4r|81lly|wh173|ju1c3|54r4h|347m3|817ch|h0m3r|v1p3r|mu51c|8007y|9r347|m0lly|573v3|12345|j1mmy|p3n15|w473r|r0ck5|45df9|8l4ck|8r0wn|p4r7y|k4713|j450n|d4ddy|73x45|5c077|php88|l19h7|54321|91rl5|xxxxx|51m0n|h0n3y|p0rn0|3lv15|j3rry|r0cky|4lph4|5n4k3|n4k3d|733n5|y0un9|h3ll0|5lu75|7193r|54ndy|5u94r|54mmy|w0m3n|70mmy|r4v3n|pu55y|chr15|h0rny|8r14n|m0n3y|84835|p373r|5up3r|qw3r7|j4p4n|p4r15|k3v1n|m0v13|w00dy|c4ndy|574r5|5p1k3|d4v1d|lucky|4ppl3|4n93l|l0v3r|k177y|1969|6969|733n|4d4m|l154|53xy|qw3r|1111|48cd|ry4n|p455|7357|8888|duk3|70ny|fuck|9999|d1ck|p1mp|m1k3|j0hn|p0rn|8lu3|j3ff|dud3|l0n9|5uck|45df|3r1c|p00p|j4ck|h4rd|71m3|900d|4321|6666|m477|90lf|5555|m1n3|l0v3|3333|f0rd|834r|91rl|5150|xxxx|fr3d|7175|0000|f15h|k1n9|2000|w0lf|1313|8455|5h17|c0ck|2112|fr33|1212|5lu7|cun7|7777|m4rk|h34d|p4ul|j4k3|c00l|r0ck|d4v3|4l3x|f1r3|848y|4444|2222|81ll|833r|574r|1234|84n9|4444|k3y|123|321|111|222|333|444|555|666|777|888|999|000|45d|qw3|2xc|098|p01|lkj|mn8|qqq|www|rrr|yyy|uuu|ppp|ddd|fff|hhh|jjj|kkk|lll|xxx|ccc|vvv|nnn|mmm","g");
var blackLength = 1043;

//from https://github.com/first20hours/google-10000-english. Words not on blacklist only. To find the difference, do this in the js console:
//Array.prototype.diff = function(a) {
//    return this.filter(function(i) {return a.indexOf(i) < 0;});
//};
//and then wordlist.diff(blacklist) from their array forms
var wordListExp = new RegExp("73l3c0mmun1c4710n5|5u8l1m3d1r3c70ry|ch4r4c73r124710n|r35p0n5181l17135|r3c0mm3nd4710n5|7r0u8l35h0071n9|ch4r4c73r1571c5|c0n9r47ul4710n5|r3pr353n74710n5|ph4rm4c3u71c4l5|r3pr353n7471v35|c0nf1d3n714l17y|1n57rum3n74710n|1n73rn4710n4lly|r3c0n57ruc710n|5p3c1f1c4710n5|1n73rpr374710n|cl4551f1c4710n|1d3n71f1c4710n|c0n51d3r4710n5|4dm1n157r471v3|4u7h3n71c4710n|5u5741n481l17y|c0rr35p0nd3nc3|d15cr1m1n4710n|c0nf19ur4710n5|1nfr457ruc7ur3|c4rd10v45cul4r|7r4n5f0rm4710n|r3h481l174710n|4dm1n157r470r5|r3c0mm3nd4710n|51mul74n30u5ly|ph4rm4c3u71c4l|c0nc3n7r4710n5|0r94n124710n4l|1mpl3m3n74710n|kn0wl3d93570rm|qu4l1f1c4710n5|1nv357194710n5|4dm1n157r4710n|r3pr353n74710n|5up3r1n73nd3n7|7r4n5p0r74710n|ch4r4c73r1571c|r3pr353n7471v3|4cc0mm0d4710n5|4dv3r7153m3n75|r35p0n5181l17y|4ppr0pr14710n5|c0mmun1c4710n5|4cc0un7481l17y|c0n5717u710n4l|p4rl14m3n74ry|4u70m471c4lly|1nv357194710n|c0n7r0v3r514l|4l73rn471v3ly|p4r71c1p4710n|4dm1n157r470r|4ppr0x1m473ly|qu35710nn41r3|qu4l1f1c4710n|c0n74m1n4710n|3x7r40rd1n4ry|ch4mp10n5h1p5|pr353n74710n5|r3v0lu710n4ry|c0mpl1m3n74ry|r3l4710n5h1p5|c0mpr3h3n51v3|c1rcum574nc35|c0nf19ur4710n|5u8574n714lly|n071f1c4710n5|c0mpu74710n4l|c0ll480r471v3|m3d173rr4n34n|1llu57r4710n5|1n73rv3n710n5|3n73r741nm3n7|p5ych0l091c4l|81073chn0l09y|func710n4l17y|pr4c71710n3r5|1n57ruc710n4l|4u7h0r124710n|d373rm1n4710n|d157r18u710n5|c0rr35p0nd1n9|4rch173c7ur4l|und3r9r4du473|m0d1f1c4710n5|m4nuf4c7ur1n9|1n5717u710n4l|c0mp47181l17y|c0ll480r4710n|c0mm15510n3r5|1n73rn4710n4l|1n4ppr0pr1473|4nn0unc3m3n75|pr3c1p174710n|1nv35719470r5|0r94n154710n5|c0n9r35510n4l|3n7r3pr3n3ur5|4ccr3d174710n|57r3n97h3n1n9|d0cum3n74710n|574r5m3rch4n7|73chn0l091c4l|53m1c0nduc70r|c0n7r18u710n5|p4r71c1p471n9|c0mpl1c4710n5|7r4n5cr1p710n|3nv1r0nm3n74l|c0n51d3r4710n|m4554chu53775|l13ch73n5731n|c0n5c10u5n355|m15c3ll4n30u5|und3r574nd1n9|c3r71f1c4710n|5p3c1f1c4710n|pr0f35510n4l5|5u85cr1p710n5|818l109r4ph1c|c0nv3r54710n5|c0nc3n7r4710n|r357ruc7ur1n9|4cc355181l17y|0pp0r7un17135|50ph1571c473d|m4nuf4c7ur3r5|d1571n9u15h3d|519n1f1c4n7ly|ph0709r4ph3r5|0r94n124710n5|35748l15hm3n7|1nd3p3nd3n7ly|3ff3c71v3n355|d3m0n57r4710n|d3v3l0pm3n74l|c0n50l1d4710n|c0mmun1c4710n|1nf0rm4710n4l|ch4r4c73r123d|1n574ll4710n5|p055181l17135|vuln3r481l17y|4cc0mm0d4710n|4dv3r7153m3n7|unf0r7un473ly|4l73rn471v35|hyp07h371c4l|p3nn5ylv4n14|un3mpl0ym3n7|pr353n74710n|4dd1710n4lly|pr353rv4710n|4cqu151710n5|d15c1pl1n4ry|c3r71f1c4735|d3571n4710n5|jur15d1c710n|d3m0n57r473d|pr0f35510n4l|1n7r0duc70ry|d3p4r7m3n74l|4lph48371c4l|3x4m1n4710n5|d3v3l0pm3n75|p3rf0rm4nc35|r35p3c71v3ly|1n57rum3n74l|5u8c0mm17733|p4r71c1p473d|c0mm15510n3r|c0nn3c71v17y|d154pp01n73d|1nd1v1du4lly|4ch13v3m3n75|c0n71nu0u5ly|1n73ll193nc3|m345ur3m3n75|73571m0n14l5|c0m81n4710n5|3ncycl0p3d14|1n73rm3d1473|ph0709r4ph3r|54715f4c70ry|hum4n174r14n|7r4n54c710n5|c0nf3r3nc1n9|4cc0mpl15h3d|1mpl1c4710n5|7r4n5l4710n5|c0ll3c718l35|r357r1c710n5|r3pr353n71n9|d35cr1p710n5|5uff1c13n7ly|5p1r17u4l17y|7h4nk591v1n9|0p71m124710n|3xp3r13nc1n9|c0n53qu3nc35|c0n53rv471v3|mun1c1p4l17y|3xp3c74710n5|818l109r4phy|1nd3p3nd3nc3|4rch173c7ur3|4n7hr0p0l09y|c0n53qu3n7ly|c0ll3c748l35|3nv1r0nm3n75|4ppl1c4710n5|0r94n154710n|p4r71cul4rly|ph0709r4ph1c|j4ck50nv1ll3|d1ff3r3n714l|5ch0l4r5h1p5|4cc0mp4ny1n9|r3cr34710n4l|h34dqu4r73r5|r3qu1r3m3n75|1nfr1n93m3n7|1llu57r4710n|d157r18u70r5|r353rv4710n5|c0nf1rm4710n|5urv31ll4nc3|qu4n717471v3|574k3h0ld3r5|ch4mp10n5h1p|c0n50l1d473d|p3r50n4l123d|c4p481l17135|3n73r741n1n9|pr3r3qu15173|5ucc355fully|c0nd1710n1n9|c0n57ruc710n|3xp3nd17ur35|r3fr193r470r|n390714710n5|3nh4nc3m3n75|r3pr0duc71v3|1n73r53c710n|1n574ll4710n|chr15714n17y|c0mm0nw34l7h|1n73r4c710n5|7r4n5p4r3ncy|5uppl3m3n74l|5p3c14l121n9|1nv35719470r|r3pr0duc710n|4pp01n7m3n75|d1c710n4r135|d15481l17135|c0mp371710n5|p4r7n3r5h1p5|73mp3r47ur35|c0n7r18u70r5|c0mp3n54710n|r3l4710n5h1p|1n73rf3r3nc3|4v41l481l17y|5h4r3h0ld3r5|1n73rv3n710n|pr351d3n714l|ph1l4d3lph14|5u853qu3n7ly|pr4c71710n3r|49r1cul7ur4l|1ncr3451n9ly|4ppr3c14710n|4rr4n93m3n75|d1ff1cul7135|c0nv3n710n4l|1n57ruc710n5|c0nv3r54710n|p3r10d1c4lly|c4nc3ll4710n|pr35cr1p710n|0r94n124710n|1mpr0v3m3n75|1n5717u710n5|c0n51573n7ly|545k47ch3w4n|c1v1l124710n|m0d1f1c4710n|90v3rnm3n74l|c0n51d3r48l3|ph4rm4c0l09y|m47h3m471c4l|1nd14n4p0l15|un1v3r517135|m4nuf4c7ur3d|c4lcul4710n5|c0rp0r4710n5|5cr33n54v3r5|p4r71c1p4n75|519n1f1c4nc3|d0wnl04d48l3|1mpl3m3n71n9|c0nf1d3n714l|m37r0p0l174n|p3r5p3c71v35|n071f1c4710n|d3m0n57r4735|r39157r4710n|n3v3r7h3l355|c00rd1n4710n|v3r1f1c4710n|5u85cr1p710n|0ccup4710n4l|0cc4510n4lly|5u851d14r135|un4u7h0r123d|l480r470r135|c0n7r18u710n|d157r18u710n|n3wf0undl4nd|1nv35719473d|m457ur84710n|4nn0unc3m3n7|c0n73mp0r4ry|4550c14710n5|c0n5717u710n|fund4m3n74l5|73chr3pu8l1c|5p3c1f1c4lly|3xp3r1m3n74l|1nc0rp0r473d|3n7r3pr3n3ur|f1nd4r71cl35|m457ur8471n9|8r04dc4571n9|dr4m471c4lly|c0n5ul74710n|4dm1n1573r3d|7r4n53xu4l35|4ckn0wl3d93d|7r4n5m15510n|c0n53rv4710n|810d1v3r517y|c0n7r18u71n9|m4nuf4c7ur3r|1n73ll3c7u4l|pu8l1c4710n5|54715f4c710n|1n7r0duc710n|n319h80rh00d|9309r4ph1c4l|73chn0l09135|pr0duc71v17y|35748l15h1n9|0853rv4710n5|r3l1481l17y|1n739r471n9|d1ff3r3n7ly|ph0709r4ph5|r350lu710n5|r3574ur4n75|c0mpr35510n|pr3f3r3nc35|519n1f1c4n7|0pp0r7un17y|c0mp37170r5|m4nuf4c7ur3|c0mf0r748l3|1n73r4c710n|3xp3r1m3n75|4f9h4n1574n|3xpl0r4710n|3ff3c71v3ly|0ccup4710n5|m3rch4nd153|5u8m15510n5|3duc4710n4l|5ch0l4r5h1p|3qu1l18r1um|5uppl3m3n75|1nd3p3nd3n7|r35p0n518l3|4l73rn471v3|c0n5ul74n75|pu8l1c4710n|m345ur3m3n7|1n57ruc70r5|p0pul4710n5|h19hl19h73d|ph0709r4phy|c00p3r4710n|4cqu151710n|1mpl3m3n73d|pr05p3c71v3|d1r3c70r135|5p3c74cul4r|c0n7r18u70r|1nv357m3n75|5u85cr183r5|4ppr0pr1473|p073n714lly|c0n57r41n75|d15c1pl1n35|c0n7r4c70r5|3nc0un73r3d|5p3c14l123d|d1m3n510n4l|r3c0mm3nd3d|m07h3r804rd|r3n41554nc3|m41n73n4nc3|7h3r4p3u71c|ph3n73rm1n3|4cc0rd1n9ly|c0rp0r4710n|4nn1v3r54ry|m3d1c4710n5|35748l15h3d|d157r18u70r|d3519n4710n|pr09r4mm1n9|1n5p3c710n5|ch4ll3n91n9|7r4n5f3rr3d|c0nf3r3nc35|r353rv4710n|pr0p051710n|8345714l17y|p3n37r4710n|c0n5ump710n|r357r1c710n|1mp0r74n7ly|47m05ph3r1c|1nc0rp0r473|1n57rum3n75|84ck9r0und5|l19h7w319h7|d0cum3n74ry|73rr170r135|l3915l471v3|p3r5p3c71v3|p4l3571n14n|m37h0d0l09y|7r4d1710n4l|0u7574nd1n9|r3534rch3r5|un5u85cr183|1n73ll193n7|c0mm17m3n75|3x4m1n4710n|1n73r3571n9|5u5741n48l3|73l3v1510n5|c0n7r18u73d|ph1l1pp1n35|57471571c4l|c0mm0d17135|7r4n54c710n|l3915l47ur3|r3c09n1710n|furn15h1n95|93n3r4710n5|1nd1v1du4l5|h05p174l17y|pr0cur3m3n7|3n91n33r1n9|1n9r3d13n75|c0n51573ncy|m070rcycl35|70urn4m3n75|c0nc3n7r473|5p0n50r5h1p|7h30r371c4l|3xh181710n5|r39ul4710n5|c3r71f1c473|d3f1n1710n5|4dv3r7151n9|w0rk574710n|p3r50n4l17y|r3cru17m3n7|3ff1c13n7ly|c4l18r4710n|5w1723rl4nd|c0mmun17135|d15p051710n|u71l124710n|4774chm3n75|c0n51d3r1n9|73mp3r47ur3|f45c1n471n9|c0mpu74710n|m41n741n1n9|unc3r741n7y|4cc0mp4n13d|pr3d1c710n5|p4r71c1p4n7|45519nm3n75|4r817r4710n|c0nf19ur1n9|c0nn3c710n5|c0nv3r93nc3|c00p3r471v3|fur7h3rm0r3|73rm1n4710n|3nc0ur491n9|3nv1r0nm3n7|m4lpr4c71c3|1nf0rm471v3|c0nclu510n5|90v3rnm3n75|4rr4n93m3n7|l1481l17135|c17123n5h1p|3l3c7r0n1c5|7r4n553xu4l|0p3r4710n4l|c0mp4r150n5|f0und4710n5|1nn0v4710n5|v13wp1c7ur3|pr0duc710n5|c0n57ruc73d|pr0pr1374ry|c0mp4r471v3|r3pu8l1c4n5|5p3c14l7135|477r4c710n5|4550c14710n|1nv174710n5|func710n1n9|cl4551f13d5|4u7h0r17135|c0mp371710n|r3qu1r3m3n7|5h4k35p34r3|j0urn4l1575|3xp3nd17ur3|3xpr35510n5|3nf0rc3m3n7|p055181l17y|c0nv3r718l3|8477l3f13ld|c1rcul4710n|53cr374r147|1mm3d1473ly|n0m1n4710n5|1d3n71fy1n9|4pp01n7m3n7|r35p1r470ry|3nh4nc3m3n7|d3m09r4ph1c|r3pr353n73d|1n73rpr373d|3v4lu4710n5|fundr4151n9|1mpr0v3m3n7|0u750urc1n9|3l1m1n4710n|und3r9r0und|c0mm15510n5|pr3l1m1n4ry|08l194710n5|p0w3r53ll3r|c0n53qu3nc3|v3r231chn15|3xp3r13nc35|unn3c3554ry|1n73r4c71v3|d15cl41m3r5|p3rf0rm4nc3|pr0c33d1n95|1nv35719473|c0mpl1c473d|5pr1n9f13ld|n390714710n|pr0m0710n4l|4ppl1c4710n|c0pyr19h73d|chr1570ph3r|c0mp1l4710n|4cc3550r135|1n5717u710n|4ckn0wl3d93|d3m0n57r473|3xp3r13nc3d|4n71c1p473d|p4r71c1p473|c0ll3c710n5|7r4n5m1773d|c0rr3c710n5|5cr33n5h075|pr09r4mm3r5|d3u75chl4nd|c0nn3c71cu7|m1551551pp1|5m17h50n14n|455ump710n5|3nl4r93m3n7|m47h3m471c5|5up3rv1510n|5p3c14l1575|c0njunc710n|c3l38r17135|d1ff3r3nc35|m1nn34p0l15|1n171471v35|835753ll3r5|c0n53cu71v3|hydr0c0d0n3|p051710n1n9|1n57ruc710n|p3r1ph3r4l5|4l8uqu3rqu3|c00rd1n4735|pl4y574710n|c0nv3n710n5|d35cr1p710n|5ynd1c4710n|n3w5l3773r5|c0n5ul74ncy|73mp0r4r1ly|c0mmun1c473|c0n7r0ll3r5|c0nv3n13nc3|r3570r4710n|ch0l3573r0l|c3l38r4710n|1n739r4710n|fr3qu3nc135|pr3p4r4710n|1m491n4710n|r3fl3c710n5|0853rv4710n|3nd0r53m3n7|4ppr3c1473d|r3fur815h3d|d0wnl04d1n9|1n7r0duc1n9|4dv3r7153r5|m49n1f1c3n7|d15cu5510n5|c0mp37171v3|1n73rr4c14l|c0mp051710n|5up3rv150r5|pr08481l17y|w357m1n573r|d3571n4710n|7r4n5cr1p75|c0n71nu4lly|p0l171c14n5|c0ll3c718l3|7r1p4dv150r|r351d3n714l|4cc0mm0d473|1mm19r4710n|p4r7n3r5h1p|5u9935710n5|r3pl4c3m3n7|n3c3554r1ly|m4rk37pl4c3|53n5171v17y|1n5p1r4710n|5urr0und1n9|d3v3l0pm3n7|n37h3rl4nd5|4ppr0x1m473|3j4cul4710n|50u7h4mp70n|c00rd1n470r|4dv4nc3m3n7|455355m3n75|7r4n5l4710n|4dju57m3n75|1llu57r473d|7r4n5p4r3n7|d357ruc710n|fund4m3n74l|5u8574n714l|r3pl1c4710n|8109r4ph135|c0n71n3n74l|1n3xp3n51v3|pr09r3551v3|l3915l4710n|4ch13v3m3n7|p3rm15510n5|l1m174710n5|3v4n35c3nc3|c00rd1n473d|3553n714lly|c0n7r0v3r5y|834u71fully|73rm1n0l09y|d373rm1n1n9|d3p4r7m3n75|m3m0r481l14|3xpl4n4710n|c4lcul4710n|c0n7r4c71n9|7hr3473n1n9|5cr33n54v3r|3xclu51v3ly|4ff1l14710n|0r13n74710n|3l3c7r1c17y|nu7r1710n4l|un4v41l48l3|d3cl4r4710n|c0n7r0ll1n9|49r1cul7ur3|c0n5717u735|c0rr3l4710n|51mul4710n5|c0nd1710n4l|1nf0rm4710n|3xc3p710n4l|fl3x181l17y|4u70m081l35|3n73rpr1535|r35p0nd3n75|d157r18u73d|c4lcul470r5|d1571nc710n|c0m81n4710n|73l3ch4r93r|5u8d1v1510n|9r0undw473r|3l19181l17y|1nv0lv3m3n7|chr15714n5|m3m83r5h1p|pr0j3c710n|4850lu73ly|pr09r4mm35|c0mp4r48l3|84ck9r0und|d3l1v3r1n9|93n3r470r5|3v3ry7h1n9|p3rf0rm1n9|1mpr3551v3|7r4d3m4rk5|1mmun0l09y|w4rr4n7135|p4553n93r5|7r3m3nd0u5|qu4n717135|v137n4m353|73l3v1510n|1n73r3573d|d0cum3n73d|7hr0u9h0u7|p373r58ur9|pr0duc710n|p0w3rp01n7|c0mm3rc14l|und3rly1n9|73chn0l09y|qu33n5l4nd|p3r1ph3r4l|c0n741n3r5|0817u4r135|pun15hm3n7|n3w5l3773r|p4p3r84ck5|ph0709r4ph|p3rc3p710n|3xp1r4710n|n3w5p4p3r5|5cr33n5h07|n4710nw1d3|pr0p0r710n|r391573r3d|pu8l15h3r5|pr0v1d3nc3|4550c14735|3xp3r1m3n7|r3f3r3nc3d|r3pr0duc3d|c0mpr0m153|pr073c710n|0ff1c14lly|3nd4n93r3d|r3l0c4710n|8u51n35535|h4r455m3n7|c4p481l17y|c0ll349u35|l1k3l1h00d|r3574ur4n7|und3r74k3n|70urn4m3n7|pr0c3dur35|r3pu74710n|4d4p74710n|h0u53w4r35|vuln3r48l3|1nn0v4710n|yu905l4v14|c0nn3c71n9|c0n50r71um|v10l4710n5|d3pl0ym3n7|ph4rm4c135|4ff0rd48l3|4n7180d135|d15cr3710n|pr1v1l3935|r3m3m83r3d|3xh181710n|w1d35pr34d|7h3m53lv35|c0n7r4c70r|v373r1n4ry|3v3rywh3r3|3v4lu4710n|5u993571n9|p0r7u9u353|d15481l17y|1n171471v3|c0n71nu0u5|r3f3r3nc35|3xp3r13nc3|5urpr151n9|r3c1p13n75|l173r47ur3|r35p3c71v3|7r4v3ll1n9|08l194710n|m4nch3573r|4pp34r4nc3|r3p05170ry|d3f1n1710n|f3d3r4710n|c4lcul473d|n37w0rk1n9|1n5p3c710n|4u57r4l14n|r39ul470ry|5u8m15510n|c0nduc71n9|w1ld3rn355|d3p3nd3nc3|p0r75m0u7h|423r841j4n|n0m1n4710n|45519nm3n7|3xpl41n1n9|4c71v17135|9u1d3l1n35|1ncr3d18l3|r3c09n153d|c0ll3c70r5|c0mm177335|r3cru171n9|c0n7r0ll3r|ch4ll3n935|4dd1710n4l|c0n5ul74n7|h3l1c0p73r|r394rdl355|c0n7r18u73|d1m3n510n5|r39r35510n|pr10r17135|3mpl0ym3n7|d1ff3r3nc3|h34dph0n35|c0mpl41n75|hyp07h3515|5u85cr183r|7r4d1710n5|f4c1l17473|81rm1n9h4m|d1r3c710n5|c0mm15510n|93n3r471n9|c0n574n7ly|pr0v1nc14l|c0mpl3x17y|4ddr3551n9|4u70m071v3|pr0c33d1n9|c0nv1c710n|5ucc355ful|d15c0un73d|1mm19r4n75|c0lumn1575|pr0m0710n5|d15c0v3r3d|pu8l15h1n9|d3m0cr471c|d3v3l0p1n9|5u8574nc35|p3r51573n7|p5ych147ry|pr35cr183d|1rr194710n|3l3c7r0n1c|h1570r1c4l|d15cl05ur3|v0lk5w493n|m37480l15m|53cur17135|5c13n71f1c|1nflu3nc35|3x7r4c710n|4cc35518l3|pr0c3550r5|5u851d14ry|l4ud3rd4l3|84nkrup7cy|r3duc710n5|7r4n5l473d|r3qu3571n9|5u9935710n|c0n51573n7|c0mpl3m3n7|func710n4l|lux3m80ur9|h0u53w1v35|0ccurr3nc3|m0n170r1n9|ch4rl3570n|1nflu3nc3d|f0rw4rd1n9|90v3rnm3n7|ch4ll3n93d|c0nf1d3nc3|91rlfr13nd|ch4nc3ll0r|cl4551f13d|7r4n53xu4l|d1c710n4ry|4cc0un71n9|r357r1c73d|un1v3r517y|m1lfhun73r|w45h1n970n|m41n57r34m|4d0l35c3n7|3xpl1c17ly|73rr0r1575|51mpl1f13d|p4r71cul4r|83n3f1c14l|p4r49r4ph5|73chn1qu35|m1ll3nn1um|1n73rv13w5|3n9493m3n7|c0mpl3710n|84n9l4d35h|p3rm15510n|3v4lu471n9|93n3r4710n|0cc4510n4l|c0mm17m3n7|4dv3r7153r|c0nn3c70r5|7hr3473n3d|3ff1c13ncy|r371r3m3n7|519n47ur35|r3pu8l1c4n|4u7h0r123d|c4l1f0rn14|f4c1l17135|w17hdr4w4l|3ncryp710n|7h3r34f73r|4f73rw4rd5|c0n5717u73|m175u815h1|4774chm3n7|cumul471v3|v0lun733r5|c0n7r0ll3d|ch4r4c73r5|0ccup4710n|3xc3p710n5|pr3d1c710n|d35c3nd1n9|4p4r7m3n75|j0urn4l157|57471571c5|1n574ll1n9|m4cr0m3d14|4773nd4nc3|4c71v4710n|1nv357m3n7|4l90r17hm5|c0n5p1r4cy|d15p47ch3d|3c0l091c4l|c0n51571n9|9309r4ph1c|5upp0r73r5|4cd83n717y|5u8m1771n9|d3c0r471n9|3l3m3n74ry|4ff1l1473d|w38m4573r5|4ppl14nc35|p05535510n|d3p4r7m3n7|r3c09n123d|d3519n473d|1n7r0duc35|4n74rc71c4|r3l4x4710n|1n739r473d|p057p0573d|80und4r135|m4n493m3n7|p5ych0l09y|d15c1pl1n3|930l091c4l|4r71f1c14l|ul71m473ly|curr1culum|c0mpl14nc3|4ll0c4710n|4dju5748l3|c0un53l1n9|34r7hqu4k3|53l3c710n5|curr3nc135|p0lyph0n1c|hum4n17135|v0c48ul4ry|fr49r4nc35|r1ch4rd50n|1nd0n3514n|4cc3p74nc3|57r4739135|m024m81qu3|4cc3p748l3|5c13n71575|574710n3ry|u283k1574n|h19hl19h75|pr353n71n9|3qu1v4l3n7|f3ll0w5h1p|4ff1l14735|m4d4945c4r|d3v3l0p3r5|r3c0rd1n95|c0nc3rn1n9|mul71m3d14|5y573m471c|pr0j3c70r5|7hum821ll4|1ndu57r14l|477r4c71v3|1n73r57473|d15cu5510n|4l3x4ndr14|4dv3n7ur35|51mul4710n|l34d3r5h1p|m3d1c4710n|4ppr04ch35|4ppr3c1473|m3ch4n1c4l|53p4r4710n|1d3n71f135|1n5717u735|3nc0ur4935|c0pyr19h75|835714l17y|4550c1473d|c0nc3p7u4l|n0771n9h4m|c0mp4r150n|f0und4710n|7h0r0u9hly|r3v0lu710n|1n57ruc70r|4m3ndm3n75|m4573rc4rd|chr0n1cl35|c0n57r41n7|m070rcycl3|5p3c14l157|d157r18u73|3x3cu71v35|9r33nh0u53|und3r5700d|d3c0r471v3|cu570m123d|3571m4710n|73chn1c14n|qu4l1fy1n9|5upp0r71n9|pr0h18173d|477r4c710n|h0r120n74l|my573r10u5|w3ll1n970n|d373rm1n3d|c17y534rch|w473rpr00f|m1n157r135|p3rc3n7493|8r174nn1c4|57473m3n75|c0mpl373ly|p0pul4r17y|n4710n4lly|4ccur473ly|3l3c7r1c4l|4ppl1c48l3|c0ll3c710n|d3l394710n|l17194710n|p0pul4710n|480r191n4l|d3pr35510n|r3m4rk48l3|pr3v3n71n9|5u5p3n510n|1nd193n0u5|n4v194710n|845k3784ll|0p3r4710n5|pr0duc71v3|r3v3l4710n|4773mp71n9|4nn074710n|r3534rch3r|v393748l35|3xc173m3n7|834574l17y|und3r574nd|1d3n71f13d|phy51c4lly|r35p0nd1n9|8url1n970n|v4l1d4710n|5u853c710n|5up3rv150r|c0rrup710n|v0ll3y84ll|p17758ur9h|455ump710n|c0nn3c710n|r3pr353n75|ch4r1748l3|c0rr3c710n|0pp051710n|1nc3n71v35|1mp05518l3|v15181l17y|l0u15v1ll3|7hum8n41l5|pr0p3r7135|4pp4r3n7ly|r3l471v3ly|4cc0rd4nc3|c194r37735|f4v0ur1735|1n73rn5h1p|hun71n970n|5uppl3m3n7|1nd1c4710n|5u853qu3n7|m0n790m3ry|purch451n9|9u4r4n7335|50und7r4ck|455355m3n7|m3ch4n15m5|k1l0m373r5|35p3c14lly|57ruc7ur4l|54cr4m3n70|c1nc1nn471|fr3qu3n7ly|1n73rf4c35|c47390r135|r35p0nd3n7|4n4ly71c4l|l480r470ry|1mpr35510n|c0n71nu1n9|c0nf3r3nc3|k424kh574n|1n57rum3n7|3nr0llm3n7|1nd1c470r5|m0d3r470r5|57ruc7ur35|c0ll3c71v3|1n5ul4710n|d1ff1cul7y|0r94n121n9|pr0f35510n|7r4n51710n|h0u53h0ld5|53p4r473ly|810l091c4l|phy51c14n5|7r4ck84ck5|m1cr0ph0n3|c4mc0rd3r5|j0urn4l15m|m3d174710n|c4nd1d4735|1ndu57r135|8l4ck83rry|517u4710n5|cr3471v17y|08j3c71v35|3xpr35510n|pr0v1510n5|pr1nc1pl35|1d3n71f13r|d35cr181n9|c0n51d3r3d|c0nd1710n5|j4v45cr1p7|4dm15510n5|5377l3m3n7|c0mp4718l3|r351574nc3|phy510l09y|7r347m3n75|ph3n0m3n0n|4dju57m3n7|c0n71nu17y|c0n5ul71n9|r3cr34710n|c0ll3c71n9|pr3f3r3nc3|5u8j3c71v3|1nf3c710u5|m34n1n9ful|pr09r4mm3r|d15cu551n9|4ccr3d173d|4ppl1c4n75|3n73rpr153|1nc0mpl373|5un9l45535|1mp0r74nc3|r3450n48l3|qu074710n5|3d170r14l5|7r4n5l470r|c0nv3r510n|c0mpr3553d|90v3rn4nc3|p4rl14m3n7|l39171m473|57r3n97h3n|1nv174710n|v39374710n|7r4n5cr1p7|c0n74c71n9|pr073c71n9|pr073c71v3|3553n714l5|p4r4m373r5|pr0c3551n9|9r4du4710n|r350lu710n|c0nf19ur3d|c0mpl371n9|c0nv3n13n7|4m84554d0r|w4llp4p3r5|v4r14710n5|4rch173c75|1n7r0duc3d|l1m0u51n35|v0c4710n4l|w1d35cr33n|9r33n580r0|v39374r14n|c0mp0n3n75|p3r50n4lly|4551574nc3|l1m174710n|5uff1c13n7|3x73n510n5|499r3551v3|1nf3c710n5|57ruc7ur3d|r3450n48ly|4cc0mpl15h|4dv4n74935|c0mm3n74ry|un3xp3c73d|4u70m4710n|r3c0mm3nd5|c00rd1n473|4850rp710n|5ch3dul1n9|f0rm4771n9|d0wnl04d3d|fr13nd5h1p|c4r7r1d935|pr3v10u5ly|r3fl3c710n|l4nd5c4p35|c4lcul470r|47m05ph3r3|c0nv3n710n|83h4v10r4l|c0nclu510n|1nd1c471n9|4u70m081l3|0r191n4lly|d373rm1n35|ph1l050phy|r39ul4710n|5urr0und3d|1nd1v1du4l|3xc3ll3nc3|5u85717u73|9u4r4n733d|m071v4710n|3nc0ur493d|1nn0v471v3|d3f1n173ly|c0n741n1n9|49r33m3n75|pr3v3n710n|d149n0571c|d15cl41m3r|d15pl4y1n9|1ncr3451n9|3v3n7u4lly|h34l7hc4r3|477r18u735|m41n741n3d|w0rdpr355|4u70m471c|c0nn3c73d|4c4d3m1c5|d1r3c70r5|4rl1n970n|4nn0unc3d|p4r71cl35|n4rr471v3|w0nd3rful|53c0nd4ry|4m3ndm3n7|r3c0rd1n9|l18r4r135|nu7r1710n|l1v3570ck|51n94p0r3|3x3mp710n|r3duc710n|u71l17135|3xclu51v3|d3l1v3r3d|pr1nc1p4l|pr4c71c4l|m374ll1c4|ch1ldh00d|p0r7f0l10|p3rm4n3n7|8u1ld1n95|4ddr35535|h0u53h0ld|84773r135|c194r3773|n1c4r49u4|9r4du4735|pr3p4r1n9|v4lu4710n|r3c1p13n7|p3rf0rm3d|47hl371c5|p051710n5|3xc3551v3|50u7h3457|r3l471v35|fr33l4nc3|d15pl4y3d|r351d3n75|p4n450n1c|p3rm4l1nk|519n47ur3|fr3qu3ncy|pr0v1510n|5qu1r71n9|73nn35533|c3r741nly|n3w5p4p3r|p4553n93r|4u70m473d|n19h7l1f3|8r4c3l375|l1481l17y|7r4d3m4rk|c0mp0und5|pr150n3r5|7r4ck84ck|pl41n71ff|73l3ph0ny|1nfl4710n|c0n741n3d|4m3r1c4n5|4l73rn473|pr0m0710n|8r347h1n9|0ff1c14l5|7h1ckn355|pr073c73d|m19r4710n|9r4ph1c4l|8r04d84nd|1nflu3nc3|3571m4735|chr0n1cl3|8451c4lly|w38m4573r|1nh3r173d|9r3371n95|f4v0r1735|c0n57ruc7|43r05p4c3|1nqu1r135|4r7hr1715|qu4r73rly|m41n741n5|5u5741n3d|r3pr353n7|5h0r7cu75|150l4710n|4p4r7m3n7|v0y3urw38|3c0n0m1c5|4cc3p71n9|5ch3dul35|l0u1514n4|chr1571n3|3x73nd1n9|d1m3n510n|57r47391c|3v0lu710n|5p3c1f135|3d170r14l|5u993573d|d3c1510n5|m4c3d0n14|4ff3c71n9|c0m81n1n9|4rm57r0n9|c0nc3rn3d|c04l1710n|5c13n7157|pr0duc3r5|574nd1n95|4c71v473d|c0ll3c70r|84ndw1d7h|p4r71710n|1nv1518l3|m4ch1n3ry|4550c1473|c0mm0d17y|5uppl13r5|pr0m071n9|1n574ll3d|499r39473|5h0w71m35|fr4m3w0rk|1n73rv13w|r3c31v1n9|4n0nym0u5|p3n4l7135|c0mpl14n7|r37urn1n9|d15cu553d|3571m473d|3l124837h|c0n741n3r|d3f3nd4n7|4dv4n7493|80ul3v4rd|p3r50nn3l|w15c0n51n|d3p4r7ur3|d1r3c710n|d3d1c473d|f0r3c4575|93n3r470r|35748l15h|c0mp371n9|3xpr3553d|cl4551c4l|1n574nc35|p4r49r4ph|p3n1n5ul4|c4mp419n5|8ul94r14n|c0n51d3r5|c0nduc73d|3x73n510n|pr05p3c75|v4c4nc135|r3qu3573d|wh0l354l3|p3r50n4l5|1mm3d1473|ch3vr0l37|y3573rd4y|h34dl1n35|4551574n7|4dv3n7ur3|m1nn35074|f1n15h1n9|455ur4nc3|08741n1n9|h4pp3n1n9|5h3ff13ld|l17hu4n14|d3v3l0p3r|534rch1n9|8r34kf457|1n7r0duc3|m0d3ll1n9|r3l1910u5|f4v0ur173|pr0c3dur3|v1c70r14n|m1n147ur3|d157r1c75|c0mpu71n9|3x7r3m3ly|c3r71f13d|c0n7r4c75|p3rc31v3d|j3ff3r50n|94rd3n1n9|ch3m157ry|0rch357r4|c3n7ur135|m49n17ud3|v4r148l35|c0n71nu35|ch4ll3n93|l4n9u4935|c174710n5|un1v3r54l|r35p0n535|4553551n9|d1v1510n5|5h0p21ll4|4ff1l1473|3553n714l|r3p0r71n9|pr4c71c35|unl1m173d|h4ndh3ld5|4n5w3r1n9|0v3rn19h7|4ppr4154l|1mpr3553d|l173r4lly|pl47f0rm5|pr1n748l3|c0mp4n10n|0r94n123r|7h354uru5|93n3r473d|v0lun74ry|h4rdc0v3r|r34c710n5|7h0u54nd5|c3l38r17y|4857r4c75|r35p0nd3d|ch0c0l473|pr3c3d1n9|d15cu5535|h4mp5h1r3|8lu37007h|pr0v1d3r5|f15h3r135|5upp0r73d|3m0710n4l|p4p3r84ck|4mpl1f13r|pr39n4ncy|8109r4phy|4r817r4ry|1n73r3575|4ch13v1n9|pr0m1n3n7|m355491n9|l3x1n970n|pr0c3553d|pr0c35535|f1n4nc1n9|9u4r4n733|c0mp0n3n7|c0n74c73d|3ff1c13n7|r3c0rd3r5|5p3c14l7y|4dd1710n5|r3qu1r1n9|p057c4rd5|r3v13w1n9|r3f1n4nc3|c0nfl1c75|c0n71nu3d|1n739r17y|93n3r4lly|9309r4phy|pr0f3550r|qu4l1f13d|c4l3nd4r5|d15c0v3ry|c0rr3c7ly|r3c0mm3nd|8l00m83r9|furn15h3d|r3c3p710n|h13r4rchy|484nd0n3d|l1f357yl3|m4ur171u5|7r4v3l3r5|cl34r4nc3|ch3ckl157|1nv3n70ry|c0nv3r73r|m345ur1n9|08j3c71v3|1nd1c473d|57r3n97h5|5c3n4r105|5473ll173|d1ff1cul7|8r34kd0wn|0ff3r1n95|7r4n5f3r5|r1n970n35|3l3v4710n|v0lun733r|d373rm1n3|3m3r93ncy|517u4710n|83v3r4935|chr1571n4|p4r4m373r|m3d1c1n35|pr0c3550r|r34l1571c|800k570r3|4773n710n|r3n3w48l3|fr4nch153|1nc0rr3c7|p455w0rd5|d35cr183d|p4r3n71n9|m4nh4774n|457r0l09y|w0rkf0rc3|fr4nc15c0|m49421n35|3nc0ur493|p4r714lly|v18r470r5|0ccurr1n9|c0n5um3r5|73rr170ry|53cr374ry|c05m371c5|1nduc710n|pr3c153ly|5p3c1f1c5|pr353n73d|94ll3r135|73574m3n7|r35ul71n9|c4m8r1d93|5pr34d1n9|5yn7h371c|3x3cu710n|pr0v1nc35|1ncr34535|7r4n5p0r7|pr3c1510n|1nc1d3nc3|d15ch4r93|5cr1p71n9|1nd1c4735|50m371m35|c0mm1773d|3x73n51v3|h4ll0w33n|c4nd1d473|d47484535|1nc1d3n75|h424rd0u5|3nh4nc1n9|m3553n93r|r351574n7|5p3c1f13d|d15c0un75|d3m0cr475|c474l09u3|pr0duc1n9|9u473m4l4|r3cycl1n9|7r345ur3r|p4l3571n3|l157pr1c3|4cc1d3n75|5l1d35h0w|8391nn1n9|c4r18834n|pu8l1c17y|1ncr3453d|v4r14710n|m1cr0w4v3|r394rd1n9|r3m41n1n9|4ll0w4nc3|4rch173c7|wr357l1n9|d3p3nd1n9|3xp4n510n|dupl1c473|cr173r10n|5u8m1773d|purch453d|ph0705h0p|func710n5|0ur53lv35|c0ll3c73d|ch4r4c73r|947h3r1n9|c0rr3c73d|p47h0l09y|m0r74l17y|5culp7ur3|07h3rw153|f347ur1n9|cr171c15m|1mpl3m3n7|5ch3dul3d|d157ur83d|0rd1n4nc3|c4mc0rd3r|5747u70ry|cr347ur35|c0mm3n73d|n0r7h3457|73mp0r4ry|200ph1l14|p41n71n95|1nj3c710n|c0mpl373d|fr3d3r1ck|4w4r3n355|v4nc0uv3r|y0rk5h1r3|r3l4710n5|573ph4n13|3mpl0y335|p4ck491n9|5p3c14lly|1n1714lly|1nd1c470r|3l1m1n473|n0r7hw357|4ppl14nc3|cl455r00m|c3l38r473|d3m0cr4cy|f3571v4l5|w4llp4p3r|7hr35h0ld|w17n35535|pr09r4mm3|v3n32u3l4|4u7h0r17y|c0n5c10u5|84l71m0r3|c0mpl41n7|53qu3nc35|m3n710n3d|ch4rl0773|457r0n0my|pr0v1d1n9|d357r0y3d|3m15510n5|7r4n5l473|4nn0unc35|l0c4710n5|4773mp73d|834u71ful|4cc3551n9|phy51c14n|h0llyw00d|0p3r4710n|w1k1p3d14|570ck1n95|5p1r17u4l|7r4d1710n|3nc0un73r|r3f3rr4l5|cu570m123|1n73rf4c3|0r94n153d|r3v1510n5|3xc3ll3n7|7hr3350m3|p3rf3c7ly|r3450n1n9|1n574n7ly|pu8l15h3r|w0rldw1d3|4nn07473d|pr3f3rr3d|j3ru54l3m|c0nv1nc3d|r3pl4c1n9|r39ul4rly|chr15714n|7h3r3f0r3|l1573n1n9|w473r5h3d|73l3ph0n3|1nv3n710n|d3v3l0p3d|h3nd3r50n|pr1v1l393|4l19nm3n7|0p3r471n9|73rr0r157|d0cum3n75|p3d147r1c|3c0mm3rc3|3nqu1r135|l4nd5c4p3|d3p3nd3n7|8r0chur35|7r4v3ll3r|5u5p3c73d|83nchm4rk|4ppl1c4n7|8391nn3r5|p073n714l|c09n171v3|5uff3r1n9|c0mp373n7|57ruc7ur3|w3dn35d4y|v393748l3|furn17ur3|c0nn3c70r|3xpl0r1n9|9r4du4lly|4m573rd4m|l1c3n51n9|3duc470r5|73x7800k5|4r9um3n75|d1v3r517y|cl3v3l4nd|7r4n5f0rm|r39157r4r|chr157m45|d351r48l3|n47ur4lly|und3rw34r|53n5171v3|73mpl4735|m3rch4n75|r3l1910n5|r3f3rr1n9|3xpl0510n|d4u9h73r5|hun94r14n|4cc0rd1n9|73chn1qu3|1nclu51v3|n3c3554ry|3x3cu71v3|ch4mp49n3|c4lcul473|pr3d1c73d|4l3x4nd3r|8r04dc457|c0nv3r73d|r0ch3573r|d3v14710n|53l3c710n|53l3c71n9|3ff3c71v3|c0nd1710n|p4n7yh053|4cc3550ry|7yp1c4lly|5p0n50r3d|hydr4ul1c|r083r750n|un1pr07k8|1n5717u73|0m15510n5|r37r13v4l|qu4l17135|4f73rn00n|84rc3l0n4|pr0707yp3|4pp4r47u5|0wn3r5h1p|3xp4nd1n9|d3l1c10u5|3mp1r1c4l|4dv3r7153|m1n1573r5|p0l171c4l|53xu4l17y|3d1n8ur9h|p0ly3573r|m0l3cul4r|574nd4rd5|c0un7r135|pr0570r35|r351d3nc3|4770rn3y5|83h4v10ur|0p3r470r5|f0r90773n|r3m41nd3r|m473r14l5|cu570m3r5|c0rp0r473|pu8l15h3d|m0l3cul35|3mpl0y3r5|r37r13v3d|c0nf1d3n7|3x3rc1535|1n73rv4l5|curr3n7ly|r3l3v4nc3|50c10l09y|3l3c710n5|7hum8n41l|5741nl355|53n73nc35|h05p174l5|1n739r473|3xclu510n|3xc3p710n|47717ud35|kn0wl3d93|1nd0n3514|7r347m3n7|1nc3n71v3|pr1m4r1ly|5cr33n1n9|h0l0c4u57|5u5p3nd3d|r3c31v3r5|cu570m153|l4nc4573r|n0npr0f17|0r94n123d|8u773rfly|1mpr0v1n9|3xp3n51v3|m3ch4n1c5|n4v19470r|1n171473d|481l17135|3xpl41n3d|5u85cr183|3xp3r7153|m3ch4n15m|r3c09n123|m4r1ju4n4|j3w3ll3ry|50m3wh3r3|847hr00m5|c47h3dr4l|pr070c0l5|f41rf13ld|h19hl19h7|1nclu510n|h0p3fully|num3r1c4l|r1v3r51d3|8r1ll14n7|l4f4y3773|d0m1n1c4n|800km4rk5|54lv4710n|d150rd3r5|3v4lu473d|d373c710n|1n5p3c70r|53l3c71v3|54cr1f1c3|f0rm4710n|3n91n33r5|m3d14w1k1|l19h7n1n9|pr0p054l5|m0d3r470r|7u70r14l5|r3m0v48l3|d0wnl04d5|918r4l74r|57473m3n7|m1cr050f7|f4n74571c|73chn1c4l|w0nd3r1n9|pr1nc370n|70l3r4nc3|d3cr3453d|4u7h3n71c|r3p0r73r5|50u7hw357|4pp01n73d|n3c35517y|r3nd3r1n9|57481l17y|c0nf19ur3|v10l4710n|m4c1n705h|m0v3m3n75|50lu710n5|4m3n17135|v1r7u4lly|3xch4n935|4n1m4710n|h3p471715|m34nwh1l3|r373n710n|pr0j3c70r|m4rk371n9|5h4r3w4r3|w4r3h0u53|n0rw3914n|5urpr153d|3c0n0m135|49r33m3n7|ch1ldr3n5|m1lw4uk33|4u57r4l14|84c73r14l|p37r0l3um|d3519n3r5|m3l80urn3|m473rn17y|p0rc3l41n|54715f13d|93n34l09y|und3r74k3|pr351d3n7|8l4ckj4ck|4r93n71n4|p1chun73r|1d3n71c4l|d4n93r0u5|8r421l14n|c0mpu73r5|51m1l4rly|50c137135|c0mp4n135|r3f3r3nc3|n45hv1ll3|3v3ry80dy|3xclud1n9|c0mm4nd3r|c0mm17733|c4nc3ll3d|r353rv01r|w0rk5h0p5|hurr1c4n3|n3wc457l3|w0rc3573r|r35p3c73d|m0r794935|p0r7r4175|c4r3fully|und3f1n3d|50m37h1n9|1nv3570r5|ch3m1c4l5|5yn7h3515|d149n0515|r3fl3c73d|pr1nc1pl3|v4c4710n5|p3rf0rm3r|1mp0r74n7|5p07l19h7|9r4du473d|3qu1pm3n7|c0n53n5u5|l091571c5|k3y804rd5|purch4535|n073800k5|f1n4nc14l|n4m35p4c3|4l90r17hm|0pp0n3n75|4dd1c710n|v4l3n71n3|n0m1n473d|c0nfu510n|3l3c70r4l|ch4n93l09|1nv0lv1n9|1nv3571n9|qu35710n5|4dm15510n|53p73m83r|r3c0v3r3d|5ymp051um|73rr0r15m|up9r4d1n9|fr0n7p493|d3m4nd1n9|r39ul473d|4ll0c473d|d3f3n51v3|f0r81dd3n|m0n170r3d|mun1c1p4l|d35cr1835|m071v473d|3x4m1n1n9|d1ff3r3n7|1n73n51v3|5w17ch1n9|5u8574nc3|d35p3r473|4ddr3553d|pr0j3c73d|c0nclud3d|1n73n710n|73571m0ny|m4nd470ry|9u357800k|5urv1v0r5|1n5ur4nc3|f1l73r1n9|d373c71v3|p0llu710n|d1r3c70ry|f1r3pl4c3|1nclud1n9|r350urc35|5umm4r135|f0ll0w1n9|3l53wh3r3|4n71v1ru5|0ff3n51v3|l00k5m4r7|c0ll349u3|p41n784ll|57473w1d3|53p4r473d|3ncl05ur3|5ynd1c473|d1574nc35|53r10u5ly|3x1573nc3|7r345ur35|d1r3c71v3|1n73n517y|c0mmun157|57r34m1n9|cr34710n5|c0mmun17y|477r18u73|c0mp4r1n9|3duc4710n|90v3rn1n9|m0un741n5|r3741l3r5|pr353n7ly|r4d14710n|8run5w1ck|l18r4r14n|570ckh0lm|7h3r4p157|d0n4710n5|pr0m151n9|ch4mp10n5|4773nd1n9|n19h7m4r3|0r94n15m5|08v10u5ly|73l35c0p3|7r4v3l1n9|f1n93r1n9|93n3r4735|r3c3p70r5|n319h80r5|c0pyr19h7|4v41l48l3|4lum1n1um|5n0w804rd|h4pp1n355|d3519n1n9|fr49r4nc3|5h1pm3n75|l393nd4ry|c47h3r1n3|93n7l3m4n|c4r7r1d93|r3pr0duc3|c0nv1c73d|r00mm4735|5p0k35m4n|4c71v1575|p3rm1773d|fr4nkfur7|4553m8l3d|w0rkpl4c3|c0mp05173|0cc4510n5|c0nf1rm3d|3qu4710n5|73rm1n4l5|mu51c14n5|cr055w0rd|c0n71n3n7|1nf3c710n|l0n917ud3|v8ull371n|1n53r710n|5w421l4nd|v4r137135|pl4c3m3n7|4pp34r1n9|l34rn3r5|r3c3p70r|574710n5|9r4du473|57r0n93r|c0774935|3x73r10r|4dv4nc35|9r347357|574nd4rd|7h1nk1n9|0p3r470r|pr3v13w5|r34ch1n9|p1c7ur35|73x71l35|3qu4710n|d15pu735|54ndw1ch|pr0v1d3r|0p710n4l|c0unc1l5|8453m3n7|p3r50n4l|pl4nn3r5|53c710n5|p0r710n5|7r4ck1n9|3l3c7r0n|3nc0d1n9|7hr34d3d|8l33d1n9|9r3371n9|5udd3nly|57unn1n9|3xpl1c17|3v1d3nc3|1mp0r73d|w3dd1n95|1n5p1r3d|4ccur473|pr09r4m5|5yr4cu53|c0rnw4ll|53n470r5|f4v0r173|m4r94r37|m4x1m123|c0n7r4ry|m4n491n9|r3c3n7ly|54mpl1n9|pr0848ly|r3p3473d|f0cu51n9|w3851735|r3l1910n|3x4m1n3d|h4pp3n3d|0p3n1n95|r074710n|93n3r0u5|l35814n5|3xp4n5y5|c45h13r5|p0571n95|d3u75ch3|m345ur35|5w17ch3d|1nv1510n|cl34n3r5|m4n493r5|41rcr4f7|r3v34l3d|c0nfl1c7|ch3m1c4l|v3r510n5|3mpl0y3r|r0m4n71c|c04ch1n9|70937h3r|4nn0unc3|d35cr183|c0mp1l3d|c17123n5|cr347ur3|h3r17493|3x3rc153|7174n1um|4c71v3ly|w0rldc47|1nc0m1n9|cul7ur35|pl3454n7|n37w0rk5|4ud13nc3|45519n3d|r3nd3r3d|3m0710n5|4dm1773d|r37r13v3|m3371n95|func710n|l0c4710n|3qu4l17y|7r4n5f3r|d1r3c73d|d1571nc7|c0n9r355|5p0r71n9|pr0m0735|4ff3c73d|u53rn4m3|3xclud3d|3xp3n535|1nd1c473|pr0duc3d|c0mpu73d|h05p174l|571ck3r5|h0m3l4nd|3nv3l0p3|0v3rv13w|3dm0n70n|c0mm0nly|4r9um3n7|3c0n0m1c|d1534535|cr3471n9|4d4p71v3|pr0j3c75|ch4r93r5|l4n9u493|4770rn3y|7h41l4nd|r3570r3d|8075w4n4|4dv150ry|8ud4p357|c0un73r5|d15p47ch|73mpl473|8r33d1n9|4nywh3r3|8l0991n9|1nclud3d|47l4n71c|5h1pm3n7|53450n4l|1nv3570r|4uc710n5|pr05p3c7|5w17ch35|w1ldl1f3|c4m3r00n|0v3rh34d|l1m171n9|c0mm3n75|5p34k1n9|5p0n50r5|d1574nc3|8l0ck1n9|fl0r1575|p3r10d1c|m4r171m3|3nd0r53d|d15p054l|7h30l09y|c00k800k|h4ndh3ld|ch3ck1n9|mu51c14n|f41lur35|r3m0v1n9|d3cl4r3d|1nf0rm3d|9u1d4nc3|574nf0rd|f48ul0u5|1nv0lv3d|7h0u9h75|f1r3w1r3|0853rv3d|v4r14nc3|qu4n717y|upl04d3d|9l0554ry|7r345ury|ch1ldr3n|p4r7n3r5|ch4nn3l5|3r1c550n|4pp3nd1x|1n73rv4l|57ud3n75|pl47f0rm|5h0pp1n9|5uppl13r|4rr4n93d|3x1571n9|53l3c73d|d14l09u3|m4ch1n35|n17r093n|r00mm473|4rk4n545|p4713n75|c0ll4p53|7h3473r5|4m3r1c45|r3c0v3ry|n073800k|h1570r1c|4774ch3d|4dj4c3n7|d1548l3d|4dju573d|r3j3c73d|upc0m1n9|0u7r34ch|m3rch4n7|83rk3l3y|r3c31v3d|w0rkfl0w|4rch1v35|5ur930n5|c0n73575|800k1n95|pr0m153d|d1r3c7ly|c0n574n7|v3h1cl35|unl1k3ly|p0r7l4nd|m49421n3|c0nc3p75|94m35p07|pr057473|pr3v10u5|c4mp419n|d3n71575|94n984n9|d3l1v3r5|7r4n5m17|3x4mpl35|3m1r4735|qu35710n|7hr1ll3r|53m1n4r5|534rch35|50f7w4r3|r3l471n9|m070r0l4|4ll14nc3|83v3r493|3ncl053d|r3f3rr4l|818l1c4l|574rr1n9|3n91n33r|m0r30v3r|8u51n355|1n73nd3d|4dv0c4cy|0ff5h0r3|57r4739y|3n53m8l3|4d3l41d3|3l3c710n|f0r357ry|83c0m1n9|84rr13r5|p0l1c135|c3m373ry|1nf3c73d|ph1ll1p5|5l33p1n9|m4rr1077|un717l3d|734ch1n9|r3l4710n|0cc4510n|p051710n|p0dc4575|5733r1n9|up5k1r75|57r1k1n9|c0nc3r75|1n71m473|c4n4d14n|r3l14nc3|fr4c710n|l1571n95|d14m0nd5|r3qu3575|53p4r473|8u1ld1n9|7h1nkp4d|h19hw4y5|r3c0rd3r|p05171v3|c0ll3935|r0u71n35|f38ru4ry|5pr1n93r|r357r1c7|n319h80r|1d3n71fy|m1n0r17y|8r07h3r5|v373r4n5|pr353n75|m1n1m123|c4m80d14|3571m473|4857r4c7|d0m3571c|w1r3l355|0ccup13d|d3cl1n3d|c4553773|4c0u571c|d15cl053|3x73nd3d|53qu3nc3|pr0m073d|4nn0y1n9|7h0r0u9h|d0m1n4n7|r3c31v35|h15p4n1c|7r4m4d0l|ch4rm1n9|539m3n75|1ncurr3d|50m3r537|n4710n4l|purch453|5n4p5h07|h4nd8495|r353rv35|pr0p3r7y|r35p0n53|pr4c71c3|8ull371n|5ch0l4r5|upd471n9|c1rcu175|3p1n10n5|p41n71n9|cl34r1n9|c0n741n5|h4rdw4r3|un1v3r53|m374d474|r34d1n95|hum4n17y|m0v3m3n7|47hl3735|pr1n71n9|church35|w47ch1n9|d34l71m3|4ppr0v4l|37h10p14|p01n71n9|573rl1n9|535510n5|p0747035|j0urn4l5|fl00r1n9|c0n74c75|0pp05173|4n4ly515|m0d3r473|3m3r91n9|54v4nn4h|r3pu8l1c|3n5ur1n9|m47ch1n9|0ff3r1n9|r3v3nu35|73rm1n4l|c0nfu53d|5c4nn3r5|p4r71cl3|n38r45k4|v4c4710n|d3519n3d|v4r148l3|4c4d3m1c|0853rv3r|pr0p3rly|cum5h075|cr4wf0rd|c0mp1l3r|d3cr3453|9r4ph1c5|c0mp4r3d|m1n3r4l5|juv3n1l3|8r4c3l37|hundr3d5|w0rk5h0p|dr41n493|hum1d17y|dyn4m1c5|70m0rr0w|fr3qu3n7|c474l095|1nc1d3n7|v15171n9|3xp3c73d|d0wn70wn|k3y804rd|150l473d|d373c73d|8l0993r5|f1x7ur35|54pph1r3|5u1748l3|c0ck741l|m1ll10n5|5p33ch35|l19h71n9|n47ur4l5|p05518l3|l173r4cy|f1nd1n95|r3yn0ld5|p0r748l3|d15c0un7|cl1ck1n9|84r941n5|c0n51d3r|r37urn3d|n0r7h3rn|qu4r73r5|8r4df0rd|41rp0r75|c0m81n35|pr150n3r|pr0p053d|d14m373r|c473r1n9|0p3r4735|4551573d|1nfr4r3d|pr0v1nc3|c47h0l1c|m3d1c41d|l1k3w153|w4rr4n7y|m477r355|90v3rn0r|1ncr3453|84l4nc3d|8r1584n3|8run3773|5h1pp1n9|5h0uld3r|c0ur735y|8391nn3r|4553m8ly|5p3ll1n9|r3l148l3|p371710n|d15cr373|cr1m1n4l|5p4nk1n9|r353rv3d|r3p0r73d|p0w3rful|c3r3m0ny|08741n3d|8r0chur3|pr08l3m5|4rr3573d|1nv4510n|5ymp70m5|up9r4d35|m3m0r14l|5uppl13d|p0l171c5|7hr0w1n9|cu570m3r|pr0m1535|0p1n10n5|1n73r357|f19h71n9|v3l0c17y|p057c4rd|3m83dd3d|c4rn1v4l|h4ndm4d3|4n4ly575|m1dl4nd5|pr39n4n7|l19h780x|174l14n0|m4n17084|54l4r135|m0d1f13d|4d4p73r5|m41n741n|r3l3453d|c3llul4r|m15510n5|n0rm4lly|pr10r17y|pl4571c5|c057um35|d1483735|3nj0y1n9|r3pr1n75|7ru57335|1n73rn4l|p3rf0rm5|3ur0p34n|f1n4nc35|d3p05175|p4ym3n75|4c71v17y|fl3x18l3|l4717ud3|d3741l3d|j4p4n353|num3r0u5|4ppr0v3d|p3n510n5|4l7h0u9h|w319h73d|ch4r91n9|947h3r3d|5up3r10r|57r419h7|7r18un4l|h4ndj085|pr3p4r3d|83l13v3d|5urr0und|5p3nd1n9|c0mp053d|m49n371c|4v01d1n9|v4l1d17y|r39157ry|8r0w51n9|8ul94r14|k1n9570n|3mpl0y3d|cyl1nd3r|r3m3d135|n1ckn4m3|5l0v3n14|n071f13d|l4unch35|50u7h3rn|y0ur53lf|5ymp47hy|cr173r14|c0mp0und|d15pl4y5|4ll0w1n9|34rn1n95|8453l1n3|3xp4nd3d|pr355ur3|l34rn1n9|c0n73n75|83h4v10r|d3l4w4r3|574ff1n9|k3yw0rd5|wr171n95|d3l1v3ry|4n4ly23d|dr4m471c|ch4n91n9|3x4m1n35|c0un7135|c0n50l35|purp0535|5urf4c35|5m4ll357|f3571v4l|r3910n4l|4rch1v3d|57r4n93r|73rr18l3|5uppl135|h4w4114n|0ccurr3d|h0m370wn|v3n7ur35|r41lr04d|f10r1c37|pl4yl157|45835705|c3n73r3d|m4ryl4nd|4pp4r3n7|5yndr0m3|3x73rn4l|3l1918l3|ch3ck0u7|7r41l3r5|5747u735|53cur3ly|h4ndl1n9|5ym4n73c|c0ncr373|3xch4n93|4773nd3d|m4nu4lly|c474ly57|l3c7ur35|93n371c5|m0n7r34l|w4rcr4f7|f0ll0w3d|21m848w3|m0157ur3|c0l0m814|4nnu4lly|c4n83rr4|734ch3r5|c0n71nu3|h19hl4nd|5u8j3c75|83n3f175|4cc1d3n7|pr070c0l|9450l1n3|pr3551n9|r351d3n7|p05518ly|w15hl157|5h3ph3rd|0r191n4l|m4r47h0n|8r13f1n9|pr0duc35|1mp41r3d|4ny7h1n9|l09173ch|fl45h1n9|4rr1v4l5|1574n8ul|4lum1num|3nr0ll3d|7r41n1n9|ch34p357|m0rr150n|47717ud3|7r4v3571|p4r3n74l|r3741n3d|pl4y84ck|c4p4c17y|7r4v3l3r|pu8l1cly|c4mp83ll|m4l4y514|84ch3l0r|r3qu1r35|h0ld1n95|c4d1ll4c|d3m0cr47|m0n90l14|1nclud35|f1rmw4r3|d3519n3r|84c73r14|4n71qu35|jud1c14l|47hl371c|r353ll3r|4n1m473d|m4rr1493|wh3r3v3r|pr0p3c14|w33k3nd5|5uff3r3d|l1f371m3|m0r79493|f1r3w4ll|v174m1n5|3xh18175|p4r4ll3l|n3ckl4c3|1nf0rm4l|wh3n3v3r|n39471v3|847hr00m|w4rr10r5|r3fl3c75|74x4710n|4dv4nc3d|m1550ur1|50lu710n|dr1nk1n9|8l0wj085|r34c710n|3nh4nc3d|3n717l3d|93n3r473|8r4nch35|h0rr18l3|4dd1710n|h0m3l355|m1n157ry|m0n170r5|d150rd3r|dur4710n|480r710n|h0m3w0rk|r350lv3d|pur5u4n7|pr0p054l|fl45h3r5|50m380dy|r3741l3r|81r7hd4y|4553553d|c0n7r457|4n5w3r3d|54lv4d0r|c1n9ul4r|r34l70r5|5l19h7ly|5urv1v4l|4d0p710n|p373r50n|0u7c0m35|d1v1d3nd|5ull1v4n|l1n93r13|5w1n93r5|pr09r355|5urv1v0r|cl1m81n9|m4ld1v35|1n519h75|pr3c10u5|80u71qu3|pr0f1l35|c1v1l14n|cr0551n9|cl07h1n9|73mp0r4l|0pp0n3n7|74n24n14|m345ur3d|m1574k35|c0n7r0l5|8r34k1n9|c0m81n3d|ul71m473|m3554935|f4m1l135|h0m3p493|7h0u54nd|53xu4lly|534rch3d|r3m1nd3r|53n73nc3|d3f1n1n9|c0un71n9|pr353rv3|4774ck3d|57r1c7ly|8r19h70n|h0n0lulu|m1l174ry|4cc3p73d|h4m1l70n|d3c1510n|p4r49u4y|v18r470r|1nf1n173|c47390ry|7u70r14l|0v3rc0m3|57udy1n9|pr0v1d35|r3v13w3d|w3lln355|3n48l1n9|f0r3c457|p0r7u94l|v4lu48l3|un519n3d|71m3l1n3|r3p0r73r|517u473d|junc710n|493nc135|f0rm3rly|r391573r|4ccur4cy|94m3cu83|wr4pp1n9|8r0w53r5|4773mp75|h4r7f0rd|ph4rm4cy|cr34710n|4pply1n9|c0lum814|41rl1n35|r34l123d|74l3n73d|ch41rm4n|v10l3nc3|5p3c1f1c|0kl4h0m4|5p34k3r5|7r345ur3|3n7r4nc3|d1v1510n|0rd1n4ry|5upp053d|1nd1r3c7|74r9373d|4v14710n|v3r1f13d|pr0c33d5|d154573r|c481n375|c0mm4nd5|cl34n1n9|7h30r135|cr171c4l|4ch13v3d|1njur135|r3534rch|4c7u4lly|pr0mp7ly|kn1771n9|c0nc3rn5|5u8ur84n|f007w34r|4pp34r3d|c0l0n14l|3mpl0y33|f347ur35|0ff1c3r5|m3d13v4l|p4v1l10n|p4ck4935|r3f3rr3d|5upp0r75|1ndu57ry|4dv150r5|4cqu1r3d|8r04dw4y|l4u9h1n9|c4p7ur3d|547urd4y|h0ndur45|3xc171n9|3qu1pp3d|d1r3c70r|5c3n4r10|8453n4m3|pr0v1d3d|r1n970n3|3m15510n|9r473ful|pl345ur3|5h3m4l35|5h0pp3r5|0r13n73d|d0n4710n|d35k70p5|pr353nc3|c0lum8u5|455um1n9|r3l3v4n7|fr33w4r3|574r71n9|1n53r73d|pr0duc3r|c0nclud3|r3qu1r3d|5urpr153|m4j0r17y|7hur5d4y|h4rdw00d|d34dl1n3|c0n5um3r|d373c70r|m0n374ry|83l13v35|3n0rm0u5|p0l15h3d|4r71571c|pl4nn1n9|fl0471n9|53m3573r|d4748453|1nn0c3n7|5c4nn1n9|1mp3r14l|0ff1c14l|pr0duc75|80und4ry|57r3n97h|7r41n3r5|d0c7r1n3|3x3cu73d|0v3r5345|m0m3n7um|d3f3rr3d|c0n7r4c7|r3l34535|0p3r473d|7r3471n9|57r0n9ly|f33l1n95|3xpl41n5|pr0731n5|h34dl1n3|4dv0c473|f4m1l14r|4n7180dy|5u993575|5h0wc453|d4u9h73r|574nd1n9|ch0051n9|p34c3ful|w385h075|hydr093n|0u7l1n3d|c4rry1n9|0rd3r1n9|clu573r5|c0rdl355|3duc473d|3d1710n5|39yp714n|0r13n74l|m0n573r5|7r14n9l3|r3fu9335|800km4rk|1ll1n015|5p3c14l5|v3r71c4l|3l3m3n75|dr4w1n95|570pp1n9|f4c1l17y|1n739r4l|fr0n713r|4850lu73|4qu4r1um|c0n51575|m1n1573r|r394rd3d|1mpr0v3d|m3d1c4r3|mul71pl3|50ld13r5|v15170r5|9u4rd14n|57ru99l3|r0ul3773|4n4ly535|j0hn570n|l173r4ry|cl4551c5|d0wnl04d|c0v3r493|3xp05ur3|73x7800k|pr3m1535|53rv1c35|94m8l1n9|3n717135|0r94n123|d157r1c7|0u7d00r5|c4l3nd4r|70m47035|483rd33n|l4unch3d|34rl1357|l1c3n535|d1549r33|ch4p73r5|8r1n91n9|3v4lu473|c174710n|7r0p1c4l|cl1n1c4l|d4v1d50n|34rr1n95|5h0071n9|f347ur3d|5c13nc35|dr1ll1n9|8u1ld3r5|pr1n73r5|3n9491n9|k3n7ucky|plym0u7h|4r71cl35|5ur91c4l|p1p3l1n3|curr3ncy|5h4n9h41|1n73r10r|f33d84ck|3p150d35|3v3ryd4y|m0un71n9|r3m41n3d|m081l17y|h34r1n95|r3l471v3|m3m8r4n3|37h3rn37|dr3551n9|c4rr13r5|1d3n717y|r350urc3|c0mm3rc3|fl0r3nc3|c1rcul4r|r3v1510n|5yn0p515|fr13ndly|f0un741n|r3duc1n9|h4nd800k|5ch3dul3|n4v19473|m41nl4nd|f1l3n4m3|r3pl4c3d|3n71r3ly|50m3wh47|r3c31v3r|d0cum3n7|w4rn1n95|0p71m123|8ru553l5|5c07715h|p0r7r417|r1chm0nd|ch4m83r5|f19h73r5|plum81n9|4cc0un75|1n73r4c7|r081n50n|mcd0n4ld|c0mp053r|1n574nc3|c0v3r1n9|jud9m3n7|83dr00m5|r4710n4l|m0d3l1n9|c4r700n5|3v3ry0n3|c0mpl373|l1c3n53d|4uckl4nd|4d3qu473|0lymp1c5|m473r14l|4ppr04ch|1nv0lv35|chry5l3r|84r84d05|w0rld53x|r35ul73d|c05m371c|53771n95|r4nk1n95|5p3c7rum|r3v13w3r|m3m0r135|r3c0rd3d|3mph4515|90r930u5|phy51c4l|f1n15h3d|cul7ur4l|h4rr150n|70wn5h1p|5ymph0ny|5l0v4k14|d15c0v3r|r1ch4rd5|930m37ry|p4773rn5|7r1n1d4d|d3v3l0p5|7h0mp50n|n375c4p3|m3d1c1n3|h0l1d4y5|v1ll4935|4cc3553d|pr3m13r3|1n7r4n37|3n73r1n9|d3l373d|57ud105|k1551n9|8u770n5|h34l1n9|v3n7ur3|3xp3n53|f1r3f0x|w1nn3r5|h319h75|455um35|r0ll1n9|574r7up|d351r3d|m3x1c4n|4w350m3|p0773ry|c4p170l|4rr1v4l|4rr1v3d|cr34735|70ur157|c0mm0n5|4l83r74|n3rv0u5|m4573r5|53n470r|4w4rd3d|p4551n9|8124rr3|3x73nd5|l0d91n9|08v10u5|r3pl1c4|ch4nc35|c0up0n5|8urn1n9|v1c71m5|570pp3d|h4ndl3d|l393nd5|800l34n|v1518l3|3xh1817|ch3ck3d|cl053ly|1nqu1ry|3xh4u57|7urn1n9|57r3375|c0ll3c7|l1v353x|f4rm1n9|c481n37|pr0m153|93n371c|h4ndl35|5k1ll3d|h4rm0ny|l3c7ur3|4ny71m3|9r4mm4r|c17123n|w1nd50r|v15173d|v1c70ry|3l3c73d|c4p48l3|c0py1n9|35c0r75|c04ch35|74r9375|v3553l5|h4r80ur|f1l73r5|c0un53l|c451n05|4ppl135|1nv173d|4rr4n93|un1f13d|d1pl0m4|f4rm3r5|qu3r135|4ndr345|ukr41n3|4853nc3|n34r357|clu573r|v3nd0r5|19n0r3d|wh3r345|5h0r7ly|pr3c153|p057493|p4r714l|1nv01c3|c4571n9|d3r1v3d|c0upl35|f1nl4nd|r4nk1n9|4n4ly57|c0nv3r7|8r1d935|wy0m1n9|83771n9|1m491n9|0n901n9|l04d1n9|7ru573d|v0l7493|f0rm1n9|3m8455y|5h1pp3d|c0n50l3|h088135|h0rm0n3|r3c31p7|4m0n957|h0r120n|700l80x|l1v3c4m|l183r4l|d34l1n9|5cr1p75|5urf1n9|d3v073d|h3471n9|1m491n3|kn0w1n9|cru1535|c00k135|477r4c7|c0lumn5|d1548l3|5ucc33d|l30n4rd|l3nd1n9|cl051n9|un1f0rm|m455493|m3dl1n3|h34d3r5|w3lf4r3|d4nc1n9|c4mp1n9|h34v1ly|c4p7ur3|m1dw357|513m3n5|pu8l15h|k4r40k3|d0m41n5|0853rv3|83rmud4|m081l35|d0c70r5|0p3r473|4m3nd3d|m3n710n|p10n33r|8r34575|57r4n93|4cr0847|73rr4c3|hundr3d|7h3rm4l|d3n517y|r3pl13d|73ll1n9|c04574l|534f00d|ch4r17y|up5k1r7|w1ll1n9|fr3385d|4n71qu3|94rd3n5|hun94ry|7r41l3r|v137n4m|539m3n7|r34l123|pu771n9|53n50r5|51771n9|5urv3y5|plu91n5|41rl1n3|dur48l3|1n519h7|705h184|d37r017|n071c35|3d171n9|53cr375|d3p3nd5|w1ch174|f0rm475|5p3c1fy|ph1l1p5|uru9u4y|p3n4l7y|9l45535|3n48l35|53m1n4r|5h0w3r5|8u1ld3r|d3p0517|r3v3r53|1n73n53|cl05ur3|3nqu1ry|748l375|fu7ur35|8l0993r|ch4r73r|w4n71n9|81dd1n9|0u7c0m3|w45h1n9|j0urn3y|my573ry|cu570dy|c3n7r35|5cr47ch|p0v3r7y|d3nm4rk|m4551v3|0u7l00k|ch4r93r|ch01c35|9r4n73d|c4r700n|c00l1n9|1nd3x3d|h4ndj08|pr07357|m4pp1n9|0ff3n53|wr173r5|d1v0rc3|83v3rly|5h0pp3r|cu771n9|83rn4rd|v3rm0n7|84r941n|3xp053d|73l3c0m|f0cu53d|r0m4nc3|cl1n1c5|h4pp3n5|0rd3r3d|dr4w1n9|v15170r|8199357|r350r75|4774ck5|p3r10d5|fuj175u|r3w4rd5|5urv1v3|f0und3d|83n347h|f0rmul4|5pyw4r3|53v3n7h|70n19h7|53nd1n9|500n357|7r41n3d|7yp1c4l|ch4m83r|l3nd3r5|f1771n9|c0n7357|84n9k0k|7084cc0|r083r75|c0n53n7|8077l35|pr3m13r|1ll394l|pr3p4r3|5urplu5|0rl34n5|90urm37|p3n510n|83l4ru5|9r4v17y|9u174r5|w0r5h1p|8ukk4k3|ch4r93d|7h3r38y|4n70n10|h3r53lf|3553nc3|pl4nn3d|3p150d3|d4m4935|570m4ch|l3771n9|w34p0n5|5upr3m3|7hr34d5|d1v3r53|81cycl3|3d170r5|l4p70p5|4n470my|4d4p73r|84rr13r|3nh4nc3|d3f3c75|3n48l3d|cl4r17y|d3f3nc3|r34ch3d|r3pl4c3|0ffl1n3|d1v1d3d|n317h3r|7r18u73|c0nf1rm|5377l3d|1n51d3r|f0ld1n9|7r3473d|l3550n5|41rf4r3|d3l1v3r|r3fl3c7|v4cc1n3|c4rr13r|4d0p73d|pl3453d|v174m1n|c0nc3r7|93nu1n3|r4151n9|8r1741n|m1n0l74|hu584nd|l34rn3d|l315ur3|4nc13n7|810l09y|p0r710n|800k1n9|c0ur13r|h19hw4y|83l91um|1mpl135|81ll1n9|c0m81n3|3n73r3d|r35p0nd|p4yr0ll|c00k1n9|1njur3d|l34v1n9|f457357|73n510n|0r94n1c|7074lly|h3lp1n9|d34l3r5|4mpl4nd|h0ld1n9|c0nc3rn|l3xm4rk|m0dul35|373rn4l|5m4ll3r|3x4m1n3|3xpl41n|w4lk1n9|8r1570l|4lc0h0l|4ff3c75|cl1m473|3n91n35|m47ch35|4773mp7|k33p1n9|83nn377|c0mp4c7|53c70r5|5hu77l3|9r0und5|7r4n517|r394rd5|fr319h7|4rm3n14|cl05357|4c7r355|845k375|93n3r1c|r3m41n5|4dv150r|cur10u5|d1374ry|l4wy3r5|m4r1lyn|57ud13d|f1ndl4w|m47ch3d|0rl4nd0|pr0f175|c4rr0ll|83dr00m|w4rm1n9|fl0r157|f33l1n9|4m421n9|0p71c4l|d3u75ch|r3v153d|f4c70ry|f1nn15h|mu5l1m5|fun3r4l|r3m0v4l|3nj0y3d|pr1n73d|f007493|c1rcu17|r3v34l5|w38573r|cl07h35|c0mp1l3|c4rr13d|n071c3d|c4rr135|4ch13v3|4ll393d|519n4l5|4l484m4|83c0m35|5m0k1n9|7un1514|573v3n5|5ym80l5|h077357|80l1v14|c0mf0r7|533k1n9|d39r335|d35p173|pr3v13w|u71l17y|84hr41n|3ld3rly|h0ld3r5|4u57r14|5w3d15h|45p3c75|c0n5157|v13w1n9|1n574n7|p0571n9|w17n355|c0ll1n5|m34n1n9|l3v17r4|h424rd5|1n5ur3d|r3910n5|dyn4m1c|4c4d3my|4l938r4|5h4d0w5|5unr153|94d9375|c0n741n|9l4590w|4m0un75|1mp4c75|w38l095|51n9l35|r4d1c4l|1nduc3d|r3m0v3d|83l0n95|r34d1ly|54mpl35|l1nk1n9|4pp34l5|1lln355|15l4m1c|3n5ur35|phy51c5|70pl355|r3duc3d|l1nd54y|p3nd1n9|l394lly|l384n0n|m4773r5|53rv1n9|k3nn3dy|c4ll1n9|5h3m4l3|733n493|7h30r3m|my5p4c3|c0nduc7|84nk1n9|53cur3d|unu5u4l|8r13fly|w4171n9|5h4r1n9|m4rr13d|f19ur35|dr1v3r5|r0u71n3|700l84r|h34l7hy|cu151n3|p3rf0rm|5pr1n95|w34r1n9|7h3473r|70r0n70|m0un73d|h481747|f19h73r|r37r347|5c4nn3r|4d4p73d|3574735|w4ll4c3|m4n493d|f3m4l35|0ff1c35|80r0u9h|1n7393r|5p34k3r|f41l1n9|4ndr3w5|m0dul4r|3n9493d|f4ll1n9|n4710n5|81ll10n|r34l17y|c0nc3p7|84ll00n|3xpl0r3|3x4c7ly|dr0pp3d|84p7157|dr35535|p3nd4n7|8351d35|r0u73r5|v1n7493|3xp3r75|fl19h75|9r47u17|m345ur3|r3v3nu3|m0m3n75|f0ld3r5|57r1n95|834ch35|3nl4r93|h0pk1n5|cl34rly|70r7ur3|cr3d175|r3duc35|1nf4n75|47l4n74|r3v3n93|3xp1r35|w1nn1n9|3n3m135|81nd1n9|9r4ph1c|4cc3p75|54v1n95|7r1993r|70ur15m|d3519n5|d3c1d3d|r0u9hly|4pp34r5|571ck3r|pr0m073|c0rn3ll|d353rv3|nucl34r|4n73nn4|455um3d|3v3n1n9|w0rr13d|k1ll1n9|m3mph15|08j3c75|p4ck375|h4rv4rd|8r0k3r5|94r8493|1nd14n4|5p0n50r|34rl13r|7h347r3|p0dc457|d3f1n35|53450n5|phr4535|p4773rn|4ccu53d|r34ch35|53477l3|p1551n9|p4rk1n9|qu12235|p0573r5|l34d3r5|l471n45|5upp053|1nv0lv3|r34d3r5|y0un93r|pl4n375|d3f1c17|80uld3r|r4p1dly|c0upl3d|my4nm4r|0n74r10|w33k3nd|f0ll0w5|f41lur3|f1571n9|c0un73r|73x7ur3|pr0duc3|pl4571c|0u7l1n3|r3c1p35|r353rv3|h0ll4nd|0p3n1n9|c3n73r5|4n719u4|5173m4p|p473n75|c4u710n|3x3cu73|m1551n9|c0l0ur5|qu4r73r|m4r714l|3l3m3n7|p1r4735|0r191n5|74lk1n9|73x71l3|d3m4nd5|r3450n5|c4r3ful|1nv4l1d|ch4r935|5u99357|70w4rd5|1nd3x35|7r4ck3d|4ff41r5|m1n1m4l|f1nd1n9|l0773ry|f0r3575|l1ck1n9|l1c3nc3|m4rk3r5|pr3v3n7|w319h75|4l84n14|pr073c7|l4571n9|c0v3r3d|d3f3n53|nur51n9|w38c4m5|3ff0r75|5urn4m3|4n4ly23|3v1d3n7|53r10u5|4ll3r9y|83l13f5|3n7r135|7h3r4py|r0m4n14|34573rn|l3451n9|c0n5ul7|h34r1n9|9r347ly|7w1573d|9r0w1n9|cycl1n9|up9r4d3|pr3m1um|174l14n|7urk15h|k3yw0rd|53c0nd5|p3n71um|qu4n7um|53rv3r5|ch34p3r|l4r93ly|h1m53lf|8r0u9h7|5ur93ry|dr1v1n9|v1ru535|d0ll4r5|qu1ckly|7r18un3|4l93r14|8l3553d|c4rd1ff|4cqu1r3|4pp4r3l|1n574ll|c0n73x7|l3773r5|5p1r175|r3f0rm5|l4w5u17|1n1714l|p01n73r|r3pl135|57r37ch|84l4nc3|p3rm175|234l4nd|84nn3r5|c1rcl35|cl34n3r|3cu4d0r|f33d1n9|p4551v3|84n98u5|f4c70r5|c0ur493|9423773|v1ll493|r3un10n|h174ch1|pr41r13|p3r50n5|p3rh4p5|0lymp1c|p4713n7|c0l3m4n|m4rk375|4n4h31m|d15cu55|cu570m5|4c710n5|cl13n75|7r4d1n9|m0n170r|d3cl1n3|15r43l1|f45h10n|n4m1814|pr1c1n9|5p3c135|kn19h75|53ll1n9|h3wl377|c0rr3c7|pr0c33d|4ll0w3d|4l73r3d|j4m41c4|4uc710n|4dv4nc3|519n1n9|4ppl13d|l4nd1n9|57r34m5|c0nn3c7|4fr1c4n|v373r4n|l4r9357|ru5514n|pr0p053|l19h73r|3570n14|k47r1n4|ch4n93d|74c71c5|4n93l35|mu51c4l|m0n7hly|h3lpful|h19h357|3c0n0my|574y1n9|53771n9|f0und3r|5p4n15h|5h0r73r|d15pu73|c0mpl3x|r3ly1n9|4dv3r53|r3f1n3d|3xc3rp7|f1f733n|c4r33r5|w47ch35|pr3d1c7|f1c710n|4cryl1c|d3v1c35|fund1n9|83n3f17|p3rfum3|5h0w1n9|r3570r3|70ddl3r|w0rk3r5|734ch3r|8l0ck3d|unkn0wn|r35p3c7|0ff1c3r|cl45535|d35k70p|cr3470r|upd4735|f1n4lly|mu53um5|57r1k35|7r4ck3r|dr3553d|p455493|83lf457|v4r137y|nur53ry|j3l50f7|h34d537|n1494r4|04kl4nd|m1n1mum|5urf4c3|0ff3r3d|4n5w3r5|v1r7u4l|pr3p41d|pl4y1n9|d3f1n3d|5u1c1d3|3l3c7r0|84773ry|v4ry1n9|7ru5733|481l17y|m15510n|80rd3r5|p4r7135|f4cul7y|l091c4l|h4mp70n|l0991n9|3x7r4c7|4u7h0r5|p4r7n3r|75un4m1|5ch0l4r|p4y48l3|pr0731n|m0rn1n9|0u7d00r|3xp3d14|930l09y|r3qu1r3|d3f4ul7|c0471n9|v3h1cl3|m41l1n9|cl34r3d|r371r3d|p4c1f1c|r3m4rk5|5m1l135|d3c4d35|80471n9|4r151n9|5h4k1r4|m1x7ur3|c0rn3r5|8r04d3r|c3n7ury|535510n|4r71575|d3v3l0p|r41lw4y|9r3473r|0p1n10n|ch1n353|p01n73d|84h4m45|f17n355|c4u51n9|m1574k3|h1771n9|l34d1n9|m1n3r4l|4qu471c|1n5734d|91l83r7|f0r7un3|cl41m3d|5cr33n5|0u7pu75|pl4nn3r|cr04714|1n5ul1n|574d1um|7r4ff1c|455ur3d|c474l09|my51m0n|4m813n7|h0u51n9|u71l123|m1l3493|4d4p70r|3dw4rd5|5h3l73r|4n1m4l5|hyund41|f0rw4rd|54715fy|c057um3|r3l4735|5747u73|p4ck1n9|w4rn1n9|m4x1mum|fr4m1n9|1mpl13d|3xpr355|c0mm4nd|812r473|d153453|w3dd1n9|k17ch3n|p4r3n75|p1ck1n9|n0rf0lk|1mpr0v3|r3n74l5|574710n|r39ul4r|50urc35|p0ck375|1nqu1r3|p41n73d|v0lum35|7r41n3r|r471n95|r34l70r|4r7w0rk|ch45515|c4m3r45|pu5h1n9|f347ur3|purp053|37h1c4l|8r0w53r|num83r5|pr1m4ry|pr3f3r5|83df0rd|5ch3m35|l0c473d|n3u7r4l|ch4nn3l|83dd1n9|0u751d3|j01n1n9|h34d1n9|3qu4lly|f0r319n|834r1n9|41rp0r7|c0ur535|3m3r4ld|cul7ur3|53n10r5|3n9l4nd|c4p174l|r37urn5|f0cu535|51l3nc3|1mp053d|48r4h4m|f1ll1n9|v10l3n7|7u35d4y|w38p493|53ll3r5|h0573l5|53n394l|8r1715h|15l4nd5|mu5cl35|j3w3lry|wr4pp3d|c077493|runn1n9|run71m3|c3r741n|m021ll4|pl4c1n9|50l0m0n|d1574n7|4nym0r3|l4undry|d3c1m4l|l0c470r|83l13v3|pr1n73r|m491c4l|50m30n3|m1r4cl3|r3pr1n7|574r73d|pl4y3r5|p4ck493|h4m8ur9|0v3r4ll|r350lv3|f47h3r5|w3573rn|73rr41n|5umm4ry|570r493|50m3h0w|7h0u9h7|k1n9d0m|cr3473d|3ff3c75|wr171n9|l483l3d|n193r14|c31l1n9|h0l1d4y|m4rk1n9|r0y4l7y|5h3r1ff|9r1ff1n|l1c3n53|4ny80dy|50l4r15|pr3570n|w4rr4n7|m4n493r|51n91n9|ch4p73r|m37h0d5|r3c31v3|l0n9357|v4r10u5|93rm4ny|0p71m4l|93771n9|p3rc3n7|u5u4lly|m4dn355|8l0w1n9|r34d1n9|5uck1n9|r3u73r5|m1nu735|f1n4nc3|c4rd14c|71ck375|v471c4n|h0571n9|f3d3r4l|wr1773n|3xp0r75|m4nu4l5|pr353n7|533k3r5|num3r1c|w47ch3d|5k471n9|7h3r30f|53471n9|3mp3r0r|r3c0rd5|4v3r493|r384735|w347h3r|pr0udly|wh37h3r|n47ur4l|pull1n9|083517y|r4n91n9|r3p41r5|p0w3r3d|l1m173d|7h0m50n|d15pl4y|h4n91n9|c0l0r3d|70ur1n9|4nd0rr4|53v3r4l|3xp1r3d|57ud135|7r4v3l5|4lr34dy|upd473d|fur7h3r|r0u71n9|3d1710n|d3l19h7|50c137y|4rch1v3|3l394n7|c0mp373|r3n3w4l|c0un73d|c0unc1l|0pp053d|5c0r1n9|d3cl4r3|c3n7r4l|51573r5|cr171c5|734ch35|r3p0r75|j0urn4l|570r135|p0pul4r|51l1c0n|7r493dy|p41nful|m1ll10n|5ch00l5|51m1l4r|pr4y3r5|n0wh3r3|m4d0nn4|m3371n9|p1c7ur3|r3qu357|r3l3453|v3r120n|50ld13r|r380und|849hd4d|ch4n935|3x4mpl3|m1rr0r5|c0nc0rd|0p710n5|l183r14|3c0l09y|pr08l3m|5h3rm4n|4554ul7|w0rk0u7|57ud3n7|p4ym3n7|4941n57|r3fu53d|80wl1n9|w0rk1n9|c0mm3n7|57471n9|m0r0cc0|7r1umph|m3d1c4l|w3ld1n9|l0ck1n9|8l4nk37|3ll1077|541l1n9|l18r4ry|h0w3v3r|ju571fy|94ll3ry|c4ndl35|p055355|50lv1n9|3n9l15h|v4n1ll4|5c13nc3|pr0c355|pr0v1d3|1c3l4nd|pur5u17|4r71cl3|d3v14n7|m07h3r5|84ck1n9|1nclud3|c0mp4r3|1mp0r75|3ndl355|c0un7ry|c0n73n7|l1571n9|5u5p3c7|f19ur3d|l0c4lly|qu4l17y|4n07h3r|cruc14l|m0ld0v4|pr3553d|pr0f1l3|5c4nn3d|4cc0un7|7u1710n|7hr3475|5ur930n|pu22l35|h1570ry|m1551l3|d4m493d|curr3n7|h4rv357|d380r4h|d357r0y|4551575|1nd14n5|w17h0u7|4ud170r|pr0ph37|8r4ck37|5y573m5|n37w0rk|m3m83r5|c4lc1um|h4rmful|r3l473d|53c710n|0lympu5|v3r510n|pr0j3c7|9luc053|w385173|5p3c14l|p3r514n|4ppr0v3|837w33n|574r73r|5u8j3c7|lu99493|9r3n4d4|1n73r1m|c4l94ry|4ddr355|57yl15h|34rn1n9|r35ul75|9r0c3ry|m41lm4n|83c4u53|50m4l14|k3nn37h|d3741l5|4dv153d|n0v3l7y|8ud9375|700lk17|pr09r4m|r3v13w5|3r071c4|p30pl35|831j1n9|j4nu4ry|d149r4m|v13w3r5|c0mp4ny|pr1v4cy|r35um35|7hr0u9h|3x1573d|qu4l1fy|0p71mum|m355493|j4ck375|3xc173d|5upp0r7|pr0duc7|r3fr35h|r3c0v3r|w38c457|57r1p35|3xp3c75|jump1n9|f48r1c5|p0lym3r|r4l319h|d3l4y3d|hy913n3|p0ul7ry|80uqu37|m4nd473|1nd1c35|h4l1f4x|c0n74c7|d0n473d|3xclud3|57uff3d|1n53c75|cl34nup|c0mpu73|4nx137y|4rr1v35|5p4714l|7r4c70r|70uch3d|c3r4m1c|c0l09n3|f1n93r5|w15h1n9|0u7l375|574pl3|r3p347|f0ll0w|80d135|5ch3m3|unl355|3rr0r5|54mpl3|m4nn3r|v1d305|r39943|7r4nny|7hr34d|4n90l4|8l00dy|f1n93r|7r4um4|l0c473|70w3r5|hu9h35|74r937|pr0p3r|3xc3p7|m4k1n9|p4y1n9|w0rk3d|w00d3n|m070r5|80x1n9|8r4k35|num83r|9l084l|50r73d|c4r80n|4dv153|1nch35|w49n3r|n33dl3|my53lf|5h4r35|ph4535|m0v1n9|cr1515|8r4nd5|v0y3ur|pl4c35|c0l0r5|8r19h7|pu5h3d|h34d3r|pr377y|f0rm3d|ch01c3|8l4d35|4pp34l|cru153|5h0r75|5h3375|5l0v4k|pu3r70|m4r10n|m374l5|7r41n5|45ylum|pl45m4|84ll07|f4c1n9|w1ck3d|lyr1c5|m4r7h4|5c4r3d|1nc357|r4r3ly|dr1v35|3xp3r7|84nn3r|r3fund|5u8m17|4r7157|m3d1um|7r3m8l|h3l3n4|l47v14|8run31|1mmun3|4m0un7|3m41l5|cypru5|l3v3l5|73chn0|84k1n9|83c4m3|d34l3r|m4k3r5|h34r75|l3773r|p4570r|n34r8y|ph0n35|w1r1n9|7w1nk5|l394cy|574nd5|h4pp3n|d4n93r|9r33n3|w1d3ly|r41535|phr453|90773n|7un1n9|1753lf|hy8r1d|fu7ur3|p4p3r5|7h0u9h|l471n4|4w4rd5|wh33l5|53xc4m|c4u53d|81993r|luxury|v3r5u5|n45d4q|fr4m35|3xc33d|v149r4|57ud10|1nd33d|54y1n9|8u7l3r|w0r7hy|r0u73r|r34d3r|cl41m5|p0l4nd|f0ld3r|w0m3n5|848135|r0573r|d373c7|upl04d|d3v1c3|34513r|d39r33|fr453r|7hr0wn|9r4h4m|v071n9|c0ur75|8u770n|r3m073|d33p3r|cycl35|5l0wly|d3n14l|4dd1n9|7h4nk5|m057ly|93n7l3|7hr0w5|l473ly|1nf4n7|w35l3y|4ll13d|pr1n75|7r4d3r|ch4n93|c3m3n7|m337up|r38473|m4773r|cu570m|8r4nch|unl1k3|k1dn3y|f1n173|7h30ry|708490|ch4rm5|wr19h7|r3m0v3|7r184l|pr0v3n|r394rd|54f3ly|c4ch3d|w4rr3n|3x1575|8urn3r|8r1d4l|4lm057|5u1735|c0mply|m4rk37|m4k3up|h1dd3n|n4rr0w|v15u4l|7hr347|807h3r|53r14l|r3l13f|w38c4m|r34lly|d05493|nu773n|w319h7|chu88y|43r14l|57ruck|m4n493|qu383c|v0c4l5|c0rn3r|pl4n37|c457l3|m4nu4l|m1553d|c0p135|r3c1p3|3d170r|50ck37|51l3n7|l483l5|p3rm17|5331n9|0r390n|83c0m3|4c71n9|kuw417|n0v3l5|570r3d|493n75|n4m3ly|hum4n5|4n4l09|f4c14l|r3p41r|74l3n7|n3wm4n|53r135|533k3r|w15d0m|ch0053|r471n9|cr4dl3|748l35|0ff537|p4yd4y|ph1l1p|d3f1n3|8ur34u|l3553r|5p33d5|p01n75|c0rpu5|c0lumn|pl4n75|8r34ch|dur1n9|p13c35|574935|fr1d93|k3lk00|c4m3r4|p0wd3r|5748l3|d1nn3r|455355|r3l04d|4v3nu3|570n35|57r355|l3550n|c1n3m4|l051n9|94rd3n|5udd3n|cl4rk3|7r3nd5|f3m4l3|m4r14h|905p3l|cur715|4r9u3d|c477l3|r37urn|53v3r3|rhy7hm|53c70r|v3lv37|h34l7h|f0ur7h|d3lux3|34rn3d|r4c14l|ch0ru5|j3r53y|m4l4w1|c0ll4r|m3n74l|l3nd3r|v13w3d|5l1d35|4ur0r4|f48r1c|m0m3n7|57ylu5|v15175|h3r38y|hun93r|7r1pl3|f47h3r|4774ck|l1573d|fly1n9|c4nc3r|53c0nd|d4m493|5ur3ly|qu0735|l0n3ly|r3450n|45519n|d0m41n|7174n5|3n3r9y|4n5w3r|p0und5|50u9h7|pl4c3d|p13rc3|ch4r75|jul14n|m3d14n|r0und5|c3n5u5|h3r31n|d351r3|9r4nd3|v4r13d|fl0ppy|93n7ly|cl0ck5|pl41n5|d0ll4r|hun9ry|c4u9h7|r3nd3r|m4rk3d|dr1v3n|8451c5|d34dly|c4rp37|h1r1n9|57ruc7|l3n535|81n4ry|h4r0ld|8077l3|p037ry|834u7y|fl33c3|8r1d93|ru883r|n471v3|fl4v0r|f0rum5|8uf1n9|c0nd05|f0551l|cur50r|83773r|py7h0n|f0r937|m37r1c|c4mpu5|pl4y3d|m0d3l5|pr1c35|r08813|0r945m|7yp1n9|84rr3l|n3ur4l|w4rn3d|pr3f1x|1m4935|51573r|3v3n75|3n717y|5h1r75|pr0f17|h0ld3r|r0ll3d|w4rn3r|n3w357|pur5u3|n071c3|1nkj37|9uy4n4|p4r4d3|4c70r5|d0n0r5|93r4ld|l148l3|0p71c5|m0rr15|du7135|r3c4ll|p1ck3d|3x73n7|9r4nny|37h1c5|83l13f|w4n73d|81k1n1|3xp3c7|4nch0r|l00kup|83y0nd|ul7r4m|8r1n95|kru93r|mu53um|0774w4|un1qu3|5urv3y|3xp0r7|nud17y|v4lv35|805n14|r3f1n3|81dd3r|51n93r|573r30|h3r4ld|5w3d3n|pr1235|4nnu4l|c0mm17|p4rc3l|r35157|plu91n|d1v1n9|1nv173|53r814|f0rm3r|d33ply|k1j1j1|5ch3m4|4d1p3x|73rr0r|53rv3r|7h1r7y|4rr357|f1n4l5|84ckup|m5957r|j4ck37|53n473|f0rc35|0r4cl3|c00k3d|myr7l3|7urn3d|5pr34d|80r1n9|3xc355|9009l3|3xp4nd|5l19h7|church|m37h0d|f4v0ur|51mply|93nr35|r3f3r5|7unn3l|84r813|4c71v3|r19h75|r3741n|4ff3c7|v1r91n|p4r3n7|m073l5|r4153d|v1c71m|574mp5|p4yp4l|f0r835|f19ur3|4lfr3d|84ck3d|p1ll0w|4rr1v3|m1n1n9|5un537|0p710n|v4ll3y|r4p1d5|94rm1n|8r33d5|fr4m3d|5uff3r|07h3r5|c1rcu5|pu8l1c|3n0u9h|947h3r|d3l373|r3l473|f0rm47|155u35|94r493|5cr0ll|9u4rd5|m41l70|7h0n95|519n4l|m0n7h5|155u3d|5h4p35|53xu4l|4l8um5|ch3475|5k1r75|k1n453|7ru575|9u3575|h0573d|54f37y|l4r93r|80770m|c0l0ny|pr4y3r|d3741l|1nf0rm|n3v4d4|5u553x|p4553d|n3w4rk|57r337|493nd4|murr4y|1n73n7|4nyw4y|d1v1d3|f4ll3n|7r4ck5|h19h3r|1mp4c7|h3473r|534rch|v3553l|c1rcl3|57473d|h0n0r5|9r4n75|57r0n9|v4r135|8u88l3|c3l385|5w17ch|7h1n95|0xy93n|f3715h|c4ny0n|m373r5|m3r3ly|c3n73r|5u87l3|c0v3r5|p45535|4p4ch3|mun1ch|p47r0l|kn1v35|durh4m|717l35|9r0und|mu5l1m|v0yu3r|h0p1n9|5l33v3|f3ll0w|d023n5|l0un93|pr024c|0wn3r5|57r0k3|4dul75|p3r50n|93n0m3|845k37|4853n7|r3m4rk|1npu75|w33kly|h1l70n|h4v1n9|h4rdly|h0rr0r|c00l3r|r1d3r5|l4unch|d3m4nd|53w1n9|d3814n|m081l3|w41v3r|5pr1n7|8ry4n7|5qu4r3|7r4v3l|fr3nch|5cr1p7|9l0v35|53rv3d|5ym80l|cr4f75|5k11n9|r074ry|4nd4l3|24m814|5c3n1c|c17135|m41nly|37hn1c|r3w4rd|fl1ckr|m471n9|d1n1n9|4lp1n3|9r4ph5|c0mm0n|f15c4l|71m1n9|57yl35|d3n13d|f1ll3d|90551p|57r1p5|rw4nd4|m1ch3l|0ccur5|d347h5|r1v3r5|n071fy|jun9l3|n47ur3|p0r73r|n4710n|907h1c|3n5ur3|0rd3r5|v3n1c3|7hum85|pr4153|c48l35|457hm4|34573r|c0770n|5l33p5|p4lm3r|h4ndl3|ur93n7|7w3lv3|l4y0u7|d3c4d3|4fr1c4|d3n74l|k1ll3d|80rd3r|71773n|f1773d|d38473|pu8m3d|574r75|m1x1n9|l471n0|dr1nk5|d0n473|v01c35|cl0ud5|74u9h7|n3x73l|w0rk3r|73nd3r|c4u535|m0nr03|h0n357|4l84ny|70m470|73mpl3|l1v1n9|p051n9|9r0w7h|p37173|57u4r7|8r34k5|c4ym4n|493ncy|w473r5|5377l3|r0ll3r|m0dul3|pr3f3r|0p3n3d|r350r7|c0d1n9|h4rr15|8ud937|r4nd0m|5c0714|c0p13d|c0un7y|h1k1n9|h4rd3r|9u1d35|p13rr3|m49n37|l00k3d|r3p0r7|5c0r35|m0710n|v3c70r|lu7h3r|c4ll3d|8uff3r|c0m3dy|0ff3r5|v3r73x|w38l09|l1n34r|4r4814|m3r93r|m4rv3l|5p34k5|mu7u4l|m0d3m5|r08u57|5yn74x|4m420n|pr150n|p4n4m4|3d173d|ch41r5|50lv3d|m0v135|83l123|j3w15h|l0993d|l1nk3d|l4p70p|1nc0m3|c0upl3|47h3n5|91v1n9|jud935|r4d1u5|r3c3n7|3nd1n9|fl00r5|d353r7|w0nd3r|w4lk3d|l0l174|0ld357|n34rly|p0w3ll|h4n53n|8391n5|l1573n|r3f0rm|570r35|4fr41d|4l3r75|f0r907|4cc3p7|0r191n|5umm17|5up3r8|5p4c35|94m1n9|n0r70n|l0ck3d|35c4p3|fu510n|455um3|p0150n|curv35|m0n4c0|7r4d35|c14l15|c4nv45|f4573r|p4r15h|pl3d93|9l4nc3|4rc4d3|80u9h7|l34v35|n4pl35|r3v13w|v1r7u3|9u1d3d|unl0ck|c0up0n|nur535|r3741l|l4y3r5|m3m0ry|8r0k3n|l0w357|h19hly|ch4p3l|ch3ck5|u53ful|f1l1n9|f0573r|4pp34r|8477l3|74993d|54f4r1|54v493|7r14l5|7155u3|r3fu53|3n91n3|4u8urn|pull3d|50c14l|83f0r3|5h4p3d|m4rk3r|174l14|f4rm3r|m1l70n|v13nn4|h073l5|p3r10d|l4dd3r|83lk1n|d15h35|3l3v3n|4c7u4l|3qu17y|73573d|y34rly|5p33ch|5urr3y|4cc3n7|45p3c7|h3r035|w4lnu7|5h4r3d|50und5|c0un75|pr1c3d|v3r84l|9r00v3|f0rm4l|7ry1n9|m4r8l3|cl053r|d0u8l3|r1d1n9|fl0r4l|m0v3r5|7r347y|cr3473|f0rc3d|5h0w3d|5cr33n|5p34r5|50urc3|d1ld05|cl1n1c|k0r34n|4u7h0r|h319h7|j01n3d|8l4ck5|p4ck37|3x3mp7|3n73r5|w1nd0w|50v137|d4rw1n|w0rld5|9u1l7y|v10l1n|08741n|n3w813|fund3d|748l37|4cr055|3x73nd|8ur13d|m0d3rn|du8l1n|53n10r|r3910n|r3m41n|c4nc3l|l1m175|n33d3d|53450n|f41l3d|v4lu3d|3451ly|r1880n|17un35|cr1m35|84r3ly|0u7l37|4dju57|fru175|murd3r|15l4nd|r3c0rd|p0573r|d1r3c7|9r4d35|941n3d|20l0f7|174l1c|d19357|ch4r93|h38r3w|r47105|cl053d|h0ll0w|c4r1n9|r3j3c7|5ph3r3|r35cu3|h48175|l05535|c0m847|93n1u5|p0773r|m05c0w|7h3515|94l4xy|n0rm4l|m41d3n|57r41n|717l3d|3n71r3|m0d1fy|0xf0rd|455375|h0lm35|p1x3l5|1njury|3ff3c7|5c4l35|831n95|h424rd|4r0und|h4rv3y|l4wy3r|ch3qu3|fr023n|8hu74n|p473n7|3mpl0y|7074l5|5und4y|fr3323|c451n0|4ff0rd|3471n9|48r04d|7r1v14|p0r74l|u94nd4|un10n5|c0ur53|h0573l|m19h7y|l349u3|m1rr0r|7urn3r|9r4715|m1nu73|v4l1um|57r4nd|p3nc1l|70w4rd|k3rn3l|5p0k3n|upd473|570ck5|574y3d|8uy3r5|v0lum3|455157|0u7pu7|5u173d|4ny0n3|n3573d|l1k3ly|y13ld5|741w4n|3ff0r7|ch053n|r3d33m|r093r5|r3m3dy|r391m3|9r33c3|w15h35|84rn35|3xcu53|f13ld5|d3p3nd|d1ff3r|l480ur|20n1n9|53rv35|8r347h|c0m1c5|n19h75|d4y70n|c4ndl3|83h4lf|h0u535|l1qu1d|p0574l|35c0r7|571ck5|54l4ry|d3c3n7|7h3hun|l47357|83l0n9|h3r84l|l0v1n9|5h0uld|1n73nd|p07470|c0473d|p4l4c3|54v1n9|ch33r5|r47h3r|r35um3|v3r1fy|7w3n7y|d33m3d|f4v0r5|p1cn1c|4v474r|0ff1c3|f1n15h|5upply|8r3457|317h3r|cr3d17|h4ck3r|m4dr1d|m37r35|m4r91n|n080dy|h3lp3d|50l3ly|1mp053|f0u9h7|50d1um|d3519n|l4m8d4|h34d3d|v073r5|d3c1d3|4dw4r3|49r335|nud157|7h1nk5|5c0r3d|m3n70r|5747u5|8r0w53|8ru74l|cl0udy|d3l4y5|455ur3|p0573d|nv1d14|7r1ck5|k4n545|74r1ff|pl3n7y|p4n3l5|7hr047|19n0r3|cl0535|r3duc3|r4d105|w34l7h|70n9u3|unwr4p|9u1n34|d4n15h|chr0m3|v4cuum|mu5cl3|fr33ly|1nv357|d471n9|54cr3d|5k1ll5|wr1735|3n48l3|57471c|53ll3r|470m1c|4ppr0x|7uc50n|4r481c|8u1ld5|570l3n|c3n7r3|8351d3|f4m0u5|wr173r|f1l73r|4773nd|5h0w3r|1n74k3|l34d3r|4dv1c3|15r43l|v3rn0n|ch41n5|pl4735|3n9493|h4nd3d|c4r33r|l0n93r|qu073d|h0ld3m|3554y5|4dr14n|93nd3r|p1ckup|8r0n23|f41rly|w4ll37|c0nf19|r3n74l|83h1nd|5u84ru|mum841|53nd3r|d3f3nd|93n3v4|h0urly|533m3d|93rm4n|8uy1n9|h4r80r|fl19h7|4lw4y5|5p0u53|3x071c|v13w3r|519nup|r35ul7|8r13f5|4m813n|84nn3d|c0l0ur|v3nd0r|pr49u3|pu22l3|r151n9|4rc71c|5h13ld|m0un75|73n4n7|w45h3r|94rl1c|m41l3d|n0710n|pr0v3d|f1nd3r|un48l3|l4773r|4ff41r|p0ck37|74ckl3|5734dy|4ll0w5|h3473d|v3nu35|d14l09|54lm0n|m1ddl3|rul1n9|n1ck3l|w17h1n|h4rp3r|pl4n35|25h0p5|574735|3ur0p3|74k1n9|d1v1n3|w34p0n|71m83r|8urd3n|8undl3|1n53r7|3n2ym3|hud50n|v4lu35|357473|7r41l5|l0c4l3|pup1l5|4lumn1|cl1ck5|r4n935|d3f347|71ck37|c0m1n9|7r1835|c45u4l|49r33d|4774ch|p0l15h|3x7r45|70p1c5|f4c70r|f1n357|r34l7y|1nl1n3|cl4u53|7r4nc3|08j3c7|7r00p5|1nd00r|4u7umn|9r0up5|r0n4ld|8r0k3r|7h3m35|p0w3r5|701l37|r4nk3d|r0u735|p4ck3d|pr1357|1mp0r7|804rd5|57r34m|5h4d35|p0l1cy|8ump3r|l3n97h|53l3c7|71m3ly|74lk3d|r08075|57r1n9|54dd4m|p4r7ly|57r1c7|h3lm37|n0rw4y|w4750n|v1ll45|45k1n9|8l0ck5|53n50r|p331n9|519n3d|8r00k5|n3w70n|r3m1nd|d3pu7y|qu33n5|534l3d|wh1l57|cl13n7|84ll37|3800k5|l04d3d|pr0mp7|ph0705|5c3n35|4dv3r7|r3v34l|9u4rd|w1r35|5unny|4r80r|81n90|l33d5|3800k|c3d4r|chuck|d38u9|l0p32|h3l3n|574k3|pr083|8l41r|h0p35|m450n|8urn5|pump5|j4n37|m4r10|jul13|u71l5|8l3nd|d3p07|p41r5|m4pl3|r4c35|20n35|74p35|l1k35|ch053|54l3m|c4r90|l07u5|574mp|8l457|cl07h|7337h|d023n|p3rry|4u705|p17ch|l4u9h|7h374|m4cr0|ch347|f4rm5|51x7h|f4c3d|94u93|r1cky|m4r5h|5k1r7|k0d4k|8r4k3|5p4r3|8ru5h|c0n90|r3537|0l1v3|41m3d|cy83r|7h475|cl0n3|d1ck5|7ur80|r3l4y|734r5|54l0n|04515|4n9ry|5p075|941n5|533k5|r0ll5|w4nn4|m4l74|f3rry|9r41n|9r1ll|54v3r|0m4h4|c1v1c|0m394|l04d5|c3n75|m073l|8unch|fl337|r4lly|d15c5|nyl0n|n3p4l|8r0k3|4l13n|d3lh1|dy1n9|57uck|l473x|570p5|70n3r|drunk|r4nch|8451n|ch4rm|h4v3n|c0m80|54f3r|v0c4l|2dn37|0r94n|lyc05|l3m0n|70x1c|5l4v3|h0p3d|94735|81k35|v073d|l4nk4|pr0xy|f3w3r|fl0w5|834d5|f4r35|83nch|r1d3r|54uc3|ch453|4ll4h|8u775|5h33p|480u7|l4mp5|c4m3l|w4v35|w1n35|7runk|curv3|574ck|54l4d|c4r0l|5700d|p4573|4cu73|5734m|71r3d|5kyp3|c173d|533d5|07h3r|n0d35|15l4m|74l35|0u73r|f0705|4d0p7|l1k3d|5h3lf|kn1f3|v4lv3|cl0ud|r3l4x|cr0wd|57r4p|r081n|5w0rd|53ll5|m34l5|c0r4l|p1x3l|fl047|c0l1n|8l4d3|p47h5|h0l35|w31rd|r0u9h|4rr0w|4c1d5|5p0k3|d41ry|4dm17|f4ncy|54m04|80r3d|wh1ch|p4ck5|5qu4d|7r4c3|44r0n|c4mp5|7h31r|w4935|3554y|451d3|xh7ml|m4l35|519m4|f4v0r|f0n75|crud3|ch405|j34n5|m1ll5|wh347|cl3rk|1n7r0|4l1c3|491n9|84535|f41l5|3v4n5|un17y|8r1d3|839un|73x75|d3c0r|50ck5|l1v3r|c0rp5|r4lph|3553x|f33l5|47l45|h0575|7h3r3|93n35|f3v3r|5l075|d415y|drum5|l0053|l0v35|5h0r3|r0v3r|n08l3|r0075|9n0m3|w1nd5|fl4m3|74nk5|r0807|p03m5|3l173|5h007|d473d|5p3ll|5w1n9|7h3f7|3m1ly|m4n94|5123d|k3ny4|m4r13|9r455|d3v1l|4nn3x|84rry|5ud4n|flu1d|ru98y|k4r3n|f1r57|f4ul7|54ud1|9l0ry|h1n75|r0l35|r34d5|w0uld|f18r3|w0rry|w1r3d|70wn5|519h7|70n35|n4ncy|4r9u3|50lv3|4r153|cr419|w1l3y|7h353|j4m13|ch357|cl1ck|90nn4|70u9h|8r34d|r0535|p0und|k33p5|ch355|m0r4l|1c0n5|80057|m3nu5|8ur57|c4n4l|4m1n0|h3r85|f0lk5|p1ll5|ly1n9|n1k0n|70ky0|l4ur4|dr1ll|8ry4n|pr1c3|h088y|7r135|4rm3d|l4nd5|5m1l3|9r0wn|4r3n4|7r1ck|fl00d|73rry|ch1p5|v1574|1r4q1|7h1ck|my3r5|dr0p5|w1d3r|0p3n5|w3ll5|3n3my|5cr3w|m0d35|8l4m3|3xc3l|v174l|v3nu3|4cr35|7r4n5|qu357|pl424|8r455|f1f7y|m4r14|uncl3|ch1l3|l1nd4|k317h|pr1d3|j4c08|r4ndy|9h057|k3rry|d1ck3|8l0nd|8r1ck|n4v4l|9l083|7w1k1|j0k35|w00d5|d0nn4|c481n|y4rd5|p1224|d0d93|83457|3dd13|dr4wn|f1r3d|ch01r|380ny|p3r7h|w4ll5|5h0ck|5yr14|84k3r|kl31n|71r35|fl495|r37r0|k1n95|d14ry|l4k35|4n93r|r4d4r|5u175|h3nc3|9l3nn|57473|y13ld|m4y0r|c0ck5|f4c35|r04d5|h4ndy|5pr4y|cr0p5|9r0v3|1n73r|cr45h|9u1ld|r093r|fr4ud|80nd5|74lk5|9r4ph|f183r|73ll5|80475|7r183|fl0ur|w0r53|8u57y|rh0d3|7r3nd|7hr0w|m0v35|m4m80|5k1ll|l4rry|m0d3m|r1d93|3m41l|w1n95|847ch|pr0v3|4l1v3|4l73r|w4yn3|9h4n4|3d935|w0rld|7w1n5|pr123|f1f7h|4m3nd|f1nd5|4c70r|3p50n|ch1ck|n07r3|9r055|c01n5|7h0n9|m3d4l|8l1nd|4p4r7|w4lk5|5uck5|cr4f7|5m0k3|p1ck5|cr4ck|8007h|1nd13|m4k3r|80n35|8r33d|cr0wn|p0l4r|c0m1c|qu137|nur53|m591d|p4n75|h0n0r|w0r57|v1nyl|4n9l3|c4r3y|u5u4l|4l4rm|53475|d4nny|914n7|pr0ud|l3453|c4ch3|7urn5|51d35|7r1p5|74573|p4710|ll0yd|r0m4n|1nn3r|834n5|v1ll4|3ll15|4d4m5|5u54n|9r4c3|74mp4|m3375|qu1l7|pl4n3|m34n7|4f73r|719h7|jul14|83rry|l1v3d|hum0r|p33r5|8l4nk|45537|0p3r4|81ll5|m1lf5|l0905|h34d5|0u9h7|f1x35|53nd5|p34rl|m42d4|57r1p|m37r0|pul53|h0ld5|80075|du7ch|71m3r|h41ry|r4p1d|734ch|7yl3r|kn0ck|v3r53|h19h5|p0r75|r15k5|p14n0|wh3r3|7r347|3ll3n|m00r3|5h075|54v3d|r4ck5|n457y|81rd5|l0v3d|m4rk5|7um0r|w4775|5h1f7|w490n|39yp7|f0r7y|7u835|7w1c3|800k5|fl0yd|5pl17|8ruc3|qu3u3|f0r7h|d00r5|c0n57|745k5|5k1n5|d0u87|l1nk5|3x4m5|c47ch|50l4r|y34r5|5h3ll|w3l5h|83lly|y0ur5|70w3r|h4171|p0ll5|0rd3r|4ud17|d1ld0|lunch|84nd5|dr4m4|r4153|3ld3r|50n1c|n3wly|m1nd5|f00d5|m3y3r|cl4rk|7hum8|5w155|8r04d|173m5|l0d93|9r0up|7ruly|pl4y5|1d4h0|ul7r4|n0v3l|c23ch|7w157|p1l07|d3l4y|p41n7|4wful|d0ll5|r4nk5|d38u7|m1cr0|570rm|80und|3x4c7|5l1d3|93nr3|4ll3n|571ck|l3w15|my5ql|fru17|8r4v3|m373r|m0u7h|v0lv0|p3nny|834r5|d3n53|5c0p3|8lu35|1v0ry|537up|7r41l|r3m1x|4l145|c0574|n3w3r|5p1c3|f0r93|pl41n|51235|45c11|l091c|d0n0r|7r45h|m4n0r|d14n3|pl473|d15c0|3nd1f|c04ch|kn0w5|0ccur|und3r|5h4rp|9r33k|4rr4y|n0153|m1nu5|w1d7h|wh33l|3x157|m1x3d|u5493|f1rm5|1r15h|5h4p3|4w4r3|m1l4n|5h4d3|h1ll5|80x35|d1917|p4rk5|l10n5|5p3c5|p00l5|94m35|lyr1c|1d34l|m41n3|3mp7y|pr00f|r4710|9r4v3|cl0ck|5p3nd|l4y3r|h0w70|r3f3r|dr355|d3v0n|7r335|54v35|4d083|l088y|80nu5|c15c0|punch|d3l74|90774|d3v3l|4h34d|k4rm4|8377y|luc45|9u355|h3nry|r1n95|m4rd1|1n73l|5h4k3|dr1nk|h0lly|51lly|5c3n3|m3rcy|c0uld|5l33p|cycl3|h3lp5|9r4m5|f3nc3|d4v15|5p3n7|d14n4|n073d|m1n0r|5h4m3|w4l35|m14m1|f474l|fu22y|l34d5|fl35h|h073l|84nk5|k0r34|74m1l|f1l3d|f19h7|8y735|jud93|j3553|rur4l|71l35|qu3ry|5p34k|4n1m3|r0u73|f33d5|7r41n|d3p7h|519n5|0c34n|q474r|570r3|v0735|7ruck|5h33r|d1390|qu33n|w17ch|c0h3n|puppy|k47hy|4l3r7|w4n75|319h7|3nd3d|8r13f|c4rl0|cl1p5|73rm5|5m3ll|8l1nk|r19h7|c4rry|57475|f4ll5|f4l53|5471n|dr34m|8r41n|pr0m0|l0c4l|74x35|7un35|h4rry|l453r|n4m3d|7h053|7r13d|funny|54ny0|u51n9|734m5|k1nd5|c0d35|3qu4l|luc14|clu85|n3rv3|ch4r7|dr4f7|r3n3w|0wn3d|f1lm5|7ru7h|94mm4|50rry|r34ch|m0v3d|ch41n|f417h|l0ck5|f4c75|48u53|v1ru5|3ur05|81r7h|4v01d|r383l|5c00p|l471n|h1r3d|5m4r7|m0un7|53rv3|904l5|70uch|ph0n3|h1ndu|f0rum|8453d|7h3m3|50l1d|h34vy|k1ll5|l480r|70ur5|ur84n|cr33k|84dly|5l0p3|5h0p5|573p5|l0u15|8394n|n41l5|l1m17|wh475|r1d35|r3h48|pr1m3|upp3r|d4735|ch3ck|m3r17|fr35h|j01n7|dru95|541n7|d15k5|c0nd0|4l0n3|54n74|f41ry|5h4f7|c4510|p47ch|cl41m|1nd3x|dr41n|m0n73|f1r35|831n9|c0un7|cr1m3|5h1r7|p4n1c|m070r|l30n3|ph453|ch41r|0n10n|w4573|c4n0n|l483l|70d4y|83475|m3rry|5cu84|8uy3r|v3rd3|73575|570n3|l1v35|dr13d|wh053|c4ll5|l00k5|c3ll5|0ld3r|53v3n|5h337|p13c3|d3r8y|50u7h|v3945|5u173|818l3|cl34n|r0y4l|8391n|h34rd|p4935|91v35|ch13f|fr4m3|574nd|5c4l3|4nn13|d3r3k|f0und|5734l|8l095|f34r5|49r33|9r4n7|7un3r|c0457|p34c3|4l1k3|ph070|w0r7h|fully|wh1l3|5493m|h4nd5|wr0n9|f1x3d|50n95|5733l|c1v1l|8l0ck|5c0u7|d34l7|8uck5|d4nc3|84d93|wr157|8r34k|h347h|y0u7h|l3xu5|5p41n|m4y83|900d5|57493|r34lm|53n53|y3m3n|0x1d3|pl4n7|8u535|1544c|m47ch|fl00r|p4n3l|9r4d3|r0u93|y3457|mul71|7hr33|7ru57|533m5|9u357|7074l|fund5|k3nny|pl4c3|m374l|yuk0n|5h1p5|wr073|un175|7r14l|9r4nd|51n9h|8r00k|v4l1d|493n7|1npu7|8r1n9|w1v35|74k35|0wn3r|l1575|x3r0x|qu173|r473d|3x7r4|7h1nk|50r75|4w4rd|v5n37|84515|p4pu4|4rm0r|174ly|m4rc0|n0k14|34r7h|8l00d|n0r7h|8u1l7|r0und|p0575|r34dy|5p0r7|pr10r|7h4nk|v1r4l|p1p35|9l455|l4d3n|4ru84|f0rm5|m3r93|3d94r|du841|c0m35|m3d14|v01c3|4ll4n|5p3rm|f1lm3|cr4p5|fr057|54lly|y4ch7|7r4cy|r00m5|wh4l3|f0cu5|c4u53|4514n|h0m35|4ll0w|1d345|51nc3|9u1d3|5h4rk|5h0wn|9r0w5|cl1ff|7r4c7|804rd|5c0r3|5m4ll|c48l3|5h1n3|w0m4n|j0yc3|w3ndy|d1ff5|l34v3|020n3|n4m35|p4574|53rum|un10n|5w1f7|l0w3r|1n80x|f0c4l|w33k5|cr055|54m84|45k3d|4pply|l1n35|7yp35|8u1ld|71m35|pl4n5|v13w5|w0und|83ll3|4l8um|51735|l3v3l|r1v3r|c1ndy|f0rc3|l1n3d|n0735|3n7ry|5h035|l04n5|d01n9|f477y|57uff|80x3d|cu81c|8r4nd|5p33d|4m0n9|4l0n9|5h0w5|8451c|l473r|wh0l3|5p135|qu1ck|3l3c7|c4535|kn0wn|74k3n|1nd14|m4k35|cl34r|710n5|3rr0r|h34r7|fly3r|l1nux|w0rd5|d34l5|w47ch|0f73n|4pn1c|847h5|c0v3r|3m4c5|cl1m8|91f75|7h1rd|5p4rc|ch34p|d0v3r|7h1n9|4dul7|f1n4l|rul35|w0rk5|70k3n|50und|m1l35|34rly|p4r75|fr0n7|57yl3|k1nd4|c0575|dyl4n|83l75|8urk3|h0ur5|d41ly|m34n5|cl4r4|7r0u7|5h0r7|dr1v3|cl053|5p1n3|flu5h|h4y35|7r4d3|l3457|7r4ck|m0535|c0l0r|j0hn5|un71l|r4d10|j3w3l|73ddy|p4x1l|1m493|dry3r|4dd3d|5h4r3|rul3d|funky|ch1ld|j01n5|c4rd5|5p4c3|5c4ry|4r345|mp395|m4j0r|m0n7h|m19h7|c4k35|n33d5|ch1n4|m1x3r|3v3n7|717l3|f1l35|58jc7|91v3n|7007h|x4n4x|0ff3r|574y5|dr0v3|wr173|up537|4ud10|c0ur7|m1n35|r4n93|155u3|l094n|p0k3r|n19h7|5h4ll|cl455|p4p3r|f13ld|571ll|r4735|l4nc3|570ry|qu073|84c0n|n193r|480v3|l394l|l091n|c0l0n|l4n35|pur53|83l0w|70p1c|u53r5|n3v3r|4pr1l|4941n|4l19n|8l355|574ff|cr357|57udy|901n9|y4h00|0r817|4ll0y|m4rch|pl075|7ul54|c453y|3v3ry|dr4w5|hum4n|8l00m|v1517|m0d3l|574r7|748l3|l4r93|l00p5|5ur93|74h03|54l35|700l5|p01n7|570ck|50ul5|5p4nk|8l4k3|pr1n7|l34rn|v4ul7|r3ply|pr355|v4lu3|m41l5|pd45|800m|c4lm|l1m3|r4r3|c475|cl4n|y0ur|h00d|w45h|w34r|5ync|0v3n|8495|m354|p3nn|j422|1n70|f41l|8374|l375|f0n7|f0ld|d053|p053|847h|51ck|m394|d4mn|f0rk|r0ll|7r0y|r34l|173m|5p1n|23r0|null|384y|7h1n|c3n7|m0n0|4c1d|5p4m|p493|m1n7|74p3|hull|cup5|w1r3|mu57|71l3|cl1p|5335|m374|d0u9|8l0w|200m|c0p3|d3ck|h4v3|kn3w|5h3d|h4n9|m3m0|10w4|71d3|p1p3|l4ck|l135|n3x7|941n|du7y|funk|p1ll|c4p5|20p3|83nd|m4d3|r33l|534l|v1c3|h0n9|w4n9|71r3|81nd|r4nd|d35k|m4r5|d15k|54nd|8uck|l1n3|9m8h|u595|u53d|5h03|4cr3|v13w|v01d|71ll|1r0n|cu75|51m5|l0w5|c7rl|4qu4|ch3n|3mm4|7r4y|470m|5345|c4f3|70n5|4ndy|51n9|p357|53m1|53nd|4pp5|fl49|f04m|ch3f|41d5|50ul|r33f|5l1p|f3l7|c457|7yp3|c4k3|70dd|hur7|1n7l|5493|w0rk|m34l|94n9|ch4n|3nd5|k1ck|ch4d|1c0n|f175|837h|hu90|8047|p03m|d15c|93n3|j1ll|m0m5|8008|l173|f0r7|c140|50f4|d14l|luck|90n3|k473|kn33|pr3p|lun9|d4n5|51lk|k3n0|ch3m|5u53|cu84|w17h|v111|f1ll|qu17|c4mp|f0ul|l457|5n0w|74k3|j375|833n|1nch|c4v3|73n7|d13d|l34f|50n5|k0n9|m473|m057|35pn|d3p7|h4ck|d4r3|m4rc|w00l|r4nk|83l7|h4wk|cr0p|j05h|7u83|0n35|pr05|94v3|d474|l4m8|m0r3|r41l|71ny|h1r3|0dd5|j4d3|w1n9|4r34|533m|w4n7|m4k3|w153|7h3m|n3ck|1p0d|8u5y|c0d3|r1ch|713d|70n3|dr0p|9uy5|7r1m|l0n3|7495|9473|3y3d|l04d|5h0w|p057|8lvd|3v3n|junk|9r48|lucy|8u95|h4n5|80n3|l405|w34k|p037|c4n7|w3r3|cl4y|00p5|l41d|c17y|3p1c|d33r|m347|dr49|54k3|p1ck|p33r|7h3y|0ur5|533d|7h47|r053|50l3|5p45|5uch|w417|w4lk|fu3l|n30n|p4r4|50f7|w4r3|54n5|7r4p|50m3|f00l|l34n|745k|m155|w1ld|8357|h347|cu73|pm1d|j3w5|45k5|8ulk|k4rl|7hru|c0rd|lu15|493d|h00k|m455|f007|5urf|ju4n|5c4n|7h3n|r1p3|much|pr0c|80ld|c0ld|834n|519n|r3ly|9r3y|4l70|83d5|d135|f1l3|5h07|p1nk|l1nk|0p3n|r007|l1k3|h475|3x4m|90r3|3d93|cul7|d45h|0r4l|l485|c493|kur7|x80x|4nn3|p41n|n0rm|5p3c|d1vx|54r4|p4lm|m1lf|hu9h|w1nd|50ld|3v4l|904l|j41l|p1n9|84ll|pump|pl07|n1ck|8urn|dvd5|7h4n|jump|833f|n31l|f1rm|5173|9070|flux|9l3n|l075|p373|934r|4rmy|d137|5k1p|mu23|w3ll|c453|m1ll|h4rm|p450|0clc|0m4n|n454|5m7p|54m3|ur93|80m8|r493|4d5l|j04n|pr1x|l4w5|pull|8145|p47h|duck|n053|53p7|fl0w|fl47|l10n|20n3|h175|7h41|w1f3|v01p|9r1d|807h|9035|1p4q|h34r|3ch0|hun7|451n|4v0n|l0rd|8y73|r4y5|c0mm|f4rm|3y35|7h15|w4l7|p00r|hd7v|50up|4cn3|7r1p|d34d|l185|und0|kn17|94m3|ch4r|d1v3|l4c3|9375|d4n4|h4l0|0h10|m1d1|3r1k|l4wn|4rch|f1nd|r1ck|u9ly|94y5|741l|f41r|ch1p|y4rn|158n|3x3c|9ulf|h057|1nf0|c4r3|h4r7|5u17|d4rk|r3n7|w00d|73nd|5375|m3n7|p1n3|c04l|c0r3|d387|jury|m45k|r4p3|8175|7h0u|04k5|m4u1|f1j1|r4c3|80rn|nc44|wh47|d473|p4ck|5c51|h19h|m1n1|d0n7|p00l|9493|810l|r357|d33p|80l7|80y5|1r4q|84ck|7w1n|4ud1|7485|r0w5|v1d5|r1n9|d0wn|m4ry|pr3v|5k1n|f335|d4l3|34rn|y4l3|34ch|0r9y|5hu7|3453|j4n3|j4v4|f070|r41d|d00m|u535|4514|j053|83n7|0w3n|v0l7|8173|155n|7r30|8r4d|d34r|my7h|90d5|cur3|7135|d00r|p0l3|4l4n|m15c|f337|drum|70ld|w33d|d1r7|5w1m|c0mp|rul3|03cd|w4y5|pu5h|p0ly|34r5|v073|phy5|w1n3|f157|d1c3|p1k3|9l0w|qu4d|d0ck|70p5|8007|m0d5|834m|w4ll|7hu5|v3ry|7r33|m3r3|n4n0|m1lk|4n4l|4r48|r0m3|h41r|h1n7|v4ry|94ry|p41d|c0n5|5h1p|m513|j03l|c0nf|n3w5|4n71|h4ll|w4k3|7r3k|74x1|8uy5|l4n9|qu12|f33d|l00p|l157|r1c3|54f3|h473|4c3r|p0rk|f4k3|m00d|d157|cdn4|d3m0|wr4p|800k|h0ld|9r4y|d34l|p155|m4p5|h1ll|n0v4|r34d|84rn|c01n|5394|f4r3|45u5|5l07|nu75|700l|p4y5|84ld|n33d|n41l|fuj1|d15h|l30n|m0ld|d4m3|5123|m4ny|9r3w|pu75|w0rn|1d34|f4ll|h3r8|4l07|l473|5h4w|u53r|cn37|50n9|n4m3|74ll|700k|1dl3|m4l3|3xp0|541d|v457|fund|933k|5p4n|m0d3|50l0|n4vy|w3n7|l34d|5h0p|xnxx|84nd|4nn4|74nk|c0rn|53n7|80wl|51nk|m3n5|73x7|m1l3|n1c3|r055|l090|d3ny|m0v3|k1nd|73mp|84l1|judy|hu93|l0ck|n0d3|m1c3|c0v3|7r10|r33d|8u5h|c454|u5p5|h0ur|cu83|f1n3|r34r|r473|8055|7un3|n1k3|j0k3|l395|cr3w|c4m3|921p|3d3n|r0l3|1ncl|w15h|h0p3|ru95|m3nu|70ur|8483|l057|m1nd|h3ld|c4m5|w4rm|500n|d035|01l5|r31d|dr4w|l3n5|r4ck|fl3x|570p|h3ll|pur3|r054|dr3w|h45h|p0r7|533n|9r1p|l42y|l0ud|cr4p|f473|c45h|v154|c4r8|p1c5|dru9|p3ru|c0py|f0rm|w1n5|m34n|7urn|p3n5|574y|j34n|9l4d|d0c5|h77p|w477|9r45|w0rm|r475|n34r|8453|80nd|un1x|d34f|ph1l|f4c3|l055|h7ml|p0ll|m475|r1c0|d34n|l4mp|ch47|d0ll|50ny|y094|mp39|m35h|l4k3|n0n3|4c75|8l4h|m1m3|h0ly|573p|p1n5|ru5h|h4lf|w4v3|50r7|r3n0|0v4l|w1d3|f30f|k3y5|luk3|l04n|50m4|1r4n|3x17|70y5|u5d4|ju57|573m|70wn|k33n|p345|un70|url5|501l|8d5m|m1n5|r15k|84nk|f33l|k175|hr3f|m337|83n2|73ch|un17|f4c7|m41n|f457|0wn5|3d17|fr0m|4u70|plu5|71p5|533k|w1f1|713r|34rl|3l53|7ru3|k1d5|n75c|p0l0|nud3|l053|0v3r|541l|l1p5|81k3|p3rl|74lk|c4ll|k155|c00k|w0rd|21nc|r00f|9uru|plu9|4935|3v3r|l3vy|h0rn|5747|ru8y|r1c4|w4rd|f347|9r4d|k1ll|8r45|l4n3|d0n3|l4nd|54y5|9u4m|up0n|f1v3|c173|p457|w1ll|kyl3|pr07|m41l|4r75|c047|c4rl|90ld|fr09|lynn|83ll|d4wn|54l7|p4l3|3995|48l3|73ll|c4r5|74l3|5ur3|full|0nc3|p34k|un1v|4w4y|53lf|m355|c3ll|w493|3ur0|94p5|l095|734r|cru2|p4c3|4dd5|k3n7|f1lm|73rm|n357|3v1l|l1f3|0nly|n470|8u77|punk|k33p|kn0w|94l3|53x0|y34h|h4nd|run5|9047|h3r0|wh3n|w1k1|8105|m4r7|du57|574n|5n4p|710n|1d0l|p41r|p0ur|r1d3|r0p3|p375|h0l3|345y|9un5|d1ff|dump|h0m3|0n70|r41n|4x15|534n|f4m3|9r0w|800l|5p07|n1n3|f0ur|f4q5|h053|91f7|r04d|5l0w|clu8|p0nd|5l1m|y34r|3457|m055|jp39|h1d3|80dy|u74h|y4rd|53ll|f3ll|h3r3|504p|4rm5|91v3|c0rk|51d3|5w4p|p4rk|8347|7h33|m4l1|ru7h|m4ll|k3p7|8l09|pr4y|w4r5|l355|d4y5|f34r|c0l3|d0m3|l1f7|pl4y|c0rp|m00n|fl1p|p0p3|c4r7|mrn4|h157|d095|c0m3|pu85|p4r7|july|m47h|h33l|8ull|wh0m|0k4y|4l50|y4n9|c057|f0lk|c4p3|70ll|81d5|pl4n|1333|41m5|5347|d3ll|jun3|p4d5|j33p|l1v3|f4n5|h3lp|n073|w33k|54v3|l4dy|734m|l3f7|l00k|84r3|w357|j01n|hun9|15l3|81rd|r00m|k1rk|8u22|r153|m1ld|dum8|54l3|du4l|1nn5|nuk3|9r39|f00d|n00n|j085|84r5|c4rd|57ud|y0rk|485|c37|97k|lcd|0ur|k17|rrp|810|3x7|p05|hu8|fwd|j4n|9h2|73l|51m|d4m|d3r|l12|d35|u7c|q7y|cu7|rn4|ccd|0r9|j4r|534|l18|7hu|0u7|455|cv5|l48|w17|h47|d4y|4u5|l47|cnn|ml8|819|7u3|0n3|r0n|c55|flu|0dd|40l|hwy|mh2|748|399|3p4|83n|000|3n7|n4m|53q|9nu|r4w|llp|83d|plc|80c|p1n|l4w|7v5|9dp|p19|r1d|w1n|0p7|p33|n84|c48|c05|m47|504|ppc|1nc|p4c|l1l|3rp|55l|f19|4r3|dvd|d1v|1nk|c4p|7mp|d45|473|qu3|2u5|rpm|4r7|l05|l7d|vpn|4cc|fcc|1nn|m4p|cd5|l17|9p5|n3c|88w|w3d|j03|3d5|f1n|un4|d47|d3f|mud|70p|un1|53n|fr1|1r4|837|w4n|m49|nh5|95m|4y3|mph|w4x|74n|84n|1m9|p07|y0u|d3l|5m5|d0n|h4d|573|4d4|81d|21p|n4v|v4l|547|f3d|w0w|517|pr3|5ql|r35|71m|nu7|l4n|7w0|jp9|m14|51x|945|urw|ddr|c91|c0m|r3c|m0n|v1d|j1m|dn4|l0l|2um|u5r|d5l|l4y|l85|pd4|1ll|c0l|h1v|d07|4l4|c4l|51c|yr5|m1d|f00|d1p|n8c|1r5|ch0|pdf|8u9|3ur|n0r|u54|984|v11|8y3|cd7|j0n|f0r|w4y|54d|d09|833|4n4|h1p|84r|r1p|5rc|5py|1n5|15p|70y|4p1|qu1|18m|93l|r0m|mp9|703|84y|519|5ky|du0|r4n|d5c|c45|cpu|4v9|c10|d0w|k1m|j0y|849|734|5r1|upc|88c|du1|157|8u5|y3n|f09|8uf|1p5|h3y|d1r|53c|llc|mu9|717|51r|5h3|p3n|l1d|817|01l|1c3|34u|u53|7u8|3xp|hr5|57r|10n|m1l|k3n|fly|v47|04k|0n5|7cp|cfr|pvc|r0d|d4n|un3|cum|www|r0y|80w|530|m37|5k1|73x|70n|f17|808|v1p|m4d|5um|71p|l4p|c14|4nn|p4d|l35|cm5|rfc|c4n|41m|150|4pp|jun|50l|347|1d5|d0d|m17|4ny|3c0|n30|jul|3v3|y34|c4d|p0d|47m|540|847|u5d|l33|r3p|f4r|91f|fur|3n8|0ld|mr5|d05|p4r|74r|57d|h0w|r0w|71l|v0l|cup|d3v|p13|9uy|50c|j37|84d|9mc|kd3|nhl|4v1|4md|w70|m0m|h4y|nfl|d19|c30|p37|9ym|4cm|v14|5y5|c57|d0c|u5c|45p|n47|4pr|4rc|0wn|l1p|9cc|w0n|490|54p|d13|154|c47|3r4|ch1|4u9|r47|73n|und|url|v4r|4l7|r08|9pl|f4n|pr0|l3d|n07|533|93n|v1c|m4r|5u8|812|p5p|p1x|1nd|ru9|m1c|du3|8mw|p0r|45n|70m|m0d|45k|l07|53x|dp1|h15|915|53p|f38|xxx|n3w|885|4mp|1d3|p57|fun|733|l0c|p4l|54w|p4n|r10|03m|f4q|f47|l09|8uy|rp9|d3m|94p|w4v|h0n|7r1|ppm|j4y|1c7|14n|k1d|1rc|90d|up5|c0n|4n7|4k4|7ry|474|48c|pu7|n1l|45h|5p4|n37|run|4p7|p4m|dry|r3f|pmc|h4m|200|crm|1nf|305|41d|l13|m1n|c0p|m3l|l39|713|r55|c0x|5un|d1m|vcr|j4m|ur1|l45|175|f33|m5n|93m|y37|nyc|dn5|f81|m3d|444|wh0|f4x|r4y|m3m|pc1|f7p|8r4|w38|37c|m41|pd7|m43|php|98p|79p|n0v|w4r|0ff|u58|54m|34r|cry|l30|n5w|f1x|vh5|71n|3y3|h3r|p4y|0c7|h45|1n9|n0n|m1x|4ud|h17|why|749|784|5u3|493|48u|p51|513|d3n|f3w|74p|pc7|p7y|d1y|k3y|m4y|9un|1n7|p0p|5ku|n0w|4dd|4l1|r3d|4c7|phd|4d5|c85|h0p|fd4|4nd|4r9|l37|r39|d75|73d|qld|p45|v4n|907|c0d|m7v|c1r|74x|3v4|m84|9u1|pu8|ph1|l3u|d1d|w45|rc4|54n|v3r|537|51n|r1m|3nd|r3v|d3c|23n|wm4|m59|p1c|3d7|54y|d15|930|957|5c1|ml5|c0w|80n|919|h07|7hy|y35|545|d03|81n|50x|h1m|4c3|8u7|41r|l0u|p47|4my|xml|k4y|471|m4x|p9p|d4d|9m7|111|v0n|w4l|m4c|94y|80x|m45|7f7|51p|50n|357|5ur|d33|m3n|l3n|53r|k41|700|4rm|1cq|3n9|80y|pc5|d0m|j08|jvc|l0w|f0x|4ll|p17|r4m|w37|937|p75|p3r|c4m|r4p|c4r|m4n|4v3|08j|7h3","g");
var wordLength = 9034;
</script>

<!--Key and Lock functions-->
<script>
//initialize a few global variables used for GUI interaction
var callKey = '',
	BasicButtons = true,
	fullAccess = true,
	allowCancelWfullAccess = false;

//global variables used for key box expiration
var keytimer = 0,
	keytime = new Date().getTime();

//Alphabets for base conversion. Used in making and reading the ezLok format
var base36 = '0123456789abcdefghijkLmnopqrstuvwxyz',									//L is capital for readability
	base64 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

//function to test key strength and come up with appropriate key stretching. Based on WiseHash
function keyStrength(string,location) {
	var entropy = entropycalc(string),
		msg,colorName;

	if(entropy == 0){
		msg = 'This is a known bad Password!';
		colorName = 'magenta'
	}else if(entropy < 20){
		msg = 'Terrible!';
		colorName = 'magenta'
	}else if(entropy < 40){
		msg = 'Weak!';
		colorName = 'red'
	}else if(entropy < 60){
		msg = 'Medium';
		colorName = 'darkorange'
	}else if(entropy < 90){
		msg = 'Good!';
		colorName = 'green'
	}else if(entropy < 120){
		msg = 'Great!';
		colorName = 'blue'
	}else{
		msg = 'Overkill  !!';
		colorName = 'cyan'
	}

	var iter = Math.max(1,Math.min(20,Math.ceil(24 - entropy/5)));			//set the scrypt iteration exponent based on entropy: 1 for entropy >= 120, 20(max) for entropy <= 20

	var seconds = time10/10000*Math.pow(2,iter-8);			//to tell the user how long it will take, in seconds
	if(BasicButtons){
		var msg = 'Key strength: ' + msg + '\r\nUp to ' + Math.max(0.01,seconds.toPrecision(3)) + ' sec. to process'
	}else{
		var msg = 'Key entropy: ' + Math.round(entropy*100)/100 + ' bits. ' + msg + '\r\nUp to ' + Math.max(0.01,seconds.toPrecision(3)) + ' sec. to process'
	}
	if(location){
		var msgName = location + 'Msg';
		document.getElementById(msgName).textContent = msg;
		hashili(msgName,string);
		document.getElementById(msgName).style.color = colorName
	}
	return iter
}

//takes a string and calculates its entropy in bits, taking into account the kinds of characters used and parts that may be in the general wordlist (reduced credit) or the blacklist (no credit)
function entropycalc(pwd){

//find the raw Keyspace
	var numberRegex = new RegExp("^(?=.*[0-9]).*$", "g");
	var smallRegex = new RegExp("^(?=.*[a-z]).*$", "g");
	var capRegex = new RegExp("^(?=.*[A-Z]).*$", "g");
	var base64Regex = new RegExp("^(?=.*[/+]).*$", "g");
	var otherRegex = new RegExp("^(?=.*[^a-zA-Z0-9/+]).*$", "g");

	pwd = pwd.replace(/\s/g,'');										//no credit for spaces

	var Ncount = 0;
	if(numberRegex.test(pwd)){
		Ncount = Ncount + 10;
	}
	if(smallRegex.test(pwd)){
		Ncount = Ncount + 26;
	}
	if(capRegex.test(pwd)){
		Ncount = Ncount + 26;
	}
	if(base64Regex.test(pwd)){
		Ncount = Ncount + 2;
	}
	if(otherRegex.test(pwd)){
		Ncount = Ncount + 31;											//assume only printable characters
	}

//start by finding words that might be on the blacklist (no credit)
	var pwd = reduceVariants(pwd);
	var wordsFound = pwd.match(blackListExp);							//array containing words found on the blacklist
	if(wordsFound){
		for(var i = 0; i < wordsFound.length;i++){
			pwd = pwd.replace(wordsFound[i],'');						//remove them from the string
		}
	}

//now look for regular words on the wordlist
	wordsFound = pwd.match(wordListExp);									//array containing words found on the regular wordlist
	if(wordsFound){
		wordsFound = wordsFound.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});	//remove duplicates from the list
		var foundLength = wordsFound.length;							//to give credit for words found we need to count how many
		for(var i = 0; i < wordsFound.length;i++){
			pwd = pwd.replace(new RegExp(wordsFound[i], "g"),'');									//remove all instances
		}
	}else{
		var foundLength = 0;
	}

	pwd = pwd.replace(/(.+?)\1+/g,'$1');								//no credit for repeated consecutive character groups

	if(pwd != ''){
		return (pwd.length*Math.log(Ncount) + foundLength*Math.log(wordLength + blackLength))/Math.LN2
	}else{
		return (foundLength*Math.log(wordLength + blackLength))/Math.LN2
	}
}

//take into account common substitutions, ignore spaces and case
function reduceVariants(string){
	return string.toLowerCase().replace(/[óòöôõo]/g,'0').replace(/[!íìïîi]/g,'1').replace(/[z]/g,'2').replace(/[éèëêe]/g,'3').replace(/[@áàäâãa]/g,'4').replace(/[$s]/g,'5').replace(/[t]/g,'7').replace(/[b]/g,'8').replace(/[g]/g,'9').replace(/[úùüû]/g,'u')
}

//replaces back variant characters, opposite of reduceVariants
function replaceVariants(string){
	return string.replace(/0/g,'o').replace(/1/g,'i').replace(/2/g,'z').replace(/3/g,'e').replace(/4/g,'a').replace(/5/g,'s').replace(/7/g,'t').replace(/8/g,'b').replace(/9/g,'g')
}

//makes 'pronounceable' hash of a string, so user can be sure the password was entered correctly
var vowel = 'aeiou',
	consonant = 'bcdfghjklmnprstvwxyz',
	hashiliTimer;

function hashili(msgID,string){
	var element = document.getElementById(msgID);
	clearTimeout(hashiliTimer);
	hashiliTimer = setTimeout(function(){
		if(!string.trim()){
			element.innerText += ''
		}else{
			var code = nacl.hash(nacl.util.decodeUTF8(string.trim())).slice(-2),			//take last 4 bytes of the SHA512		
				code10 = ((code[0]*256)+code[1]) % 10000,		//convert to decimal
				output = '';

			for(var i = 0; i < 2; i++){
				var remainder = code10 % 100;								//there are 5 vowels and 20 consonants; encode every 2 digits into a pair
				output += consonant[Math.floor(remainder / 5)] + vowel[remainder % 5];
				code10 = (code10 - remainder) / 100
			}
			element.innerText += '\n' + output
		}
	}, 1000);						//one second delay to display hashili
}

//these derive from the Key after running through scrypt stretching. BitArray format. Dir (salt=userName) is 32-byte, Sgn (salt=email, Edwards curve) is 64-byte; DH (Motgomery curve, deriving from Sgn) is 32-byte, myEmail is a string.
var KeyStr,
	KeyDir,
	KeySgn,
	KeyDH,
	myEmail = '';

//reads Key box and stops if there's something wrong. If the timer has run out, the Key is deleted from box, and stretched keys are deleted from memory
function refreshKey(){
	clearTimeout(keytimer);
	var period = 300000;

//start timer to erase Key
	keytimer = setTimeout(function() {
		resetKeys();
	}, period);

//erase key at end of period, by a different way
	if ((new Date().getTime() - keytime > period)) {
		resetKeys();
	}
    keytime = new Date().getTime();

	if (!KeyStr){
		any2key();
		if(callKey == 'initkey'){
			pwdMsg.textContent = 'Welcome to PassLok Privacy\r\nPlease enter your secret Key'
		}else{
			pwdMsg.textContent = 'Please enter your secret Key';
			shadow.style.display = 'block'
		}
		return false
	}
	return true
}

//resets the Keys in memory when the timer ticks off
function resetKeys(){
	KeyStr = '';
	KeyDir = '';
	KeySgn = '';
	KeyDH = '';
	myEmail = '';
	pwdBox.value = '';
	imageBox.value = ''
}

//reads email from the box. This is used as a salt to make the Lock
function readEmail(){
	if(myEmail) return myEmail;
	if(locDir['myself'] && fullAccess){
		if(locDir['myself'][0]){
			var decrypted = keyDecrypt(locDir['myself'][0]);
			if(decrypted == undefined) return undefined;
			return decrypted
		}
	}
	var email = emailBox.value;
	if (email == "" && emailScr.style.display != 'block'){
		any2email();
		return false
	};
	return email.trim()
}

var userName = '';

//to initialize a new user. Executed by final button in new user wizard
function initUser(){
	var key = pwdIntroBox.value,
		email = emailIntro.value,
		isNewUser = true;
	userName = nameIntro.value;
	myEmail = email.trim();

	if (key.trim() == '' || userName.trim() == ''){
		intromsg2.textContent = 'The User Name or the Key box is empty. Please go back and ensure both are filled.';
		return
	}
	pwdIntroBox.value = '';
	emailIntro.value = '';
	openClose('introscr5');

	if(!localStorage[userName]){
		locDir = {};
		localStorage[userName] = JSON.stringify(locDir)
	}
	locDir = JSON.parse(localStorage[userName]);
	mainMsg.textContent = '';
	var blinker = document.createElement('span'),
		msgText = document.createElement('span');
	blinker.className = "blink";
	blinker.textContent = "LOADING...";
	msgText.textContent = " for best speed, use at least a Medium Key";
	mainMsg.appendChild(blinker);
	mainMsg.appendChild(msgText);
	key2any();

setTimeout(function(){									//do the rest after a short while to give time for the key screen to show
	KeyStr = key;
	KeyDir = wiseHash(key,userName);							//storage stretched key loaded into memory, will be used right away

	if(ChromeSyncOn){											//if sync is available, get settings only from sync, then the rest
		var syncName = userName+'.myself';
		chrome.storage.sync.get(syncName.toLowerCase(), function (obj) {
			var lockdata = obj[syncName.toLowerCase()];
			if(lockdata){											//the user isn't totally new: retrieve settings
				locDir['myself'] = JSON.parse(lockdata);
				email = keyDecrypt(locDir['myself'][0]);
				if(!email) return;
				retrieveAllSync();
				isNewUser = false;
				setTimeout(function(){fillList();mainMsg.textContent = 'Settings synced from Chrome';}, 500);
			}else{													//user never seen before: store settings
				locDir['myself'] = [];
				locDir['myself'][0] = keyEncrypt(email);			//email/token is stored, encrypted by Key+userName
				if(!locDir['myself'][0]) return;
				syncChromeLock('myself',locDir['myself'][0]);
				setTimeout(function(){fillList();}, 500);
			}
			if(email) myEmail = email;
			localStorage[userName] = JSON.stringify(locDir);
			lockNames = Object.keys(locDir);
			KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(key,email)).secretKey;		//make the Edwards curve secret key first
			KeyDH = ed2curve.convertSecretKey(KeySgn);								//and then the Montgomery curve key
			showLock();
		});
	}else{															//if not, store the email
		if(!locDir['myself']) locDir['myself'] = [];
		locDir['myself'][0] = keyEncrypt(email);
		if(!locDir['myself'][0]) return;
		localStorage[userName] = JSON.stringify(locDir);
		lockNames = Object.keys(locDir);
		KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(key,email)).secretKey;
		KeyDH = ed2curve.convertSecretKey(KeySgn);
		showLock();
		setTimeout(function(){fillList();}, 500);
	}
	if(ChromeSyncOn) syncCheck.style.display = 'block';
	getSettings();
	if(inviteBox.checked) sendMail();
	
	//if from a QR code or invitation, get the Lock from the URL and add it to the directory
	var hash = decodeURI(window.location.hash).slice(1);								//check for data in the URL
	if(hash.length == 43){										//as from a QR code
		var hashStripped = hash
	}else{														//as from an invitation, etc.
		var hashStripped = hash.match('==(.*)==') || [' ',' '];
		hashStripped = hashStripped[1];
		hashStripped = extractLock(hashStripped)
	}
	if (hashStripped.length == 43 || hashStripped.length == 50){			//sender's Lock
		lockBox.textContent = hashStripped;
		addLock(true)
	}

	setTimeout(function(){ makeGreeting(isNewUser)}, 30);									//fill Main box with a special greeting
},30);
}

//makes a special encrypted greeting for a new user
function makeGreeting(isNewUser){
	var Lock = lockDisplay().split('==')[1];
	if(isNewUser){
		var greeting = "<div>Congratulations! You have decrypted your first message.</div><div><br></div><div>Remember, this is your Lock, which you should give to other people so they can encrypt messages and files that only you can decrypt:</div><div><br></div>" + Lock + "<div><div><br></div><div>You can display it at any time by clicking <b>myLock</b> with the main box empty.</div><div><br></div><div>It is already entered into the local directory (top box), under name 'myself'. When you add your friends' Locks or shared Keys by pasting them into the main box or clicking the <b>Edit</b> button, they will appear in the directory so you can encrypt items that they will be able to decrypt. If someone invited you, that person should be there already.</div><div><br></div><div>Try encrypting this back: click on <b>myself</b> in the directory in order to select your Lock, and then click <b>Encrypt</b></div></div><div><br></div><div>You won't be able to decrypt this back if you select someone else's name before you click <b>Encrypt</b>, but that person will.</div><div><br></div><div><a href='https://passlok.com/learn'>Right-click and open this link</a> to reload PassLok along with a series of tutorials.</div>";
		Encrypt_List(['myself'],greeting);
		var welcomeMsg = document.createElement('div');
		welcomeMsg.textContent = "Welcome to PassLok!\r\n\r\nYour Lock is:\r\n\r\n" + Lock + "\r\n\r\nYou want to give this Lock to your friends so they can encrypt messages that only you can decrypt. You will need *their* Locks in order to encrypt messages for them. You can display it any time by clicking myLock with the main box empty.\r\n\r\nEncrypted messages look like the gibberish below this line. Go ahead and decrypt it by clicking the Decrypt button.\r\n\r\n";
		mainBox.insertBefore(welcomeMsg,mainBox.firstChild);
		mainMsg.textContent = "PassLok Privacy";
		updateButtons();
	}
}

//checks that the Key is the same as before, resumes operation. Executed by OK button in key entry dialog
function acceptpwd(){
	var key = pwdBox.value.trim();
	if(key == ''){
		pwdMsg.textContent = 'Please enter your Key';
		return
	}
	if(key.length < 4){
		pwdMsg.textContent = 'This Key is too short!';
		return
	}

	var x = document.getElementById('nameList');
	if (x.options.length == 2){						//only one user, no need to select it
		userName = x.options[1].value
	}else{												//several users
		for (var i = 0; i < x.options.length; i++) {
    		if(x.options[i].selected){
				userName = x.options[i].value
    		}
  		}
	}
	if (userName == '' && fullAccess){
		pwdMsg.textContent = 'Please select a user name, or make a new one';
		return
	}
	if(Object.keys(locDir).length == 0 && localStorage[userName]) locDir = JSON.parse(localStorage[userName]);
	if(firstInit){
		mainMsg.textContent = '';
		var blinker = document.createElement('span'),
			msgText = document.createElement('span');
		blinker.className = "blink";
		blinker.textContent = "LOADING...";
		msgText.textContent = " for best speed, use at least a Medium Key";
		mainMsg.appendChild(blinker);
		mainMsg.appendChild(msgText);
	}
	KeyStr = key;
	key2any();

setTimeout(function(){									//execute after a 30 ms delay so the key entry dialog can go away
	if(locDir['myself']){
		if(!fullAccess){									//OK so far, now check that the Key is good; at the same time populate email and generate stretched Keys
			locDir['myself'][3] = 'guest mode';
			localStorage[userName] = JSON.stringify(locDir);
			mainMsg.textContent = 'You have limited access to functions. For full access, reload and enter the Key'
		}
		if(!checkKey(key)) return;							//check the key and bail out if fail
		getSettings();

		var hash = decodeURI(window.location.hash).slice(1);								//check for data in the URL
		if(hash.length == 43 || hash.length == 50){										//as from a QR code
			var hashStripped = hash
		}else{														//as from an invitation, etc.
			var hashStripped = hash.match('==(.*)==') || [' ',' '];
			hashStripped = hashStripped[1];
			hashStripped = extractLock(hashStripped)
		}
		
		if (hashStripped.length == 43 || hashStripped.length == 50){			//sender's Lock
			lockBox.textContent = hashStripped;
			addLock(true);
			
		}else{								//process automatically the other kinds; most will need a Lock to be selected first.
			if(hash) mainBox.textContent = hash;
			var type = hashStripped.charAt(0);
			if(type == 'A' || type == 'k'){						//anonymous or key-encrypted
				unlock(type,hashStripped,'')
			}else if(type == 'l'){
				setTimeout(function(){mainMsg.textContent= "Please select the sender and click Unseal"; updateButtons();},300)
			}else if(hash){
				setTimeout(function(){mainMsg.textContent= "Please select the sender and click Decrypt"; updateButtons();},300)
			}
		}

		if(ChromeSyncOn && chromeSyncMode.checked){
			syncChromeLock('myself',JSON.stringify(locDir['myself']))
		}
	}else{													//if stored settings are not present: ask for email, compute stretched Keys. Store stuff if full access
		if(firstInit) KeyDir = wiseHash(key,userName);

		if(ChromeSyncOn && chromeSyncMode.checked && firstInit){	//the Chrome app gets the settings from sync, asynchronously
			var syncName = userName+'.myself';
    		chrome.storage.sync.get(syncName.toLowerCase(), function (obj) {
				var lockdata = obj[syncName.toLowerCase()];
				if(lockdata){											//the user isn't totally new: retrieve settings
					locDir['myself'] = JSON.parse(lockdata);
					email = keyDecrypt(locDir['myself'][0]);
					if(email){myEmail = email}else{return}
					localStorage[userName] = JSON.stringify(locDir);
					retrieveAllSync();
					setTimeout(function(){mainMsg.textContent = 'Settings retrieved Chrome sync';}, 500);
				}else{													//user missing in sync: store settings
					var email = readEmail();
					locDir['myself'] = [];
					locDir['myself'][0] = keyEncrypt(email);
					if(!locDir['myself'][0]) return;
					localStorage[userName] = JSON.stringify(locDir);
					syncChromeLock('myself',JSON.stringify(locDir['myself']));
				}
				lockNames = Object.keys(locDir);
				KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(key,email)).secretKey;		//make the Edwards curve secret key first
				KeyDH = ed2curve.convertSecretKey(KeySgn);								//and then the Montgomery curve key
			});
		} else {											//no sync, so ask user for email and go on making Keys
			firstInit = false;
			var email = readEmail();
			KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(key,email)).secretKey;
			KeyDH = ed2curve.convertSecretKey(KeySgn);
			locDir['myself'] = [];
			locDir['myself'][0] = keyEncrypt(email);
			if(!locDir['myself'][0]) return;
			localStorage[userName] = JSON.stringify(locDir);
		}
		checkboxStore();
	}
	pwdBox.value = '';																		//all done, so empty the box
	
	if(Object.keys(locDir).length == 1 || Object.keys(locDir).length == 0){		//new user, so display a fuller message
		mainMsg.textContent = 'To encrypt a message for someone, you must first enter the recipient’s Lock or shared Key by clicking the Edit button'
	}
	if (callKey == 'encrypt'){						//now complete whatever was being done when the Key was found missing
		lockBtnAction()
	}else if(callKey == 'decrypt'){
		lockBtnAction()
	}else if(callKey == 'sign'){
		signVerify()
	}else if(callKey == 'addlock'){
		openClose('lockScr');
		openClose('shadow');
		addLock(false)
	}else if(callKey == 'decryptitem'){
		decryptItem()
	}else if(callKey == 'decryptlock'){
		decryptLock()
	}else if(callKey == 'mergedb'){
		mergeLockDB()
	}else if(callKey == 'movedb'){
		moveLockDB()
	} else if(callKey == 'showlock'){
		showLock()
	} else if(callKey == 'fillbox'){
		fillBox()
	} else if(callKey == 'changekey'){
		acceptnewKey()
	} else if(callKey == 'changename'){
		name2any()
	} else if(callKey == 'changeemail'){
		email2any()
	} else if(callKey == 'movemyself'){
		moveMyself()
	}
	focusBox()
},30);
}

var locDir = {},
	lockNames = [],
	myLock,
	myLockStr,
	myezLock,
	firstInit = true;

//sticky settings are stored in array 'myself' on directory; here is a breakdown of what each index contains:
//0: email/token, encrypted by Key; 1: checkbox code, plain; 2: color scheme; 3: full access on or off, plain

//function to initialize locDir and interface for the user
function getSettings(){
	if(userName in localStorage){
		if(Object.keys(locDir).length == 0) locDir = JSON.parse(localStorage[userName]);	//database in Object form. Global variable
		lockNames = Object.keys(locDir);												//array for finding Lock names. Global variable
		if(locDir['myself']){															//initialize permanent settings
			if(!firstInit) return;														//skip the rest if it's not the first time
			if(locDir['myself'][3] == 'guest mode'){
				setTimeout(function(){				//add delay so messages are seen and recrypt doesn't get in the way
					if(fullAccess){
						var reply = confirm("Last user did not enter the right Key. Would you like to re-encrypt the local directory?");
						if(reply){
							recryptDB(KeyStr,userName);
							mainMsg.textContent = 'The local directory has been re-encrypted'
						}else{
							mainMsg.textContent = 'WARNING: last session was in Guest mode'
						}
					}else{
						mainMsg.textContent = 'Last session was also in Guest mode'
					}
				}, 500);
				locDir['myself'][3] = 'full access';
				localStorage[userName] = JSON.stringify(locDir);
			}
			code2checkbox();										//set checkboxes

			if(ChromeSyncOn && chromeSyncMode.checked) retrieveAllSync();
		}
	}
	fillList();
	resetList();
	firstInit = false;
	setTimeout(function(){
		mainMsg.textContent = 'PassLok is ready'
	},100)
}

//try decrypting the email/token in 'myself' to see if the Key is the same as the last one used. Then populate email box and generate stretched keys and Lock
var checkingKey = false;

function checkKey(key){
	checkingKey = true;
	KeyDir = wiseHash(key,userName);
	if(fullAccess){
		var myEmailcrypt = locDir['myself'][0];
		var email = keyDecrypt(myEmailcrypt);				//this will fail if the Key is not the last one used, displaying a message
		if(!checkingKey) return false;
		if(email){
			myEmail = email
		}else{
			myEmail = readEmail()
		}
	}else{
		myEmail = readEmail();
	}
	KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(key,myEmail)).secretKey;
	KeyDH = ed2curve.convertSecretKey(KeySgn);
	if(!myLock){
		myLock = nacl.sign.keyPair.fromSecretKey(KeySgn).publicKey;
		myLockStr = nacl.util.encodeBase64(myLock).replace(/=+$/,'');
		myezLock = changeBase(myLockStr, base64, base36, true);
	}
	checkingKey = false;
	return true
}

//display Lock in the lower box of the Main tab.
function showLock(){
	if(showLockBtn.textContent == 'Email'){		//redirect to email if not ready to show Lock
		sendMail();
		return
	}
	callKey = 'showlock';
	if(learnMode.checked){
		var reply = confirm("The Lock matching the Key in this box will be placed in the lower box, replacing its contents. Cancel if this is not what you want.");
		if(!reply) return;
	};

	if(!refreshKey()) return;
	if(!locDir['myself']) locDir['myself'] = [];
	if(!myLock){
		myLock = nacl.sign.keyPair.fromSecretKey(KeySgn).publicKey;
		myLockStr = nacl.util.encodeBase64(myLock).replace(/=+$/,'');	//the Lock derives from the signing Key
		myezLock = changeBase(myLockStr, base64, base36, true);
	}

	//done calculating, now display it
	mainBox.textContent = lockDisplay();
	mainMsg.textContent = "The Lock matching your Key is in the box. Send it to people to communicate";
	updateButtons();
	showLockBtn.textContent = 'Email';
	showLockBtnBasic.textContent = 'Email';
	callKey = '';
}

//extracts Lock at the start of an item, from an invitation or PassLok for Email, or data in the URL
function extractLock(string){
		var CGParts = stripTags(removeHTMLtags(string)).replace(/-/g,'').split('//////');				//if PassLok for Email or SeeOnce item, extract ezLock, filter anyway
		if(CGParts[0].length == 50){
			var possibleLock = CGParts[0],
				possibleLock64 = changeBase(possibleLock, base36, base64, true);
			string = string.slice(56)
		}else if(CGParts[0].length == 43){
			var possibleLock = CGParts[0],
				possibleLock64 = possibleLock;
			string = string.slice(49)
		}else{
			var possibleLock = removeHTMLtags(string)
		}

		var wordsStr = possibleLock.match('==') ? possibleLock.split('==')[1].replace(/_/g,' ').trim() : possibleLock.replace(/_/g,' ').trim(),
			words = wordsStr.split(' ');					//for word Locks in URL
		if(words.length == 20){
			possibleLock = changeBase(wordsStr,wordListExp,base64,true);			//convert to base64
			if(!possibleLock) return false
		}
		
		if(possibleLock.length == 43 || possibleLock.length == 50){
			var index = 0, foundIndex;
			for(var name in locDir){
				if(locDir[name][0] == possibleLock || locDir[name][0] == possibleLock64){
					foundIndex = index	
				}
				index++
			}
			if(foundIndex != null){															//found it, so select this user
				lockList.options[foundIndex+1].selected = true;
				fillBox()
			}else{																				//not found, so store after asking for a name
				lockBox.textContent = possibleLock;
				addLock(true)
			}
		}
		return string
}

//just to display the Lock. Gets called above and in one more place
function lockDisplay(){
	if(ezLokMode.checked){
		var mylocktemp = myezLock;
		mylocktemp = mylocktemp.match(/.{1,5}/g).join("-");					//split into groups of five, for easy reading
		mylocktemp = "PL24ezLok==" + mylocktemp + "==PL24ezLok"
	}else if(normalLockMode.checked){
		var mylocktemp = myLockStr;
		mylocktemp = "PL24lok==" + mylocktemp + "==PL24lok"
	}else{
		mylocktemp = "PL24wordLok==" + changeBase(myLockStr,base64,wordListExp,true) + "==PL24wordLok"
	}
	return mylocktemp
}

//stores email if missing
function storemyEmail(){
	if(!locDir['myself']) locDir['myself'] = [];
	locDir['myself'][0] = keyEncrypt(readEmail());
	if(!locDir['myself'][0]) return;
	localStorage[userName] = JSON.stringify(locDir);

	if(ChromeSyncOn && chromeSyncMode.checked){
		syncChromeLock('myself',JSON.stringify(locDir['myself']))
	}
}

//stretches a password string with a salt string to make a 256-bit Uint8Array Key
function wiseHash(pwd,salt){
	var iter = keyStrength(pwd,false),
		secArray = new Uint8Array(32),
		keyBytes;
	if(salt.length == 43) iter = 1;								//random salt: no extra stretching needed
	scrypt(pwd,salt,iter,8,32,0,function(x){keyBytes=x;});
	for(var i=0;i<32;i++){
			secArray[i] = keyBytes[i]
	}
	return secArray
}

//returns milliseconds for 10 scrypt runs at iter=10 so the user can know how long wiseHash will take; called at the end of body script
function hashTime10(){
	var before = Date.now();
	for (var i=0; i<10; i++){
		scrypt('hello','world',10,8,32,0,function(){});
	}
	return Date.now() - before
}

//makes the DH public array and a DH secret key array. Returns a uint8 array
function makePub(sec){
	return nacl.box.keyPair.fromSecretKey(sec).publicKey
}

//Diffie-Hellman combination of a DH public key and a DH secret key array. Returns Uint8Array
function makeShared(pub,sec){
	return nacl.box.before(pub,sec)
}

//makes the DH public key (Montgomery) from a published Lock, which is a Signing public key (Edwards)
function convertPub(Lock){
	return ed2curve.convertPublicKey(Lock)
}

//stretches nonce to 24 bytes. The rest is left undefined
function makeNonce24(nonce){
	var	result = new Uint8Array(24);
	for(i = 0; i < nonce.length; i++){result[i] = nonce[i]}
	return result
}

//encrypt string with a shared Key, returns a uint8 array
function PLencrypt(plainstr,nonce24,sharedKey,isCompressed){
	if(!isCompressed || plainstr.match('="data:')){						//no compression if it includes a file
		var plain = nacl.util.decodeUTF8(plainstr)
	}else{
		var plain = LZString.compressToUint8Array(plainstr)
	}
	return nacl.secretbox(plain,nonce24,sharedKey)
}

//decrypt string (or uint8 array) with a shared Key. Var 'label' is to display messages
function PLdecrypt(cipherStr,nonce24,sharedKey,isCompressed,label){
	if(typeof cipherStr == 'string'){
		var cipher = nacl.util.decodeBase64(cipherStr);
		if(!cipher) return false
	}else{
		var cipher = cipherStr
	}
	var	plain = nacl.secretbox.open(cipher,nonce24,sharedKey);					//decryption instruction
	if(!plain){failedDecrypt(label);return false};

	if(!isCompressed || plain.join().match(",61,34,100,97,116,97,58,")){		//this is '="data:' after encoding
		return nacl.util.encodeUTF8(plain)
	}else{
		return LZString.decompressFromUint8Array(plain)
	}
}

//encrypts a string or uint8 array with the secret Key, 9 byte nonce, padding so length for ASCII input is the same no matter what. The input can also be binary, and then it won't be padded
function keyEncrypt(plainstr){
	if(!refreshKey()) return undefined;																		//make sure the Key is still alive
	var	nonce = nacl.randomBytes(9),
		nonce24 = makeNonce24(nonce);
	if(typeof plainstr == 'string'){
		plainstr = encodeURI(plainstr).replace(/%20/g,' ');
		while (plainstr.length < 43) plainstr = plainstr + ' ';
		var cipher = PLencrypt(plainstr,nonce24,KeyDir,false)
	}else{
		var cipher = nacl.secretbox(plainstr,nonce24,KeyDir)
	}
	return nacl.util.encodeBase64(concatUint8Arrays([144],concatUint8Arrays(nonce,cipher))).replace(/=+$/,'')		//1st character should be k
}

//decrypts a string encrypted with the secret Key, 9 byte nonce. Returns original if not encrypted. If isArray set, return uint8 array
function keyDecrypt(cipherStr,isArray){
	var cipher = nacl.util.decodeBase64(cipherStr.replace(/[^a-zA-Z0-9+\/]+/g,''));
	if(!cipher) return false;
	if (cipher[0] == 144){
		if(!refreshKey()) return undefined;											//make sure the Key is still alive
		var	nonce = cipher.slice(1,10),												//ignore the marker byte
			nonce24 = makeNonce24(nonce),
			cipher2 = cipher.slice(10);
		if(isArray){
			var plain = nacl.secretbox.open(cipher2,nonce24,KeyDir);
			if(!plain) return;
			return plain
		}else{
			var plain = PLdecrypt(cipher2,nonce24,KeyDir,false,'key');
			if(!plain) return;
			return decodeURI(plain.trim())
		}
	}else{
		return cipherStr
	}
}

//this strips initial and final tags, plus spaces and non-base64 characters in the middle
function stripTags(string){
	string = string.replace(/\s/g,'').replace(/==+/,'==');										//remove spaces, reduce multiple = to double
	if(string.match('==')) string = string.split('==')[1].replace(/<(.*?)>/gi,"");
	string = string.replace(/[^a-zA-Z0-9+\/]+/g,''); 											//takes out anything that is not base64
	return string
}

//removes stuff between angle brackets
function removeHTMLtags(string){
	return string.replace(/<(.*?)>/gi, "")
}

//this one escapes dangerous characters, preserving non-breaking spaces
function escapeHTML(str){
	escapeHTML.replacements = { "&": "&amp;", '"': "&quot;", "'": "&#039;", "<": "&lt;", ">": "&gt;" };
	str = str.replace(/&nbsp;/gi,'non-breaking-space')
	str = str.replace(/[&"'<>]/g, function (m){
		return escapeHTML.replacements[m];
	});
	return str.replace(/non-breaking-space/g,'&nbsp;')
}

//remove XSS vectors using DOMPurify
function decryptSanitizer(string){
	return DOMPurify.sanitize(string, {ADD_DATA_URI_TAGS: ['a']})
}

var nameBeingUnlocked = '';

//this function replaces an item with its value on the locDir database, decrypted if necessary, if the name exists
function replaceByItem(name){
	var fullName = '',
		index = searchStringInArrayDB(name,lockNames);
	if (index < 0){									//not on database; strip it if it's a Lock
		var stripped = stripTags(name);
		if(stripped.length == 43 || stripped.length == 50){fullName = stripped}else{fullName = name}
	} else if(name == 'myself'){
		if(myLock) fullName = myLockStr
	} else {									//found name on DB, so get value from the database and decrypt if necessary
		fullName = lockNames[index];
		var string = locDir[fullName][0];
		nameBeingUnlocked = fullName;
		var whole = keyDecrypt(string);
		if(!whole) return undefined;
		nameBeingUnlocked = '';
		var	stripped = stripTags(whole);
		if(stripped.length == 43 || stripped.length == 50) {fullName = stripped} else {fullName = whole}		//if it's a Lock, strip tags
	}
	return fullName
}

//changes the base of a number. inAlpha and outAlpha are strings containing the base code for the original and target bases, as in '0123456789' for decimal. Bases can be string, words separated by spaces, or RegExp
//adapted from http://snippetrepo.com/snippets/bignum-base-conversion, by kybernetikos
function changeBase(numberIn, inAlpha, outAlpha, isLock) {
	var isWordsIn = inAlpha instanceof RegExp || inAlpha.match(' '),				//detect whether it's words into string, or the opposite
		isWordsOut = outAlpha instanceof RegExp || outAlpha.match(' ');			//could be RegExp or space-delimited
		
	//split alphabets into array
	var alphaIn = isWordsIn ? (inAlpha instanceof RegExp ? inAlpha.toString().slice(1,-2).split('|') : inAlpha.trim().split(' ')) : inAlpha.split(''),
		alphaOut = isWordsOut ? (outAlpha instanceof RegExp ? outAlpha.toString().slice(1,-2).split('|') : outAlpha.trim().split(' ')) : outAlpha.split('');
	
	var targetBase = alphaOut.length,
		originalBase = alphaIn.length;
    var result = [],
		number = isWordsIn ? numberIn.trim().replace(/ +/g,' ').split(' ') : numberIn.split('');
		
	if(isWordsIn){										//convert words into dictionary variants
		for(var i = 0; i < number.length; i++){
			number[i] = reduceVariants(number[i])
		}
	}
	
    while (number.length > 0) {
        var remainingToConvert = [], resultDigit = 0;
        for (var position = 0; position < number.length; ++position) {
            var idx = alphaIn.indexOf(number[position]);
            if (idx < 0) {
				if(lockScr.style.display == 'block'){
					lockMsg.textContent = "Word '" + replaceVariants(number[position]) + "' in word Lock not found in dictionary. Please check"
				}else{
					mainMsg.textContent = "Word '" + replaceVariants(number[position]) + "' in pasted word Lock not found in dictionary. Please check"
				}
					return false
            }
            var currentValue = idx + resultDigit * originalBase;
            var remainDigit = Math.floor(currentValue / targetBase);
            resultDigit = currentValue % targetBase;
            if (remainingToConvert.length || remainDigit) {
                remainingToConvert.push(alphaIn[remainDigit])
            }
        }
        number = remainingToConvert;
        result.push(alphaOut[resultDigit])
    }
	
	if(isLock){													//add leading zeroes in Locks
		var lockLength = isWordsOut ? 20 : ((targetBase == 36) ? 50 : 43);
		while(result.length < lockLength) result.push(alphaOut[0])
	}
	result.reverse();
	
	if(isWordsOut){											//convert to regular words
		for(var i = 0; i < result.length; i++){
			result[i] = replaceVariants(result[i])
		}
	}

    return isWordsOut ? result.join(' ') : result.join('')
}

//puts an 43-character random string in the 'emailBox' boxes
function randomToken(){
	var token = nacl.util.encodeBase64(nacl.randomBytes(32)).slice(0,43);
	emailIntro.value = token;
	emailBox.value = token;
}

//takes appropriate UI action if decryption fails
function failedDecrypt(label){
	pwdMsg.style.color = '';
	mainMsg.style.color = '';
	if(checkingKey){
		shadow.style.display = 'block';
		keyScr.style.display = 'block';
		pwdMsg.textContent = "Please write the last Key you used. You can change the Key in Options";
		checkingKey = false
	}else if(lockBox.textContent.trim().slice(0,1) == 'k' || isList || nameBeingUnlocked != '' || label == 'key'){
		any2key();					//this displays the Key entry dialog
		pwdMsg.textContent = "This Key won't decrypt the item " + nameBeingUnlocked;
		allowCancelWfullAccess = true
	}else if(keyChange.style.display == 'block'){
		keyChange.style.display = 'none';
		pwdMsg.textContent = "The Old Key is wrong"
	}else if(label == 'decoy'){
		mainMsg.textContent = 'No hidden message was found'
	}else if(label == 'read-once' && !decoyMode.checked){
		mainMsg.textContent = 'Read-once decrypt has Failed. You may have to reset the exchange with this sender';	
	}else if(!decoyMode.checked){
		mainMsg.textContent = 'Decryption has failed'
	}
	return
}
</script>

<!--cryptographic functions-->
<script>
//function that starts it all when the Decrypt button is pushed
function lock(lockBoxHTML,plainText){
	blinkMsg(mainMsg);
	setTimeout(function(){																			//the rest after a 10 ms delay
		Encrypt_Single(lockBoxHTML,plainText);
		updateButtons()
	},10);
}

//function that starts it all when the Decrypt button is pushed
function unlock(type,cipherText,lockBoxHTML){
	blinkMsg(mainMsg);
	setTimeout(function(){																			//the rest after a 10 ms delay
		Decrypt_Single(type,cipherText,lockBoxHTML);
		updateButtons()
	},10);
}

//Encryption process: determines the kind of encryption by looking at the radio buttons and check boxes under the main box and the length of the presumed Lock
//This function handles short mode encryption only (no List). Otherwise, Encrypt_List() is called
function Encrypt_Single(lockBoxItem,text){
	callKey = 'encrypt';
	if(lockBoxItem == ""){
		mainMsg.textContent = 'You must select a stored Lock or shared Key, or click Edit and enter one.';
		return
	}

	if(lockBoxItem.length*entropyPerChar > (mainBox.textContent.length + 64) * 8 && lockBoxItem.length > 43){		//special mode for long keys, first cut
		padEncrypt(text);
		return
	}

	var listArray = lockBoxItem.replace(/<div>/g,'<br>').replace(/<\/div>/g,'').split('<br>');		//see if this is actually several Locks rather than one

	var lockBoxNoVideo = listArray[0].trim(),					//strip video URL, if any
		lockBoxHold = lockBoxNoVideo,								//to hold it in case it is a name
		LockStr = replaceByItem(lockBoxNoVideo),				//if it's the name of a stored item, use the decrypted item instead, if not and it isn't a Lock, there will be a warning. This function removes tags and non-base64 chars from true Locks only
		name = lockBoxNoVideo;
	
	if(LockStr.split('~').length == 3){																//key is three strings separated by tildes: human-computable encryption
		lockBox.textContent = LockStr;
		humanEncrypt(text,true);
		return
	}	
	
	if(longMode.checked){							//Encrypt_Single() handles only short and compatible modes, otherwise Encrypt_List() is used instead
		if(emailMode.checked && listArray.length < 2 && LockStr.length != 43 && LockStr.length != 50){		//likely a shared Key, so go on, switching momentarily to Compatible mode
			var isLong = true;
			compatMode.checked = true
		}else{
			Encrypt_List(listArray,text);
			return
		}
	}else if (listArray.length > 1 && listArray[1].slice(0,4) != 'http'){			//this is a List, which is not compatible with short mode, video URLs on 2nd line don't count
		if(emailMode.checked){
			mainMsg.textContent = 'Only one shared Key allowed in Email mode'
		}else{
			mainMsg.textContent = 'Short and Compatible modes not available for multiple recipients'
		}
		return
	}	

	if(locDir[lockBoxNoVideo]) name = lockBoxNoVideo;
	if (LockStr.length == 50) LockStr = changeBase(LockStr.toLowerCase().replace(/l/g,'L'), base36, base64, true); 		//ezLok replaced by regular Lock
	var nonce = nacl.randomBytes(9),
		nonce24 = makeNonce24(nonce),
		nonceStr = nacl.util.encodeBase64(nonce),
		clipped = false;
	if(shortMode.checked){
		text = encodeURI(text).replace(/%20/g,' ')
	}
	
		//now we do the different encryption modes
	if(LockStr.length != 43 && !onceMode.checked){				//shared Key-locked mode, if no true Lock is entered
		if(learnMode.checked){
			var reply3 = confirm("The contents of the main box will be encrypted with the shared Key in the Locks box, and the result will replace the main box. Cancel if this is not what you want.");
			if(!reply3) return
		}
		var sharedKey = wiseHash(LockStr,nonceStr);		//use the nonce for stretching the user-supplied Key
		if(shortMode.checked){
			if (text.length > 94) clipped = true;  			//94-char capacity
			text = text.slice(0,94);
			while (text.length < 94) text += ' '
		}
		var cipher = PLencrypt(text,nonce24,sharedKey,compatMode.checked);				//will compress if not a short message
		if(learnMode.checked){
			alert(name + " will need to place the same Key in the Locks box to decrypt the message in the main box.")
		}	

		var outString = nacl.util.encodeBase64(concatUint8Arrays([128],concatUint8Arrays(nonce,cipher))).replace(/=+$/,'');			//1st character is g
		if(compatMode.checked){
			mainBox.textContent = '';
			if(fileMode.checked){
				if(textMode.checked){
					var fileLink = document.createElement('a');
					fileLink.download = "PL24msg.txt";
					fileLink.href = "data:," + outString;
					fileLink.textContent = "PassLok 2.4 shared Key encrypted message (text file)"
				}else{
					var fileLink = document.createElement('a');
					fileLink.download = "PL24msg.plk";
					fileLink.href = "data:binary/octet-stream;base64," + outString;
					fileLink.textContent = "PassLok 2.4 shared Key encrypted message (binary file)"
				}
			}else if(emailMode.checked){
				var fileLink = document.createElement('pre');
				fileLink.textContent = "----------begin shared Key message encrypted with PassLok--------==\r\n\r\n" + outString.match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end shared Key message encrypted with PassLok-----------"
			}else{
				var fileLink = document.createElement('pre');
				fileLink.textContent = ("PL24msg==" + outString + "==PL24msg").match(/.{1,80}/g).join("\r\n")
			}
			mainBox.appendChild(fileLink)
		}else{
			mainBox.textContent = outString
		}
	}

	else if(signedMode.checked){					//signed mode, make encryption key from secret Key and recipient's Lock
		if(learnMode.checked){
			var reply3 = confirm("The contents of the main box will be encrypted with your secret secret Key and the Lock in the Locks box, and the result will replace the main box. Cancel if this is not what you want.");
			if(!reply3) return
		}
		if(!refreshKey()) return;
		if(!locDir[name] && locDir[lockBoxHold]) name = lockBoxHold;				//get name from Lock area
		var LockBin = nacl.util.decodeBase64(LockStr);
		if(!LockBin) return false;
		var sharedKey = makeShared(convertPub(LockBin),KeyDH);
		if(shortMode.checked){
			if (text.length > 94) clipped = true;  						//94-char capacity
			text = text.slice(0,94);
			while (text.length < 94) text += ' '
		}
		var cipher = PLencrypt(text,nonce24,sharedKey,compatMode.checked);
		if(learnMode.checked){
			alert(lockMsg + " will need your Lock and his/her secret Key to decrypt the message in the main box.");
		}

		var outString = nacl.util.encodeBase64(concatUint8Arrays([176],concatUint8Arrays(nonce,cipher))).replace(/=+$/,'');			//1st character is s
		if(compatMode.checked){
			mainBox.textContent = '';
			if(fileMode.checked){
				if(textMode.checked){
					var fileLink = document.createElement('a');
					fileLink.download = "PL24mss.txt";
					fileLink.href = "data:," + myezLock + '//////' + outString;
					fileLink.textContent = "PassLok 2.4 Signed message (text file)"
				}else{
					var fileLink = document.createElement('a');
					fileLink.download = "PL24mss.plk";
					fileLink.href = "data:binary/octet-stream;base64," + myezLock + '//////' + outString;
					fileLink.textContent = "PassLok 2.4 Signed message (binary file)"
				}
			}else{
				var fileLink = document.createElement('pre');
				fileLink.textContent = ("PL24mss==" + myezLock + '//////' + outString + "==PL24mss").match(/.{1,80}/g).join("\r\n")
			}
			mainBox.appendChild(fileLink)
		}else{
			mainBox.textContent = outString
		}
	}

	else if(anonMode.checked){								//anonymous mode, using only the recipient's Lock
		if(learnMode.checked){
			var reply = confirm("The contents of the main box will be encrypted with the Lock in the Locks box and the result will be placed in the main box. This is irreversible. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(name == '') name = "the recipient";
		var secdum = nacl.randomBytes(32),							//make dummy Key
			pubdum = makePub(secdum),							//matching dummy Lock
			LockBin = nacl.util.decodeBase64(LockStr);
		if(!LockBin) return false;
		var	sharedKey = makeShared(convertPub(LockBin),secdum);
		if(shortMode.checked){
			if (text.length > 62) clipped = true;  			//62-char capacity because of the dummy Lock
			text = text.slice(0,62);
			while (text.length < 62) text += ' '
		}
		var cipher = PLencrypt(text,nonce24,sharedKey,compatMode.checked);
		if(learnMode.checked){
			alert(name + " will need to place his/her secret Key in the key box to decrypt the message in the main box.");
		}

		var outString = nacl.util.encodeBase64(concatUint8Arrays([104],concatUint8Arrays(nonce,concatUint8Arrays(pubdum,cipher)))).replace(/=+$/,'');			//1st character is a
		if(compatMode.checked){
			mainBox.textContent = '';
			if(fileMode.checked){
				if(textMode.checked){
					var fileLink = document.createElement('a');
					fileLink.download = "PL24msa.txt";
					fileLink.href = "data:," + myezLock + '//////' + outString;
					fileLink.textContent = "PassLok 2.4 Anonymous message (text file)"
				}else{
					var fileLink = document.createElement('a');
					fileLink.download = "PL24msa.plk";
					fileLink.href = "data:binary/octet-stream;base64," + myezLock + '//////' + outString;
					fileLink.textContent = "PassLok 2.4 Anonymous message (binary file)"
				}
			}else{
				var fileLink = document.createElement('pre');
				fileLink.textContent = ("PL24msa==" + myezLock + '//////' + outString + "==PL24msa").match(/.{1,80}/g).join("\r\n")
			}
			mainBox.appendChild(fileLink)
		}else{
			mainBox.textContent = outString
		}
	}

	else if(onceMode.checked){									//Read-once mode
		if(name == 'myself'){
			mainMsg.textContent = 'You cannot encrypt for yourself in Read-once mode';
			return
		}
		if(learnMode.checked){
			var reply3 = confirm("The contents of the main box will be encrypted so it can only be read once, and the result will replace the main box. Cancel if this is not what you want.");
			if(!reply3) return
		};
		if(locDir[name] == null){
			mainMsg.textContent = "In Read-once mode the recipient's Lock must be stored";
			return
		}
		if(!refreshKey()) return;

		var lastKeyCipher = locDir[name][1],
			lastLockCipher = locDir[name][2],
			turnstring = locDir[name][3],
			secdum = nacl.randomBytes(32);

		if(lastKeyCipher){
			var lastKey = keyDecrypt(lastKeyCipher,true)		//use array output option
			if(!lastKey) return
		}else{													//use new dummy Key if stored dummy doesn't exist, warn user
			var lastKey = secdum,
				pfsMessage = true
		}

		if(lastLockCipher){										//if dummy exists, decrypt it first
			var lastLock = keyDecrypt(lastLockCipher,true);
			if(!lastLock) return
		}else{													//use permanent Lock if dummy doesn't exist
			if(LockStr.length == 43){
				var LockBin = nacl.util.decodeBase64(LockStr);
				if(!LockBin) return false;
				var lastLock = convertPub(LockBin);					//Lock is actually a signing public key; must be converted
			}else{
				var lastLock = makePub(wiseHash(LockStr,nonceStr))		//if actually a shared Key, make the Lock deriving from it
			}
			var resetMessage = true
		}
		var sharedKey = makeShared(lastLock,lastKey);

		if (turnstring != 'lock'){								//if out of turn don't change the dummy Key, this includes reset
			if(turnstring == 'reset'){var resetMessage = true }else{ var pfsMessage = true};
			if(lastLockCipher){
				if(LockStr.length == 43){
					var newLockCipher = nacl.secretbox(makePub(lastKey),nonce24,makeShared(lastLock,KeyDH))
				}else{
					var newLockCipher = nacl.secretbox(makePub(lastKey),nonce24,makeShared(lastLock,wiseHash(LockStr,nonceStr)))
				}
			}else{
				var	dualKey = getDualKey(LockStr,nonceStr),
					newLockCipher = nacl.secretbox(makePub(lastKey),nonce24,dualKey)
			}

		}else{														//normal Read-once algorithm
			var pubdum = makePub(secdum);
			if(lastLockCipher){
				if(lastKeyCipher){
					var newLockCipher = nacl.secretbox(pubdum,nonce24,sharedKey)
				}else{
					if(LockStr.length == 43){
						var newLockCipher = nacl.secretbox(pubdum,nonce24,makeShared(lastLock,KeyDH))
					}else{
						var newLockCipher = nacl.secretbox(pubdum,nonce24,makeShared(lastLock,wiseHash(LockStr,nonceStr)))
					}
				}
			}else{
				var dualKey = getDualKey(LockStr,nonceStr),
					newLockCipher = nacl.secretbox(pubdum,nonce24,dualKey)
			}
		}

		if(turnstring == 'lock' || !lastKeyCipher){
			locDir[name][1] = keyEncrypt(secdum);			//new Key is stored in the permanent database, except if repeat
			if(!locDir[name][0]) return
		}
		if(turnstring != 'reset') locDir[name][3] = 'unlock';
		if(fullAccess) localStorage[userName] = JSON.stringify(locDir);

		if(ChromeSyncOn && chromeSyncMode.checked){									//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(locDir[name]))
		}

		if(shortMode.checked){
			if (text.length > 46) clipped = true;  			//46-character capacity
			text = text.slice(0,46);
			while (text.length < 46) text += ' '
		}
		var cipher = PLencrypt(text,nonce24,sharedKey,compatMode.checked);
		if(learnMode.checked){
			alert(name + " will need to select you in his/her directory to decrypt the message.")
		};
		if(resetMessage){						//1st character is r
			var outString = nacl.util.encodeBase64(concatUint8Arrays([172],concatUint8Arrays(nonce,concatUint8Arrays(newLockCipher,cipher)))).replace(/=+$/,'')
		}else if(pfsMessage){					//1st character is p
			var outString = nacl.util.encodeBase64(concatUint8Arrays([164],concatUint8Arrays(nonce,concatUint8Arrays(newLockCipher,cipher)))).replace(/=+$/,'')
		}else{									//1st character is o
			var outString = nacl.util.encodeBase64(concatUint8Arrays([160],concatUint8Arrays(nonce,concatUint8Arrays(newLockCipher,cipher)))).replace(/=+$/,'')
		}

		if(compatMode.checked){				//prepend ezLock in compatibility mode
			mainBox.textContent = '';
			if(fileMode.checked){
				if(textMode.checked){
					var fileLink = document.createElement('a');
					fileLink.download = "PL24mso.txt";
					fileLink.href = "data:," + myezLock + '//////' + outString;
					fileLink.textContent = "PassLok 2.4 Read-once message (text file)"
				}else{
					var fileLink = document.createElement('a');
					fileLink.download = "PL24mso.plk";
					fileLink.href = "data:binary/octet-stream;base64," + myezLock + '//////' + outString;
					fileLink.textContent = "PassLok 2.4 Read-once message (binary file)"
				}
			}else{
				var fileLink = document.createElement('pre');
				fileLink.textContent = ("PL24mso==" + myezLock + '//////' + outString + "==PL24mso").match(/.{1,80}/g).join("\r\n")
			}
			mainBox.appendChild(fileLink)
		}else{
			mainBox.textContent = outString
		}
	}

	if(isLong){compatMode.checked = false;longMode.checked = true}
	mainMsg.textContent = 'Encryption successful';
	if (clipped) mainMsg.textContent = "The message has been truncated";
	if (pfsMessage) mainMsg.textContent = "This message will become un-decryptable when it is replied to";
	if (resetMessage) mainMsg.textContent = "This message has no forward secrecy. The recipient will be advised to delete it";

	if(emailMode.checked) sendMail();

	decoyText.value = "";
	decoyInBox.value = "";
	decoyOutBox.value = "";
	callKey = ''
}

//concatenates two uint8 arrays, normally used right before displaying the output
function concatUint8Arrays(array1,array2){
	var result = new Uint8Array(array1.length + array2.length);
	result.set(array1,0);
	result.set(array2,array1.length);
	return result
}

//makes the permanent shared Key. Used by PFS and normal Read-once modes
function getDualKey(LockStr,nonceStr){
	if (LockStr.length == 43){
		var LockBin = nacl.util.decodeBase64(LockStr);
		if(!LockBin) return false;
		return makeShared(convertPub(LockBin),KeyDH)
	}else{
		return wiseHash(LockStr,nonceStr)					//"Lock" is actually a permanent shared Key, unstripped
	}
}

//encrypts for a list of recipients. First makes a 256-bit message key, then gets the Lock or shared Key for each recipient and encrypts the message key with it
//the output string contains each encrypted key along with 64 bits of an encrypted form of the recipient's item, so he/she can find the right encrypted key
function Encrypt_List(listArray,text){
	if(shortMode.checked){
		mainMsg.textContent = 'Short mode not available for multiple recipients';
		return
	}
	var lengthLimit = 71000;
	if(emailMode.checked && mainBox.textContent.length > lengthLimit){
		var agree = confirm("This item is too long to be transmited in an email body and likely will be clipped by the server, rendering it undecryptable. We suggest to cancel and encrypt to file instead, then attach the file to your email");
		if(!agree) return
	}
	var warningList = "",
		warningList2 = "";
	for (var index = 0; index < listArray.length; index++){		//scan lines and pop a warning if some are not names on DB or aren't Locks
		var name = listArray[index].trim();
		if (name.slice(0,4) == 'http') {
			listArray[index] = '';
			name = ''
		}
		if (name != ''){
			var index2 = searchStringInArrayDB(name,lockNames);
			if(index2 < 0){				//not on database; see if it's a Lock, and if not add to warning list
				var namestr = stripTags(name);
				if(namestr.length != 43 && namestr.length != 50){
					if (warningList == ""){warningList = name} else {warningList += '\n' + name}
				}
			}else if(stripTags(locDir[lockNames[index2]][0]).length != 43 && stripTags(locDir[lockNames[index2]][0]).length != 50 && emailMode.checked && name.toLowerCase() != 'myself'){	//email mode: shared Keys per recipient not allowed
				if (warningList2 == ""){warningList2 = name} else {warningList2 += '\n' + name};
				listArray[index] = ''
			}
		}
	}
	listArray = listArray.filter(Boolean);																						//remove empty elements
	if(emailMode.checked && !onceMode.checked && listArray.indexOf('myself') == -1) listArray.push('myself');				//add 'myself' in email mode
	listArray = shuffle(listArray);																								//extra precaution
	var recipients = listArray.length;
	
	if ((warningList != '') && (recipients > 1)){
		var agree = confirm('The names on the list below were not found in your local directory. If you click OK, they will be used as shared Keys for encrypting and decrypting the message. This could be a serious security hazard:\n\n' + warningList);
		if (!agree) return
	}
	if (warningList2 != ''){
		var agree = confirm('The names on the list below are for shared Keys, not Locks, and are not allowed for encryption in Email mode. If you click OK, they will be ignored:\n\n' + warningList2);
		if (!agree) return
	}
	if(recipients == 0){
		mainMsg.textContent = 'No valid recipients for this mode';
		return
	}else if(recipients > 255){
		mainMsg.textContent = 'Maximum number of recipients is 255';
		return
	}
	
	var	msgKey = nacl.randomBytes(32),
		nonce = nacl.randomBytes(15),
		nonce24 = makeNonce24(nonce),
		nonceStr = nacl.util.encodeBase64(nonce),
		isChatInvite = text.slice(-44,-43) == '?' && !text.slice(43).match(/[^A-Za-z0-9+\/?]/);			//detect chat invitation, for final display
	if (anonMode.checked) {
		if(learnMode.checked){
			var reply = confirm("The contents of the main box will be anonymously encrypted with the Locks of the recipients listed, so that all of them can read it with their respective Keys, and the result will replace the main box. Cancel if this is not what you want.");
			if(!reply) return
		}
		var outArray = new Uint8Array(2);	
		outArray[0] = 0;												//will become "A" in base64
		outArray[1] = recipients
		
	} else if(onceMode.checked){
		if(learnMode.checked){
			var reply = confirm("The contents of the main box will be encrypted in Read-once mode with the Locks of the recipients listed, so that all of them can read it with their respective Keys, and the result will replace the main box. It will not encrypt for yourself. Cancel if this is not what you want.");
			if(!reply) return
		}
		var outArray = new Uint8Array(2);	
		outArray[0] = 56;												//will become "O" in base64
		outArray[1] = recipients
	} else {
		if(learnMode.checked){
			var reply = confirm("The contents of the main box will be encrypted with the Locks of the recipients listed and signed with your Key, so that all of them can read it by supplying your Lock, and the result will replace the main box. Cancel if this is not what you want.");
			if(!reply) return
		}
		var outArray = new Uint8Array(2);	
		outArray[0] = 72;												//will become "S" in base64
		outArray[1] = recipients
	}

	if(anonMode.checked) {											//for anonymous mode, make dummy Lock. Make padding in all modes
		var secdum = nacl.randomBytes(32),
			pubdum = makePub(secdum)
	}else{
		if(!refreshKey()) return
	}
	
	if(anonMode.checked){
		var padding = decoyEncrypt(75,secdum);				//fits a complete ezLock; results in 100 bytes
		if(!padding) return
	}else{
		var padding = decoyEncrypt(75,KeyDH);					//won't work for a recipient defined by a shared Key, who won't have the sender's Lock loaded (matching KeyDH)
		if(!padding) return
	}

	var cipher = PLencrypt(text,nonce24,msgKey,true);				//main encryption event including compression, but don't add the result yet

	outArray = concatUint8Arrays(outArray,concatUint8Arrays(nonce,padding));

	if(anonMode.checked) outArray = concatUint8Arrays(outArray,pubdum);					//for anonymous mode, add the dummy Lock now

	//for each item on the List (unless empty), encrypt the message key and add it, prefaced by the first 256 bits of the ciphertext obtained when the item is encrypted with the message nonce and the shared key. Notice: same nonce, but different key for each item (unless someone planted two recipients who have the same key, but then the encrypted result will also be identical).
	for(var index = 0; index < recipients; index++){
		var name = listArray[index].trim();
		if(name != ''){
			var LockStr = replaceByItem(name);							//returns item if the name is on directory. Locks are stripped
			if(LockStr.length == 50) LockStr = changeBase(LockStr.toLowerCase().replace(/l/g,'L'), base36, base64, true) 		//get Lock from ezLok

	//if it's a Lock, do anonymous, Read-once or signed encryption, and add the result to the output. Same if, not being a Lock, Read-Once mode is selected. Shared Key case at the end of all this
			if(LockStr.length == 43  || onceMode.checked){
				if(LockStr.length == 43){var Lock = nacl.util.decodeBase64(LockStr);if(!Lock) return false};
				if(signedMode.checked){
					var sharedKey = makeShared(convertPub(Lock),KeyDH),
						cipher2 = nacl.secretbox(msgKey,nonce24,sharedKey),
						idTag = nacl.secretbox(Lock,nonce24,sharedKey).slice(0,8)

				}else if (anonMode.checked){
					var sharedKey = makeShared(convertPub(Lock),secdum),
						cipher2 = nacl.secretbox(msgKey,nonce24,sharedKey),
						idTag = nacl.secretbox(Lock,nonce24,sharedKey).slice(0,8)

				}else if (onceMode.checked){
					if(locDir[name] == null){
						if(locDir[lockMsg.textContent] != null && listArray.length == 1){
							name = lockMsg.textContent
						} else {
							mainMsg.textContent = "In Read-once mode, recipients' Locks must be stored";
							return
						}
					}

				  if(name != 'myself'){								//can't do Read-once to myself
				  	var lastKeyCipher = locDir[name][1],
						lastLockCipher = locDir[name][2],				//retrieve dummy Lock from storage, [0] is the permanent Lock by that name
						turnstring = locDir[name][3],
						secdum = nacl.randomBytes(32)							//different dummy key for each recipient
	
					if(turnstring == 'reset'){
						var typeByte = [172],								//becomes 'r' in base64
							resetMessage = true
					}else if(turnstring == 'unlock'){
						var typeByte = [164],								//becomes 'p' in base64
							pfsMessage = true
					}else{
						var typeByte = [160]								//becomes 'o' in base64
					}

					if(lastKeyCipher){
						var lastKey = keyDecrypt(lastKeyCipher,true);		//keep as a byte array
						if(!lastKey) return
					}else{													//use new dummy Key if stored dummy doesn't exist
						var lastKey = secdum;
						if(!resetMessage){
							typeByte = [164];
							var pfsMessage = true
						}
					}

					if(!turnstring){									//so that an initial message is seen the same as a reset mesage
						typeByte = [172];
						var resetMessage = true
					}
					
					if(lastLockCipher){										//if dummy exists, decrypt it first
						var lastLock = keyDecrypt(lastLockCipher,true);
						if(!lastLock) return
					}else{													//use permanent Lock if dummy doesn't exist
						if(Lock){
							var lastLock = convertPub(Lock)
						}else{
							var lastLock = makePub(wiseHash(LockStr,nonceStr))	//if actually a shared Key, make the Lock deriving from it
						}
					}

					if(lastLockCipher){
						if(Lock){
							var idKey = makeShared(lastLock,KeyDH);
						}else{
							var idKey = makeShared(lastLock,wiseHash(LockStr,nonceStr));
						}
					}else{
						var idKey = getDualKey(LockStr,nonceStr);
					}

					var sharedKey = makeShared(lastLock,lastKey);

					var cipher2 = nacl.secretbox(msgKey,nonce24,sharedKey);

					if(Lock){
						var idTag = nacl.secretbox(Lock,nonce24,idKey).slice(0,8)
					}else{
						var idTag = PLencrypt(LockStr,nonce24,idKey).slice(0,8)
					}

					if(turnstring != 'lock'){															//if out of turn don't change the dummy Key, this includes reset
						var newLockCipher = nacl.secretbox(makePub(lastKey),nonce24,idKey)
					}else{
						var	newLockCipher = nacl.secretbox(makePub(secdum),nonce24,idKey)
					}
					
					if(turnstring == 'lock' || !lastKeyCipher){
						locDir[name][1] = keyEncrypt(secdum);										//new Key is stored in the permanent database, unless repeat or empty
						if(!locDir[name][1]) return
					}
					if(turnstring != 'reset') locDir[name][3] = 'unlock';

					if(ChromeSyncOn && chromeSyncMode.checked){										//if Chrome sync is available, change in sync storage
						syncChromeLock(name,JSON.stringify(locDir[name]))
					}
				  }else{
					if(listArray.length < 2){
						mainMsg.textContent = 'In Read-once mode, you must select recipients other than yourself.';
						return
					}
				  }
				}

			}else{
		//if it's not a Lock (and not PFS or Read-Once), do a symmetric encryption instead, with appropriate key stretching. ID tag based on the shared Key encrypted by itself (stretched)
				var sharedKey = wiseHash(LockStr,nonceStr),
					cipher2 = nacl.secretbox(msgKey,nonce24,sharedKey),
					idTag = nacl.secretbox(nacl.util.decodeUTF8(LockStr),nonce24,sharedKey).slice(0,8)
			}

			//now add the idTag (first 8 bytes only) and encrypted arrays to the output array, and go to the next recipient
			if(onceMode.checked){				//these include encrypted ephemeral Locks, not the other types
				if(name != 'myself') outArray = concatUint8Arrays(outArray,concatUint8Arrays(idTag,concatUint8Arrays(cipher2,concatUint8Arrays(typeByte,newLockCipher))))
			}else{
				outArray = concatUint8Arrays(outArray,concatUint8Arrays(idTag,cipher2))
			}
		}
	}
	//all recipients done at this point

	//finish off by adding the encrypted message and tags and encoding to base64
	var outString = nacl.util.encodeBase64(concatUint8Arrays(outArray,cipher)).replace(/=+$/,'');

	mainBox.textContent = '';
	if(anonMode.checked){
		if(fileMode.checked){
			if(textMode.checked){
				var fileLink = document.createElement('a');
				fileLink.download = "PL24msa.txt";
				fileLink.href = "data:," + outString;
				fileLink.textContent = "PassLok 2.4 Anonymous message (text file)"
			}else{
				var fileLink = document.createElement('a');
				fileLink.download = "PL24msa.plk";
				fileLink.href = "data:binary/octet-stream;base64," + outString;
				fileLink.textContent = "PassLok 2.4 Anonymous message (binary file)"
			}
		}else if(emailMode.checked){
			var fileLink = document.createElement('pre');
			fileLink.textContent = "----------begin Anonymous message encrypted with PassLok--------==\r\n\r\n" + outString.match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end Anonymous message encrypted with PassLok-----------"
		}else{
			var fileLink = document.createElement('pre');
			fileLink.textContent = ("PL24msa==" + outString + "==PL24msa").match(/.{1,80}/g).join("\r\n")
		}
	}else if(onceMode.checked){
		if(fileMode.checked){
			if(textMode.checked){
				var fileLink = document.createElement('a');
				fileLink.download = "PL24mso.txt";
				fileLink.href = "data:," + outString;
				fileLink.textContent = "PassLok 2.4 Read-once message (text file)"
			}else{
				var fileLink = document.createElement('a');
				fileLink.download = "PL24mso.plk";
				fileLink.href = "data:binary/octet-stream;base64," + outString;
				fileLink.textContent = "PassLok 2.4 Read-once message (binary file)"
			}
		}else if(emailMode.checked){
			var fileLink = document.createElement('pre');
			fileLink.textContent = "----------begin Read-once message encrypted with PassLok--------==\r\n\r\n" + (myezLock + '//////' + outString).match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end Read-once message encrypted with PassLok-----------"
		}else{
			var fileLink = document.createElement('pre');
			fileLink.textContent = ("PL24mso==" + outString + "==PL24mso").match(/.{1,80}/g).join("\r\n")
		}
	}else{
		if(fileMode.checked){
			if(textMode.checked){
				var fileLink = document.createElement('a');
				fileLink.download = "PL24mss.txt";
				fileLink.href = "data:," + outString;
				fileLink.textContent = "PassLok 2.4 Signed message (text file)"
			}else{
				var fileLink = document.createElement('a');
				fileLink.download = "PL24mss.plk";
				fileLink.href = "data:binary/octet-stream;base64," + outString;
				fileLink.textContent = "PassLok 2.4 Signed message (binary file)"
			}
		}else if(emailMode.checked){
			var fileLink = document.createElement('pre');
			fileLink.textContent = "----------begin Signed message encrypted with PassLok--------==\r\n\r\n" + (myezLock + '//////' + outString).match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end Signed message encrypted with PassLok-----------"
		}else{
			var fileLink = document.createElement('pre');
			fileLink.textContent = ("PL24mss==" + outString + "==PL24mss").match(/.{1,80}/g).join("\r\n")
		}
	}
	if(isChatInvite){
		if(fileMode.checked){
			if(textMode.checked){
				var fileLink = document.createElement('a');
				fileLink.download = "PL24chat.txt";
				fileLink.href = "data:," + outString;
				fileLink.textContent = "PassLok 2.4 Chat invitation (text file)"
			}else{
				var fileLink = document.createElement('a');
				fileLink.download = "PL24chat.plk";
				fileLink.href = "data:binary/octet-stream;base64," + outString;
				fileLink.textContent = "PassLok 2.4 Chat invitation (binary file)"
			}
		}else if(emailMode.checked){
			var fileLink = document.createElement('pre');
			fileLink.textContent = "----------begin Chat invitation encrypted with PassLok--------==\r\n\r\n" + (myezLock + '//////' + outString).match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end Chat invitation encrypted with PassLok-----------"
		}else{
			var fileLink = document.createElement('pre');
			fileLink.textContent = ("PL24chat==" + outString + "==PL24chat").match(/.{1,80}/g).join("\r\n")
		}
	}
	mainBox.appendChild(fileLink);

	if(fullAccess) localStorage[userName] = JSON.stringify(locDir);
	mainMsg.textContent = 'Encryption successful. Copy it now.'
	if (pfsMessage) mainMsg.textContent = "Delayed forward secrecy for at least one recipient";
	if (resetMessage) mainMsg.textContent = "No forward secrecy for at least one recipient, who will be warned";

	if(emailMode.checked) sendMail();

	callKey = '';
}

//just to shuffle the array containing the recipients' Locks so no one can tell the order
function shuffle(a) {
    var j, x, i;
    for (i = a.length; i; i -= 1) {
        j = Math.floor(Math.random() * i);
        x = a[i - 1];
        a[i - 1] = a[j];
        a[j] = x;
    }
	return a
}

//encrypts a hidden message into the padding included with list encryption, or makes a random padding also encrypted so it's indistinguishable
function decoyEncrypt(length,secKey){
	if (decoyMode.checked){
		if(learnMode.checked){
			var reply = confirm("You are adding a hidden message. Cancel if this is not what you want, then uncheck Hidden message in Options.");
			if(!reply) return false
		}
		if((decoyInBox.value.trim() == "")||(decoyText.value.trim() == "")){ 		//stop to display the decoy entry form if there is no hidden message or key
			decoyIn.style.display = "block";											//display decoy form, and back shadow
			shadow.style.display = "block";
			if(!isMobile) decoyText.focus();
			return false
		}
		var keyStr = decoyInBox.value,
			text = encodeURI(decoyText.value.replace(/%20/g,' '));
			nonce = nacl.randomBytes(9),
			nonce24 = makeNonce24(nonce);

		keyStr = replaceByItem(keyStr);													//if in database, get the real item
		var keyStripped = stripTags(keyStr);

		if(keyStripped.length == 43 || keyStripped.length == 50){							//the key is a Lock, so do asymmetric encryption
			if (keyStripped.length == 50) keyStripped = changeBase(keyStripped.toLowerCase().replace(/l/g,'L'), base36, base64, true) //ezLok replaced by regular Lock
			var keyStrippedBin = nacl.util.decodeBase64(keyStripped);
			if(!keyStrippedBin) return false;
			var sharedKey = makeShared(convertPub(keyStrippedBin),secKey)
		}else{
			var sharedKey = wiseHash(keyStr,nacl.util.encodeBase64(nonce))					//symmetric encryption for true shared key
		}

		while(text.length < length) text = text + ' ';											//add spaces to make the number of characters required
		if(text.length > length) text = text.slice(0,length);									//truncate if needed
		var cipher = concatUint8Arrays(nonce,PLencrypt(text,nonce24,sharedKey))
	}else{
		var cipher = nacl.randomBytes(length + 25)												//no decoy mode so padding is random; add 25 to account for mac and nonce
	}
	decoyInBox.value = "";
	decoyText.value = "";
	return cipher;
};

//decryption process: determines which kind of encryption by looking at first character after the initial tag. Calls Encrypt_Single as appropriate
function Decrypt_Single(type,cipherStr,lockBoxHTML){
	callKey = 'decrypt';
	pwdMsg.textContent = "";
	mainMsg.textContent = "";

	if(cipherStr == ""){
			mainMsg.textContent = 'Nothing to encrypt or decrypt';
			return
	}
	
	var isCompressed = false;
	if(cipherStr.slice(50,56).match('//////') && !cipherStr.slice(0,50).match(/[^0-9a-kLm-z]/)){	//if it comes from PassLok for Email or SeeOnce
		cipherStr = extractLock(cipherStr);																		//get or enter sender	
		lockBoxHTML = lockBox.innerHTML.replace(/\n/g,'<br>').trim();
		if(!cipherStr.charAt(0).match(/[gasoprASO]/)){														//check for allowed types after prepended Lock and separator
			mainMsg.textContent = 'Unrecognized message format';
			return
		}
		isCompressed = true													//will be used to get the right encoding
	}
	
	if(lockBoxHTML.slice(0,1) == 'k') decryptItem();			//if Lock or shared Key is encrypted, decrypt it
	var name = lockMsg.textContent,
		lockBoxLines = lockBoxHTML.replace(/<div>/g,"<br>").replace(/<\/div>/g,"").split('<br>'),
		lockBoxItem = lockBoxLines[0],
		strippedLockBox = stripTags(lockBoxItem);		//this holds a Lock or shared Key (or a name leading to it). if there is a video URL, it gets stripped, as well as any non-base64 chars

	if(type == 'd' && lockBoxHTML.length > 43){padDecrypt(cipherStr);openChat();return}		//special encrypting mode for long keys
	
	if(type == 'h')	{																		//special human encrypted mode
		lockBox.textContent = replaceByItem(lockBoxItem);
		if(lockBox.textContent.split('~').length != 3){
			mainMsg.textContent = 'Please supply a Key like this: three strings separated by tildes';
			return
		}
		humanEncrypt(cipherStr,false);													//when set to false the process decrypts
		return
	}

	//here detect if the message is for multiple recipients, and if so call the appropriate function
	if(type.match(/[ASO]/)){
		Decrypt_List(type,cipherStr);
		openChat();
		return
	}

	if(type.match(/[gsopr]/)){															//only one sender allowed in some modes
		if(lockBoxLines.length > 1){
			if(lockBoxLines[1].slice(0,4) != 'http'){
				mainMsg.textContent = "Please select a single sender";
				return
			}
		}
	}

	if(cipherStr.length != 160 && isBase64) isCompressed = true;				//detect URSA and compatible mode messages, which are compressed

	if(type == "k"){																//secret Key-encrypted item, such as a complete locDir database
		if(learnMode.checked){
			var reply = confirm("The message in the main box was encrypted with your secret Key, and will now be decrypted if your secret Key has been entered. If it is a database it will be placed in the Locks screen so you can merge it into the stored database. If it contains settings, they will replace your current setings, including the email/token.  Cancel if this is not what you want.");
			if(!reply) return
		}
		if(!refreshKey()) return;					
		lockBox.innerHTML = decryptSanitizer(keyDecrypt(cipherStr));			//decryption step
		if(!lockBox.innerHTML) return;

		if(lockBox.textContent.trim().slice(0,6) == 'myself'){		//string contains settings; add them after confirmation
			var reply = confirm("If you click OK, the settings from the backup will replace the current settings, possibly including a random token. This cannot be undone.");
			if(!reply) return

			mergeLockDB();
			mainMsg.textContent = 'The settings have been replaced with those in this backup';
			lockBox.textContent = ''
		}else{																		//stored local directory; display so it can be edited
			setTimeout(function(){lockMsg.textContent = 'Extracted items. Click Merge to add them to the local directory.'},10);
			if(!advancedMode.checked) mode2adv();
			main2lock()
		}

	}else if(type == "g"){							//symmetric decryption
		if(learnMode.checked){
			var reply2 = confirm("The message in the main box was encrypted with a shared Key, and will now be decrypted if the same Key is present in the Locks box. The result will replace the encrypted message. Cancel if this is not what you want.");
			if(!reply2) return
		}
		var fullArray = nacl.util.decodeBase64(cipherStr);
		if(!fullArray) return false;
		var	nonce = fullArray.slice(1,10),								//9 bytes
			nonce24 = makeNonce24(nonce),
			nonceStr = nacl.util.encodeBase64(nonce),
			cipher = fullArray.slice(10);		
		if(lockBoxItem == ''){
			mainMsg.textContent = 'Enter shared Key or select the sender';
			return
		}
		lockBoxItem = replaceByItem(lockBoxItem);						//if it's a name in the box, get the real item
		var	keyStr = lockBoxItem;
		if(keyStr.length == 43){
			var sharedKey = nacl.util.decodeBase64(keyStr);				//sender's Lock, likely from an invitation email
			if(!sharedKey) return false
		}else if(keyStr.length == 50){
			var sharedKey = nacl.util.decodeBase64(changeBase(keyStr.toLowerCase().replace(/l/g,'L'),base36,base64));		//sender's ezLok, likely from an invitation email
			if(!sharedKey) return false
		}else{
			var sharedKey = wiseHash(keyStr,nonceStr)					//real shared Key
		}

		var plain = PLdecrypt(cipher,nonce24,sharedKey,isCompressed,'symmetric');			//main decryption instruction	

		if(isCompressed){
			mainBox.innerHTML = decryptSanitizer(plain.trim())					//make sure non-allowed tags and attributes are disabled
		}else{
			mainBox.innerHTML = decryptSanitizer(decodeURI(plain).trim())
		}
		mainMsg.textContent = 'Decryption successful';
																		//additional text to accompany an invitation
		if(keyStr.length == 43 || keyStr.length == 50){
			var prefaceMsg = document.createElement('div'),
				epilogueMsg = document.createElement('div');
			prefaceMsg.textContent = "This is my message to you:\r\n----------\r\n";
			epilogueMsg.textContent = "----------\r\nPassLok is now ready to encrypt your reply so that only I can decrypt it.\r\n\r\nTo do this, click *Clear*, type your message, select my name in the directory, and then click *Encrypt*. Optionally, you can select a different encryption mode at the bottom of the screen before you click the button. Then you can copy and paste it into your favorite communications program or click *Email* to send it with your default email.\r\n\r\nIf this is a computer, you can use rich formatting if you click the *Rich* button.";
			mainBox.insertBefore(prefaceMsg,mainBox.firstChild);
			mainBox.appendChild(epilogueMsg)
		}

	}else if(type == "s"){							//signed decryption
		if(learnMode.checked){
			var reply = confirm("The message in the main box was encrypted with your Lock and the sender's Key, and will now be decrypted, replacing the encrypted message, if your secret Key has been entered. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(strippedLockBox == ''){
			mainMsg.textContent = "Identify the sender or enter his/her Lock";
			return
		}
		if(!refreshKey()) return;
		if(locDir[name] == null){
			name = lockBoxItem							//try again using the string in the lockBox as name, not stripped
		}
		strippedLockBox = replaceByItem(lockBoxItem);
		if (strippedLockBox.length == 50) strippedLockBox = changeBase(strippedLockBox.toLowerCase().replace(/l/g,'L'), base36, base64, true); 	//replace ezLok with standard
		var strippedLockBoxBin = nacl.util.decodeBase64(strippedLockBox);
		if(!strippedLockBoxBin) return false;
		var sharedKey = makeShared(convertPub(strippedLockBoxBin),KeyDH),
			fullArray = nacl.util.decodeBase64(cipherStr);
		if(!fullArray) return false;	
		var	nonce = fullArray.slice(1,10),
			nonce24 = makeNonce24(nonce),
			cipher = fullArray.slice(10);

		var plain = PLdecrypt(cipher,nonce24,sharedKey,isCompressed,'signed');			//decryption step

		if(isCompressed){
			mainBox.innerHTML = decryptSanitizer(plain.trim())
		}else{
			mainBox.innerHTML = decryptSanitizer(decodeURI(plain).trim())
		}
		mainMsg.textContent = 'Decryption successful'

	}else if(type == "a"){					//short anonymous decryption
		if(learnMode.checked){
			var reply = confirm("The short message in the main box was encrypted with your personal Lock, and will now be decrypted if your secret Key has been entered, replacing the encrypted message. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(!refreshKey()) return;
		var fullArray = nacl.util.decodeBase64(cipherStr);
		if(!fullArray) return false;
		var	nonce = fullArray.slice(1,10),
			pubdum = fullArray.slice(10,42),
			nonce24 = makeNonce24(nonce),
			sharedKey = makeShared(pubdum,KeyDH),
			cipher = fullArray.slice(42);

		var plain = PLdecrypt(cipher,nonce24,sharedKey,isCompressed,'anon');			//decryption step

		if(isCompressed){
			mainBox.innerHTML = decryptSanitizer(plain.trim())
		}else{
			mainBox.innerHTML = decryptSanitizer(decodeURI(plain).trim())
		}
		mainMsg.textContent = 'Decryption successful'

	}else if(type == "o" || type == "p" || type == "r"){			//Read-once and PFS decryption, may be SeeOnce
		if(learnMode.checked){
			var reply2 = confirm("The message in the main box was encrypted in Read-once mode, and will now be decrypted if the sender has been selected. The result will replace the encrypted message. Cancel if this is not what you want.");
			if(!reply2) return
		}
		if(!refreshKey()) return;
		if(lockBoxItem == ''){
			mainMsg.textContent = 'Select the sender';
			return
		}
		if(name == 'myself'){
			mainMsg.textContent = 'You cannot make a Read-once message to yourself';
			return	
		}
		if(!locDir[name]) name = lockBoxItem;						//if the name is not displayed, try with the content of the Lock box
		if(!locDir[name]){											//if it still doesn't work, message and bail out
			mainMsg.textContent = 'The sender must be in the directory';
			return
		}

		if(type == 'r'){											//if a reset message, delete ephemeral data first, after recipient agrees
			var agree = confirm('If you go ahead, the current Read-once conversation with the sender will be reset. This may be OK if this is a new message, but if it is an old one the conversation will go out of sync');
			if(!agree) return
			locDir[name][1] = locDir[name][2] = null;
			var isReset = true
		}

		var LockStr = replaceByItem(lockBoxItem);					//if it's a name in the box, get the real item
		if(LockStr.length == 50) LockStr = changeBase(LockStr.toLowerCase().replace(/l/g,'L'), base36, base64, true); 		//replace ezLok with standard
		var	keyStr = lockBoxItem,
			fullArray = nacl.util.decodeBase64(cipherStr);
		if(!fullArray) return false;	
		var	nonce = fullArray.slice(1,10),
			nonce24 = makeNonce24(nonce),
			nonceStr = nacl.util.encodeBase64(nonce),
			newLockCipher = fullArray.slice(10,58),
			cipher = fullArray.slice(58);

		var lastKeyCipher = locDir[name][1],												//retrieve dummy Key from storage
			turnstring = locDir[name][3];													//this strings says whose turn it is to encrypt
		if(turnstring=='lock' && type=='o'){
			window.setTimeout(function(){mainMsg.textContent = 'Read-once messages can be decrypted only once'},2000)
		}

		if(lastKeyCipher) {
			var lastKey = keyDecrypt(lastKeyCipher,true);
			if(!lastKey) return
		}else{																	//if a dummy Key doesn't exist, use permanent Key
			if(LockStr.length == 43){
				var lastKey = KeyDH
			}else{
				var lastKey = wiseHash(LockStr,nonceStr)							//shared Key: use directly
			}
		}

		if(type == 'p' || type == 'r'){												//retrieve ephemeral Lock in PFS and reset modes
			if(lastKeyCipher){
				if(LockStr.length == 43){
					var LockBin = nacl.util.decodeBase64(LockStr);
					if(!LockBin) return false;
					var newLock = nacl.secretbox.open(newLockCipher,nonce24,makeShared(convertPub(LockBin),lastKey));
					if(!newLock){failedDecrypt('read-once');return}
				}else{
					var newLock = nacl.secretbox.open(newLockCipher,nonce24,makeShared(makePub(wiseHash(LockStr,nacl.util.encodeBase64(nonce))),lastKey));
					if(!newLock){failedDecrypt('read-once');return}
				}
			}else{
				var dualKey = getDualKey(LockStr,nonceStr),
					newLock = nacl.secretbox.open(newLockCipher,nonce24,dualKey);
				if(!newLock){failedDecrypt('read-once');return}
			}
			var	sharedKey = makeShared(newLock,lastKey)

		}else{																			//retrieve ephemeral Lock in proper Read-once mode
			var lastLockCipher = locDir[name][2];										//read-once mode uses last Key and last Lock
			if(lastKeyCipher){
				if(lastLockCipher){
					var newLock = nacl.secretbox.open(newLockCipher,nonce24,makeShared(keyDecrypt(lastLockCipher,true),lastKey));
					if(!newLock){failedDecrypt('read-once');return}
				}else{
					if(LockStr.length == 43){
						var LockBin = nacl.util.decodeBase64(LockStr);
						if(!LockBin) return false;
						var newLock = nacl.secretbox.open(newLockCipher,nonce24,makeShared(convertPub(LockBin),lastKey));
						if(!newLock){failedDecrypt('read-once');return}
					}else{
						var newLock = nacl.secretbox.open(newLockCipher,nonce24,makeShared(makePub(wiseHash(LockStr,nonceStr)),lastKey));
						if(!newLock){failedDecrypt('read-once');return}
					}
				}
			}else{
				var dualKey = getDualKey(LockStr,nonceStr),
					newLock = nacl.secretbox.open(newLockCipher,nonce24,dualKey);
					if(!newLock){failedDecrypt('read-once');return}
			}
			if(lastLockCipher) {												//if stored dummy Lock exists, decrypt it first
				var lastLock = keyDecrypt(lastLockCipher,true);
				if(!lastLock) return
			}else{																	//use new dummy if stored dummy doesn't exist
				var lastLock = newLock
			}
			var	sharedKey = makeShared(lastLock,lastKey)
		}

		var plain = PLdecrypt(cipher,nonce24,sharedKey,isCompressed,'read-once');		//main decryption step

		if(isCompressed){
			mainBox.innerHTML = decryptSanitizer(plain.trim())
		}else{
			mainBox.innerHTML = decryptSanitizer(decodeURI(plain).trim())
		}

		locDir[name][2] = keyEncrypt(newLock);										//store the new ephemeral Lock
		if(!locDir[name][2]) return;
		locDir[name][3] = 'lock';
		if(fullAccess) localStorage[userName] = JSON.stringify(locDir);

		if(ChromeSyncOn && chromeSyncMode.checked){									//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(locDir[name]))
		}
		setTimeout(function(){														//give it some time before displaying this
			if(isReset){
				mainMsg.textContent = 'You have just decrypted the first message or one that resets a Read-once conversation. This message can be decrypted again, but doing so after more messages are exchanged will cause the conversation to go out of sync. It is best to delete it to prevent this possibility'			
			}else if(type == 'o'){
				mainMsg.textContent = 'Decryption successful. This message cannot be decrypted again'
			}else if(type == 'p'){
				mainMsg.textContent = 'Decryption successful. This message will become un-decryptable after you reply'
			}else{
				mainMsg.textContent = 'Decryption successful'
			}
		},10);
	}else{
		Encrypt_Single(lockBoxHTML,cipherStr)										//none of the known encrypted types, therefore encrypt rather than decrypt
	}
	openChat();
	callKey = ''
}

//decrypts a message encrypted for multiple recipients. Encryption can be Signed, Anonymous, or Read-once. For Signed and Anonymous modes, it is possible that a shared Key has been used rather than a Lock.
function Decrypt_List(type,cipherStr){
	pwdMsg.textContent = "";
	var name = lockMsg.innerHTML,														//keep the formatting if there are several lines
		cipherInput = nacl.util.decodeBase64(cipherStr);
		if(!cipherInput) return false;
	var	recipients = cipherInput[1],										//number of recipients. '0' reserved for special cases
		nonce = cipherInput.slice(2,17),									//15 bytes
		nonce24 = makeNonce24(nonce),
		nonceStr = nacl.util.encodeBase64(nonce),
		padding = cipherInput.slice(17, 117);							//100 bytes

	if(type == 'A'){
		var pubdum = cipherInput.slice(117,149);							//retrieve ephemeral lock
		cipherInput = cipherInput.slice(149)
	}else{
		cipherInput = cipherInput.slice(117)
	}

	//now cut the rest of the input into pieces. First ID tags and their respective encrypted keys etc., then the ciphertext
	var cipherArray = new Array(recipients);
	if(type != 'O'){													//shorter pieces in Anonymous and Signed modes
		for(var i = 0; i < recipients; i++){
			cipherArray[i] = cipherInput.slice(56*i,56*(i+1))		//8 bytes for ID, 48 for encrypted key
		}
		var cipher = cipherInput.slice(56*recipients)
	}else{																//longer pieces in Read-once mode
		for(var i = 0; i < recipients; i++){
			cipherArray[i] = cipherInput.slice(105*i,105*(i+1))		//8 bytes for ID, 48 for encrypted ephemeral Lock, 48 for encrypted key, 1 for type
		}
		var cipher = cipherInput.slice(105*recipients)
	}

	var lockBoxItem = lockBox.innerHTML.replace(/\n/g,'<br>').replace(/<br>$/,"").trim().replace(/<div>/g,'<br>').replace(/<\/div>/g,'').split('<br>')[0],
		LockStr = replaceByItem(lockBoxItem);					//if it's a name, replace it with the decrypted item. Locks are stripped of their tags in any case.
	if(!locDir[name] && locDir[lockBoxItem]) name = lockBoxItem;	//name placed in the box

	if(LockStr.length == 50) LockStr = changeBase(LockStr.toLowerCase().replace(/l/g,'L'), base36, base64, true) 				//ezLok case
	if(LockStr.length == 43){var Lock = nacl.util.decodeBase64(LockStr); if(!Lock) return false};
	if(locDir['myself'] == null && fullAccess) key2any();									//make this entry if it has been deleted

	if(decoyMode.checked){													//decoy decryption of the padding
		if(type == 'A'){
			var answer = decoyDecrypt(padding,pubdum);
			if(!answer) return
		}else{
			if(Lock){
				var answer = decoyDecrypt(padding,convertPub(Lock));		//works since KeyDH was used for encryption
				if(!answer) return
			}else{
				var answer = decoyDecrypt(padding);							//main shared Key case. Will trigger an error message if the decoy key was asymmetric
				if(!answer) return
			}
		}
	}

	//now make the idTag to be searched for, depending on the type of encryption
	if(LockStr.length == 43 || (LockStr == '' && type == 'A')){
		var stuffForId = myLock
	}else{
		var stuffForId = nacl.util.decodeUTF8(LockStr)
	}
	if(type == 'O' && name == 'myself'){
		mainMsg.textContent = 'You cannot make a Read-once message to yourself';
		return
	}
	if(type == 'S'){											//signed mode first
		if(learnMode.checked){
			var reply = confirm("The contents of the message in the main box will be decrypted with your secret Key, provided the sender's Lock or shared Key are selected on the directory, or entered directly after pressing Edit. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(LockStr == ''){
			mainMsg.textContent = "Enter the sender's Lock or shared Key";
			return
		}
		var lockBoxLines = lockBox.innerHTML.replace(/\n/g,'<br>').trim().split('<br>').filter(Boolean);
		if(lockBoxLines.length > 1){
			if(lockBoxLines[1].slice(0,4) != 'http'){
				mainMsg.textContent = "Please select a single sender";
				return
			}
		}
		if(!refreshKey()) return;
		if(Lock){														//assuming this is a Lock, not a shared Key. See below for the other case
			if(!locDir[name] && locDir[lockBoxItem]) name = lockBoxItem;
			var sharedKey = makeShared(convertPub(Lock),KeyDH),
				idKey = sharedKey;
		}else{														//this when it's a regular shared Key in common with the sender
			var	sharedKey = wiseHash(LockStr,nonceStr),						//nonce is used as salt for regular shared Keys
				idKey = sharedKey;
		}

	}else if(type == 'A'){										//anonymous mode
		if(learnMode.checked){
			var reply = confirm("The contents of the message in the main box will be decrypted with your secret Key. Cancel if this is not what you want.");
			if(!reply) return
		}
		var LockSplit = LockStr.split('\n');
		if(LockSplit.length > 1) var isVideo = (LockSplit[1].slice(0,4) == 'http');
		if(LockStr.length == 43 || LockStr == '' || isVideo){		//test for Lock, empty, video URL, in order to do anonymous Diffie-Hellman using the dummy Lock
			if(!refreshKey()) return;
			var	sharedKey = makeShared(pubdum,KeyDH),
				idKey = sharedKey;
		}else{																//looks like a shared Key in the Lock box: use it as is
			var	sharedKey = wiseHash(LockStr,nonceStr),
				idKey = sharedKey;
		}

	}else if(type == 'O'){														//Read-once mode
		if(learnMode.checked){
			var reply = confirm("The contents of the message in the main box will be decrypted with your secret Key, provided the sender's Lock or shared Key are selected on the directory, or entered directly after pressing Enter. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(LockStr == ''){
			mainMsg.textContent = "Enter the sender's Lock or shared Key";
			return
		}
		if(!refreshKey()) return;
		if(locDir[name]){
			var	lastKeyCipher = locDir[name][1],
				lastLockCipher = locDir[name][2],
				turnstring = locDir[name][3];										//this strings says whose turn it is to encrypt
			if(turnstring == 'lock'){											//set message in case decryption fails
				window.setTimeout(function(){mainMsg.textContent = 'Read-once messages can be decrypted only once'},2000)
			}
		}

		if(lastKeyCipher){													//now make idTag
			var lastKey = keyDecrypt(lastKeyCipher,true);
			if(!lastKey) return;
			if(Lock){
				var idKey = makeShared(convertPub(Lock),lastKey)
			}else{
				var idKey = makeShared(makePub(wiseHash(LockStr,nonceStr)),lastKey)
			}
		}else{														//if a dummy Key doesn't exist, use permanent Key
			if(Lock){
				var lastKey = KeyDH
			}else{
				var lastKey = wiseHash(LockStr,nonceStr)									//shared Key: use directly
			}
			var idKey = getDualKey(LockStr,nonceStr)
		}
	}else{															//no known type, so encrypt rather than decrypt
		Encrypt_List(lockBox.innerHTML.replace(/\n/g,'<br>').replace(/<br>$/,"").trim().replace(/<div>/g,'<br>').replace(/<\/div>/g,'').split('<br>'),cipherStr);
		return
	}

	if(Lock || (LockStr == '' && type == 'A')){
		var idTag = nacl.secretbox(stuffForId,nonce24,idKey).slice(0,8)
	}else{
		var idTag = PLencrypt(LockStr,nonce24,idKey).slice(0,8)
	}

	//look for the id tag and return the bytes that follows it
	for(i = 0; i < recipients; i++){
		var success = true;
		for(var j = 0; j < 8; j++){									//just the first 8 bytes
			success = success && (idTag[j] == cipherArray[i][j])		//find the idTag bytes at the start of cipherArray[i]
		}
		if(success){
			var msgKeycipher = cipherArray[i].slice(8)
		}
	}

	if(typeof msgKeycipher == 'undefined'){							//may have been reset, so try again
		if(LockStr){
			if(Lock){
				lastKey = KeyDH
			}else{
				lastKey = wiseHash(LockStr,nonceStr)
			}
			idKey = getDualKey(LockStr,nonceStr);
			idTag = nacl.secretbox(stuffForId,nonce24,idKey).slice(0,8);
			for(i = 0; i < recipients; i++){
				var success = true;
				for(var j = 0; j < 8; j++){
					success = success && (idTag[j] == cipherArray[i][j])	
				}
				if(success){
					var msgKeycipher = cipherArray[i].slice(8)
				}
			}
		}
		if(typeof msgKeycipher == 'undefined'){						//now really give up
			if(!decoyMode.checked) mainMsg.textContent = 'No message found for you';
			return
		}
	}

	//got the encrypted message key so now decrypt it, and finally the main message. The process for PFS and Read-once modes is more involved.
	if(type != 'O'){					//anonymous and signed modes
		var msgKey = nacl.secretbox.open(msgKeycipher,nonce24,sharedKey);
		if(!msgKey){failedDecrypt('signed');return};

//for Read-once mode, first we separate the encrypted new Lock from the proper message key, then decrypt the new Lock and combine it with the stored Key (if any) to get the ephemeral shared Key, which unlocks the message Key. The particular type of encryption (Read-once or PFS) is indicated by the last byte
	}else{
		var	typeByte = msgKeycipher.slice(48,49),
			newLockCipher = msgKeycipher.slice(49),
			newLock = nacl.secretbox.open(newLockCipher,nonce24,idKey);
		msgKeycipher = msgKeycipher.slice(0,48);
		if(!newLock){failedDecrypt('read-once');return};

		if(typeByte[0] == 164){														//PFS mode: last Key and new Lock
			var	sharedKey = makeShared(newLock,lastKey);

		}else if(typeByte[0] == 172){													//reset. lastKey is the permanent, or symmetric key
			var agree = confirm('If you go ahead, the current Read-once conversation with the sender will be reset. This may be OK if this is a new message, but if it is an old one the conversation will go out of sync');
			if(!agree) return
			var	sharedKey = makeShared(newLock,lastKey);
			locDir[name][1] = locDir[name][2] = null									//if reset type, delete ephemeral data first

		}else{																			//Read-once mode: last Key and last Lock
			var lastLockCipher = locDir[name][2];
			if(lastLockCipher != null){												//if stored dummy Lock exists, decrypt it
				var lastLock = keyDecrypt(lastLockCipher,true);
				if(!lastLock) return
			}else{																	//use new dummy if no stored dummy
				var lastLock = newLock
			}
			var	sharedKey = makeShared(lastLock,lastKey)
		}

		var msgKey = nacl.secretbox.open(msgKeycipher,nonce24,sharedKey);
		if(!msgKey){failedDecrypt('read-once');return};
		locDir[name][2] = keyEncrypt(newLock);										//store the new dummy Lock (final storage at end)
		if(!locDir[name][2]) return;
		locDir[name][3] = 'lock';

		if(ChromeSyncOn && chromeSyncMode.checked){									//change in sync storage
			syncChromeLock(name,JSON.stringify(locDir[name]))
		}
	}

	//final decryption for the main message, plus decompression
	var plainstr = PLdecrypt(cipher,nonce24,msgKey,true);
	mainBox.innerHTML = decryptSanitizer(plainstr);											//non-whitelisted tags and attributes disabled

	if(fullAccess) localStorage[userName] = JSON.stringify(locDir);				//everything OK, so store
	if (!decoyMode.checked){
		if(typeByte){
			if(typeByte[0] == 172){
				mainMsg.textContent = 'You have just decrypted the first message or one that resets a Read-once conversation. This message can be decrypted again, but doing so after more messages are exchanged will cause the conversation to go out of sync. It is best to delete it to prevent this possibility'
			}else if(typeByte[0] == 160){
				mainMsg.textContent = 'Decryption successful. This message cannot be decrypted again'
			}else if(typeByte[0] == 164){
				mainMsg.textContent = 'Decryption successful. This message will become un-decryptable after you reply'
			}
		}else{
			mainMsg.textContent = 'Decryption successful'
		}
	}
	callKey = ''
}

//decrypt the message hidden in the padding, for decoy mode
function decoyDecrypt(cipher,dummyLock){
	if(learnMode.checked){
		var reply = confirm("Hidden message mode is selected. If you go ahead, a dialog will ask you for the special Key or Lock for this. Cancel if this is not what you want.");
		if(!reply) return false
	}
	if (decoyOutBox.value.trim() == ""){					//stop to display the decoy key entry form if there is no key entered
		decoyOut.style.display = "block";
		shadow.style.display = "block";
		if(!isMobile) decoyOutBox.focus();
		return false
	}
	var keyStr = decoyOutBox.value;
	keyStr = replaceByItem(keyStr);													//use stored item, if it exists
	decoyOutBox.value = "";

	var nonce = cipher.slice(0,9),
		cipherMsg = cipher.slice(9),
		nonce24 = makeNonce24(nonce),
		sharedKey = wiseHash(keyStr,nacl.util.encodeBase64(nonce)),				//try symmetric first
		plain = nacl.secretbox.open(cipherMsg,nonce24,sharedKey);
	if(!plain){																			//try asymmetric
		var email = readEmail();
		if(dummyLock){
			sharedKey = makeShared(dummyLock,ed2curve.convertSecretKey(nacl.sign.keyPair.fromSeed(wiseHash(keyStr,email)).secretKey))
		}else{failedDecrypt('decoy');return}
		plain = nacl.secretbox.open(cipherMsg,nonce24,sharedKey);
		if(!plain){failedDecrypt('decoy')	;return}										//now give up
	}
	mainMsg.textContent = 'Hidden message: ' + decodeURI(nacl.util.encodeUTF8(plain));
	return true
}
</script>

<!--crypto extra functions: signatures, pad and human modes-->
<script>
//function that starts it all when the Seal/Unseal button is pushed
function signVerify(){
	blinkMsg(mainMsg);
	var array = getType(mainBox.innerHTML.trim()),
		lockBoxHTML = lockBox.innerHTML.replace(/\n/g,'<br>').replace(/<br>$/,"").trim();
	setTimeout(function(){																			//the rest after a 20 ms delay
		if(array[0] == 'l'){
			verifySignature(array[1],lockBoxHTML)
		}else{
			applySignature(array[1])
		}
		charsLeft()
	},20);						//end of timeout
}

//adds Schnorr signature to the contents of the main box
function applySignature(textStr){
	callKey = 'sign';
	pwdMsg.textContent = "";
	if(learnMode.checked){
		var reply = confirm("The contents of the main box will be sealed using your secret Key, so that others can verify its origin. The resulting item WILL NOT BE LOCKED. Cancel if this is not what you want.");
		if(!reply) return
	}
	if(!refreshKey()) return;
	
	// for decoy message
	var	padding = decoyEncrypt(75,KeyDH);

	if(textStr.match('="data:')){
		var encodedText = nacl.util.decodeUTF8(textStr)
	}else{
		var encodedText = LZString.compressToUint8Array(textStr)
	}

	//main signing instruction, prefix is l
	var sealedText = nacl.util.encodeBase64(concatUint8Arrays([150],concatUint8Arrays(padding,nacl.sign(encodedText,KeySgn)))).replace(/=+$/,'');

	mainBox.textContent = '';
	if(fileMode.checked){
		if(textMode.checked){
			var fileLink = document.createElement('a');
			fileLink.download = "PL24sld.txt";
			fileLink.href = "data:," + sealedText;
			fileLink.textContent = "PassLok 2.4 Sealed message (text file)"
		}else{
			var fileLink = document.createElement('a');
			fileLink.download = "PL24sld.plk";
			fileLink.href = "data:binary/octet-stream;base64," + sealedText;
			fileLink.textContent = "PassLok 2.4 Sealed message (binary file)"
		}		
	}else{
		var fileLink = document.createElement('pre');
		fileLink.textContent = ("PL24sld==" + sealedText + "==PL24sld").match(/.{1,80}/g).join("\r\n")
	}
	mainBox.appendChild(fileLink);
	mainMsg.textContent = 'The text has been sealed with your secret Key. It is ';
	var blinker = document.createElement('span');
	blinker.className = "blink";
	blinker.textContent = "NOT LOCKED";
	mainMsg.appendChild(blinker);
	callKey = ''
};

//verifies the Schnorr signature of the plaintext, calls applySignature as appropriate.
function verifySignature(textStr,LockStr){
	pwdMsg.textContent = "";
	if (textStr == ""){																	//nothing in text box
		mainMsg.textContent = 'Nothing to sign or verify';
		return
	}
	if(lockBox.textContent.trim().charAt(0) == 'k') decryptItem();

	if(learnMode.checked){
		var reply = confirm("The item in the main box has been sealed with somebody's secret Key. I will now check the matching Lock, which should be selected on the local directory, and will display the unsealed message inside. Cancel if this is not what you want.");
		if(!reply) return
	}
	callKey = 'sign';												//needed in case there is a decoy decryption

	if (LockStr == ""){
		setTimeout(function(){mainMsg.textContent = 'Please select the sealer first, then click Unseal'},50);		//the wait time may need to be longer
		return
	}
	var	Lockstripped = stripTags(LockStr),
		index = searchStringInArrayDB(LockStr,lockNames);
	if (Lockstripped.length != 43 && Lockstripped.length != 50){									//not a Lock, but maybe it's a name
		if(index >= 0){
			var name = lockNames[index];
			LockStr = replaceByItem(LockStr)
		}else{
			mainMsg.textContent = "Sealer not recognized";
			return
		}
	}else{
		var name = lockNames[index];
		LockStr = Lockstripped
	}
	if (LockStr.length == 50) LockStr = changeBase(LockStr.toLowerCase().replace(/l/g,'L'), base36, base64, true); 		//ezLok replaced by regular Lock
	if (LockStr.length != 43){
		mainMsg.textContent = 'Enter a valid Lock';
		return
	}

	var Lock = nacl.util.decodeBase64(LockStr);
	if(!Lock) return false;
	var	sealedArray = nacl.util.decodeBase64(textStr);
	if(!sealedArray) return false;
	var	padding = sealedArray.slice(1,101);
		
	if(decoyMode.checked) decoyDecrypt(padding,convertPub(Lock));			//extract decoy message, uses DH version of the signing Lock

	var	sealedItem = sealedArray.slice(101),
		result = nacl.sign.open(sealedItem,Lock);								//unsealing of sealed message

	if(result){
		if(result.join().match(",61,34,100,97,116,97,58,")){
			mainBox.innerHTML = decryptSanitizer(nacl.util.encodeUTF8(result))
		}else{
			mainBox.innerHTML = decryptSanitizer(LZString.decompressFromUint8Array(result))									//decompress and filter
		}
		setTimeout(function(){if(!decoyMode.checked) mainMsg.textContent = 'Seal ownership is VERIFIED for: ' + name},500)				//apply a delay so this appears last
	}else{
		setTimeout(function(){if(!decoyMode.checked) mainMsg.textContent = 'The seal has FAILED to verify for: ' + name},500)
	}
	callKey = ''
}

//Now the Pad encryption mode

var entropyPerChar = 1.58;			//expected entropy of the key text in bits per character, from Shannon, as corrected by Guerrero; for true random UTF8 text this value is 8
//function for encrypting with long key
function padEncrypt(text){
	var keyText = lockBox.textContent.replace(/\n/g,' ').trim(),		//turn linefeeds into spaces for compatibility with PassLok for Email
		keyTextBin = nacl.util.decodeUTF8(keyText),
		clipped = false;

	if(shortMode.checked){
		text = encodeURI(text).replace(/%20/g,' ');
		if (text.length > 94) clipped = true;  						//94-char capacity in short mode
		text = text.slice(0,94);
		while (text.length < 94) text += ' ';							//ensure standard ciphertext length after encoding
		var nonce = nacl.randomBytes(9),		
			textBin = nacl.util.decodeUTF8(text)
	}else{
		var nonce = nacl.randomBytes(15);	
		if(text.match('="data:')){
			var textBin = nacl.util.decodeUTF8(text)
		}else{
			var textBin = LZString.compressToUint8Array(text)
		}
	}
	var	keyLengthNeed = Math.ceil((textBin.length + 64) * 8 / entropyPerChar)
	
	if(keyLengthNeed > keyTextBin.length){
		mainMsg.textContent = "The key Text is too short";
		return
	}
	while(isNaN(startIndex) || startIndex < 0 || startIndex > keyTextBin.length){
		var reply = prompt("Pad mode in use.\nPlease enter the position in the key text where we should start (0 to " + keyTextBin.length + ")",0);
		if(reply == null){return}else{var startIndex = parseInt(reply)}
	}

	var cipherBin = padResult(textBin, keyTextBin, nonce, startIndex),				//main encryption event
		macBin = padMac(textBin, keyTextBin, nonce, startIndex),						//make mac
		outStr = nacl.util.encodeBase64(concatUint8Arrays([116],concatUint8Arrays(nonce,concatUint8Arrays(macBin,cipherBin)))).replace(/=+$/,'');

	if(shortMode.checked){
		mainBox.textContent = outStr
	}else{
		mainBox.textContent = '';
		if(fileMode.checked){
			if(textMode.checked){
				var fileLink = document.createElement('a');
				fileLink.download = "PL24msp.txt";
				fileLink.href = "data:," + outStr;
				fileLink.textContent = "PassLok 2.4 Pad encrypted message (text file)"
			}else{
				var fileLink = document.createElement('a');
				fileLink.download = "PL24msp.plk";
				fileLink.href = "data:binary/octet-stream;base64," + outStr;
				fileLink.textContent = "PassLok 2.4 Pad encrypted message (binary file)"
			}
		}else if(emailMode.checked){
			var fileLink = document.createElement('pre');
			fileLink.textContent = "----------begin Pad mode message encrypted with PassLok--------==\r\n\r\n" + outString.match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end Pad mode message encrypted with PassLok-----------"
		}else{
			var fileLink = document.createElement('pre');
			fileLink.textContent = ("PL24msp==" + outStr + "==PL24msp").match(/.{1,80}/g).join("\r\n")
		}
		mainBox.appendChild(fileLink)
	}
	if(clipped){
		mainMsg.textContent = 'The message has been truncated'
	}else{
		mainMsg.textContent = 'Encryption successful. Click Email or copy and send.'
	}
	
	if(emailMode.checked) sendMail();
	
	callKey = ''
}

//This is the core of pad encryption. Takes binary inputs and returns binary output. Same code for encrypt and decrypt
function padResult(textBin, keyTextBin, nonce, startIndex){
	var keyLength = Math.ceil(textBin.length * 8 / entropyPerChar);
	var keyBin = new Uint8Array(keyLength),
		i;
	if(startIndex + keyLength <= keyTextBin.length){								//fits without wrapping
		for(i = 0; i < keyLength; i++){
			keyBin[i] = keyTextBin[startIndex + i]
		}
	}else{																				//wrapping needed
		for(i = 0; i < keyTextBin.length - startIndex; i++){
			keyBin[i] = keyTextBin[startIndex + i]
		}
		for(i = 0; i < keyLength - (keyTextBin.length - startIndex); i++){
			keyBin[keyTextBin.length - startIndex + i] = keyTextBin[i]
		}
	}
	
	//now take a whole bunch of hashes of the encoded key Text, in 64-byte groups and using the nonce and an index, to make the keystream
	var count = Math.ceil(textBin.length / 64),
		keyStream = new Uint8Array(count * 64);	
	for(var index = 0; index < count; index++){
		var indexBin = nacl.util.decodeUTF8(index);
		var inputArray = new Uint8Array(keyBin.length + nonce.length + indexBin.length);

		//now concatenate the arrays
		for(i = 0; i < keyBin.length; i++){
			inputArray[i] = keyBin[i]
		}
		for(i = 0; i < nonce.length; i++){
			inputArray[keyBin.length + i] = nonce[i]
		}
		for(i = 0; i < indexBin.length; i++){
			inputArray[keyBin.length + nonce.length + i] = indexBin[i]
		}		
		var hash = nacl.hash(inputArray);			//now take the hash
		for(i = 0; i < 64; i++){
			keyStream[index*64 + i] = hash[i]
		}
	}
	
	//and finally XOR the keystream and the text
	var cipherBin = new Uint8Array(textBin.length);
	for(i = 0; i < textBin.length; i++){
		cipherBin[i] = textBin[i] ^ keyStream[i]
	}
	return cipherBin
}

//makes a 16-byte message authentication code
function padMac(textBin, keyTextBin, nonce, startIndex){						//startIndex is the one from the prompt
	var textKeyLength = Math.ceil(textBin.length * 8 / entropyPerChar),
		macKeyLength = Math.ceil(64 * 8 / entropyPerChar);						//collect enough entropy so the probability of a positive is the same for correct and incorrect decryptions
	var macBin = new Uint8Array(textBin.length + macKeyLength + nonce.length),
		i;
	var macStartIndex = (startIndex + textKeyLength) % keyTextBin.length		//mod because it may have wrapped
	
	//now add a sufficient part of the key text to obfuscate 9 bytes
	if(macStartIndex + macKeyLength <= keyTextBin.length){								//fits without wrapping
		for(i = 0; i < macKeyLength; i++){
			macBin[i] = keyTextBin[macStartIndex + i]
		}
	}else{																					//wrapping needed
		for(i = 0; i < keyTextBin.length - macStartIndex; i++){
			macBin[i] = keyTextBin[macStartIndex + i]
		}
		for(i = 0; i < macKeyLength - (keyTextBin.length - macStartIndex); i++){
			macBin[keyTextBin.length - macStartIndex + i] = keyTextBin[i]
		}
	}

	//now add the nonce
	for(i = 0; i < nonce.length; i++){
		macBin[macKeyLength + i] = nonce[i]
	}

	//finish adding the plaintext. The rest will be left as zeroes
	for(i = 0; i < textBin.length; i++){
		macBin[macKeyLength + nonce.length + i] = textBin[i]
	}

	//take the SHA512 hash and keep the first 16 bytes
	return nacl.hash(macBin).slice(0,16)
}

//for decrypting with long key
function padDecrypt(cipherStr){
	mainMsg.textContent = "";
	var keyText = lockBox.textContent.replace(/\n/g,' ').trim();
	if (keyText == ''){
		mainMsg.textContent = 'Click Enter and enter long shared Key, then try again';
		return
	}
	try{
		var inputBin = nacl.util.decodeBase64(cipherStr);
		if(!inputBin) return false;
		var	keyTextBin = nacl.util.decodeUTF8(keyText);
		if(cipherStr.length == 160){									//short mode message
			var	nonce = inputBin.slice(1,10),
				macBin = inputBin.slice(10,26),
				cipherBin = inputBin.slice(26)
		}else{															//all other modes
			var	nonce = inputBin.slice(1,16),
				macBin = inputBin.slice(16,32),
				cipherBin = inputBin.slice(32)
		}
			
	}catch(err){
		mainMsg.textContent = "This is corrupt or not encrypted"
	}
	if(cipherBin.length > keyTextBin.length){
		mainMsg.textContent = "The key Text is too short";
		return
	}
	while(isNaN(startIndex) || startIndex < 0 || startIndex > keyTextBin.length){
		var reply = prompt("Pad mode in use.\nPlease enter the position in the key text where we should start (0 to " + keyTextBin.length + ")",0);
		if(reply == null){return}else{var startIndex = parseInt(reply)}
	}
	
	var plainBin = padResult(cipherBin, keyTextBin, nonce, startIndex);		//decryption instruction

	try{
		if(cipherStr.length == 160){
			var plain = decodeURI(nacl.util.encodeUTF8(plainBin)).trim()
		}else{
			if(plainBin.join().match(",61,34,100,97,116,97,58,")){					//this when the result is a file, which uses no compression
				var plain = nacl.util.encodeUTF8(plainBin)
			}else{
				var plain = LZString.decompressFromUint8Array(plainBin)			//use compression in the normal case
			}
		}
	}catch(err){
		mainMsg.textContent = "Decryption has failed"
	}
	
	//so far so good. Now do MAC checking
	if(plain){
		var	macNew = padMac(plainBin, keyTextBin, nonce, startIndex),				//make mac of the result
			macChecks = true;
		for(var i = 0; i < 16; i++){
			macChecks = macChecks && (macBin[i] == macNew[i])
		}

		if(macChecks){																//check authentication and display result if passed
			mainBox.innerHTML = decryptSanitizer(plain);
			mainMsg.textContent = 'Decryption successful';
		}else{
			mainMsg.textContent = 'Message authentication has failed';
		}
		openChat()														//in case it was an encrypted chat
	}else{
		mainMsg.textContent = "Decryption has failed"
	}
	
	callKey = ''
}

//Finally, Human encryption mode

var	base26 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
	
//makes the scrambled alphabet, starting from a string
function makeAlphabet(string){
	var result = '', alpha = "ZYXWVUTSRQPONMLKJIHGFEDCBA",
		stringLength = string.length;
	if(stringLength != 0){
		for(var i = 0; i < stringLength; i++){
			var letter = string.charAt(i);
			if(result.indexOf(letter) == -1){			//letter not picked yet
				result += letter;
				var reg = new RegExp(letter);
				alpha = alpha.replace(reg,'')
			}else{										//letter was picked, so take first letter before it in the alphabet that is still available
				var index = base26.indexOf(letter),
					alphaLength = alpha.length;
				for(var j = 0; j < alphaLength; j++){
					if(base26.indexOf(alpha.charAt(j)) < index){
						result += alpha.charAt(j);
						alpha = alpha.slice(0,j) + alpha.slice(j+1,alphaLength);
						break
					}else if(j == alphaLength - 1){
						result += alpha.charAt(0);
						alpha = alpha.slice(1)
					}
				}
			}
		}
		var base26B = result + alpha
	}else{
		var base26B = base26							//use straight alphabet if the key is empty
	}
	var base26Barray = new Array(26),
		base26Binverse = new Array(26);
	for(var i = 0; i < 26; i++){
		base26Barray[i] = base26.indexOf(base26B.charAt(i));
		base26Binverse[i] = base26B.indexOf(base26.charAt(i))
	}
	return [base26Barray,base26Binverse]
}

//to remove accents etc.
String.prototype.removeDiacritics = function() {
    var diacritics = [
        [/[\300-\306]/g, 'A'],
        [/[\340-\346]/g, 'a'],
        [/[\310-\313]/g, 'E'],
        [/[\350-\353]/g, 'e'],
        [/[\314-\317]/g, 'I'],
        [/[\354-\357]/g, 'i'],
        [/[\322-\330]/g, 'O'],
        [/[\362-\370]/g, 'o'],
        [/[\331-\334]/g, 'U'],
        [/[\371-\374]/g, 'u'],
        [/[\321]/g, 'N'],
        [/[\361]/g, 'n'],
        [/[\307]/g, 'C'],
        [/[\347]/g, 'c'],
		 [/[\337]/g, 'ss'],
    ];
    var s = this;
    for (var i = 0; i < diacritics.length; i++) {
        s = s.replace(diacritics[i][0], diacritics[i][1]);
    }
    return s;
}

//processes plaintext or ciphertext and does encryption (decryption if isEncrypt = false)
function humanEncrypt(text,isEncrypt){
	text = text.replace(/(<br>|<div>)/g,' ').replace(/<(.*?)>/g,'');																		//no tags allowed. pure text
	if(text.trim() == '') return;
	
	//text preparation. If encrypting, convert Qs into Ks and then spaces into Qs. Punctuation other than commas into QQ
	if(isEncrypt){
		text = text.replace(/[0-9]/g,function(match){return base26.charAt(match);}).trim();						//replace numbers with letters
		text = text.toUpperCase().removeDiacritics();																//remove accents and make upper case
		text = text.replace(/Q/g,'K').replace(/[.;:!?{}_()\[\]…—–―\-\s\n]/g,'Q').replace(/Q+$/,'')				//turn Q into K, spaces and punctuation into Q
	}
	text = text.replace(/[^A-Z]/g,'');																				//only base26 anyway

	var rawKeys = lockBox.textContent.trim().split('~');
	for(var i = 0; i < 3; i++) rawKeys[i] = rawKeys[i].toUpperCase().removeDiacritics().replace(/[^A-Z]/g,'');	//remove accents, spaces, and all punctuation

	var	base26B1arrays = makeAlphabet(compressKey(rawKeys[0],25)),
		base26B2arrays = makeAlphabet(compressKey(rawKeys[1],25)),
		base26BArray1 = base26B1arrays[0],
		base26BArray2 = base26B2arrays[0],
		base26Binverse1 = base26B1arrays[1],
		base26Binverse2 = base26B2arrays[1],
		seed = rawKeys[2] ? rawKeys[2] : rawKeys[0];			//if seed is empty, use key 1

	var seedLength = seed.length;
	seedArray = new Array(seedLength);				//this is actually the seed mask
	for(var i = 0; i < seedLength; i++){
		seedArray[i] = base26.indexOf(seed.charAt(i))
	}

	var isGoodSeed = false,							//so it calculates at least once. No iteration when decrypting
		extendedText = text;							//initialize for decryption
  while(!isGoodSeed){
	var	rndSeedArray = new Array(seedLength);	
	if(isEncrypt){										//per-message random seed
		var	dummySeed = '',
			newIndex;
		for(var i = 0; i < seedLength; i++){
			newIndex = Math.floor(betterRandom()*26);	//avoid using Math.random() since this must be cryptographically secure
			rndSeedArray[i] = newIndex;					//this contains the random seed		
			dummySeed += base26.charAt(newIndex)
		}
		extendedText = dummySeed + text
	}		
		
	var	length = extendedText.length,
		textArray = new Array(length),
		cipherArray = new Array(length);

	//now fill row 1 with numbers representing letters; this will be a lot faster than doing string operations
	for(var i = 0; i < length; i++){
		textArray[i] = base26.indexOf(extendedText.charAt(i))
	}
	
	//if decrypting, extract the random seed
	if(!isEncrypt){
		for(var i = 0; i < seedLength; i++) rndSeedArray[i] = base26BArray2[(26 - base26Binverse1[textArray[i]] + seedArray[i]) % 26]
	}
	
	//main calculation. First make the keystream
	var stream = new Array(length);
	for(var i = 0; i < seedLength; i++){
		stream[i] = rndSeedArray[i]
	}
	for(var i = seedLength; i < length; i++){
		stream[i] = base26BArray1[(26 - base26Binverse2[stream[i-seedLength]] + stream[i-seedLength+1]) % 26]
	}
	
	//now test that the cipherstream obtained has sufficient quality, otherwise make another guess for the seed and repeat the process
	if(isEncrypt){
		var freqArray = frequencies(stream,26),											//first compute the frequency histogram
			chiNumber = chiSquared(stream,freqArray,26),									//single letter chi-squared. Must be smaller than 34.4
			corNumber = corrAtDistance(stream,freqArray,26,1);							//correlation chi-squared for consecutive letters. Must be smaller than 671
		
		isGoodSeed = (chiNumber < 34.4) && (corNumber < 671)							//this is the test for randomness of the keystream
	}else{
		isGoodSeed = true																	//automatic pass when decrypting
	}
  }																						//end of iteration for good seed
	
	stream = seedArray.concat(stream.slice(seedLength));											//replace random seed with original seed before the final operation

	//now combine the plaintext (ciphertext) and the keystream using the Tabula Prava, and convert back to letters
	for(var i = 0; i < length; i++) cipherArray[i] = isEncrypt ? base26.charAt(base26BArray1[(26 - base26Binverse2[textArray[i]] + stream[i]) % 26]) : base26.charAt(base26BArray2[(26 - base26Binverse1[textArray[i]] + stream[i]) % 26]);
	var cipherText = cipherArray.join('');

	if(!isEncrypt){
		cipherText = cipherText.slice(seedLength);										//remove dummy seed when decrypting
		cipherText = cipherText.replace(/QQ/g,'. ').replace(/Q/g,' ').replace(/KU([AEIO])/g,'QU$1')
	}

	if(shortMode.checked || !isEncrypt){
		mainBox.textContent = cipherText					//no tags in short mode or decrypting
	}else if(isEncrypt){
		mainBox.textContent = '';
		if(fileMode.checked){
			if(textMode.checked){
				var fileLink = document.createElement('a');
				fileLink.download = "PL24msh.txt";
				fileLink.href = "data:," + cipherText;
				fileLink.textContent = "PassLok 2.4 Human encrypted message (text file)"
			}else{
				var fileLink = document.createElement('a');
				fileLink.download = "PL24msh.plk";
				fileLink.href = "data:binary/octet-stream;base64," + cipherText;
				fileLink.textContent = "PassLok 2.4 Human encrypted message (binary file)"
			}
		}else if(emailMode.checked){
			var fileLink = document.createElement('pre');
			fileLink.textContent = "----------begin Human mode message encrypted with PassLok--------==\r\n\r\n" + outString.match(/.{1,80}/g).join("\r\n") + "\r\n\r\n==---------end Human mode message encrypted with PassLok-----------"
		}else{
			var fileLink = document.createElement('pre');
			fileLink.textContent = ("PL24msh==" + cipherText + "==PL24msh").match(/.{1,80}/g).join("\r\n")
		}
		mainBox.appendChild(fileLink)
	}
	if(isEncrypt){
		mainMsg.textContent = 'Human encryption done. Recipients can decrypt this by hand'
	}else{
		mainMsg.textContent = 'Human decryption done. Numbers turned into characters. Commas lost'
	}
	
	if(emailMode.checked && isEncrypt) sendMail();
	
	callKey = ''
}

//alternative to Math.random based on nacl.randomBytes. Used to generate floating point numbers between 0 and 1. Uses 8 bytes as space, which is enough for double precision
function betterRandom(){
	var randomArray = nacl.randomBytes(8),
		integer = 0,
		maxInt = 18446744073709551616; 				//this is 256^8
	for(var i = 0; i < 8; i++) integer = integer * 256 + randomArray[i];
	return integer / maxInt
}

//makes a high-entropy base26 key of a given length from a piece of regular text
function compressKey(string,length){
	var indexArray = new Array(string.length),
		outputArray = new Array(length),
		rows = Math.ceil(string.length / length),
		outStr = '';
	
	for(var i = 0; i < string.length; i++) indexArray[i] = base26.indexOf(string.charAt(i));		//turn into index array

	for(var i = 0; i < length; i++){	
		if(indexArray[i] != undefined) outputArray[i] = indexArray[i];									//do serpentine operations so long as there is more key material
		for(var j = 1; j < rows; j++){
			if(indexArray[i + length * j] != undefined) outputArray[i] = (26 - outputArray[i] + indexArray[i + length * j]) % 26
		}
	}
	
	for(var i = 0; i < length; i++) if(outputArray[i] != undefined) outStr += base26.charAt(outputArray[i]);
	return outStr
}

//counts frequency for each digit in the given base. The input array contains numbers from 0 to base - 1
function frequencies(array,base){
	var length = array.length,
		freqArray = new Array(base).fill(0);
	for(var i = 0; i < length; i++) freqArray[array[i]]++;
	return freqArray
}

//chi-squared statistic of a array in a given base
function chiSquared(array,freqArray,base){
	var	result = 0,
		length = array.length,
		expected = length / base,
		operand;
	for(var i = 0; i < base; i++){
		operand = freqArray[i] - expected;
		result += (operand * operand) / expected
	}
	return result
}

//two-digit test of dependence at different distance, for a given base. Minimum distance is 1
function corrAtDistance(array,freqArray,base,distance){
	var	length = array.length,
		highIndex = length - distance,
		result = 0,
		operand,
		expected,
		freqTable = new Array(base);
	for(var i = 0; i < base; i++) freqTable[i] = new Array(base).fill(0);
	for(var k = 0; k < highIndex; k++){			//fill the table with data
		freqTable[array[k]][array[k + distance]]++
	}
	for(var i = 0; i < base; i++){					//each first character
		for(var j = 0; j < base; j++){				//each second character
			expected = freqArray[i] * freqArray[j] / length;		//expected P(xy) = P(x)*P(y)
			if(expected > 0){										//in case a letter does not appear at all
				operand = freqTable[i][j] - expected;
				result += (operand * operand) / expected
			}
		}
	}
	return result
}
</script>

<!--extra functions for mail, etc.-->
<script>
//formats results depending on tags present and sends to default email
function sendMail() {
	var type = getType(mainBox.innerHTML.trim())[0],
		words = mainBox.textContent;							//for word Locks
	if(words.match('==')) words = words.split('==')[1];
	words = words.trim().split(' ');
	if(learnMode.checked){
		if(type.match(/[lckgdasoprASO]/)){
			var reply = confirm("A new tab will open, including the contents of this box in your default email. You still need to supply the recipient's address and a subject line. Only Locks and encrypted or signed items are allowed. Cancel if this is not what you want.")
		}else{
			var reply = confirm("An invitation for others to join PassLok and containing your Lock will open in your default email. You still need to supply the recipient's address.  Cancel if this is not what you want.")
		}
		if(!reply) return
	}

  if(mainBox.textContent.match("The gibberish link below contains a message from me that has been encrypted with PassLok")){			//invitation message
	var link = "mailto:"+ "?subject=Invitation to PassLok" + "&body=" + encodeURIComponent(mainBox.textContent.trim()) + "%0D%0A%0D%0AYou can get PassLok from https://passlok.com/app and other sources, plus the Chrome, Firefox, and Android app stores."
  }else{
	var hashTag = encodeURIComponent(mainBox.textContent.trim().replace(/ /g,'_'));		//item ready for link
	var linkText = "Click the link below if you wish to process this automatically using the web app (the app will open in a new tab and ask you for your Key), or simply copy it and paste it into your favorite version of PassLok:%0D%0A%0D%0Ahttps://passlok.com/app#" + hashTag + "%0D%0A%0D%0AYou can get PassLok from https://passlok.com/app and other sources, plus the Chrome, Firefox, and Android app stores.";

	if(words.length == 20){												//20 words, so most likely a word Lock
		var link = "mailto:"+ "?subject= " + "&body=This email contains my PassLok v.2.4 Lock as a list of words. Use it to encrypt text or files for me to decrypt, or to verify my seal.%0D%0A%0D%0A" + linkText
	}else if(type=="a" || type=="A"){
		if(emailMode.checked){
			var link = "mailto:"+ "?subject= " + "&body=" + encodeURIComponent(mainBox.textContent.trim())
		}else{
    		var link = "mailto:"+ "?subject= " + "&body=Anonymous message encrypted with PassLok v.2.4 %0D%0A%0D%0ADecrypt with your secret Key.%0D%0A%0D%0A" + linkText
		}
	}else if (type=="g" || type=="d" || type=="h"){
		if(emailMode.checked){
			var link = "mailto:"+ "?subject= " + "&body=" + encodeURIComponent(mainBox.textContent.trim())
		}else{
			var link = "mailto:"+ "?subject= " + "&body=Message encrypted with PassLok v.2.4 %0D%0A%0D%0ADecrypt with shared Key.%0D%0A%0D%0A" + linkText
		}
	}else if (type=="s" || type=="S"){
		if(emailMode.checked){
			var link = "mailto:"+ "?subject= " + "&body=" + encodeURIComponent(mainBox.textContent.trim())
		}else{
			var link = "mailto:"+ "?subject= " + "&body=Signed message encrypted with PassLok v.2.4 %0D%0A%0D%0ADecrypt with your secret Key and my Lock.%0D%0A%0D%0A" + linkText
		}
	}else if (type && type.match(/[oprO]/)){
		if(emailMode.checked){
			var link = "mailto:"+ "?subject= " + "&body=" + encodeURIComponent(mainBox.textContent.trim())
		}else{
			var link = "mailto:"+ "?subject= " + "&body=Read-once message encrypted with PassLok v.2.4 %0D%0A%0D%0ADecrypt with your secret Key.%0D%0A%0D%0A" + linkText
		}
	}else if (type=="k"){
		var link = "mailto:"+ "?subject=My PassLok database" + "&body=Database encrypted with PassLok v.2.4 %0D%0A%0D%0ADecrypt with my secret Key.%0D%0A%0D%0A" + linkText
	}else if (type=="l"){
		var link = "mailto:"+ "?subject= " + "&body=Text sealed with PassLok v.2.4. It is not encrypted. Extract it and verify my authorship using my Lock.%0D%0A%0D%0A" + linkText;
	}else if (type=='c'){
		var link = "mailto:"+ "?subject= " + "&body=This email contains my PassLok v.2.4 Lock. Use it to encrypt text or files for me to decrypt, or to verify my seal.%0D%0A%0D%0A" + linkText
	}
  }
	if(isMobile){ 	 											//new window for PC, same window for mobile
		if(isChrome && isAndroid){
			mainMsg.textContent = "Android Chrome does not allow communication with the email app"
		}else{	
			window.open(link,"_parent")
		}
	}else{
		window.open(link,"_blank")
	}
}

//encrypt main box with myLock in order to make an invitation
function makeInvitation(){
	if(mainBox.textContent.trim() != ''){
		var reply = confirm('Do you want the contents of the main box to be encrypted and added to an invitation email? This will encourage the recipients to try PassLok, but be aware that the encrypted contents WILL NOT BE SECURE.');
		if (!reply) return;	
		var text = mainBox.innerHTML.trim(),
			nonce = nacl.randomBytes(9),
			nonce24 = makeNonce24(nonce),
			cipherStr = myezLock + '//////' + nacl.util.encodeBase64(concatUint8Arrays([128],concatUint8Arrays(nonce,PLencrypt(text,nonce24,myLock,true)))).replace(/=+$/,'');			//this includes compression		
		mainBox.textContent = '';
		
			var prefaceMsg = document.createElement('div');
			prefaceMsg.textContent = "The gibberish link below contains a message from me that has been encrypted with PassLok, a free app that you can get at the Chrome and Firefox web stores. There is also PassLok Privacy, PassLok for Email, and PassLok Universal at the same stores, plus the standalone PassLok web app at https://passlok.com/app.\r\n\r\nTo decrypt it, install PassLok, reload this page. You will be asked to supply a Master Key, which will not be stored or sent anywhere. You must remember your secret Key, but you can change it later if you want. When asked whether to accept my new Key (which you don't know), go ahead and click OK. You can also decrypt the invitation by pasting it into your favorite version of PassLok:";
		if(emailMode.checked){
			var initialTag = document.createElement('pre'),
				invBody = document.createElement('pre'),
				finalTag = document.createElement('pre');
			initialTag.textContent = "\r\n\r\n----------begin invitation message encrypted with PassLok--------==\r\n\r\n";
			invBody.textContent = cipherStr.match(/.{1,80}/g).join("\r\n");
			finalTag.textContent = "\r\n\r\n==---------end invitation message encrypted with PassLok-----------";
			mainBox.appendChild(prefaceMsg);
			mainBox.appendChild(initialTag);
			mainBox.appendChild(invBody);
			mainBox.appendChild(finalTag);
		}else{
			prefaceMsg.textContent = prefaceMsg.textContent + "\r\n\r\nhttps://passlok.com/app#PL24inv==" + cipherStr + "==PL24inv";
			mainBox.appendChild(prefaceMsg)
		}
		updateButtons();
		mainMsg.textContent = "Invitation created. Invitations are ";
		var blinker = document.createElement('span');
		blinker.className = "blink";
		blinker.textContent = "NOT SECURELY ENCRYPTED";
		mainMsg.appendChild(blinker);
		if(emailMode.checked) sendMail()
	}else{
		mainMsg.textContent = "Write something not confidential to add to the invitation, then click Invite again"
	}
}

//displays QR code with sender's Lock and main URL
function makeQRcode(){
	if(!refreshKey()) return;
	qrcode.makeCode('passlok.com/app#' + myLockStr);
	mainMsg.textContent = "This QR code contains your Lock. Tap it to hide"
	qrcodeImg.style.display = 'block'
}

//calls texting app
function sendSMS(){
	if(learnMode.checked){
		var reply = confirm("The default texting app will now open. You need to have copied your short encrypted message to the clipboard before doing this, if you want to send one. This only works on smartphones. Cancel if this is not what you want.");
		if(!reply) return
	}
	if(sendSMSBtn.textContent == 'Save'){
		saveFiles()
	}else{
		selectMain();
		window.open("SMS:","_parent")
	}
}

//decrypts a chat invite if found, then opens chat screen, otherwise makes one
function Chat(){
	var text = mainBox.innerHTML.trim();

	if(text.match('==') && text.split('==')[0].slice(-4) == 'chat'){		//there is already a chat invitation, so open it
		var msg = text.split('==')[1],
			type = msg.charAt(0);
		unlock(type,msg,lockBox.innerHTML.replace(/\n/g,'<br>').trim());
		return
	}

	var listArray = lockBox.innerHTML.replace(/\n/g,'<br>').trim().split('<br>').filter(Boolean);
	if(learnMode.checked){
		var reply = confirm("A special encrypted item will be made, inviting the selected recipients to a secure chat session. Cancel if this is not what you want.");
		if(!reply) return
	}

	if(listArray.length == 0 || (listArray.length == 1 && listArray[0] == 'myself')){
		mainMsg.textContent = 'Please select those invited to chat';
		return
	}
	if(longMode.checked) listArray = listArray.concat('myself');								//make sure 'myself' is on the list, unless it's not a multi-recipient message
	listArray = listArray.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});  			//remove duplicates and nulls
	listArray = listArray.filter(function(n){return n});
	lockBox.innerText = listArray.join('\n');
	openClose('shadow');
	openClose('chatDialog');												//stop to get chat type
	chatDate.value = mainBox.textContent.trim().slice(0,43);
}

//continues making a chat invite after the user has chosen the chat type
function makeChat(){
	closeBox();
	if(dataChat.checked){					//A to C for Muaz Khan's WebRTC chat, D for Jitsi
		var type = 'A'
	}else if (audioChat.checked){
		var type = 'B'
	}else if (videoChat.checked){
		var type = 'C'
	}else{
		var type = 'D'
	}
	var date = chatDate.value.slice(0,43);						//can't do encodeURI here because this will be decrypted by decryptList, which doesn't expect it
	if(date.trim() == '') date = 'noDate';
	while(date.length < 43) date += ' ';
	var password = nacl.util.encodeBase64(nacl.randomBytes(32)).replace(/=+$/,''),
		chatRoom = makeChatRoom();
	lock(lockBox.innerHTML.replace(/\n/g,'<br>').replace(/<br>$/,"").trim(),date + type + chatRoom + '?' + password);	//date msg + info to be sent to chat page
	setTimeout(function(){
			if(emailMode.checked) sendMail()
	},50)
}

//makes a mostly anonymous chatRoom name from four words in the wordlist
function makeChatRoom(){
	var wordlist = wordListExp.toString().slice(1,-2).split('|'),
		name = '';
	for(var i = 0; i < 4; i++){
		name += capitalizeFirstLetter(replaceVariants(wordlist[randomIndex()]))
	}
	return name
}

//capitalizes first letter, the better to blend into Jitsi
function capitalizeFirstLetter(str) {
  return str[0].toUpperCase() + str.slice(1);
}

//returns a random index for wordlist
function randomIndex(){
	return Math.floor(Math.random()*wordLength)
}

//detects if there is a chat link in the main box, and opens the Chat window
function openChat(){
	var typetoken = mainBox.textContent.trim();
	if (typetoken.slice(-44,-43) == '?' && !typetoken.slice(43).match(/[^A-Za-z0-9+\/?]/)){			//chat data detected, so open chat
		mainBox.textContent = '';
		var date = typetoken.slice(0,43).trim(),									//the first 43 characters are for the date and time etc.
			chatToken = decodeURI(typetoken.slice(43));
		if(date != 'noDate'){
			var msgStart = "This chat invitation says:\n\n " + date + " \n\n"
		}else{
			var msgStart = ""
		}
		var reply = confirm(msgStart + "If you go ahead, the chat session will open now.\nWARNING: this involves going online, which might give away your location. If you cancel, a link for the chat will be made.");
		if(!reply){
			var chatLink = document.createElement('a');
			chatLink.href = 'https://passlok.com/chat/chat.html#' + chatToken;
			chatLink.textContent = 'Right-click to open the chat';
			mainBox.textContent = '';
			mainBox.appendChild(chatLink);
			return
		}
		if(isSafari || isIE || isiOS){
			mainMsg.textContent = 'Sorry, but chat is not yet supported by your browser or OS';
			return
		}
		main2chat(chatToken)
	}
}
</script>

<!--Shamir Secret Sharing Scheme-->
<script>
//function that starts it all when the Split/Join button is pushed
function splitJoin(){
	blinkMsg(mainMsg);				//Get blinking message started
	setTimeout(function(){																			//the rest after a 20 ms delay
		secretshare()
	},20)					//end of timeout
}

//this function implements the Shamir Secret Sharing Scheme, taking the secret from the main box and putting the result back there, and vice-versa.
function secretshare(){
	var main = mainBox.innerHTML.trim(),																//innerHTML to preserve links
		tags = main.match(/PL\d{2}p\d{3}/);
	if(tags){																	//main box has parts: join parts
		if(main.match('href="data:')){										//parts in links
			var shares = main.replace(/<div>/g,'<br>').replace(/<\div>/g,"").replace(/<b>/g,"").split("<br>").filter(Boolean)				//go from newline-containing string to array
		}else{
			var shares = mainBox.innerText.split("\n\n").filter(Boolean)							//split when double spaced
		}
		var	n = shares.length,
			quorum = parseInt(tags[0].slice(-3));														//quorum in tags is "p" plus 3 digits in a row, first instance
		if(n < quorum){																//not enough parts
			mainMsg.textContent = 'According to the tags, you need ' + (quorum - n) + ' more parts in the box';
			return
		}
		if(n < quorum){																//not enough parts
			mainMsg.textContent = 'According to the tags, you need ' + (quorum - n) + ' more parts in the box';
			return
		}
		//extract shares from links, condition shares for combination
		for (var i = 0; i < shares.length; i++) {
			if(shares[i].match('href="data:')){										//share is in link
				shares[i] = shares[i].match(/,[a-zA-Z0-9\/+]+"/)[0].slice(1,-1)
			}else{																		//share as text, just remove tags and extra spaces
				shares[i] = stripTags(shares[i].replace(/\s/g,''))
			}
			var shareBin = nacl.util.decodeBase64(shares[i]);
			if(!shareBin) return false;
			shares[i] = "8" + charArray2hex(shareBin)				//convert to hex
		}
		if(learnMode.checked){
			var reply = confirm("The parts in the main box will be joined to retrieve the original item, which will be placed in this box. Please make sure that there are enough parts. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(n === 1){
			mainMsg.textContent = 'Only one part in main box';
			return
		}
try{
		var	sechex = secrets.combine(shares),
			secBin = hex2charArray(sechex);
		if(secBin.join().match(",61,34,100,97,116,97,58,")){
			var secret = nacl.util.encodeUTF8(secBin)
		}else{
			var secret = LZString.decompressFromUint8Array(secBin)
		}
		mainBox.innerHTML = decryptSanitizer(secret);									//disable non-whitelisted tags and attributes
		mainMsg.textContent = 'Join successful'
}catch(err){
	mainMsg.textContent = 'There was an error'									//the encodeUTF8 is the likely culprit
}
	}else{																		//parts not detected, split instead
		if(main == "") {
			mainMsg.textContent = 'The box is empty';
			return
		}
		if(learnMode.checked){
			var reply = confirm("The item in the box will be split into several partial items, which will replace the contents of the box. A popup will ask for the total number of parts, and the minimum needed to reconstruct the original item. Cancel if this is not what you want.");
			if(!reply) return
		}
		var number = partsNumber.value;
		if(number.trim() == ""){													//stop to display the entry form if it is empty
			partsIn.style.display = "block";
			shadow.style.display = "block";
			if(!isMobile){
				partsNumber.focus()
			}else{
				window.scrollTo(0, 0)
			}
			return
		}
		partsIn.style.display = "none";
		shadow.style.display = "none";
		var quorum = partsQuorum.value;					//this value defaults to the total number if empty
		if (quorum.trim() == ""){
			quorum = number
		}
		partsNumber.value = "";							//on re-execution, read the box and reset it
		partsQuorum.value = "";
		quorum = parseInt(quorum);
		number = parseInt(number);
		if(number < 2){number = 2} else if(number > 255) {number = 255};
		if (quorum > number) quorum = number;
		var secret = mainBox.innerHTML.trim();
		if(secret.match('="data:')){									//no compression if it includes a file
			var secBin = nacl.util.decodeUTF8(secret)
		}else{
			var secBin = LZString.compressToUint8Array(secret)
		}
		var	sechex = charArray2hex(secBin),
			shares = secrets.share(sechex,number,quorum);
		displayshare(shares,quorum);
		mainMsg.textContent = number + ' parts made. ' + quorum + ' required to reconstruct';
		partsInBox = true
	}
	setTimeout(function(){charsLeft();},20)
}

function displayshare(shares,quorum){
	var length = shares[0].length,
		quorumStr = "00" + quorum,
		output = "";
	quorumStr = quorumStr.substr(quorumStr.length-3);
	
	mainBox.textContent = '';
	var fragment = document.createElement('div');

	for (var i = 0; i < shares.length; i++) {
		var dataItem = nacl.util.encodeBase64(hex2charArray(shares[i].slice(1,length))).replace(/=+/g, '');
		if(i > 0) output += "<br><br>";
		if(fileMode.checked){
			if(textMode.checked){
				output +=  '<a download="PL24p' + quorumStr + '.txt" href="data:,' + dataItem + '"><b>PassLok 2.4 Part out of ' + quorumStr + ' as a text file</b></a>'
			}else{
				output += '<a download="PL24p' + quorumStr + '.txt" href="data:binary/octet-stream;base64,' + dataItem + '"><b>PassLok 2.4 Part out of ' + quorumStr + ' as a binary file</b></a>'
			}
		}else{
			output += "<pre>" + ("PL24p" + quorumStr + "==" + dataItem + "==PL24p" + quorumStr).match(/.{1,80}/g).join("<br>") + "</pre>"
		}
	};
	fragment.innerHTML = output;				//must use innerHTML because building the list of links with linefeeds in between with the appendChild method does not work in Chrome (bug?)
	mainBox.appendChild(fragment)
}

//convert an array of 8-bit decimal codes into a hexadecimal string
function charArray2hex(charArray){
	var output = '';
	for(var i = 0;i < charArray.length; i++){
		var newstring = charArray[i].toString(16);
		if (newstring.length < 2) newstring = '0' + newstring;
		output += newstring
	}
	return output
}

//convert a hexadecimal string (two characters per byte) into an array of decimal codes. Wrong codes marked as -1
function hex2charArray(string){
	var output = [];
	for(var i = 0;i < string.length; i=i+2){
		var a = parseInt(string.slice(i,i+2),16);
		if(isNaN(a)){
			output[i/2] = -1
		}else{
			output[i/2] = a
		}
	}
	return output
}
</script>

<!--text steganograghy-->
<script>
//The following code is to convert the contents of main box into fake text, and back. This can be useful against email scanners.

if (typeof code == 'undefined'){			//default text for base64 to words conversion, global variable
	var defaultCoverText = "The licenses for most software and other practical works are designed to take away your freedom to share and change the works. By contrast, the GNU General Public License is intended to guarantee your freedom to share and change all versions of a program to make sure it remains free software for all its users. We, the Free Software Foundation, use the GNU General Public License for most of our software; it applies also to any other work released this way by its authors. You can apply it to your program, too. When we speak of free software, we are referring to freedom, not price. Our General Public Licenses are designed to make sure that you have the freedom to distribute copies of free softwares (and charge for them if you wish), that you receive source code or can get it if you want it, that you can change the software or use pieces of it in new free programs, and that you know you can do these things. To protect your rights, we need to prevent others from denying you these rights or asking you to surrender the rights. Therefore, you have certain responsibilities if you distribute copies of the software, or if you modify it: responsibilities to respect the freedom of others. For example, if you distribute copies of such a program, whether gratis or for a fee, you must pass on to the recipients the same freedoms that you received. You must make sure that they, too, receive or can get the source code. And you must show them these terms so they know their rights. Developers that use the GNU GPL protect your rights with two steps: (1) assert copyright on the software, and (2) offer you this License giving you legal permission to copy, distribute and or modify it. For the developers' and authors' protection, the GPL clearly explains that there is no warranty for this free software. For both users' and authors' sake, the GPL requires that modified versions be marked as changed, so that their problems will not be attributed erroneously to authors of previous versions.";
	var coverText = defaultCoverText;
		coverText = coverText.replace(/ +/g," ").replace(/ \n/g,"\n")									//remove multiple spaces, space before linefeed
}

//returns true if pure base64
function isBase64(string){
	return !string.match(/[^a-zA-Z0-9+\/]/)
}

//to remove duplicates in array much more quickly than with array.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});
function uniq(a) {
    var seen = {};
    return a.filter(function(item) {
        return seen.hasOwnProperty(item) ? false : (seen[item] = true);
    })
}

//This function checks for legal (base64 after tags are removed) PassLok output and calls the currently selected encoder. Otherwise it calls the decoder
function textStego(){
	var text = mainBox.innerHTML.replace(/&[^;]+;/g,'').replace(/<a(.*?).(plk|txt)" href="data:(.*?),/,'').replace(/">(.*?)\/a>$/,'').replace(/<br>/g,'').replace(/[\r\n]/g,'');
	if(text.match('==')) text = text.split('==')[1].replace(/-/g,'');						//remove tags and dashes
	text = text.replace(/<(.*?)>/gi,'');
	if(text == ""){
		mainMsg.textContent = 'No text in the box';
		return
	}

	blinkMsg(mainMsg);
setTimeout(function(){																			//the rest after a 20 ms delay
	if(isBase64(text)){										//pure base64 found: encode it
		if(sentenceMode.checked){
			toPhrases(text)
		}else if(wordMode.checked){
			toWords(text)
		}else if(spaceMode.checked){
			toSpaces(text)
		}else if(invisibleMode.checked){
			toInvisible(text)
		}else{
			toLetters(text)
		}
	}else{												//no legal item found: try to decode
		if(text.match('\u00ad')){						//detect soft hyphen
			fromInvisible(text);
			mainMsg.textContent = 'Message extracted from Invisible encoding'
		}else if(text.match('\u200c')){				//detect zero width non-joiner
			fromSpaces(text);
			mainMsg.textContent = 'Message extracted from Spaces encoding'
		}else if(text.match('\u2004') || text.match('\u2005') || text.match('\u2006')){		//detect special characters used in Letters encoding
			fromLetters(text);
			mainMsg.textContent = 'Message extracted from Letters'
		}else if(text.match(':') != null){			//detect colons and if there are any invoke Sentences decoder
			fromPhrases(text);
			mainMsg.textContent = 'Message extracted from Sentences'
		}else{											//no special characters detected: words decoder
			fromWords(text);
			mainMsg.textContent = 'Message extracted from Words encoding'
		}
	}
	charsLeft()
},20);					//end of timeout
}

//makes array with words of 8 different lengths taken from the cover
function makeWordMatrix(cover){
	var wordArray = uniq(cover.replace(/[\.,!?\*;:{}_()\[\]"…“”‘’„‚«»‹›—–―¿¡]|_/g, "").replace(/[\s\n]+/g,' ').slice(0,-1).split(/ /)),
		bins = [[],[],[],[],[],[],[],[]];
	for(var i = 0; i < wordArray.length; i++){
		var lengthMod8 = wordArray[i].length % 8;
		bins[lengthMod8] = bins[lengthMod8].concat(wordArray[i])
	}
	for(var i = 0; i < 8; i++){
		if(bins[i].length == 0){
			mainMsg.textContent = 'Please use a Cover text with more variation';
			return
		}
	}
	return bins
}

//words encoder: each character is given a 2-digit base9 code, and replaced by two words of those lengths
function toWords(text){
	if(learnMode.checked){
		var reply = confirm("The contents of the main box will be replaced with encoded text which contains the original text as words of varying length. Cancel if this is not what you want.");
		if(!reply) return
	}
	var	wordArray = makeWordMatrix(coverText),
		out = new Array(text.length * 2);

	//now get a 2-digit code for each character in the text; each digit goes from 0 to 7, so we have 64 possibilities to encode base64
	for(var i = 0; i < text.length; i++){
		var index = base64.indexOf(text[i]),
			word1Choices = wordArray[Math.floor(index / 8)],
			word2Choices = wordArray[index % 8];
		out[2*i] = word1Choices[Math.floor(Math.random()*word1Choices.length)] + randompunct();
		out[2*i+1] = word2Choices[Math.floor(Math.random()*word2Choices.length)] + randompunct()
	}
	var outStr = out.join('');
	
	 //capitalize initial and after period, add final period.
	outStr = outStr.toLowerCase().replace(/[.][\s\n][a-z]/g,function(a){return a.toUpperCase();});
	outStr = outStr.replace(/[a-z]/,function(a){return a.toUpperCase();});
	outStr = outStr.slice(0,-1) + '.';
	mainBox.textContent = outStr.trim();
	mainMsg.textContent = 'Message encoded as words of varying length'
}

//words decoder. Takes groups of 2 words. Their lengths is the index of each characters, in base9
function fromWords(text){
	if(learnMode.checked){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(!reply) return
	}
	text = text.replace(/&nbsp;/g,'').replace(/[.,\n]/g,''); 		//remove extra spaces and punctuation
	var	textArray = text.split(/ /),
		out = new Array(textArray.length / 2);
	for(var i = 0; i < textArray.length; i=i+2){
		var index1 = textArray[i].trim().length % 8,
			index2 = textArray[i+1].trim().length % 8;
		out[i/2] = base64[index1 * 8 + index2]
	}
	mainBox.textContent = out.join('').trim()
}

//This is to generate random periods, commans and newlines, per the percentage brackets below, plus spaces when appropriate
function randompunct(){
	var percent = Math.ceil(Math.random() * 100);
	if (percent < 8) {
		return ". "
	} else if(percent < 14) {
		return ", "
	} else {
		return " "
	}
}

//the following functions are to hide text into a text cover, as binary double spaces. It needs a little under 6 cover words for each base64 character, 36 for non-ASCII
function spacesEncoder(bin){
	var textsplit = coverText.split(" "),
		stegospace = [' ', ' \u200c'],
		spaces = textsplit.length - 1,
		turns = 0;
	if (spaces < bin.length){									//repeat cover text if too short
		while (spaces < bin.length){
			textsplit = textsplit.concat(coverText.split(" "));
			spaces = textsplit.length - 1;
			turns++
		}
		mainMsg.textContent = 'Message encoded into spaces of this text. It was repeated ' + turns + ' times.'
	}else{
		mainMsg.textContent = 'Message encoded into spaces of this text'
	}
	textsplit = textsplit.slice(0,bin.length + 1);		//take a sufficiently long piece of cover text
	var newtext = new Array(bin.length + 1);
	newtext[0] = textsplit[0];
	for(var i = 0; i < bin.length; i++){
		newtext[i+1] = stegospace[bin[i]] + textsplit[i+1]
	}
	return newtext.join('')
}

function spacesDecoder(text){
	var textsplit = text.split(" "),
		bin = new Array(textsplit.length - 1);
	
	for(var i = 0; i < textsplit.length - 1; i++){
		if (textsplit[i + 1].match('\u200c')){
			bin[i] = 1
		}else{
			bin[i] = 0
		}
	}
	return bin
}

//retrieves base64 string from binary array. No error checking
function fromBin(input){
	var length = input.length - (input.length % 6),
		output = new Array(length / 6),
		index = 0;
	
	for(var i = 0; i < length; i = i+6) {
		index = 0;
		for(var j = 0; j < 6; j++){
			index = 2 * index + input[i+j]
		}
		output[i / 6] = base64.charAt(index)
    }
	return output.join('')
}

//makes the binary equivalent (array) of a base64 string. No error checking
function toBin(input){
	var output = new Array(input.length * 6),
		code = 0,
		digit = 0,
		divider = 32;
	
    for(var i = 0; i < input.length; i++) {
		code = base64.indexOf(input.charAt(i));
		divider = 32;
		for(var j = 0; j < 5; j++){
			digit = code >= divider ? 1 : 0;
			code -= digit * divider;
			divider = divider / 2;
			output[6 * i + j] = digit
		}
		output[6 * i + 5] = code;
    }
	return output
}

function toSpaces(text) {
	if(learnMode.checked){
		var reply = confirm("The contents of the main box will be replaced with encoded text which contains the original text as formatted spacing. Cancel if this is not what you want.");
		if(!reply) return
	}
	mainBox.textContent = spacesEncoder(toBin(text))
}

function fromSpaces(text) {
	if(learnMode.checked){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(!reply) return
	}
	mainBox.textContent = fromBin(spacesDecoder(text)).replace(/\x00/g,'').trim();		//take out nulls, in case text was added to finish the last sentence.
}

//the following functions are to hide text between two letters, as a binary string made of invisible characters.
function toInvisible(text) {
	if(learnMode.checked){
		var reply = confirm("The contents of the main box will be invisibly encoded (to a human) at the end of a sentence. Cancel if this is not what you want.");
		if(!reply) return
	}
	mainBox.textContent = 'Dear friend,' + invisibleEncoder(toBin(text)) + '\r\n\r\nBody of the message.'
}

function fromInvisible(text) {
	if(learnMode.checked){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(!reply) return
	}
	mainBox.textContent = fromBin(invisibleDecoder(text)).trim()
}

function invisibleEncoder(bin){
	var stegospace = ['\u00ad', '\u200c'],
		newtext = new Array(bin.length);

	for(var i = 0; i < bin.length; i++){
		newtext[i+1] = stegospace[bin[i]]
	}
	mainMsg.textContent = 'Message invisibly encoded at the end of the introduction in the box';
	return newtext.join('')
}

function invisibleDecoder(text){
	var binStr = text.replace(/\u00ad/g,'0').replace(/\u200c/g,'1');
	binStr = binStr.match(/[01]+/)[0];									//keep binary part
	var length = binStr.length,
		bin = new Array(length);
	for(var i = 0; i < length; i++){
		if (binStr.charAt(i) == '0'){
			bin[i] = 0
		}else{
			bin[i] = 1
		}
	}
	return bin
}

//makes phrase matrix for a given cover text, where sentences are catalogued by length mod 11
function makePhraseMatrix(cover){
	var phraseArray = cover.replace(/["…“”‘’„‚«»‹›¿¡]+/g,'').slice(0,-1).split(/[.,;:?!] /),
		bins = [[],[],[],[],[],[],[],[],[],[],[]];
	for(var i = 0; i < phraseArray.length; i++){
		var lengthMod12 = phraseArray[i].length % 11;
		bins[lengthMod12] = bins[lengthMod12].concat(phraseArray[i])
	}
	for(var i = 0; i < 11; i++){
		if(bins[i].length == 0){
			mainMsg.textContent = 'Please use a Cover text with more variation.';
			return
		}
	}
	return bins
}

//encodes text as sentences of varying length (11 different values)
function toPhrases(text){
	if(learnMode.checked){
		var reply = confirm("The contents of the main box will be replaced with encoded text which contains the original text as sentences of varying length. Cancel if this is not what you want.");
		if(!reply) return
	}
	var	phraseArray = makePhraseMatrix(coverText),
		punct = '.,;:!?',
		outArray = new Array(text.length);

	//now split the base64-encoded string into a base11 code to select sentence length, and a base6 code to select punctuation
	for(var i = 0; i < text.length; i++){
		var index = base64.indexOf(text[i]),
			phraseChoices = phraseArray[index % 11];
		outArray[i] = phraseChoices[Math.floor(Math.random()*phraseChoices.length)] + punct[Math.floor(index/11)] + ' '
	}
	var out = outArray.join('');
	out = out.replace(/[.!?][\s\n][a-z]/g,function(a){return a.toUpperCase();}).replace(/[,;:][\s\n][A-Z]/g,function(a){return a.toLowerCase();}).trim();  //capitalization
	out = out.charAt(0).toUpperCase() + out.slice(1);
	mainBox.textContent = out.trim();
	mainMsg.textContent = 'Message encoded as sentences of varying length'
}

//decodes text encoded as sentences of varying length
function fromPhrases(text){
	if(learnMode.checked){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(!reply) return
	}
	text = text.replace(/&nbsp;/g,'').replace(/\n/g,'');
	var	textArray = text.split(/[.,;:!?]/g).slice(0,-1),
		punctArray = text.match(/[.,;:!?]/g),
		punct = ".,;:!?",
		outArray = new Array(textArray.length);

	for(var i = 0; i < textArray.length; i++){
		var index11 = textArray[i].trim().length % 11,
			index6 = punct.indexOf(punctArray[i]);
		outArray[i] = base64[index6 * 11 + index11]
	}
	mainBox.textContent = outArray.join('').trim()
}

//Letters encoding is based on code at: http://www.irongeek.com/i.php?page=security/unicode-steganography-homoglyph-encoder, by Adrian Crenshaw, 2013
//first the object containing the Unicode character substitutions
var charMappings = {//Aa
					"a":"0", "a0":"a", "\u0430":"1", "a1":"\u0430",
					"A":"0", "A0":"A", "\u0391":"1", "A1":"\u0391",
					//Bb
					"B":"0", "B0":"B", "\u0392":"1", "B1":"\u0392",
					//Cc
					"c":"0", "c0":"c", "\u0441":"1", "c1":"\u0441",
					"C":"0", "C0":"C", "\u0421":"1", "C1":"\u0421",
					//Ee
					"e":"0", "e0":"e", "\u0435":"1", "e1":"\u0435",
					"E":"0", "E0":"E", "\u0415":"1", "E1":"\u0415",
					//Gg
					"g":"0", "g0":"g", "\u0261":"1", "g1":"\u0261",
					//Hh
					"H":"0", "H0":"H", "\u041D":"1", "H1":"\u041D",
					//Ii
					"i":"0", "i0":"i", "\u0456":"1", "i1":"\u0456",
					"I":"0", "I0":"I", "\u0406":"1", "I1":"\u0406",
					//Jj
					"j":"0", "j0":"j", "\u03F3":"1", "j1":"\u03F3",
					"J":"0", "J0":"J", "\u0408":"1", "J1":"\u0408",
					//Kk
					"K":"0", "K0":"K", "\u039A":"1", "K1":"\u039A",
					//Mm
					"M":"0", "M0":"M", "\u039C":"1", "M1":"\u039C",
					//Nn
					"N":"0", "N0":"N", "\u039D":"1", "N1":"\u039D",
					//Oo
					"o":"0", "o0":"o", "\u03BF":"1", "o1":"\u03BF",
					"O":"0", "O0":"O", "\u039F":"1", "O1":"\u039F",
					//Pp
					"p":"0", "p0":"p", "\u0440":"1", "p1":"\u0440",
					"P":"0", "P0":"P", "\u03A1":"1", "P1":"\u03A1",
					//Ss
					"s":"0", "s0":"s", "\u0455":"1", "s1":"\u0455",
					"S":"0", "S0":"S", "\u0405":"1", "S1":"\u0405",
					//Tt
					"T":"0", "T0":"T", "\u03A4":"1", "T1":"\u03A4",
					//Xx
					"x":"0", "x0":"x", "\u0445":"1", "x1":"\u0445",
					"X":"0", "X0":"X", "\u03A7":"1", "X1":"\u03A7",
					//Yy
					"y":"0", "y0":"y", "\u0443":"1", "y1":"\u0443",
					"Y":"0", "Y0":"Y", "\u03A5":"1", "Y1":"\u03A5",
					//Zz
					"Z":"0", "Z0":"Z", "\u0396":"1", "Z1":"\u0396",
					//Spaces
					" ":"000",
					" 000":" ",
					"\u2004":"001",
					" 001":"\u2004",
					"\u2005":"010",
					" 010":"\u2005",
					"\u2006":"011",
					" 011":"\u2006",
					"\u2008":"100",
					" 100":"\u2008",
					"\u2009":"101",
					" 101":"\u2009",
					"\u202f":"110",
					" 110":"\u202F",
					"\u205F":"111",
					" 111":"\u205F"
					};

//counts the number of encodable bits in the cover text
function encodableBits(cover){
	var bitcount = 0;
	for (var i = 0; i < cover.length; i++){
		if (charMappings[cover[i]] !== undefined){
			bitcount = bitcount + charMappings[cover[i]].length
		}
	}
	return bitcount
}

//encodes text as special letters and spaces in the cover text, which replace the original ones
function toLetters(text){
	if(learnMode.checked){
		var reply = confirm("The contents of the main box will be replaced with encoded text which contains the original text as formatted special characters and spaces. Cancel if this is not what you want.");
		if(!reply) return
	}
	var textBin = toBin(text).join(''),				//string containing 1's and 0's
		cover = coverText,
		capacity = encodableBits(cover);
	if (capacity < textBin.length){						//repeat the cover text if it's too short
		var turns = Math.ceil(textBin.length / capacity),
			index = 0;
		while (index < turns){
			cover += ' ' + coverText;
			index++
		}
		mainMsg.textContent = 'Message encoded into letters. Cover was repeated ' + turns + ' times.'
	}
	var finalString = "",
		bitsIndex = 0,
		i = 0,
		doneBits = '';
	while(doneBits.length < textBin.length){
		if (charMappings[cover[i]] === undefined){
			finalString = finalString + cover[i]
		}else{
			var tempBits = textBin.substring(bitsIndex,bitsIndex + charMappings[cover[i]].length);
			while(tempBits.length < charMappings[cover[i]].length){tempBits = tempBits + "0";} 			//Got to pad it out
			finalString += charMappings[cover[i] + tempBits];
			bitsIndex += charMappings[cover[i]].length;
			doneBits += tempBits
		}
		i++
	}
	mainBox.textContent = finalString + '.';								//period needed because there could be spaces at the end
	mainMsg.textContent = 'Message encoded into letters of this text.'
}

//gets the original text from Letters encoded text
function fromLetters(text){
	if(learnMode.checked){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(!reply) return
	}
	var bintemp = [],
		tempchar = "";
	for (var i = 0; i < text.length; i++){
		if (charMappings[text[i]] === undefined ){
		}else{
			tempchar = charMappings[text[i]];
			bintemp.push(tempchar)
		}
	}
	var binStr = bintemp.join(''),
		bin = new Array(binStr.length);
	for(var i = 0; i < binStr.length; i++) bin[i] = parseInt(binStr.charAt(i));
	mainBox.textContent = fromBin(bin.slice(0,bin.length-(bin.length % 6)))
}

//this one is to display the cover text or change it as requested
function newCover(string){
	coverText = addSpaces(string.replace(/[\n\s-]+/g,' '));		//newlines, dashes, and multiple spaces do weird things, so remove them
	mainMsg.textContent = 'Cover text changed'
}

//adds spaces that can be encoded if Chinese, Korean, or Japanese
function addSpaces(string){
	if (string.match(/[\u3400-\u9FBF]/) != null) string = string.split('').join(' ').replace(/\s+/g, ' ');
	return string
}
</script>

<!--image steganograghy-->
<script>
//this code is closely related to that available at https://github.com/fruiz500/passlok-stego

//clean up some junk possibly left by JPG hiding functions
	delete localStorage['action'];
	delete localStorage['container'];
	delete localStorage['method'];
	delete localStorage['wikisafe'];

// load image for hiding text and open dialog
var importImage = function(e) {
	if(learnMode.checked){
		var reply = confirm("An image stored in this device will replace the current image. Cancel if this is not what you want.");
		if(!reply) return
	}

    var reader = new FileReader();

    reader.onload = function(event) {
        // set the preview
        previewImg.style.display = 'block';
        previewImg.src = event.target.result
    }

    reader.readAsDataURL(e.target.files[0]);
	previewImg.onload = function(){
		//see if the password box can be pre-populated because there is only one recipient
		var lockArray = lockBox.innerHTML.replace(/\r\n/g,'<br>').replace(/<br>$/,'').replace(/<div>/g,'<br>').replace(/<\/div>/g,'').replace(/myself/,'').split('<br>').filter(Boolean);
		if(lockArray.length == 1){
			var lock = replaceByItem(lockArray[0]),
				locklen = lock.length;
			if(locklen == 43 || locklen == 50){					//Lock identified, compute shared Key
				if(!refreshKey()) return;
				if (locklen == 50) lock = changeBase(lock.toLowerCase().replace(/l/g,'L'), base36, base64, true);
				var lockBin = nacl.util.decodeBase64(lock);
				if(!lockBin) return false;
				imageBox.value = nacl.util.encodeBase64(makeShared(convertPub(lockBin),KeyDH)).replace(/=+$/,'')
			}else{													//not a Lock, so use it directly
				imageBox.value = lock
			}
		}else{
			imageBox.value = ''
		}
		
		updateCapacity();
		openClose('imageScr');
		openClose('shadow');
		imageBox.focus()
	}
};

//show how much text can be hidden in the image
function updateCapacity(){
	var	textsize = mainBox.textContent.length;

	imageMsg.style.color = '';
	blinkMsg(imageMsg);
	setTimeout(function(){																				//give it 2 seconds to complete
		if(imageMsg.textContent == 'PROCESSING') imageMsg.textContent = 'There was an error calculating the capacity, but the image is still usable'
	},2000)

setTimeout(function(){
	//start measuring png capacity. Subtract 4 bits used to encode k, 48 for the end marker
	var shadowCanvas = document.createElement('canvas'),
		shadowCtx = shadowCanvas.getContext('2d');
	shadowCanvas.style.display = 'none';

	shadowCanvas.width = previewImg.naturalWidth;
	shadowCanvas.height = previewImg.naturalHeight;
	shadowCtx.drawImage(previewImg, 0, 0, shadowCanvas.width, shadowCanvas.height);
	
	var imageData = shadowCtx.getImageData(0, 0, shadowCanvas.width, shadowCanvas.height),
		opaquePixels = 0;
	for(var i = 3; i < imageData.data.length; i += 4){				//look at alpha channel values
		if(imageData.data[i] == 255) opaquePixels++					//use pixels with full opacity only
	}
	var pngChars = Math.floor((opaquePixels * 3 - 270) / 6);

	//now measure jpeg capacity
	if(previewImg.src.slice(11,15) == 'jpeg' && !isiOS){					//true jpeg capacity calculation, gets stuck on iOS
		var lumaCoefficients = [],
			count = 0;
		jsSteg.getCoefficients(previewImg.src, function(coefficients){
			var subSampling = 1;
			for(var index = 1; index <= 3; index++){						//first luma, then chroma channels, index 0 is always empty
				lumaCoefficients = coefficients[index];
				if(lumaCoefficients){
					if(index != 1) subSampling = Math.floor(coefficients[1].length / lumaCoefficients.length);
	 	 			for (var i = 0; i < lumaCoefficients.length; i++) {
						for (var j = 0; j < 64; j++) {
							if(lumaCoefficients[i][j] != 0) count += subSampling		//if subsampled, multiply the count since it won't be upon re-encoding
   	 					}
					}
					if(index == 1) var firstCount = count
				}else{
					count += firstCount													//repeat count if the channel appears not to exist (bug in js-steg)
				}
			}
			var jpgChars = Math.floor((count - 270) / 6);			//base64 version, 4 bits used to encode k, 48 for the end marker, 218 buffer for second message

			imageMsg.textContent = 'This image can hide ' + pngChars + ' characters as PNG, ' + jpgChars + ' as JPG. The main box has ' + textsize + ' characters'
		})
	}else{															//no jpeg, so estimate capacity
		var jpgChars = Math.floor(pngChars / 20);		//base64 version

		imageMsg.textContent = 'This image can hide ' + pngChars + ' characters as PNG, at least ' + jpgChars + ' as JPG. The main box has ' + textsize + ' characters'
	}
},30)
}

//put text into image, which turns into PNG
function encodePNG(){
	if(learnMode.checked){
		var reply = confirm("The text in the main box will be encoded into this image as a PNG, which can then be copied and sent to others. Cancel if this is not what you want.");
		if(!reply) return
	}
	var text = mainBox.textContent.trim();
	if(text.match('==')) text = text.split('==')[1].replace(/[-\s]/g,'').replace(/<(.*?)>/gi,"");			//remove end tags, spaces, newlines, and dashes from Locks

	//bail out if this is not a PassLok string, etc.
	if(!text){
		imageMsg.textContent = 'There is nothing to hide';
		return
	}
	if(!isBase64(text.replace(/=/g,''))){
		imageMsg.textContent = 'The text contains illegal characters for a PassLok string';
		return
	}
	if(previewImg.src.length < 100){											//no image loaded
		imageMsg.textContent = 'Please load an image before clicking this button';
		return
	}
	
	imageMsg.style.color = '';
	blinkMsg(imageMsg);

	var resultURI = encodePNGprocess(text);																//this is the main process, in next functions

	previewImg.src = resultURI;													//put result into page so it can be saved
	previewImg.onload = function(){
		imageMsg.textContent = 'Item hidden in the image. Save it now.'
	}
}

var imgEOF = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
//this function does the PNG encoding as LSB in all channels except alpha, which is kept with original values
function encodePNGprocess(text){
	var shadowCanvas = document.createElement('canvas'),
		shadowCtx = shadowCanvas.getContext('2d');
	shadowCanvas.style.display = 'none';

	shadowCanvas.width = previewImg.naturalWidth;
	shadowCanvas.height = previewImg.naturalHeight;
	shadowCtx.drawImage(previewImg, 0, 0, shadowCanvas.width, shadowCanvas.height);
	
	var imageData = shadowCtx.getImageData(0, 0, shadowCanvas.width, shadowCanvas.height),			//get the image data
		indexBin = 0,
		length = imageData.data.length,
		alphaData = new Array(length / 4);

	allCoefficients = new Array(length / 4 * 3);				//global variable, initialized below
	
	//separate alpha channel
	var k = 0;														//counter for actual data used
	for(var i = 3; i < length; i += 4){
		alphaData[Math.floor(i / 4)] = imageData.data[i]				//contains the alpha channel data, which will be needed later
		if(imageData.data[i] == 255){
			for(var j = 0; j < 3; j++){
				allCoefficients[k] = imageData.data[i - 3 + j];		//use data for opaque pixels only
				k++
			}
		}
	}
	allCoefficients = allCoefficients.slice(0,k);			//cut off the space that wasn't used
	
	//now turn the base64 text into a binary array
	var msgBin = toBin(text).concat(imgEOF),							//also replace special characters with base64 and add 48-bit end marker
		pwdArray = imageBox.value.trim().replace(/\n/g,' ').split('|'),
		seed = nacl.util.encodeBase64(wiseHash(pwdArray[0].trim(), length.toString() + 'png'));
	if(pwdArray.length == 3){
		var pwd2 = pwdArray[1].trim(), 
			msgBin2 = toBin(LZString.compressToBase64(pwdArray[2].trim())).concat(imgEOF);						//for when there is a second message
	}

	shuffleCoefficients(seed,0);																					//scramble image data to unpredictable locations

	var lastIndex = encodeToCoefficients('png',msgBin,0);
	
	if(msgBin2){													//this is done only if there is a second message, to be added immediately after the main message
		msgBin2 = msgBin2.concat(imgEOF);

		var seed2 = nacl.util.encodeBase64(wiseHash(pwd2, lastIndex.toString() + 'png'));  			//using Wisehash rather than built-in
		
		shuffleCoefficients(seed2,lastIndex + 1);							//shuffle only beyond the last index used

		encodeToCoefficients('png', msgBin2, lastIndex + 1);
		
		unShuffleCoefficients(lastIndex + 1);
		lastIndex = 0
	}

	unShuffleCoefficients(0);																		//return image data to their right places

	//put result back into image
	k = 0;															//already defined as local
	for(var i = 3; i < length; i += 4){
		var alphaIndex = Math.floor(i / 4);
		if(alphaData[alphaIndex] == 255){
			for(var j = 0; j < 3; j++){
				imageData.data[i - 3 + j] = allCoefficients[k];					//RGB data
				k++
			}
		}
	}
	permutation = [];				//reset global variables
	permutation2 = [];
	allCoefficients = [];
	imageBox.value = '';

	shadowCtx.putImageData(imageData, 0, 0);								//put in canvas so the dataURL can be produced
	return shadowCanvas.toDataURL()
}

//extract text from image
function decodeImage(){
	if(isiOS){
		imageMsg.textContent = 'On iOS, you can do PNG hide only';
		return
	}
	if(learnMode.checked){
		var reply = confirm("The text hidden in this image, if any, will be extracted and placed in the previous box, replacing its contents. This does not yet work on mobile devices. Cancel if this is not what you want.");
		if(!reply) return
	}
	
	imageMsg.style.color = '';
	blinkMsg(imageMsg);
	
setTimeout(function(){
	if(previewImg.src.slice(11,15) == 'png;'){							//two cases: png and jpeg
		decodePNG()
	}else if(previewImg.src.slice(11,15) == 'jpeg'){
		decodeJPG()
	}
},30)						//long timeout because decoding may take a while
}

//decodes data stored in PNG image
function decodePNG(){
	var shadowCanvas = document.createElement('canvas'),
		shadowCtx = shadowCanvas.getContext('2d');
	shadowCanvas.style.display = 'none';

	shadowCanvas.width = previewImg.naturalWidth;
	shadowCanvas.height = previewImg.naturalHeight;
	shadowCtx.drawImage(previewImg, 0, 0, shadowCanvas.width, shadowCanvas.height);

	var imageData = shadowCtx.getImageData(0, 0, shadowCanvas.width, shadowCanvas.height),
		length = imageData.data.length;

	allCoefficients = new Array(length / 4 * 3);				//global variable
	
	//separate RGB data from alpha channel
	var k = 0;
	for(var i = 3; i < length; i += 4){
		if(imageData.data[i] == 255){										//use opaque pixels only
			for(var j = 0; j < 3; j++){
				allCoefficients[k] = imageData.data[i - 3 + j];
				k++
			}
		}
	}
	allCoefficients = allCoefficients.slice(0,k);

	var pwdArray = imageBox.value.trim().replace(/\n/g,' ').split('|'),
		seed = nacl.util.encodeBase64(wiseHash(pwdArray[0].trim(), length.toString() + 'png'));
	if(pwdArray.length == 2) var pwd2 = pwdArray[1].trim();										//for when there is a second message

	shuffleCoefficients(seed,0);																	//scramble image data to unpredictable locations

	var result = decodeFromCoefficients('png',0);

	if(pwd2){													//extract hidden message if a second password is supplied
		var seed2 = nacl.util.encodeBase64(wiseHash(pwd2, result[2].toString() + 'png'));	
		shuffleCoefficients(seed2,result[2] + 1);
		var result2 = decodeFromCoefficients('png',result[2] + 1)
	}
	
	permutation = [];
	permutation2 = [];
	allCoefficients = [];
	var text = fromBin(result[0]);
	mainBox.innerHTML = decryptSanitizer(text.trim());
	image2main();
	imageBox.value = '';
	updateButtons();
	if(advancedMode.checked) main2extra();
	if(result2){
		mainMsg.textContent = 'Hidden message: ' + LZString.decompressFromBase64(fromBin(result2[0]))
	}else{
		mainMsg.textContent = 'This is what was hidden in the image'
	}
}

//this function gets the jpeg coefficients (first luma, then chroma) and extracts the hidden material. Stops when the 48-bit endText code is found
var allCoefficients, permutation, permutation2;

var decodeJPG = function(){
	jsSteg.getCoefficients(previewImg.src, function(coefficients){
		var length = coefficients[1].length;
		if(coefficients[2].length != length){							//there's chrome subsampling, therefore it was not made by this process
			imageMsg.textContent = 'This image does not contain anything, or perhaps the password is wrong';		//actually, just the former
			return
		}

		var	rawLength = 3*length*64,
			rawCoefficients = new Array(rawLength);

		for(var index = 1; index <= 3; index++){									//linearize the coefficients matrix into rawCoefficients
			for (var i = 0; i < length; i++) {
				for (var j = 0; j < 64; j++) {
					rawCoefficients[index*length*64 + i*64 + j] = coefficients[index][i][j]
				}
			}
		}	
		allCoefficients = removeZeros(rawCoefficients);							//get rid of zeros

		var pwdArray = imageBox.value.trim().replace(/\n/g,' ').split('|'),
			seed = nacl.util.encodeBase64(wiseHash(pwdArray[0].trim(), allCoefficients.length.toString() + 'jpeg'));
		if(pwdArray.length == 2) var pwd2 = pwdArray[1].trim();						//for when there is a second message

		shuffleCoefficients(seed,0);															//scramble image data to unpredictable locations

		var result = decodeFromCoefficients('jpeg',0);
		
		if(pwd2){													//extract hidden message if a second password is supplied
			var seed2 = nacl.util.encodeBase64(wiseHash(pwd2, result[2].toString() + 'jpeg'));
			shuffleCoefficients(seed2,result[2] + 1);
			var result2 = decodeFromCoefficients('png',result[2] + 1)
		}
		
		var text = fromBin(result[0]);
		mainBox.innerHTML = decryptSanitizer(text.trim());
		image2main();
		permutation = [];
		permutation2 = [];
		allCoefficients = [];
		imageBox.value = '';
		updateButtons();
		if(advancedMode.checked) main2extra();
		if(result2){
			mainMsg.textContent = 'Hidden message: ' + LZString.decompressFromBase64(fromBin(result2[0]))
		}else{
			mainMsg.textContent = 'This is what was hidden in the image'
		}
	})
}

//function to encode mainBox as coefficients in a jpeg image. Most of the work is done by modifyCoefficients, below
var encodeJPG = function(){
	if(learnMode.checked){
		var reply = confirm("The text in the main box will be encoded into this image as a JPG, which can then be copied and sent to others. Cancel if this is not what you want.");
		if(!reply) return
	}
	var text = mainBox.textContent.trim();
	if(text.match('==')) text = text.split('==')[1].replace(/[-\s]/g,'').replace(/<(.*?)>/gi,"");

	//bail out if this is not a PassLok string, etc.
	if(!text){
		imageMsg.textContent = 'There is nothing to hide';
		return
	}
	if(!isBase64(text.replace(/=/g,''))){
		imageMsg.textContent = 'The text contains illegal characters for a PassLok string';
		return
	}
	if(previewImg.src.length < 100){											//no image loaded
		imageMsg.textContent = 'Please load an image before clicking this button';
		return
	}

	imageMsg.style.color = '';
	blinkMsg(imageMsg);
	
setTimeout(function(){																			//the rest after a 30 ms delay
	if(previewImg.src.slice(11,15).match(/gif;|png;/)) transparent2white();		//first remove transparency

	jsSteg.reEncodeWithModifications(previewImg.src, modifyCoefficients, function (resultURI) {
		previewImg.src = resultURI;
		previewImg.onload = function(){
			imageMsg.textContent = 'Item hidden in the image. Save it now.'
		}
  	})
},30)						//end of timeout
}

/**
 * Called when encoding a JPEG
 * - coefficients: coefficients[0] is an array of luminosity blocks, coefficients[1] and
 *   coefficients[2] are arrays of chrominance blocks. Each block has 64 "modes"
 */
var modifyCoefficients = function(coefficients) {
	var text = mainBox.textContent.trim();
	if(text.match('==')) text = text.split('==')[1].replace(/[-\s]/g,'').replace(/<(.*?)>/gi,"");
	var msgBin = toBin(text).concat(imgEOF);			//also replace special characters with base64 and add 48-bit end marker
		
	var length = coefficients[0].length,
		rawLength = 3*length*64,
		rawCoefficients = new Array(rawLength);

	for(var index = 0; index < 3; index++){									//linearize the coefficients matrix into rawCoefficients
		for (var i = 0; i < length; i++) {
			for (var j = 0; j < 64; j++) {
				rawCoefficients[index*length*64 + i*64 + j] = coefficients[index][i][j]
			}
		}
	}
	allCoefficients = removeZeros(rawCoefficients);							//remove zeros and store in global variable

	var pwdArray = imageBox.value.trim().replace(/\n/g,' ').split('|'),
		seed = nacl.util.encodeBase64(wiseHash(pwdArray[0].trim(), allCoefficients.length.toString() + 'jpeg'));
	if(pwdArray.length == 3){
		var pwd2 = pwdArray[1].trim(), 
			msgBin2 = toBin(LZString.compressToBase64(pwdArray[2].trim())).concat(imgEOF);						//for when there is a second message
	}

	shuffleCoefficients(seed,0);										//scramble image data to unpredictable locations
	
	var lastIndex = encodeToCoefficients('jpeg', msgBin, 0);						//encoding step
	
	if(msgBin2){													//this is done only if there is a second message, to be added immediately after the main message
		var seed2 = nacl.util.encodeBase64(wiseHash(pwd2, lastIndex.toString() + 'jpeg'));
		
		shuffleCoefficients(seed2,lastIndex + 1);							//shuffle only beyond the last index used

		encodeToCoefficients('jpeg', msgBin2, lastIndex + 1);
		
		unShuffleCoefficients(lastIndex + 1);
		lastIndex = 0
	}

	unShuffleCoefficients(0);							//get the coefficients back to their original places
	
	var j = 0;													//put the zeros back in their places
	for(var i = 0; i < rawLength; i++){
		if(rawCoefficients[i]){									//only non-zeros
			rawCoefficients[i] = allCoefficients[j];
			j++
		}
	}

	for(var index = 0; index < 3; index++){					//reshape coefficient array back to original form
		for (var i = 0; i < length; i++) {
			for (var j = 0; j < 64; j++) {
				coefficients[index][i][j] = rawCoefficients[index*length*64 + i*64 + j]
			}
		}
	}
	permutation = [];
	permutation2 = [];
	allCoefficients = [];
	imageBox.value = ''
}

//calculates a random-walk permutation, as seeded by "seed" and shuffles the global array "allCoefficients" accordingly. "permutation" is also global
function shuffleCoefficients(seed,startIndex){
	isaac.seed(seed);		//re-seed the PRNG

	var	length = allCoefficients.length,
		permutedCoeffs = new Array(length);

	if(!startIndex){
		permutation = randPerm(length)		//pseudo-random but repeatable array containing values 0 to length-1
	}else{
		permutation2 = randPerm(length - startIndex)		//the PRNG should be re-initialized before this operation
	}

	if(!startIndex){
		for(var i = 0; i < length; i++){
			permutedCoeffs[i] = allCoefficients[permutation[i]]
		}
		for(var i = 0; i < length; i++){
			allCoefficients[i] = permutedCoeffs[i]
		}
	}else{
		for(var i = 0; i < length - startIndex; i++){
			permutedCoeffs[i] = allCoefficients[startIndex + permutation2[i]]
		}
		for(var i = 0; i < length - startIndex; i++){
			allCoefficients[startIndex + i] = permutedCoeffs[i]
		}
	}
}

//inverse of the previous function, assumes the data and permutation arrays are stored in global variables allCoefficients and permutation
function unShuffleCoefficients(startIndex){
	var	length = allCoefficients.length,
		permutedCoeffs = new Array(length),
		index;
	if(!startIndex){var inversePermutation = new Array(length)}else{var inversePermutation2 = new Array(length - startIndex)};

	if(!startIndex){
		for(var i = 0; i < length; i++){		//first make the inverse permutation array
			index = permutation[i];
			inversePermutation[index] = i
		}
	}else{
		for(var i = 0; i < length - startIndex; i++){	
			index = permutation2[i];
			inversePermutation2[index] = i
		}		
	}
	if(!startIndex){
		for(var i = 0; i < length; i++){
			permutedCoeffs[i] = allCoefficients[inversePermutation[i]]
		}
		for(var i = 0; i < length; i++){
			allCoefficients[i] = permutedCoeffs[i]
		}
	}else{
		for(var i = 0; i < length - startIndex; i++){
			permutedCoeffs[i] = allCoefficients[startIndex + inversePermutation2[i]]
		}
		for(var i = 0; i < length - startIndex; i++){
			allCoefficients[startIndex + i] = permutedCoeffs[i]
		}
	}
}

//obtain a random permutation using isaac re-seedable PRNG, for use in image steganography
function randPerm(n) {
  var result = new Array(n);
  result[0] = 0;

  for(var i = 1; i < n; ++i) {
    var idx = (isaac.random() * (i + 1)) | 0			//here is the call to the isaac PRNG library
    if(idx < i) {
      result[i] = result[idx]
    }
    result[idx] = i
  }
  return result
}

//convert binary array to decimal number
function binArray2dec(array){
	var length = array.length,
		output = 0,
		mult = 1;
	
	for(var i = 0; i < length; i++){
		output += array[length-1-i]*mult;
		mult = mult*2
	}
	return output
}

//to get the parity of a number. Positive: 0 if even, 1 if odd. Negative: 0 if odd, 1 if even. 0 is even
function stegParity(number){
	if(number >= 0){
		return number % 2
	}else{
		return -(number - 1) % 2
	}
}

//faster Boolean filter for array
function removeZeros(array){
	var length = array.length,
		nonZeros = 0;
	for(var i = 0; i < length; i++) if(array[i]) nonZeros++;
	
	var outArray = new Array(nonZeros),
		j = 0;
	
	for(var i = 0; i < length; i++){
		if(array[i]){
			outArray[j] = array[i];
			j++
		}		
	}
	return outArray
}

//gets counts in the DCT AC histogram: 2's plus -2, 3's plus -3, outputs array containing the counts
function partialHistogram(array){
	var output = [0,0],
		length = array.length;
	
	for(var j = 0; j < length; j++){
		for(var i = 2; i <= 3; i++){
			if(array[j] == i || array[j] == -i) output[i-2]++
		}
	}
	return output
}

//matrix encoding of allCoefficients with variable k, which is prepended to the message. Selectable for png or jpeg encoding.
function encodeToCoefficients(type,inputBin,startIndex){
	//first decide what value to use for k
	var length = (startIndex == 0) ? allCoefficients.length - 222 : allCoefficients.length - startIndex - 4,	//extra slack the first time to have room for a hidden message
		rate = inputBin.length / length,				//necessary embedding rate
		k = 2;
	if(inputBin.length > length){
		imageMsg.textContent='This image can hide ' + (Math.floor(length/6) - 8).toString() + ' characters. But the main box has ' + (Math.floor(inputBin.length/6) - 8).toString() + ' characters';
		allCoefficients = [];
		permutation = [];
		permutation2 = [];
		imageBox.value = '';
		return
	}
	while( k / (Math.pow(2,k) - 1) > rate) k++;
	k--;
	if(k > 16) k = 16;											//so it fits in 4 bits at the start
	var kCode = new Array(4);									//k in 4-bit binary form
	for(var j = 0; j < 4; j++) kCode[3-j] = (k-1 >> j) & 1;	//actually, encode k-1 (0 to 15)
	if(type == 'jpeg'){
		var count2to3 = partialHistogram(allCoefficients.slice(startIndex + 4)),		//calculate histogram-adjusting frequencies
			y = count2to3[1]/(count2to3[0] + count2to3[1]),
			ones = 0,															//surplus 1's and -1's
			minusones = 0;
	}

	//now encode k into allCoefficients
	if(type == 'jpeg'){												//jpeg embedding
		for(var i = 0; i < 4; i++){
			if(allCoefficients[startIndex + i] > 0){									//positive same as for png
				if(kCode[i] == 1 && stegParity(allCoefficients[startIndex + i]) == 0){			//even made odd by going down one
					allCoefficients[startIndex + i]--
				}else if(kCode[i] == 0 && stegParity(allCoefficients[startIndex + i]) != 0){		//odd made even by going down one, except if the value was 1, which is taken to -1
					if(allCoefficients[startIndex + i] != 1){ allCoefficients[startIndex + i]-- }else{ allCoefficients[startIndex + i] = -1}
				}
			}else{														//negative coefficients are encoded in reverse
				if(kCode[i] == 0 && stegParity(allCoefficients[startIndex + i]) != 0){		//"odd" made even by going up one
					allCoefficients[startIndex + i]++
				}else if(kCode[i] == 1 && stegParity(allCoefficients[startIndex + i]) == 0){			//"even" made odd by going up one, except if the value was -1, which is taken to 1
					if(allCoefficients[startIndex + i] != -1){ allCoefficients[startIndex + i]++ }else{ allCoefficients[startIndex + i] = 1}
				}
			}
		}
	}else{																//png embedding
		for(var i = 0; i < 4; i++){
			if(kCode[i] == 1 && stegParity(allCoefficients[startIndex + i]) == 0){					//even made odd by going up one
				allCoefficients[startIndex + i]++
			}else if(kCode[i] == 0 && stegParity(allCoefficients[startIndex + i]) != 0){				//odd made even by going down one
				allCoefficients[startIndex + i]--
			}
		}
	}	
	
	//encode the actual data
	var n = Math.pow(2,k) - 1,
		blocks = Math.ceil(inputBin.length / k);		//number of blocks that will be used
	
	var parityBlock = new Array(n),
		inputBlock = new Array(k),
		coverBlock = new Array(n),
		hash, inputNumber, outputNumber;						//decimal numbers
	while(inputBin.length % k) inputBin.push(0);				//pad msg with zeros so its length is a multiple of k

	for(var i = 0; i < blocks; i++){
		inputBlock = inputBin.slice(i*k, (i*k)+k);
		inputNumber = binArray2dec(inputBlock);						//convert the binary block to decimal
		coverBlock = allCoefficients.slice(startIndex + 4+i*n, startIndex + 4+(i*n)+n);		//first 4 were for encoding k
		for(var j = 0; j < n; j++) parityBlock[j] = stegParity(coverBlock[j]);		//get parity digit for each number
		
		hash = 0;
		for(var j = 1; j <= n; j++) hash = hash ^ (parityBlock[j-1]*j);		//hash-making step, as in F5, notice the xor operation
		outputNumber = inputNumber ^ hash;							//position in the cover block that needs to be flipped, if the position is 0 change none
		
		if(outputNumber){												//no change if the result is zero, but increment the counter anyway
			if(type == 'jpeg'){										//jpeg embedding
				if(coverBlock[outputNumber-1] > 0){			//positive, so change by going down (normally); if 1 or -1, switch to the other
					if(coverBlock[outputNumber-1] == 1){		//whether to go up or down determined by whether there are too few or too many 1's and -1's
						if(minusones <= 0){allCoefficients[startIndex + 3+i*n+outputNumber] = -1; ones--; minusones++}else{allCoefficients[startIndex + 3+i*n+outputNumber] = 2; ones--}
					}else if(coverBlock[outputNumber-1] == 2){
						if(ones <= 0){allCoefficients[startIndex + 3+i*n+outputNumber]--; ones++}else{allCoefficients[startIndex + 3+i*n+outputNumber]++}
					}else{
						if(Math.random() > y){allCoefficients[startIndex + 3+i*n+outputNumber]--}else{allCoefficients[startIndex + 3+i*n+outputNumber]++}
					}
				}else if(coverBlock[outputNumber-1] < 0){	//negative, so change by going up
					if(coverBlock[outputNumber-1] == -1){
						if(ones <= 0){allCoefficients[startIndex + 3+i*n+outputNumber] = 1; minusones--; ones++}else{allCoefficients[startIndex + 3+i*n+outputNumber] = -2; minusones--}
					}else if(coverBlock[outputNumber-1] == -2){
						if(minusones <= 0){allCoefficients[startIndex + 3+i*n+outputNumber]++; minusones++}else{allCoefficients[startIndex + 3+i*n+outputNumber]--}
					}else{
						if(Math.random() > y){allCoefficients[startIndex + 3+i*n+outputNumber]++}else{allCoefficients[startIndex + 3+i*n+outputNumber]--}
					}
				}													//if the coefficient was a zero, there is no change and the counter does not advance, so we repeat			
			}else{														//png embedding
				if(coverBlock[outputNumber-1] % 2){					//odd made even by going down one
					allCoefficients[startIndex + 3+i*n+outputNumber]--
				}else{													//even made odd by going up one
					allCoefficients[startIndex + 3+i*n+outputNumber]++
				}
			}
		}
	}
	return startIndex + blocks * n + 3						//last index involved in the encoding
}

//matrix decode of allCoefficients, where k is extracted from the start of the message. Selectable for png or jpeg encoding.
function decodeFromCoefficients(type,startIndex){
	//first extract k
	var	length = (startIndex == 0) ? allCoefficients.length - 222 : allCoefficients.length - startIndex - 4,		//extra slack the first time
		kCode = new Array(4);										//contains k in 4-bit format
	for(var i = 0; i < 4; i++) kCode[i] = stegParity(allCoefficients[startIndex + i]);			//output is 1's and 0's
	var k = binArray2dec(kCode) + 1;
	
	//now decode the data
	var n = Math.pow(2,k) - 1,
		blocks = Math.floor(length / n);
	if(blocks == 0){										//cover does not contain even one block
		imageMsg.textContent = 'This image does not contain anything, or perhaps the password is wrong';
		allCoefficients = [];
		permutation = [];
		permutation2 = [];
		imageBox.value = '';
		return
	}
	
	var parityBlock = new Array(n),
		coverBlock = new Array(n),
		outputBin = new Array(k*blocks),
		hash;

	for(var i = 0; i < blocks; i++){
		coverBlock = allCoefficients.slice(startIndex + 4+i*n, startIndex + 4+(i*n)+n);
		for(var j = 0; j < n; j++) parityBlock[j] = stegParity(coverBlock[j]);		//0 if even, 1 if odd (reverse if negative, as in F5)
		
		hash = 0;
		for(var j = 1; j <= n; j++) hash = hash ^ (parityBlock[j-1]*j);		//hash-making step, as in F5, notice the xor operation
		for(var j = 0; j < k; j++) outputBin[i*k + k-1-j] = (hash >> j) & 1		//converts number to binary array and adds to output
	}

	var found = false,									//find the end marker after all the embedded bits are extracted, rather than after every block. This ends up being faster
		outLength = outputBin.length;
	for(var j = 0; j < outLength - 47; j++){
		found = true
		for(var l = 0; l < 48; l++){
			found = found && (imgEOF[47-l] == outputBin[outLength-l-j])
		}
		if(found){var fromEnd = j+47; break}
	}		
	if(!found){
		imageMsg.textContent = 'The image does not contain anything, or perhaps the password is wrong';
		allCoefficients = [];
		permutation = [];
		imageBox.value = '';
		return
	}
	outputBin = outputBin.slice(0,-fromEnd);
	var blocksUsed = Math.ceil((outputBin.length + 48) / k);
	return [outputBin,'Reveal successful',startIndex + blocksUsed * n + 3]								//clean up the end
}

//gets the histogram of an array, in this format: 0, 1, -1, 2, -2, ..., n, -n. Inputs are the array and n, output is the histogram. For testing purposes.
function getHistogram(array, n){
	var output = new Array(2*n + 2),
		length = array.length,
		counter1 = 0,
		counter2 = 0;
	
	for(var i = 0; i <= n; i++){
		counter1 = counter2 = 0;
		for(var j = 0; j < length; j++){
			if(array[j] == i) counter1++;
			if(array[j] == -i) counter2++
		}
		output[2*i] = counter1;
		output[2*i+1] = counter2
	}
	return output.slice(1)
}

//remove transparency and turn background white
function transparent2white(){
	var shadowCanvas = document.createElement('canvas'),
		shadowCtx = shadowCanvas.getContext('2d');
	shadowCanvas.style.display = 'none';

	shadowCanvas.width = previewImg.naturalWidth;
	shadowCanvas.height = previewImg.naturalHeight;
	shadowCtx.drawImage(previewImg, 0, 0, shadowCanvas.width, shadowCanvas.height);
	
	var imageData = shadowCtx.getImageData(0, 0, shadowCanvas.width, shadowCanvas.height),
		opaquePixels = 0;
	for(var i = 3; i < imageData.data.length; i += 4){				//look at alpha channel values
		if(imageData.data[i] == 0){
			for(var j = 0; j < 4; j++) imageData.data[i-j] = 255		//turn pure transparent to white
		}else{
			imageData.data[i] = 255									//if not pure transparent, turn opaque without changing color
		}
	}
	shadowCtx.putImageData(imageData, 0, 0);								//put in canvas so the dataURL can be produced
	previewImg.src = shadowCanvas.toDataURL()							//send to image element	
}
</script>

<!--local Directory functions-->
<script>
//detect if Lock pasted in Lock box and offer to save it
function pasteLock(){
	setTimeout(function(){
	lockMsg.textContent = '';
	var text = lockBox.innerHTML.replace(/<br>/gi,'\n').replace(/\<(?!\/?a).*?\>/gi,'').trim().replace(/\n/g,'<br>').replace(/&nbsp;/gi,' ').replace(/<br>$/i,''),	//clean preserving anchors
		strings = text.split('<br>');
	var lastline = strings[strings.length-1];
	if (lastline.slice(0,4) != 'http'){
		var lock = lastline
	}else{
		var lock = strings[strings.length-2]									//in case there is a video URL as last line
	}
	var lockstripped = lock.replace(/-/g,'').split("==").sort(function (a, b) { return b.length - a.length; })[0];		//remove tags

	suspendFindLock = true;															//allow writing a name without searching

	if (lockstripped.replace(/\s/g,'').length == 43 || lockstripped.replace(/\s/g,'').length == 50 || lockstripped.trim().split(/[ _]/).length == 20){
		lockMsg.textContent = 'Lock detected';
		lockBox.textContent = lockstripped;
		extractLock(lockstripped)
	}
	},0)
}

//get name and Lock from form and merge them with the locDir object, then store
function addLock(fromMain){
	if(!fullAccess){
		lockMsg.textContent = 'Save not available in Guest mode\r\nPlease restart PassLok';
		return
	}
	if(learnMode.checked){
		var reply = confirm("The item in the box will be added to the permanent directory. Cancel if this is not what you want.");
		if(!reply) return
	}
	callKey = 'addlock';
	var	lock = lockBox.innerHTML.replace(/\n/g,'<br>').replace(/<br>$/i,"").trim().replace(/<div>/gi,'<br>').replace(/<\/div>/gi,'').trim(),
		lockarray = lock.split('<br>'),
		isList = (lockarray.length > 1 && lockarray[1].slice(0,4) != 'http' && lock.length <= 500);			//identify List
		
	if (lock == ''){																//if box is empty, put a random string there
		if(!locDir['myself'] || BasicButtons) return;									//don't do it in Basic mode
		lock = nacl.util.encodeBase64(nacl.randomBytes(31)).replace(/=+$/,'');			//a little shorter so it's distinct from  a Lock
		lockBox.textContent = lock;
		addLockBtn.textContent = "Save";
		return

	}else{																			//if populated, encrypt if not a Lock, then prompt for a name and save
		var locklength = stripTags(lockarray[0]).length;
		if((locklength == 43 || locklength == 50) && lockarray.length == 1){
			var lockcrypt = lock													//store Locks unencrypted, everything else encrypted by the Key
		}else if(lockarray[0].trim().split(/[ _]/).length == 20){				//word Lock case
			var lockcrypt = changeBase(lock, wordListExp, base64, true);
			if(!lockcrypt) return;
			lockBox.textContent = lockcrypt
		}else{
			if (lock.length > 500) lock = LZString.compressToBase64(lock).replace(/=/g,'');			//cover texts are compressed
			var	lockcrypt = keyEncrypt(lock);
			if(!lockcrypt) {lockMsg.textContent = "Storage failed"; return}
		}
		if(fromMain){
			var name = prompt("Looks like you got someone's new Lock. If you give it a name in the box below, it will be saved to your local directory. If you use a name that is already in the directory, the new Lock will replace the old one.")
		}else{
			var name = prompt("What name do you want to give to this item?");
		}
		if(!name){callKey = '';lockBox.textContent = '';return};
		if(isList) name = '--' + name + '--';										//dashes bracket name for Lists
		var newEntry = JSON.parse('{"' + name + '":["' + lockcrypt + '"]}');
		locDir = sortObject(mergeObjects(locDir,newEntry));
		localStorage[userName] = JSON.stringify(locDir);
		lockNames = Object.keys(locDir);
		window.setTimeout(function(){											//this needs to be on a timer for iOS
			if(stripTags(lock).length == 43 || stripTags(lock).length == 50){
				lockMsg.textContent = 'Lock saved to local directory with name: ' + name
			}else if(isList){
				lockMsg.textContent = 'List saved to local directory with name: ' + name
			}else{
				lockMsg.textContent = 'Item saved to local directory with name: ' + name
			};
		}, 100)
		fillList();

			if(ChromeSyncOn && chromeSyncMode.checked){													//if Chrome sync is available, add to sync storage
				syncChromeLock(name,JSON.stringify(locDir[name]))
			}

		suspendFindLock = false;
		callKey = ''
	}
}

//delete a particular key in Object locDir, then store
function removeLock(){
	if(!fullAccess){
		lockMsg.textContent = 'Delete not available in Guest mode\r\nPlease restart PassLok';
		return
	}
	var	name = lockBox.textContent.trim(),
		index = searchStringInArrayDB(name,lockNames);
	if( index >= 0){
		var fullName = lockNames[index];
		if (fullName == 'myself'){
			lockMsg.textContent = 'There is a button to reset your options in the Options tab';
			return
		}
		var reply = confirm("The item displayed in the box will be removed from the permanent directory. This is irreversible. Cancel if this is not what you want.");
		if(!reply) return;
		delete locDir[fullName];
		localStorage[userName] = JSON.stringify(locDir);
		lockNames = Object.keys(locDir);
		window.setTimeout(function(){										//this needs to be on a timer for iOS
			lockMsg.textContent = fullName + ' deleted';
			lockBox.textContent = ''
		}, 100);
		fillList();

			if(ChromeSyncOn && chromeSyncMode.checked){						//if Chrome sync is available, remove from sync storage
				if(confirm('Item removed from local storage. Do you want to remove it also from sync storage?')) remChromeLock(fullName)
			}

		suspendFindLock = false
	}else{
		lockMsg.textContent = 'To delete an item, first type its name in the box until it is recognized';
	}
}

//this is to just delete the Read-once data for a particular key
function resetPFS(){
	if(!fullAccess){
		lockMsg.textContent = 'Reset not available in Guest mode. Please restart PassLok';
		return
	}

	var reply = confirm("The data needed to maintain a Read-once conversation with this person will be deleted. This is irreversible. Cancel if this is not what you want.");
	if(!reply) return;

	var name = lockMsg.textContent;
	name = name.slice(0,9) == 'Directory' ? name.slice(32) : name;			//take just the end of the displayed name
	if (locDir[name] == null){
		lockMsg.textContent = 'The item to be reset must be displayed first';
		return
	}
	if (name == 'myself'){
		lockMsg.textContent = 'There is a button to reset your options in the Options tab';
		return
	}
	if ((locDir[name][1] == null) && (locDir[name][2] == null)){
		lockMsg.textContent = 'Nothing to reset';
		return
	}
	locDir[name][1] = locDir[name][2] = null;
	locDir[name][3] = 'reset';
	localStorage[userName] = JSON.stringify(locDir);

		if(ChromeSyncOn && chromeSyncMode.checked){							//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(locDir[name]))
		}

	lockMsg.textContent = 'Read-once data for ' + name + " deleted. The next message to this user won't have forward secrecy.";
	suspendFindLock = false
}

var suspendFindLock = false							//when true, user can input a name without deleting the Lock box

//searches for name in Locks database and returns the Lock, displays full name as well. Invoked as the user types
function findLock(){
	lockMsg.textContent = '';
	var string = removeHTMLtags(lockBox.textContent.trim()),
		stringstrip = stripTags(string),
		index = searchStringInArrayDB(string,lockNames);
	if (index >= 0){
		var name = lockNames[index];
		lockMsg.textContent = "Directory item found with name: " + name
	}else{
		lockMsg.textContent = ''
	}
}

//decrypts the contents of the Locks Box
function decryptLock(){
	callKey = 'decryptlock';
	var lockStr = lockBox.textContent.trim(),
		firstchar = lockStr.slice(0,1);
	if(firstchar == 'k' && lockStr.length == 92) {
		nameBeingUnlocked = lockMsg.textContent;
		decryptItem();
		nameBeingUnlocked = ''
	}
	if(lockBox.textContent.trim()){
		var listArray = lockBox.innerHTML.replace(/\n/g,'<br>').split('<br>').filter(Boolean);
		if(lockBox.textContent.length > 500){
			lockBox.innerHTML = decryptSanitizer(LZString.decompressFromBase64(lockBox.textContent).trim());
			newCover(lockBox.textContent.trim());							//this for loading cover text from Lock screen
			lockMsg.textContent = 'New Cover text extracted and ready to use'
		} else if(listArray.length > 1 && listArray[1].slice(0,4) != 'http'){
			lockMsg.textContent = 'List extracted'
		} else if(stripTags(lockBox.textContent).length == 43 || stripTags(lockBox.textContent).length == 50){
			lockMsg.textContent = 'Lock extracted'
		} else if(lockBox.textContent.trim().length == 42){
			lockMsg.textContent = 'Random Key extracted'
		} else if(lockMsg.textContent.trim() == 'myself'){
			lockMsg.textContent = 'Email/token extracted'
		} else {
			lockMsg.textContent = 'Shared Key extracted'
		}
	}
	if(lockScr.style.display != 'block') main2lock();
	callKey = ''
}

//automatically decrypts an item stored encrypted in the locDir database. It uses the permanent Key
function decryptItem(){
	if(callKey != 'decryptlock') callKey = 'decryptitem';
	if(!refreshKey()) return;
	var	string = lockBox.textContent.trim();
	if(string == "") return;
	lockBox.innerHTML = decryptSanitizer(keyDecrypt(string));
	if(!lockBox.innerHTML) return;
	if(callKey != 'decryptlock') callKey = ''
}

//add a few spaces and newlines, then remove brackets, etc., extra spaces, put in alphabetical order
function showLockDB(){
	if(learnMode.checked){
		var reply = confirm("The complete directory of Locks, shared Keys, etc. stored under the current user name will be displayed. Cancel if this is not what you want.");
		if(!reply) return
	}
	if(localStorage[userName] != "{}"){
		lockBox.textContent = JSON.stringify(locDir,null,4).replace(/": \[\n/g,':\n').replace(/\],/g,'').replace(/[{}"\] ,]/g,'').trim()
		lockMsg.textContent = 'These are the items stored under the current user name'
	}else{
		lockMsg.textContent = 'There are no stored items'
	}
	suspendFindLock = false
}

//as above, but just the 'myself' entry
function showMyself(){
	if(locDir['myself']){
		var alphalocDir = locDir['myself'];
		mainBox.textContent = 'myself:\r\n' + JSON.stringify(alphalocDir,null,4).replace(/[{}"\[\]]/g,'').trim();
		mainMsg.textContent = 'These are your stored settings'
	}else{
		mainMsg.textContent = 'No settings to store'
	}
	suspendFindLock = false
}

//reconstruct the original JSON string from the newlines and spaces as displayed by showLockDB
function mergeLockDB(){
	callKey = 'mergedb';
	var	lockstr = lockBox.innerHTML.replace(/\n/g,'<br>').replace(/<br>$/,"").trim(),		//see if these are Locks for a possible DH merge, which is not the main function of this button
		mainstr = mainBox.textContent.trim();
	if (lockstr == ''){
		lockMsg.textContent = 'Nothing to merge';
		return
	}
	if (lockstr.slice(0,1) == 'k') {
		lockstr = keyDecrypt(lockstr);
		if(!lockstr) return
	}
	var lockstr2 = stripTags(lockstr),
		mainstr2 = stripTags(mainstr),
		locklen = lockstr2.length,
		mainlen = mainstr2.length;

	if(lockstr.split('<br>').length > 1){			//the real database merge implies multiline
		if(learnMode.checked){
			var reply = confirm("The items in the box will be merged into the permanent directory, replacing existing items of the same name. This is irreversible. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(!fullAccess){
			if(lockScr.style.display == 'block'){
				lockMsg.textContent = 'Merge not available in Guest mode\r\nPlease restart PassLok'
			}else{
				mainMsg.textContent = 'Settings update not available in Guest mode\nPlease restart PassLok'
			}
			return
		}
		var newDB = JSON.parse('{"' + lockstr.replace(/<br><br>/g,'"],"').replace(/:<br>/g,'":["').replace(/<br>/g,'","') + '"]}');
		newDB = realNulls(newDB);
		locDir = sortObject(mergeObjects(locDir,newDB));
		localStorage[userName] = JSON.stringify(locDir);
		lockNames = Object.keys(locDir);

		if(ChromeSyncOn && chromeSyncMode.checked){
			for(var name in locDir){								//if Chrome sync is available, put all this in sync storage
				syncChromeLock(name,JSON.stringify(locDir[name]))
			}
		}

		var email = keyDecrypt(locDir['myself'][0]);				//populate email and recalculate Keys and Locks
		if(email){myEmail = email}else{return}
		if(!refreshKey()) return;
		KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(KeyStr,email)).secretKey;
		KeyDH = ed2curve.convertSecretKey(KeySgn);
		myLock = nacl.sign.keyPair.fromSecretKey(KeySgn).publicKey;
		myLockStr = nacl.util.encodeBase64(myLock).replace(/=+$/,'');
		myezLock = changeBase(myLockStr, base64, base36, true);

		fillList();
		var reply = prompt("The items have been merged into the local directory. It might be a good idea to change the user name at this point. To do so, enter the new user name and click OK. Otherwise Cancel.");
		if(reply){
			userNameBox.value = reply;
			changeName()
		}
		lockMsg.textContent = 'Items merged into the local directory'

	}else if(locklen == 43 && (mainlen == 43 || mainlen == 50)){	 //merging of a DH Key in the directory box and a DH Lock in main
		if(learnMode.checked){
			var reply = confirm("The Key in the directory box will be combined with the Lock in the main box, and the resulting Lock will replace both. Cancel if this is not what you want.");
			if(!reply) return
		}
		if (mainlen == 50) mainstr2 = changeBase(mainstr2.toLowerCase().replace(/l/g,'L'), base36, base64, true);
		var mainBin2 = nacl.util.decodeBase64(mainstr2),
			lockBin2 = nacl.util.decodeBase64(lockstr2);
		if(!mainBin2 || !lockBin2) return false;
		var merged = nacl.util.encodeBase64(makeShared(mainBin2,lockBin2)).replace(/=+$/,'');
		mainBox.textContent = merged;
		lockBox.textContent = merged;
		lockMsg.textContent = 'Key merged with Lock, in main box';
		return

	}else if(locklen == 43 || locklen == 50){	                    //merging of a Lock in the directory box the user Key in order to get their shared Key
		if(learnMode.checked){
			var reply = confirm("The Lock in the directory box will be combined with your Key, and the resulting shared Key will replace both. Cancel if this is not what you want.");
			if(!reply) return
		}
		if(!refreshKey()) return;
		if (locklen == 50) lockstr2 = changeBase(lockstr2.toLowerCase().replace(/l/g,'L'), base36, base64, true);
		var lockBin2 = nacl.util.decodeBase64(lockstr2);
		if(!lockBin2) return false;
		var merged = nacl.util.encodeBase64(makeShared(convertPub(lockBin2),KeyDH)).replace(/=+$/,'');
		lockBox.textContent = merged;
		imageBox.value = merged;										//for image hiding
		lockMsg.textContent = 'The Lock has been merged with your Key and turned into this shared Key. Also copied as image Password';
		return

	}else{
		lockMsg.textContent = 'The items to be merged must be 256-bit and in base64 (or base36 for Locks)';
		return
	}
	suspendFindLock = false;
	callKey = ''
}

//convert literal "null" entries to real nulls
function realNulls(object){
	for(var name in object){
		for(var i = 0; i < object[name].length; i++){
			if(object[name][i] == "null") object[name][i] = null
		}
	}
	return object
}

//makes encrypted backup of the whole DB, then if allowed clears locDir object, then stores
function moveLockDB(){
	if(!fullAccess){
		optionMsg.textContent = 'Move not allowed in Guest mode\nPlease restart PassLok';
		return
	}
	callKey = 'movedb';
	if(!refreshKey()) return;

	//first encrypt locDir, as displayed by showLockDB
	showLockDB();
	var datacrypt = keyEncrypt(lockBox.innerHTML.replace(/\n/g,'<br>').replace(/\r/g,'').replace(/<br>$/,"").trim());
	if(!datacrypt) return;
	mainBox.textContent = 'PL24dir==' + datacrypt + '==PL24dir';
	optionMsg.textContent = 'Database in Main tab';
	mainMsg.textContent = 'The item in the box contains your directory. To restore it, click Decrypt';
	setTimeout(function(){updateButtons()},50);

	//now check that the user really wants to delete the database
	var reply = confirm("Your local directory has been exported to the Main tab. If you click OK, it will now be erased from this device. This cannot be undone.");
	if (!reply) return;

	if(ChromeSyncOn && chromeSyncMode.checked){								//if Chrome sync is available, remove from sync storage
		if(confirm('Do you want to delete also from Chrome sync?')){
			for(var name in locDir) remChromeLock(name);
			chrome.storage.sync.remove(userName.toLowerCase() + '.ChromeSyncList')
		}
	}

	locDir = {};
	delete localStorage[userName];
	lockNames = [];
	optionMsg.textContent = 'Stored items erased';
	fillList();
	suspendFindLock = false;
	callKey = ''
}

//makes encrypted backup of the 'myself' entry only, then if allowed clears it, then stores
function moveMyself(){
	callKey = 'movemyself';

	//first encrypt myself data, as displayed by showLockDB
	showMyself();
	if(fullAccess){
		var datacrypt = keyEncrypt(mainBox.innerHTML.trim());					//preserve formatting
		if(!datacrypt) return;
		mainBox.textContent = 'PL24bak==' + datacrypt+ '==PL24bak';
		var msg = 'The item in the box contains your settings\r\nTo restore them, click Decrypt'
	}else{
		var msg = 'These are your settings, possibly including your encrypted random token\r\nYou may want to save them in a safe place.'
	}
	optionMsg.textContent = 'Backed-up settings on Main tab';
	mainMsg.textContent = msg;
	setTimeout(function(){updateButtons()},50);

	//now check that the user really wants to delete the database
	var reply = confirm("Your settings, including the email/token, have been backed up. If you click OK, they will now be erased from this device. This cannot be undone.");
	if (!reply) return;
	delete locDir['myself'];
	localStorage[userName] = JSON.stringify(locDir);
	lockNames = Object.keys(locDir);
	fillList();
	mainMsg.textContent = 'Your settings, including the email/token, have been erased\r\n' + msg;
	optionMsg.textContent = 'Settings erased';

	if(ChromeSyncOn && chromeSyncMode.checked){								//if Chrome sync is available, remove from sync storage
		if(confirm('Do you want to remove your settings also from Chrome sync?')) remChromeLock('myself')
	}

	suspendFindLock = false;
	callKey = ''
}

//merges two objects; doesn't sort the keys
function mergeObjects(obj1,obj2){
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3
}

//sorts object keys alphabetically
function sortObject(o) {
    var sorted = {},
    	key, a = [];
    for (key in o) {
    	if (o.hasOwnProperty(key)) {
    		a.push(key);
    	}
    }
    a.sort(insensitive);							//this depends on next function
    for (key = 0; key < a.length; key++) {
    	sorted[a[key]] = o[a[key]];
    }
    return sorted
}

//to make sorting case-insensitive
function insensitive(s1, s2) {
  var s1lower = s1.toLowerCase();
  var s2lower = s2.toLowerCase();
  return s1lower > s2lower? 1 : (s1lower < s2lower? -1 : 0)
}

//finds first partial match of string str and returns index of array element
function searchStringInArrayDB (str, strArray) {
	if (str != ''){
		var reg = new RegExp(str, "i");					//make it case-insensitive
		for (var j=0; j<strArray.length; j++) {
			if (strArray[j] != null){
    			if (strArray[j].match(reg)) return j
			}
		}
	}
    return -1
}

//decrypts locDir items one by one and encrypts them with new Key
function recryptDB(newKey,newUserName){
	var oldKeyStretched = KeyDir,
		newKeyStretched = wiseHash(newKey,newUserName);

	for(var name in locDir){
		if(name != 'myself'){
			for(var index = 0; index < locDir[name].length; index++){
				var content = locDir[name][index];
				if(content){
					if(content.slice(0,1) == 'k'){										//do only encrypted items
						KeyDir = oldKeyStretched;
						nameBeingUnlocked = name;
						content = keyDecrypt(content);
						if(!content) return;
						KeyDir = newKeyStretched;
						content = keyEncrypt(content);
						if(!content) return;
						locDir[name][index] = content
					}
				}
				if(ChromeSyncOn && chromeSyncMode.checked && index == 0){		//if Chrome sync is available, add to sync storage
					syncChromeLock(name,JSON.stringify(locDir[name]))
				}
			}
		}
	}

//change Lock stored under name 'myself'
	KeyDir = newKeyStretched;
	var email = readEmail();
	KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(newKey,email)).secretKey;
	KeyDH = ed2curve.convertSecretKey(KeySgn);
	myLock = nacl.sign.keyPair.fromSecretKey(KeySgn).publicKey;
	myLockStr = nacl.util.encodeBase64(myLock).replace(/=+$/,'');
	myezLock = changeBase(myLockStr, base64, base36, true);
	locDir['myself'][0] = keyEncrypt(email);
	if(!locDir['myself'][0]) return;
	localStorage[userName] = JSON.stringify(locDir);

	if(ChromeSyncOn && chromeSyncMode.checked && index == 0){
		syncChromeLock(name,JSON.stringify(locDir['myself']))
	}
}

//reads old and new Key from boxes and calls recryptDB so locDir is re-encrypted with the new Key
function acceptnewKey(){
	if(!fullAccess){
		optionMsg.textContent = 'Key change not allowed in Guest mode. Please restart PassLok';
		return
	}
	callKey = 'changekey';
	if(learnMode.checked){
		var reply = confirm("The local directory will be re-encrypted with a new Key. Cancel if this is not what you want.");
		if(!reply) return
	}
	var newkey = newKeyBox.value.trim(),
		newkey2 = newKey2Box.value.trim();
	if (newkey.trim() == "" || newkey2.trim() == ""){								//stop to display the entry form if new Key is empty
		keyChange.style.display = "block";
		shadow.style.display = "block";
		newKeyMsg.textContent = 'Enter the new Key in both boxes';
		if(!isMobile){
			if(newkey.trim() == ""){
				newKeyBox.focus()
			}else{
				newKey2Box.focus();
				window.scrollTo(0, 0)
			}
		}
		return
	}
	if(newkey.trim() != newkey2.trim()){											//check that the two copies match before going ahead
		newKeyMsg.textContent = "The two Keys don't match";
		return
	}

//everything OK, so do it!
	if(!fullAccess){
		newKeyMsg.textContent = 'Key change not allowed in Guest mode';
		return
	}
	recryptDB(newkey,userName);
	newKeyBox.value = "";									//on re-execution, read the box and reset it
	newKey2Box.value = "";
	keyChange.style.display = 'none';
	shadow.style.display = 'none';
	KeyStr = newkey;									//refill Key box, too

	if(ChromeSyncOn && chromeSyncMode.checked){
		for(var name in locDir){
			syncChromeLock(name,JSON.stringify(locDir[name]))
		}
	}

	if(keyScr.style.display == 'block') keyScr.style.display = 'none';
	mainMsg.textContent = 'The Key has changed';
	lockMsg.textContent = 'The Key has changed';
	optionMsg.textContent = 'The Key has changed';
	callKey = ''
}

//grab the names in locDir and put them on the Main tab selection box
function fillList(){
	if(bgColor[0]){
		if(bgColor[0] != 'FFFFFF') {var headingColor = milder(bgColor[0],'33')}else{var headingColor = '639789'};
	}else{var headingColor = '639789'};
	lockList.textContent = '';
	var fragment = document.createDocumentFragment();
	if(extraButtonsTop.style.display == 'block'){									//steganography buttons showing
		var opt2 = document.createElement("option");
		if(isiPhone){
			opt2.value = "default";
			opt2.textContent = "default"			
		}else{
			opt2.value = "default";
			opt2.textContent = "Choose one stored Cover text:";
			opt2.disabled = true;
			opt2.selected = true
		}
		lockList.appendChild(opt2);
		var opt3 = document.createElement("option");
		opt3.value = "default";
		opt3.textContent = "default";
		fragment.appendChild(opt3);
		for(var name in locDir){
			if(locDir[name][0].length > 500){										//only cover texts, which are long
				var opt = document.createElement("option");
				opt.value = name;
				opt.textContent = name;
				fragment.appendChild(opt)
			}
		}
	}else{																			//normal behavior
		var opt2 = document.createElement("option");
		if(isiPhone){
		}else if(isMobile)	{
			opt2.disabled = true;
			opt2.selected = true;
			opt2.textContent = "Select recipients:";
			fragment.appendChild(opt2)		
		}else{
			opt2.disabled = true;
			opt2.selected = true;
			opt2.textContent = "Select recipients (ctrl-click for several):";
			fragment.appendChild(opt2)
		}
		for(var name in locDir){
			if(locDir[name][0] && locDir[name][0].length < 500){
				var opt = document.createElement("option");
				opt.value = name;
				opt.textContent = name;
				fragment.appendChild(opt)
			}
		}
	}
	lockList.style.color = '#' + headingColor;
	lockList.appendChild(fragment);
	if(lockList.options.length != 0) lockList.options[0].selected = false
}

//take the selected names and put them in the Locks lower box. If any is a List, extract and merge with the other names, removing duplicates
var isList = false;												//so a decryption failure knows how to end
function fillBox(){
	callKey = 'fillbox';
	lockBox.textContent = '';
	lockMsg.textContent = '';
	var list = '';
	for(var i = 0; i < lockList.options.length; i++){
    	if(lockList.options[i].selected){
			if(lockList.options[i].value.slice(0,2) == '--'){					//it's a List, so decrypt it and add the contents to the box
				var itemcrypt = locDir[lockList.options[i].value][0];
				isList = true;											//to return here if the Key is wrong
				var nextItem = keyDecrypt(itemcrypt);
				if(!nextItem) return;
				list += '<br>' + nextItem
			}else if(lockList.options[i].value == 'default'){					//default cover selected
				var covername = 'default';
				newCover(defaultCoverText)
			}else if(locDir[lockList.options[i].value][0].length > 500){		//it's a Cover, so decrypt it and make it the new Cover
				var covername = lockList.options[i].value;
				var covercrypt = locDir[covername][0];
				isList = true;
				var cover2 = keyDecrypt(covercrypt);
				if(!cover2) return;
				newCover(LZString.decompressFromBase64(cover2))
			}else{
         		list += '<br>' + lockList.options[i].value
			}
    	}
  	}
	list = list.replace(/<br>/i,'');										//remove the first linefeed
	var array = list.split('<br>');
	if(array[0] != ''){
		array = array.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});  			//remove duplicates
		array = array.filter(function(n){return n});													//remove nulls
		array.sort();																					//alphabetical order
		list = '';
		var msg = 'Encrypting for: ';
		for(var index = 0; index < array.length; index++){
			list += '<br>' + array[index];
			msg += array[index] + ', '
		}
		lockBox.innerHTML = list.replace(/<br>/i,'').trim();				//remove first linefeed
	}else if(covername){
		var msg = covername + ' Cover text loaded'
	}else{
		var msg = ''
	}
	mainMsg.textContent = msg.trim().replace(/,$/,'');
	lockMsg.textContent = '';
	isList = false;
	updateButtons();
	callKey = ''
}

//empty the selection box on Main tab
function resetList(){
	for (var i = 0; i < lockList.options.length; i++) {
		if(lockList.options[i].selected) {lockBox.textContent = '';lockMsg.textContent = ''}
    	lockList.options[i].selected = false
  	}
	setTimeout(function(){
		var l = lockBox.textContent.trim().length;
		if(l == 0){
			mainMsg.textContent = 'Nobody selected'
		}else if(l > 500){
			mainMsg.textContent = 'Click Edit to see the Cover text'
		}else{
			mainMsg.textContent = 'Click Edit to see loaded Keys'				
		}
		updateButtons()
	},0)
}

//grab the names in localStorage and put them on the userName selection box. Buggy, so a lot of cleanup ifs
function fillNameList(){
	nameList.innerHTML = '<option value="" disabled>Select User Name:</option>';
	nameList.style.color = '#639789';
	var list = [];
	for(var name in localStorage){
			//this if is because of a bug in all major browsers
		if(name != 'clear' && name != 'getItem' && name != 'key' && name!= 'length' && name != 'removeItem' && name != 'setItem' && name != 'randid'){
			//and this, because of a bug in Safari
			if(!name.match('com.apple.WebInspector') && name != 'locDir'){
				list = list.concat(removeHTMLtags(name))
			}
		}
	}
	list.sort(function (a, b) {											//case-insensitive sort
    	return a.toLowerCase().localeCompare(b.toLowerCase())
	})
	var fragment = document.createDocumentFragment();
	for(var i = 0; i < list.length; i++){
		var opt = document.createElement("option");
		opt.value = list[i];
		opt.textContent = list[i];
		fragment.appendChild(opt)
	}
	nameList.appendChild(fragment)
}
</script>

<!--user interface-->
<script>
//start blinking message, for Msg elements
function blinkMsg(element){
	element.textContent = '';
	var blinker = document.createElement('span');
	blinker.className = "blink";
	blinker.textContent = 'PROCESSING';
	element.appendChild(blinker)
}

//displays how many characters are left, in Short mode and Decoy In box
function charsLeft(){
	//for decoy message box
	if(decoyIn.style.display == 'block'){
		var chars = encodeURI(decoyText.value).replace(/%20/g,' ').length,
			limit = 75;	
		if(chars <= limit){
			decoyInMsg.textContent = chars + " characters out of " + limit + " used"
		}else{
			decoyInMsg.textContent = 'Maximum length exceeded. The message will be truncated'
		}
		return
	}

	//this one is for the text in the chat making dialog
	else if(chatDialog.style.display == 'block'){
		var chars = chatDate.value.length;
		var limit = 43;
		if(chars <= limit){
			chatmsg.textContent = chars + " characters out of " + limit + " used"
		}else{
			chatmsg.textContent = 'Maximum length exceeded. The message will be truncated'
		}
		return
	}

	//Now for main box. Short mode character count
	else if(shortMode.checked && mainBox.textContent.match(/[^a-zA-Z0-9+\/=-]/)){		//don't display character count if this is output
		updateButtons();
		var chars = encodeURI(mainBox.textContent).replace(/%20/g,' ').length,
			sharedKey = stripTags(replaceByItem(lockBox.textContent.trim()));
		if(!sharedKey) return;
		if(sharedKey.length != 43 && sharedKey.length != 50 && !onceMode.checked){	
			var limit = 94									//Key-encrypted mode, 94 chars
		}else if(anonMode.checked){
			var limit = 62									//anonymous mode, 62 chars
		}else if(signedMode.checked){
			var limit = 94									//signed mode, 94 chars
		}else if(onceMode.checked){
			var limit = 46									//Read-once mode, 46 chars
		}
		if(extraButtonsTop.style.display != 'block'){		//don't show this if hiding or splitting
			if(chars <= limit){
				mainMsg.textContent = chars + " characters out of " + limit + " used"
			}else{
				mainMsg.textContent = 'Maximum length exceeded. The message will be truncated'
			}
		}
	}else{
		mainMsg.textContent = '';					//to clear previous errors while typing
		updateButtons()							//display button labels according to item nature
	}
}

//changes button labels according to context
function updateButtons(){
	var string = mainBox.innerHTML.trim(),
		type = getType(string)[0],
		isRecipient = !!lockBox.textContent.trim();

	if(type && type.match(/[hkdsgasoprASO]/)){
		decryptBtn.textContent = 'Decrypt';
		decryptBtnBasic.textContent = 'Decrypt';
		decryptBtnEmail.textContent = 'Decrypt';
		showLockBtn.textContent = 'Email';
		showLockBtnBasic.textContent = 'Email'	
	}else if(type && type.match(/[lc]/) && isRecipient){
		decryptBtn.textContent = 'Encrypt';
		decryptBtnBasic.textContent = 'Encrypt';
		decryptBtnEmail.textContent = 'Encrypt';
		showLockBtn.textContent = 'Email';
		showLockBtnBasic.textContent = 'Email';
	}else if(isRecipient){
		decryptBtn.textContent = 'Encrypt';
		decryptBtnBasic.textContent = 'Encrypt';
		decryptBtnEmail.textContent = 'Encrypt';
		showLockBtn.textContent = 'myLock';
		showLockBtnBasic.textContent = 'myLock'	
	}else{
		decryptBtn.textContent = 'Invite';
		decryptBtnBasic.textContent = 'Invite';
		decryptBtnEmail.textContent = 'Invite';
		showLockBtn.textContent = 'myLock';
		showLockBtnBasic.textContent = 'myLock'	
	}
	if(type && type == 'l'){verifyBtn.textContent = 'Unseal'}else{verifyBtn.textContent = 'Seal'};

	if(string.match(/PL\d{2}p\d{3}/)){						//box contains parts
		secretShareBtn.textContent = 'Join'
	}else{
		secretShareBtn.textContent = 'Split'
	}
	if(string.includes('href="data:')){sendSMSBtn.textContent = "Save"}else{sendSMSBtn.textContent = "SMS"}
}

//gets recognized type of string, if any, otherwise returns false. Also returns cleaned-up string
function getType(stringIn){
	var string = stringIn.replace(/&[^;]+;/g,'').replace(/<a(.*?).(plk|txt)" href="data:(.*?),/,'').replace(/"(.*?)\/a>/,''); 	//remove special chars, files and images
	if(string.match('==')) string = string.split('==')[1];									//remove PassLok tags
	string = string.replace(/<(.*?)>/g,'').replace(/-/g,'').replace(/\r?\n|\r/g,'').trim();		//remove HTML tags and dashes, plus carriage returns

	var	type = string.charAt(0),
		hasLock = (string.slice(50,56) == '//////'),
		typeGC = string.charAt(56),												//PassLok for Email compatible
		isBase64 = !string.match(/[^a-zA-Z0-9\+\/]/),
		isBase26 = !string.match(/[^A-Z ]/),										//spaces allowed, as in 5-letter codegroups 
		isNoLock = string.length != 43 && string.length != 50;

	if(!hasLock && type.match(/[lkgdasoprASO]/) && isBase64 && !isBase26 && isNoLock && string.length > 40){				//encrypted or signed, no Lock prepended
		return [type, string]
	}else if(hasLock && typeGC.match(/[gasoprSO]/) && isBase64 && !isBase26 && isNoLock && string.length > 40){				//encrypted, Lock prepended
		return [typeGC, string]
	}else if(!hasLock && !isNoLock && isBase64 && !isBase26 && string.length > 40){											//special type for a Lock
		return ['c'	, string]
	}else if(!hasLock && string && isBase26){																					//human-computable encrypted
		return ['h', string]
	}else{
		return [false, stringIn]																									//unrecognized type
	}
}

//start decrypt or verify if the item pasted in is recognized
function pasteMain() {
    setTimeout(function(){
		var string = mainBox.innerHTML.trim()
		if((string.replace(/<(.*?)>/g,'').slice(0,13).match(/p\d{3}/) && string.replace(/<(.*?)>/g,'').slice(0,7).match('PL')) || (string.match(/PL\d{2}p\d{3}/) && string.match('.txt'))){																//parts to be joined detected
			secretshare();
			return
		}
		var array = getType(string.replace(/<(.*?)>/g,'')),
			type = array[0],
			lockBoxHTML = lockBox.innerHTML.replace(/\n/g,'<br>').replace(/\r/g,'').replace(/<br>$/,"").trim();
		if(type && type.match(/[hkdsgasoprASO]/)){							//known encrypted type: decrypt
			unlock(type,array[1],lockBoxHTML);
			return
		}else if(type && type == 'l'){										//unseal
			verifySignature(array[1],lockBoxHTML);
			return
		}else if(type && type == 'c'){										//store new Lock
			extractLock(string)
		}else if(string.split(/[ _]/).length == 20){							//word Lock
			extractLock(string)
		}
    }, 0)
}

//for showing.hiding password fields
var eyeImg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==",
	hideImg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAAb1BMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABt6r1GAAAAJHRSTlMAFNTiDPTNBvnaulFBAe/osrGBZCXSwIdnLhzIqKd7XFRLSjAYduwyAAAAuklEQVQoz62QRxbDIAwFhWkhwb07PeH+Z4wQPMjCS89KegP6AjiWSbF9oVzBQNyNlKZZ/s+wwpvLyXlkp7P5umiIcYDIwB0ZLWzrTb3GSQYbMsjDl3wj0fj6TDmpK7F60nnLeDCW2h6rgioBVZgmwlwUJoo6bkC7KRQ9iQ/MzuWtXyjKKcTpmVc8mht4Nu5NV+Y/UAKItaY7byHsOeSkp48uQSahO+kiISfD+ha/nbcLwxwFuzB1hUP5AR4JF1hy2DV7AAAAAElFTkSuQmCC";

//this is for showing and hiding text in password input boxes
function showPwd(name){
	var pwdIn = document.getElementById(name + 'Box'),
		icon = document.getElementById(name + 'Icon');
	if(pwdIn.type=="password"){
		pwdIn.type="text";
		icon.src = hideImg
	}else{
		pwdIn.type="password";
		icon.src = eyeImg
	}
	keyStrength(pwdIn.value.trim(),name)
}

//for clearing different boxes
function clearMain(){
	mainBox.textContent = '';
	mainMsg.textContent = '';
	charsLeft()
}
function clearLocks(){
	lockBox.textContent='';
	lockMsg.textContent='';
	addLockBtn.textContent = "Rand.";
	suspendFindLock = false
}
function clearIntro(){
	pwdIntroBox.value = '';
	pwdIntroMsg.textContent = '';
	KeyStr = '';
	pwdMsg.textContent = ''
}
function clearIntroEmail(){
	emailIntro.value = ''
}

//encrypts, decrypts, or sends invite depending on main box content
function lockBtnAction(){
	var text = mainBox.innerHTML.trim();
	if(!text){
		makeQRcode();		//includes Lock
		return
	}
	var array = getType(text),
		type = array[0],
		lockBoxHTML = lockBox.innerHTML.replace(/\n/g,'<br>').replace(/\r/g,'').replace(/<br>$/,"").trim();
	if(type && type.match(/[hkdgasoprASO]/)){								//known encrypted type: decrypt
		unlock(type,array[1],lockBoxHTML)
	}else if(!!lockBoxHTML){												//recipients selected: encrypt and send if Email mode
		lock(lockBoxHTML,array[1]);
		setTimeout(function(){
			if(emailMode.checked) sendMail()
		},500)
	}else{
		makeInvitation()													//no recipients: invite
	}
}

//for selecting the Main box contents and copying them to clipboard
function selectMain(){
  if(mainBox.textContent.trim() != ''){
    var range, selection;
    if(document.body.createTextRange){
        range = document.body.createTextRange();
        range.moveToElementText(mainBox);
        range.select()
    }else if (window.getSelection){
        selection = window.getSelection();
        range = document.createRange();
        range.selectNodeContents(mainBox);
        selection.removeAllRanges();
        selection.addRange(range)
    }
	document.execCommand('copy');
	mainMsg.textContent = "main Box copied to clipboard"
  }
}

//writes five random dictionary words in the intro Key box
function suggestIntro(){
	var output = '',
		wordlist = wordListExp.toString().slice(1,-2).split('|')
	for(var i = 1; i <= 5 ; i++){
		output += ' ' + replaceVariants(wordlist[Math.floor(Math.random()*wordlist.length)])
	}
	pwdIntroBox.type="text";
	pwdIntroBox.value = output.trim();
	pwdIntroIcon.src = hideImg;
	keyStrength(output.trim(),true)
}

//makes a new user account
function newUser(){
	introscr.style.display = "block";
	BasicButtons = true
}

//shows email screen so email/token can be changed
function showEmail(){
	if(!fullAccess){
		optionMsg.textContent = 'Email change not allowed in Guest mode. Please restart PassLok';
		return
	}
	if(isMobile) window.scrollTo(0, 0);
	if(myEmail) emailBox.value = myEmail;
	shadow.style.display = 'block';
	emailScr.style.display = 'block'
}

//shows user name so it can be changed
function showName(){
	if(!fullAccess){
		optionMsg.textContent = 'Name change not allowed in Guest mode. Please restart PassLok';
		return
	}
	if(isMobile) window.scrollTo(0, 0);
	userNameBox.value = userName;
	shadow.style.display = 'block';
	nameScr.style.display = 'block'
}

//changes the name of the complete database, syncs if possible
function changeName(){
	if(!fullAccess){
		namechangemsg.textContent = 'Name change not allowed in Guest mode';
		return
	}
	if(learnMode.checked){
		var reply = confirm("The current User Name will be changed. Cancel if this is not what you want.");
		if(!reply) return
	}
	var oldUserName = userName,
		userNameTemp = document.getElementById('userNameBox').value;
	if (userNameTemp.trim() == ''){
		return
	}
	recryptDB(KeyStr,userNameTemp);
	localStorage[userNameTemp] = localStorage[userName];
	delete localStorage[userName];
	userName = userNameTemp;

	if(ChromeSyncOn && chromeSyncMode.checked){
		for(var name in locDir){
			syncChromeLock(name,JSON.stringify(locDir[name]));
			chrome.storage.sync.remove((oldUserName+'.'+name).toLowerCase())
		}
		updateChromeSyncList();
		chrome.storage.sync.remove(oldUserName.toLowerCase()+'.ChromeSyncList')
	}
}

//makes base64 code for checkboxes in Options and stores it
function checkboxStore(){
	if(fullAccess){
		var checks = document.optionchecks;
		var binCode = '', i;
		for(i = 0; i < checks.length; i++){
			binCode += checks[i].checked ? 1 : 0
		}
		if(locDir['myself']){
			locDir['myself'][1] = changeBase(binCode,'01',base64);
			localStorage[userName] = JSON.stringify(locDir);

			if(ChromeSyncOn && chromeSyncMode.checked){
				syncChromeLock('myself',JSON.stringify(locDir['myself']))
			}
		}
	}
}

//resets checkboxes in Options according to the stored code
function code2checkbox(){
	var checks = document.optionchecks;
	if(locDir['myself'][1]){
		var binCode = changeBase(locDir['myself'][1],base64,'01'), i;
		while(binCode.length < checks.length) binCode = '0' + binCode;
		for(i = 0; i < checks.length; i++){
			checks[i].checked = (binCode[i] == '1')
		}
		var isEmailMode = checks[2].checked;
		BasicButtons = checks[0].checked || isEmailMode
	}
	if(!BasicButtons){									//retrieve Advanced interface
		openClose("basicBtnsTop");
		openClose("mainBtnsTop");
		openClose("lockBtnsBottom");
		openClose("basicHideModes");
		openClose('advancedModes');
		openClose('specialEncryptModes');
		openClose('advancedBtns');
		openClose('advancedHelp');
		basicMode.checked = false;
		advancedMode.checked = true
	}
	if(isEmailMode){									//Email compatible interface
		mode2email();
		updateButtons()
	}
	getCustomColors();
	selectStyle();

	if(ChromeSyncOn) syncCheck.style.display = 'block'
}

//go to 2nd intro screen, and back. The others are similar
function go2intro2(){
	openClose('introscr');
	openClose('introscr2')
}
function go2intro3(){
	openClose('introscr2');
	openClose('introscr3')
}
function go2intro4(){
	openClose('introscr3');
	openClose('introscr4')
}
function go2intro5(){
	intromsg2.textContent = '';
	openClose('introscr4');
	openClose('introscr5')
}

//these close input dialogs
function closeBox(){
	shadow.style.display = "none";
	keyScr.style.display = "none";
	lockScr.style.display = "none";
	decoyIn.style.display = "none";
	decoyOut.style.display = "none";
	partsIn.style.display = "none";
	keyChange.style.display = "none";
	emailScr.style.display = "none";
	chatDialog.style.display = "none";
	nameScr.style.display = "none";
	introscr.style.display = "none"
}

//Key entry is canceled, so record the limited access mode and otherwise start normally
function cancelKey(){
	if(firstInit) {pwdBox.value = ''; KeyStr = '';}
	if(!allowCancelWfullAccess){
		fullAccess = false;

		if(nameList.options.length == 2){						//only one user, no need to select it
			userName = nameList.options[1].value
		}else{												//several users
			for(var i = 0; i < nameList.options.length; i++){
    			if(nameList.options[i].selected){
					userName = nameList.options[i].value
    			}
  			}
		}

		getSettings();
		fillList();										//put names in selection box
		if(locDir['myself']){
			locDir['myself'][3] = 'guest mode';
			localStorage[userName] = JSON.stringify(locDir);

			if(ChromeSyncOn && chromeSyncMode.checked){
				syncChromeLock('myself',JSON.stringify(locDir['myself']))
			}
		}
		if(Object.keys(locDir).length == 1 || Object.keys(locDir).length == 0){		//new user, so display a fuller message
			mainMsg.textContent = 'To encrypt you must first enter the recipient’s Lock or shared Key via Edit button'
		}else{
			setTimeout(function(){mainMsg.textContent = 'You are in Guest mode. For full access, reload and enter your Key'},30)
		}
	}
	allowCancelWfullAccess = false;
	closeBox()
}
function cancelName(){
	closeBox();
	mainMsg.textContent = 'User name change canceled';
	callKey = ''
}
function cancelEmail(){
	emailBox.value = '';
	closeBox();
	mainMsg.textContent = 'Email/token change canceled';
	callKey = ''
}
function cancelDecoy(){
	decoyInBox.value = '';
	decoyOutBox.value = '';
	closeBox();
	mainMsg.textContent = 'Hidden message canceled'
}
function cancelPartsIn(){
	partsNumber.value = '';
	closeBox();
	mainMsg.textContent = 'Split canceled'
}
function cancelChat(){
	closeBox();
	mainMsg.textContent = 'Chat canceled'
}
function cancelKeyChange(){
	newKeyBox.value = '';
	closeBox();
	mainMsg.textContent = 'Key change canceled';
	if(keyScr.style.display == 'block') keyScr.style.display = 'none';
	callKey = ''
}

//generic function to evaluate key strength and execute on Enter. Possible names are: pwd, oldPwd, decoyIn, decoyOut, imageBox
function boxKeyup(name,evt){
	evt = evt || window.event;
	var key = evt.keyCode || evt.which || evt.keyChar;
	if(key == 13){
		window['accept' + name]()
	}else{
		return keyStrength(document.getElementById(name + 'Box').value, name)
	}
}

//triggered if the user types Enter in the locks screen
function lockBoxKeyup(evt){
	evt = evt || window.event;												//IE6 compliance
	var key = evt.keyCode || evt.which || evt.keyChar;
	if(lockBox.textContent.trim() == ''){
		addLockBtn.textContent = "Rand."
	}else{
		addLockBtn.textContent = "Save"
	}
	if(key == 13) {												//sync from Chrome if hit Return
		if(lockMsg.textContent == ''){				//found nothing, so try to get it from Chrome sync
			if(ChromeSyncOn && chromeSyncMode.checked){
				getChromeLock(lockBox.textContent.trim());
			}
		}
	}else if(!suspendFindLock){											//otherwise search database
			return findLock()
	}else{
		if(lockBox.textContent.trim() == ''){
			suspendFindLock = false;
			return findLock()
		}
	}
}

//this one looks at the second box and announces a match
function newKey2up(evt){
	evt = evt || window.event;
	var key = evt.keyCode || evt.which || evt.keyChar;
	if(key == 13){acceptnewKey()}else{
		var	newkey = newKeyBox.value,
			newkey2 = newKey2Box.value,
			length = newkey.length,
			length2 = newkey2.length;
		if(length != length2){
			if(newkey2 == newkey.slice(0,length2)){
				newKeyMsg.textContent = 'Keys match so far. ' + (length - length2) + ' characters to go'
			}else{
				newKeyMsg.textContent = "Keys don't match"
			}
		}else{
			if(newkey2 == newkey){
				newKeyMsg.textContent = "Keys match!"
			}else{
				newKeyMsg.textContent = "Keys don't match"
			}
		}
	}
}

//activated when the user clicks OK on a decoy screen
//function submitDecoy(){
function acceptdecoyIn(){
	closeBox();
	if(callKey == 'sign'){
		signVerify()
	}else{
		lockBtnAction()
	}
}
function acceptdecoyOut(){
	acceptdecoyIn()
}
function acceptpwdIntro(){	//needed because the event listener is created automatically
}
function acceptimage(){
	imageMsg = 'Please click one of the buttons'
}

function partsKeyup(evt){
	evt = evt || window.event;
	var key = evt.keyCode || evt.which || evt.keyChar;
	if(key == 13){submitParts()}
}
function submitParts(){
	if(!isNaN(partsNumber.value)){
	closeBox();
	secretshare()
	}
}
function emailKeyup(evt){
	evt = evt || window.event;
	var key = evt.keyCode || evt.which || evt.keyChar;
	if(key == 13){email2any()}
}
function nameKeyup(evt){
	evt = evt || window.event;
	var key = evt.keyCode || evt.which || evt.keyChar;
	if(key == 13){name2any()}
}

//for switching between sets of buttons
function main2extra(){
	if(basicMode.checked) return;
	openClose("mainBtnsTop");
	openClose("extraButtonsTop");
	fillList()
}

//switch to Advanced mode
function mode2adv(){
	mainBtnsTop.style.display = 'block';
	basicBtnsTop.style.display = 'none';
	emailBtnsTop.style.display = 'none';
	lockBtnsBottom.style.display = 'block';
	advancedModes.style.display = 'block';
	basicHideModes.style.display = 'block';
	specialEncryptModes.style.display = 'block';
	advancedBtns.style.display = 'block';
	advancedHelp.style.display = 'block';
	basicMode.checked = false;
	advancedMode.checked = true;
	emailMode.checked = false;	
	anonMode.style.display = '';
	anonMode.checked = true;
	signedMode.checked = false;
	onceMode.checked = false;
	BasicButtons = false;
	checkboxStore()
}

//switch to Basic mode
function mode2basic(){
	mainBtnsTop.style.display = 'none';
	extraButtonsTop.style.display = 'none';
	basicBtnsTop.style.display = 'block';
	emailBtnsTop.style.display = 'none';	
	lockBtnsBottom.style.display = 'none';
	basicHideModes.style.display = 'none';
	advancedModes.style.display = 'none';
	specialEncryptModes.style.display = 'none';
	advancedBtns.style.display = 'none';
	advancedHelp.style.display = 'none';
	basicMode.checked = true;
	advancedMode.checked = false;
	emailMode.checked = false;
	resetAdvModes();
	decoyMode.checked = false;	
	anonMode.style.display = '';
	anonMode.checked = true;
	signedMode.checked = false;
	onceMode.checked = false;
	BasicButtons = true;
	checkboxStore();
	fillList()
}

//switch to PassLok for Email compatible mode
function mode2email(){
	mainBtnsTop.style.display = 'none';
	extraButtonsTop.style.display = 'none';
	basicBtnsTop.style.display = 'none';
	emailBtnsTop.style.display = 'block';
	lockBtnsBottom.style.display = 'none';
	basicHideModes.style.display = 'block';
	advancedModes.style.display = 'none';
	specialEncryptModes.style.display = 'none';
	advancedBtns.style.display = 'none';
	advancedHelp.style.display = 'none';
	basicMode.checked = false;
	advancedMode.checked = false;
	emailMode.checked = true;
	ezLokMode.checked = true;
	resetAdvModes();
	letterMode.checked = true;
	anonMode.checked = false;
	signedMode.checked = true;
	onceMode.checked = false;
	BasicButtons = true;
	checkboxStore();
	fillList()
}

//sets modes selectable in Advanced mode to default values
function resetAdvModes(){
	longMode.checked = true;
	shortMode.checked = false;
	compatMode.checked = false;
	letterMode.checked = true;
	wordMode.checked = false;
	spaceMode.checked = false;
	sentenceMode.checked = false
}

//opens local directory for input if something seems to be missing
function main2lock(){
	if(isMobile) window.scrollTo(0, 0);
	if(tabLinks['mainTab'].className == '') return;
	if(Object.keys(locDir).length == 1 || Object.keys(locDir).length == 0){				//new user, so display a fuller message
		lockMsg.textContent = 'Please enter a Lock or shared Key in the lower box. To store it, write a name in the top box and click Save'
	}
	var string = lockBox.textContent.trim();
	if(string.length > 500){							//cover text detected, so replace the currently selected one
		newCover(string)
	}
	if(string == '') addLockBtn.textContent = "Rand.";
	resetList();
	openClose('lockScr');
	openClose('shadow');
	focusBox()
}

//close image screen
function image2main(){
	if(imageScr.style.display=='block'){
		openClose('imageScr');
		openClose('shadow');
		focusBox()
	}
}

//opens a chat page
function main2chat(token){
	if(token){
		window.open("https://passlok.com/chat/chat.html#" + token);
		mainMsg.textContent = 'Chat session open in a separate tab'
	}
}

//called when the Key box is empty
function any2key(){
	closeBox();
	shadow.style.display = 'block';
	keyScr.style.display = 'block';
	if(!isMobile){
		pwdBox.focus()
	}else{
		window.scrollTo(0, 0)
	}
	allowCancelWfullAccess = false
}

//called when the email box is empty
function any2email(){
	if(isMobile) window.scrollTo(0, 0);
	shadow.style.display = 'block';
	emailScr.style.display = 'block';
	emailMsg.textContent = 'Please enter your new email or similar item, or a new random token';
	if(!isMobile) emailBox.focus()
}

//close screens and reset Key timer when leaving the Key box. Restarts whatever was being done when the Key was found missing.
function key2any(){
	clearTimeout(keytimer);
	keytimer = setTimeout(resetKeys, 300000);	//reset timer for 5 minutes, then delete Key
	keytime = new Date().getTime();
	keyScr.style.display = 'none';
	shadow.style.display = 'none';
	focusBox()
}

//leave email screen
function email2any(){
	if(callKey = 'showlock') var dispLock = true;				//in case we were in the middle of displaying the Lock
	callKey = 'changeemail';
	var email = emailBox.value.trim();
	if(myEmail.length == 43 && fullAccess){
		var result = confirm('If you go ahead, the random token associated with your user name will be overwritten, which will change your Lock. This is irreversible.');
		if(!result){
			emailMsg.textContent = 'Random token overwrite canceled';
			return
		}
	}
	myEmail = email;
	emailBox.value = '';
	if(!refreshKey()) return;
	if(!KeyDir) KeyDir = wiseHash(KeyStr,userName);
	KeySgn = nacl.sign.keyPair.fromSeed(wiseHash(KeyStr,myEmail)).secretKey;			//do this regardless in case email has changed
	KeyDH = ed2curve.convertSecretKey(KeySgn);
	myLock = nacl.sign.keyPair.fromSecretKey(KeySgn).publicKey;
	myLockStr = nacl.util.encodeBase64(myLock).replace(/=+$/,'');
	myezLock = changeBase(myLockStr, base64, base36, true);
	if(dispLock) lockDisplay();

	if(fullAccess) storemyEmail();
	emailScr.style.display = 'none';
	key2any();															//close key dialog too, if it was open
	if(tabLinks['optionsTab'].className == 'selected'){
		optionMsg.textContent = 'Email/token changed'
	}else{
		mainMsg.textContent = 'Email entered. You may need to re-set options'
	}
	fillList();
	callKey = ''
}

//leave name change screen
function name2any(){
	callKey = 'changename';
	if(fullAccess){
		changeName()
	}else{
		namechangemsg.textContent = 'Name change not allowed in Guest mode';
		return
	}
	closeBox();
	optionMsg.textContent = 'The User Name has changed to: '+ userName;
	callKey = ''
}

//put cursor in the box. Handy when using keyboard shortcuts
function focusBox(){
	if (!isMobile){															//on mobile, don't focus
		if(keyScr.style.display == 'block'){
			pwdBox.focus()
		} else if(lockScr.style.display == 'block'){
			lockBox.focus()
		} else {
			mainBox.focus()
		}
	}
}

//to hide and unhide stuff
function openClose(theID) {
	if(document.getElementById(theID).style.display === "block"){
		document.getElementById(theID).style.display = "none"
	}else{
		document.getElementById(theID).style.display = "block"
	}
}

//for opening one item at a time in the Help screen, with animation
function openHelp(){
	var helpItems = document.getElementsByClassName('helpHeading');
	for(var i = 0; i < helpItems.length; i++){					//hide all help texts
		var panel = helpItems[i].nextElementSibling;
		panel.style.maxHeight = null;
	}
	helpItems = document.getElementsByClassName('helpHeading2');
	for(var i = 0; i < helpItems.length; i++){					//hide also secondary texts
		var panel = helpItems[i].nextElementSibling;
		panel.style.maxHeight = null;
	}
	var panel = this.nextElementSibling;							//except for the one clicked
	panel.style.maxHeight = panel.scrollHeight + "px"	     
}

//for secondary help items
function openHelp2(){
	var panel = this.nextElementSibling,
		parent = this.parentElement;
	panel.style.maxHeight = panel.scrollHeight + "px";
	setTimeout(function(){parent.style.maxHeight = parent.scrollHeight + "px"},301)
}

<!--variables and functions for making tabs, by Matt Doyle 2009-->
var tabLinks = new Array(),
	contentDivs = new Array();

function initTabs(){

      // Grab the tab links and content divs from the page
      var tabListItems = document.getElementById('tabs').childNodes;
      for( var i = 0; i < tabListItems.length; i++){
        if(tabListItems[i].nodeName == "LI"){
          var tabLink = getFirstChildWithTagName( tabListItems[i], 'A' );
          var id = getHash( tabLink.getAttribute('href'));
          tabLinks[id] = tabLink;
          contentDivs[id] = document.getElementById(id)
        }
      }

      // Assign onclick events to the tab links, and
      // highlight the first tab
      var i = 0;

      for(var id in tabLinks){
        tabLinks[id].onclick = showTab;
        tabLinks[id].onfocus = function(){ this.blur()};
        if (i == 0) tabLinks[id].className = 'selected';
        i++
      }

      // Hide all content divs except the first
      var i = 0;

      for(var id in contentDivs){
        if( i != 0 ) contentDivs[id].className = 'tabContent hide';
        i++
      }
}

function showTab(){
      var selectedId = getHash( this.getAttribute('href'));

      // Highlight the selected tab, and dim all others.
      // Also show the selected content div, and hide all others.
      for(var id in contentDivs){
        if(id == selectedId){
          tabLinks[id].className = 'selected';
          contentDivs[id].className = 'tabContent'
        }else{
          tabLinks[id].className = '';
          contentDivs[id].className = 'tabContent hide'
        }
      }
	  if(this.hash == '#mainTab') fillList();
	  if(this.hash != '#optionsTab'){
		  customColors.style.display = 'none';
		  optionMsg.textContent = 'Change Name, Key, etc.'
	  }
	  if(this.hash != '#helpTab' && !isiOS){
			if(helpTop.style.display != 'block') helpTop.style.display = 'block'
	  }
	  storeColors();

      // Stop the browser following the link
      return false
}

function getFirstChildWithTagName(element, tagName){
      for(var i = 0; i < element.childNodes.length; i++){
        if(element.childNodes[i].nodeName == tagName) return element.childNodes[i]
      }
}

function getHash(url){
      var hashPos = url.lastIndexOf('#');
      return url.substring(hashPos + 1)
}
//end of tab functions

//function to search in Help tab, from JAVASCRIPTER.NET 2011
var TRange=null;

function findString (str){
 if (parseInt(navigator.appVersion) < 4) return;
 var strFound;
 if (window.find){

  // CODE FOR BROWSERS THAT SUPPORT window.find

  strFound = self.find(str);
  if (!strFound){
   strFound = self.find(str,0,1);
   while(self.find(str,0,1)) continue
  }
 }
 else if(navigator.appName.indexOf("Microsoft") != -1){

  // EXPLORER-SPECIFIC CODE

  if(TRange != null){
   TRange.collapse(false);
   strFound = TRange.findText(str);
   if(strFound) TRange.select();
  }
  if(TRange == null || strFound == 0){
   TRange = self.document.body.createTextRange();
   strFound = TRange.findText(str);
   if(strFound) TRange.select()
  }
 }
 else if(navigator.appName == "Opera"){
  alert ("Opera browsers not supported, sorry...")
  return
 }
 if(!strFound){
	 helpmsg.textContent = 'Text not found in the titles. You may need to switch to Advanced mode'
 }else{
	 helpmsg.textContent = 'Text highlighted below. Click again to see more results'
 }
 return
}

//for rich text editing
function formatDoc(sCmd, sValue){
	  document.execCommand(sCmd, false, sValue); mainBox.focus()
}

var niceEditor = false;

//function to toggle rich text editing on mainBox
function toggleRichText(){
	if(niceEditor){
		toolBar1.style.display = 'none';
		mainBox.style.borderTopLeftRadius = '15px';
		mainBox.style.borderTopRightRadius = '15px';
		niceEditBtn.innerText = 'Rich';
		niceEditor = false
	}else{
		toolBar1.style.display = 'block';
		mainBox.style.borderTopLeftRadius = '0';
		mainBox.style.borderTopRightRadius = '0';
		niceEditBtn.innerText = 'Plain';
		niceEditor = true
	}
	textheight()
}
</script>

<!--for changing screen colors-->
<script>
//this group creates dummy stylesheets for buttons, tabs, boxes, and background. One sheet for general color and another for text
var btnSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';				//a nonce added because otherwise the CSP of the extension will refuse next statement
	document.head.appendChild(style);
	return style.sheet
})();
var tabSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();
var boxSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();
var bgSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();
var btnTextSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();
var tabTextSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();
var boxTextSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();
var bgTextSheet = (function() {
	var style = document.createElement("style");
	style.appendChild(document.createTextNode(""));
	style.nonce = '4AEemGb0yJptoIGFP3Nd';
	document.head.appendChild(style);
	return style.sheet
})();

//these two are to add a rule (usually a changed color) to a dummy stylesheet, or to remove it
function addCSSRule(sheet, selector, rules, index) {
	if("insertRule" in sheet) {
		sheet.insertRule(selector + "{" + rules + "}", index)
	}
	else if("addRule" in sheet) {
		sheet.addRule(selector, rules, index)
	}
}
function removeCSSRule(sheet, selector, rules, index) {
	if("deleteRule" in sheet) {
		sheet.deleteRule(selector + "{" + rules + "}", index)
	}
	else if("removeRule" in sheet) {
		sheet.removeRule(selector, rules, index)
	}
}

//stores custom colors
function storeColors(){
	if(fullAccess){
		var hexCode = '';
		for(var i=0; i<4; i++) hexCode += bgColorStore[i];
		if(locDir['myself']){
			locDir['myself'][2] = hexCode;
			localStorage[userName] = JSON.stringify(locDir);

			if(ChromeSyncOn && chromeSyncMode.checked){
				syncChromeLock('myself',JSON.stringify(locDir['myself']))
			}
		}
	}
}

//retrieves custom colors from storage
function getCustomColors(){
	if(locDir['myself'][2]){
		var hexCode = locDir['myself'][2];
		while(hexCode.length < 24) hexCode = '0' + hexCode;
		for(var i=0; i<4; i++){
			bgColorStore[i] = hexCode.slice(i*6,(i+1)*6);
			bgColor[i] = bgColorStore[i];
			fgColorStore[i] = foregColor(bgColorStore[i]);
			fgColor[i] = fgColorStore[i]
		}
	}
}

//deduces foreground color (white or black) from hex background color
function foregColor(bgColor){
	var red = parseInt(bgColor.slice(0,2),16),
		green = parseInt(bgColor.slice(2,4),16),
		blue = parseInt(bgColor.slice(4,6),16);
	return 0.213 * red + 0.715 * green + 0.072 * blue < 128 ? 'FFFFFF' : '000000'
}

//returns a closer to neutral gray version of a hex color, as given by a hex offset (1 byte)
function milder(color, offset){
	var red = parseInt(color.slice(0,2),16),
		green = parseInt(color.slice(2,4),16),
		blue = parseInt(color.slice(4,6),16),
		offset10 = parseInt(offset, 16);
	if(0.213 * red + 0.715 * green + 0.072 * blue < 128){		//dark or light condition is the same as for foreground color
		red = Math.min((red + offset10),255).toString(16);
		green = Math.min((green + offset10),255).toString(16);
		blue = Math.min((blue + offset10),255).toString(16)
	}else{
		red = Math.max((red - offset10),0).toString(16);
		green = Math.max((green - offset10),0).toString(16);
		blue = Math.max((blue - offset10),0).toString(16)
	}
	if(red.length < 2) red = '0' + red;				//take care of single-digit colors
	if(green.length < 2) green = '0' + green;
	if(blue.length < 2) blue = '0' + blue;
	return red + green + blue
}

function updateColor(){
	if(editTabColor.checked) {updateTabColor(true)}
	else if(editBgColor.checked) {updateBgColor(true)}
	else if(editBtnColor.checked) {updateBtnColor(true)}
	else {updateBoxColor(true)}
}

//global variables containing hex screen colors. Default is Light. Indices: 0 = tabs, 1 = background, 2 = buttons, 3 = boxes
var	fgColor = ['202128','000000','666666','000000'],
	fgColorStore = ['202128','000000','666666','000000'],
	bgColor = ['c6d5c6','ffffff','e6e6e6','fffff5'],
	bgColorStore = ['c6d5c6','ffffff','e6e6e6','fffff5'];

//gets color from picker and puts it into global variables
function getColor(i,isPicker){
	if(customStyle.checked){
		if(isPicker){
			bgColor[i] = colorPicker.value;
			fgColor[i] = foregColor(bgColor[i]);
			bgColorStore[i] = bgColor[i];
			fgColorStore[i] = fgColor[i]
		}else{
			bgColor[i] = bgColorStore[i];
			fgColor[i] = fgColorStore[i]
		}
	}
}

//change tab colors (index 0); first delete all rules, then re-make them according to the current color; first background, then text
function updateTabColor(isPicker){
	getColor(0,isPicker);
	while(tabSheet.cssRules.length) removeCSSRule(tabSheet,"ul#tabs");
	addCSSRule(tabSheet, "ul#tabs", "background-color:#" + bgColor[0]);
	addCSSRule(tabSheet, "ul#tabs li a", "background-color:#" + bgColor[0]);
	addCSSRule(tabSheet, "ul#tabs li a:hover", "background-color:#" + milder(bgColor[0],'22'));
	while(tabTextSheet.cssRules.length) removeCSSRule(tabTextSheet,"ul#tabs");
	addCSSRule(tabTextSheet, "ul#tabs li a", "color:#" + milder(fgColor[0],'22'))
}

//same for general background (index 1)
function updateBgColor(isPicker){
	getColor(1,isPicker);
	while(bgSheet.cssRules.length){
		removeCSSRule(bgSheet,"body");
		removeCSSRule(bgSheet,".block_page");
		removeCSSRule(bgSheet,".white_content");
		removeCSSRule(bgSheet,"ul#tabs");
		removeCSSRule(bgSheet,"div.tabContent");
		removeCSSRule(bgSheet,".helpHeading:hover")
	}
	addCSSRule(bgSheet, "body", "background-color:#" + bgColor[1]);
	addCSSRule(bgSheet, ".block_page", "background-color:#" + bgColor[1]);
	addCSSRule(bgSheet, ".white_content", "background-color:#" + bgColor[1]);
	addCSSRule(bgSheet, "ul#tabs li a.selected", "background-color:#" + bgColor[1]);
	addCSSRule(bgSheet, "div.tabContent", "background-color:#" + bgColor[1]);
	addCSSRule(bgSheet, ".helpHeading:hover", "background-color:#" + milder(bgColor[1],'11'));
	while(bgTextSheet.cssRules.length){
		removeCSSRule(bgTextSheet,"body");
		removeCSSRule(bgTextSheet,".block_page");
		removeCSSRule(bgTextSheet,".white_content");
		removeCSSRule(bgTextSheet,"ul#tabs");
		removeCSSRule(bgTextSheet,"div.tabContent")
	}
	addCSSRule(bgTextSheet, "body", "color:#" + fgColor[1]);
	addCSSRule(bgTextSheet, ".block_page", "color:#" + fgColor[1]);
	addCSSRule(bgTextSheet, ".white_content", "color:#" + fgColor[1]);
	addCSSRule(bgTextSheet, "ul#tabs li a.selected", "color:#" + fgColor[1]);
	addCSSRule(bgTextSheet, "div.tabContent", "color:#" + fgColor[1])
}

//and for buttons (index 2)
function updateBtnColor(isPicker){
	getColor(2,isPicker);
	while(btnSheet.cssRules.length){
		removeCSSRule(btnSheet,".cssbutton");
		removeCSSRule(btnSheet,".cssbutton:hover");
		removeCSSRule(btnSheet,"#toolBar1")
	}
	addCSSRule(btnSheet, ".cssbutton", "background-color:#" + bgColor[2]);
	addCSSRule(btnSheet, ".cssbutton:hover", "background-color:#" + milder(bgColor[2],'22'));
	addCSSRule(btnSheet, "#toolBar1", "background-color:#" + bgColor[2]);
	while(btnTextSheet.cssRules.length){
		removeCSSRule(btnTextSheet,".cssbutton")
	}
	addCSSRule(btnTextSheet, ".cssbutton", "color:#" + milder(fgColor[2],'28'));
	decryptBtn.style.color = '#' + fgColor[2];
	decryptBtnBasic.style.color = '#' + fgColor[2];
	decryptBtnEmail.style.color = '#' + fgColor[2];
}

//and for boxes (index 3)
function updateBoxColor(isPicker){
	getColor(3,isPicker);
	while(boxSheet.cssRules.length){
		removeCSSRule(boxSheet,".cssbox");
		removeCSSRule(boxSheet,"select")
	}
	addCSSRule(boxSheet, ".cssbox", "background-color:#" + bgColor[3]);
	addCSSRule(boxSheet, "select", "background-color:#" + bgColor[3]);
	while(boxTextSheet.cssRules.length){
		removeCSSRule(boxTextSheet,".cssbox");
		removeCSSRule(boxTextSheet,"select")
	}
	addCSSRule(boxTextSheet, ".cssbox", "color:#" + fgColor[3]);
	addCSSRule(boxTextSheet, "select", "color:#" + fgColor[3]);
}

//initialize color picker
function initPicker(){
	if(editTabColor.checked){
		colorPicker.color.fromString(bgColor[0])
	}else if(editBgColor.checked){
		colorPicker.color.fromString(bgColor[1])
	}else if(editBtnColor.checked){
		colorPicker.color.fromString(bgColor[2])
	}else {
		colorPicker.color.fromString(bgColor[3])
	}
}

//this loads the pre-selected color schemes from Options
function selectStyle(){
	if(liteStyle.checked){
		customColors.style.display = 'none';
		bgColor[0] = 'c6d5c6';
		fgColor[0] = '202128';
		bgColor[1] = 'ffffff';
		fgColor[1] = '000000';
		bgColor[2] = 'e6e6e6';
		fgColor[2] = '666666';
		bgColor[3] = 'fffff5';
		fgColor[3] = '000000';
		updateTabColor(false);
		updateBgColor(false);
		updateBtnColor(false);
		updateBoxColor(false)
	}else if(darkStyle.checked){
		customColors.style.display = 'none';
		bgColor[0] = '455245';
		fgColor[0] = 'e9e9e9';
		bgColor[1] = '000000';
		fgColor[1] = 'ffffff';
		bgColor[2] = '7b7b7b';
		fgColor[2] = 'eeeeee';
		bgColor[3] = '111111';
		fgColor[3] = 'ffffff';
		updateTabColor(false);
		updateBgColor(false);
		updateBtnColor(false);
		updateBoxColor(false)
	}else if(redStyle.checked){
		customColors.style.display = 'none';
		bgColor[0] = '000000';
		fgColor[0] = 'efefef';
		bgColor[1] = 'cc3300';
		fgColor[1] = 'ffffff';
		bgColor[2] = '663333';
		fgColor[2] = 'dddddd';
		bgColor[3] = 'ffcc99';
		fgColor[3] = '000000';
		updateTabColor(false);
		updateBgColor(false);
		updateBtnColor(false);
		updateBoxColor(false)
	}else if(greenStyle.checked){
		customColors.style.display = 'none';
		bgColor[0] = '9999cc';
		fgColor[0] = 'ffffff';
		bgColor[1] = '99cc99';
		fgColor[1] = '000000';
		bgColor[2] = 'ddddaa';
		fgColor[2] = '666666';
		bgColor[3] = 'ffffcc';
		fgColor[3] = '000000';
		updateTabColor(false);
		updateBgColor(false);
		updateBtnColor(false);
		updateBoxColor(false)
	}else if(blueStyle.checked){
		customColors.style.display = 'none';
		bgColor[0] = '003399';
		fgColor[0] = 'efefef';
		bgColor[1] = '0099cc';
		fgColor[1] = 'ffffff';
		bgColor[2] = '1c57cc';
		fgColor[2] = 'dddddd';
		bgColor[3] = 'd7ffd7';
		fgColor[3] = '000000';
		updateTabColor(false);
		updateBgColor(false);
		updateBtnColor(false);
		updateBoxColor(false)
	}else{
		if(customColors.style.display == 'none'){
			customColors.style.display = 'block'
		}else{
			customColors.style.display = 'none'
		}
		bgColor[0] = bgColorStore[0];
		fgColor[0] = fgColorStore[0];
		updateTabColor(false);
		bgColor[1] = bgColorStore[1];
		fgColor[1] = fgColorStore[1];
		updateBgColor(false);
		bgColor[2] = bgColorStore[2];
		fgColor[2] = fgColorStore[2];
		updateBtnColor(false);
		bgColor[3] = bgColorStore[3];
		fgColor[3] = fgColorStore[3];
		updateBoxColor(false);
		initPicker()
	}
	checkboxStore()
}

//selects random colors for the custom setting
function randomColors(){
	editBoxColor.checked = true;
	for(var i=0; i<4; i++){
		bgColor[i] = Math.floor(Math.random()*16777216).toString(16);
		while(bgColor[i].length < 6) bgColor[i] = '0' + bgColor[i];
		fgColor[i] = foregColor(bgColor[i]);
		bgColorStore[i] = bgColor[i];
		fgColorStore[i] = fgColor[i]
	}
	initPicker();
	updateTabColor(false);
	updateBgColor(false);
	updateBtnColor(false);
	updateBoxColor(false)
}
//The main script in the head ends here.
</script><style></style><style></style><style></style><style></style><style></style><style></style><style></style><style></style>

<!--special functions that work only with Chrome apps and extensions-->
<script>
//to put Lock into sync storage
function syncChromeLock(name,data) {
	var syncName = userName + '.' + name,
    	jsonfile = {};
    jsonfile[syncName.toLowerCase()] = data;
    chrome.storage.sync.set(jsonfile);

	//now update the list, also in Chrome sync
	if(name != 'myself') updateChromeSyncList()
}

//to update the stored list
function updateChromeSyncList(){
	var ChromeSyncList = lockNames.join('|'),
		jsonfile2 = {};
	jsonfile2[userName + '.ChromeSyncList'] = ChromeSyncList;
	chrome.storage.sync.set(jsonfile2)
}

//to retrieve Lock from sync storage. The code specifying what to do with the item is here because the get operation is asynchronous
function getChromeLock(name) {
	var syncName = userName + '.' + name;
    chrome.storage.sync.get(syncName.toLowerCase(), function (obj){
		var lockdata = obj[syncName.toLowerCase()];
		if(lockdata){
			storeChromeLock(name,lockdata)
		}else if(name.slice(0,2) != '--'){
			var name2 = '--' + name.toLowerCase() + '--';			//it may be a List, so change the name and try again
			lockdata = obj[name2];
			getChromeLock(name2)
		}else{
			if (name.slice(0,2) == '--') name = name.slice(2,name.length-2);
			lockMsg.textContent = name + ' not found in Chrome sync'
		}
	})
}

//this one is called by the above function
function storeChromeLock(name,lockdata){
	locDir[name] = JSON.parse(lockdata);
	lockBox.textContent = removeHTMLtags(locDir[name][0]);			//extra precaution, in case something slipped in
	lockMsg.textContent = name + ' added from Chrome sync';
	locDir = sortObject(locDir);
	localStorage[userName] = JSON.stringify(locDir);
	lockNames = Object.keys(locDir);
	fillList();
	updateChromeSyncList()
}

//to completely remove an entry
function remChromeLock(name){
	var syncName = userName + '.' + name;
    chrome.storage.sync.remove(syncName.toLowerCase());
	updateChromeSyncList()
}

//this one controls an asynchronous loop
var asyncLoop = function(o){
    var i=-1;

    var loop = function(){
        i++;
        if(i==o.length){o.callback(); return;}
        o.functionToLoop(loop, i)
    }
    loop()		//init
}

//get Lock list	from Chrome sync, then call an asynchronous loop to retrieve the data
function retrieveAllSync(){
	var syncName = userName + '.ChromeSyncList';
	chrome.storage.sync.get(syncName, function(obj){
		var lockdata = obj[syncName];
		if(lockdata){
			var ChromeSyncList = lockdata.split('|');

//asynchronous loop to fill local directory
			asyncLoop({
				length : ChromeSyncList.length,

				functionToLoop : function(loop, i){
					if (ChromeSyncList[i] != 'myself'){
						var syncName2 = userName + '.' + ChromeSyncList[i];
						var lockdata2 = {};
						chrome.storage.sync.get(syncName2.toLowerCase(), function (obj) {
							lockdata2 = obj[syncName2.toLowerCase()];
							locDir[ChromeSyncList[i]] = JSON.parse(lockdata2);
							locDir = sortObject(locDir);
							localStorage[userName] = JSON.stringify(locDir);
							lockNames = Object.keys(locDir);
							fillList()
						})
					}
					loop()
    			},

    			callback : function(){	//not used here
				}
			})
//end of asynchronous loop, any code below won't wait for it to be done

		}
	})
}
</script>

</head>

<body>

<!--Tabs-->
<ul id="tabs">
  <li><a href="#mainTab" title="messages go here (alt-M)" accesskey="m" class="selected">Main</a></li>
  <li><a href="#optionsTab" title="several modes available (alt-O)" accesskey="o">Options</a></li>
  <li><a href="#helpTab" title="help for all functions (alt-M)" accesskey="h">Help</a></li>
</ul>

<!--Main tab-->
<div class="tabContent" id="mainTab">
  <div align="center"> <br>
    <div id="mainSpacer">
    <br>
    <br>
    </div>
    <!--message area and local directory box, plus buttons-->
    <div id="mainMsg" class="message" style="min-height: 20px;">Welcome to PassLok</div>
    <br>
    <br>
    <select class="cssbox" id="lockList" size="4" multiple="multiple" title="Hold Ctrl or cmd to select several items" style="padding: 4px; width: 30%;">
    	<option value="" disabled="disabled" selected="selected">Select recipients (ctrl-click for several):</option>
    </select>
    <button class="cssbutton" id="resetListBtn" value="resetList" title="reset selection (alt-0)" accesskey="0">Deselect</button>
    <button class="cssbutton" id="main2lockBtn" value="editLocks" title="add or edit items in the local directory (alt-E)" accesskey="e">Edit</button>
    <br>
    <br>

    <!--buttons above the main box-->
    <div id="basicBtnsTop" style="display: block;">
      <button class="cssbutton" id="decryptBtnBasic" value="Lock/Unlock" title="encrypt plain text in the box, decrypt encrypted text (alt-D)" accesskey="d">Encrypt</button><!--
--><button class="cssbutton" id="showLockBtnBasic" value="myLock" title="display your Lock or send email (alt-L)" accesskey="l">myLock</button>
    </div>
    <div id="emailBtnsTop">
      <button class="cssbutton" id="decryptBtnEmail" value="Lock/Unlock" title="encrypt plain text in the box, decrypt encrypted text (alt-D)" accesskey="d">Encrypt</button><!--
--><button class="cssbutton" id="stegoBtnEmail" value="Hide" title="hide box contents as text (alt-T)" accesskey="T">Txt hide</button><!--
--><label for="imageFileEmail" title="open dialog to select the cover image"><span class="cssbutton" id="imageFileEmailBtn" title="open image hiding functions (alt-I)" accesskey="i">Img hide</span></label><!--
--><input type="file" id="imageFileEmail">
    </div>
    <div id="mainBtnsTop">
      <button class="cssbutton" id="decryptBtn" value="Lock/Unlock" title="encrypt plain text in the box, decrypt encrypted text (alt-D)" accesskey="">Encrypt</button><!--
--><button class="cssbutton" id="verifyBtn" value="Seal/Unseal" title="add signature based on secret Key and box contents, or verify existing signature (alt-V)" accesskey="v">Seal</button><!--
--><button class="cssbutton" id="showLockBtn" value="myLock" title="display your Lock (alt-L)">myLock</button><!--
--><button class="cssbutton" id="main2extraBtn" value="More" title="replace main buttons with those for extra functions (alt-.)" accesskey=".">▼</button>
      <br>
    </div>
    <div id="extraButtonsTop" style="display: none;">
      <button class="cssbutton" id="stegoBtn" value="Stego" title="hide box contents as text, using method set in Options tab, or reveal hidden contents (alt-T)" accesskey="t">Text hide</button><!--
--><label for="imageFile" title="open dialog to select the cover image"><span class="cssbutton" id="imageFileBtn" title="open image hiding functions (alt-I)" accesskey="i">Image hide</span></label><!--
--><input type="file" id="imageFile"><!--
--><button class="cssbutton" id="secretShareBtn" value="Split/Join" title="split plain box contents into several random-looking parts, or rejoin parts in the box (alt-J)" accesskey="j">&nbsp;Split&nbsp;</button><!--
--><button class="cssbutton" id="extra2mainBtn" value="Less" title="return main buttons (alt-.)">▲</button>
      <br>
    </div>
  </div>

  <!--toolbar for rich text editing; this first section contains lists for style, fonts, etc.-->
  <div id="toolBar1">
    <select id="formatBlock" title="headings, etc.">
      <option selected="selected">- formatting -</option>
      <option value="h1">Title 1 &lt;h1&gt;</option>
      <option value="h2">Title 2 &lt;h2&gt;</option>
      <option value="h3">Title 3 &lt;h3&gt;</option>
      <option value="h4">Title 4 &lt;h4&gt;</option>
      <option value="h5">Title 5 &lt;h5&gt;</option>
      <option value="h6">Subtitle &lt;h6&gt;</option>
      <option value="p">Paragraph &lt;p&gt;</option>
      <option value="pre">Preformatted &lt;pre&gt;</option>
    </select>
    <select id="fontName" title="font type">
      <option class="heading" selected="selected">- font -</option>
      <option>Arial</option>
      <option>Arial Black</option>
      <option>Courier New</option>
      <option>Times New Roman</option>
      <option>Verdana</option>
      <option>Comic Sans MS</option>
      <option>Impact</option>
      <option>Trebuchet MS</option>
      <option>Symbol</option>
    </select>
    <select id="fontSize" title="font size">
      <option class="heading" selected="selected">- size -</option>
      <option value="1">Very small</option>
      <option value="2">A bit small</option>
      <option value="3">Normal</option>
      <option value="4">Medium-large</option>
      <option value="5">Big</option>
      <option value="6">Very big</option>
      <option value="7">Maximum</option>
    </select>
    <select id="foreColor" title="text color">
      <option class="heading" selected="selected">- color -</option>
      <option value="brown">Brown</option>
      <option value="red">Red</option>
      <option value="orange">Orange</option>
      <option value="green">Green</option>
      <option value="blue">Blue</option>
      <option value="purple">Violet</option>
      <option value="violet">Pink</option>
      <option value="yellow">Yellow</option>
      <option value="cyan">Cyan</option>
      <option value="white">White</option>
      <option value="gray">Gray</option>
      <option value="black">Black</option>
    </select>
    <select id="backColor" title="color behind the text">
      <option class="heading" selected="selected">- back color -</option>
      <option value="brown">Brown</option>
      <option value="red">Red</option>
      <option value="orange">Orange</option>
      <option value="green">Green</option>
      <option value="blue">Blue</option>
      <option value="purple">Violet</option>
      <option value="violet">Pink</option>
      <option value="yellow">Yellow</option>
      <option value="cyan">Cyan</option>
      <option value="white">White</option>
      <option value="gray">Gray</option>
      <option value="black">Black</option>
    </select>

    <!--rich text editing buttons; images are loaded as data-->
    <div id="toolBar2"> <img class="intLink" title="Bold" src="data:image/gif;base64,R0lGODlhFgAWAID/AMDAwAAAACH5BAEAAAAALAAAAAAWABYAQAInhI+pa+H9mJy0LhdgtrxzDG5WGFVk6aXqyk6Y9kXvKKNuLbb6zgMFADs="> <img class="intLink" title="Italic" src="data:image/gif;base64,R0lGODlhFgAWAKEDAAAAAF9vj5WIbf///yH5BAEAAAMALAAAAAAWABYAAAIjnI+py+0Po5x0gXvruEKHrF2BB1YiCWgbMFIYpsbyTNd2UwAAOw=="> <img class="intLink" title="Underline" src="data:image/gif;base64,R0lGODlhFgAWAKECAAAAAF9vj////////yH5BAEAAAIALAAAAAAWABYAAAIrlI+py+0Po5zUgAsEzvEeL4Ea15EiJJ5PSqJmuwKBEKgxVuXWtun+DwxCCgA7"> <img class="intLink" title="Strikethrough" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWBAMAAAA2mnEIAAAAGFBMVEUAAABGRkZxcXGrq6uOjo7CwsINDQ3p6emLJhauAAAAAXRSTlMAQObYZgAAAEVJREFUGNNjoCYoDjaBs1UZDGFMVmUGJhibXcidFa7GUVAVygpSUlJMS0uBqmFgFhSA6TVgYIOxmcUZ2BxgbEFnF2o6HQD3yAWvJ+vXvwAAAABJRU5ErkJggg=="> <img class="intLink" title="Subscript" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWBAMAAAA2mnEIAAAAGFBMVEUAAACCgoJISEh0pePr7/WgssrS0tLH1vP156UFAAAAAXRSTlMAQObYZgAAAElJREFUGNNjoB5gDBQRFICy2YQCAhNgEomqAghFSg5wNosSkniQGktwAURYlFEp2d0AIiyYpKTGbICwJBihnd2kBM5mNjagzPEAztoHvc+7u1sAAAAASUVORK5CYII="> <img class="intLink" title="Superscript" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWBAMAAAA2mnEIAAAAGFBMVEUAAACCgoJISEigssrr7/V0pePS0tLH1vPtoVcWAAAAAXRSTlMAQObYZgAAAEpJREFUGNNjoC5gCTaAs5ndAxASrBA2o6GIoICpA5jNJmhg6B5SApFPUhZgDQ2AalRyQBioJABnMxqpwYWFGZUMYMKCSUpqlDocAJ7SBzNIUMnCAAAAAElFTkSuQmCC"> <img class="intLink" title="Left align" src="data:image/gif;base64,R0lGODlhFgAWAID/AMDAwAAAACH5BAEAAAAALAAAAAAWABYAQAIghI+py+0Po5y02ouz3jL4D4JMGELkGYxo+qzl4nKyXAAAOw=="> <img class="intLink" title="Center align" src="data:image/gif;base64,R0lGODlhFgAWAID/AMDAwAAAACH5BAEAAAAALAAAAAAWABYAQAIfhI+py+0Po5y02ouz3jL4D4JOGI7kaZ5Bqn4sycVbAQA7"> <img class="intLink" title="Right align" src="data:image/gif;base64,R0lGODlhFgAWAID/AMDAwAAAACH5BAEAAAAALAAAAAAWABYAQAIghI+py+0Po5y02ouz3jL4D4JQGDLkGYxouqzl43JyVgAAOw=="> <img class="intLink" title="Justify" src="data:image/gif;base64,R0lGODlhFgAWAIAAAMDAwAAAACH5BAEAAAAALAAAAAAWABYAAAIghI+py+0Po2yh2nvnxNxq2XVfFHIjVGLnk2brC8fyXAAAOw=="> <img class="intLink" title="Numbered list" src="data:image/gif;base64,R0lGODlhFgAWAMIGAAAAADljwliE35GjuaezxtHa7P///////yH5BAEAAAcALAAAAAAWABYAAAM2eLrc/jDKSespwjoRFvggCBUBoTFBeq6QIAysQnRHaEOzyaZ07Lu9lUBnC0UGQU1K52s6n5oEADs="> <img class="intLink" title="Dotted list" src="data:image/gif;base64,R0lGODlhFgAWAMIGAAAAAB1ChF9vj1iE33mOrqezxv///////yH5BAEAAAcALAAAAAAWABYAAAMyeLrc/jDKSesppNhGRlBAKIZRERBbqm6YtnbfMY7lud64UwiuKnigGQliQuWOyKQykgAAOw=="> <img class="intLink" title="Quote" src="data:image/gif;base64,R0lGODlhFgAWAIQXAC1NqjFRjkBgmT9nqUJnsk9xrFJ7u2R9qmKBt1iGzHmOrm6Sz4OXw3Odz4Cl2ZSnw6KxyqO306K63bG70bTB0rDI3bvI4P///////////////////////////////////yH5BAEKAB8ALAAAAAAWABYAAAVP4CeOZGmeaKqubEs2CekkErvEI1zZuOgYFlakECEZFi0GgTGKEBATFmJAVXweVOoKEQgABB9IQDCmrLpjETrQQlhHjINrTq/b7/i8fp8PAQA7"> <img class="intLink" title="Delete indentation" src="data:image/gif;base64,R0lGODlhFgAWAMIHAAAAADljwliE35GjuaezxtDV3NHa7P///yH5BAEAAAcALAAAAAAWABYAAAM2eLrc/jDKCQG9F2i7u8agQgyK1z2EIBil+TWqEMxhMczsYVJ3e4ahk+sFnAgtxSQDqWw6n5cEADs="> <img class="intLink" title="Add indentation" src="data:image/gif;base64,R0lGODlhFgAWAOMIAAAAADljwl9vj1iE35GjuaezxtDV3NHa7P///////////////////////////////yH5BAEAAAgALAAAAAAWABYAAAQ7EMlJq704650B/x8gemMpgugwHJNZXodKsO5oqUOgo5KhBwWESyMQsCRDHu9VOyk5TM9zSpFSr9gsJwIAOw=="> <img class="intLink" title="Horizontal rule" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWBAMAAAA2mnEIAAAAGFBMVEUAAADIyMimpqbp6enz8/P8/PzZ2dldXV27aT9/AAAAAXRSTlMAQObYZgAAAD5JREFUGNNjoBg4GSDYSgpYFCQKgkECiC0aGuLi7GwsAGILKYGBABYt5QUwVoiZuJhJAITN6mxs7Apk0wIAACMpB/oWEo0pAAAAAElFTkSuQmCC"> <img class="intLink" title="Hyperlink" src="data:image/gif;base64,R0lGODlhFgAWAOMKAB1ChDRLY19vj3mOrpGjuaezxrCztb/I19Ha7Pv8/f///////////////////////yH5BAEKAA8ALAAAAAAWABYAAARY8MlJq7046827/2BYIQVhHg9pEgVGIklyDEUBy/RlE4FQF4dCj2AQXAiJQDCWQCAEBwIioEMQBgSAFhDAGghGi9XgHAhMNoSZgJkJei33UESv2+/4vD4TAQA7"> <img class="intLink" title="Remove hyperlink" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWBAMAAAA2mnEIAAAAGFBMVEUAAAD08fHXzcxjY2OMhoafn5+uLyrktrTVXxhsAAAAAXRSTlMAQObYZgAAAGxJREFUGNNjwAAFMAZjEkMCYyKUU6aQoAaTYU90TIcrFwBCCFANDWIKDVUAMZkcBUVZBQWDQGwWERcnJhcXETBbBUEyKzubsjobK4PYrEZCwsxCQqZgc4KNTVmMjQOQzIfbW5jOgOYehDspAwBt9Q/S3exo3wAAAABJRU5ErkJggg=="> <img class="intLink" title="Remove formatting" src="data:image/gif;base64,R0lGODlhFgAWAIQbAD04KTRLYzFRjlldZl9vj1dusY14WYODhpWIbbSVFY6O7IOXw5qbms+wUbCztca0ccS4kdDQjdTLtMrL1O3YitHa7OPcsd/f4PfvrvDv8Pv5xv///////////////////yH5BAEKAB8ALAAAAAAWABYAAAV84CeOZGmeaKqubMteyzK547QoBcFWTm/jgsHq4rhMLoxFIehQQSAWR+Z4IAyaJ0kEgtFoLIzLwRE4oCQWrxoTOTAIhMCZ0tVgMBQKZHAYyFEWEV14eQ8IflhnEHmFDQkAiSkQCI2PDC4QBg+OAJc0ewadNCOgo6anqKkoIQA7"> <img class="intLink" title="Undo" src="data:image/gif;base64,R0lGODlhFgAWAOMKADljwliE33mOrpGjuYKl8aezxqPD+7/I19DV3NHa7P///////////////////////yH5BAEKAA8ALAAAAAAWABYAAARR8MlJq7046807TkaYeJJBnES4EeUJvIGapWYAC0CsocQ7SDlWJkAkCA6ToMYWIARGQF3mRQVIEjkkSVLIbSfEwhdRIH4fh/DZMICe3/C4nBQBADs="> <img class="intLink" title="Redo" src="data:image/gif;base64,R0lGODlhFgAWAMIHAB1ChDljwl9vj1iE34Kl8aPD+7/I1////yH5BAEKAAcALAAAAAAWABYAAANKeLrc/jDKSesyphi7SiEgsVXZEATDICqBVJjpqWZt9NaEDNbQK1wCQsxlYnxMAImhyDoFAElJasRRvAZVRqqQXUy7Cgx4TC6bswkAOw==">
<label for="imgFile">
<img class="intLink" title="Insert image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAMAAABhEH5lAAAAbFBMVEUAAAAAAAAmJibm5uaJiYnZ2dnn5+e5ubmBgYHNzc3z8/Pr6+vW1ta2trZ/f3/y8vLQ0NDPz8/Dw8OgoKCOjo54eHgcHBwGBgb+/v7T09PIyMi+vr6srKyEhIRqampiYmJbW1tPT08qKioRERGLOctyAAAAAXRSTlMAQObYZgAAAHJJREFUGNOtzkkShCAQRNFKbLsVsZ3nWe9/R8EAYeHSv6u3qEh6qo0/TkUiKULNbCglfZGSjf0vCvWZLTmxwBBXVGG1NO2D+hoIQ6IHmrKrciJDfgxIBGbPId12E//pUjOiyHydCGtFyQG3kWTcc4ro1U7vPAUU4TAxJQAAAABJRU5ErkJggg==">
</label>
<input type="file" id="imgFile">
<label for="mainFile">
<img class="intLink" title="Load a file" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAMAAABhEH5lAAAATlBMVEUAAAAAAAD19fVcXFwbGxsTExP8/PzT09NxcXFaWlo4ODg1NTUEBAT5+fnw8PDr6+vU1NTIyMi+vr6Xl5dsbGxnZ2dXV1dISEghISEMDAw0f0rSAAAAAXRSTlMAQObYZgAAAFBJREFUGNO9yEkOgCAQBMBmUxDc9/9/VJ2EjgkHb9axcJuceqQRtMq4aAdWkDr6xtW5jJRFx2MBu23fdS7eG6Vz0U8VytrKmhMnVoDQlOfbBQLIAl4FF2fyAAAAAElFTkSuQmCC">
</label>
<input type="file" id="mainFile">
<img class="intLink" title="Download files" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAMAAADzapwJAAAAdVBMVEUAAAAfHx9GRkYAAAAPDw9aWlr+/v739/fHx8dpaWkEBAT7+/v29vby8vLu7u7Z2dm1tbWysrKtra2qqqqMjIxWVlZJSUk1NTUUFBQJCQnz8/Pq6uri4uLMzMzKysq+vr69vb2NjY16enpvb29hYWE9PT0rKytDpsqlAAAAAXRSTlMAQObYZgAAAHdJREFUGNO1zscOgCAMgGG0iIp77z3e/xEV05CoJJ78D9B86aHkO6bUuXBUnFWuig1q/sTs5PclyR7YpZ+vD+4rrSg3mJ7rFgWA9EZhcPmlbuyh1mCLr0vEO0CI7HPB2AgRTh43mORYMstBk3HaEqxZdFlmkZ87AICHBL2TAUCPAAAAAElFTkSuQmCC">
</div>
  </div>
  <div id="mainBox" class="cssbox" accesskey=";" placeholder="Write or paste your message here. You can use nice formatting and add images and files if you click Rich. To encrypt or decrypt, select the correspondents in the top box, then click the button. Add more correspondents by pasting their Locks in this box." style="height: 483px;" contenteditable="true"></div>
  <div align="center">
    <!--buttons below the main box-->
    <div id="mainbuttonsbot">
      <button class="cssbutton" id="niceEditBtn" value="Rich" title="toggle rich text editor (alt-R)" accesskey="r">Rich</button><!--
--><button class="cssbutton" id="selectMainBtn" value="Select" title="select the box content and copy it to clipboard">Copy</button><!--
--><button class="cssbutton" id="clearMainBtn" value="Clear" title="clear the text in the box">Clear</button><!--
--><button class="cssbutton" id="chatBtn" value="Chat" title="make a chat invitation or open it (alt-C)" accesskey="c">Chat</button><!--
--><button class="cssbutton" id="sendSMSBtn" value="SMS" title="mobile: open the default Texting app">SMS</button>
    </div>
    <br>
    <input type="radio" name="lockmodes" id="anonMode" title="anonymous encryption mode; recipient's Lock needed (alt-N)" accesskey="n" checked="checked">
    <span id="anonLabel">&nbsp;Anonymous&nbsp;&nbsp;</span>
    <input type="radio" name="lockmodes" id="signedMode" title="signed encryption mode; recipient needs the sender's Lock (alt-S)" accesskey="s">
    &nbsp; Signed &nbsp;&nbsp;
    <input type="radio" name="lockmodes" id="onceMode" title="Read-once encryption mode; messages become unreadable after being read once (alt-1)" accesskey="1">
    &nbsp; Read-once </div>
</div>

<!--Options tab-->
<div class="tabContent hide" id="optionsTab"> <br>
  <br>
  <br>
  <form name="optionchecks">
    &nbsp;&nbsp;<span id="modeLabel">Interface:&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <input type="radio" name="interfacemodes" id="basicMode" title="basic mode; only essential functions (alt-B)" accesskey="b" checked="checked">
    &nbsp; Basic&nbsp;&nbsp;
    <input type="radio" name="interfacemodes" id="advancedMode" title="advanced mode; all functions available (alt-A)" accesskey="a">
    &nbsp; Advanced&nbsp;&nbsp;
	<input type="radio" name="interfacemodes" id="emailMode" title="PassLok for Email compatible output">
    &nbsp; Email    
    <hr>
    &nbsp;&nbsp;Color scheme:&nbsp;&nbsp;&nbsp;&nbsp;
    <input type="radio" name="colormodes" id="liteStyle" title="switch back to default light style" checked="checked">
    &nbsp; Light&nbsp;&nbsp;
    <input type="radio" name="colormodes" id="darkStyle" title="switch to dark style">
    &nbsp; Dark <br>
    <br>
    &nbsp;&nbsp;
    <input type="radio" name="colormodes" id="redStyle" title="switch to red style">
    &nbsp; Red&nbsp;&nbsp;
    <input type="radio" name="colormodes" id="greenStyle" title="switch to green style">
    &nbsp; <span id="greenLabel">Green</span>&nbsp;&nbsp;
    <input type="radio" name="colormodes" id="blueStyle" title="switch to blue style">
    &nbsp; Blue&nbsp;&nbsp;
    <input type="radio" name="colormodes" id="customStyle" title="switch to custom style">
    &nbsp; <span id="customLabel">Custom</span>
    <div id="customColors"><br>
      Click to edit color:
      <input class="color {pickerPosition:'top', onImmediateChange:'updateColor();'}" id="colorPicker" title="click here to edit the color selected below" autocomplete="off" style="background-image: none; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0);" value="FFFFFF">
      &nbsp;
      <button type="button" class="cssbutton" id="rndColors" value="Random Colors" title="pick colors at random">Random</button>
      <br>
      <br>
      &nbsp;&nbsp;
      <input type="radio" name="colorareas" id="editTabColor" title="edit Tab color" checked="checked">
      &nbsp; Tabs&nbsp;&nbsp;
      <input type="radio" name="colorareas" id="editBgColor" title="edit Background color">
      &nbsp; <span id="backgroundLabel">Backg.</span>&nbsp;&nbsp;
      <input type="radio" name="colorareas" id="editBtnColor" title="edit Button color">
      &nbsp; Btns.&nbsp;&nbsp;
      <input type="radio" name="colorareas" id="editBoxColor" title="edit Box color">
      &nbsp; Box </div>
      <hr>
      &nbsp;&nbsp;<span id="otherLabel">Other:&nbsp;&nbsp;&nbsp;&nbsp;</span>
      <input type="checkbox" id="learnMode" title="get explanatory messages after buttons are pressed, but before functions are executed">
      &nbsp; Learn&nbsp;&nbsp;
      <input type="checkbox" id="decoyMode" title="second message added or retrieved" accesskey="">
      &nbsp; Hidden message<br><br>
      &nbsp;&nbsp;
      <input type="radio" name="lockType" id="ezLokMode" title="display easy to read Lock" checked="checked">
      &nbsp; ezLok&nbsp;&nbsp;
      <input type="radio" name="lockType" id="wordLockMode" title="display Lock made of words">
      &nbsp; Word Lock&nbsp;&nbsp;
      <input type="radio" name="lockType" id="normalLockMode" title="display base64 Lock">
      &nbsp; base64<br><br>  
      &nbsp;&nbsp; 
      <input type="checkbox" id="fileMode" title="output is turned into files" accesskey="">
      &nbsp; File output&nbsp;&nbsp;    
      <input type="radio" name="fileModes" id="binaryMode" title="output file is binary" checked="checked">
      &nbsp; Binary&nbsp;&nbsp;
      <input type="radio" name="fileModes" id="textMode" title="output file is text">
      &nbsp; Text
      <div id="specialEncryptModes">
      <br>
      &nbsp;&nbsp;
      <input type="radio" name="lenghtModes" id="longMode" title="encrypted message can be as long as it needs to be" checked="checked">
      &nbsp; Normal&nbsp;&nbsp;
      <input type="radio" name="lenghtModes" id="shortMode" title="encrypted message will fit within 160 characters">
      &nbsp; Short&nbsp;&nbsp;
      <input type="radio" name="lenghtModes" id="compatMode" title="encrypted message compatible with SeeOnce and URSA">
      &nbsp; Compatible
      </div>   
      <div id="syncCheck"> <br>&nbsp;&nbsp;
      <input type="checkbox" id="chromeSyncMode" title="sync through Chrome" checked="checked">
      &nbsp;Chrome sync </div>
      <div id="basicHideModes">   
      <hr>
      &nbsp;&nbsp;Text Hiding:&nbsp;&nbsp;
      <input type="radio" name="stegomodes" id="letterMode" title="hide item into letters" checked="checked">
      &nbsp; Letters&nbsp;&nbsp;
      <input type="radio" name="stegomodes" id="invisibleMode" title="hide item invisibly">
      &nbsp; Invisible
      </div>
      <div id="advancedModes">
      <br>&nbsp;&nbsp;
      <input type="radio" name="stegomodes" id="wordMode" title="hide item as individual words">
      &nbsp; Words&nbsp;&nbsp;
      <input type="radio" name="stegomodes" id="spaceMode" title="hide item in spaces between words">
      &nbsp; Spaces&nbsp;&nbsp;
      <input type="radio" name="stegomodes" id="sentenceMode" title="hide item as sentences">
      &nbsp; <span id="sentencesLabel">Sentences</span></div>
  </form>
  <div id="advancedBtns">
    <hr>
    &nbsp;&nbsp;<span id="optionMsg" class="message">Change Name, Key, etc.</span><br>
    <br>&nbsp;
    <button class="cssbutton" id="changeNameBtn" value="Change Name" title="re-store directory under a new User Name">Name</button><!--
   --><button class="cssbutton" id="changeKeyBtn" value="Change Key" title="re-encrypt directory with a new Key">Key</button><!--
   --><button class="cssbutton" id="changeEmailBtn" value="Change Email" title="change email/token">Email/token</button>
    <br>
    <br>
    &nbsp;&nbsp;Backup/Remove:<br>
    <br>&nbsp;
    <button class="cssbutton" id="backupSettingsBtn" value="Backup" title="backup and optionally reset options, including the email/token">Options only</button><!--
	--><button class="cssbutton" id="moveLockDBBtn" value="Move" title="archive entire local directory, then delete it">Whole Directory</button>
  </div>
</div>

<!--Help tab-->
<div class="tabContent hide" id="helpTab">
<br>
<div id="helpTop" style="display: block;">
<br>
<span id="helpmsg" class="message">For instructions on how to do things, click on each title.</span>
<br>

<!--search box, as an iframe-->
<iframe id="srchform2" src="javascript:'<html><body style=margin:0px; ><form action=&quot;javascript:void();&quot; onSubmit=if(this.t1.value!=&quot;&quot;)parent.findString(this.t1.value);return(false); ><input type=text id=t1 name=t1 placeholder=Text to find size=20><input type=submit name=b1 value=Search titles></form></body></html>'" border="0" scrolling="no" seamless="" width="220" height="60" frameborder="0"> </iframe>
</div>

<br>
<!--space so the items aren't buried below the fixed stuff-->

  <div id="helpSpace" style="display: block;"> <br>
    <br>
    <br>
    <br>
    <br>
  </div>
  <div id="helpTopMobile" style="display: none;">
    <p>For instructions on how to do things, click on each title below. Click again to hide.</p>
    <p>To get instructions as you click buttons in PassLok, check <strong>Learn</strong> on the <strong>Options</strong> tab.</p>
  </div>

  <!--the help items begin here-->
  <hr>
  <div class="helpHeading">
    <h3>What is PassLok?</h3>
  </div>
  <div class="helpText">
    <p>Before you do anything else, you may want to watch this 
three-minute video, which explains the essential concepts in a 
lighthearted way (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=UxgrES_CGcg" target="_blank">https://www.youtube.com/watch?v=UxgrES_CGcg</a></p>
    <ul>
      <li>PassLok locks text and files, and sets up secure real time chat sessions using strong <strong>end-to-end encryption</strong>.</li>
      <li>PassLok is based on Keys and Locks. You encrypt something with <strong>someone else's Lock</strong>, so only that person can decrypt it with his/her Key.</li>
      <li>Your Key is a short piece of text, which <strong>can be anything you want so you can remember it</strong>.</li>
      <li>The matching Lock is then made from your Key. It is impossible to get the Key or your email from the Lock.</li>
      <li>You should never give your Key to anyone. Your Lock, however, is meant to be distributed freely, like a phone number.</li>
    </ul>
    <p>This approach has a number of advantages over other privacy apps that you may be familiar with:</p>
    <ul>
      <li>PassLok does not involve a server, so nobody can possibly have your private data.</li>
      <li>The same code runs on computers, phones, and tablets to make it perfectly portable.</li>
      <li>You can use PassLok with your favorite email, texting app, or any program by cut and paste.</li>
      <li>PassLok does not need to store anything secret. The only secret is your Key, which stays in your head.</li>
      <li>You can use PassLok with a public or borrowed device as easily and safely as with your private phone or computer.</li>
      <li>Several users (or several identities) can coexist on the same device.</li>
    </ul>
    <p>PassLok is <strong>still in experimental phase</strong> since 
there has not been enough time for security experts to uncover possible 
flaws. Bear this in mind before entrusting critical secrets to it.</p>
    <p>If you find PassLok too difficult, you may want to try SeeOnce instead, from <a href="https://passlok.com/seeonce" target="_blank">https://passlok.com/seeonce</a>. <strong>SeeOnce</strong>
 implements the Read-once mode of PassLok plus one type of text hiding, 
but you never have to worry about maintaining a directory of Locks. Even
 easier is <strong>URSA</strong>, available at <a href="https://passlok.com/ursa" target="_blank">https://passlok.com/ursa</a>, which includes only the shared Key mode of PassLok. Finally, there's <strong>PassLok for Email</strong>, an extension for <a href="https://chrome.google.com/webstore/detail/passlok-for-email/ehakihemolfjgbbfhkbjgahppbhecclh" target="_blank">Chrome</a> and <a href="https://addons.mozilla.org/en-US/firefox/addon/passlok-for-email/" target="_blank">Firefox</a> that integrates with popular email services (currently Gmail, Yahoo, and Outlook), and <strong>PassLok Universal</strong>, very similar to PassLok for Email, but not restricted to any email service; these are its links for <a href="https://chrome.google.com/webstore/detail/passlok-universal/lbmlbnfgnbfppkfijbbpnecpglockled" target="_blank">Chrome</a> and <a href="https://addons.mozilla.org/en-US/firefox/addon/passlok-universal/" target="_blank">Firefox</a>. All of these apps are fully compatible with PassLok, although they may not be compatible with each other.</p>
    <p>And if you don't, you may want to try the <strong>PassLok Privacy</strong> extension for <a href="https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh" target="_blank">Chrome</a> and <a href="https://addons.mozilla.org/en-US/firefox/addon/passlok-privacy/" target="_blank">Firefox</a>,
 which is almost identical to this standalone app, except that it syncs 
seamlessly between computers and is impervious to other extensions that 
might be running on the browser. Finally, the whole PassLok Privacy is 
part of the <strong>FusionKey</strong> extension for <a href="https://chrome.google.com/webstore/detail/fusionkey/legnppmlegkibpinfjodjbejohblaaam" target="_blank">Chrome</a> and <a href="https://addons.mozilla.org/en-US/firefox/addon/fusionkey/" target="_blank">Firefox</a>, which integrates with any email service (not just the Big Three) and also includes the <strong>SynthPass</strong> password manager.</p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Invite others to PassLok</h3>
  </div>
  <div class="helpText">
    <p>Before you can communicate with others using PassLok, they must 
have obtained the app, come up with a secret Key (which they won't tell 
you), generated a Lock from it, and sent it back to you.</p>
    <p>You can tell others about PassLok any way you want, but PassLok 
can help you to start your network with a single keystroke, this way:</p>
    <p>1. Optionally, type a message in the main box. Don't write anything sensitive, since <strong>invitation messages are not secure</strong>.</p>
    <p>2. Click the <strong>Invite</strong> button. If nothing was 
written, a QR code will appear containing your Lock and a link to the 
app at passlok.com. You may want to stand by in order to guide people 
who scan the code through their initial set-up. Tap it to hide it.</p>
    <p>3. If something was written, you will be asked to confirm, and 
then a new page should open in your default email, containing a link to 
PassLok that includes your personal Lock plus your encrypted message and
 a short set of instructions. Edit it as needed, then write the 
recipients' email addresses and send it.</p>
    <p>This is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=0wTJWyd9s64" target="_blank">https://www.youtube.com/watch?v=0wTJWyd9s64</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>The QR code and the invitation link load the web version of 
PassLok, but pasting the message into any other version of PassLok, or 
opening the email in PassLok for Email, PassLok Universal, FusionKey, or
 SeeOnce works just as well. Invitations made in those apps can also be 
opened in PassLok Privacy.</p>
      <p>Those who get PassLok from your QR code or email invitation 
will have your Lock automatically stored in their directories, so they 
can encrypt items for you right away.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Learn how to use PassLok</h3>
  </div>
  <div class="helpText">
    <p>If you check the <strong>Learn</strong> box in the <strong>Options</strong> tab, a text explaining what is about to happen will pop up every time a button is clicked.</p>
    <p>And here are a few more resources you may want to check out:</p>
    <p>The Learn PassLok website at <a href="https://passlok.com/learn" target="_blank">https://passlok.com/learn</a> contains a working copy of PassLok and a number of lessons on the different things you can do with it.</p>
    <p>The PassLok information website at <a href="http://passlok.weebly.com/" target="_blank">http://passlok.weebly.com</a> contains a number of videos and PDF documents.</p>
    <p>The PassLok <a href="http://passlok.weebly.com/uploads/2/4/1/8/24187628/passlok_manual.pdf" target="_blank">manual in PDF format.</a></p>
    <p>If you want to learn what's under the hood, read the <a href="http://www.weebly.com/uploads/2/4/1/8/24187628/passlok_technical_document.pdf" target="_blank">PassLok technical document.</a></p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Change PassLok's look</h3>
  </div>
  <div class="helpText">
    <p>PassLok opens with the default Light colors. You can also select the Dark, Red, Green, and Blue schemes on the <strong>Options</strong> tab, or even make your own custom scheme, this way:</p>
    <p>1. Click Custom on <strong>Options</strong>.</p>
    <p>2. Select the  color you wish to modify: Tabs, Background, Buttons, or Boxes.</p>
    <p>3. Click the colored box, which will open a selector. Hue and saturation are set on the main area, brightness on the sidebar.</p>
    <p>4. Repeat steps 2 and 3 for each color type.</p>
    <p>PassLok will pick random colors if you click the <strong>Random</strong> button. You can then edit them using the selector.</p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>How to make a strong Key</h3>
  </div>
  <div class="helpText">
    <p>You should be able to <strong>remember your secret Key</strong> 
without having to write it down. PassLok does not store the Key 
anywhere. In fact, it deletes it from memory after five minutes of not 
being used.</p>
    <p>As you type your Key, PassLok displays a color-coded message 
telling you how strong it is. If you stop typing for a second, a 
mnemonic "Hashili" word based on your Key is displayed right under the 
strength score, to reassure you that you have typed the Key correctly, 
even if you cannot see it. Clicking the eye icon reveals the entire Key.</p>
    <p>Your Key will be stronger if it contains <strong>caPiTals</strong> in unusual places, <strong>numb3rs</strong>, and <strong>$ymbol$</strong>. If you use common words, <strong>miespell</strong> them to make harder a "dictionary attack." Break the words up with <strong>num334bers</strong> and <strong>sy#$%mbols</strong>.
 Avoid anything that might be easy to guess. PassLok knows frequently 
used words, but hackers' dictionaries are bigger. Do not use 
grammatically correct sentences, even if PassLok gives a big score.</p>
    <p>PassLok <strong>compensates for weak Keys by adding spurious computations</strong> and may even appear to have crashed. If PassLok is slow, this may be because your Key strength is less than Medium.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=JbNM_cf8My0" target="_blank">https://www.youtube.com/watch?v=JbNM_cf8My0</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>If you plan to use PassLok only with shared Keys, you do not 
need a secret Key at all. Simply Cancel when you are asked for your Key 
when PassLok starts, and write or paste the encryption Key into the 
lower box that appears when you you click the <strong>Edit</strong> button located next to the directory.</p>
      <p>If instead of a short shared Key you paste in a piece or text 
at least five times as long as the message to be encrypted, PassLok uses
 it in Pad mode, which theoretically is much more secure than the 
regular mode (more on this in a help item below).</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Get a hint to remember my Key</h3>
  </div>
  <div class="helpText">
    <p>If you are reading this, likely you have gained Guest access to PassLok by clicking <strong>Cancel</strong>
 at the Key entry screen. The good news is that you can still encrypt 
messages if you know the recipient's Lock or shared Key, verify 
signatures, and use the Locks stored in your local directory as well as 
all the auxiliary functions of PassLok. You can even seal items and 
display the matching Lock if you enter a Key when PassLok asks for it.</p>
    <p>The bad news is that  you cannot change anything stored in the 
local directory, and your use of it is limited to Locks. You cannot do 
anything that would involve your secret Key, such as decrypting messages
 encrypted with your Lock, or continuing a Read-once conversation in 
course.</p>
    <p>Well, we've got even worse news for you: we cannot help you to 
recover your secret Key, because PassLok never stored it or sent it out.
 There are no saved hints, either. If you forgot your Key, <strong>it's gone, along with all encrypted items in the local directory</strong>.</p>
    <p>But chances are you <em>almost</em> remember it, and are off by a
 few characters only. If you click the eye icon, a mnemonic "Hashili" 
word derived from it appears right above it. Perhaps you can recognize 
the correct Hashili word when you see it, which will help you to 
reconstruct your Key. For your security, the Hashili word alone is not 
enough to reconstruct the Key.</p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>Hopefully Guest mode will let you get by until you remember 
your secret Key. But if you want to get full access to PassLok with a 
new Key, here are the steps:</p>
      <p>1. Go to the <strong>Options</strong> tab.</p>
      <p>2. Click the Backup/Remove <strong>Options only</strong> box. When a popup asks for confirmation to delete your settings, click <strong>OK</strong>.</p>
      <p>3. Reload PassLok.</p>
      <p>4. The user selection screen will appear, and this time PassLok
 will accept whatever new Key and email or suchlike you want to give it 
for the user in question. Now you're back in business and can use 
PassLok with the new Key to seal, decrypt, store items in the local 
directory, etc.</p>
      <p>At this point, the only directory entry that will work fully is
 "myself". You can reset or delete the entries that don't work one by 
one, by typing each name in the directory Edit dialog and clicking <strong>Reset</strong> (leave essential data intact) or <strong>Delete</strong>
 (take out everything) when the name is recognized, or all at once by 
following the process described in a help item below, about "moving the 
entire local directory."</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Use a different Key temporarily</h3>
  </div>
  <div class="helpText">
    <p>For a given user name, there is only one "secret Key" that 
unlocks all the capabilities of PassLok, but if you are willing to 
accept a limited access to its functions, you can use a different Key 
for the session, or whenever PassLok asks you for the Key. This way:</p>
    <p>1. Select the user and enter the new Key in the box (optional).</p>
    <p>2. Click the <strong>Cancel</strong> button.</p>
    <p>3. If asked for your email etc., enter it and click <strong>OK</strong>. (the <strong>Random</strong> button will write a new random value, different from the original random token, if any, so beware)</p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>You can do pretty much everything, except things that would 
have involved the secret Key. You cannot modify anything in the local 
directory. When you reload PassLok and enter the correct Key, a warning 
will tell you that last session was run in Guest mode. If you don't 
select a user from the list, you won't have access to any stored Locks.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Make PassLok even more secure</h3>
  </div>
  <div class="helpText">
    <p>When you first opened PassLok, you were asked to optionally enter
 your email or similar public, easy to recall personal information. But 
if instead of entering your email you click the <strong>Random</strong> 
button next to the input box, an 43-character random token is used. This
 makes your Lock  much harder to crack, but it becomes tied to the 
device where it was created  (except for the Chrome and Firefox 
extensions, which can sync it across devices).</p>
    <p>To back up your random token to a safe place in case of accidental deletion or to be able to use a different device:</p>
    <p>1. Click the Backup/Remove <strong>Options only</strong> button on the <strong>Options</strong>
 tab (visible in the Advanced interface). A backup item bracketed by 
"PL**bak" tags appears on the main box, from where you can save it to 
file, copy it, email it, etc.</p>
    <p>2. Then a dialog asks you if you want to reset your settings. If you click <strong>OK</strong>, PassLok will restart as if it had never started before, except that the local directory remains intact.</p>
    <p>To restore the random token from a backup item, paste the packup into the main box and click <strong>Decrypt</strong>.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=4DjhIjU_nuM" target="_blank">https://www.youtube.com/watch?v=4DjhIjU_nuM</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>The reason for the email or other additional data is to combat 
the "rainbow table" attack, where hackers pre-compute Locks made from 
the words in a dictionary. This data is encrypted and stored along with 
other settings, so you won't need to enter it again. The Lock depends 
both on the Key and the email or random token; this adds extra security,
 but it also means that if the random token gets erased you will not be 
able to decrypt anything that was encrypted with your Lock. The backup 
item contains your settings, including the random token, 
double-encrypted by your secret Key. One reason to delete your settings 
while leaving the local directory intact is to be able to change the 
random token to a new value. You can also proceed without entering any 
email or token.</p>
      <p>If you plan to use both PassLok and PassLok for Email or 
PassLok Universal, it is best if you write your real email in this box, 
for in this case your PassLok Lock will be identical to the one used in 
those apps and you'll be able to use their main features 
interchangeably. This precaution is not necessary if you only use one of
 the versions.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Display the Lock matching your secret Key</h3>
  </div>
  <div class="helpText">
    <p>Click the <strong>myLock</strong> button on the <strong>Main</strong> tab. The Lock matching that Key will appear
      in the lower box, from where you can copy it or email it.</p>
    <p>Alternatively, you can click the <strong>Invite</strong> button 
with nothing displayed in the main box, and then a Lock-containing QR 
code will appear that others can scan with mobile devices. Tap it to 
make it go away.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=L00yybDzN6k" target="_blank">https://www.youtube.com/watch?v=L00yybDzN6k</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>By default, PassLok displays the Lock in ezLok format, 
consisting of 50 lowercase letters (except L) and numbers, so you can 
easily dictate it if necessary. On the <strong>Options</strong> tab, you
 can change this to Word format, consisting of 20 common words, or to 
base64 format like all other PassLok items, consisting of 43 numbers, 
letters (capital and smallcase) and special characters / or +<strong></strong>.
 PassLok for Email, PassLok Universal, and FusionKey are compatible with
 all Lock formats, but SeeOnce is compatible only with ezLoks. If you 
wrote your real email when asked about it in the initial wizard, rather 
than something else, then your Lock is the same as that used in those 
apps, and the encrypted items made by any flavor of PassLok can be 
decrypted in the other apps. This precaution is not necessary for 
SeeOnce.</p>
      <p>If you need to make a Lock for a different Key (for instance, 
in order to receive hidden messages), it is best if you start PassLok in
 Guest mode by clicking <strong>Cancel</strong> when you are first asked for your Key, which will make PassLok accept a different Key. Then click <strong>myLock</strong>
 and supply the new Key and your email, if requested (if you use a 
random token you will need to copy it before, by  clicking Change Email 
in Options).</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Encrypt a message with a Lock, to be decrypted with the matching Key (Anonymous mode)</h3>
  </div>
  <div class="helpText">
    <p>1. Make  sure <strong>Anonymous</strong> mode is selected at the bottom of the <strong>Main</strong> tab. This is the default.</p>
    <p>2. If the recipients' Locks have been previously stored in the directory, simply select their names in the top box of the <strong>Main</strong> tab. </p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the directory listing and paste the Locks, one per line, in the dialog that appears. Then click <strong>Done</strong>.</li>
    </ul>
    <p>3. Write or paste your message in the lower box of the <strong>Main</strong> tab. You can give it rich formatting or add images and files if you display the formatting toolbar by clicking the <strong>Rich</strong> button (non-mobile).</p>
    <p>4. Click the <strong>Encrypt</strong> button. The
      encrypted message will appear in the box, replacing the original message.</p>
    <p>Copy it and paste it into your
      communications program or click <strong>Email</strong> to open your default email. </p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=nBA5JNY4gmQ" target="_blank">https://www.youtube.com/watch?v=nBA5JNY4gmQ</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>This mode is called Anonymous not because it provides any 
protection against tracking over a network, but because the identity of 
the sender cannot be deduced from the encrypted message. This message 
can be decrypted only by someone having the Key matching one of the 
Locks selected. Alternatively, you can write the Locks' names, one per 
line, in the dialog that appears whn you click the Edit button. Or you 
can select a List, as described in an item below, in order to encrypt 
for all the recipients in the List. It is okay if the tags up to the 
"==" signs on the Lock are missing, or carriage returns have been added 
(such as for a video URL).</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Decrypt an Anonymous encrypted message (tags are PL**msa)</h3>
  </div>
  <div class="helpText">
    <p>1. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
    <p>2. If the message doesn't decrypt automatically, click the <strong>Decrypt</strong> button. The decrypted message
      will appear in the box, replacing the encrypted message.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=nBA5JNY4gmQ" target="_blank">https://www.youtube.com/watch?v=nBA5JNY4gmQ</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>It is okay if the message is broken up by
        carriage returns or is
        missing its tags. It doesn't matter which encryption mode is selected at the botton of the <strong>Main</strong> tab.</p>
      <p>Even though this encryption mode is not available in Email mode, Anonymous messages will decrypt fine even if Email mode is set.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Encrypt a message with a Lock, to be decrypted with the matching Key, and sign it with your secret Key (Signed mode)</h3>
  </div>
  <div class="helpText">
    <p>1. Make sure <strong>Signed</strong> mode is selected at the bottom of the <strong>Main</strong> tab.</p>
    <p>2. If the recipients' Locks have been previously stored in the directory, simply select their names in the top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the directory box and paste the Locks, one per line, in the dialog that appears. Then click <strong>Done</strong>.</li>
    </ul>
    <p>3. Write or paste your message in the lower box of the <strong>Main</strong> tab. You can give it rich formatting or add images and files if you display the formatting toolbar by clicking the <strong>Rich</strong> button (non-mobile).</p>
    <p>4. Click the <strong>Encrypt</strong> button. The
      encrypted message will appear in the box, replacing the original message.</p>
    <p>Copy it and paste it into your
      communications program or click <strong>Email</strong> to open your default email.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=R9UanENF3ro" target="_blank">https://www.youtube.com/watch?v=R9UanENF3ro</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p> This mode is called Signed not because a digital signature is 
involved, but because the message can be decrypted only by
        someone having the Key matching one of the Locks selected, and 
your Lock. This way, the recipient can be sure of who encrypted the 
message. Alternatively, you can also write the names, one per line, in 
the dialog that appears when you click the Edit button. You can also 
encrypt for all the recipients in a List by selecting a List name. It is
 okay to strip the tags up to the "==" signs, but not recommended.  It 
is also okay to split the encrypted message with line returns. This 
message can be decrypted only by someone having the Key matching the 
Lock used to encrypt it. Additionally, they must have your Lock in order
 to verify that it comes from you.</p>
      <p>Messages encrypted in this mode can be decrypted by PassLok for
 Email and PassLok Universal, if the Email mode checkbox is checked in 
Options before the message is encrypted.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Decrypt a Signed message   (tags are PL**mss)</h3>
  </div>
  <div class="helpText">
    <p>1. If the sender's Lock has been previously stored in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the directory box and paste the sender's Lock in the dialog that appears. Then click <strong>Done</strong>.</li>
    </ul>
    <p>2. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
    <p>3. If the message doesn't decrypt automatically, click the <strong>Decrypt</strong> button. The decrypted message
      will replace the encrypted message.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=R9UanENF3ro" target="_blank">https://www.youtube.com/watch?v=R9UanENF3ro</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>It is okay if the message is broken up by carriage returns or 
is missing its tags.  It doesn't matter which encryption mode is 
selected at the botton of the <strong>Main</strong> tab.</p>
      <p> A message encrypted by PassLok for Email or PassLok Universal 
in normal mode will be decrypted by PassLok in Signed mode. Just paste 
it in and supply a name for the included ezLok, if requested.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Encrypt a message so that nobody can read it after the exchange is over (Read-once mode)</h3>
  </div>
  <div class="helpText">
    <p>1. Make sure <strong>Read-once</strong> mode is selected at the bottom of the <strong>Main</strong> tab.</p>
    <p>2. Select the recipients' Locks in the top box of the <strong>Main</strong> tab. This mode requires the recipients' Locks to be previously stored in the local directory. </p>
    <p>3. Write or paste your message in the lower box of the <strong>Main</strong> tab. You can give it rich formatting or add images and files if you display the formatting toolbar by clicking the <strong>Rich</strong> button (non-mobile).</p>
    <p>4. Click the <strong>Encrypt</strong> button. The
      encrypted message will appear in the box, replacing the original message.</p>
    <p>Copy it and paste it into your
      communications program or click <strong>Email</strong> to open your default email.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=VutWfWZW5bY" target="_blank">https://www.youtube.com/watch?v=VutWfWZW5bY</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>This message can be decrypted only by someone having the Key 
matching one of the Locks selected, and your Lock, and then typically 
only once. In order to restart a Read-once conversation that has gone 
out of sync, clear the old data for that recipient by clicking the <strong>Reset</strong> button in the directory <strong>Edit</strong>
 dialog  after the recipient's name is displayed above the box (you may 
have to type the name in the box for this to happen), then encrypt the 
message normally. The first message after a reset does not have forward 
secrecy, so be careful with this one. To encrypt for all recipients in a
 List, select the List in the top box of the Main screen. It is okay to 
strip the Lock tags up to the "==" signs, but not recommended.  It is 
also okay to split the encrypted message with line returns.</p>
      <p>Messages encrypted in this mode can be read in SeeOnce if Compatibility mode is checked in Options.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Decrypt a message that was encrypted in Read-once mode (tags are PL**mso)</h3>
  </div>
  <div class="helpText">
    <p>1. Select the sender's Lock on the top box of the <strong>Main</strong> tab. This mode requires the sender's Lock to be previously stored in the device's local directory.</p>
    <p>2. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
    <p>3. If the message doesn't decrypt automatically, click the <strong>Decrypt</strong> button. The decrypted message
      will replace the encrypted message.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=VutWfWZW5bY" target="_blank">https://www.youtube.com/watch?v=VutWfWZW5bY</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>Usually you can decrypt the message only once, since the 
ephemeral key needed to decrypt it is overwritten in the process, but 
after a reset the first message can be decrypted forever, and the second
 becomes undecryptable only after it is replied to.  It is okay if the 
message is broken up by carriage returns or is missing its tags. It 
doesn't matter which encryption mode is selected at the botton of the <strong>Main</strong> tab.</p>
      <p>A message encrypted by PassLok for Email or PassLok Universal 
in Read-once mode can be decrypted by PassLok in this mode. Just paste 
it in and supply a name for the included ezLok, if requested. Same if it
 was encrypted in SeeOnce.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Reset a Read-once conversation</h3>
  </div>
  <div class="helpText">
    <p>This may be needed if the conversation with a given correspondent
 has gone out of sync so that you are unable to decrypt a new Read-once 
message from this person. Resetting clears ephemeral Keys and Locks on 
both sides, and re-initiates the Read-once exchange.
    </p><p>1. Click the <strong>Edit</strong> button next to the Lock selection box.</p>
    <p>2. Start writing the name given to the correspondent in the 
dialog. As you type, the line above the box displays existing items 
matching what you have typed so far. You can stop typing once you see 
the complete name you're looking for. Search is case-insensitive.</p>
    <p>3. Click the <strong>Reset</strong> button. A popup asks you to confirm the action, and then a message tells you that it has been done.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=VutWfWZW5bY" target="_blank">https://www.youtube.com/watch?v=VutWfWZW5bY</a></p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Send a PassLok item (Lock, encrypted message, etc.) by email</h3>
  </div>
  <div class="helpText">
    <p>1. Check that the item displayed on the <strong>Main</strong> tab is PassLok output. If it is not, the button you need to press in the next step won't be there.</p>
    <p>2. Click the <strong>Email</strong> button. If the device is so 
configured, a window appears containing the item and some explanatory 
text. You only need to supply the recipient's email address and a 
subject line before clicking the Send button.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=LsljKvjAi9I" target="_blank">https://www.youtube.com/watch?v=LsljKvjAi9I</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>Be aware that there is a limit to the size of a message that is
 made this way. If you get an error, you can always copy the contents of
 the box and paste it into a normal mail compose screen.The email 
includes a link that, if clicked, will open the contents in the web app 
version of PassLok. To open it in a different email client or in case 
the button is not visible or the new window fails to appear, copy it to 
the clipboard and then paste it into the "compose" box of your favorite 
email.</p>
      <p>If the recipient is going to use PassLok for Email or PassLok 
Universal rather than this standalone version of PassLok or FusionKey, 
you'll make things easier if you switch to Email mode in Options before 
you click <strong>Encrypt</strong>.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Send a PassLok item by Text messaging</h3>
  </div>
  <div class="helpText">
    <p>1. Check that the item to be sent is displayed on the <strong>Main</strong> tab. Usually it will have been produced with <strong>Short</strong> mode selected in <strong>Options</strong>, to make sure it fits in a single message.</p>
    <p>2. Tap the button dealing with text messaging, which is labeled <strong>SMS</strong>. A window appears with the default texting app (setting it in a computer up may require additional steps).</p>
    <p>3. Tap the input box and then paste the clipboard, which will contain the encrypted message. Send the message in the usual way.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=LsljKvjAi9I" target="_blank">https://www.youtube.com/watch?v=LsljKvjAi9I</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>To decrypt a encrypted message received by texting, you must first copy it to the clipboard, and then paste it on the <strong>Main</strong>
 tab of PassLok. Due to browser restrictions, there is no way to know 
whether the item has been copied to clipboard, but hopefully the process
 above is fairly foolproof.  (Advanced) If you want to make sure the 
encrypted message fits within a single text message, encrypt it with the
 <strong>Short</strong> option on.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Load files to be encrypted, sealed, or split</h3>
  </div>
  <div class="helpText">
    <p>1. The button to load files is near the right end of the formatting toolbar, which is displayed by clicking the <strong>Rich</strong> button. It looks like this: <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAMAAABhEH5lAAAATlBMVEUAAAAAAAD19fVcXFwbGxsTExP8/PzT09NxcXFaWlo4ODg1NTUEBAT5+fnw8PDr6+vU1NTIyMi+vr6Xl5dsbGxnZ2dXV1dISEghISEMDAw0f0rSAAAAAXRSTlMAQObYZgAAAFBJREFUGNO9yEkOgCAQBMBmUxDc9/9/VJ2EjgkHb9axcJuceqQRtMq4aAdWkDr6xtW5jJRFx2MBu23fdS7eG6Vz0U8VytrKmhMnVoDQlOfbBQLIAl4FF2fyAAAAAElFTkSuQmCC"></p>
    <p>2. When you click it, a dialog will appear so you can navigate to
 the file. If all goes well, the file loads into the box as a link. You 
will see only its name, but the whole file is actually in there.</p>
    <p>Now you can encrypt it, seal it, or split it just like a 
text-based message. You can also add more files if you want. The process
 to retrieve the original files is explained in the help item below.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=tPeUv6BRTrg" target="_blank">https://www.youtube.com/watch?v=tPeUv6BRTrg</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p> If the file is a text file, it will load as plain text rather 
than as a link. Be aware that mobile devices (especially in iOS) often 
place severe restrictions on accessing stored content. If using a 
Chromebook, be aware that the Files extension does not load Google 
documents completely; save the file locally in a different format and 
try loading it again.</p>
      <p>You can also put images in your message, by clicking the button
 immediately to the left of the one to load files. In this case the 
content is displayed as an image rather than a link.</p>
      <p>If you plan to send large files by email or other means, it is 
best to encrypt them with an archiving program such as 7zip, Winzip, or 
Winrar (Windows), Keka (OSX), or p7zip (Linux) using AES and a random 
symmetric key, and then use PassLok to encrypt that symmetric key for 
transmission, along with the encrypted files as attachments.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Retrieve a file that has just been decrypted, unsealed, of joined</h3>
  </div>
  <div class="helpText">
    <p>1. Make sure the file appears as a link on the Main box.</p>
    <p>2. A button below the Main box will be labeled <strong>Save</strong>. Click it to download all the files in the Main box. You can also use the rightmost button on the toolbar.</p>
    <p>3. For small enough files, you can also right-click on its link and select the <strong>Save link as</strong> option. The file will be saved at the location you select.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=tPeUv6BRTrg" target="_blank">https://www.youtube.com/watch?v=tPeUv6BRTrg</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>Chrome does not display the <strong>Save link as</strong> 
option if the file is larger than 1.5MB. Be aware that mobile devices 
(especially on iOS) place severe restrictions on what files can be 
saved, and where.</p>
    </div>
  </div>
    <hr>
    <div class="helpHeading">
      <h3>File output</h3>
    </div>
    <div class="helpText">
      <p>If you select <strong>File output</strong> on the <strong>Options</strong>
 tab before encrypting, sealing, or splitting, the result of the 
operation appears as a file (several, in the case of splitting), which 
you can then save anywhere with the Save button. Doing this will speed 
up things considerably if you are encrypting, sealing, or splitting 
something large.</p>
      <p>The file can be either binary with extension .plk (default), or text with extension .txt. This can be selected on the <strong>Options</strong> tab.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=Sm4f6FIOShI" target="_blank">https://www.youtube.com/watch?v=Sm4f6FIOShI</a></p>
     <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
     <p>An output item loaded as a file can be decrypted, unsealed, or 
joined just like an item loaded as text. It can also be sent by email as
 an attachment, which is handy when the item is large. Feel free to 
change the file name or extension to something else, but to decrypt, 
unseal, or join files made this way, you must make sure the extension is
 .plk or .txt before you load them or PassLok may fail to recognize them
 as its own output. Be aware that mobile devices (especially on iOS) 
often make it difficult to work with files.</p>
    </div>
    </div>
  <hr>
  <div class="helpHeading">
    <h3>Make an invitation to join a real-time multi-party chat session</h3>
  </div>
  <div class="helpText">
    <p>1. Select the other participants in the chat on the list at the top of the <strong>Main</strong> tab. You are added automatically.</p>
    <p>2. Click the <strong>Chat</strong> button, which is below the 
box. A dialog will appear asking you whether this chat is going to 
involve text and files only, or also will involve audio, or  video, or 
be hosted by Jitsi, an open-source videoconference service. There is 
also a text box where you can optionally type something that will be 
shown to the users (such as the date and time for the chat) before they 
join the chat.</p>
    <p>3. Supply the required information and click <strong>OK</strong>. If the main box did not contain a chat invitation, a new one is generated and placed there. You can now email it with the <strong>Email</strong> button, or send it out by any other means.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=XytUN0T_2zQ">https://www.youtube.com/watch?v=XytUN0T_2zQ</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p> Please tell participants about the time for the chat. When the
 time comes, you will join the chat using the same invitation as the 
other parties, so make sure to save it somewhere. All browsers can make a
 chat invitation, but some (Internet Explorer, Safari, native Android 
app, anything on iOS) don't support joining the actual chat.</p>
      <p>PassLok chat invitations can be decrypted in PassLok for Email,
 PassLok Universal, and FusionKey, and vice-versa. If you set encrypt 
Compatible mode in Options before encryption, they can be decrypted in 
SeeOnce (Read-once only) or URSA as well.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Use an invitation to join a real-time chat session (tags are PL**chat)</h3>
  </div>
  <div class="helpText">
    <p>1. Place the invitation in the Main box and click the <strong>Chat</strong> or the <strong>Decrypt</strong> button. If the sender added a message, it will be displayed and you will have to click <strong>OK</strong> to go on, or <strong>Cancel</strong> to try later.</p>
    <p>2. A new screen opens. Write the name you want to use for the 
chat in the top box, check that the type of chat offered is what 
everyone agreed on, and then click<strong> Join</strong>.</p>
    <p>3. As participants join the chat session, their chosen names will
 appear at the top of the chat screen (or a randomly-chosen tag, if they
 didn't supply a name). You can then post text by writing it in the Text
 box, followed by Enter. You can also post files by clicking the Browse 
or Files button.</p>
    <p>4. If the chat involves audio or video, you may be asked to give 
permission to access you microphone and camera. After you grant it, you 
will see or hear the other participants as they join, and likely 
yourself too. Jitsi chats are the most polished, but participants 
connect through a server rather than one-on-one as in the other types.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=XytUN0T_2zQ">https://www.youtube.com/watch?v=XytUN0T_2zQ</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p> Connections between participants are direct in all chat types 
except Jitsi, but a signaling server is used at the start so the 
participants can find one another, and then it is contacted no more. 
PassLok will remind you that this may lead to your being tracked. The 
connection will stay alive until all the participants leave. If things 
get out of hand, you can always reset your session by reloading the chat
 page. At that point you'll have the chance to change the kind of chat 
if you so desire.</p>
      <p>Browsers are not equal as far as support for chat: Firefox and 
Chrome are the best, followed by the Android browser, Maxthon, and then 
Opera (with problems). Internet Explorer, Tor, Safari, and anything on 
iOS don't yet support joining a chat, though you can make a chat 
invitation from them.</p>
      <p>PassLok can open chat invitations made in SeeOnce and URSA.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Encrypt a message with a shared Key, to be decrypted with the same Key</h3>
  </div>
  <div class="helpText">
    <p>1. Make sure the <strong>Anonymous</strong> or <strong>Signed</strong> mode is selected at the bottom of the <strong>Main</strong> tab.</p>
    <p>2. If the Keys shared with each of the recipients have been 
previously stored in the local directory, simply select their names in 
the top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the 
directory box and paste the shared Keys, one per line, in the dialog 
that appears. You can mix shared Keys and Locks. Then click <strong>Done</strong>.</li>
    </ul>
    <p>3. Write or paste the message in the lower box of the <strong>Main</strong> tab.</p>
    <p>4. Click the <strong>Encrypt</strong> button. The
      encrypted message will appear in the box, replacing the original text.</p>
    <p>Copy it and paste it into your
      communications program or click <strong>Email</strong> to open your default email program. </p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number):<a href="https://www.youtube.com/watch?v=sRdpWe4zya8" target="_blank">https://www.youtube.com/watch?v=sRdpWe4zya8</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>This message can be decrypted only by someone having the same 
shared Key. It does not matter whether Anonymous or Signed mode is 
selected,  since they use shared Keys identically. It is okay to strip 
the tags up to the "==" signs, but not recommended. It is also okay to 
split the encrypted message with line returns. The tags will depend on 
the encryption mode selected. There is no special tag to indicate that a
 shared Key was used instead of a Lock.</p>
      <p>Messages encrypted with a shared Key can be decrypted in 
PassLok for Email, PassLok Universal, and FusionKey as well. They can be
 decrypted in URSA if Short or Compatible mode are chosen in Options 
prior to encryption.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Decrypt a message encrypted with a shared Key</h3>
  </div>
  <div class="helpText">
    <p>1. If the Key shared with the sender has been previously stored 
in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the directory box and paste the shared Key in the dialog that appears. Then click <strong>Done</strong>.</li>
    </ul>
    <p>2. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
    <p>3. If the message does not decrypt automatically, click the <strong>Decrypt</strong> button. The decrypted message
      will appear in the main box, replacing the encrypted message.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number):<a href="https://www.youtube.com/watch?v=sRdpWe4zya8" target="_blank">https://www.youtube.com/watch?v=sRdpWe4zya8</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>It is okay if the message is broken up by
        carriage returns or is
        missing its tags. It doesn't matter which encryption mode is selected at the botton of the <strong>Main</strong> tab.</p>
      <p>Messages encrypted with URSA can be decrypted in PassLok, using this procedure.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Encrypt a message with a Pad, to be decrypted with the same Pad</h3>
  </div>
  <div class="helpText">
    <p>1. Copy the text to be used as Pad from its source. It should be 
at least five times as long as the message, or Pad mode won't engage. 
You can also load a whole file that is at least five times as long as 
the message.</p>
    <p>2. Click the <strong>Edit</strong> button next to the directory 
box and paste the shared Pad in the dialog that appears. You can also 
load a file by means of a button visible in the Advanced interface. Then
 click <strong>Done</strong>.</p>
    <p>3. Write the message in the lower box of the <strong>Main</strong> tab.</p>
    <p>4. Click the <strong>Encrypt</strong> button. If Pad mode is 
engaged, a popup will ask for the starting position in the Pad, 
otherwise encryption will proceed using the regular shared Key mode (a 
warning popup will appear if there are several paragraphs).</p>
    <p>5. Write a number within the range given in the dialog and click <strong>OK</strong>. The
    encrypted message will appear in the box, replacing the original text.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=BEXYuaCxciM" target="_blank">https://www.youtube.com/watch?v=BEXYuaCxciM</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>Pad mode is <em>theoretically impossible to break</em>, even by
 brute force. Use it when you need utmost security. The text material 
can be taken from a digital book, for instance. You may transmit in 
plaintext the page number and starting position, so long as the text 
source is kept secret.</p>
      <p>It is okay to split the encrypted message with line returns or 
to eliminate the tags at either end. It doesn't matter which encryption 
mode is selected at the botton of the <strong>Main</strong> tab.</p>
      <p>Messages encrypted this way can also be decrypted in URSA.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Decrypt a message encrypted with a Pad (tags are PL**msp)</h3>
  </div>
  <div class="helpText">
    <p>1. Copy the text to be used as Pad from its source. It should be 
at least five times as long as the message, or Pad mode won't engage. 
You can also load a whole file that is at least five times as long as 
the message.</p>
    <p>2. Click the <strong>Edit</strong> button next to the directory 
box and paste the shared Pad in the dialog that appears. You can also 
load a file by means of a button visible in the Advanced interface. Then
 click <strong>Done</strong>.</p>
    <p>3. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
    <p>4. Click the <strong>Decrypt</strong> button if decrypting does not start automatically. A popup will ask for the starting position in the Pad.</p>
    <p>5. Write the numerical starting position in the popup and click <strong>OK</strong>. The decrypted message will appear in the main box, replacing the encrypted message.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=BEXYuaCxciM" target="_blank">https://www.youtube.com/watch?v=BEXYuaCxciM</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>It is okay if the message is broken up by
        carriage returns or is
        missing its tags. It doesn't matter which encryption mode is selected at the botton of the <strong>Main</strong> tab.</p>
      <p>URSA messages encrypted this way can also be decrypted in PassLok.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Encrypt in Human mode, so it can be decrypted by hand</h3>
  </div>
  <div class="helpText">
  	<p>1. If the three-part Key shared with the recipient has been 
previously stored in the local directory, simply select its name in the 
top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the directory box and type the Human mode Key, which consists of <em>three strings separated by tildes </em>"~". Then click <strong>Done</strong>.    </li>
    </ul>
    <p>2. Write the message in the lower box of the <strong>Main</strong> tab. This mode understands only Latin characters, and removes any accents and diacritic marks. </p>
    <p>3. Click the <strong>Encrypt</strong> button.    </p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=npROBlHjxmc" target="_blank">https://www.youtube.com/watch?v=npROBlHjxmc</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>This mode engages automatically if the Key consists of three 
strings separated by tildes. If you have a single string, write two 
tildes after it in order to use this mode. It doesn't matter which 
encryption mode is selected at the botton of the <strong>Main</strong> tab or on the <strong>Options</strong> tab.</p>
      <p>The method is described in detail in this page, which can also encrypt and decrypt messages: <a href="https://passlok.com/human" target="_blank">https://passlok.com/human</a>.
 URSA can also encrypt and decrypt in this mode. Even though encryption 
and decryption can be performed without a computer, security against 
computer-based cryptanalysis is comparable to that of computer-based 
ciphers.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Decrypt a message encrypted in Human mode (tags are PL**msh)</h3>
  </div>
  <div class="helpText">
    <p>1. If the three-part Key shared with the recipient has been 
previously stored in the local directory, simply select its name in the 
top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, click the <strong>Edit</strong> button next to the directory box and type the Human mode Key, which consists of <em>three strings separated by tildes </em>"~". Then click <strong>Done</strong>.</li>
    </ul>
    <p>2. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
    <p>3. Click the <strong>Decrypt</strong> button if decrypting does 
not start automatically. Unlike in other modes, you won't get a message 
telling you whether or not the decryption has been successful.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=npROBlHjxmc" target="_blank">https://www.youtube.com/watch?v=npROBlHjxmc</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>It is okay if the message is broken up by carriage returns or 
is missing its tags. It doesn't matter which encryption mode is selected
 at the botton of the <strong>Main</strong> tab.</p>
      <p>If you want to learn how to encrypt or decrypt in this mode, 
using simply paper and pencil, look at the instructions in this page, 
which also does encryption and decryption: <a href="https://passlok.com/human" target="_blank">https://passlok.com/human</a>. URSA can also encrypt and decrypt in this mode.</p>
    </div>
  </div> 
  <hr>
  <div class="helpHeading">
    <h3>Add a Lock or shared Key to the local directory</h3>
  </div>
  <div class="helpText">
    <p>From the <strong>Main</strong> tab (this works only for Locks):</p>
    <p>1. Paste the Lock into the Main box. If the item is identified as a Lock, a prompt will ask you to give it a name.</p>
    <p>2. Write a name in the prompt box and click <strong>OK</strong>. You will see the name added to the selection box at the top of the <strong>Main</strong> tab.</p>
    <p>From the directory Edit dialog:</p>
    <p>1. Cick the <strong>Edit</strong> button next to the directory box.    </p>
    <p>2. Paste the Lock or shared Key in the box, replacing whatever 
was there before. Usually PassLok will recognize a Lock and display a 
message saying so.</p>
    <p>3. Click the <strong>Save</strong> button. A popup will ask you to provide a name for the item.</p>
    <p>4. Write the name and click <strong>OK</strong>. A message confirms that the item has been saved under the name given.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=vQrED7eIkLA" target="_blank">https://www.youtube.com/watch?v=vQrED7eIkLA</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>If the given name is already in the directory, the Lock or 
shared Key will be replaced rather than added. You can store a cover 
text or a List besides an individual's Lock or shared Key. In the case 
of a List, the given name will be displayed bracketed by double dashes. 
Items that are not Locks are stored encrypted. When you load PassLok 
from an email link, a popup may open asking you to accept saving the 
sender's Lock to your directory. You can change its name at this point.</p>
      <p>(<em>Chrome/Firefox app only</em>) If <strong>Chrome sync</strong>
 is checked in Options, the item will also be added to the Chrome sync 
area, so it is available on a different computer after you log into 
Chrome or Firefox.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Retrieve a Lock or shared Key from the local directory</h3>
  </div>
  <div class="helpText">
    <p>1. Click the <strong>Edit</strong> button next to the directory box.</p>
    <p>2. Start writing the name of the item in the box that appears. As
 you type, the line above the box displays existing names that match 
what you have typed so far. When you see that the correct name has been 
found, you may stop typing; PassLok will use that item to encrypt or 
decrypt.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=vQrED7eIkLA" target="_blank">https://www.youtube.com/watch?v=vQrED7eIkLA</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p> The process also works for Lists, and cover texts stored in 
the local directory. Search is case-insensitive. If the item is a cover 
text, it loads automatically for use in Text hiding.</p>
      <p>(<em>Chrome/Firefox app only</em>) If you type "Enter" after a complete name that was not found on the local database and <strong>Chrome sync</strong>
 is checked in Options, PassLok will look for it in its Chrome sync 
area, which syncs across computers, and then add it to the local 
directory.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Delete a stored item</h3>
  </div>
  <div class="helpText">
    <p>1. Click the <strong>Edit</strong> button next to the directory box.</p>
    <p>1. Start writing the name of the item in the dialog that appears.
 As you type, the line above the box displays existing names that match 
what you have typed so far.</p>
    <p>2. When the name of the item you want to remove is displayed above the box, click the <strong>Del.</strong> button. A popup asks for confirmation before the item is deleted from the local directory.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=vQrED7eIkLA" target="_blank">https://www.youtube.com/watch?v=vQrED7eIkLA</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>You can stop typing once you see the complete name for the item you are looking for. Search is case-insensitive.</p>
      <p>(<em>Chrome/Firefox app only</em>)  If <strong>Chrome sync</strong> is checked in Options,  the item will also be deleted from there, after a confirmation popup.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Make a video to authenticate your Lock</h3>
  </div>
  <div class="helpText">
    <p>What should the video include:</p>
    <ul>
      <li> Identify yourself (First and Last name, or other).</li>
      <li> Write your Lock on a sign and display it, and read a portion 
of it out loud (say, the first 15 characters after the initial tag).</li>
      <li>For regular Locks, make sure to distinguish capitals from smallcase letters. This is not necessary for ezLoks.</li>
      <li> The video should be short, only a few seconds long.</li>
      <li> Play a song in the background to ensure the video is not tampered with.</li>
    </ul>
    <p>What to do with the video: </p>
    <ul>
      <li> Upload the video to the Web.</li>
    </ul>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=zkcqEz3UjnM" target="_blank">https://www.youtube.com/watch?v=zkcqEz3UjnM</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>It is highly recommended that you make a video whenever you 
change your secret Key, so that others can be assured that the matching 
Lock really belongs to you. When you post your Lock so that people can 
use it to encrypt messages for you, write the address of the video on 
the line immediately below the Lock, to facilitate the verifying 
process. Video URLs don't affect the function of Locks, so it is okay to
 handle the Lock and its video address as a unit. Obviously, you 
wouldn't do this for a shared Key, only for a Lock.</p>
      <p>Your PassLok ezLok is also used in PassLok for Email and 
PassLok Universal, so one video will suffice for all apps. The other 
apps display your ezLok at the beginning of any item you encrypt, 
separated from the encrypted message by a group of slashes.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Add, remove, and backup users</h3>
  </div>
  <div class="helpText">
    <p>To add a new user:</p>
    <p>1. Reload PassLok. Then click the <strong>New User</strong> button next to the user selection box.</p>
    <p>To backup and optionally remove an existing user (advanced):</p>
    <p>1. While you are logged in with that user's Key, go to the <strong>Options</strong> tab and click the Backup/Remove <strong>Whole Directory</strong> button (visible in the Advanced interface).</p>
    <p>2. Then a prompt asks you to confirm deleting the directory from the device. If you click <strong>OK,</strong> the entire local directory for that user is deleted, leaving no traces. If you click <strong>Cancel</strong>, the process ends and the directory contents are not deleted. In both cases the backup on the <strong>Main</strong> tab remains.</p>
    <p>3. To retrieve a backed-up directory (has PL**dir tags), paste it into the <strong>Main</strong> tab, and click <strong>Decrypt</strong>
 if it does not decrypt automatically. The database will be decrypted 
and placed in the directory Edit dialog. Then you can add it to the 
device's current local directory by clicking <strong>Merge</strong>.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=8zo-N5O82iM" target="_blank">https://www.youtube.com/watch?v=8zo-N5O82iM</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>You can maintain multiple identities, using different Keys. The
 backup process is useful whenever you stop using a device or just want 
to transfer your data to another device.</p>
      <p>(<em>Chrome app only</em>) Even if the local directory is completely deleted, the items in your Chrome sync area remain available if you click <strong>Cancel</strong>
 when PassLok offers to remove them from sync as well. They will load 
back automatically, even on a different machine, if you set up a user 
with <em>the same user name</em>.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Access the advanced functions of PassLok</h3>
  </div>
  <div class="helpText">
    <p>PassLok launches first in Basic mode, so you are able to encrypt 
and decrypt messages and perform the essential directory management 
functions. But PassLok has a lot more capabilities, which become 
available when you click the <strong>Advanced</strong> checkbox in the <strong>Options</strong> tab. To get back to Basic mode, click the <strong>Basic</strong> checkbox. PassLok will remember your choice of interface next time you open it.</p>
    <p>Some advanced capabilities include:</p>
    <ul>
      <li>Apply a seal to a text, and verify its authenticity.</li>
      <li>Hide PassLok's random-looking output inside images or as apparently normal text.</li>
      <li>Include an additional hidden message, whose presence cannot be detected.</li>
      <li>Change the user name, the Key, or the email/token.</li>
      <li>Backup or erase user settings, or even the entire local directory.</li>
    </ul>
    <p>There is also <strong>Email</strong> mode, which displays only the functions that are available in <a href="https://chrome.google.com/webstore/detail/passlok-for-email/ehakihemolfjgbbfhkbjgahppbhecclh" target="_blank">PassLok for Email</a> and <a href="https://chrome.google.com/webstore/detail/passlok-for-email/lbmlbnfgnbfppkfijbbpnecpglockled" target="_blank">PassLok Universal</a>.
 In this mode, PassLok's output is nearly identical to that of those 
apps, so it can be decrypted there. The ouput of PassLok for Email and 
PassLok Universal can always be handled by the standalone PassLok, no 
matter which interface mode is selected in Options.</p>
    <p>Finally, you can choose <strong>Compatible</strong> mode in Options (after selecting <strong>Advanced</strong>), which will cause PassLok's output to be accepted by URSA and SeeOnce.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=Ttyvb0Qt7h0" target="_blank">https://www.youtube.com/watch?v=Ttyvb0Qt7h0</a></p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Are there any keyboard shortcuts?</h3>
  </div>
  <div class="helpText">
    <p>The main functions in PassLok can be accessed directly from the 
keyboard. The button tooltips tell you what the shortcut is for each 
button that has a shortcut, but below is a complete list, just in case: </p>
    <ul>
      <p>Alt-M: <strong>M</strong>ain tab</p>
      <p>Alt-H: <strong>H</strong>elp tab</p>
      <p>Alt-O: <strong>O</strong>ptions tab</p>
      <p>Alt-0: Deselect all Locks</p>
      <p>Alt-E: <strong>E</strong>dit the Lock directory</p>
      <p>Alt-<strong>.</strong> <em>(period)</em>: extra buttons open and close</p>
      <p>Alt-D: encrypt or <strong>D</strong>ecrypt</p>
      <p>Alt-V: seal or <strong>V</strong>erify seal</p>
      <p>Alt-L: display my <strong>L</strong>ock or send emai<strong>L</strong></p>
      <p>Alt-R: toggle the <strong>R</strong>ich text editor</p>
      <p>Alt-C: start or join <strong>C</strong>hat</p>
      <p>Alt-B: use the <strong>B</strong>asic interface</p>
      <p>Alt-A: use the <strong>A</strong>dvanced interface</p>
      <p>Alt-N: set a<strong>N</strong>onymous mode</p>
      <p>Alt-S: set <strong>S</strong>igned mode</p>
      <p>Alt-1: set Read-<strong>once</strong> mode</p>
      <p>Alt-T: hide/unhide as <strong>T</strong>ext</p>
      <p>Alt-I: <strong>I</strong>mage screen open and close</p>
      <p>Alt-J: split or <strong>J</strong>oin parts</p>
      <p>Alt-<strong>;</strong> <em>(semicolon)</em>: put cursor on main box</p>
      <p>Alt-G: <strong>G</strong>eneral Directory</p>
    </ul>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>The list is made for access from Windows or Linux, so that each shortcut is of the form Alt-<em>letter</em>. If you are using a Mac, you should type ctrl-alt-<em>letter</em> instead. Shortcuts do not work on mobile devices.</p>
    </div>
  </div>
  <hr>
  <div id="advancedHelp">
    <div class="helpHeading">
      <h3>Make a short encrypted message suitable for texting <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. On the <strong>Options</strong> tab, check the <strong>Short</strong> button. Also make sure the appropriate encryption mode is selected with the radio buttons at the bottom of the <strong>Main</strong> tab.</p>
      <p>2. If the recipient's Lock of shared Key has been previously 
stored in the local directory, simply select its name in the top box of 
the <strong>Main</strong> tab.</p>
      <ul>
        <li>If not, click the <strong>Edit</strong> button next to the directory box and paste the Lock or shared Key in the box that appears. Then click <strong>Done</strong>.</li>
      </ul>
      <p>3. Write or paste your message into the box of the <strong>Main</strong> tab.</p>
      <p>4. Click the <strong>Encrypt</strong> button. The encrypted message will appear in the box, replacing the original message.</p>
      <p>Copy it and paste it into your communications program. </p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=pD-uvyxKBgQ" target="_blank">https://www.youtube.com/watch?v=pD-uvyxKBgQ</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>The encrypted message, which has no tags, will fit within one
 SMS message (160 characters). A message above the main box will tell 
you how much space is left, depending on the encryption mode selected. 
On a mobile device, the encrypted message will be selected and ready to 
be copied into the clipboard. <strong>You need to copy it</strong> manually before clicking the <strong>SMS</strong>
 button, which will open your texting app.  Message length is limited to
 94 ASCII characters when encrypting with a shared Key or in Signed 
mode, 62 in Anonymous mode, 46 in Read-once mode. Non-ASCII characters 
use 6 spaces each, so avoid them if you can. Any text beyond the limit 
will be lost.</p>
        <p>Short-mode locked items are not compatible with PassLok for 
Email and PassLok Universal, but if a shared Key is used they can be 
decrypted in URSA and FusionKey.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Decrypt a short encrypted message (no tags) <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. If the message was encrypted in Signed or Read-once mode, or
 with a shared Key, you will need to select the sender on the directory,
 or enter the appropriate Lock or shared Key in the directory Edit 
dialog, as described in a help item above.</p>
      <p>2. Paste the encrypted message in the lower box of the <strong>Main</strong> tab.</p>
      <p>3. If it does not decrypt automatically, click the <strong>Decrypt</strong> button. The decrypted message will appear in the box, replacing the encrypted message.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=pD-uvyxKBgQ" target="_blank">https://www.youtube.com/watch?v=pD-uvyxKBgQ</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>It is okay if the message is broken up by carriage returns. 
When decrypting, there is no need to set the encryption mode at the 
bottom of the <strong>Main</strong> tab.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Seal a text with your secret Key so others know it comes from you <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Write or paste the text to be sealed in the lower box of the <strong>Main</strong> tab.</p>
      <p>2. Click the <strong>Seal</strong> button. The text is replaced by a random-looking item, which is the sealed text. Copy
        it or email it from there.</p>
      <p>You must be aware that a sealed item is <strong>NOT ENCRYPTED</strong>, and that anyone in the world can unseal it so long as he/she has your Lock, which is public.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=Vh9wwFZiV4w" target="_blank">https://www.youtube.com/watch?v=Vh9wwFZiV4w</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>It is okay to strip the tags up to the "=" sign, but not 
recommended. It is also okay to split the sealed item with carriage 
returns. Sealed items can be unsealed only in PassLok.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Unseal a sealed text and verify its origin (tags are PL**sld) <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. If the sealer's Lock has been previously stored in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
      <ul>
        <li>If not, click the <strong>Edit</strong> button next to the directory box, then paste the Lock in the box that appears and click <strong>Done</strong>. </li>
      </ul>
      <p>2. Paste the sealed item in the lower box of the <strong>Main</strong> tab.</p>
      <p>3. If the item doesn't unseal automatically, lick the <strong>Unseal</strong> button. If successful, the sealed item will be replaced by the unsealed text, and a message above the main box will say whether
        or not the seal has been verified for that sealer.</p>
      <p>You must be aware that being able to unseal an item does not 
mean that others are not able to do it just as easily, because a sealed 
item is <strong>NOT ENCRYPTED</strong>. What unsealing does is verify that the item could only have been sealed by the selected person.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=Vh9wwFZiV4w" target="_blank">https://www.youtube.com/watch?v=Vh9wwFZiV4w</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p> It is okay if the signer's Lock is missing its tags up to 
the "==" signs, or carriage returns have been added to the sealed item. 
Unsealing requires a true Lock; shared Keys cannot be used for 
unsealing. Encrypting/decrypting with a shared Key partially verifies 
the identity of the sender, since shared Keys are not public. Decrypting
 a Signed or Read-once encrypted item also verifies the encrypter's 
identity.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Conceal a PassLok item (Lock, message, etc.) inside a piece of text <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Check that the item to be converted into fake text is on the <strong>Main</strong> tab. Then click the <strong>▼</strong> button, if needed, to show the <strong>Text hide</strong> button.</p>
      <p>2. If you wish to use a cover text different from the default 
and you have stored it in the local directory, select it on the top box 
of the <strong>Main</strong> tab. Otherwise click the <strong>Edit</strong> button and enter the new cover text in the dialog, then return to the <strong>Main</strong> tab.</p>
      <p>3. Make sure the hiding mode you want is the one selected in the <strong>Options</strong>
 tab. There are five different modes: Invisible, Letters, Words, Spaces,
 and Sentences. Letters (default) encodes the item as identical-looking 
non-ASCII characters in the cover text. Words replaces each character by
 two words. Spaces encodes the characters into the spaces between words.
 Sentences encodes characters as grammatically correct sentences. 
Invisible mode encodes into invisible characters between two lines, 
which can then be completed to look like a normal message.</p>
      <p>4. If now you click the <strong>Text hide</strong> button, the 
PassLok item is converted into text, using words from the cover text. 
You may have to complete the last sentence manually.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=_7Fju1EwhV4" target="_blank">https://www.youtube.com/watch?v=_7Fju1EwhV4</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>The recipient does not need to have the cover text in order 
to retrieve the original. The output of Spaces and Sentences encoding is
 roughly six times longer than that of Letters or Words encoding. The 
most grammatically-correct output is that or Letters and Spaces 
(identical to the cover text), followed by Sentences; Words output 
doesn't make much grammatical sense. Invisible encoding has no impact on
 intelligibility, but care must be taken to copy the entire invisible 
content. If the cover text is not long enough, it will be repeated 
several times. When you use Spaces or Letters encoding, you should be 
careful not to add or delete any spaces within the encoded text, but it 
is okay to add a few extra letters to complete the last sentence. Also 
be aware that some services replace the special characters in Letters- 
and Invisible-encoded items with something else, thus corrupting the 
items.</p>
        <p>Text encoding is no substitute for real encryption, and so 
PassLok will refuse to convert into text anything that does not look 
like genuine PassLok output.</p>
        <p>Cover texts do not have to be in English or even use Latin 
characters. Anything that can be written in UTF-16 encoded characters 
can be used (most languages, including Arabic and Chinese, will work 
fine).</p>
        <p>You can store often-used cover texts in your local directory so they can be loaded easily from the <strong>Main</strong> tab. To do this, click the <strong>Edit</strong> button next to the directory box, then paste the cover text in the lower box, and click <strong>Save</strong>. A popup will ask you to write a name for the stored cover text.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Retrieve an original PassLok item concealed within text <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Put the text in the box of the <strong>Main</strong> tab.</p>
      <p>2. Click the <strong>▼</strong> button, if needed, followed by the <strong>Text hide</strong> button. PassLok will detect the type of encoding used and display the original item in the box, replacing the text.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=_7Fju1EwhV4" target="_blank">https://www.youtube.com/watch?v=_7Fju1EwhV4</a></p>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Hide a PassLok item inside an image <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Make sure the item to be hidden is in the lower box of the <strong>Main</strong> tab.</p>
      <p>2. Click the <strong>▼</strong> button, if needed, and then the <strong>Image hide</strong> button.</p>
      <p>3. A dialog appears to load the image where the item is to be 
hidden. The image format does not matter, so long as it can be displayed
 in a web page. Then the image appears in a new dialog, along with a few
 controls and a message telling you how much data you can hide in the 
image.</p>
      <p>4. You will get much better stealth if you write a password in 
the box on that dialog. In this case, anyone trying to extract the 
hidden data will fail to detect that anything is there unless he/she 
also supplies the same password.</p>
      <p>5. Click the <strong>PNG hide</strong> or the <strong>JPG hide</strong>
 button, depending on the format of the image you want to produce. A 
message will say when processing is completed, although the image will 
not appear to have changed much.</p>
      <p>6. Right-click or long-press on the image in order to save it or send it somewhere. Then you can close the dialog with the <strong>Done</strong> button.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=_iXIyH6AnMI" target="_blank">https://www.youtube.com/watch?v=_iXIyH6AnMI</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p> If you selected a single recipient before clicking the <strong>Image hide</strong>
 button, the password box will be pre-filled with a string based on the 
recipient's Lock and your Key, which will be the same for the recipient.
 You can use this or replace it with something else.</p>
        <p>You can hide a second short message, in addition to the item 
in the main box, by writing after the image password a vertical bar "|",
 followed by a second password just for the second message, another 
vertical bar, and then the second message. How long the second message 
can be depends on the way the main box item is hidden, and cannot be 
known beforehand, but the process will fail if it is too long.</p>
        <p>Images only a few kB in size can hide PassLok items with 
hundreds of characters. Images taken with a mobile camera are usually 
too large for PassLok to be able to use them for hiding items, because 
of the large processing time required. JPG images containing information
 use no chroma subsampling. The PNG format can contain a lot more 
information, but file size will be larger.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Retrieve the PassLok item hidden inside an image <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Navigate to the image hiding screen from the <strong>Main</strong> tab by clicking <strong>▼</strong>, if needed, and then <strong>Image hide</strong>.</p>
      <p>2. A dialog appears to load the image where the item is hidden.  Then the image appears in a new dialog.</p>
      <p>3. If a password was used to hide the data, you must write the 
same password in the box on that dialog. Otherwise the revealing process
 will fail exactly as if the image did not contain anything. If you want
 PassLok to guess the password for you, select the sender in the 
directory box before clicking the <strong>Image hide</strong> button.</p>
      <p>4. Click the <strong>Reveal</strong> button. If succesful, the 
dialog closes and the hidden data appears in the main box. If 
unsuccessful, the dialog stays so you can try a different password; or 
you can close the dialog with the <strong>Done</strong> button.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=_iXIyH6AnMI" target="_blank">https://www.youtube.com/watch?v=_iXIyH6AnMI</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>This function is not available on iOS, but it is on Android. 
This is because iOS converts all images to JPG format as they are 
loaded, thus destroying any hidden information.</p>
        <p>If there is a second message hidden in the image, you can 
reveal it by writing after the image password a vertical bar "|", 
followed by the second password. If successful, the second message will 
appear in the message area of the Main tab.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Split an item into several random-looking parts <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Put the item in the lower box of the <strong>Main</strong> tab.</p>
      <p>2. Click the <strong>▼</strong> button, if needed, and then click the <strong>Split</strong> button. </p>
      <p>3. A popup asks for the total number of parts to be made, and 
the minimum number required to retrieve the original. Enter those 
numbers, which must be between 2 and 255, and click <strong>OK</strong>.
 The parts appear in the main box, replacing the original item, and a 
message confirms it. Copy the parts one by one and send or store them as
 needed.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=ZdVHaD-FpSk" target="_blank">https://www.youtube.com/watch?v=ZdVHaD-FpSk</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>The parts are enclosed within tags of the PL**p^^^ form, 
where ^^^ is the minimum number of parts that are needed to reconstruct 
the original. It is okay to strip the tags of the resulting parts up to 
the "==" sign, but not recommended.  It is also okay to split the parts 
with line returns. If you enter nothing in the second box, it is 
understood that all parts will be required to retrieve the original. 
Split items can only be joined in PassLok.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Join parts to retrieve the original item (tags are PL**p^^^) <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Paste a sufficient number of parts on separate lines of the lower box in the <strong>Main</strong> tab. Make sure that each part is unique. </p>
      <p>2. Click the <strong>▼</strong> button, if needed, and then the <strong>Join</strong> button. If all goes well, the reconstructed item appears in the box.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=ZdVHaD-FpSk" target="_blank">https://www.youtube.com/watch?v=ZdVHaD-FpSk</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>You need as many parts as the second number entered when the 
item was split, which is written at the end of each  PL**p^^^ tag. 
Having more parts than the minimum is okay, so long as they belong to 
the same set and are not corrupt. They don't need to be placed in any 
particular order. If nothing happens, likely causes include: 
insufficient number of parts, incomplete or corrupt parts, parts 
belonging to different sets.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Encrypt a second, undetectable message in addition to the main message (Hidden message mode) <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. On the <strong>Options</strong> tab, check the <strong>Hidden message</strong> checkbox.</p>
      <p>2. Follow the above instructions for any kind of regular 
encryption (not Short). A popup will ask for a hidden message and a 
special Key/Lock to encrypt it.</p>
      <p>3. Input the  hidden message into the top box and the special 
shared Key or Lock (either kind will work) in the bottom box. Then click
 <strong>OK</strong>. </p>
      <p>The encrypted message containing both the main text and the 
hidden text will appear in the main box, replacing the original text. 
Copy it and paste it into your communications program.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=4WrYEdRp2Q4" target="_blank">https://www.youtube.com/watch?v=4WrYEdRp2Q4</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>It is impossible to tell whether or not a encrypted item 
contains a hidden message. The length of the hidden message is limited 
to 83 ASCII characters, sufficient to include an ezLock. Non-ASCII 
characters use 6 spaces each, so avoid them if you can. Any text beyond 
the limit will be lost. If a shared Key is used for the second message, 
the same shared Key is needed to retrieve it; if a Lock was used, its 
matching Key will be needed. If a given recipient has a shared Key in 
common with the sender instead of a Lock, and Signed or Read-once mode 
is used for the main encryption, he/she won't be able to get the hidden 
message if encrypted with a Lock.</p>
        <p>Hidden messages added in PassLok can be revealed in PassLok 
for Email, PassLok Universal, and FusionKey, and vice-versa. This 
compatibility does not extend to other programs such as SeeOnce or URSA.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Reveal the hidden text contained within a message encrypted in Hidden message mode <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. On the <strong>Options</strong> tab, check the <strong>Hidden message</strong> checkbox.</p>
      <p>2. Follow the instructions for any of the regular decrypting modes. A popup will ask for a Hidden message Key.</p>
      <p>3. Input the special Key, then click <strong>OK</strong>. The hidden message, if it exists, will appear above the main box.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=4WrYEdRp2Q4" target="_blank">https://www.youtube.com/watch?v=4WrYEdRp2Q4</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>Since it is impossible to detect the presence of a hidden message, it is necessary to click the <strong>Hidden message</strong>
 checkbox in order to check for it. Likewise, there is no way to tell 
whether the sender used a Key or a Lock for encrypting the hidden 
message.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Change your secret Key <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Click the Change <strong>Key</strong> button on the <strong>Options</strong> tab. A new dialog will pop up asking you to enter the new Key twice.</p>
      <p>2. Write the new Key in the two boxes in this dialog, and then click <strong>OK</strong>. A message will announce that the Key has changed. </p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=LubzBF4Xaa8" target="_blank">https://www.youtube.com/watch?v=LubzBF4Xaa8</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>The items in the local directory are encrypted with your Key;
 this operation re-encrypts them with the new Key. Your Key is not 
stored anywhere, not even encrypted, but PassLok is still able to check 
whether the Key entered is the one in use.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Display the entire local directory <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Click the <strong>Edit</strong> button next to the Lock selection box.</p>
      <p>2. Click the <strong>All</strong> button below the box that 
appears. The complete local directory, including encrypted Read-once 
data, is displayed in the box so you can find items and copy them 
easily.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=8zo-N5O82iM" target="_blank">https://www.youtube.com/watch?v=8zo-N5O82iM</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>The format for each item is the following: name, followed by a
 colon (:), new line, item data; then two new lines before the next 
name, and so forth. If a name also has Read-once data, those follow the 
item data, occupying consecutive lines. Item 'myself' is special, and 
contains the Lock matching your secret Key and a collection of settings.</p>
       <p>If you want to decrypt a particular piece of data from the 
directory, copy it and paste it into the main box. It should decrypt 
automatically and appear in the directory Edit dialog.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Merge additional data into the local directory <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Click the <strong>Edit</strong> button next to the Lock selection box.</p>
      <p>2. Paste the additional data into the box hat appears.</p>
      <p>3. Click the <strong>Merge</strong> button. The new data is merged into the local directory.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=8zo-N5O82iM" target="_blank">https://www.youtube.com/watch?v=8zo-N5O82iM</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>The format for the additional data must be the following: 
name, followed by a colon (:), new line, item data; then two new lines 
before the next name, and so forth. If a name also has Read-once data, 
those follow the item data, occupying consecutive lines. If the 
additional data contains names that were already in use in the 
directory, the new data replaces the original data. Items are added in 
encrypted form but are not checked as they are added, so it is possible 
that different items may need different Keys to be decrypted, if you 
changed your secret Key in the past. (<em>Chrome/Firefox app only</em>) If <strong>Chrome sync</strong> is checked in Options,  the additional data will also be added to that area so it is accessible from other computers.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Use Lists <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>You can always encrypt a message for multiple recipients by 
writing their respective Locks or shared Keys in separate lines of the 
box in the directory edit dialog. You can also write the names of the 
Locks or shared Keys instead. A List itself can be given a name in order
 to save it in the local directory. You do this by clicking the <strong>Save</strong> button. Saved Lists appear bracketed by double dashes in the top box of the <strong>Main</strong> tab.</p>
      <p>To encrypt an item for all the recipients included in a saved List, just select its name in the top box of the <strong>Main</strong> tab before clicking the <strong>Encrypt</strong> button.</p>
      <p>Lists can contain Locks, shared Keys, or names of items in the local directory, but not names of other Lists. </p>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Make a random Key <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>PassLok has a built-in way to make a 42-character random Key: </p>
      <p>1. Click the <strong>Edit</strong> button next to the directory box.</p>
      <p>2. On the dialog that appears, click <strong>Save</strong> with the lower box empty.</p>
      <p>2. If you actually want to save the random Key, write a name for it in the top box before clicking <strong>Save</strong>. </p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=3OUpuk3-tRo" target="_blank">https://www.youtube.com/watch?v=3OUpuk3-tRo</a></p>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Combine a Key and a Lock <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>This operation, which goes by the technical name of 
"Diffie-Hellman key exchange,"  is at the core of many PassLok 
functions. Should you ever want to compute the result manually, here is 
how to do it:</p>
      <p>1. Write or paste the Key or the Lock on the <strong>Main</strong> tab.</p>
      <p>2. Click the <strong>Edit</strong> button next to the directory box, and write or paste the other item in the dialog that appears.</p>
      <p>3. Click the <strong>Merge</strong> button. The Key and the 
Lock will merge and the 43-character result, which is itself a valid 
Lock, is placed in both the dialog and the <strong>Main</strong> tab.</p>
      <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=0EImhN35Tbs" target="_blank">https://www.youtube.com/watch?v=0EImhN35Tbs</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>If both items or neither of them is a valid Lock, the merging
 process fails and a message is displayed. The result of combining your 
secret Key and someone's Lock is itself a Lock, and the same as that of 
combining your Lock and that person's secret Key. You can combine a set 
of Keys into one by first making the Lock of one of them, and then 
combining the other Keys, one after the other, as described above. The 
order of entering the Keys does not matter.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Ask the participants in a Chat session to authenticate themselves <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. Inside the chat session, type a bunch of garbage. You should
 expect  the garbage back as a sealed item from each participant who has
 not yet done so.</p>
      <p>2. When a sealed item is posted in the chat session, copy it  and go back to the <strong>Main</strong> tab of PassLok, then paste it there.</p>
      <p>3. In the local directory, select the Lock belonging to the person who posted the signature, and click the <strong>Unseal</strong> button.</p>
      <p>4. The original garbage string should be recovered, plus a 
message indicating that the sealer has been verified. If the seal is 
verified, this means that the one who posted it is indeed who he/she 
claims to be.</p>
      <p>This is all explained in this video: <a href="https://www.youtube.com/watch?v=NlEJJpF-Wmo" target="_blank">https://www.youtube.com/watch?v=NlEJJpF-Wmo</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>This process assumes that the Locks in your local directory 
have been authenticated, perhaps by following the process explained 
elsewhere in the help area. When asking others to authenticate 
themselves, it is important to ensure that the text they are asked to 
seal could not have been predicted ahead of time.</p>
        <p>If there is no Lock for a participant, but rather a shared 
Key, he/she should instead encrypt the garbage text with that shared Key
 and post the result. Authentication will be complete once the encrypted
 text can be decrypted with the shared Key and the result matches the 
original.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Respond to a request for authentication posted in a Chat session <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>1. If you see a piece of garbage text posted by someone 
(especially if you have just joined), that means that anyone who has not
 yet authenticated him/herself is asked to do so. Copy the garbage text 
and go back to the <strong>Main</strong> tab of PassLok, then paste it there.</p>
      <p>2. Click the <strong>Seal</strong> button. The text will be sealed.</p>
      <p>3. Copy the whole thing and go back to the chat session by clicking the <strong>Back to Chat</strong> button, then paste it into the chat box and submit it.</p>
      <p>This is all explained in this video: <a href="https://www.youtube.com/watch?v=NlEJJpF-Wmo" target="_blank">https://www.youtube.com/watch?v=NlEJJpF-Wmo</a></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>If your chat invitation was encrypted with a shared Key 
rather than a Lock, you should instead encrypt the garbage text with 
that shared Key and post the result; authentication will be complete 
once the encrypted text can be decrypted with the shared Keyl.</p>
      </div>
    </div>
    <hr>
    <div class="helpHeading">
      <h3>Authenticate a Lock without using videos <em>(advanced)</em></h3>
    </div>
    <div class="helpText">
      <p>The easy way: call the Lock's owner and ask him/her to read  a 
substantial portion of the Lock over the phone. But if you are 
communicating exclusively by email you can send a person whom you know 
and who knows you the following message, or something like it:</p>
      <p><br>
        <em>Dear So-and-So:</em><br>
        <em>I just obtained your PassLok Lock from (cite source), but I 
still wonder if it is authentic since I am unable to view the 
authenticating video. Therefore, I ask you to help me authenticate it 
through the interlock protocol. Here's what I want you to do:</em></p>
      <ol>
        <li><em>Write a message asking me to take a picture or video of 
myself doing something of your choice. Encrypt the message with my Lock,
 which is appended to this message, and copy it to a safe place. Then 
split it in two and send me the first half only.</em></li>
        <li><em>When I receive your first half, I will also write a 
message asking you to do something in a picture or short video. I'll 
encrypt that message with your Lock, and I'll send you half of the 
encrypted message first. When you get it, go ahead and send me the other
 half of your encrypted message.</em></li>
        <li><em>When I get your second half, I'll put the two halves 
together and decrypt your message. Then, following your instructions 
I'll send you the picture or video right away, decrypted, along with the
 second half of my encrypted request.</em></li>
        <li><em>When you get it, please verify that what I sent conforms
 to your instructions. If so, put together the two halves of my 
encrypted message to you, decrypt it, and send me what I ask in the 
message as soon as possible, decrypted as well. Then I'll know that your
 Lock is authentic.</em></li>
      </ol>
      <p><em>Many thanks. Sincerely, This-and-That</em></p>
      <div class="helpHeading2">
        <p><em>Click here for More:</em></p>
      </div>
      <div class="helpText">
        <p>Alternatively, you can ask the other person to use PassLok's built-in <strong>Split/Join</strong>
 function, explained in another help item, rather than simply cutting 
messages in two.  The pictures or videos (or recordings) don't need to 
be encrypted. Only the instructions for making them need to be encrypted
 and transmitted with this two-step process. There is an article in the <a href="http://passlok.weebly.com/uploads/2/4/1/8/24187628/passlok_manual21.pdf" target="_blank">PassLok manual</a> that explains how this protocol works for authenticating Locks.</p>
      </div>
    </div>
    <hr>
  </div>
  <!--end of advanced help-->

  <div class="helpHeading">
    <h3>Check the authenticity of the code</h3>
  </div>
  <div class="helpText">
    <p>If you got PassLok from an app store, that app store is ensuring 
that the code you have is what the author gave to them. The following is
 to check the integrity of the web app version of PassLok running in a 
browser:</p>
    <p>1. Direct your browser to "view source." If your browser has a 
command to save the source (Chrome, Firefox, and Safari do), go ahead 
and save it to file. Alternatively, you can go to Online-convert 
(https://hash.online-convert.com/sha256-generator) and type the URL of 
your version of PassLok there, then skip step 2.</p>
    <p>2. Now you have to take the SHA256 checksum of the code (or the 
MD5 or SHA1 checksums) using a program different from PassLok. You have 
several options:</p>
    <ul>
      <li>Use a local program or online utility to take the checksum of the source saved to a file.</li>
      <li>Use an online utility where you paste the text on a box and 
click a button. You must make sure that pasting does not add extra space
 at the top or the bottom of the file, which would affect the result.</li>
    </ul>
    <p>3. Look up the checksum for this version of PassLok, which is 
published on the PassLok information website at passlok.weebly.com and a
 number of other places. If this value and the one obtained above are 
not the same, the program has been tampered with. Here are some places 
where this information is published:</p>
    <ul>
      <li>PassLok information page: <a href="https://passlok.weebly.com/get-passlok.html" target="_blank">https://passlok.weebly.com/get-passlok.html</a></li>
      <li>PR Gomez.com (author's blog): <a href="https://prgomez.com/current-version-of-passlok" target="_blank">https://prgomez.com/current-version-of-passlok/</a></li>
      <li>Chrome extension description: <a href="https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh" target="_blank">https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh</a></li>
      <li>Firefox addon description: <a href="https://addons.mozilla.org/en-US/firefox/addon/passlok-privacy/" target="_blank">https://addons.mozilla.org/en-US/firefox/addon/passlok-privacy/</a></li>
      <li>Android app description: <a href="https://play.google.com/store/apps/details?id=com.fruiz500.passlok" target="_blank">https://play.google.com/store/apps/details?id=com.fruiz500.passlok</a></li>
    </ul>
    <p>4. Now, a hacker who could alter the source code at the server 
might also be able to change the published checksums so they match the 
tampered code. To make sure that the value is authentic you should watch
 the one-minute video where the author or PassLok, Francisco Ruiz, reads
 the SHA256 checksum aloud. A link to the video usually accompanies the 
published SHA256 value.</p>
    <p>This and more is explained in this video tutorial (warning: watching it may leak your IP number): <a href="https://www.youtube.com/watch?v=NrAfSo2xjnY" target="_blank">https://www.youtube.com/watch?v=NrAfSo2xjnY</a></p>
    <div class="helpHeading2">
      <p><em>Click here for More:</em></p>
    </div>
    <div class="helpText">
      <p>Typically, you load the source on a separate tab by typing 
CTRL-U (Windows) or option-cmd-u (OSX). Another way to save the source 
is to copy it by first selecting the the whole source code (CTRL-A or 
cmd-a), then copy to clipboard (CTRL-C or cmd-c), and then paste it into
 a text editor (CTRL-V or cmd-v), and save it from there. DO NOT save 
the code using the "save" command when the working PassLok page is 
displayed, since then the browser would modify the source code before 
saving it. The correct encoding is UTF-8, no BOM (notes: Windows Notepad
 is unable to save text in the correct format. Cut and paste from Chrome
 introduces artifacts for big items like the source code).</p>
      <p>SHA256 is built into the OS in Linux and OSX, not so in 
Windows, but there are free programs available, such as Checksum Utility
 and Bitser. There are also online utilities where you can upload a file
 and get the hash. Online-convert 
(https://hash.online-convert.com/sha256-generator), fileformat.info 
(http://www.fileformat.info/tool/hash.htm) and freeformatter.com 
(https://www.freeformatter.com/sha256-generator.html) have worked well 
in our tests.</p>
      <p>If you want a clipboard-based SHA256 utility, the one at Xorbin
 (https://www.xorbin.com/tools/sha256-hash-calculator) has worked quite 
well in our tests. Don't copy and paste from Chrome, since this 
introduces artifacts.</p>
    </div>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>I have an item that was encrypted/sealed with a previous version of PassLok, and the current version cannot handle it</h3>
  </div>
  <div class="helpText">
    <p>We do not recommend using old versions for new work. Newer 
versions have enhanced security and are more user-friendly. But 
sometimes you may need to handle an item that is incompatible with the 
current version. Here is a pretty complete list of old PassLok versions,
 with links to them.</p>
    <p><strong>The current version</strong> of PassLok can be obtained from the following servers (as always, be aware that following any link may reveal your location):</p>
    <p>source server: <a href="https://passlok.com/app" target="_blank">https://passlok.com/app</a></p>
    <p>information page: <a href="http://passlok.weebly.com/get-passlok.html" target="_blank">http://passlok.weebly.com</a></p>
    <p>GitHub page: <a href="https://github.com/fruiz500/passlok" target="_blank">https://github.com/fruiz500/passlok</a></p>
    <p>Chrome app: <a href="https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh" target="_blank">https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh</a></p>
    <p>Firefox addon: <a href="https://addons.mozilla.org/en-US/firefox/addon/passlok-privacy/" target="_blank">https://addons.mozilla.org/en-US/firefox/addon/passlok-privacy/</a>
    </p><p>Android app: <a href="https://play.google.com/store/apps/details?id=com.fruiz500.passlok" target="_blank">https://play.google.com/store/apps/details?id=com.fruiz500.passlok</a>    </p>
    <p>mirrors:</p>
    <p><a href="https://www.autistici.org/passlok" target="_blank">https://www.autistici.org/passlok</a> (non-US, self-certified)</p>
    <p><a href="https://passlok.site44.com/" target="_blank">https://passlok.site44.com</a></p>
    <p><a href="https://fruiz500.github.io/passlok" target="_blank">https://fruiz500.github.io/passlok</a></p>
    <p>SHA256 for this version and video of the author reading it at:</p>
    <p><a href="http://passlok.weebly.com/get-passlok.html" target="_blank">http://passlok.weebly.com/get-passlok.html</a></p>
    <p>&nbsp;</p>
    <p><strong>Previous versions </strong>(SHA256 for each)<strong>:</strong></p>
    <p><strong>2.4.20</strong> (155f-b7f2-1067-a69b-5bd6-22d1-6d8a-9f71-84f5-e7bc-59bb-0e56-b053-6c11-6167-340d)</p>
    <p><a href="https://passlok.com/archive/passlok24.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok24.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok24.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=x3eq1QJt4-k" target="_blank">Author reading the SHA256</a></p>
    <p><strong>2.3.5</strong> (b0a7-b564-26c1-1bd5-4f23-0829-63be-5a52-20c3-915c-96c3-8d85-7d43-b32f-5fdb-e5df)</p>
    <p><a href="https://passlok.com/archive/passlok23.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok23.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok23.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=_zsCzbZc3uU" target="_blank">Author reading the SHA256</a></p>
    <p><strong>2.2.8</strong> (1580-d524-c402-53bc-c973-6305-bee8-64ec-0853-2623-d9d3-a21e-1400-4a38-4b19-b07e)</p>
    <p><a href="https://passlok.com/archive/passlok22.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok22.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok22.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=u2aHUycmgWQ" target="_blank">Author reading the SHA256</a></p>
    <p><strong>2.1.03</strong> (fdc9-8bae-45c0-902f-bf6d-da01-ae7e-704c-8e32-4679-e691-a20d-4aee-2254-63af-b8d6)</p>
    <p><a href="https://passlok.com/archive/passlok21.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok21.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok21.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=kK1d8WrCMMY" target="_blank">Author reading the SHA256</a></p>
    <p><strong>2.0.03</strong> (627e-45e4-0160-c885-b668-896a-7f79-766e-b93c-c6e3-0094-a28f-4380-b060-7830-48d0)</p>
    <p><a href="https://passlok.com/archive/passlok20.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok20.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok20.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=6Nqn5u2mg2w" target="_blank">Author reading the SHA256</a></p>
    <p><strong>1.7.08</strong> (87a4-fee6-8916-99fb-c59b-9d73-32dd-3023-5af0-3e69-18e0-caa3-d9e7-8a53-2385-957c)</p>
    <p><a href="https://passlok.com/archive/passlok17.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok17.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok17.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=yhGs76QReRM" target="_blank">Author reading the SHA256</a></p>
    <p><strong>1.6.02</strong> (2c64-63d5-5d68-c7b2-9350-68cc-8bef-1a75-ddc1-1fa0-cd04-4428-f3ef-c079-e14f-4133)</p>
    <p><a href="https://passlok.com/archive/passlok16.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok16.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok16.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=Z5e9TVGMMsE" target="_blank">Author reading the SHA256</a></p>
    <p><strong>1.5.03</strong> (0061-4b79-8ba1-8fee-34c5-e243-96e9-4c7c-a0ea-cfc5-82c1-a44d-4cbb-06c4-ca00-985c)</p>
    <p><a href="https://passlok.com/archive/passlok15.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok15.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok15.html" target="_blank">Site44</a></p>
    <p><a href="https://www.youtube.com/watch?v=YQIDRKE_wbI" target="_blank">Author reading the SHA256</a></p>
    <p>The following (except 1.0) were edited so the archived help file 
works, changing the SHA256 from the original value (therefore no video)</p>
    <p><strong>1.4.03</strong> (f1cc-8931-1d31-4d65-4dfe-fb0d-5368-f854-3766-b240-f131-c93f-a0e9-8d14-752e-018e)</p>
    <p><a href="https://passlok.com/archive/passlok14.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok14.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok14.html" target="_blank">Site44</a></p>
    <p><strong>1.3.03</strong> (7c6f-3d59-1059-e712-15ea-8dcf-dcde-861a-7359-6508-3b29-5720-41c9-8271-cb69-f01a)</p>
    <p><a href="https://passlok.com/archive/passlok13.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok13.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok13.html" target="_blank">Site44</a></p>
    <p><strong>1.2</strong> (c17b-c529-8757-578a-6bc2-bdc4-122e-c607-8c16-19ef-b9ee-8d4d-75aa-cf0a-b703-e0ec)</p>
    <p><a href="https://passlok.com/archive/passlok12.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok12.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok12.html" target="_blank">Site44</a></p>
    <p><strong>1.1</strong> (8e5c-9714-eec3-cc65-aa8f-640d-d434-2747-aa24-624c-74c5-65ea-4077-0f0f-3b22-cc30)</p>
    <p><a href="https://passlok.com/archive/passlok11.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok11.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok11.html" target="_blank">Site44</a></p>
    <p><strong>1.0</strong> (a907-25eb-50e3-e4a6-5f4b-27c1-684e-f590-6094-6fae-52f3-c7ca-47b1-732c-9eab-3e9b)</p>
    <p><a href="https://passlok.com/archive/passlok10.html" target="_blank">PassLok.com</a></p>
    <p><a href="https://www.autistici.org/passlok/archive/passlok10.html" target="_blank">Autistici</a></p>
    <p><a href="https://passlok.site44.com/archive/passlok10.html" target="_blank">Site44</a></p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>None of the help items answers my question / I want to give feedback</h3>
  </div>
  <div class="helpText">
    <p>Then you can send us an email at <a href="mailto:passlokprivacy@gmail.com?subject=PassLok support request" target="_blank">passlokprivacy@gmail.com</a>
 (the link will open your email client). We'll do our best to reply in a
 timely fashion. If you are a GitHub user, you can also go to <a href="https://github.com/fruiz500/passlok" target="_blank">our page on GitHub</a> and post issues or submit improvements there.</p>
    <p>Good constructive feedback is hard to get, so let us <strong>thank you</strong> right now, before we read your email.</p>
  </div>
  <hr>
  <div class="helpHeading">
    <h3>Privacy Policy and Warrant Canary</h3>
  </div>
  <div class="helpText">
    <p><strong>Data we collect:</strong> Nothing. No cookies or anything of that sort. We don't even have the means to know who has downloaded the app.</p>
    <p><strong>How we use this data:</strong> Nothingness brings us closer to Nirvana. It's quite a liberation.</p>
    <p><strong>What data we share:</strong> Everything we have from you,
 that is, absolutely nothing. This way we don't need expensive servers 
and our bills are small, plus we cannot compromise your precious data. 
Here's wishing that so many other providers would do likewise.</p>
    <p>Concerning truly private data:</p>
    <p><strong>1. We cannot give your secret Key to anyone</strong> (not
 even yourself) because we don't have it. Your Key is never stored or 
transmitted, and by default gets deleted from memory  after five minutes
 of not being used.</p>
    <p><strong>2. We cannot give your private data to anyone</strong> 
because PassLok does not send anything out of your device. When you 
download the app from its server, you get only the code, without any 
cookies, plugins, or anything of that sort.</p>
    <p><strong>3. We cannot eavesdrop on your chat sessions, or enable anyone to do so.</strong>
 Establishing a chat session does involve contacting a signaling server 
and giving it your IP address and a disposable chatroom name so that 
others can contact you; the signaling server never sees the content of 
your chat, which is between participants only. The PassLok web server 
doesn't even see the connection data.</p>
    <p><strong>4. We will never weaken the cryptography methods contained within PassLok at the request of a third party, private or public.</strong>
 This also means no backdoors will ever be added. We would rather shut 
down PassLok than be forced to do this, which would betray the very 
essence of our efforts. If we learn that counterfeit versions of PassLok
 are circulating, whether placed by hackers or government agencies, we 
will make the fact known to users.</p>
    <p><strong>Notice:</strong> Since PassLok is distributed as a piece 
of human-readable code, we consider it an expression of free speech 
protected by the laws of many countries. Putting into circulation 
tampered versions of PassLok, whether by individuals or public entities,
 violates free speech and copyright protection laws.</p>
    <p>PassLok contains strong cryptographic methods, which may be 
illegal to use in some countries. Please check the local laws before 
using PassLok.</p>
    <div id="canary"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8BAMAAADI0sRBAAAAGFBMVEUAAAAAAAD///91XhdgYGCcnJzMzMzUqipkv+fEAAAAAXRSTlMAQObYZgAAAYFJREFUOMt1lLGOgzAQREEUaVkHkhpEUkOVmvsDIt31IF1PdP8vnWwzHtaGKRDmsbO7eHGm9Cfyys4km/ojmEvQ/ZBS10N6Gl+I18/v6G/KtCrTOnVuscbWSwsxPYPBwEsGw1nxgEGpxoUzuI00MjuDqWdwvyD4e88nuOdbMFOge3j79V3liHAjL7np4kt4u5V2fwS8bGbbHd3hjZ0wyt1hZAzuxL3FZoffqrUSlaG4qqU2HFbMfoplj68pNqr0T4xF4SFUMyJcY+EqxVgTS4QlwkZjrAXSubFRsw4H5p5BxLlIgwfTIW6DoXafPcYkqN74zRf3uN7bf2HHChvnuMGX7WoRYD8tTN/4q2CS/YQ8tvY79GwsXjO3J6jq/Qz7Mds8ds5RSDypAmz4zSr1E/EfQ9MJHjDd5PSGu1Vt8Q3BOBrVDuNdnj0DB2RCvH0xPpnYHoLhXmluXdajU7E7ONOj+YyP5Fzx9MDHQHIkQGCv1WtcaFqSkKeUumjnVB80TP0D1fGXaRHBg/YAAAAASUVORK5CYII=">
    <p>This paragraph and the canary logo above attest to the fact that,
 up until the release of PassLok version 2.5 (April 2022) we have not 
received any requests under gag order for user data or modifications of 
the code. This paragraph will be periodically updated as this situation 
continues.</p>
    </div>
  </div>
  <hr>
  <address>
  PassLok v2.5 © F. Ruiz 2022
  </address>
  <ul>
    <li> engine: NaCl by D. Bernstein, W. Janssen, T. Lange, P. Schwabe, M. Dempsky, and A. Moon 2013</li>
    <li> tweetNaCl JavaScript implementation by D. Chestnykh and D. Mandiri 2015</li>
    <li> DOMPurify XSS sanitizer by cure53 2022</li>
    <li> Shamir secret sharing by A. Stetsyuk 2013</li>
    <li> image steganography based on F5 by Andreas Westfeld 2001</li>
    <li> jpeg image hiding libraries js-steg by Owen Campbell-Moore et al. 2014</li>
    <li> isaac seedable PRNG by Yves-Marie Rinquin 2012</li>
    <li> file In/Out based on an article from the This Could Be Better blog 2012</li>
    <li> scrypt key stretching implementation and edcurve-js by D. Chestnykh 2014</li>
    <li> lz-string compression by pieroxy 2014</li>
    <li> webRTC chat by Muaz Khan 2019</li>
    <li> Jitsi chat by jitsi.org 2020</li>
    <li> Letters encoding based on Advanced Unicode Stego by Adrian&nbsp;Crenshaw 2013</li>
    <li> color picker: jscolor by Jan Odvarko, 2014</li>
    <li> QRcode library by David Shim, 2015</li>
    <li> testing, help items, interface ideas by the IIT PassLok team 2014-17</li>
  </ul>
  <address>
  This document may be used, modified or redistributed under GNU GPL license, version 3.0 or higher.
  </address>
</div>

<!--Directory dialog-->
<div id="lockScr" class="white_content" align="center">
  <div id="locktop" align="center">
    <button class="cssbutton" id="lock2mainBtn" value="&lt; Back" title="return to main screen (alt-E)" accesskey="">◄ Done</button>
    <br>
    <br>
    <br>
    <div id="lockMsg" class="message">Enter Locks, shared Keys, or their names in the box</div>
    <br>
    <br>
  </div>
  <div id="lockBtnsTop" align="center">
    <button class="cssbutton" id="clearLocksBtn" value="Clear" title="clear box">Clear</button><!--
--><button class="cssbutton" id="addLockBtn" value="Save" title="save to the local directory | if box is empty, make random item">Rand.</button><!--
--><button class="cssbutton" id="removeLockBtn" value="Delete" title="delete the item whose name is displayed">Del.</button><!--
--><button class="cssbutton" id="resetPFSBtn" value="Reset" title="reset Read-once data for the item whose name is displayed">Reset</button>
  </div>
  <div class="cssbox" id="lockBox" name="text" rows="10" placeholder="To save a Lock or shared Key, write it in this box, then click Save. You will be asked for a name. You can also use Locks and shared Keys without saving them if you write them here, one line per item." style="height: 468px;" contenteditable="true" align="left"></div>
  <div id="lockBtnsBottom" align="center">
    <button class="cssbutton" id="showLockDBBtn" value="All" title="show the entire local directory">All</button><!--
--><button class="cssbutton" id="mergeLockDBBtn" value="Merge" title="merge into the local directory | Diffie-Hellman merge of this and the main screen contents">Merge</button><!--
--><label for="lockFile" title="open dialog to select file to load"><span class="cssbutton">Load file</span></label><input type="file" id="lockFile" title="open dialog to select file to load">
  </div>
</div>

<!--Key dialog-->
<div id="keyScr" class="white_content" align="center"> <br>
  <div id="pwdMsg" class="message">Welcome to PassLok Privacy
downloaded from a secure server
Select your user name and enter your Key. Then click OK</div>
  <br>
  <br>
  <select class="cssbox" id="nameList" size="4" title="select your user name" style="color: rgb(99, 151, 137);"><option value="" disabled="disabled">Select User Name:</option><option value="eric.ouweneel@pm.me">eric.ouweneel@pm.me</option></select>
  <button class="cssbutton" id="newUserBtn" value="new user" title="set up a new user">New User</button>
  <br>
  <br>
  <input type="password" class="cssbox" autocomplete="off" id="pwdBox" name="text" placeholder="Enter your secret Key here." align="middle"><img id="pwdIcon" class="field-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==" title="click this to see/hide the Password">
  <br>
  <br>
  <button class="cssbutton" id="cancelKeyBtn" value="cancel" title="close Key dialog">Cancel</button>
  &nbsp;
  <button class="cssbutton" id="acceptKeyBtn" value="OK" title="accept Key">OK</button>
  <br>
  <br>
  <span id="fiveMin">
  <p>You will need to re-enter your Key if you don't use it for 5 min.</p>
  </span>
  <p><strong>PassLok will be very slow</strong> if your Key is worse than Medium.</p>
  <p>To display or refresh your Lock, click myLock on the Main tab.</p>
  <p>Cancel for limited functionality in Guest mode.</p>
</div>

<!--Intro wizard, split into five screens-->
<div id="introscr" class="block_page" align="center">
  <h2 id="introWelcome">Welcome to PassLok</h2>
  <div id="intro1" align="left">
    <p>In the following screens, you will be asked to provide a user 
name for yourself, plus a secret Key, and a piece of public data such as
 your email. You can go offline if you like; nothing will leave this 
device. Your Key will not be stored.</p>
    <p>This is needed to keep a permanent directory of your friends’ 
Locks and shared Keys, all securely encrypted. If you prefer not to 
store anything, click <strong>Exit</strong>.</p>
    <div id="introVideoText">
    <p>If you have three minutes to spare, you may want to watch the fun
 video called by the button below, which explains how PassLok works. It 
will load on a separate window. Click <strong>Next</strong> when you're ready.</p>
    <div align="center">
      <a href="https://www.youtube.com/watch?v=UxgrES_CGcg" target="_blank">
      <button class="cssbutton" id="introvideo" value="video" title="click this to load the introductory video. WARNING: this may leak your IP number">Alice &amp; Bob Video</button>
      </a></div></div>
    <button class="cssbutton" id="gotointro2" value="next" title="to step 2">Next ►</button>
    <button class="cssbutton" id="skipIntroBtn" value="skip" title="skip this">Exit</button>
  </div>
</div>


<div id="introscr2" class="block_page" align="center">
  <div id="intro2" align="left">
    <button class="cssbutton" id="backtointro1" value="back" title="back to beginning">◄ Back</button>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Step 2 of 5<br>
    <p>Please enter your user name here. This way several users (or several identities) can share the same device.</p>
    <div align="center">
      <input type="text" class="cssbox" autocomplete="off" id="nameIntro" name="username" placeholder="Enter your User Name here" align="middle">
      <br>
      <br>
    </div>
    <button class="cssbutton" id="gotointro3" value="next" title="to step 3">Next ►</button>
  </div>
</div>


<div id="introscr3" class="block_page" align="center">
  <div id="intro3" align="left">
    <button class="cssbutton" id="backtointro2" value="back" title="back to step 2">◄ Back</button>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Step 3 of 5<br>
    <p>Now enter your secret Key in the box below. You will <strong>never give this Key to anyone</strong>.
 Make sure to use $ymbol$, numb3rs, caPiTals, unusual words and 
mespelingss. You should be able to remember it, because it won't get 
stored.</p>
    <p>The Suggest button will get you started with five words, which you can modify at will.</p>
    <div align="center"> <span id="pwdIntroMsg" class="message">This is where the Key score will appear</span><br>
      <br>
      <input type="password" class="cssbox" autocomplete="off" id="pwdIntroBox" name="text" placeholder="Enter your secret Key here" align="middle"><img id="pwdIntroIcon" class="field-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==" title="click this to see/hide the Password">
      <br>
      <br>
      <button class="cssbutton" id="suggestIntroBtn" value="Suggest" title="suggest a Key made of five common words">Suggest</button>
      <button class="cssbutton" id="clearIntroBtn" value="Clear" title="clear box contents">Clear</button>
      <br>
    </div>
    <p>If your Key score is below Medium, <strong>PassLok will be very slow.</strong></p>
    <button class="cssbutton" id="gotointro4" value="next" title="to step 4">Next ►</button>
  </div>
</div>


<div id="introscr4" class="block_page" align="center">
  <div id="intro4" align="left">
    <button class="cssbutton" id="backtointro3" value="back" title="back to step 3">◄ Back</button>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Step 4 of 5<br>
    <p>You will get better security if you also provide some public 
piece of data about yourself, such as your email address. This is case 
sensitive. There's no risk of spam since nothing will be sent out. You 
can skip this if you want.</p>
    <p>If you want your encrypted output to be compatible with that of <em>PassLok for Email</em>, you must write your email address here.</p>
    <div align="center">
      <input type="text" class="cssbox" id="emailIntro" name="text" placeholder="Optionally, enter your email or some other not secret personal info here" align="middle">
      <br>
      <br>
      <button class="cssbutton" id="introRandomBtn" value="Rand." title="display a random token">Random</button>
      <button class="cssbutton" id="clearIntroRandomBtn" value="Clear" title="clear box contents">Clear</button>
      <br>
    </div>
    <p>For ultimate security (at the expense of portability), you may 
want to click the Random button to use a random token instead. It will 
be stored locally in encrypted form.</p>
    <button class="cssbutton" id="gotointro5" value="next" title="to step 5">Next ►</button>
  </div>
</div>


<div id="introscr5" class="block_page" align="center">
  <div id="intro5" align="left">
    <button class="cssbutton" id="backtointro4" value="back" title="back to step 4">◄ Back</button>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Step 5 of 5<br>
    <p>When you click the button below, the random-looking Lock matching
 your secret Key will appear on PassLok's Main screen, along with some 
further instructions. You want to send that Lock to your friends so they
 can send you encrypted messages. You can do this any time by clicking 
the Email button or just by clicking the checkbox below.</p>
    <p>You will start in Basic mode, which shows only the most essential
 functions. If you are looking for more features, go to the Options tab 
and check the Advanced checkbox. There is also Email mode, which makes 
this app fully compatible with <em>PassLok for Email</em> and <em>PassLok Universal</em>.</p>
    <p>You may not see this screen again, but comprehensive help is always available on the Help tab.</p>
  </div>
  <div align="center">
    <input type="checkbox" id="inviteBox">
    &nbsp; Email my Lock&nbsp;&nbsp;<br>
    <br>
    <button class="cssbutton" id="showlockIntroBtn" value="Make Lock" align="center" title="make matching Lock and open Main tab">Finish</button>
    <br>
    <br>
    <span id="intromsg2" class="message"></span> </div>
</div>

<!--name dialog-->
<div id="nameScr" class="white_content" align="center"> <br>
  <div align="center">
    <div id="namechangemsg" class="message">Please enter a new User name for this account</div>
    <br>
    <br>
    <input type="text" class="cssbox" autocomplete="off" id="userNameBox" name="name" placeholder="Enter your new User Name here." align="middle">
    <br>
    <br>
    <button class="cssbutton" id="cancelNameBtn" value="cancel" title="close name change dialog">Cancel</button>
    &nbsp;
    <button class="cssbutton" id="acceptNameBtn" value="OK" title="accept new user name">OK</button>
  </div>
</div>

<!--Key change dialog-->
<div id="keyChange" class="white_content" align="center"> <br>
  <br>
  <div id="newKeyMsg" class="message"></div>
  <br>
  <br>
  <input type="password" id="newKeyBox" class="cssbox" name="newkey" placeholder="Enter the new Key here."><img id="newKeyIcon" class="field-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==" title="click this to see/hide the Password">
  <br>
  <br>
  <input type="password" id="newKey2Box" class="cssbox" name="newkey2" placeholder="Enter the new Key again.">
  <br>
  <br>
  <button class="cssbutton" id="cancelKeyChangeBtn" value="Cancel" title="do not change the Key">Cancel</button>
  &nbsp;
  <button class="cssbutton" id="submitKeyChangeBtn" value="OK" title="go on with Key change">OK</button>
</div>

<!--email change dialog-->
<div id="emailScr" class="white_content" align="center"> <br>
  <div align="center"> <span id="emailMsg" class="message">Please enter your new email or similar item, or a new random token</span><br>
    <br>
    <button class="cssbutton" id="randomEmailBtn" value="random" title="insert random token">Random</button>
    <br>
    <br>
    <input type="text" class="cssbox" autocomplete="off" id="emailBox" name="emailBox" placeholder="Enter your email or some other not secret personal info here." align="middle">
    <br>
    <br>
    <button class="cssbutton" id="cancelEmailBtn" value="cancel" title="close email dialog">Cancel</button>
    &nbsp;
    <button class="cssbutton" id="acceptEmailBtn" value="OK" title="accept email">OK</button>
    <p>Your Lock will change if this is not the same you entered before.</p>
    <p>If you use a random token, make sure to back it up from Options.</p>
  </div>
</div>

<!--Decoy In dialog-->
<div id="decoyIn" class="white_content" align="center"> <br>
  <span id="decoyInMsg" class="message">Enter the Hidden Message</span>
  <div id="decoyInSpacer1"><br></div>
  <br>
  <textarea id="decoyText" class="cssbox" name="text" rows="3"></textarea>
  <p>Enter the Key/Lock</p><p>
  </p><div id="decoyInSpacer2"><br></div>
  <input type="password" class="cssbox" id="decoyInBox" name="key"><img id="decoyInIcon" class="field-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==" title="click this to see/hide the Password">
  <br>
  <br>
  <button class="cssbutton" id="cancelDecoyBtn" value="Cancel" title="do not encrypt">Cancel</button>
  &nbsp;
  <button class="cssbutton" id="submitDecoyBtn" value="OK" title="go on with encryption">OK</button>
</div>

<!--Decoy Out dialog-->
<div id="decoyOut" class="white_content" align="center"> <br>
  <span id="decoyOutMsg" class="message">Enter the Key for the Hidden message</span>
  <div id="decoyOutSpacer"><br></div>
  <br>
  <input type="password" class="cssbox" id="decoyOutBox" name="key"><img id="decoyOutIcon" class="field-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==" title="click this to see/hide the Password">
  <br>
  <br>
  <button class="cssbutton" id="cancelDecoy2Btn" value="Cancel" title="stop decrypt">Cancel</button>
  &nbsp;
  <button class="cssbutton" id="submitDecoy2Btn" value="OK" title="go on with decrypt">OK</button>
  <p>The Hidden message will appear on the Main tab</p>
</div>

<!--Parts for SSSS dialog-->
<div id="partsIn" class="white_content" align="center"> <br>
  <p>Enter the total number of parts (between 2 and 255)</p>
  <div id="partSpacer1">
  <br>
  <br>
  </div>
  <input type="text" class="cssbox" id="partsNumber" name="text" rows="1">
  <br>
  <p>And the number of parts needed to retrieve the item</p>
  <div id="partSpacer2">
  <br>
  <br>
  </div>
  <input type="text" class="cssbox" id="partsQuorum" name="text" rows="1">
  <br>
  <br>
  <button class="cssbutton" id="cancelPartsBtn" value="Cancel" title="do not split">Cancel</button>
  &nbsp;
  <button class="cssbutton" id="submitPartsBtn" value="OK" title="go on with splitting">OK</button>
</div>

<!--Chat dialog, to enter the chat type and date or other information-->
<div id="chatDialog" class="white_content" align="center"> <br>
  <br>
  <br>
  <span id="chatmsg" class="message">Choose the type of chat, then optionally write in the box a message plus date and time</span><br>
  <br>
  &nbsp;<input type="radio" name="chatmodes" id="dataChat" title="chat with text messages and file exchange" checked="checked">
  &nbsp; Text&nbsp;&nbsp;
  <input type="radio" name="chatmodes" id="audioChat" title="like Text chat, plus audio">
  &nbsp; Audio&nbsp;&nbsp;
  <input type="radio" name="chatmodes" id="videoChat" title="like audio chat, plus video">
  &nbsp; Video&nbsp;&nbsp;
  <input type="radio" name="chatmodes" id="jitsiChat" title="full featured, on jit.si">
  &nbsp; Jitsi
  <br>
  <br>
  <textarea id="chatDate" class="cssbox" name="chatDate" rows="1" title="additional information" placeholder="Write here the date and time for the chat"></textarea>
  <br>
  <br>
  <button class="cssbutton" id="cancelChatBtn" value="Cancel" title="cancel chat invitation">Cancel</button>
  &nbsp;
  <button class="cssbutton" id="submitChatBtn" value="OK" title="make chat invitation">OK</button>
</div>

<!--Image hiding dialog-->
<div id="imageScr" class="white_content" align="center">
  <button class="cssbutton" id="image2mainBtn" value="&lt; Done" title="return to main screen (alt-I)" accesskey="i">◄ Done</button>
  <span id="imgSpacer"><br>
  <br>
  <br>
  </span>
  <button class="cssbutton" id="encodePNGBtn" value="PNG Hide" title="hide main box contents into PNG image">PNG hide</button>
  &nbsp;
  <button class="cssbutton" id="encodeJPGBtn" value="JPG Hide" title="hide main box contents into JPG image">JPG hide</button>
  &nbsp;
  <button class="cssbutton" id="decodeImgBtn" value="Reveal" title="extract hidden content and put it in main box">Reveal</button>
  <br>
  <br>
  <input type="text" class="cssbox" id="imageBox" title="use a password for better undetectability" placeholder="optional Password"><img id="imageIcon" class="field-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAASFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACrhKybAAAAF3RSTlMA5Qyz9kEFh3rd1sjDoGsfHRKwQIp+Qzv02bEAAACJSURBVCjPvVBJEoQgDMwCAfeFmfH/P51KkFKL0qN9SXdDVngRy8joHPK4XGyJbtvhohz+3G0ndHPxp0b1mojSqqyZsk+tqphFVN6S8cH+g3wQgwCrGtT3VjhB0BB26QGgN0aAGhDIZP/wUHLrUrk5g4RT83rcbxn3WJA90Y/zgs8nqY94d/b38AeFUhCT+3yIqgAAAABJRU5ErkJggg==" title="click this to see/hide the Password">
  <br>
  <br>
  <div id="imageMsg" class="message"></div>
  <br>
  <img id="previewImg" src="" style="width: 80%;" width="100%"> </div>

<!--Shadow backdrop-->
<div id="shadow" class="black_overlay"> </div>

<!--QRcode, which goes away when touched-->    
<div id="qrcodeImg" class="white_content" align="center"><canvas width="290" height="290"></canvas><img style="display: none;"></div>

<!--Body script: window reformatting, special functions-->
<script>
//this is the part of the javascript code that must be within the body

//detect browser and device
	var isMobile = (typeof window.orientation != 'undefined'),
		isChrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1,
		isFirefox = typeof InstallTrigger !== 'undefined',   						// Firefox 1.0+
		isSafari = Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor') > 0,       // At least Safari 3+: "[object HTMLElementConstructor]"
		isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0,								// Opera 8.0+ (UA detection to detect Blink/v8-powered Opera)
		isIE = /*@cc_on!@*/false || !!document.documentMode,						 // At least IE6
		isiPad = (navigator.userAgent.match(/iPad/i) != null),
		isiPhone = (navigator.userAgent.match(/iPhone|iPod/i) != null),
		isiOS = (isiPhone || isiPad),
		isAndroid = (isMobile && !isiOS),
		isAndroidTablet = (navigator.userAgent.match(/mobile/i) == null && isAndroid),
		isAndroidPhone = (navigator.userAgent.match(/mobile/i) != null && isAndroid),
		isFile = (window.location.protocol == 'file:');
	textheight();

//  Clear out "sorry, no JavaScript" warning and display the type of source
	showGreeting();

//set global variable indicating if there is a Chrome sync data area. Works for Chrome and Firefox apps and extension
var ChromeSyncOn = false;
if(typeof(chrome) != 'undefined'){
	if(typeof(chrome.storage) != 'undefined'){
		if(typeof(chrome.storage.sync) != 'undefined'){
			ChromeSyncOn = true
		}
	}
}

//clears the no JavaScript warning and displays an initial message depending on the type of source
function showGreeting(){
	var protocol = window.location.protocol;
	var msgStart = "Welcome to PassLok Privacy\r\n",
		msgEnd = "\r\nSelect your user name and enter your Key. Then click OK";
	if(protocol == 'file:'){
		pwdMsg.textContent = msgStart + 'running from a saved file' + msgEnd
	}else if(protocol == 'https:'){
		pwdMsg.textContent = msgStart + 'downloaded from a secure server' + msgEnd
	}else if(protocol == 'chrome-extension:' || protocol == 'moz-extension:'){
		pwdMsg.textContent = msgStart + 'running as a Chrome or Firefox addon' + msgEnd
	}else{
		mainTab.style.backgroundColor = '#ffd0ff';
		pwdMsg.textContent = msgStart + 'WARNING: running from an insecure source!' + msgEnd
	}
}

//resizes text boxes so they fit within the window
function textheight(){
	var	fullheight = document.documentElement.clientHeight,
		offsetheight = 392,
		toolbarheight = 50;
	if(isiPhone) offsetheight = offsetheight - 65;
	lockBox.style.height = (fullheight - 300) * (isMobile ? 1 : 0.8) + 'px';
	if(niceEditor){
		mainBox.style.height = fullheight - offsetheight - toolbarheight + 'px'
	}else{
		if(isMobile){
			if(isAndroid && !isFile){
				mainBox.style.height = fullheight - offsetheight + 40 + 'px';
			}else if(isiPhone){
				mainBox.style.height = fullheight - offsetheight - 10 + 'px';
			}else{
				mainBox.style.height = fullheight - offsetheight + 'px';
			}
		}else{
			mainBox.style.height = fullheight - offsetheight - 10 + 'px';
		}
	}
}

//this one is called by window.onload below
function loadFileAsURL(){
	var fileToLoad = mainFile.files[0],
		fileReader = new FileReader();
	fileReader.onload = function(fileLoadedEvent){
		var fileName = fileToLoad.name;
		var URLFromFileLoaded = fileLoadedEvent.target.result;
		if(URLFromFileLoaded.length > 2000000){
			var reply = confirm("This file is larger than 1.5MB and Chrome won't save it. Do you want to continue loading it?");
			if(!reply){
				mainMsg.textContent = 'File load canceled';
				return
			}
		}
		if(fileToLoad.type.slice(0,4) == "text"){
			if(URLFromFileLoaded.slice(0,2) == '==' && URLFromFileLoaded.slice(-2) == '=='){
				var fileLink = document.createElement("a");
				fileLink.download = fileName;
				fileLink.href = "data:," + decryptSanitizer(URLFromFileLoaded);			//filter before adding to the DOM
				fileLink.textContent = fileName;
				mainBox.appendChild(fileLink)
			}else{
				var spacer = document.createElement("br"),
					textDiv = document.createElement("div");
				textDiv.textContent = decryptSanitizer(URLFromFileLoaded).replace(/  /g,' &nbsp;');
				mainBox.appendChild(spacer);
				mainBox.appendChild(textDiv)
			}
		}else{
			var fileLink = document.createElement("a");
			fileLink.download = fileName;
			fileLink.href = decryptSanitizer(URLFromFileLoaded).replace(/=+$/,'');
			fileLink.textContent = fileName;
			mainBox.appendChild(fileLink)
		}
	};
	if(fileToLoad.type.slice(0,4) == "text"){
		fileReader.readAsText(fileToLoad, "UTF-8");
		mainMsg.textContent = 'This is the content of file: ' + fileToLoad.name;
	}else{
		fileReader.readAsDataURL(fileToLoad, "UTF-8");
		mainMsg.textContent = 'The file has been loaded in encoded form. It is NOT ENCRYPTED';
	}
	setTimeout(function(){
		updateButtons();
		if(decryptBtn.textContent == 'Decrypt') mainMsg.textContent = 'This file may contain an encrypted item';
		if(verifyBtn.textContent == 'Unseal') mainMsg.textContent = 'This file may contain a sealed item';
		if(secretShareBtn.textContent == 'Join') mainMsg.textContent = 'This file may contain a part. Add more parts if necessary';
	},300);
}

//to load a file into the directory dialog
function loadLockFile(){
	var fileToLoad = lockFile.files[0],
		fileReader = new FileReader();
	fileReader.onload = function(fileLoadedEvent){
		var fileName = fileToLoad.name;
			URLFromFileLoaded = fileLoadedEvent.target.result,
			escapedName = escapeHTML(fileName);
		lockBox.textContent = '';
		var fileLink = document.createElement('a');
		fileLink.download = escapedName;
		fileLink.href = decryptSanitizer(URLFromFileLoaded).replace(/=+$/,'');
		fileLink.textContent = escapedName;
		lockBox.appendChild(fileLink)
	};

	fileReader.readAsDataURL(fileToLoad, "UTF-8");
	lockMsg.textContent = 'File ' + escapedName + ' has been loaded'
}

//to load an image into the main box
function loadImage(){
	var fileToLoad = imgFile.files[0],
		fileReader = new FileReader();
	fileReader.onload = function(fileLoadedEvent){
		var URLFromFileLoaded = fileLoadedEvent.target.result;
		if(URLFromFileLoaded.slice(0,10) != 'data:image'){
			mainMsg.textContent = 'This file is not a recognized image type';
			return
		}
		var image = document.createElement("img");
		image.src = decryptSanitizer(URLFromFileLoaded).replace(/=+$/,'');
		mainBox.appendChild(image)
	};

	fileReader.readAsDataURL(fileToLoad, "UTF-8");
}

//operates when the Save button is clicked
function saveFiles(){
	mainBox.contentEditable = 'false';
	var files = mainBox.querySelectorAll('a'),
		length = files.length;				//since files will be loaded as links in the main box
	for(var i = 0; i < length; i++){		//download all files
		if(files[i].href.includes('data:')) files[i].click()
	}
	mainBox.contentEditable = 'true'
}
</script>

<!--initialization, button connections-->
<script>
// initialize things
window.onload = function() {

	if(isMobile){
		imgSpacer.style.display = 'none';
		mainSpacer.style.display = 'none';
		partSpacer1.style.display = 'none';
		partSpacer2.style.display = 'none';
		decoyInSpacer1.style.display = 'none';
		decoyInSpacer2.style.display = 'none';
		decoyOutSpacer.style.display = 'none';
		qrcodeImg.style.width = '100%';
		var bottomButtons = mainbuttonsbot.children;
		for(var i = 0; i < bottomButtons.length; i++) bottomButtons[i].classList.add("narrow")
	}else{
		previewImg.style.width = "80%"					//smaller image on PCs
	}
	if(!isMobile || isChrome){						//search box in Help tab. Works on Android Chrome, but won't detect right
		helpTopMobile.style.display = 'none';
		helpTop.style.display = 'block';
		helpSpace.style.display = 'block'
	}
	if(isAndroid){										//resize shift buttons on Android
		extra2mainBtn.style.padding = '11px';
		main2extraBtn.style.padding = '11px'
	}
	if(isiOS) encodeJPGBtn.style.display = 'none';	//JPG hide does not work on iOS
	if(isiPhone || isAndroidPhone){					//to make things fit on narrow screens
		anonLabel.textContent = ' Anon.  ';
		modeLabel.style.display = 'none';
		otherLabel.style.display = 'none';
		greenLabel.textContent = 'Grn';
		customLabel.textContent = 'Cust';
		backgroundLabel.textContent = 'Bg.';
		sentencesLabel.textContent = 'Sentence';
		lockScr.style.top = "5%";
		lockScr.style.left = "5%";
		lockScr.style.width = "90%";
		lockScr.style.height = "90%"
	}
	
	//load field icons
	pwdIntroIcon.src = eyeImg;
	pwdIcon.src = eyeImg;
	newKeyIcon.src = eyeImg;
	decoyInIcon.src = eyeImg;
	decoyOutIcon.src = eyeImg;
	imageIcon.src = eyeImg;

  //event listeners for buttons etc.
	window.addEventListener('resize',textheight);

	mainFile.addEventListener('change', loadFileAsURL);
	mainFile.addEventListener('click', function(){this.value = '';});
	
	imgFile.addEventListener('change', loadImage);
	imgFile.addEventListener('click', function(){this.value = '';});

	imageFile.addEventListener('change', importImage);
	imageFile.addEventListener('click', function(){this.value = '';});

	imageFileEmail.addEventListener('change', importImage);
	imageFileEmail.addEventListener('click', function(){this.value = '';});

	lockFile.addEventListener('change', loadLockFile);
	lockFile.addEventListener('click', function(){this.value = '';});

    encodePNGBtn.addEventListener('click', encodePNG);

	encodeJPGBtn.addEventListener('click', encodeJPG);

    decodeImgBtn.addEventListener('click', decodeImage);

	imageIcon.addEventListener('click',function(){showPwd('image')});

	showLockBtn.addEventListener('click', showLock);

	selectMainBtn.addEventListener('click', selectMain);

   	clearMainBtn.addEventListener('click', clearMain);

	showLockBtnBasic.addEventListener('click', showLock);

   	decryptBtn.addEventListener('click', lockBtnAction);

	verifyBtn.addEventListener('click', signVerify);

   	main2extraBtn.addEventListener('click', main2extra);

   	decryptBtnBasic.addEventListener('click', lockBtnAction);

	decryptBtnEmail.addEventListener('click', lockBtnAction);

   	extra2mainBtn.addEventListener('click', main2extra);

   	niceEditBtn.addEventListener('click', toggleRichText);

   	chatBtn.addEventListener('click', Chat);

   	sendSMSBtn.addEventListener('click', sendSMS);

   	secretShareBtn.addEventListener('click', splitJoin);

	stegoBtn.addEventListener('click', textStego);

	stegoBtnEmail.addEventListener('click', textStego);

   	image2mainBtn.addEventListener('click', image2main);

   	clearLocksBtn.addEventListener('click', clearLocks);

   	addLockBtn.addEventListener('click', function(){addLock(false)});

   	removeLockBtn.addEventListener('click', removeLock);

   	resetPFSBtn.addEventListener('click', resetPFS);

   	showLockDBBtn.addEventListener('click', showLockDB);

   	mergeLockDBBtn.addEventListener('click', mergeLockDB);

   	moveLockDBBtn.addEventListener('click', moveLockDB);

   	acceptKeyBtn.addEventListener('click', acceptpwd);

   	cancelKeyBtn.addEventListener('click', cancelKey);

   	skipIntroBtn.addEventListener('click', cancelKey);

   	changeNameBtn.addEventListener('click', showName);

   	changeKeyBtn.addEventListener('click', acceptnewKey);

   	changeEmailBtn.addEventListener('click', showEmail);

   	backupSettingsBtn.addEventListener('click', moveMyself);

   	basicMode.addEventListener('click', mode2basic);

   	advancedMode.addEventListener('click', mode2adv);

	emailMode.addEventListener('click', mode2email);

	liteStyle.addEventListener('click', selectStyle);

	darkStyle.addEventListener('click', selectStyle);

	redStyle.addEventListener('click', selectStyle);

	greenStyle.addEventListener('click', selectStyle);

	blueStyle.addEventListener('click', selectStyle);

	customStyle.addEventListener('click', selectStyle);

	colorPicker.addEventListener('change',updateColor);

	rndColors.addEventListener('click', randomColors);

	editTabColor.addEventListener('click', initPicker);

	editBgColor.addEventListener('click', initPicker);

	editBtnColor.addEventListener('click', initPicker);

	editBoxColor.addEventListener('click', initPicker);

	anonMode.addEventListener('click', checkboxStore);

	signedMode.addEventListener('click', checkboxStore);

	onceMode.addEventListener('click', checkboxStore);

	learnMode.addEventListener('click', checkboxStore);

	longMode.addEventListener('click', checkboxStore);

	shortMode.addEventListener('click', checkboxStore);

	compatMode.addEventListener('click', checkboxStore);

	decoyMode.addEventListener('click', checkboxStore);

	wordLockMode.addEventListener('click', checkboxStore);

	ezLokMode.addEventListener('click', checkboxStore);

   	normalLockMode.addEventListener('click', checkboxStore);

	fileMode.addEventListener('click', checkboxStore);

	binaryMode.addEventListener('click', checkboxStore);

	textMode.addEventListener('click', checkboxStore);

	chromeSyncMode.addEventListener('click', checkboxStore);

	sentenceMode.addEventListener('click', checkboxStore);

	letterMode.addEventListener('click', checkboxStore);

	invisibleMode.addEventListener('click', checkboxStore);

	wordMode.addEventListener('click', checkboxStore);

	spaceMode.addEventListener('click', checkboxStore);

	pwdIcon.addEventListener('click',function(){showPwd('pwd')});

   	introRandomBtn.addEventListener('click', randomToken);

	clearIntroRandomBtn.addEventListener('click', clearIntroEmail);

   	randomEmailBtn.addEventListener('click', randomToken);

   	acceptEmailBtn.addEventListener('click', email2any);

   	cancelEmailBtn.addEventListener('click', cancelEmail);

   	acceptNameBtn.addEventListener('click', name2any);

   	cancelNameBtn.addEventListener('click', cancelName);

   	pwdIntroIcon.addEventListener('click', function(){showPwd('pwdIntro')});

   	clearIntroBtn.addEventListener('click', clearIntro);

   	suggestIntroBtn.addEventListener('click', suggestIntro);

   	showlockIntroBtn.addEventListener('click', initUser);

   	decoyInIcon.addEventListener('click', function(){showPwd('decoyIn')});

   	submitDecoyBtn.addEventListener('click', acceptdecoyIn);

   	cancelDecoyBtn.addEventListener('click', cancelDecoy);

   	decoyOutIcon.addEventListener('click', function(){showPwd('decoyOut')});

   	submitDecoy2Btn.addEventListener('click', acceptdecoyIn);

   	cancelDecoy2Btn.addEventListener('click', cancelDecoy);

   	submitPartsBtn.addEventListener('click', submitParts);

   	cancelPartsBtn.addEventListener('click', cancelPartsIn);

   	cancelChatBtn.addEventListener('click', closeBox);

   	submitChatBtn.addEventListener('click', makeChat);

	lockList.addEventListener('change', fillBox);

	lockList.addEventListener('click', updateButtons);

   	resetListBtn.addEventListener('click', resetList);

	main2lockBtn.addEventListener('click', main2lock);

	lock2mainBtn.addEventListener('click', main2lock);

   	newUserBtn.addEventListener('click', newUser);

   	submitKeyChangeBtn.addEventListener('click', acceptnewKey);

   	cancelKeyChangeBtn.addEventListener('click', cancelKeyChange);

	newKeyIcon.addEventListener('click',function(){showPwd('newKey')});

	gotointro2.addEventListener('click', go2intro2);

   	backtointro1.addEventListener('click', go2intro2);

   	gotointro3.addEventListener('click', go2intro3);

   	backtointro2.addEventListener('click', go2intro3);

   	gotointro4.addEventListener('click', go2intro4);

   	backtointro3.addEventListener('click', go2intro4);

   	gotointro5.addEventListener('click', go2intro5);

   	backtointro4.addEventListener('click', go2intro5);

   	mainBox.addEventListener('keyup', charsLeft);

	mainBox.addEventListener('paste', pasteMain);

   	decoyText.addEventListener('keyup', charsLeft);

   	chatDate.addEventListener('keyup', charsLeft);

	pwdBox.addEventListener('keyup',function(event){boxKeyup('pwd',event)});

	pwdIntroBox.addEventListener('keyup',function(event){boxKeyup('pwdIntro',event)});

	decoyInBox.addEventListener('keyup', function(event){boxKeyup('decoyIn',event)});

	decoyOutBox.addEventListener('keyup', function(event){boxKeyup('decoyOut',event)});

	partsIn.addEventListener('keyup', function(event) {partsKeyup(event)}, false);

	newKeyBox.addEventListener('keyup', function(event){boxKeyup('newKey',event)});

	newKey2Box.addEventListener('keyup', function(event) {newKey2up(event)}, false);

	lockBox.addEventListener('keyup', function(event) {lockBoxKeyup(event)}, false);

	lockBox.addEventListener('paste', pasteLock);

	userNameBox.addEventListener('keyup', function(event) {nameKeyup(event)}, false);

	emailBox.addEventListener('keyup', function(event) {emailKeyup(event)}, false);

	imageBox.addEventListener('keyup', function(event){boxKeyup('image',event)});
	
	qrcodeImg.addEventListener('click', function(){qrcodeImg.style.display = 'none';mainMsg.textContent = 'QR code canceled'});

//for the rich text editor boxes and buttons
	formatBlock.addEventListener("change", function() {formatDoc('formatBlock',this[this.selectedIndex].value);this.selectedIndex=0;});
	fontName.addEventListener("change", function() {formatDoc('fontName',this[this.selectedIndex].value);this.selectedIndex=0;});
	fontSize.addEventListener("change", function() {formatDoc('fontSize',this[this.selectedIndex].value);this.selectedIndex=0;});
	foreColor.addEventListener("change", function() {formatDoc('foreColor',this[this.selectedIndex].value);this.selectedIndex=0;});
	backColor.addEventListener("change", function() {formatDoc('backColor',this[this.selectedIndex].value);this.selectedIndex=0;});

	document.images[0].addEventListener("click", function() {formatDoc('bold')});
	document.images[1].addEventListener("click", function() {formatDoc('italic')});
	document.images[2].addEventListener("click", function() {formatDoc('underline')});
	document.images[3].addEventListener("click", function() {formatDoc('strikethrough')});
	document.images[4].addEventListener("click", function() {formatDoc('subscript')});
	document.images[5].addEventListener("click", function() {formatDoc('superscript')});
	document.images[6].addEventListener("click", function() {formatDoc('justifyleft')});
	document.images[7].addEventListener("click", function() {formatDoc('justifycenter')});
	document.images[8].addEventListener("click", function() {formatDoc('justifyright')});
	document.images[9].addEventListener("click", function() {formatDoc('justifyfull')});
	document.images[10].addEventListener("click", function() {formatDoc('insertorderedlist')});
	document.images[11].addEventListener("click", function() {formatDoc('insertunorderedlist')});
	document.images[12].addEventListener("click", function() {formatDoc('formatBlock','blockquote')});
	document.images[13].addEventListener("click", function() {formatDoc('outdent')});
	document.images[14].addEventListener("click", function() {formatDoc('indent')});
	document.images[15].addEventListener("click", function() {formatDoc('inserthorizontalrule')});
	document.images[16].addEventListener("click", function() {var sLnk=prompt('Write the URL here','http:\/\/');if(sLnk&&sLnk!=''&&sLnk!='http://'){formatDoc('createlink',sLnk)}});
	document.images[17].addEventListener("click", function() {formatDoc('unlink')});
	document.images[18].addEventListener("click", function() {formatDoc('removeFormat')});
	document.images[19].addEventListener("click", function() {formatDoc('undo')});
	document.images[20].addEventListener("click", function() {formatDoc('redo')});
	document.images[23].addEventListener("click", saveFiles);

//for the help screens
	var helpHeaders = document.getElementsByClassName("helpHeading");		//add listeners to all the help headers

	for (var i = 0; i < helpHeaders.length; i++) {
		helpHeaders[i].addEventListener('click', openHelp);
	}
	
	var helpHeaders2 = document.getElementsByClassName("helpHeading2");		//2nd level help
	
	for (var i = 0; i < helpHeaders2.length; i++) {
		helpHeaders2[i].addEventListener('click', openHelp2);
	}

//fixes after inline styles were moved to css file
	lockList.style.padding = '4px';
	lockList.style.width = '30%';
	basicBtnsTop.style.display = 'block';
	mainMsg.style.minHeight = '20px';
	extraButtonsTop.style.display = 'none'
};

//fix for iOS Safari upon startup
if(isMobile){
	if(window.location.hash.match('#a') && window.location.hash.length < 10) window.location.hash = ''
}

if(!localStorage){newUser();}else if(localStorage.length == 0){newUser();}else if(localStorage.length == 1 && localStorage['randid']){newUser();};

//initialize QRcode
var qrcode = new QRCode(document.getElementById("qrcodeImg"), {
	width : 290,
	height : 290
});

fillNameList();

initTabs();																	//initialize tabs

//var time10 = hashTime10();													//get milliseconds for 10 wiseHash at iter = 10
var time10 = 200									//valid for core2 duo. Should be smaller for more recent machines

//end of body script.
</script>


</body></html>
